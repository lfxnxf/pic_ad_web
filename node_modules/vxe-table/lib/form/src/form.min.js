"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=_interopRequireDefault(require("../../mixins/size")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools"),_util=require("./util"),_utils=require("../../tools/src/utils"),_dom=require("../../tools/src/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(t,e){var i,r=Object.keys(t);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(t),e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,i)),r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(i),!0).forEach(function(e){_defineProperty(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"message",get:function(){return _tools.UtilTools.getFuncText(this.$options.message)}}]),t}();function validErrorRuleValue(e,t){var i=e.type,r=e.min,l=e.max,n=e.pattern,e="number"===i,i=e?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!e||!isNaN(t))||(!_xeUtils.default.eqNull(r)&&i<_xeUtils.default.toNumber(r)||(!_xeUtils.default.eqNull(l)&&i>_xeUtils.default.toNumber(l)||!(!n||(_xeUtils.default.isRegExp(n)?n:new RegExp(n)).test(t))))}function getResetValue(e,t){return t=_xeUtils.default.isArray(e)?[]:t}function callSlot(e,t,i,r){if(t){var l=e.$scopedSlots;if(_xeUtils.default.isString(t)&&(t=l[t]||null),_xeUtils.default.isFunction(t))return t.call(e,i,r)}return[]}function renderPrefixIcon(e,t){return e("span",{class:"vxe-form--item-title-prefix"},[e("i",{class:t.icon||_conf.default.icon.FORM_PREFIX})])}function renderSuffixIcon(e,t){return e("span",{class:"vxe-form--item-title-suffix"},[e("i",{class:t.icon||_conf.default.icon.FORM_SUFFIX})])}function renderTitle(e,t,i){var r=t.data,l=i.slots,n=i.field,o=i.itemRender,s=i.titlePrefix,a=i.titleSuffix,u=(0,_tools.isEnableConf)(o)?_vXETable.default.renderer.get(o.name):null,r={data:r,property:n,item:i,$form:t},n=[];return s&&n.push(s.message?e("vxe-tooltip",{props:{content:_tools.UtilTools.getFuncText(s.message),enterable:s.enterable,theme:s.theme}},[renderPrefixIcon(e,s)]):renderPrefixIcon(e,s)),n.push(e("span",{class:"vxe-form--item-title-label"},u&&u.renderItemTitle?u.renderItemTitle(o,r):l&&l.title?callSlot(t,l.title,r,e):_tools.UtilTools.getFuncText(i.title))),a&&n.push(a.message?e("vxe-tooltip",{props:{content:_tools.UtilTools.getFuncText(a.message),enterable:a.enterable,theme:a.theme}},[renderSuffixIcon(e,a)]):renderSuffixIcon(e,a)),n}function renderItems(I,R,e){var U=R._e,w=R.rules,S=R.data,$=R.collapseAll,P=R.validOpts,j=R.titleOverflow;return e.map(function(e,t){var i,r=e.slots,l=e.title,n=e.folding,o=e.visible,s=e.visibleMethod,a=e.field,u=e.collapseNode,c=e.itemRender,f=e.showError,d=e.errRule,m=e.className,p=e.titleOverflow,h=e.children,v=(0,_tools.isEnableConf)(c)?_vXETable.default.renderer.get(c.name):null,g=e.span||R.span,_=e.align||R.align,x=e.titleAlign||R.titleAlign,b=e.titleWidth||R.titleWidth,y=s,T=_xeUtils.default.isUndefined(p)||_xeUtils.default.isNull(p)?j:p,s="title"===T,p=!0===T||"tooltip"===T,T=s||p||"ellipsis"===T,E={data:S,property:a,item:e,$form:R};if(!1===o)return U();if(h&&0<h.length){h=renderItems(I,R,e.children);return h.length?I("div",{class:["vxe-form--gather vxe-row",e.id,g?"vxe-col--".concat(g," is--span"):"",m?_xeUtils.default.isFunction(m)?m(E):m:""]},h):U()}!y&&v&&v.itemVisibleMethod&&(y=v.itemVisibleMethod),!w||(O=w[a])&&(i=O.some(function(e){return e.required}));var O=[];r&&r.default?O=callSlot(R,r.default,E,I):v&&v.renderItemContent?O=v.renderItemContent.call(R,I,c,E):v&&v.renderItem?O=v.renderItem.call(R,I,c,E):a&&(O=["".concat(_xeUtils.default.get(S,a))]);p=p?{mouseenter:function(e){R.triggerHeaderHelpEvent(e,E)},mouseleave:R.handleTargetLeaveEvent}:{};return I("div",{class:["vxe-form--item",e.id,g?"vxe-col--".concat(g," is--span"):null,m?_xeUtils.default.isFunction(m)?m(E):m:"",{"is--title":l,"is--required":i,"is--hidden":n&&$,"is--active":!y||y(E),"is--error":f}],key:t},[I("div",{class:"vxe-form--item-inner"},[l||r&&r.title?I("div",{class:["vxe-form--item-title",x?"align--".concat(x):null,{"is--ellipsis":T}],style:b?{width:isNaN(b)?b:"".concat(b,"px")}:null,attrs:{title:s?_tools.UtilTools.getFuncText(l):null},on:p},renderTitle(I,R,e)):null,I("div",{class:["vxe-form--item-content",_?"align--".concat(_):null]},O.concat([u?I("div",{class:"vxe-form--item-trigger-node",on:{click:R.toggleCollapseEvent}},[I("span",{class:"vxe-form--item-trigger-text"},$?_conf.default.i18n("vxe.form.unfolding"):_conf.default.i18n("vxe.form.folding")),I("i",{class:["vxe-form--item-trigger-icon",$?_conf.default.icon.FORM_FOLDING:_conf.default.icon.FORM_UNFOLDING]})]):null,d&&P.showMessage?I("div",{class:"vxe-form--item-valid",style:d.maxWidth?{width:"".concat(d.maxWidth,"px")}:null},d.message):null]))])])})}var _default2={name:"VxeForm",mixins:[_size.default],props:{loading:Boolean,data:Object,size:{type:String,default:function(){return _conf.default.form.size||_conf.default.size}},span:[String,Number],align:{type:String,default:function(){return _conf.default.form.align}},titleAlign:{type:String,default:function(){return _conf.default.form.titleAlign}},titleWidth:[String,Number],titleColon:{type:Boolean,default:function(){return _conf.default.form.titleColon}},titleAsterisk:{type:Boolean,default:function(){return _conf.default.form.titleAsterisk}},titleOverflow:{type:[Boolean,String],default:null},className:[String,Function],items:Array,rules:Object,preventSubmit:{type:Boolean,default:function(){return _conf.default.form.preventSubmit}},validConfig:Object},data:function(){return{collapseAll:!0,staticItems:[],formItems:[],tooltipTimeout:null,tooltipActive:!1,tooltipStore:{item:null,visible:!1}}},provide:function(){return{$xeform:this}},computed:{validOpts:function(){return Object.assign({},_conf.default.form.validConfig,this.validConfig)},tooltipOpts:function(){var e=Object.assign({leaveDelay:300},_conf.default.form.tooltipConfig,this.tooltipConfig);return e.enterable&&(e.leaveMethod=this.handleTooltipLeaveMethod),e}},created:function(){var t=this;this.$nextTick(function(){var e=t.items;e&&t.loadItem(e)})},watch:{staticItems:function(e){this.formItems=e},items:function(e){this.loadItem(e)}},render:function(e){var t=this._e,i=this.loading,r=this.className,l=this.data,n=this.vSize,o=this.tooltipOpts,s=this.formItems,a=_vXETable.default._tooltip;return e("form",{class:["vxe-form",r?_xeUtils.default.isFunction(r)?r({items:s,data:l,$form:this}):r:"",(_defineProperty(r={},"size--".concat(n),n),_defineProperty(r,"is--colon",this.titleColon),_defineProperty(r,"is--asterisk",this.titleAsterisk),_defineProperty(r,"is--loading",i),r)],on:{submit:this.submitEvent,reset:this.resetEvent}},[e("div",{class:"vxe-form--wrapper vxe-row"},renderItems(e,this,s)),e("div",{class:"vxe-form-slots",ref:"hideItem"},this.$slots.default),e("div",{class:["vxe-loading",{"is--visible":i}]},[e("div",{class:"vxe-loading--spinner"})]),a?e("vxe-tooltip",_objectSpread({ref:"tooltip"},o)):t()])},methods:{loadItem:function(e){var t,i=this;return"development"===process.env.NODE_ENV&&(t=this.$scopedSlots,e.forEach(function(e){e.slots&&_xeUtils.default.each(e.slots,function(e){_xeUtils.default.isFunction(e)||t[e]||_tools.UtilTools.error("vxe.error.notSlot",[e])})})),this.staticItems=_xeUtils.default.mapTree(e,function(e){return(0,_util.createItem)(i,e)},{children:"children"}),this.$nextTick()},getItems:function(){var t=[];return _xeUtils.default.eachTree(this.formItems,function(e){t.push(e)},{children:"children"}),t},toggleCollapse:function(){return this.collapseAll=!this.collapseAll,this.$nextTick()},toggleCollapseEvent:function(e){this.toggleCollapse(),this.$emit("toggle-collapse",{collapse:!this.collapseAll,data:this.data,$form:this,$event:e},e)},submitEvent:function(t){var i=this;t.preventDefault(),this.preventSubmit||this.beginValidate().then(function(){i.$emit("submit",{data:i.data,$form:i,$event:t})}).catch(function(e){i.$emit("submit-invalid",{data:i.data,errMap:e,$form:i,$event:t})})},reset:function(){var l=this,n=this.data;return n&&this.getItems().forEach(function(e){var t=e.field,i=e.resetValue,r=e.itemRender;(0,_tools.isEnableConf)(r)&&((r=_vXETable.default.renderer.get(r.name))&&r.itemResetMethod?r.itemResetMethod({data:n,property:t,item:e,$form:l}):t&&_xeUtils.default.set(n,t,null===i?getResetValue(_xeUtils.default.get(n,t),void 0):i))}),this.clearValidate()},resetEvent:function(e){e.preventDefault(),this.reset(),this.$emit("reset",{data:this.data,$form:this,$event:e})},handleTooltipLeaveMethod:function(){var e=this,t=this.tooltipOpts;return setTimeout(function(){e.tooltipActive||e.closeTooltip()},t.leaveDelay),!1},closeTooltip:function(){var e=this.tooltipStore,t=this.$refs.tooltip;return e.visible&&(Object.assign(e,{item:null,visible:!1}),t&&t.close()),this.$nextTick()},triggerHeaderHelpEvent:function(e,t){var i=t.item,r=this.tooltipStore,l=this.$refs.tooltip,n=e.currentTarget,t=(n.textContent||"").trim(),e=n.scrollWidth>n.clientWidth;clearTimeout(this.tooltipTimeout),this.tooltipActive=!0,this.closeTooltip(),t&&e&&(Object.assign(r,{item:i,visible:!0}),l&&l.open(n,t))},handleTargetLeaveEvent:function(){var t=this,e=this.tooltipOpts;this.tooltipActive=!1,e.enterable?this.tooltipTimeout=setTimeout(function(){var e=t.$refs.tooltip;e&&!e.isHover&&t.closeTooltip()},e.leaveDelay):this.closeTooltip()},clearValidate:function(t){var e,i=this.getItems();return t?(e=i.find(function(e){return e.field===t}))&&(e.showError=!1):i.forEach(function(e){e.showError=!1}),this.$nextTick()},validate:function(e){return this.beginValidate("",e)},beginValidate:function(e,i){var l=this,n=this.data,t=this.rules,r=this.validOpts,o={},s=[],a=[],u=this.getItems();return this.clearValidate(),clearTimeout(this.showErrTime),n&&t?(u.forEach(function(i){var r=i.field;r&&a.push(l.validItemRules(e||"all",r).then(function(){i.errRule=null}).catch(function(e){var t=e.rule,e={rule:t,rules:e.rules,data:n,property:r,$form:l};return o[r]||(o[r]=[]),o[r].push(e),s.push(r),i.errRule=t,Promise.reject(e)}))}),Promise.all(a).then(function(){i&&i()}).catch(function(){return new Promise(function(e,t){l.showErrTime=setTimeout(function(){u.forEach(function(e){e.errRule&&(e.showError=!0)})},20),r.autoPos&&l.$nextTick(function(){l.handleFocus(s)}),i?(i(o),e()):t(o)})})):(i&&i(),Promise.resolve())},validItemRules:function(n,o,e){var s,a,u=this,c=this.data,t=this.rules,f=[],d=[];return o&&t&&((s=_xeUtils.default.get(t,o))&&(a=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(c,o):e,s.forEach(function(t){var e,i=t.type,r=t.trigger,l=t.required;"all"!==n&&r&&n!==t.trigger||(_xeUtils.default.isFunction(t.validator)?(e=t.validator({itemValue:a,rule:t,rules:s,data:c,property:o,$form:u}))&&(_xeUtils.default.isError(e)?f.push(new Rule({type:"custom",trigger:r,message:e.message,rule:new Rule(t)})):e.catch&&d.push(e.catch(function(e){f.push(new Rule({type:"custom",trigger:r,message:(e||t).message,rule:new Rule(t)}))}))):(i="array"===i?!_xeUtils.default.isArray(a)||!a.length:(0,_utils.eqEmptyValue)(a),(l?i||validErrorRuleValue(t,a):!i&&validErrorRuleValue(t,a))&&f.push(new Rule(t))))}))),Promise.all(d).then(function(){if(f.length){var e={rules:f,rule:f[0]};return Promise.reject(e)}})},handleFocus:function(e){var n=this.$el,o=this.getItems();e.some(function(t){var e=o.find(function(e){return e.field===t});if(e&&(0,_tools.isEnableConf)(e.itemRender)){var i,r=e.itemRender,l=_vXETable.default.renderer.get(r.name);if(r.autofocus&&(i=n.querySelector(".".concat(e.id," ").concat(r.autofocus))),!i&&l&&l.autofocus&&(i=n.querySelector(".".concat(e.id," ").concat(l.autofocus))),i)return i.focus(),_dom.browse.msie&&((i=i.createTextRange()).collapse(!1),i.select()),!0}})},updateStatus:function(e,t){var i=this,r=e.property;r&&this.validItemRules("change",r,t).then(function(){i.clearValidate(r)}).catch(function(e){var t=e.rule,e=i.getItems().find(function(e){return e.field===r});e&&(e.showError=!0,e.errRule=t)})}}};exports.default=_default2;