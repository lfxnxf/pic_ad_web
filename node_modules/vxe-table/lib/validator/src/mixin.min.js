"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_tools=require("../../tools"),_utils=require("../../tools/src/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var l=t[r];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(e,l.key,l)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.max,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"message",get:function(){return _tools.UtilTools.getFuncText(this.$options.message)}}]),t}();function validErrorRuleValue(e,t){var r=e.type,l=e.min,i=e.max,n=e.pattern,e="number"===r,r=e?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!e||!isNaN(t))||(!_xeUtils.default.eqNull(l)&&r<_xeUtils.default.toNumber(l)||(!_xeUtils.default.eqNull(i)&&r>_xeUtils.default.toNumber(i)||!(!n||(_xeUtils.default.isRegExp(n)?n:new RegExp(n)).test(t))))}var _default={methods:{_fullValidate:function(e,t){return this.beginValidate(e,t,!0)},_validate:function(e,t){return this.beginValidate(e,t)},handleValidError:function(t){var r=this;return new Promise(function(e){!1===r.validOpts.autoPos?(r.emitEvent("valid-error",t),e()):r.handleActived(t,{type:"valid-error",trigger:"call"}).then(function(){setTimeout(function(){e(r.showValidTooltip(t))},10)})})},beginValidate:function(e,u,l){var s=this,o={},i=this.editRules,c=this.afterFullData,d=this.treeConfig,t=this.treeOpts;!0===e?r=c:e&&(_xeUtils.default.isFunction(e)?u=e:r=_xeUtils.default.isArray(e)?e:[e]);var r=r||this.getInsertRecords().concat(this.getUpdateRecords()),n=[];if(this.lastCallTime=Date.now(),this.validRuleErr=!1,this.clearValidate(),i){var a=this.getColumns(),e=function(r){var e;!l&&s.validRuleErr||(e=[],a.forEach(function(t){!l&&s.validRuleErr||!_xeUtils.default.has(i,t.property)||e.push(s.validCellRules("all",r,t).catch(function(e){e={rule:e.rule,rules:e.rules,rowIndex:s.getRowIndex(r),row:r,columnIndex:s.getColumnIndex(t),column:t,$table:s};if(o[t.property]||(o[t.property]=[]),o[t.property].push(e),!l)return s.validRuleErr=!0,Promise.reject(e)}))}),n.push(Promise.all(e)))};return d?_xeUtils.default.eachTree(r,e,t):r.forEach(e),Promise.all(n).then(function(){var e=Object.keys(o);return s.$nextTick().then(function(){return e.length?Promise.reject(o[e[0]][0]):void(u&&u())})}).catch(function(a){return new Promise(function(e,t){function r(){s.$nextTick(function(){u?(u(o),e()):t(o)})}function l(){a.cell=s.getCell(a.row,a.column),_tools.DomTools.scrollToView(a.cell),s.handleValidError(a).then(r)}var i=a.row,n=c.indexOf(i),i=0<n?c[n-1]:i;!1===s.validOpts.autoPos?r():(d?s.scrollToTreeRow(i):s.scrollToRow(i)).then(l)})})}return this.$nextTick().then(function(){u&&u()})},hasCellRules:function(t,e,r){var l=this.editRules,r=r.property;if(r&&l){r=_xeUtils.default.get(l,r);return r&&_xeUtils.default.find(r,function(e){return"all"===t||!e.trigger||t===e.trigger})}return!1},validCellRules:function(n,a,u,e){var s,o,c=this,t=this.editRules,r=u.property,d=[],f=[];return r&&t&&((s=_xeUtils.default.get(t,r))&&(o=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(a,r):e,s.forEach(function(t){var e,r=t.type,l=t.trigger,i=t.required;"all"!==n&&l&&n!==l||(_xeUtils.default.isFunction(t.validator)?(e=t.validator({cellValue:o,rule:t,rules:s,row:a,rowIndex:c.getRowIndex(a),column:u,columnIndex:c.getColumnIndex(u),$table:c}))&&(_xeUtils.default.isError(e)?(c.validRuleErr=!0,d.push(new Rule({type:"custom",trigger:l,message:e.message,rule:new Rule(t)}))):e.catch&&f.push(e.catch(function(e){c.validRuleErr=!0,d.push(new Rule({type:"custom",trigger:l,message:(e&&e.message?e:t).message,rule:new Rule(t)}))}))):(r="array"===r?!_xeUtils.default.isArray(o)||!o.length:(0,_utils.eqEmptyValue)(o),(i?r||validErrorRuleValue(t,o):!r&&validErrorRuleValue(t,o))&&(c.validRuleErr=!0,d.push(new Rule(t)))))}))),Promise.all(f).then(function(){if(d.length){var e={rules:d,rule:d[0]};return Promise.reject(e)}})},_clearValidate:function(){var e=this.$refs.validTip;return Object.assign(this.validStore,{visible:!1,row:null,column:null,content:"",rule:null}),e&&e.visible&&e.close(),this.$nextTick()},triggerValidate:function(t){var r=this,e=this.editConfig,l=this.editStore,i=this.editRules,n=this.validStore,l=l.actived;if(l.row&&i){var l=l.args,a=l.row,u=l.column,s=l.cell;if(this.hasCellRules(t,a,u))return this.validCellRules(t,a,u).then(function(){"row"===e.mode&&n.visible&&n.row===a&&n.column===u&&r.clearValidate()}).catch(function(e){e=e.rule;if(e.trigger&&t!==e.trigger)return Promise.resolve();e={rule:e,row:a,column:u,cell:s};return r.showValidTooltip(e),Promise.reject(e)})}return Promise.resolve()},showValidTooltip:function(e){var t=this,r=this.$refs,l=this.height,i=this.tableData,n=this.validOpts,a=e.rule,u=e.row,s=e.column,o=e.cell,c=r.validTip,d=a.message;return this.$nextTick(function(){if(Object.assign(t.validStore,{row:u,column:s,rule:a,content:d,visible:!0}),t.emitEvent("valid-error",e),c&&("tooltip"===n.message||"default"===n.message&&!l&&i.length<2))return c.open(o,d)})}}};exports.default=_default;