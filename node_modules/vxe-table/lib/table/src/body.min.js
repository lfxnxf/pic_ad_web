"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools"),_util=require("./util"),_dom=require("../../tools/src/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,l,t){return l in e?Object.defineProperty(e,l,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[l]=t,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,l){if(e){if("string"==typeof e)return _arrayLikeToArray(e,l);var t=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(t="Object"===t&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,l):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,l){(null==l||l>e.length)&&(l=e.length);for(var t=0,r=new Array(l);t<l;t++)r[t]=e[t];return r}var scrollProcessTimeout,renderType="body";function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.delayHover}function renderLine(e,l,t,r,o,n){var i=n.column,s=t.treeOpts,a=t.treeConfig,c=i.slots,i=i.treeNode;return c&&c.line?t.callSlot(c.line,n,e):a&&i&&s.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat((0,_util.calcTreeLine)(n,o),"px"),left:"".concat(r*s.indent+(r?2-(0,_util.getOffsetSize)(t):0)+16,"px")}})])]:[]}function renderColumn(e,l,t,r,o,n,i,s,a,c,d,u,p,f,h,y){var v,m=t.$listeners,g=t.afterFullData,w=t.tableData,x=t.height,b=t.columnKey,T=t.overflowX,_=t.scrollXLoad,S=t.scrollYLoad,$=t.highlightCurrentRow,C=t.showOverflow,O=t.isAllOverflow,L=t.align,I=t.currentColumn,k=t.cellClassName,E=t.cellStyle,R=t.mergeList,Y=t.spanMethod,A=t.radioOpts,P=t.checkboxOpts,B=t.expandOpts,M=t.treeOpts,D=t.tooltipOpts,U=t.mouseConfig,q=t.editConfig,H=t.editOpts,X=t.editRules,j=t.validOpts,N=t.editStore,W=t.validStore,z=t.tooltipConfig,F=p.type,V=p.cellRender,K=p.editRender,G=p.align,J=p.showOverflow,Q=p.className,Z=p.treeNode,ee=N.actived,le=D.showAll||D.enabled,te=t.getColumnIndex(p),re=t.getVTColumnIndex(p),oe=(0,_tools.isEnableConf)(K),N=i?p.fixed!==i:p.fixed&&T,D=_xeUtils.default.isUndefined(J)||_xeUtils.default.isNull(J)?C:J,T="ellipsis"===D,ne="title"===D,ie=!0===D||"tooltip"===D,J=ne||ie||T,D={},G=G||L,L=W.row===a&&W.column===p,X=X&&j.showMessage&&("default"===j.message?x||1<w.length:"inline"===j.message),x={colid:p.id},se=m["cell-mouseenter"],ae=m["cell-mouseleave"],j=K&&q&&"dblclick"===H.trigger,ce={$table:t,$seq:r,seq:o,rowid:n,row:a,rowIndex:c,$rowIndex:d,_rowIndex:u,column:p,columnIndex:te,$columnIndex:f,_columnIndex:re,fixed:i,type:renderType,isHidden:N,level:s,visibleData:g,data:w,items:y};if(!_&&!S||J||(T=J=!0),(ne||ie||le||se||z)&&(D.mouseenter=function(e){isOperateMouse(t)||(ne?_tools.DomTools.updateCellTitle(e.currentTarget,p):(ie||le)&&t.triggerBodyTooltipEvent(e,ce),se&&t.emitEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},ce),e))}),(ie||le||ae||z)&&(D.mouseleave=function(e){isOperateMouse(t)||((ie||le)&&t.handleTargetLeaveEvent(e),ae&&t.emitEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},ce),e))}),(P.range||U)&&(D.mousedown=function(e){t.triggerCellMousedownEvent(e,ce)}),($||m["cell-click"]||K&&q||"row"===B.trigger||"cell"===B.trigger||"row"===A.trigger||"radio"===p.type&&"cell"===A.trigger||"row"===P.trigger||"checkbox"===p.type&&"cell"===P.trigger||"row"===M.trigger||p.treeNode&&"cell"===M.trigger)&&(D.click=function(e){t.triggerCellClickEvent(e,ce)}),(j||m["cell-dblclick"])&&(D.dblclick=function(e){t.triggerCellDblclickEvent(e,ce)}),R.length){u=(0,_util.mergeBodyMethod)(R,u,re);if(u){var re=u.rowspan,de=u.colspan;if(!re||!de)return null;1<re&&(x.rowspan=re),1<de&&(x.colspan=de)}}else if(Y){de=Y(ce)||{},Y=de.rowspan,Y=void 0===Y?1:Y,de=de.colspan,de=void 0===de?1:de;if(!Y||!de)return null;1<Y&&(x.rowspan=Y),1<de&&(x.colspan=de)}!(N=N&&R&&(1<x.colspan||1<x.rowspan)?!1:N)&&q&&(K||V)&&(H.showStatus||H.showUpdateStatus)&&(v=t.isUpdateByRow(a,p.property));V=[];return N&&C&&O?V.push(e("div",{class:["vxe-cell",{"c--title":ne,"c--tooltip":ie,"c--ellipsis":T}]})):(V.push.apply(V,_toConsumableArray(renderLine(e,l,t,s,y,ce)).concat([e("div",{class:["vxe-cell",{"c--title":ne,"c--tooltip":ie,"c--ellipsis":T}],attrs:{title:ne?t.getCellLabel(a,p):null}},p.renderCell(e,ce))])),X&&L&&V.push(e("div",{class:"vxe-cell--valid",style:W.rule&&W.rule.maxWidth?{width:"".concat(W.rule.maxWidth,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},W.content)]))),e("td",{class:["vxe-body--column",p.id,(_defineProperty(e={},"col--".concat(G),G),_defineProperty(e,"col--".concat(F),F),_defineProperty(e,"col--last",f===h.length-1),_defineProperty(e,"col--tree-node",Z),_defineProperty(e,"col--edit",oe),_defineProperty(e,"col--ellipsis",J),_defineProperty(e,"fixed--hidden",N),_defineProperty(e,"col--dirty",v),_defineProperty(e,"col--actived",q&&oe&&ee.row===a&&(ee.column===p||"row"===H.mode)),_defineProperty(e,"col--valid-error",L),_defineProperty(e,"col--current",I===p),e),_tools.UtilTools.getClass(Q,ce),_tools.UtilTools.getClass(k,ce)],key:b?p.id:f,attrs:x,style:E?_xeUtils.default.isFunction(E)?E(ce):E:null,on:D},V)}function renderRows(u,p,f,h,y,v,m,g){var w=f.stripe,x=f.rowKey,b=f.highlightHoverRow,T=f.rowClassName,_=f.rowStyle,S=f.editConfig,$=f.showOverflow,C=f.treeConfig,O=f.treeOpts,L=f.editOpts,I=f.treeExpandeds,k=f.scrollYLoad,E=f.scrollYStore,R=f.editStore,Y=f.rowExpandeds,A=f.radioOpts,P=f.checkboxOpts,B=f.expandColumn,M=f.hasFixedColumn,D=[];return m.forEach(function(t,r){var e={},o=(i=r)+1;k&&(o+=E.startIndex);var n=f.getVTRowIndex(t),i=f.getRowIndex(t);b&&(e.mouseenter=function(e){isOperateMouse(f)||f.triggerHoverEvent(e,{row:t,rowIndex:i})},e.mouseleave=function(){isOperateMouse(f)||f.clearHoverRow()});var l,s,a=_tools.UtilTools.getRowid(f,t),c={$table:f,$seq:h,seq:o,rowid:a,fixed:v,type:renderType,level:y,row:t,rowIndex:i,$rowIndex:r},d=!1;S&&(d=-1<R.insertList.indexOf(t)),D.push(u("tr",{class:["vxe-body--row",{"row--stripe":w&&(f.getVTRowIndex(t)+1)%2==0,"is--new":d,"row--new":d&&(L.showStatus||L.showInsertStatus),"row--radio":A.highlight&&f.selectRow===t,"row--checked":P.highlight&&f.isCheckedByCheckboxRow(t)},T?_xeUtils.default.isFunction(T)?T(c):T:""],attrs:{rowid:a},style:_?_xeUtils.default.isFunction(_)?_(c):_:null,key:x||C?a:r,on:e},g.map(function(e,l){return renderColumn(u,p,f,h,o,a,v,y,t,i,r,n,e,l,g,m)}))),B&&Y.length&&-1<Y.indexOf(t)&&(C&&(l={paddingLeft:"".concat(y*O.indent+30,"px")}),s=B.showOverflow,c=_xeUtils.default.isUndefined(s)||_xeUtils.default.isNull(s)?$:s,s={$table:f,$seq:h,seq:o,column:B,fixed:v,type:renderType,level:y,row:t,rowIndex:i,$rowIndex:r},D.push(u("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(a),style:_?_xeUtils.default.isFunction(_)?_(s):_:null,on:e},[u("td",{class:["vxe-body--expanded-column",{"fixed--hidden":v&&!M,"col--ellipsis":c}],attrs:{colspan:g.length}},[u("div",{class:"vxe-body--expanded-cell",style:l},[B.renderData(u,s)])])]))),C&&I.length&&((s=t[O.children])&&s.length&&-1<I.indexOf(t)&&D.push.apply(D,_toConsumableArray(renderRows(u,p,f,(h?"".concat(h,"."):"").concat(o),y+1,v,s,g))))}),D}function syncBodyScroll(e,l,t){(l||t)&&(l&&((0,_util.removeScrollListener)(l),l.scrollTop=e),t&&((0,_util.removeScrollListener)(t),t.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){(0,_util.restoreScrollListener)(l),(0,_util.restoreScrollListener)(t)},300))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,fixedColumn:Array,size:String,fixedType:String},data:function(){return{wheelTime:null,wheelYSize:0,wheelYInterval:0,wheelYTotal:0}},mounted:function(){var e=this.$parent,l=this.$el,t=this.$refs,r=this.fixedType,e=e.elemStore,r="".concat(r||"main","-body-");e["".concat(r,"wrapper")]=l,e["".concat(r,"table")]=t.table,e["".concat(r,"colgroup")]=t.colgroup,e["".concat(r,"list")]=t.tbody,e["".concat(r,"xSpace")]=t.xSpace,e["".concat(r,"ySpace")]=t.ySpace,e["".concat(r,"emptyBlock")]=t.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){clearTimeout(this.wheelTime),this.$el._onscroll=null,this.$el.onscroll=null},render:function(t){var e=this._e,l=this.$parent,r=this.fixedColumn,o=this.fixedType,n=l.$scopedSlots,i=l.tId,s=l.tableData,a=l.tableColumn,c=l.visibleColumn,d=l.showOverflow,u=l.keyboardConfig,p=l.keyboardOpts,f=l.mergeList,h=l.spanMethod,y=l.scrollXLoad,v=l.scrollYLoad,m=l.isAllOverflow,g=l.emptyOpts,w=l.mouseConfig,x=l.mouseOpts,b=l.sYOpts;return o&&(a=!(y||v||d&&m)||f.length||h||u&&p.isMerge?c:r),g=n.empty?n.empty.call(this,{$table:l},t):(n=(n=g.name?_vXETable.default.renderer.get(g.name):null)?n.renderEmpty:null)?n.call(this,t,g,{$table:l}):l.emptyText||_conf.default.i18n("vxe.table.emptyText"),t("div",{class:["vxe-table--body-wrapper",o?"fixed-".concat(o,"--wrapper"):"body--wrapper"],attrs:{xid:i},on:v&&"wheel"===b.mode?{wheel:this.wheelEvent}:{}},[o?e():t("div",{class:"vxe-body--x-space",ref:"xSpace"}),t("div",{class:"vxe-body--y-space",ref:"ySpace"}),t("table",{class:"vxe-table--body",attrs:{xid:i,cellspacing:0,cellpadding:0,border:0},ref:"table"},[t("colgroup",{ref:"colgroup"},a.map(function(e,l){return t("col",{attrs:{name:e.id},key:l})})),t("tbody",{ref:"tbody"},renderRows(t,this,l,"",0,o,s,a))]),t("div",{class:"vxe-table--checkbox-range"}),w&&x.area?t("div",{class:"vxe-table--cell-area"},[t("span",{class:"vxe-table--cell-main-area"},x.extension?[t("span",{class:"vxe-table--cell-main-area-btn",on:{mousedown:function(e){l.triggerCellExtendMousedownEvent(e,{$table:l,fixed:o,type:renderType})}}})]:null),t("span",{class:"vxe-table--cell-copy-area"}),t("span",{class:"vxe-table--cell-extend-area"}),t("span",{class:"vxe-table--cell-multi-area"}),t("span",{class:"vxe-table--cell-active-area"})]):null,o?null:t("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[t("div",{class:"vxe-table--empty-content"},g)])])},methods:{scrollEvent:function(e){var l=this.$el,t=this.$parent,r=this.fixedType,o=t.$refs,n=t.highlightHoverRow,i=t.scrollXLoad,s=t.scrollYLoad,a=t.lastScrollTop,c=t.lastScrollLeft,d=o.tableHeader,u=o.tableBody,p=o.leftBody,f=o.rightBody,h=o.tableFooter,y=o.validTip,o=d?d.$el:null,d=h?h.$el:null,h=u.$el,u=p?p.$el:null,p=f?f.$el:null,f=l.scrollTop,l=h.scrollLeft,c=l!==c,a=f!==a;t.lastScrollTop=f,t.lastScrollLeft=l,t.lastScrollTime=Date.now(),n&&t.clearHoverRow(),u&&"left"===r?syncBodyScroll(f=u.scrollTop,h,p):p&&"right"===r?syncBodyScroll(f=p.scrollTop,h,u):(c&&(o&&(o.scrollLeft=h.scrollLeft),d&&(d.scrollLeft=h.scrollLeft)),(u||p)&&(t.checkScrolling(),a&&syncBodyScroll(f,u,p))),i&&c&&t.triggerScrollXEvent(e),s&&a&&t.triggerScrollYEvent(e),c&&y&&y.visible&&y.updatePlacement(),t.emitEvent("scroll",{type:renderType,fixed:r,scrollTop:f,scrollLeft:l,isX:c,isY:a},e)},handleWheel:function(s,a,e,c,d){var u=this,p=this.$parent,l=p.$refs,t=l.tableBody,r=l.leftBody,l=l.rightBody,f=t.$el,h=r?r.$el:null,y=l?l.$el:null,l=this.isPrevWheelTop===a?Math.max(0,this.wheelYSize-this.wheelYTotal):0;this.isPrevWheelTop=a,this.wheelYSize=Math.abs(a?e-l:e+l),this.wheelYInterval=0,this.wheelYTotal=0,clearTimeout(this.wheelTime),function e(){var l,t,r=u.fixedType,o=u.wheelYTotal,n=u.wheelYSize,i=u.wheelYInterval;o<n&&(n<(o+=i=Math.max(5,Math.floor(1.5*i)))&&(i-=o-n),t=f.scrollTop,l=f.clientHeight,n=f.scrollHeight,t=t+i*(a?-1:1),f.scrollTop=t,h&&(h.scrollTop=t),y&&(y.scrollTop=t),(a?t<n-l:0<=t)&&(u.wheelTime=setTimeout(e,10)),u.wheelYTotal=o,u.wheelYInterval=i,p.emitEvent("scroll",{type:renderType,fixed:r,scrollTop:f.scrollTop,scrollLeft:f.scrollLeft,isX:c,isY:d},s))}()},wheelEvent:function(e){var l=e.deltaY,t=e.deltaX,r=this.$el,o=this.$parent,n=o.$refs,i=o.highlightHoverRow,s=o.scrollYLoad,a=o.lastScrollTop,c=o.lastScrollLeft,d=n.tableBody.$el,n=_dom.browse.firefox?40*l:l,l=_dom.browse.firefox?40*t:t,t=n<0;(t?r.scrollTop<=0:r.scrollTop>=r.scrollHeight-r.clientHeight)||(r=r.scrollTop+n,c=(l=d.scrollLeft+l)!==c,(a=r!==a)&&(e.preventDefault(),o.lastScrollTop=r,o.lastScrollLeft=l,o.lastScrollTime=Date.now(),i&&o.clearHoverRow(),this.handleWheel(e,t,n,c,a),s&&o.triggerScrollYEvent(e)))}}};exports.default=_default;