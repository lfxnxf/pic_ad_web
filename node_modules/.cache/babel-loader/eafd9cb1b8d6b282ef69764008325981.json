{"remainingRequest":"/Users/zhang/canteen_manage/node_modules/babel-loader/lib/index.js!/Users/zhang/canteen_manage/src/assets/layui/layui.js","dependencies":[{"path":"/Users/zhang/canteen_manage/src/assets/layui/layui.js","mtime":1638355006714},{"path":"/Users/zhang/canteen_manage/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/zhang/canteen_manage/node_modules/babel-loader/lib/index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:dmFyIF90eXBlb2YgPSByZXF1aXJlKCIvVXNlcnMvemhhbmcvY2FudGVlbl9tYW5hZ2Uvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvdHlwZW9mIilbImRlZmF1bHQiXTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5sYXN0LWluZGV4LW9mLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuZGF0ZS50by1zdHJpbmcuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QudG8tc3RyaW5nLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMucmVnZXhwLnRvLXN0cmluZy5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL3dlYi50aW1lcnMuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5zbGljZS5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNwbGljZS5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC5leGVjLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLm1hdGNoLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnJlcGxhY2UuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5pbmRleC1vZi5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5saW5rLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMucGFyc2UtaW50LmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnNwbGl0LmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnNlYXJjaC5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC5jb25zdHJ1Y3Rvci5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNvcnQuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5yZXZlcnNlLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZmluZC5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmpvaW4uanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5wYXJzZS1mbG9hdC5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmNvbmNhdC5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmZpbHRlci5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5Lm1hcC5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy50cmltLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuaXMtYXJyYXkuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zeW1ib2wuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zeW1ib2wuZGVzY3JpcHRpb24uanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zeW1ib2wuaXRlcmF0b3IuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuaXRlcmF0b3IuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLml0ZXJhdG9yLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuZnVuY3Rpb24ubmFtZS5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5maXhlZC5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm51bWJlci50by1maXhlZC5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm51bWJlci5jb25zdHJ1Y3Rvci5qcyIpOwoKLyohIE1JVCBMaWNlbnNlZCAqLwo7CiFmdW5jdGlvbiAodCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIGUgPSB0LmRvY3VtZW50LAogICAgICBuID0gewogICAgbW9kdWxlczoge30sCiAgICBzdGF0dXM6IHt9LAogICAgdGltZW91dDogMTAsCiAgICBldmVudDoge30KICB9LAogICAgICByID0gZnVuY3Rpb24gcigpIHsKICAgIHRoaXMudiA9ICIyLjYuOCI7CiAgfSwKICAgICAgbyA9IHQuTEFZVUlfR0xPQkFMIHx8IHt9LAogICAgICBhID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHQgPSBlLmN1cnJlbnRTY3JpcHQgPyBlLmN1cnJlbnRTY3JpcHQuc3JjIDogZnVuY3Rpb24gKCkgewogICAgICBmb3IgKHZhciB0LCBuID0gZS5zY3JpcHRzLCByID0gbi5sZW5ndGggLSAxLCBvID0gcjsgbyA+IDA7IG8tLSkgewogICAgICAgIGlmICgiaW50ZXJhY3RpdmUiID09PSBuW29dLnJlYWR5U3RhdGUpIHsKICAgICAgICAgIHQgPSBuW29dLnNyYzsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHQgfHwgbltyXS5zcmM7CiAgICB9KCk7CiAgICByZXR1cm4gbi5kaXIgPSBvLmRpciB8fCB0LnN1YnN0cmluZygwLCB0Lmxhc3RJbmRleE9mKCIvIikgKyAxKTsKICB9KCksCiAgICAgIGkgPSBmdW5jdGlvbiBpKGUsIG4pIHsKICAgIG4gPSBuIHx8ICJsb2ciLCB0LmNvbnNvbGUgJiYgY29uc29sZVtuXSAmJiBjb25zb2xlW25dKCJsYXl1aSBlcnJvciBoaW50OiAiICsgZSk7CiAgfSwKICAgICAgdSA9ICJ1bmRlZmluZWQiICE9IHR5cGVvZiBvcGVyYSAmJiAiW29iamVjdCBPcGVyYV0iID09PSBvcGVyYS50b1N0cmluZygpLAogICAgICBsID0gbi5idWlsdGluID0gewogICAgbGF5OiAibGF5IiwKICAgIGxheWVyOiAibGF5ZXIiLAogICAgbGF5ZGF0ZTogImxheWRhdGUiLAogICAgbGF5cGFnZTogImxheXBhZ2UiLAogICAgbGF5dHBsOiAibGF5dHBsIiwKICAgIGxheWVkaXQ6ICJsYXllZGl0IiwKICAgIGZvcm06ICJmb3JtIiwKICAgIHVwbG9hZDogInVwbG9hZCIsCiAgICBkcm9wZG93bjogImRyb3Bkb3duIiwKICAgIHRyYW5zZmVyOiAidHJhbnNmZXIiLAogICAgdHJlZTogInRyZWUiLAogICAgdGFibGU6ICJ0YWJsZSIsCiAgICBlbGVtZW50OiAiZWxlbWVudCIsCiAgICByYXRlOiAicmF0ZSIsCiAgICBjb2xvcnBpY2tlcjogImNvbG9ycGlja2VyIiwKICAgIHNsaWRlcjogInNsaWRlciIsCiAgICBjYXJvdXNlbDogImNhcm91c2VsIiwKICAgIGZsb3c6ICJmbG93IiwKICAgIHV0aWw6ICJ1dGlsIiwKICAgIGNvZGU6ICJjb2RlIiwKICAgIGpxdWVyeTogImpxdWVyeSIsCiAgICBhbGw6ICJhbGwiLAogICAgImxheXVpLmFsbCI6ICJsYXl1aS5hbGwiCiAgfTsKCiAgci5wcm90b3R5cGUuY2FjaGUgPSBuLCByLnByb3RvdHlwZS5kZWZpbmUgPSBmdW5jdGlvbiAodCwgZSkgewogICAgdmFyIHIgPSB0aGlzLAogICAgICAgIG8gPSAiZnVuY3Rpb24iID09IHR5cGVvZiB0LAogICAgICAgIGEgPSBmdW5jdGlvbiBhKCkgewogICAgICB2YXIgdCA9IGZ1bmN0aW9uIHQoX3QyLCBlKSB7CiAgICAgICAgbGF5dWlbX3QyXSA9IGUsIG4uc3RhdHVzW190Ml0gPSAhMDsKICAgICAgfTsKCiAgICAgIHJldHVybiAiZnVuY3Rpb24iID09IHR5cGVvZiBlICYmIGUoZnVuY3Rpb24gKHIsIG8pIHsKICAgICAgICB0KHIsIG8pLCBuLmNhbGxiYWNrW3JdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgZSh0KTsKICAgICAgICB9OwogICAgICB9KSwgdGhpczsKICAgIH07CgogICAgcmV0dXJuIG8gJiYgKGUgPSB0LCB0ID0gW10pLCByLnVzZSh0LCBhLCBudWxsLCAiZGVmaW5lIiksIHI7CiAgfSwgci5wcm90b3R5cGUudXNlID0gZnVuY3Rpb24gKHIsIG8sIGMsIHMpIHsKICAgIGZ1bmN0aW9uIHAodCwgZSkgewogICAgICB2YXIgciA9ICJQTGF5U1RBVElPTiAzIiA9PT0gbmF2aWdhdG9yLnBsYXRmb3JtID8gL15jb21wbGV0ZSQvIDogL14oY29tcGxldGV8bG9hZGVkKSQvOwogICAgICAoImxvYWQiID09PSB0LnR5cGUgfHwgci50ZXN0KCh0LmN1cnJlbnRUYXJnZXQgfHwgdC5zcmNFbGVtZW50KS5yZWFkeVN0YXRlKSkgJiYgKG4ubW9kdWxlc1toXSA9IGUsIHYucmVtb3ZlQ2hpbGQoYiksIGZ1bmN0aW9uIG8oKSB7CiAgICAgICAgcmV0dXJuICsrbSA+IDFlMyAqIG4udGltZW91dCAvIDQgPyBpKGggKyAiIGlzIG5vdCBhIHZhbGlkIG1vZHVsZSIsICJlcnJvciIpIDogdm9pZCAobi5zdGF0dXNbaF0gPyBmKCkgOiBzZXRUaW1lb3V0KG8sIDQpKTsKICAgICAgfSgpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBmKCkgewogICAgICBjLnB1c2gobGF5dWlbaF0pLCByLmxlbmd0aCA+IDEgPyB5LnVzZShyLnNsaWNlKDEpLCBvLCBjLCBzKSA6ICJmdW5jdGlvbiIgPT0gdHlwZW9mIG8gJiYgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBsYXl1aS5qcXVlcnkgJiYgImZ1bmN0aW9uIiA9PSB0eXBlb2YgbGF5dWkuanF1ZXJ5ICYmICJkZWZpbmUiICE9PSBzID8gbGF5dWkuanF1ZXJ5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgIG8uYXBwbHkobGF5dWksIGMpOwogICAgICAgIH0pIDogdm9pZCBvLmFwcGx5KGxheXVpLCBjKTsKICAgICAgfSgpOwogICAgfQoKICAgIHZhciB5ID0gdGhpcywKICAgICAgICBkID0gbi5kaXIgPSBuLmRpciA/IG4uZGlyIDogYSwKICAgICAgICB2ID0gZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpWzBdOwogICAgciA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICJzdHJpbmciID09IHR5cGVvZiByID8gW3JdIDogImZ1bmN0aW9uIiA9PSB0eXBlb2YgciA/IChvID0gciwgWyJhbGwiXSkgOiByOwogICAgfSgpLCB0LmpRdWVyeSAmJiBqUXVlcnkuZm4ub24gJiYgKHkuZWFjaChyLCBmdW5jdGlvbiAodCwgZSkgewogICAgICAianF1ZXJ5IiA9PT0gZSAmJiByLnNwbGljZSh0LCAxKTsKICAgIH0pLCBsYXl1aS5qcXVlcnkgPSBsYXl1aS4kID0galF1ZXJ5KTsKICAgIHZhciBoID0gclswXSwKICAgICAgICBtID0gMDsKICAgIGlmIChjID0gYyB8fCBbXSwgbi5ob3N0ID0gbi5ob3N0IHx8IChkLm1hdGNoKC9cL1wvKFtcc1xTXSs/KVwvLykgfHwgWyIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgIi8iXSlbMF0sIDAgPT09IHIubGVuZ3RoIHx8IGxheXVpWyJsYXl1aS5hbGwiXSAmJiBsW2hdKSByZXR1cm4gZigpLCB5OwogICAgdmFyIGcgPSAobFtoXSA/IGQgKyAibW9kdWxlcy8iIDogL15ce1wvXH0vLnRlc3QoeS5tb2R1bGVzW2hdKSA/ICIiIDogbi5iYXNlIHx8ICIiKSArICh5Lm1vZHVsZXNbaF0gfHwgaCkgKyAiLmpzIjsKICAgIGlmIChnID0gZy5yZXBsYWNlKC9eXHtcL1x9LywgIiIpLCAhbi5tb2R1bGVzW2hdICYmIGxheXVpW2hdICYmIChuLm1vZHVsZXNbaF0gPSBnKSwgbi5tb2R1bGVzW2hdKSAhZnVuY3Rpb24gUygpIHsKICAgICAgcmV0dXJuICsrbSA+IDFlMyAqIG4udGltZW91dCAvIDQgPyBpKGggKyAiIGlzIG5vdCBhIHZhbGlkIG1vZHVsZSIsICJlcnJvciIpIDogdm9pZCAoInN0cmluZyIgPT0gdHlwZW9mIG4ubW9kdWxlc1toXSAmJiBuLnN0YXR1c1toXSA/IGYoKSA6IHNldFRpbWVvdXQoUywgNCkpOwogICAgfSgpO2Vsc2UgewogICAgICB2YXIgYiA9IGUuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgIGIuYXN5bmMgPSAhMCwgYi5jaGFyc2V0ID0gInV0Zi04IiwgYi5zcmMgPSBnICsgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0ID0gbi52ZXJzaW9uID09PSAhMCA/IG4udiB8fCBuZXcgRGF0ZSgpLmdldFRpbWUoKSA6IG4udmVyc2lvbiB8fCAiIjsKICAgICAgICByZXR1cm4gdCA/ICI/dj0iICsgdCA6ICIiOwogICAgICB9KCksIHYuYXBwZW5kQ2hpbGQoYiksICFiLmF0dGFjaEV2ZW50IHx8IGIuYXR0YWNoRXZlbnQudG9TdHJpbmcgJiYgYi5hdHRhY2hFdmVudC50b1N0cmluZygpLmluZGV4T2YoIltuYXRpdmUgY29kZSIpIDwgMCB8fCB1ID8gYi5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgZnVuY3Rpb24gKHQpIHsKICAgICAgICBwKHQsIGcpOwogICAgICB9LCAhMSkgOiBiLmF0dGFjaEV2ZW50KCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBmdW5jdGlvbiAodCkgewogICAgICAgIHAodCwgZyk7CiAgICAgIH0pLCBuLm1vZHVsZXNbaF0gPSBnOwogICAgfQogICAgcmV0dXJuIHk7CiAgfSwgci5wcm90b3R5cGUuZ2V0U3R5bGUgPSBmdW5jdGlvbiAoZSwgbikgewogICAgdmFyIHIgPSBlLmN1cnJlbnRTdHlsZSA/IGUuY3VycmVudFN0eWxlIDogdC5nZXRDb21wdXRlZFN0eWxlKGUsIG51bGwpOwogICAgcmV0dXJuIHJbci5nZXRQcm9wZXJ0eVZhbHVlID8gImdldFByb3BlcnR5VmFsdWUiIDogImdldEF0dHJpYnV0ZSJdKG4pOwogIH0sIHIucHJvdG90eXBlLmxpbmsgPSBmdW5jdGlvbiAodCwgciwgbykgewogICAgdmFyIGEgPSB0aGlzLAogICAgICAgIHUgPSBlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF0sCiAgICAgICAgbCA9IGUuY3JlYXRlRWxlbWVudCgibGluayIpOwogICAgInN0cmluZyIgPT0gdHlwZW9mIHIgJiYgKG8gPSByKTsKICAgIHZhciBjID0gKG8gfHwgdCkucmVwbGFjZSgvXC58XC8vZywgIiIpLAogICAgICAgIHMgPSBsLmlkID0gImxheXVpY3NzLSIgKyBjLAogICAgICAgIHAgPSAiY3JlYXRpbmciLAogICAgICAgIGYgPSAwOwogICAgcmV0dXJuIGwucmVsID0gInN0eWxlc2hlZXQiLCBsLmhyZWYgPSB0ICsgKG4uZGVidWcgPyAiP3Y9IiArIG5ldyBEYXRlKCkuZ2V0VGltZSgpIDogIiIpLCBsLm1lZGlhID0gImFsbCIsIGUuZ2V0RWxlbWVudEJ5SWQocykgfHwgdS5hcHBlbmRDaGlsZChsKSwgImZ1bmN0aW9uIiAhPSB0eXBlb2YgciA/IGEgOiAoZnVuY3Rpb24geShvKSB7CiAgICAgIHZhciB1ID0gMTAwLAogICAgICAgICAgbCA9IGUuZ2V0RWxlbWVudEJ5SWQocyk7CiAgICAgIHJldHVybiArK2YgPiAxZTMgKiBuLnRpbWVvdXQgLyB1ID8gaSh0ICsgIiB0aW1lb3V0IikgOiB2b2lkICgxOTg5ID09PSBwYXJzZUludChhLmdldFN0eWxlKGwsICJ3aWR0aCIpKSA/IChvID09PSBwICYmIGwucmVtb3ZlQXR0cmlidXRlKCJsYXktc3RhdHVzIiksIGwuZ2V0QXR0cmlidXRlKCJsYXktc3RhdHVzIikgPT09IHAgPyBzZXRUaW1lb3V0KHksIHUpIDogcigpKSA6IChsLnNldEF0dHJpYnV0ZSgibGF5LXN0YXR1cyIsIHApLCBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICB5KHApOwogICAgICB9LCB1KSkpOwogICAgfSgpLCBhKTsKICB9LCByLnByb3RvdHlwZS5hZGRjc3MgPSBmdW5jdGlvbiAodCwgZSwgcikgewogICAgcmV0dXJuIGxheXVpLmxpbmsobi5kaXIgKyAiY3NzLyIgKyB0LCBlLCByKTsKICB9LCBuLmNhbGxiYWNrID0ge30sIHIucHJvdG90eXBlLmZhY3RvcnkgPSBmdW5jdGlvbiAodCkgewogICAgaWYgKGxheXVpW3RdKSByZXR1cm4gImZ1bmN0aW9uIiA9PSB0eXBlb2Ygbi5jYWxsYmFja1t0XSA/IG4uY2FsbGJhY2tbdF0gOiBudWxsOwogIH0sIHIucHJvdG90eXBlLmltZyA9IGZ1bmN0aW9uICh0LCBlLCBuKSB7CiAgICB2YXIgciA9IG5ldyBJbWFnZSgpOwogICAgcmV0dXJuIHIuc3JjID0gdCwgci5jb21wbGV0ZSA/IGUocikgOiAoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHIub25sb2FkID0gbnVsbCwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgZSAmJiBlKHIpOwogICAgfSwgdm9pZCAoci5vbmVycm9yID0gZnVuY3Rpb24gKHQpIHsKICAgICAgci5vbmVycm9yID0gbnVsbCwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgbiAmJiBuKHQpOwogICAgfSkpOwogIH0sIHIucHJvdG90eXBlLmNvbmZpZyA9IGZ1bmN0aW9uICh0KSB7CiAgICB0ID0gdCB8fCB7fTsKCiAgICBmb3IgKHZhciBlIGluIHQpIHsKICAgICAgbltlXSA9IHRbZV07CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwgci5wcm90b3R5cGUubW9kdWxlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciB0ID0ge307CgogICAgZm9yICh2YXIgZSBpbiBsKSB7CiAgICAgIHRbZV0gPSBsW2VdOwogICAgfQoKICAgIHJldHVybiB0OwogIH0oKSwgci5wcm90b3R5cGUuZXh0ZW5kID0gZnVuY3Rpb24gKHQpIHsKICAgIHZhciBlID0gdGhpczsKICAgIHQgPSB0IHx8IHt9OwoKICAgIGZvciAodmFyIG4gaW4gdCkgewogICAgICBlW25dIHx8IGUubW9kdWxlc1tuXSA/IGkobiArICIgTW9kdWxlIGFscmVhZHkgZXhpc3RzIiwgImVycm9yIikgOiBlLm1vZHVsZXNbbl0gPSB0W25dOwogICAgfQoKICAgIHJldHVybiBlOwogIH0sIHIucHJvdG90eXBlLnJvdXRlciA9IGZ1bmN0aW9uICh0KSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgdCA9IHQgfHwgbG9jYXRpb24uaGFzaCwKICAgICAgICBuID0gewogICAgICBwYXRoOiBbXSwKICAgICAgc2VhcmNoOiB7fSwKICAgICAgaGFzaDogKHQubWF0Y2goL1teI10oIy4qJCkvKSB8fCBbXSlbMV0gfHwgIiIKICAgIH07CiAgICByZXR1cm4gL14jXC8vLnRlc3QodCkgPyAodCA9IHQucmVwbGFjZSgvXiNcLy8sICIiKSwgbi5ocmVmID0gIi8iICsgdCwgdCA9IHQucmVwbGFjZSgvKFteI10pKCMuKiQpLywgIiQxIikuc3BsaXQoIi8iKSB8fCBbXSwgZS5lYWNoKHQsIGZ1bmN0aW9uICh0LCBlKSB7CiAgICAgIC9eXHcrPS8udGVzdChlKSA/IGZ1bmN0aW9uICgpIHsKICAgICAgICBlID0gZS5zcGxpdCgiPSIpLCBuLnNlYXJjaFtlWzBdXSA9IGVbMV07CiAgICAgIH0oKSA6IG4ucGF0aC5wdXNoKGUpOwogICAgfSksIG4pIDogbjsKICB9LCByLnByb3RvdHlwZS51cmwgPSBmdW5jdGlvbiAodCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIG4gPSB7CiAgICAgIHBhdGhuYW1lOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGUgPSB0ID8gZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGUgPSAodC5tYXRjaCgvXC5bXi5dKz9cLy4rLykgfHwgW10pWzBdIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGUucmVwbGFjZSgvXlteXC9dKy8sICIiKS5yZXBsYWNlKC9cPy4rLywgIiIpOwogICAgICAgIH0oKSA6IGxvY2F0aW9uLnBhdGhuYW1lOwogICAgICAgIHJldHVybiBlLnJlcGxhY2UoL15cLy8sICIiKS5zcGxpdCgiLyIpOwogICAgICB9KCksCiAgICAgIHNlYXJjaDogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBuID0ge30sCiAgICAgICAgICAgIHIgPSAodCA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBlID0gKHQubWF0Y2goL1w/LisvKSB8fCBbXSlbMF0gfHwgIiI7CiAgICAgICAgICByZXR1cm4gZS5yZXBsYWNlKC9cIy4rLywgIiIpOwogICAgICAgIH0oKSA6IGxvY2F0aW9uLnNlYXJjaCkucmVwbGFjZSgvXlw/Ky8sICIiKS5zcGxpdCgiJiIpOwogICAgICAgIHJldHVybiBlLmVhY2gociwgZnVuY3Rpb24gKHQsIGUpIHsKICAgICAgICAgIHZhciByID0gZS5pbmRleE9mKCI9IiksCiAgICAgICAgICAgICAgbyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHIgPCAwID8gZS5zdWJzdHIoMCwgZS5sZW5ndGgpIDogMCAhPT0gciAmJiBlLnN1YnN0cigwLCByKTsKICAgICAgICAgIH0oKTsKCiAgICAgICAgICBvICYmIChuW29dID0gciA+IDAgPyBlLnN1YnN0cihyICsgMSkgOiBudWxsKTsKICAgICAgICB9KSwgbjsKICAgICAgfSgpLAogICAgICBoYXNoOiBlLnJvdXRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHQgPyAodC5tYXRjaCgvIy4rLykgfHwgW10pWzBdIHx8ICIvIiA6IGxvY2F0aW9uLmhhc2g7CiAgICAgIH0oKSkKICAgIH07CiAgICByZXR1cm4gbjsKICB9LCByLnByb3RvdHlwZS5kYXRhID0gZnVuY3Rpb24gKGUsIG4sIHIpIHsKICAgIGlmIChlID0gZSB8fCAibGF5dWkiLCByID0gciB8fCBsb2NhbFN0b3JhZ2UsIHQuSlNPTiAmJiB0LkpTT04ucGFyc2UpIHsKICAgICAgaWYgKG51bGwgPT09IG4pIHJldHVybiBkZWxldGUgcltlXTsKICAgICAgbiA9ICJvYmplY3QiID09IF90eXBlb2YobikgPyBuIDogewogICAgICAgIGtleTogbgogICAgICB9OwoKICAgICAgdHJ5IHsKICAgICAgICB2YXIgbyA9IEpTT04ucGFyc2UocltlXSk7CiAgICAgIH0gY2F0Y2ggKGEpIHsKICAgICAgICB2YXIgbyA9IHt9OwogICAgICB9CgogICAgICByZXR1cm4gInZhbHVlIiBpbiBuICYmIChvW24ua2V5XSA9IG4udmFsdWUpLCBuLnJlbW92ZSAmJiBkZWxldGUgb1tuLmtleV0sIHJbZV0gPSBKU09OLnN0cmluZ2lmeShvKSwgbi5rZXkgPyBvW24ua2V5XSA6IG87CiAgICB9CiAgfSwgci5wcm90b3R5cGUuc2Vzc2lvbkRhdGEgPSBmdW5jdGlvbiAodCwgZSkgewogICAgcmV0dXJuIHRoaXMuZGF0YSh0LCBlLCBzZXNzaW9uU3RvcmFnZSk7CiAgfSwgci5wcm90b3R5cGUuZGV2aWNlID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBuID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLAogICAgICAgIHIgPSBmdW5jdGlvbiByKHQpIHsKICAgICAgdmFyIGUgPSBuZXcgUmVnRXhwKHQgKyAiLyhbXlxcc1xcX1xcLV0rKSIpOwogICAgICByZXR1cm4gdCA9IChuLm1hdGNoKGUpIHx8IFtdKVsxXSwgdCB8fCAhMTsKICAgIH0sCiAgICAgICAgbyA9IHsKICAgICAgb3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gL3dpbmRvd3MvLnRlc3QobikgPyAid2luZG93cyIgOiAvbGludXgvLnRlc3QobikgPyAibGludXgiIDogL2lwaG9uZXxpcG9kfGlwYWR8aW9zLy50ZXN0KG4pID8gImlvcyIgOiAvbWFjLy50ZXN0KG4pID8gIm1hYyIgOiB2b2lkIDA7CiAgICAgIH0oKSwKICAgICAgaWU6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gISEodC5BY3RpdmVYT2JqZWN0IHx8ICJBY3RpdmVYT2JqZWN0IiBpbiB0KSAmJiAoKG4ubWF0Y2goL21zaWVccyhcZCspLykgfHwgW10pWzFdIHx8ICIxMSIpOwogICAgICB9KCksCiAgICAgIHdlaXhpbjogcigibWljcm9tZXNzZW5nZXIiKQogICAgfTsKCiAgICByZXR1cm4gZSAmJiAhb1tlXSAmJiAob1tlXSA9IHIoZSkpLCBvLmFuZHJvaWQgPSAvYW5kcm9pZC8udGVzdChuKSwgby5pb3MgPSAiaW9zIiA9PT0gby5vcywgby5tb2JpbGUgPSAhKCFvLmFuZHJvaWQgJiYgIW8uaW9zKSwgbzsKICB9LCByLnByb3RvdHlwZS5oaW50ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHsKICAgICAgZXJyb3I6IGkKICAgIH07CiAgfSwgci5wcm90b3R5cGUuX3R5cGVvZiA9IGZ1bmN0aW9uICh0KSB7CiAgICByZXR1cm4gbnVsbCA9PT0gdCA/IFN0cmluZyh0KSA6ICJvYmplY3QiID09IF90eXBlb2YodCkgfHwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgdCA/IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodCkubWF0Y2goL1xzKC4rKVxdJC8pIHx8IFtdLAogICAgICAgICAgbiA9ICJGdW5jdGlvbnxBcnJheXxEYXRlfFJlZ0V4cHxPYmplY3R8RXJyb3J8U3ltYm9sIjsKICAgICAgcmV0dXJuIGUgPSBlWzFdIHx8ICJPYmplY3QiLCBuZXcgUmVnRXhwKCJcXGIoIiArIG4gKyAiKVxcYiIpLnRlc3QoZSkgPyBlLnRvTG93ZXJDYXNlKCkgOiAib2JqZWN0IjsKICAgIH0oKSA6IF90eXBlb2YodCk7CiAgfSwgci5wcm90b3R5cGUuX2lzQXJyYXkgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIG4sCiAgICAgICAgciA9IHRoaXMsCiAgICAgICAgbyA9IHIuX3R5cGVvZihlKTsKCiAgICByZXR1cm4gISghZSB8fCAib2JqZWN0IiAhPSBfdHlwZW9mKGUpIHx8IGUgPT09IHQpICYmIChuID0gImxlbmd0aCIgaW4gZSAmJiBlLmxlbmd0aCwgImFycmF5IiA9PT0gbyB8fCAwID09PSBuIHx8ICJudW1iZXIiID09IHR5cGVvZiBuICYmIG4gPiAwICYmIG4gLSAxIGluIGUpOwogIH0sIHIucHJvdG90eXBlLmVhY2ggPSBmdW5jdGlvbiAodCwgZSkgewogICAgdmFyIG4sCiAgICAgICAgciA9IHRoaXMsCiAgICAgICAgbyA9IGZ1bmN0aW9uIG8odCwgbikgewogICAgICByZXR1cm4gZS5jYWxsKG5bdF0sIHQsIG5bdF0pOwogICAgfTsKCiAgICBpZiAoImZ1bmN0aW9uIiAhPSB0eXBlb2YgZSkgcmV0dXJuIHI7CiAgICBpZiAodCA9IHQgfHwgW10sIHIuX2lzQXJyYXkodCkpIGZvciAobiA9IDA7IG4gPCB0Lmxlbmd0aCAmJiAhbyhuLCB0KTsgbisrKSB7CiAgICAgIDsKICAgIH0gZWxzZSBmb3IgKG4gaW4gdCkgewogICAgICBpZiAobyhuLCB0KSkgYnJlYWs7CiAgICB9CiAgICByZXR1cm4gcjsKICB9LCByLnByb3RvdHlwZS5zb3J0ID0gZnVuY3Rpb24gKHQsIGUsIG4pIHsKICAgIHZhciByID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0IHx8IFtdKSk7CiAgICByZXR1cm4gZSA/IChyLnNvcnQoZnVuY3Rpb24gKHQsIG4pIHsKICAgICAgdmFyIHIgPSB0W2VdLAogICAgICAgICAgbyA9IG5bZV0sCiAgICAgICAgICBhID0gWyFpc05hTihyKSwgIWlzTmFOKG8pXTsKICAgICAgcmV0dXJuIGFbMF0gJiYgYVsxXSA/IHIgJiYgIW8gJiYgMCAhPT0gbyA/IDEgOiAhciAmJiAwICE9PSByICYmIG8gPyAtMSA6IHIgLSBvIDogYVswXSB8fCBhWzFdID8gYVswXSB8fCAhYVsxXSA/IC0xIDogIWFbMF0gfHwgYVsxXSA/IDEgOiB2b2lkIDAgOiByID4gbyA/IDEgOiByIDwgbyA/IC0xIDogMDsKICAgIH0pLCBuICYmIHIucmV2ZXJzZSgpLCByKSA6IHI7CiAgfSwgci5wcm90b3R5cGUuc3RvcGUgPSBmdW5jdGlvbiAoZSkgewogICAgZSA9IGUgfHwgdC5ldmVudDsKCiAgICB0cnkgewogICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgfSBjYXRjaCAobikgewogICAgICBlLmNhbmNlbEJ1YmJsZSA9ICEwOwogICAgfQogIH07CiAgdmFyIGMgPSAiTEFZVUktRVZFTlQtUkVNT1ZFIjsKICByLnByb3RvdHlwZS5vbmV2ZW50ID0gZnVuY3Rpb24gKHQsIGUsIG4pIHsKICAgIHJldHVybiAic3RyaW5nIiAhPSB0eXBlb2YgdCB8fCAiZnVuY3Rpb24iICE9IHR5cGVvZiBuID8gdGhpcyA6IHIuZXZlbnQodCwgZSwgbnVsbCwgbik7CiAgfSwgci5wcm90b3R5cGUuZXZlbnQgPSByLmV2ZW50ID0gZnVuY3Rpb24gKHQsIGUsIHIsIG8pIHsKICAgIHZhciBhID0gdGhpcywKICAgICAgICBpID0gbnVsbCwKICAgICAgICB1ID0gKGUgfHwgIiIpLm1hdGNoKC9cKCguKilcKSQvKSB8fCBbXSwKICAgICAgICBsID0gKHQgKyAiLiIgKyBlKS5yZXBsYWNlKHVbMF0sICIiKSwKICAgICAgICBzID0gdVsxXSB8fCAiIiwKICAgICAgICBwID0gZnVuY3Rpb24gcCh0LCBlKSB7CiAgICAgIHZhciBuID0gZSAmJiBlLmNhbGwoYSwgcik7CiAgICAgIG4gPT09ICExICYmIG51bGwgPT09IGkgJiYgKGkgPSAhMSk7CiAgICB9OwoKICAgIHJldHVybiByID09PSBjID8gKGRlbGV0ZSAoYS5jYWNoZS5ldmVudFtsXSB8fCB7fSlbc10sIGEpIDogbyA/IChuLmV2ZW50W2xdID0gbi5ldmVudFtsXSB8fCB7fSwgbi5ldmVudFtsXVtzXSA9IFtvXSwgdGhpcykgOiAobGF5dWkuZWFjaChuLmV2ZW50W2xdLCBmdW5jdGlvbiAodCwgZSkgewogICAgICByZXR1cm4gInsqfSIgPT09IHMgPyB2b2lkIGxheXVpLmVhY2goZSwgcCkgOiAoIiIgPT09IHQgJiYgbGF5dWkuZWFjaChlLCBwKSwgdm9pZCAocyAmJiB0ID09PSBzICYmIGxheXVpLmVhY2goZSwgcCkpKTsKICAgIH0pLCBpKTsKICB9LCByLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uICh0LCBlLCBuKSB7CiAgICB2YXIgciA9IHRoaXM7CiAgICByZXR1cm4gci5vbmV2ZW50LmNhbGwociwgZSwgdCwgbik7CiAgfSwgci5wcm90b3R5cGUub2ZmID0gZnVuY3Rpb24gKHQsIGUpIHsKICAgIHZhciBuID0gdGhpczsKICAgIHJldHVybiBuLmV2ZW50LmNhbGwobiwgZSwgdCwgYyk7CiAgfSwgdC5sYXl1aSA9IG5ldyByKCk7Cn0od2luZG93KTsKbGF5dWkuZGVmaW5lKGZ1bmN0aW9uIChhKSB7CiAgdmFyIGkgPSBsYXl1aS5jYWNoZTsKICBsYXl1aS5jb25maWcoewogICAgZGlyOiBpLmRpci5yZXBsYWNlKC9sYXlcL2Rlc3RcLyQvLCAiIikKICB9KSwgYSgibGF5dWkuYWxsIiwgbGF5dWkudik7Cn0pOwohZnVuY3Rpb24gKHQpIHsKICAidXNlIHN0cmljdCI7CgogIHZhciBlID0gImxheSIsCiAgICAgIG4gPSB0LmRvY3VtZW50LAogICAgICByID0gZnVuY3Rpb24gcih0KSB7CiAgICByZXR1cm4gbmV3IG8odCk7CiAgfSwKICAgICAgbyA9IGZ1bmN0aW9uIG8odCkgewogICAgZm9yICh2YXIgZSA9IDAsIHIgPSAib2JqZWN0IiA9PSBfdHlwZW9mKHQpID8gW3RdIDogKHRoaXMuc2VsZWN0b3IgPSB0LCBuLnF1ZXJ5U2VsZWN0b3JBbGwodCB8fCBudWxsKSk7IGUgPCByLmxlbmd0aDsgZSsrKSB7CiAgICAgIHRoaXMucHVzaChyW2VdKTsKICAgIH0KICB9OwoKICBvLnByb3RvdHlwZSA9IFtdLCBvLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IG8sIHIuZXh0ZW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHQgPSAxLAogICAgICAgIGUgPSBhcmd1bWVudHMsCiAgICAgICAgbiA9IGZ1bmN0aW9uIG4odCwgZSkgewogICAgICB0ID0gdCB8fCAoImFycmF5IiA9PT0gbGF5dWkuX3R5cGVvZihlKSA/IFtdIDoge30pOwoKICAgICAgZm9yICh2YXIgciBpbiBlKSB7CiAgICAgICAgdFtyXSA9IGVbcl0gJiYgZVtyXS5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0ID8gbih0W3JdLCBlW3JdKSA6IGVbcl07CiAgICAgIH0KCiAgICAgIHJldHVybiB0OwogICAgfTsKCiAgICBmb3IgKGVbMF0gPSAib2JqZWN0IiA9PSBfdHlwZW9mKGVbMF0pID8gZVswXSA6IHt9OyB0IDwgZS5sZW5ndGg7IHQrKykgewogICAgICAib2JqZWN0IiA9PSBfdHlwZW9mKGVbdF0pICYmIG4oZVswXSwgZVt0XSk7CiAgICB9CgogICAgcmV0dXJuIGVbMF07CiAgfSwgci52ID0gIjEuMC44Iiwgci5pZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpOwogICAgcmV0dXJuICEhKHQuQWN0aXZlWE9iamVjdCB8fCAiQWN0aXZlWE9iamVjdCIgaW4gdCkgJiYgKChlLm1hdGNoKC9tc2llXHMoXGQrKS8pIHx8IFtdKVsxXSB8fCAiMTEiKTsKICB9KCksIHIubGF5dWkgPSBsYXl1aSB8fCB7fSwgci5nZXRQYXRoID0gbGF5dWkuY2FjaGUuZGlyLCByLnN0b3BlID0gbGF5dWkuc3RvcGUsIHIuZWFjaCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBsYXl1aS5lYWNoLmFwcGx5KGxheXVpLCBhcmd1bWVudHMpLCB0aGlzOwogIH0sIHIuZGlnaXQgPSBmdW5jdGlvbiAodCwgZSwgbikgewogICAgdmFyIHIgPSAiIjsKICAgIHQgPSBTdHJpbmcodCksIGUgPSBlIHx8IDI7CgogICAgZm9yICh2YXIgbyA9IHQubGVuZ3RoOyBvIDwgZTsgbysrKSB7CiAgICAgIHIgKz0gIjAiOwogICAgfQoKICAgIHJldHVybiB0IDwgTWF0aC5wb3coMTAsIGUpID8gciArICgwIHwgdCkgOiB0OwogIH0sIHIuZWxlbSA9IGZ1bmN0aW9uICh0LCBlKSB7CiAgICB2YXIgbyA9IG4uY3JlYXRlRWxlbWVudCh0KTsKICAgIHJldHVybiByLmVhY2goZSB8fCB7fSwgZnVuY3Rpb24gKHQsIGUpIHsKICAgICAgby5zZXRBdHRyaWJ1dGUodCwgZSk7CiAgICB9KSwgbzsKICB9LCByLmhhc1Njcm9sbGJhciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuLmJvZHkuc2Nyb2xsSGVpZ2h0ID4gKHQuaW5uZXJIZWlnaHQgfHwgbi5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0KTsKICB9LCByLnBvc2l0aW9uID0gZnVuY3Rpb24gKGUsIG8sIGkpIHsKICAgIGlmIChvKSB7CiAgICAgIGkgPSBpIHx8IHt9LCBlICE9PSBuICYmIGUgIT09IHIoImJvZHkiKVswXSB8fCAoaS5jbGlja1R5cGUgPSAicmlnaHQiKTsKCiAgICAgIHZhciBjID0gInJpZ2h0IiA9PT0gaS5jbGlja1R5cGUgPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGUgPSBpLmUgfHwgdC5ldmVudCB8fCB7fTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbGVmdDogZS5jbGllbnRYLAogICAgICAgICAgdG9wOiBlLmNsaWVudFksCiAgICAgICAgICByaWdodDogZS5jbGllbnRYLAogICAgICAgICAgYm90dG9tOiBlLmNsaWVudFkKICAgICAgICB9OwogICAgICB9KCkgOiBlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLAogICAgICAgICAgdSA9IG8ub2Zmc2V0V2lkdGgsCiAgICAgICAgICBhID0gby5vZmZzZXRIZWlnaHQsCiAgICAgICAgICBmID0gZnVuY3Rpb24gZih0KSB7CiAgICAgICAgcmV0dXJuIHQgPSB0ID8gInNjcm9sbExlZnQiIDogInNjcm9sbFRvcCIsIG4uYm9keVt0XSB8IG4uZG9jdW1lbnRFbGVtZW50W3RdOwogICAgICB9LAogICAgICAgICAgcyA9IGZ1bmN0aW9uIHModCkgewogICAgICAgIHJldHVybiBuLmRvY3VtZW50RWxlbWVudFt0ID8gImNsaWVudFdpZHRoIiA6ICJjbGllbnRIZWlnaHQiXTsKICAgICAgfSwKICAgICAgICAgIGwgPSA1LAogICAgICAgICAgaCA9IGMubGVmdCwKICAgICAgICAgIHAgPSBjLmJvdHRvbTsKCiAgICAgICJjZW50ZXIiID09PSBpLmFsaWduID8gaCAtPSAodSAtIGUub2Zmc2V0V2lkdGgpIC8gMiA6ICJyaWdodCIgPT09IGkuYWxpZ24gJiYgKGggPSBoIC0gdSArIGUub2Zmc2V0V2lkdGgpLCBoICsgdSArIGwgPiBzKCJ3aWR0aCIpICYmIChoID0gcygid2lkdGgiKSAtIHUgLSBsKSwgaCA8IGwgJiYgKGggPSBsKSwgcCArIGEgKyBsID4gcygpICYmIChjLnRvcCA+IGEgKyBsID8gcCA9IGMudG9wIC0gYSAtIDIgKiBsIDogInJpZ2h0IiA9PT0gaS5jbGlja1R5cGUgJiYgKHAgPSBzKCkgLSBhIC0gMiAqIGwsIHAgPCAwICYmIChwID0gMCkpKTsKICAgICAgdmFyIHkgPSBpLnBvc2l0aW9uOwoKICAgICAgaWYgKHkgJiYgKG8uc3R5bGUucG9zaXRpb24gPSB5KSwgby5zdHlsZS5sZWZ0ID0gaCArICgiZml4ZWQiID09PSB5ID8gMCA6IGYoMSkpICsgInB4Iiwgby5zdHlsZS50b3AgPSBwICsgKCJmaXhlZCIgPT09IHkgPyAwIDogZigpKSArICJweCIsICFyLmhhc1Njcm9sbGJhcigpKSB7CiAgICAgICAgdmFyIGQgPSBvLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICFpLlNZU1RFTV9SRUxPQUQgJiYgZC5ib3R0b20gKyBsID4gcygpICYmIChpLlNZU1RFTV9SRUxPQUQgPSAhMCwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICByLnBvc2l0aW9uKGUsIG8sIGkpOwogICAgICAgIH0sIDUwKSk7CiAgICAgIH0KICAgIH0KICB9LCByLm9wdGlvbnMgPSBmdW5jdGlvbiAodCwgZSkgewogICAgdmFyIG4gPSByKHQpLAogICAgICAgIG8gPSBlIHx8ICJsYXktb3B0aW9ucyI7CgogICAgdHJ5IHsKICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbigicmV0dXJuICIgKyAobi5hdHRyKG8pIHx8ICJ7fSIpKSgpOwogICAgfSBjYXRjaCAoaSkgewogICAgICByZXR1cm4gaGludC5lcnJvcigicGFyc2VlcnJvclx1RkYxQSIgKyBpLCAiZXJyb3IiKSwge307CiAgICB9CiAgfSwgci5pc1RvcEVsZW0gPSBmdW5jdGlvbiAodCkgewogICAgdmFyIGUgPSBbbiwgcigiYm9keSIpWzBdXSwKICAgICAgICBvID0gITE7CiAgICByZXR1cm4gci5lYWNoKGUsIGZ1bmN0aW9uIChlLCBuKSB7CiAgICAgIGlmIChuID09PSB0KSByZXR1cm4gbyA9ICEwOwogICAgfSksIG87CiAgfSwgby5hZGRTdHIgPSBmdW5jdGlvbiAodCwgZSkgewogICAgcmV0dXJuIHQgPSB0LnJlcGxhY2UoL1xzKy8sICIgIiksIGUgPSBlLnJlcGxhY2UoL1xzKy8sICIgIikuc3BsaXQoIiAiKSwgci5lYWNoKGUsIGZ1bmN0aW9uIChlLCBuKSB7CiAgICAgIG5ldyBSZWdFeHAoIlxcYiIgKyBuICsgIlxcYiIpLnRlc3QodCkgfHwgKHQgPSB0ICsgIiAiICsgbik7CiAgICB9KSwgdC5yZXBsYWNlKC9eXHN8XHMkLywgIiIpOwogIH0sIG8ucmVtb3ZlU3RyID0gZnVuY3Rpb24gKHQsIGUpIHsKICAgIHJldHVybiB0ID0gdC5yZXBsYWNlKC9ccysvLCAiICIpLCBlID0gZS5yZXBsYWNlKC9ccysvLCAiICIpLnNwbGl0KCIgIiksIHIuZWFjaChlLCBmdW5jdGlvbiAoZSwgbikgewogICAgICB2YXIgciA9IG5ldyBSZWdFeHAoIlxcYiIgKyBuICsgIlxcYiIpOwogICAgICByLnRlc3QodCkgJiYgKHQgPSB0LnJlcGxhY2UociwgIiIpKTsKICAgIH0pLCB0LnJlcGxhY2UoL1xzKy8sICIgIikucmVwbGFjZSgvXlxzfFxzJC8sICIiKTsKICB9LCBvLnByb3RvdHlwZS5maW5kID0gZnVuY3Rpb24gKHQpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICBuID0gMCwKICAgICAgICBvID0gW10sCiAgICAgICAgaSA9ICJvYmplY3QiID09IF90eXBlb2YodCk7CgogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAociwgYykgewogICAgICBmb3IgKHZhciB1ID0gaSA/IGMuY29udGFpbnModCkgOiBjLnF1ZXJ5U2VsZWN0b3JBbGwodCB8fCBudWxsKTsgbiA8IHUubGVuZ3RoOyBuKyspIHsKICAgICAgICBvLnB1c2godVtuXSk7CiAgICAgIH0KCiAgICAgIGUuc2hpZnQoKTsKICAgIH0pLCBpIHx8IChlLnNlbGVjdG9yID0gKGUuc2VsZWN0b3IgPyBlLnNlbGVjdG9yICsgIiAiIDogIiIpICsgdCksIHIuZWFjaChvLCBmdW5jdGlvbiAodCwgbikgewogICAgICBlLnB1c2gobik7CiAgICB9KSwgZTsKICB9LCBvLnByb3RvdHlwZS5lYWNoID0gZnVuY3Rpb24gKHQpIHsKICAgIHJldHVybiByLmVhY2guY2FsbCh0aGlzLCB0aGlzLCB0KTsKICB9LCBvLnByb3RvdHlwZS5hZGRDbGFzcyA9IGZ1bmN0aW9uICh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChuLCByKSB7CiAgICAgIHIuY2xhc3NOYW1lID0gb1tlID8gInJlbW92ZVN0ciIgOiAiYWRkU3RyIl0oci5jbGFzc05hbWUsIHQpOwogICAgfSk7CiAgfSwgby5wcm90b3R5cGUucmVtb3ZlQ2xhc3MgPSBmdW5jdGlvbiAodCkgewogICAgcmV0dXJuIHRoaXMuYWRkQ2xhc3ModCwgITApOwogIH0sIG8ucHJvdG90eXBlLmhhc0NsYXNzID0gZnVuY3Rpb24gKHQpIHsKICAgIHZhciBlID0gITE7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChuLCByKSB7CiAgICAgIG5ldyBSZWdFeHAoIlxcYiIgKyB0ICsgIlxcYiIpLnRlc3Qoci5jbGFzc05hbWUpICYmIChlID0gITApOwogICAgfSksIGU7CiAgfSwgby5wcm90b3R5cGUuY3NzID0gZnVuY3Rpb24gKHQsIGUpIHsKICAgIHZhciBuID0gdGhpcywKICAgICAgICBvID0gZnVuY3Rpb24gbyh0KSB7CiAgICAgIHJldHVybiBpc05hTih0KSA/IHQgOiB0ICsgInB4IjsKICAgIH07CgogICAgcmV0dXJuICJzdHJpbmciID09IHR5cGVvZiB0ICYmIHZvaWQgMCA9PT0gZSA/IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKG4ubGVuZ3RoID4gMCkgcmV0dXJuIG5bMF0uc3R5bGVbdF07CiAgICB9KCkgOiBuLmVhY2goZnVuY3Rpb24gKG4sIGkpIHsKICAgICAgIm9iamVjdCIgPT0gX3R5cGVvZih0KSA/IHIuZWFjaCh0LCBmdW5jdGlvbiAodCwgZSkgewogICAgICAgIGkuc3R5bGVbdF0gPSBvKGUpOwogICAgICB9KSA6IGkuc3R5bGVbdF0gPSBvKGUpOwogICAgfSk7CiAgfSwgby5wcm90b3R5cGUud2lkdGggPSBmdW5jdGlvbiAodCkgewogICAgdmFyIGUgPSB0aGlzOwogICAgcmV0dXJuIHZvaWQgMCA9PT0gdCA/IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGUubGVuZ3RoID4gMCkgcmV0dXJuIGVbMF0ub2Zmc2V0V2lkdGg7CiAgICB9KCkgOiBlLmVhY2goZnVuY3Rpb24gKG4sIHIpIHsKICAgICAgZS5jc3MoIndpZHRoIiwgdCk7CiAgICB9KTsKICB9LCBvLnByb3RvdHlwZS5oZWlnaHQgPSBmdW5jdGlvbiAodCkgewogICAgdmFyIGUgPSB0aGlzOwogICAgcmV0dXJuIHZvaWQgMCA9PT0gdCA/IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGUubGVuZ3RoID4gMCkgcmV0dXJuIGVbMF0ub2Zmc2V0SGVpZ2h0OwogICAgfSgpIDogZS5lYWNoKGZ1bmN0aW9uIChuLCByKSB7CiAgICAgIGUuY3NzKCJoZWlnaHQiLCB0KTsKICAgIH0pOwogIH0sIG8ucHJvdG90eXBlLmF0dHIgPSBmdW5jdGlvbiAodCwgZSkgewogICAgdmFyIG4gPSB0aGlzOwogICAgcmV0dXJuIHZvaWQgMCA9PT0gZSA/IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKG4ubGVuZ3RoID4gMCkgcmV0dXJuIG5bMF0uZ2V0QXR0cmlidXRlKHQpOwogICAgfSgpIDogbi5lYWNoKGZ1bmN0aW9uIChuLCByKSB7CiAgICAgIHIuc2V0QXR0cmlidXRlKHQsIGUpOwogICAgfSk7CiAgfSwgby5wcm90b3R5cGUucmVtb3ZlQXR0ciA9IGZ1bmN0aW9uICh0KSB7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChlLCBuKSB7CiAgICAgIG4ucmVtb3ZlQXR0cmlidXRlKHQpOwogICAgfSk7CiAgfSwgby5wcm90b3R5cGUuaHRtbCA9IGZ1bmN0aW9uICh0KSB7CiAgICB2YXIgZSA9IHRoaXM7CiAgICByZXR1cm4gdm9pZCAwID09PSB0ID8gZnVuY3Rpb24gKCkgewogICAgICBpZiAoZS5sZW5ndGggPiAwKSByZXR1cm4gZVswXS5pbm5lckhUTUw7CiAgICB9KCkgOiB0aGlzLmVhY2goZnVuY3Rpb24gKGUsIG4pIHsKICAgICAgbi5pbm5lckhUTUwgPSB0OwogICAgfSk7CiAgfSwgby5wcm90b3R5cGUudmFsID0gZnVuY3Rpb24gKHQpIHsKICAgIHZhciBlID0gdGhpczsKICAgIHJldHVybiB2b2lkIDAgPT09IHQgPyBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChlLmxlbmd0aCA+IDApIHJldHVybiBlWzBdLnZhbHVlOwogICAgfSgpIDogdGhpcy5lYWNoKGZ1bmN0aW9uIChlLCBuKSB7CiAgICAgIG4udmFsdWUgPSB0OwogICAgfSk7CiAgfSwgby5wcm90b3R5cGUuYXBwZW5kID0gZnVuY3Rpb24gKHQpIHsKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGUsIG4pIHsKICAgICAgIm9iamVjdCIgPT0gX3R5cGVvZih0KSA/IG4uYXBwZW5kQ2hpbGQodCkgOiBuLmlubmVySFRNTCA9IG4uaW5uZXJIVE1MICsgdDsKICAgIH0pOwogIH0sIG8ucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uICh0KSB7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChlLCBuKSB7CiAgICAgIHQgPyBuLnJlbW92ZUNoaWxkKHQpIDogbi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG4pOwogICAgfSk7CiAgfSwgby5wcm90b3R5cGUub24gPSBmdW5jdGlvbiAodCwgZSkgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAobiwgcikgewogICAgICByLmF0dGFjaEV2ZW50ID8gci5hdHRhY2hFdmVudCgib24iICsgdCwgZnVuY3Rpb24gKHQpIHsKICAgICAgICB0LnRhcmdldCA9IHQuc3JjRWxlbWVudCwgZS5jYWxsKHIsIHQpOwogICAgICB9KSA6IHIuYWRkRXZlbnRMaXN0ZW5lcih0LCBlLCAhMSk7CiAgICB9KTsKICB9LCBvLnByb3RvdHlwZS5vZmYgPSBmdW5jdGlvbiAodCwgZSkgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAobiwgcikgewogICAgICByLmRldGFjaEV2ZW50ID8gci5kZXRhY2hFdmVudCgib24iICsgdCwgZSkgOiByLnJlbW92ZUV2ZW50TGlzdGVuZXIodCwgZSwgITEpOwogICAgfSk7CiAgfSwgdC5sYXkgPSByLCB0LmxheXVpICYmIGxheXVpLmRlZmluZSAmJiBsYXl1aS5kZWZpbmUoZnVuY3Rpb24gKHQpIHsKICAgIHQoZSwgcik7CiAgfSk7Cn0od2luZG93LCB3aW5kb3cuZG9jdW1lbnQpOwpsYXl1aS5kZWZpbmUoZnVuY3Rpb24gKGUpIHsKICAidXNlIHN0cmljdCI7CgogIHZhciByID0gewogICAgb3BlbjogInt7IiwKICAgIGNsb3NlOiAifX0iCiAgfSwKICAgICAgYyA9IHsKICAgIGV4cDogZnVuY3Rpb24gZXhwKGUpIHsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoZSwgImciKTsKICAgIH0sCiAgICBxdWVyeTogZnVuY3Rpb24gcXVlcnkoZSwgYywgdCkgewogICAgICB2YXIgbyA9IFsiIyhbXFxzXFxTXSkrPyIsICIoW157I31dKSo/Il1bZSB8fCAwXTsKICAgICAgcmV0dXJuIG4oKGMgfHwgIiIpICsgci5vcGVuICsgbyArIHIuY2xvc2UgKyAodCB8fCAiIikpOwogICAgfSwKICAgIGVzY2FwZTogZnVuY3Rpb24gZXNjYXBlKGUpIHsKICAgICAgcmV0dXJuIFN0cmluZyhlIHx8ICIiKS5yZXBsYWNlKC8mKD8hIz9bYS16QS1aMC05XSs7KS9nLCAiJmFtcDsiKS5yZXBsYWNlKC88L2csICImbHQ7IikucmVwbGFjZSgvPi9nLCAiJmd0OyIpLnJlcGxhY2UoLycvZywgIiYjMzk7IikucmVwbGFjZSgvIi9nLCAiJnF1b3Q7Iik7CiAgICB9LAogICAgZXJyb3I6IGZ1bmN0aW9uIGVycm9yKGUsIHIpIHsKICAgICAgdmFyIGMgPSAiTGF5dHBsIEVycm9yOiAiOwogICAgICByZXR1cm4gIm9iamVjdCIgPT0gKHR5cGVvZiBjb25zb2xlID09PSAidW5kZWZpbmVkIiA/ICJ1bmRlZmluZWQiIDogX3R5cGVvZihjb25zb2xlKSkgJiYgY29uc29sZS5lcnJvcihjICsgZSArICJcbiIgKyAociB8fCAiIikpLCBjICsgZTsKICAgIH0KICB9LAogICAgICBuID0gYy5leHAsCiAgICAgIHQgPSBmdW5jdGlvbiB0KGUpIHsKICAgIHRoaXMudHBsID0gZTsKICB9OwoKICB0LnB0ID0gdC5wcm90b3R5cGUsIHdpbmRvdy5lcnJvcnMgPSAwLCB0LnB0LnBhcnNlID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgIHZhciBvID0gdGhpcywKICAgICAgICBwID0gZSwKICAgICAgICBhID0gbigiXiIgKyByLm9wZW4gKyAiIyIsICIiKSwKICAgICAgICBsID0gbihyLmNsb3NlICsgIiQiLCAiIik7CiAgICBlID0gZS5yZXBsYWNlKC9ccyt8XHJ8XHR8XG4vZywgIiAiKS5yZXBsYWNlKG4oci5vcGVuICsgIiMiKSwgci5vcGVuICsgIiMgIikucmVwbGFjZShuKHIuY2xvc2UgKyAifSIpLCAifSAiICsgci5jbG9zZSkucmVwbGFjZSgvXFwvZywgIlxcXFwiKS5yZXBsYWNlKG4oci5vcGVuICsgIiEoLis/KSEiICsgci5jbG9zZSksIGZ1bmN0aW9uIChlKSB7CiAgICAgIHJldHVybiBlID0gZS5yZXBsYWNlKG4oIl4iICsgci5vcGVuICsgIiEiKSwgIiIpLnJlcGxhY2UobigiISIgKyByLmNsb3NlKSwgIiIpLnJlcGxhY2UobihyLm9wZW4gKyAifCIgKyByLmNsb3NlKSwgZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4gZS5yZXBsYWNlKC8oLikvZywgIlxcJDEiKTsKICAgICAgfSk7CiAgICB9KS5yZXBsYWNlKC8oPz0ifCcpL2csICJcXCIpLnJlcGxhY2UoYy5xdWVyeSgpLCBmdW5jdGlvbiAoZSkgewogICAgICByZXR1cm4gZSA9IGUucmVwbGFjZShhLCAiIikucmVwbGFjZShsLCAiIiksICciOycgKyBlLnJlcGxhY2UoL1xcKC4pL2csICIkMSIpICsgJzt2aWV3Kz0iJzsKICAgIH0pLnJlcGxhY2UoYy5xdWVyeSgxKSwgZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIGMgPSAnIisoJzsKICAgICAgcmV0dXJuIGUucmVwbGFjZSgvXHMvZywgIiIpID09PSByLm9wZW4gKyByLmNsb3NlID8gIiIgOiAoZSA9IGUucmVwbGFjZShuKHIub3BlbiArICJ8IiArIHIuY2xvc2UpLCAiIiksIC9ePS8udGVzdChlKSAmJiAoZSA9IGUucmVwbGFjZSgvXj0vLCAiIiksIGMgPSAnIitfZXNjYXBlXygnKSwgYyArIGUucmVwbGFjZSgvXFwoLikvZywgIiQxIikgKyAnKSsiJyk7CiAgICB9KSwgZSA9ICcidXNlIHN0cmljdCI7dmFyIHZpZXcgPSAiJyArIGUgKyAnIjtyZXR1cm4gdmlldzsnOwoKICAgIHRyeSB7CiAgICAgIHJldHVybiBvLmNhY2hlID0gZSA9IG5ldyBGdW5jdGlvbigiZCwgX2VzY2FwZV8iLCBlKSwgZSh0LCBjLmVzY2FwZSk7CiAgICB9IGNhdGNoICh1KSB7CiAgICAgIHJldHVybiBkZWxldGUgby5jYWNoZSwgYy5lcnJvcih1LCBwKTsKICAgIH0KICB9LCB0LnB0LnJlbmRlciA9IGZ1bmN0aW9uIChlLCByKSB7CiAgICB2YXIgbiwKICAgICAgICB0ID0gdGhpczsKICAgIHJldHVybiBlID8gKG4gPSB0LmNhY2hlID8gdC5jYWNoZShlLCBjLmVzY2FwZSkgOiB0LnBhcnNlKHQudHBsLCBlKSwgciA/IHZvaWQgcihuKSA6IG4pIDogYy5lcnJvcigibm8gZGF0YSIpOwogIH07CgogIHZhciBvID0gZnVuY3Rpb24gbyhlKSB7CiAgICByZXR1cm4gInN0cmluZyIgIT0gdHlwZW9mIGUgPyBjLmVycm9yKCJUZW1wbGF0ZSBub3QgZm91bmQiKSA6IG5ldyB0KGUpOwogIH07CgogIG8uY29uZmlnID0gZnVuY3Rpb24gKGUpIHsKICAgIGUgPSBlIHx8IHt9OwoKICAgIGZvciAodmFyIGMgaW4gZSkgewogICAgICByW2NdID0gZVtjXTsKICAgIH0KICB9LCBvLnYgPSAiMS4yLjAiLCBlKCJsYXl0cGwiLCBvKTsKfSk7CmxheXVpLmRlZmluZShmdW5jdGlvbiAoZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIGEgPSBkb2N1bWVudCwKICAgICAgdCA9ICJnZXRFbGVtZW50QnlJZCIsCiAgICAgIG4gPSAiZ2V0RWxlbWVudHNCeVRhZ05hbWUiLAogICAgICBpID0gImxheXBhZ2UiLAogICAgICByID0gImxheXVpLWRpc2FibGVkIiwKICAgICAgdSA9IGZ1bmN0aW9uIHUoZSkgewogICAgdmFyIGEgPSB0aGlzOwogICAgYS5jb25maWcgPSBlIHx8IHt9LCBhLmNvbmZpZy5pbmRleCA9ICsrcy5pbmRleCwgYS5yZW5kZXIoITApOwogIH07CgogIHUucHJvdG90eXBlLnR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMuY29uZmlnOwogICAgaWYgKCJvYmplY3QiID09IF90eXBlb2YoZS5lbGVtKSkgcmV0dXJuIHZvaWQgMCA9PT0gZS5lbGVtLmxlbmd0aCA/IDIgOiAzOwogIH0sIHUucHJvdG90eXBlLnZpZXcgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgYSA9IGUuY29uZmlnLAogICAgICAgIHQgPSBhLmdyb3VwcyA9ICJncm91cHMiIGluIGEgPyAwIHwgYS5ncm91cHMgOiA1OwogICAgYS5sYXlvdXQgPSAib2JqZWN0IiA9PSBfdHlwZW9mKGEubGF5b3V0KSA/IGEubGF5b3V0IDogWyJwcmV2IiwgInBhZ2UiLCAibmV4dCJdLCBhLmNvdW50ID0gMCB8IGEuY291bnQsIGEuY3VyciA9IDAgfCBhLmN1cnIgfHwgMSwgYS5saW1pdHMgPSAib2JqZWN0IiA9PSBfdHlwZW9mKGEubGltaXRzKSA/IGEubGltaXRzIDogWzEwLCAyMCwgMzAsIDQwLCA1MF0sIGEubGltaXQgPSAwIHwgYS5saW1pdCB8fCAxMCwgYS5wYWdlcyA9IE1hdGguY2VpbChhLmNvdW50IC8gYS5saW1pdCkgfHwgMSwgYS5jdXJyID4gYS5wYWdlcyAmJiAoYS5jdXJyID0gYS5wYWdlcyksIHQgPCAwID8gdCA9IDEgOiB0ID4gYS5wYWdlcyAmJiAodCA9IGEucGFnZXMpLCBhLnByZXYgPSAicHJldiIgaW4gYSA/IGEucHJldiA6ICImI3g0RTBBOyYjeDRFMDA7JiN4OTg3NTsiLCBhLm5leHQgPSAibmV4dCIgaW4gYSA/IGEubmV4dCA6ICImI3g0RTBCOyYjeDRFMDA7JiN4OTg3NTsiOwogICAgdmFyIG4gPSBhLnBhZ2VzID4gdCA/IE1hdGguY2VpbCgoYS5jdXJyICsgKHQgPiAxID8gMSA6IDApKSAvICh0ID4gMCA/IHQgOiAxKSkgOiAxLAogICAgICAgIGkgPSB7CiAgICAgIHByZXY6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gYS5wcmV2ID8gJzxhIGhyZWY9ImphdmFzY3JpcHQ6OyIgY2xhc3M9ImxheXVpLWxheXBhZ2UtcHJldicgKyAoMSA9PSBhLmN1cnIgPyAiICIgKyByIDogIiIpICsgJyIgZGF0YS1wYWdlPSInICsgKGEuY3VyciAtIDEpICsgJyI+JyArIGEucHJldiArICI8L2E+IiA6ICIiOwogICAgICB9KCksCiAgICAgIHBhZ2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZSA9IFtdOwogICAgICAgIGlmIChhLmNvdW50IDwgMSkgcmV0dXJuICIiOwogICAgICAgIG4gPiAxICYmIGEuZmlyc3QgIT09ICExICYmIDAgIT09IHQgJiYgZS5wdXNoKCc8YSBocmVmPSJqYXZhc2NyaXB0OjsiIGNsYXNzPSJsYXl1aS1sYXlwYWdlLWZpcnN0IiBkYXRhLXBhZ2U9IjEiICB0aXRsZT0iJiN4OTk5NjsmI3g5ODc1OyI+JyArIChhLmZpcnN0IHx8IDEpICsgIjwvYT4iKTsKICAgICAgICB2YXIgaSA9IE1hdGguZmxvb3IoKHQgLSAxKSAvIDIpLAogICAgICAgICAgICByID0gbiA+IDEgPyBhLmN1cnIgLSBpIDogMSwKICAgICAgICAgICAgdSA9IG4gPiAxID8gZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGUgPSBhLmN1cnIgKyAodCAtIGkgLSAxKTsKICAgICAgICAgIHJldHVybiBlID4gYS5wYWdlcyA/IGEucGFnZXMgOiBlOwogICAgICAgIH0oKSA6IHQ7CgogICAgICAgIGZvciAodSAtIHIgPCB0IC0gMSAmJiAociA9IHUgLSB0ICsgMSksIGEuZmlyc3QgIT09ICExICYmIHIgPiAyICYmIGUucHVzaCgnPHNwYW4gY2xhc3M9ImxheXVpLWxheXBhZ2Utc3ByIj4mI3gyMDI2Ozwvc3Bhbj4nKTsgciA8PSB1OyByKyspIHsKICAgICAgICAgIHIgPT09IGEuY3VyciA/IGUucHVzaCgnPHNwYW4gY2xhc3M9ImxheXVpLWxheXBhZ2UtY3VyciI+PGVtIGNsYXNzPSJsYXl1aS1sYXlwYWdlLWVtIiAnICsgKC9eIy8udGVzdChhLnRoZW1lKSA/ICdzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjonICsgYS50aGVtZSArICc7IicgOiAiIikgKyAiPjwvZW0+PGVtPiIgKyByICsgIjwvZW0+PC9zcGFuPiIpIDogZS5wdXNoKCc8YSBocmVmPSJqYXZhc2NyaXB0OjsiIGRhdGEtcGFnZT0iJyArIHIgKyAnIj4nICsgciArICI8L2E+Iik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYS5wYWdlcyA+IHQgJiYgYS5wYWdlcyA+IHUgJiYgYS5sYXN0ICE9PSAhMSAmJiAodSArIDEgPCBhLnBhZ2VzICYmIGUucHVzaCgnPHNwYW4gY2xhc3M9ImxheXVpLWxheXBhZ2Utc3ByIj4mI3gyMDI2Ozwvc3Bhbj4nKSwgMCAhPT0gdCAmJiBlLnB1c2goJzxhIGhyZWY9ImphdmFzY3JpcHQ6OyIgY2xhc3M9ImxheXVpLWxheXBhZ2UtbGFzdCIgdGl0bGU9IiYjeDVDM0U7JiN4OTg3NTsiICBkYXRhLXBhZ2U9IicgKyBhLnBhZ2VzICsgJyI+JyArIChhLmxhc3QgfHwgYS5wYWdlcykgKyAiPC9hPiIpKSwgZS5qb2luKCIiKTsKICAgICAgfSgpLAogICAgICBuZXh0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGEubmV4dCA/ICc8YSBocmVmPSJqYXZhc2NyaXB0OjsiIGNsYXNzPSJsYXl1aS1sYXlwYWdlLW5leHQnICsgKGEuY3VyciA9PSBhLnBhZ2VzID8gIiAiICsgciA6ICIiKSArICciIGRhdGEtcGFnZT0iJyArIChhLmN1cnIgKyAxKSArICciPicgKyBhLm5leHQgKyAiPC9hPiIgOiAiIjsKICAgICAgfSgpLAogICAgICBjb3VudDogIjxzcGFuIGNsYXNzPVwibGF5dWktbGF5cGFnZS1jb3VudFwiPlx1NTE3MSAiICsgYS5jb3VudCArICIgXHU2NzYxPC9zcGFuPiIsCiAgICAgIGxpbWl0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGUgPSBbJzxzcGFuIGNsYXNzPSJsYXl1aS1sYXlwYWdlLWxpbWl0cyI+PHNlbGVjdCBsYXktaWdub3JlPiddOwogICAgICAgIHJldHVybiBsYXl1aS5lYWNoKGEubGltaXRzLCBmdW5jdGlvbiAodCwgbikgewogICAgICAgICAgZS5wdXNoKCc8b3B0aW9uIHZhbHVlPSInICsgbiArICciJyArIChuID09PSBhLmxpbWl0ID8gInNlbGVjdGVkIiA6ICIiKSArICI+IiArIG4gKyAiIFx1Njc2MS9cdTk4NzU8L29wdGlvbj4iKTsKICAgICAgICB9KSwgZS5qb2luKCIiKSArICI8L3NlbGVjdD48L3NwYW4+IjsKICAgICAgfSgpLAogICAgICByZWZyZXNoOiBbJzxhIGhyZWY9ImphdmFzY3JpcHQ6OyIgZGF0YS1wYWdlPSInICsgYS5jdXJyICsgJyIgY2xhc3M9ImxheXVpLWxheXBhZ2UtcmVmcmVzaCI+JywgJzxpIGNsYXNzPSJsYXl1aS1pY29uIGxheXVpLWljb24tcmVmcmVzaCI+PC9pPicsICI8L2E+Il0uam9pbigiIiksCiAgICAgIHNraXA6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gWyc8c3BhbiBjbGFzcz0ibGF5dWktbGF5cGFnZS1za2lwIj4mI3g1MjMwOyYjeDdCMkM7JywgJzxpbnB1dCB0eXBlPSJ0ZXh0IiBtaW49IjEiIHZhbHVlPSInICsgYS5jdXJyICsgJyIgY2xhc3M9ImxheXVpLWlucHV0Ij4nLCAnJiN4OTg3NTs8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImxheXVpLWxheXBhZ2UtYnRuIj4mI3g3ODZlOyYjeDViOWE7PC9idXR0b24+JywgIjwvc3Bhbj4iXS5qb2luKCIiKTsKICAgICAgfSgpCiAgICB9OwogICAgcmV0dXJuIFsnPGRpdiBjbGFzcz0ibGF5dWktYm94IGxheXVpLWxheXBhZ2UgbGF5dWktbGF5cGFnZS0nICsgKGEudGhlbWUgPyAvXiMvLnRlc3QoYS50aGVtZSkgPyAibW9sdiIgOiBhLnRoZW1lIDogImRlZmF1bHQiKSArICciIGlkPSJsYXl1aS1sYXlwYWdlLScgKyBhLmluZGV4ICsgJyI+JywgZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IFtdOwogICAgICByZXR1cm4gbGF5dWkuZWFjaChhLmxheW91dCwgZnVuY3Rpb24gKGEsIHQpIHsKICAgICAgICBpW3RdICYmIGUucHVzaChpW3RdKTsKICAgICAgfSksIGUuam9pbigiIik7CiAgICB9KCksICI8L2Rpdj4iXS5qb2luKCIiKTsKICB9LCB1LnByb3RvdHlwZS5qdW1wID0gZnVuY3Rpb24gKGUsIGEpIHsKICAgIGlmIChlKSB7CiAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgIGkgPSB0LmNvbmZpZywKICAgICAgICAgIHIgPSBlLmNoaWxkcmVuLAogICAgICAgICAgdSA9IGVbbl0oImJ1dHRvbiIpWzBdLAogICAgICAgICAgbCA9IGVbbl0oImlucHV0IilbMF0sCiAgICAgICAgICBwID0gZVtuXSgic2VsZWN0IilbMF0sCiAgICAgICAgICBjID0gZnVuY3Rpb24gYygpIHsKICAgICAgICB2YXIgZSA9IDAgfCBsLnZhbHVlLnJlcGxhY2UoL1xzfFxEL2csICIiKTsKICAgICAgICBlICYmIChpLmN1cnIgPSBlLCB0LnJlbmRlcigpKTsKICAgICAgfTsKCiAgICAgIGlmIChhKSByZXR1cm4gYygpOwoKICAgICAgZm9yICh2YXIgbyA9IDAsIHkgPSByLmxlbmd0aDsgbyA8IHk7IG8rKykgewogICAgICAgICJhIiA9PT0gcltvXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICYmIHMub24ocltvXSwgImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGUgPSAwIHwgdGhpcy5nZXRBdHRyaWJ1dGUoImRhdGEtcGFnZSIpOwogICAgICAgICAgZSA8IDEgfHwgZSA+IGkucGFnZXMgfHwgKGkuY3VyciA9IGUsIHQucmVuZGVyKCkpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBwICYmIHMub24ocCwgImNoYW5nZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZSA9IHRoaXMudmFsdWU7CiAgICAgICAgaS5jdXJyICogZSA+IGkuY291bnQgJiYgKGkuY3VyciA9IE1hdGguY2VpbChpLmNvdW50IC8gZSkpLCBpLmxpbWl0ID0gZSwgdC5yZW5kZXIoKTsKICAgICAgfSksIHUgJiYgcy5vbih1LCAiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgYygpOwogICAgICB9KTsKICAgIH0KICB9LCB1LnByb3RvdHlwZS5za2lwID0gZnVuY3Rpb24gKGUpIHsKICAgIGlmIChlKSB7CiAgICAgIHZhciBhID0gdGhpcywKICAgICAgICAgIHQgPSBlW25dKCJpbnB1dCIpWzBdOwogICAgICB0ICYmIHMub24odCwgImtleXVwIiwgZnVuY3Rpb24gKHQpIHsKICAgICAgICB2YXIgbiA9IHRoaXMudmFsdWUsCiAgICAgICAgICAgIGkgPSB0LmtleUNvZGU7CiAgICAgICAgL14oMzd8Mzh8Mzl8NDApJC8udGVzdChpKSB8fCAoL1xELy50ZXN0KG4pICYmICh0aGlzLnZhbHVlID0gbi5yZXBsYWNlKC9cRC8sICIiKSksIDEzID09PSBpICYmIGEuanVtcChlLCAhMCkpOwogICAgICB9KTsKICAgIH0KICB9LCB1LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIG4gPSB0aGlzLAogICAgICAgIGkgPSBuLmNvbmZpZywKICAgICAgICByID0gbi50eXBlKCksCiAgICAgICAgdSA9IG4udmlldygpOwogICAgMiA9PT0gciA/IGkuZWxlbSAmJiAoaS5lbGVtLmlubmVySFRNTCA9IHUpIDogMyA9PT0gciA/IGkuZWxlbS5odG1sKHUpIDogYVt0XShpLmVsZW0pICYmIChhW3RdKGkuZWxlbSkuaW5uZXJIVE1MID0gdSksIGkuanVtcCAmJiBpLmp1bXAoaSwgZSk7CiAgICB2YXIgcyA9IGFbdF0oImxheXVpLWxheXBhZ2UtIiArIGkuaW5kZXgpOwogICAgbi5qdW1wKHMpLCBpLmhhc2ggJiYgIWUgJiYgKGxvY2F0aW9uLmhhc2ggPSAiISIgKyBpLmhhc2ggKyAiPSIgKyBpLmN1cnIpLCBuLnNraXAocyk7CiAgfTsKICB2YXIgcyA9IHsKICAgIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKGUpIHsKICAgICAgdmFyIGEgPSBuZXcgdShlKTsKICAgICAgcmV0dXJuIGEuaW5kZXg7CiAgICB9LAogICAgaW5kZXg6IGxheXVpLmxheXBhZ2UgPyBsYXl1aS5sYXlwYWdlLmluZGV4ICsgMWU0IDogMCwKICAgIG9uOiBmdW5jdGlvbiBvbihlLCBhLCB0KSB7CiAgICAgIHJldHVybiBlLmF0dGFjaEV2ZW50ID8gZS5hdHRhY2hFdmVudCgib24iICsgYSwgZnVuY3Rpb24gKGEpIHsKICAgICAgICBhLnRhcmdldCA9IGEuc3JjRWxlbWVudCwgdC5jYWxsKGUsIGEpOwogICAgICB9KSA6IGUuYWRkRXZlbnRMaXN0ZW5lcihhLCB0LCAhMSksIHRoaXM7CiAgICB9CiAgfTsKICBlKGksIHMpOwp9KTsKIWZ1bmN0aW9uIChlLCB0KSB7CiAgInVzZSBzdHJpY3QiOwoKICB2YXIgYSA9IGUubGF5dWkgJiYgbGF5dWkuZGVmaW5lLAogICAgICBuID0gewogICAgZ2V0UGF0aDogZS5sYXkgJiYgbGF5LmdldFBhdGggPyBsYXkuZ2V0UGF0aCA6ICIiLAogICAgbGluazogZnVuY3Rpb24gbGluayh0LCBhLCBuKSB7CiAgICAgIGwucGF0aCAmJiBlLmxheSAmJiBsYXkubGF5dWkgJiYgbGF5LmxheXVpLmxpbmsobC5wYXRoICsgdCwgYSwgbik7CiAgICB9CiAgfSwKICAgICAgaSA9IGUuTEFZVUlfR0xPQkFMIHx8IHt9LAogICAgICBsID0gewogICAgdjogIjUuMy4xIiwKICAgIGNvbmZpZzoge30sCiAgICBpbmRleDogZS5sYXlkYXRlICYmIGUubGF5ZGF0ZS52ID8gMWU1IDogMCwKICAgIHBhdGg6IGkubGF5ZGF0ZV9kaXIgfHwgbi5nZXRQYXRoLAogICAgc2V0OiBmdW5jdGlvbiBzZXQoZSkgewogICAgICB2YXIgdCA9IHRoaXM7CiAgICAgIHJldHVybiB0LmNvbmZpZyA9IGxheS5leHRlbmQoe30sIHQuY29uZmlnLCBlKSwgdDsKICAgIH0sCiAgICByZWFkeTogZnVuY3Rpb24gcmVhZHkoZSkgewogICAgICB2YXIgdCA9ICJsYXlkYXRlIiwKICAgICAgICAgIGkgPSAiIiwKICAgICAgICAgIHIgPSAoYSA/ICJtb2R1bGVzL2xheWRhdGUvIiA6ICJ0aGVtZS8iKSArICJkZWZhdWx0L2xheWRhdGUuY3NzP3Y9IiArIGwudiArIGk7CiAgICAgIHJldHVybiBhID8gbGF5dWkuYWRkY3NzKHIsIGUsIHQpIDogbi5saW5rKHIsIGUsIHQpLCB0aGlzOwogICAgfQogIH0sCiAgICAgIHIgPSBmdW5jdGlvbiByKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIHQgPSBlLmNvbmZpZywKICAgICAgICBhID0gdC5pZDsKICAgIHJldHVybiByLnRoYXRbYV0gPSBlLCB7CiAgICAgIGhpbnQ6IGZ1bmN0aW9uIGhpbnQodCkgewogICAgICAgIGUuaGludC5jYWxsKGUsIHQpOwogICAgICB9LAogICAgICBjb25maWc6IGUuY29uZmlnCiAgICB9OwogIH0sCiAgICAgIG8gPSAibGF5ZGF0ZSIsCiAgICAgIHMgPSAiLmxheXVpLWxheWRhdGUiLAogICAgICB5ID0gImxheXVpLXRoaXMiLAogICAgICBkID0gImxheWRhdGUtZGlzYWJsZWQiLAogICAgICBtID0gWzEwMCwgMmU1XSwKICAgICAgYyA9ICJsYXl1aS1sYXlkYXRlLXN0YXRpYyIsCiAgICAgIHUgPSAibGF5dWktbGF5ZGF0ZS1saXN0IiwKICAgICAgaCA9ICJsYXl1aS1sYXlkYXRlLWhpbnQiLAogICAgICBmID0gImxheXVpLWxheWRhdGUtZm9vdGVyIiwKICAgICAgcCA9ICIubGF5ZGF0ZS1idG5zLWNvbmZpcm0iLAogICAgICBnID0gImxheWRhdGUtdGltZS10ZXh0IiwKICAgICAgdiA9ICJsYXlkYXRlLWJ0bnMtdGltZSIsCiAgICAgIFQgPSAibGF5dWktbGF5ZGF0ZS1wcmV2aWV3IiwKICAgICAgRCA9IGZ1bmN0aW9uIEQoZSkgewogICAgdmFyIHQgPSB0aGlzOwogICAgdC5pbmRleCA9ICsrbC5pbmRleCwgdC5jb25maWcgPSBsYXkuZXh0ZW5kKHt9LCB0LmNvbmZpZywgbC5jb25maWcsIGUpLCBlID0gdC5jb25maWcsIGUuaWQgPSAiaWQiIGluIGUgPyBlLmlkIDogdC5pbmRleCwgbC5yZWFkeShmdW5jdGlvbiAoKSB7CiAgICAgIHQuaW5pdCgpOwogICAgfSk7CiAgfSwKICAgICAgdyA9ICJ5eXl5fHl8TU18TXxkZHxkfEhIfEh8bW18bXxzc3xzIjsKCiAgci5mb3JtYXRBcnIgPSBmdW5jdGlvbiAoZSkgewogICAgcmV0dXJuIChlIHx8ICIiKS5tYXRjaChuZXcgUmVnRXhwKHcgKyAifC4iLCAiZyIpKSB8fCBbXTsKICB9LCBELmlzTGVhcFllYXIgPSBmdW5jdGlvbiAoZSkgewogICAgcmV0dXJuIGUgJSA0ID09PSAwICYmIGUgJSAxMDAgIT09IDAgfHwgZSAlIDQwMCA9PT0gMDsKICB9LCBELnByb3RvdHlwZS5jb25maWcgPSB7CiAgICB0eXBlOiAiZGF0ZSIsCiAgICByYW5nZTogITEsCiAgICBmb3JtYXQ6ICJ5eXl5LU1NLWRkIiwKICAgIHZhbHVlOiBudWxsLAogICAgaXNJbml0VmFsdWU6ICEwLAogICAgbWluOiAiMTkwMC0xLTEiLAogICAgbWF4OiAiMjA5OS0xMi0zMSIsCiAgICB0cmlnZ2VyOiAiY2xpY2siLAogICAgc2hvdzogITEsCiAgICBzaG93Qm90dG9tOiAhMCwKICAgIGlzUHJldmlldzogITAsCiAgICBidG5zOiBbImNsZWFyIiwgIm5vdyIsICJjb25maXJtIl0sCiAgICBsYW5nOiAiY24iLAogICAgdGhlbWU6ICJkZWZhdWx0IiwKICAgIHBvc2l0aW9uOiBudWxsLAogICAgY2FsZW5kYXI6ICExLAogICAgbWFyazoge30sCiAgICB6SW5kZXg6IG51bGwsCiAgICBkb25lOiBudWxsLAogICAgY2hhbmdlOiBudWxsCiAgfSwgRC5wcm90b3R5cGUubGFuZyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICB0ID0gZS5jb25maWcsCiAgICAgICAgYSA9IHsKICAgICAgY246IHsKICAgICAgICB3ZWVrczogWyJcdTY1RTUiLCAiXHU0RTAwIiwgIlx1NEU4QyIsICJcdTRFMDkiLCAiXHU1NkRCIiwgIlx1NEU5NCIsICJcdTUxNkQiXSwKICAgICAgICB0aW1lOiBbIlx1NjVGNiIsICJcdTUyMDYiLCAiXHU3OUQyIl0sCiAgICAgICAgdGltZVRpcHM6ICJcdTkwMDlcdTYyRTlcdTY1RjZcdTk1RjQiLAogICAgICAgIHN0YXJ0VGltZTogIlx1NUYwMFx1NTlDQlx1NjVGNlx1OTVGNCIsCiAgICAgICAgZW5kVGltZTogIlx1N0VEM1x1Njc1Rlx1NjVGNlx1OTVGNCIsCiAgICAgICAgZGF0ZVRpcHM6ICJcdThGRDRcdTU2REVcdTY1RTVcdTY3MUYiLAogICAgICAgIG1vbnRoOiBbIlx1NEUwMCIsICJcdTRFOEMiLCAiXHU0RTA5IiwgIlx1NTZEQiIsICJcdTRFOTQiLCAiXHU1MTZEIiwgIlx1NEUwMyIsICJcdTUxNkIiLCAiXHU0RTVEIiwgIlx1NTM0MSIsICJcdTUzNDFcdTRFMDAiLCAiXHU1MzQxXHU0RThDIl0sCiAgICAgICAgdG9vbHM6IHsKICAgICAgICAgIGNvbmZpcm06ICJcdTc4NkVcdTVCOUEiLAogICAgICAgICAgY2xlYXI6ICJcdTZFMDVcdTdBN0EiLAogICAgICAgICAgbm93OiAiXHU3M0IwXHU1NzI4IgogICAgICAgIH0sCiAgICAgICAgdGltZW91dDogIlx1N0VEM1x1Njc1Rlx1NjVGNlx1OTVGNFx1NEUwRFx1ODBGRFx1NjVFOVx1NEU4RVx1NUYwMFx1NTlDQlx1NjVGNlx1OTVGNDxicj5cdThCRjdcdTkxQ0RcdTY1QjBcdTkwMDlcdTYyRTkiLAogICAgICAgIGludmFsaWREYXRlOiAiXHU0RTBEXHU1NzI4XHU2NzA5XHU2NTQ4XHU2NUU1XHU2NzFGXHU2MjE2XHU2NUY2XHU5NUY0XHU4MzAzXHU1NkY0XHU1MTg1IiwKICAgICAgICBmb3JtYXRFcnJvcjogWyJcdTY1RTVcdTY3MUZcdTY4M0NcdTVGMEZcdTRFMERcdTU0MDhcdTZDRDU8YnI+XHU1RkM1XHU5ODdCXHU5MDc1XHU1RkFBXHU0RTBCXHU4RkYwXHU2ODNDXHU1RjBGXHVGRjFBPGJyPiIsICI8YnI+XHU1REYyXHU0RTNBXHU0RjYwXHU5MUNEXHU3RjZFIl0sCiAgICAgICAgcHJldmlldzogIlx1NUY1M1x1NTI0RFx1OTAwOVx1NEUyRFx1NzY4NFx1N0VEM1x1Njc5QyIKICAgICAgfSwKICAgICAgZW46IHsKICAgICAgICB3ZWVrczogWyJTdSIsICJNbyIsICJUdSIsICJXZSIsICJUaCIsICJGciIsICJTYSJdLAogICAgICAgIHRpbWU6IFsiSG91cnMiLCAiTWludXRlcyIsICJTZWNvbmRzIl0sCiAgICAgICAgdGltZVRpcHM6ICJTZWxlY3QgVGltZSIsCiAgICAgICAgc3RhcnRUaW1lOiAiU3RhcnQgVGltZSIsCiAgICAgICAgZW5kVGltZTogIkVuZCBUaW1lIiwKICAgICAgICBkYXRlVGlwczogIlNlbGVjdCBEYXRlIiwKICAgICAgICBtb250aDogWyJKYW4iLCAiRmViIiwgIk1hciIsICJBcHIiLCAiTWF5IiwgIkp1biIsICJKdWwiLCAiQXVnIiwgIlNlcCIsICJPY3QiLCAiTm92IiwgIkRlYyJdLAogICAgICAgIHRvb2xzOiB7CiAgICAgICAgICBjb25maXJtOiAiQ29uZmlybSIsCiAgICAgICAgICBjbGVhcjogIkNsZWFyIiwKICAgICAgICAgIG5vdzogIk5vdyIKICAgICAgICB9LAogICAgICAgIHRpbWVvdXQ6ICJFbmQgdGltZSBjYW5ub3QgYmUgbGVzcyB0aGFuIHN0YXJ0IFRpbWU8YnI+UGxlYXNlIHJlLXNlbGVjdCIsCiAgICAgICAgaW52YWxpZERhdGU6ICJJbnZhbGlkIGRhdGUiLAogICAgICAgIGZvcm1hdEVycm9yOiBbIlRoZSBkYXRlIGZvcm1hdCBlcnJvcjxicj5NdXN0IGJlIGZvbGxvd2VkXHVGRjFBPGJyPiIsICI8YnI+SXQgaGFzIGJlZW4gcmVzZXQiXSwKICAgICAgICBwcmV2aWV3OiAiVGhlIHNlbGVjdGVkIHJlc3VsdCIKICAgICAgfQogICAgfTsKICAgIHJldHVybiBhW3QubGFuZ10gfHwgYS5jbjsKICB9LCBELnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHQgPSB0aGlzLAogICAgICAgIGEgPSB0LmNvbmZpZywKICAgICAgICBuID0gInN0YXRpYyIgPT09IGEucG9zaXRpb24sCiAgICAgICAgaSA9IHsKICAgICAgeWVhcjogInl5eXkiLAogICAgICBtb250aDogInl5eXktTU0iLAogICAgICBkYXRlOiAieXl5eS1NTS1kZCIsCiAgICAgIHRpbWU6ICJISDptbTpzcyIsCiAgICAgIGRhdGV0aW1lOiAieXl5eS1NTS1kZCBISDptbTpzcyIKICAgIH07CiAgICBhLmVsZW0gPSBsYXkoYS5lbGVtKSwgYS5ldmVudEVsZW0gPSBsYXkoYS5ldmVudEVsZW0pLCBhLmVsZW1bMF0gJiYgKHQucmFuZ2VTdHIgPSBhLnJhbmdlID8gInN0cmluZyIgPT0gdHlwZW9mIGEucmFuZ2UgPyBhLnJhbmdlIDogIi0iIDogIiIsICJhcnJheSIgPT09IGxheXVpLl90eXBlb2YoYS5yYW5nZSkgJiYgKHQucmFuZ2VFbGVtID0gW2xheShhLnJhbmdlWzBdKSwgbGF5KGEucmFuZ2VbMV0pXSksIGlbYS50eXBlXSB8fCAoZS5jb25zb2xlICYmIGNvbnNvbGUuZXJyb3IgJiYgY29uc29sZS5lcnJvcigibGF5ZGF0ZSB0eXBlIGVycm9yOiciICsgYS50eXBlICsgIicgaXMgbm90IHN1cHBvcnRlZCIpLCBhLnR5cGUgPSAiZGF0ZSIpLCBhLmZvcm1hdCA9PT0gaS5kYXRlICYmIChhLmZvcm1hdCA9IGlbYS50eXBlXSB8fCBpLmRhdGUpLCB0LmZvcm1hdCA9IHIuZm9ybWF0QXJyKGEuZm9ybWF0KSwgdC5FWFBfSUYgPSAiIiwgdC5FWFBfU1BMSVQgPSAiIiwgbGF5LmVhY2godC5mb3JtYXQsIGZ1bmN0aW9uIChlLCBhKSB7CiAgICAgIHZhciBuID0gbmV3IFJlZ0V4cCh3KS50ZXN0KGEpID8gIlxcZHsiICsgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBuZXcgUmVnRXhwKHcpLnRlc3QodC5mb3JtYXRbMCA9PT0gZSA/IGUgKyAxIDogZSAtIDFdIHx8ICIiKSA/IC9eeXl5eXx5JC8udGVzdChhKSA/IDQgOiBhLmxlbmd0aCA6IC9eeXl5eSQvLnRlc3QoYSkgPyAiMSw0IiA6IC9eeSQvLnRlc3QoYSkgPyAiMSwzMDgiIDogIjEsMiI7CiAgICAgIH0oKSArICJ9IiA6ICJcXCIgKyBhOwogICAgICB0LkVYUF9JRiA9IHQuRVhQX0lGICsgbiwgdC5FWFBfU1BMSVQgPSB0LkVYUF9TUExJVCArICIoIiArIG4gKyAiKSI7CiAgICB9KSwgdC5FWFBfSUZfT05FID0gbmV3IFJlZ0V4cCgiXiIgKyB0LkVYUF9JRiArICIkIiksIHQuRVhQX0lGID0gbmV3IFJlZ0V4cCgiXiIgKyAoYS5yYW5nZSA/IHQuRVhQX0lGICsgIlxcc1xcIiArIHQucmFuZ2VTdHIgKyAiXFxzIiArIHQuRVhQX0lGIDogdC5FWFBfSUYpICsgIiQiKSwgdC5FWFBfU1BMSVQgPSBuZXcgUmVnRXhwKCJeIiArIHQuRVhQX1NQTElUICsgIiQiLCAiIiksIHQuaXNJbnB1dChhLmVsZW1bMF0pIHx8ICJmb2N1cyIgPT09IGEudHJpZ2dlciAmJiAoYS50cmlnZ2VyID0gImNsaWNrIiksIGEuZWxlbS5hdHRyKCJsYXkta2V5IikgfHwgKGEuZWxlbS5hdHRyKCJsYXkta2V5IiwgdC5pbmRleCksIGEuZXZlbnRFbGVtLmF0dHIoImxheS1rZXkiLCB0LmluZGV4KSksIGEubWFyayA9IGxheS5leHRlbmQoe30sIGEuY2FsZW5kYXIgJiYgImNuIiA9PT0gYS5sYW5nID8gewogICAgICAiMC0xLTEiOiAiXHU1MTQzXHU2NUU2IiwKICAgICAgIjAtMi0xNCI6ICJcdTYwQzVcdTRFQkEiLAogICAgICAiMC0zLTgiOiAiXHU1OTg3XHU1OTczIiwKICAgICAgIjAtMy0xMiI6ICJcdTY5MERcdTY4MTEiLAogICAgICAiMC00LTEiOiAiXHU2MTFBXHU0RUJBIiwKICAgICAgIjAtNS0xIjogIlx1NTJCM1x1NTJBOCIsCiAgICAgICIwLTUtNCI6ICJcdTk3NTJcdTVFNzQiLAogICAgICAiMC02LTEiOiAiXHU1MTNGXHU3QUU1IiwKICAgICAgIjAtOS0xMCI6ICJcdTY1NTlcdTVFMDgiLAogICAgICAiMC05LTE4IjogIlx1NTZGRFx1ODAzQiIsCiAgICAgICIwLTEwLTEiOiAiXHU1NkZEXHU1RTg2IiwKICAgICAgIjAtMTItMjUiOiAiXHU1NzIzXHU4QkRFIgogICAgfSA6IHt9LCBhLm1hcmspLCBsYXkuZWFjaChbIm1pbiIsICJtYXgiXSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgdmFyIG4gPSBbXSwKICAgICAgICAgIGkgPSBbXTsKCiAgICAgIGlmICgibnVtYmVyIiA9PSB0eXBlb2YgYVt0XSkgewogICAgICAgIHZhciBsID0gYVt0XSwKICAgICAgICAgICAgciA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAogICAgICAgICAgICBvID0gODY0ZTUsCiAgICAgICAgICAgIHMgPSBuZXcgRGF0ZShsID8gbCA8IG8gPyByICsgbCAqIG8gOiBsIDogcik7CiAgICAgICAgbiA9IFtzLmdldEZ1bGxZZWFyKCksIHMuZ2V0TW9udGgoKSArIDEsIHMuZ2V0RGF0ZSgpXSwgbCA8IG8gfHwgKGkgPSBbcy5nZXRIb3VycygpLCBzLmdldE1pbnV0ZXMoKSwgcy5nZXRTZWNvbmRzKCldKTsKICAgICAgfSBlbHNlIG4gPSAoYVt0XS5tYXRjaCgvXGQrLVxkKy1cZCsvKSB8fCBbIiJdKVswXS5zcGxpdCgiLSIpLCBpID0gKGFbdF0ubWF0Y2goL1xkKzpcZCs6XGQrLykgfHwgWyIiXSlbMF0uc3BsaXQoIjoiKTsKCiAgICAgIGFbdF0gPSB7CiAgICAgICAgeWVhcjogMCB8IG5bMF0gfHwgbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpLAogICAgICAgIG1vbnRoOiBuWzFdID8gKDAgfCBuWzFdKSAtIDEgOiBuZXcgRGF0ZSgpLmdldE1vbnRoKCksCiAgICAgICAgZGF0ZTogMCB8IG5bMl0gfHwgbmV3IERhdGUoKS5nZXREYXRlKCksCiAgICAgICAgaG91cnM6IDAgfCBpWzBdLAogICAgICAgIG1pbnV0ZXM6IDAgfCBpWzFdLAogICAgICAgIHNlY29uZHM6IDAgfCBpWzJdCiAgICAgIH07CiAgICB9KSwgdC5lbGVtSUQgPSAibGF5dWktbGF5ZGF0ZSIgKyBhLmVsZW0uYXR0cigibGF5LWtleSIpLCAoYS5zaG93IHx8IG4pICYmIHQucmVuZGVyKCksIG4gfHwgdC5ldmVudHMoKSwgYS52YWx1ZSAmJiBhLmlzSW5pdFZhbHVlICYmICgiZGF0ZSIgPT09IGxheXVpLl90eXBlb2YoYS52YWx1ZSkgPyB0LnNldFZhbHVlKHQucGFyc2UoMCwgdC5zeXN0ZW1EYXRlKGEudmFsdWUpKSkgOiB0LnNldFZhbHVlKGEudmFsdWUpKSk7CiAgfSwgRC5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIGEgPSBlLmNvbmZpZywKICAgICAgICBuID0gZS5sYW5nKCksCiAgICAgICAgaSA9ICJzdGF0aWMiID09PSBhLnBvc2l0aW9uLAogICAgICAgIHIgPSBlLmVsZW0gPSBsYXkuZWxlbSgiZGl2IiwgewogICAgICBpZDogZS5lbGVtSUQsCiAgICAgICJjbGFzcyI6IFsibGF5dWktbGF5ZGF0ZSIsIGEucmFuZ2UgPyAiIGxheXVpLWxheWRhdGUtcmFuZ2UiIDogIiIsIGkgPyAiICIgKyBjIDogIiIsIGEudGhlbWUgJiYgImRlZmF1bHQiICE9PSBhLnRoZW1lICYmICEvXiMvLnRlc3QoYS50aGVtZSkgPyAiIGxheWRhdGUtdGhlbWUtIiArIGEudGhlbWUgOiAiIl0uam9pbigiIikKICAgIH0pLAogICAgICAgIG8gPSBlLmVsZW1NYWluID0gW10sCiAgICAgICAgcyA9IGUuZWxlbUhlYWRlciA9IFtdLAogICAgICAgIHkgPSBlLmVsZW1Db250ID0gW10sCiAgICAgICAgZCA9IGUudGFibGUgPSBbXSwKICAgICAgICBtID0gZS5mb290ZXIgPSBsYXkuZWxlbSgiZGl2IiwgewogICAgICAiY2xhc3MiOiBmCiAgICB9KTsKCiAgICBpZiAoYS56SW5kZXggJiYgKHIuc3R5bGUuekluZGV4ID0gYS56SW5kZXgpLCBsYXkuZWFjaChuZXcgQXJyYXkoMiksIGZ1bmN0aW9uIChlKSB7CiAgICAgIGlmICghYS5yYW5nZSAmJiBlID4gMCkgcmV0dXJuICEwOwogICAgICB2YXIgdCA9IGxheS5lbGVtKCJkaXYiLCB7CiAgICAgICAgImNsYXNzIjogImxheXVpLWxheWRhdGUtaGVhZGVyIgogICAgICB9KSwKICAgICAgICAgIGkgPSBbZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBlID0gbGF5LmVsZW0oImkiLCB7CiAgICAgICAgICAiY2xhc3MiOiAibGF5dWktaWNvbiBsYXlkYXRlLWljb24gbGF5ZGF0ZS1wcmV2LXkiCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGUuaW5uZXJIVE1MID0gIiYjeGU2NWE7IiwgZTsKICAgICAgfSgpLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGUgPSBsYXkuZWxlbSgiaSIsIHsKICAgICAgICAgICJjbGFzcyI6ICJsYXl1aS1pY29uIGxheWRhdGUtaWNvbiBsYXlkYXRlLXByZXYtbSIKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZS5pbm5lckhUTUwgPSAiJiN4ZTYwMzsiLCBlOwogICAgICB9KCksIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZSA9IGxheS5lbGVtKCJkaXYiLCB7CiAgICAgICAgICAiY2xhc3MiOiAibGF5ZGF0ZS1zZXQteW0iCiAgICAgICAgfSksCiAgICAgICAgICAgIHQgPSBsYXkuZWxlbSgic3BhbiIpLAogICAgICAgICAgICBhID0gbGF5LmVsZW0oInNwYW4iKTsKICAgICAgICByZXR1cm4gZS5hcHBlbmRDaGlsZCh0KSwgZS5hcHBlbmRDaGlsZChhKSwgZTsKICAgICAgfSgpLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGUgPSBsYXkuZWxlbSgiaSIsIHsKICAgICAgICAgICJjbGFzcyI6ICJsYXl1aS1pY29uIGxheWRhdGUtaWNvbiBsYXlkYXRlLW5leHQtbSIKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZS5pbm5lckhUTUwgPSAiJiN4ZTYwMjsiLCBlOwogICAgICB9KCksIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZSA9IGxheS5lbGVtKCJpIiwgewogICAgICAgICAgImNsYXNzIjogImxheXVpLWljb24gbGF5ZGF0ZS1pY29uIGxheWRhdGUtbmV4dC15IgogICAgICAgIH0pOwogICAgICAgIHJldHVybiBlLmlubmVySFRNTCA9ICImI3hlNjViOyIsIGU7CiAgICAgIH0oKV0sCiAgICAgICAgICBsID0gbGF5LmVsZW0oImRpdiIsIHsKICAgICAgICAiY2xhc3MiOiAibGF5dWktbGF5ZGF0ZS1jb250ZW50IgogICAgICB9KSwKICAgICAgICAgIHIgPSBsYXkuZWxlbSgidGFibGUiKSwKICAgICAgICAgIG0gPSBsYXkuZWxlbSgidGhlYWQiKSwKICAgICAgICAgIGMgPSBsYXkuZWxlbSgidHIiKTsKICAgICAgbGF5LmVhY2goaSwgZnVuY3Rpb24gKGUsIGEpIHsKICAgICAgICB0LmFwcGVuZENoaWxkKGEpOwogICAgICB9KSwgbS5hcHBlbmRDaGlsZChjKSwgbGF5LmVhY2gobmV3IEFycmF5KDYpLCBmdW5jdGlvbiAoZSkgewogICAgICAgIHZhciB0ID0gci5pbnNlcnRSb3coMCk7CiAgICAgICAgbGF5LmVhY2gobmV3IEFycmF5KDcpLCBmdW5jdGlvbiAoYSkgewogICAgICAgICAgaWYgKDAgPT09IGUpIHsKICAgICAgICAgICAgdmFyIGkgPSBsYXkuZWxlbSgidGgiKTsKICAgICAgICAgICAgaS5pbm5lckhUTUwgPSBuLndlZWtzW2FdLCBjLmFwcGVuZENoaWxkKGkpOwogICAgICAgICAgfQoKICAgICAgICAgIHQuaW5zZXJ0Q2VsbChhKTsKICAgICAgICB9KTsKICAgICAgfSksIHIuaW5zZXJ0QmVmb3JlKG0sIHIuY2hpbGRyZW5bMF0pLCBsLmFwcGVuZENoaWxkKHIpLCBvW2VdID0gbGF5LmVsZW0oImRpdiIsIHsKICAgICAgICAiY2xhc3MiOiAibGF5dWktbGF5ZGF0ZS1tYWluIGxheWRhdGUtbWFpbi1saXN0LSIgKyBlCiAgICAgIH0pLCBvW2VdLmFwcGVuZENoaWxkKHQpLCBvW2VdLmFwcGVuZENoaWxkKGwpLCBzLnB1c2goaSksIHkucHVzaChsKSwgZC5wdXNoKHIpOwogICAgfSksIGxheShtKS5odG1sKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSBbXSwKICAgICAgICAgIHQgPSBbXTsKICAgICAgcmV0dXJuICJkYXRldGltZSIgPT09IGEudHlwZSAmJiBlLnB1c2goJzxzcGFuIGxheS10eXBlPSJkYXRldGltZSIgY2xhc3M9IicgKyB2ICsgJyI+JyArIG4udGltZVRpcHMgKyAiPC9zcGFuPiIpLCAoYS5yYW5nZSB8fCAiZGF0ZXRpbWUiICE9PSBhLnR5cGUpICYmIGUucHVzaCgnPHNwYW4gY2xhc3M9IicgKyBUICsgJyIgdGl0bGU9IicgKyBuLnByZXZpZXcgKyAnIj48L3NwYW4+JyksIGxheS5lYWNoKGEuYnRucywgZnVuY3Rpb24gKGUsIGwpIHsKICAgICAgICB2YXIgciA9IG4udG9vbHNbbF0gfHwgImJ0biI7CiAgICAgICAgYS5yYW5nZSAmJiAibm93IiA9PT0gbCB8fCAoaSAmJiAiY2xlYXIiID09PSBsICYmIChyID0gImNuIiA9PT0gYS5sYW5nID8gIlx1OTFDRFx1N0Y2RSIgOiAiUmVzZXQiKSwgdC5wdXNoKCc8c3BhbiBsYXktdHlwZT0iJyArIGwgKyAnIiBjbGFzcz0ibGF5ZGF0ZS1idG5zLScgKyBsICsgJyI+JyArIHIgKyAiPC9zcGFuPiIpKTsKICAgICAgfSksIGUucHVzaCgnPGRpdiBjbGFzcz0ibGF5ZGF0ZS1mb290ZXItYnRucyI+JyArIHQuam9pbigiIikgKyAiPC9kaXY+IiksIGUuam9pbigiIik7CiAgICB9KCkpLCBsYXkuZWFjaChvLCBmdW5jdGlvbiAoZSwgdCkgewogICAgICByLmFwcGVuZENoaWxkKHQpOwogICAgfSksIGEuc2hvd0JvdHRvbSAmJiByLmFwcGVuZENoaWxkKG0pLCAvXiMvLnRlc3QoYS50aGVtZSkpIHsKICAgICAgdmFyIHUgPSBsYXkuZWxlbSgic3R5bGUiKSwKICAgICAgICAgIGggPSBbIiN7e2lkfX0gLmxheXVpLWxheWRhdGUtaGVhZGVye2JhY2tncm91bmQtY29sb3I6e3t0aGVtZX19O30iLCAiI3t7aWR9fSAubGF5dWktdGhpc3tiYWNrZ3JvdW5kLWNvbG9yOnt7dGhlbWV9fSAhaW1wb3J0YW50O30iXS5qb2luKCIiKS5yZXBsYWNlKC97e2lkfX0vZywgZS5lbGVtSUQpLnJlcGxhY2UoL3t7dGhlbWV9fS9nLCBhLnRoZW1lKTsKICAgICAgInN0eWxlU2hlZXQiIGluIHUgPyAodS5zZXRBdHRyaWJ1dGUoInR5cGUiLCAidGV4dC9jc3MiKSwgdS5zdHlsZVNoZWV0LmNzc1RleHQgPSBoKSA6IHUuaW5uZXJIVE1MID0gaCwgbGF5KHIpLmFkZENsYXNzKCJsYXlkYXRlLXRoZW1lLW1vbHYiKSwgci5hcHBlbmRDaGlsZCh1KTsKICAgIH0KCiAgICBsLnRoaXNJZCA9IGEuaWQsIGUucmVtb3ZlKEQudGhpc0VsZW1EYXRlKSwgaSA/IGEuZWxlbS5hcHBlbmQocikgOiAodC5ib2R5LmFwcGVuZENoaWxkKHIpLCBlLnBvc2l0aW9uKCkpLCBlLmNoZWNrRGF0ZSgpLmNhbGVuZGFyKG51bGwsIDAsICJpbml0IiksIGUuY2hhbmdlRXZlbnQoKSwgRC50aGlzRWxlbURhdGUgPSBlLmVsZW1JRCwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgYS5yZWFkeSAmJiBhLnJlYWR5KGxheS5leHRlbmQoe30sIGEuZGF0ZVRpbWUsIHsKICAgICAgbW9udGg6IGEuZGF0ZVRpbWUubW9udGggKyAxCiAgICB9KSksIGUucHJldmlldygpOwogIH0sIEQucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgYSA9ICh0LmNvbmZpZywgbGF5KCIjIiArIChlIHx8IHQuZWxlbUlEKSkpOwogICAgcmV0dXJuIGFbMF0gPyAoYS5oYXNDbGFzcyhjKSB8fCB0LmNoZWNrRGF0ZShmdW5jdGlvbiAoKSB7CiAgICAgIGEucmVtb3ZlKCk7CiAgICB9KSwgdCkgOiB0OwogIH0sIEQucHJvdG90eXBlLnBvc2l0aW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIHQgPSBlLmNvbmZpZzsKICAgIHJldHVybiBsYXkucG9zaXRpb24oZS5iaW5kRWxlbSB8fCB0LmVsZW1bMF0sIGUuZWxlbSwgewogICAgICBwb3NpdGlvbjogdC5wb3NpdGlvbgogICAgfSksIGU7CiAgfSwgRC5wcm90b3R5cGUuaGludCA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgYSA9ICh0LmNvbmZpZywgbGF5LmVsZW0oImRpdiIsIHsKICAgICAgImNsYXNzIjogaAogICAgfSkpOwogICAgdC5lbGVtICYmIChhLmlubmVySFRNTCA9IGUgfHwgIiIsIGxheSh0LmVsZW0pLmZpbmQoIi4iICsgaCkucmVtb3ZlKCksIHQuZWxlbS5hcHBlbmRDaGlsZChhKSwgY2xlYXJUaW1lb3V0KHQuaGluVGltZXIpLCB0LmhpblRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGxheSh0LmVsZW0pLmZpbmQoIi4iICsgaCkucmVtb3ZlKCk7CiAgICB9LCAzZTMpKTsKICB9LCBELnByb3RvdHlwZS5nZXRBc1lNID0gZnVuY3Rpb24gKGUsIHQsIGEpIHsKICAgIHJldHVybiBhID8gdC0tIDogdCsrLCB0IDwgMCAmJiAodCA9IDExLCBlLS0pLCB0ID4gMTEgJiYgKHQgPSAwLCBlKyspLCBbZSwgdF07CiAgfSwgRC5wcm90b3R5cGUuc3lzdGVtRGF0ZSA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IGUgfHwgbmV3IERhdGUoKTsKICAgIHJldHVybiB7CiAgICAgIHllYXI6IHQuZ2V0RnVsbFllYXIoKSwKICAgICAgbW9udGg6IHQuZ2V0TW9udGgoKSwKICAgICAgZGF0ZTogdC5nZXREYXRlKCksCiAgICAgIGhvdXJzOiBlID8gZS5nZXRIb3VycygpIDogMCwKICAgICAgbWludXRlczogZSA/IGUuZ2V0TWludXRlcygpIDogMCwKICAgICAgc2Vjb25kczogZSA/IGUuZ2V0U2Vjb25kcygpIDogMAogICAgfTsKICB9LCBELnByb3RvdHlwZS5jaGVja0RhdGUgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQsCiAgICAgICAgYSwKICAgICAgICBuID0gdGhpcywKICAgICAgICBpID0gKG5ldyBEYXRlKCksIG4uY29uZmlnKSwKICAgICAgICByID0gbi5sYW5nKCksCiAgICAgICAgbyA9IGkuZGF0ZVRpbWUgPSBpLmRhdGVUaW1lIHx8IG4uc3lzdGVtRGF0ZSgpLAogICAgICAgIHMgPSBuLmJpbmRFbGVtIHx8IGkuZWxlbVswXSwKICAgICAgICB5ID0gKG4uaXNJbnB1dChzKSA/ICJ2YWwiIDogImh0bWwiLCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChuLnJhbmdlRWxlbSkgewogICAgICAgIHZhciBlID0gW24ucmFuZ2VFbGVtWzBdLnZhbCgpLCBuLnJhbmdlRWxlbVsxXS52YWwoKV07CiAgICAgICAgaWYgKGVbMF0gJiYgZVsxXSkgcmV0dXJuIGUuam9pbigiICIgKyBuLnJhbmdlU3RyICsgIiAiKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG4uaXNJbnB1dChzKSA/IHMudmFsdWUgOiAic3RhdGljIiA9PT0gaS5wb3NpdGlvbiA/ICIiIDogbGF5KHMpLmF0dHIoImxheS1kYXRlIik7CiAgICB9KCkpLAogICAgICAgIGQgPSBmdW5jdGlvbiBkKGUpIHsKICAgICAgZS55ZWFyID4gbVsxXSAmJiAoZS55ZWFyID0gbVsxXSwgYSA9ICEwKSwgZS5tb250aCA+IDExICYmIChlLm1vbnRoID0gMTEsIGEgPSAhMCksIGUuaG91cnMgPiAyMyAmJiAoZS5ob3VycyA9IDAsIGEgPSAhMCksIGUubWludXRlcyA+IDU5ICYmIChlLm1pbnV0ZXMgPSAwLCBlLmhvdXJzKyssIGEgPSAhMCksIGUuc2Vjb25kcyA+IDU5ICYmIChlLnNlY29uZHMgPSAwLCBlLm1pbnV0ZXMrKywgYSA9ICEwKSwgdCA9IGwuZ2V0RW5kRGF0ZShlLm1vbnRoICsgMSwgZS55ZWFyKSwgZS5kYXRlID4gdCAmJiAoZS5kYXRlID0gdCwgYSA9ICEwKTsKICAgIH0sCiAgICAgICAgYyA9IGZ1bmN0aW9uIGMoZSwgdCwgbCkgewogICAgICB2YXIgciA9IFsic3RhcnRUaW1lIiwgImVuZFRpbWUiXTsKICAgICAgdCA9ICh0Lm1hdGNoKG4uRVhQX1NQTElUKSB8fCBbXSkuc2xpY2UoMSksIGwgPSBsIHx8IDAsIGkucmFuZ2UgJiYgKG5bcltsXV0gPSBuW3JbbF1dIHx8IHt9KSwgbGF5LmVhY2gobi5mb3JtYXQsIGZ1bmN0aW9uIChvLCBzKSB7CiAgICAgICAgdmFyIHkgPSBwYXJzZUZsb2F0KHRbb10pOwogICAgICAgIHRbb10ubGVuZ3RoIDwgcy5sZW5ndGggJiYgKGEgPSAhMCksIC95eXl5fHkvLnRlc3QocykgPyAoeSA8IG1bMF0gJiYgKHkgPSBtWzBdLCBhID0gITApLCBlLnllYXIgPSB5KSA6IC9NTXxNLy50ZXN0KHMpID8gKHkgPCAxICYmICh5ID0gMSwgYSA9ICEwKSwgZS5tb250aCA9IHkgLSAxKSA6IC9kZHxkLy50ZXN0KHMpID8gKHkgPCAxICYmICh5ID0gMSwgYSA9ICEwKSwgZS5kYXRlID0geSkgOiAvSEh8SC8udGVzdChzKSA/ICh5IDwgMSAmJiAoeSA9IDAsIGEgPSAhMCksIGUuaG91cnMgPSB5LCBpLnJhbmdlICYmIChuW3JbbF1dLmhvdXJzID0geSkpIDogL21tfG0vLnRlc3QocykgPyAoeSA8IDEgJiYgKHkgPSAwLCBhID0gITApLCBlLm1pbnV0ZXMgPSB5LCBpLnJhbmdlICYmIChuW3JbbF1dLm1pbnV0ZXMgPSB5KSkgOiAvc3N8cy8udGVzdChzKSAmJiAoeSA8IDEgJiYgKHkgPSAwLCBhID0gITApLCBlLnNlY29uZHMgPSB5LCBpLnJhbmdlICYmIChuW3JbbF1dLnNlY29uZHMgPSB5KSk7CiAgICAgIH0pLCBkKGUpOwogICAgfTsKCiAgICBpZiAoImxpbWl0IiA9PT0gZSkgcmV0dXJuIGQobyksIG47CiAgICB5ID0geSB8fCBpLnZhbHVlLCAic3RyaW5nIiA9PSB0eXBlb2YgeSAmJiAoeSA9IHkucmVwbGFjZSgvXHMrL2csICIgIikucmVwbGFjZSgvXlxzfFxzJC9nLCAiIikpOwoKICAgIHZhciB1ID0gZnVuY3Rpb24gdSgpIHsKICAgICAgaS5yYW5nZSAmJiAobi5lbmREYXRlID0gbi5lbmREYXRlIHx8IGxheS5leHRlbmQoe30sIGkuZGF0ZVRpbWUsIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZSA9IHt9LAogICAgICAgICAgICB0ID0gaS5kYXRlVGltZSwKICAgICAgICAgICAgYSA9IG4uZ2V0QXNZTSh0LnllYXIsIHQubW9udGgpOwogICAgICAgIHJldHVybiAieWVhciIgPT09IGkudHlwZSA/IGUueWVhciA9IHQueWVhciArIDEgOiAidGltZSIgIT09IGkudHlwZSAmJiAoZS55ZWFyID0gYVswXSwgZS5tb250aCA9IGFbMV0pLCAiZGF0ZXRpbWUiICE9PSBpLnR5cGUgJiYgInRpbWUiICE9PSBpLnR5cGUgfHwgKGUuaG91cnMgPSAyMywgZS5taW51dGVzID0gZS5zZWNvbmRzID0gNTkpLCBlOwogICAgICB9KCkpKTsKICAgIH07CgogICAgdSgpLCAic3RyaW5nIiA9PSB0eXBlb2YgeSAmJiB5ID8gbi5FWFBfSUYudGVzdCh5KSA/IGkucmFuZ2UgPyAoeSA9IHkuc3BsaXQoIiAiICsgbi5yYW5nZVN0ciArICIgIiksIGxheS5lYWNoKFtpLmRhdGVUaW1lLCBuLmVuZERhdGVdLCBmdW5jdGlvbiAoZSwgdCkgewogICAgICBjKHQsIHlbZV0sIGUpOwogICAgfSkpIDogYyhvLCB5KSA6IChuLmhpbnQoci5mb3JtYXRFcnJvclswXSArIChpLnJhbmdlID8gaS5mb3JtYXQgKyAiICIgKyBuLnJhbmdlU3RyICsgIiAiICsgaS5mb3JtYXQgOiBpLmZvcm1hdCkgKyByLmZvcm1hdEVycm9yWzFdKSwgYSA9ICEwKSA6IHkgJiYgImRhdGUiID09PSBsYXl1aS5fdHlwZW9mKHkpID8gaS5kYXRlVGltZSA9IG4uc3lzdGVtRGF0ZSh5KSA6IChpLmRhdGVUaW1lID0gbi5zeXN0ZW1EYXRlKCksIGRlbGV0ZSBuLnN0YXJ0VGltZSwgZGVsZXRlIG4uZW5kRGF0ZSwgdSgpLCBkZWxldGUgbi5lbmRUaW1lKSwgZnVuY3Rpb24gKCkgewogICAgICBpZiAobi5yYW5nZUVsZW0pIHsKICAgICAgICB2YXIgZSA9IFtuLnJhbmdlRWxlbVswXS52YWwoKSwgbi5yYW5nZUVsZW1bMV0udmFsKCldLAogICAgICAgICAgICB0ID0gW2kuZGF0ZVRpbWUsIG4uZW5kRGF0ZV07CiAgICAgICAgbGF5LmVhY2goZSwgZnVuY3Rpb24gKGUsIGEpIHsKICAgICAgICAgIG4uRVhQX0lGX09ORS50ZXN0KGEpICYmIGModFtlXSwgYSwgZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0oKSwgZChvKSwgaS5yYW5nZSAmJiBkKG4uZW5kRGF0ZSksIGEgJiYgeSAmJiBuLnNldFZhbHVlKGkucmFuZ2UgPyBuLmVuZERhdGUgPyBuLnBhcnNlKCkgOiAiIiA6IG4ucGFyc2UoKSk7CgogICAgdmFyIGggPSBmdW5jdGlvbiBoKGUpIHsKICAgICAgcmV0dXJuIG4ubmV3RGF0ZShlKS5nZXRUaW1lKCk7CiAgICB9OwoKICAgIHJldHVybiAoaChvKSA+IGgoaS5tYXgpIHx8IGgobykgPCBoKGkubWluKSkgJiYgKG8gPSBpLmRhdGVUaW1lID0gbGF5LmV4dGVuZCh7fSwgaS5taW4pKSwgaS5yYW5nZSAmJiAoaChuLmVuZERhdGUpIDwgaChpLm1pbikgfHwgaChuLmVuZERhdGUpID4gaChpLm1heCkpICYmIChuLmVuZERhdGUgPSBsYXkuZXh0ZW5kKHt9LCBpLm1heCkpLCBlICYmIGUoKSwgbjsKICB9LCBELnByb3RvdHlwZS5tYXJrID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgIHZhciBhLAogICAgICAgIG4gPSB0aGlzLAogICAgICAgIGkgPSBuLmNvbmZpZzsKICAgIHJldHVybiBsYXkuZWFjaChpLm1hcmssIGZ1bmN0aW9uIChlLCBuKSB7CiAgICAgIHZhciBpID0gZS5zcGxpdCgiLSIpOwogICAgICBpWzBdICE9IHRbMF0gJiYgMCAhPSBpWzBdIHx8IGlbMV0gIT0gdFsxXSAmJiAwICE9IGlbMV0gfHwgaVsyXSAhPSB0WzJdIHx8IChhID0gbiB8fCB0WzJdKTsKICAgIH0pLCBhICYmIGUuaHRtbCgnPHNwYW4gY2xhc3M9ImxheWRhdGUtZGF5LW1hcmsiPicgKyBhICsgIjwvc3Bhbj4iKSwgbjsKICB9LCBELnByb3RvdHlwZS5saW1pdCA9IGZ1bmN0aW9uIChlLCB0LCBhLCBuKSB7CiAgICB2YXIgaSwKICAgICAgICBsID0gdGhpcywKICAgICAgICByID0gbC5jb25maWcsCiAgICAgICAgbyA9IHt9LAogICAgICAgIHMgPSByW2EgPiA0MSA/ICJlbmREYXRlIiA6ICJkYXRlVGltZSJdLAogICAgICAgIHkgPSBsYXkuZXh0ZW5kKHt9LCBzLCB0IHx8IHt9KTsKICAgIHJldHVybiBsYXkuZWFjaCh7CiAgICAgIG5vdzogeSwKICAgICAgbWluOiByLm1pbiwKICAgICAgbWF4OiByLm1heAogICAgfSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgb1tlXSA9IGwubmV3RGF0ZShsYXkuZXh0ZW5kKHsKICAgICAgICB5ZWFyOiB0LnllYXIsCiAgICAgICAgbW9udGg6IHQubW9udGgsCiAgICAgICAgZGF0ZTogdC5kYXRlCiAgICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZSA9IHt9OwogICAgICAgIHJldHVybiBsYXkuZWFjaChuLCBmdW5jdGlvbiAoYSwgbikgewogICAgICAgICAgZVtuXSA9IHRbbl07CiAgICAgICAgfSksIGU7CiAgICAgIH0oKSkpLmdldFRpbWUoKTsKICAgIH0pLCBpID0gby5ub3cgPCBvLm1pbiB8fCBvLm5vdyA+IG8ubWF4LCBlICYmIGVbaSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiXShkKSwgaTsKICB9LCBELnByb3RvdHlwZS50aGlzRGF0ZVRpbWUgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSB0aGlzLAogICAgICAgIGEgPSB0LmNvbmZpZzsKICAgIHJldHVybiBlID8gdC5lbmREYXRlIDogYS5kYXRlVGltZTsKICB9LCBELnByb3RvdHlwZS5jYWxlbmRhciA9IGZ1bmN0aW9uIChlLCB0LCBhKSB7CiAgICB2YXIgbiwKICAgICAgICBpLAogICAgICAgIHIsCiAgICAgICAgbyA9IHRoaXMsCiAgICAgICAgcyA9IG8uY29uZmlnLAogICAgICAgIHQgPSB0ID8gMSA6IDAsCiAgICAgICAgZCA9IGUgfHwgby50aGlzRGF0ZVRpbWUodCksCiAgICAgICAgYyA9IG5ldyBEYXRlKCksCiAgICAgICAgdSA9IG8ubGFuZygpLAogICAgICAgIGggPSAiZGF0ZSIgIT09IHMudHlwZSAmJiAiZGF0ZXRpbWUiICE9PSBzLnR5cGUsCiAgICAgICAgZiA9IGxheShvLnRhYmxlW3RdKS5maW5kKCJ0ZCIpLAogICAgICAgIGcgPSBsYXkoby5lbGVtSGVhZGVyW3RdWzJdKS5maW5kKCJzcGFuIik7CiAgICByZXR1cm4gZC55ZWFyIDwgbVswXSAmJiAoZC55ZWFyID0gbVswXSwgby5oaW50KHUuaW52YWxpZERhdGUpKSwgZC55ZWFyID4gbVsxXSAmJiAoZC55ZWFyID0gbVsxXSwgby5oaW50KHUuaW52YWxpZERhdGUpKSwgby5maXJzdERhdGUgfHwgKG8uZmlyc3REYXRlID0gbGF5LmV4dGVuZCh7fSwgZCkpLCBjLnNldEZ1bGxZZWFyKGQueWVhciwgZC5tb250aCwgMSksIG4gPSBjLmdldERheSgpLCBpID0gbC5nZXRFbmREYXRlKGQubW9udGggfHwgMTIsIGQueWVhciksIHIgPSBsLmdldEVuZERhdGUoZC5tb250aCArIDEsIGQueWVhciksIGxheS5lYWNoKGYsIGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgIHZhciBhID0gW2QueWVhciwgZC5tb250aF0sCiAgICAgICAgICBsID0gMDsKICAgICAgdCA9IGxheSh0KSwgdC5yZW1vdmVBdHRyKCJjbGFzcyIpLCBlIDwgbiA/IChsID0gaSAtIG4gKyBlLCB0LmFkZENsYXNzKCJsYXlkYXRlLWRheS1wcmV2IiksIGEgPSBvLmdldEFzWU0oZC55ZWFyLCBkLm1vbnRoLCAic3ViIikpIDogZSA+PSBuICYmIGUgPCByICsgbiA/IChsID0gZSAtIG4sIGwgKyAxID09PSBkLmRhdGUgJiYgdC5hZGRDbGFzcyh5KSkgOiAobCA9IGUgLSByIC0gbiwgdC5hZGRDbGFzcygibGF5ZGF0ZS1kYXktbmV4dCIpLCBhID0gby5nZXRBc1lNKGQueWVhciwgZC5tb250aCkpLCBhWzFdKyssIGFbMl0gPSBsICsgMSwgdC5hdHRyKCJsYXkteW1kIiwgYS5qb2luKCItIikpLmh0bWwoYVsyXSksIG8ubWFyayh0LCBhKS5saW1pdCh0LCB7CiAgICAgICAgeWVhcjogYVswXSwKICAgICAgICBtb250aDogYVsxXSAtIDEsCiAgICAgICAgZGF0ZTogYVsyXQogICAgICB9LCBlKTsKICAgIH0pLCBsYXkoZ1swXSkuYXR0cigibGF5LXltIiwgZC55ZWFyICsgIi0iICsgKGQubW9udGggKyAxKSksIGxheShnWzFdKS5hdHRyKCJsYXkteW0iLCBkLnllYXIgKyAiLSIgKyAoZC5tb250aCArIDEpKSwgImNuIiA9PT0gcy5sYW5nID8gKGxheShnWzBdKS5hdHRyKCJsYXktdHlwZSIsICJ5ZWFyIikuaHRtbChkLnllYXIgKyAiIFx1NUU3NCIpLCBsYXkoZ1sxXSkuYXR0cigibGF5LXR5cGUiLCAibW9udGgiKS5odG1sKGQubW9udGggKyAxICsgIiBcdTY3MDgiKSkgOiAobGF5KGdbMF0pLmF0dHIoImxheS10eXBlIiwgIm1vbnRoIikuaHRtbCh1Lm1vbnRoW2QubW9udGhdKSwgbGF5KGdbMV0pLmF0dHIoImxheS10eXBlIiwgInllYXIiKS5odG1sKGQueWVhcikpLCBoICYmIChzLnJhbmdlID8gZSAmJiAoby5saXN0WU0gPSBbW3MuZGF0ZVRpbWUueWVhciwgcy5kYXRlVGltZS5tb250aCArIDFdLCBbby5lbmREYXRlLnllYXIsIG8uZW5kRGF0ZS5tb250aCArIDFdXSwgby5saXN0KHMudHlwZSwgMCkubGlzdChzLnR5cGUsIDEpLCAidGltZSIgPT09IHMudHlwZSA/IG8uc2V0QnRuU3RhdHVzKCJcdTY1RjZcdTk1RjQiLCBsYXkuZXh0ZW5kKHt9LCBvLnN5c3RlbURhdGUoKSwgby5zdGFydFRpbWUpLCBsYXkuZXh0ZW5kKHt9LCBvLnN5c3RlbURhdGUoKSwgby5lbmRUaW1lKSkgOiBvLnNldEJ0blN0YXR1cyghMCkpIDogKG8ubGlzdFlNID0gW1tkLnllYXIsIGQubW9udGggKyAxXV0sIG8ubGlzdChzLnR5cGUsIDApKSksIHMucmFuZ2UgJiYgImluaXQiID09PSBhICYmICFlICYmIG8uY2FsZW5kYXIoby5lbmREYXRlLCAxKSwgcy5yYW5nZSB8fCBvLmxpbWl0KGxheShvLmZvb3RlcikuZmluZChwKSwgbnVsbCwgMCwgWyJob3VycyIsICJtaW51dGVzIiwgInNlY29uZHMiXSksIG8uc2V0QnRuU3RhdHVzKCksIG87CiAgfSwgRC5wcm90b3R5cGUubGlzdCA9IGZ1bmN0aW9uIChlLCB0KSB7CiAgICB2YXIgYSA9IHRoaXMsCiAgICAgICAgbiA9IGEuY29uZmlnLAogICAgICAgIGkgPSBuLmRhdGVUaW1lLAogICAgICAgIGwgPSBhLmxhbmcoKSwKICAgICAgICByID0gbi5yYW5nZSAmJiAiZGF0ZSIgIT09IG4udHlwZSAmJiAiZGF0ZXRpbWUiICE9PSBuLnR5cGUsCiAgICAgICAgbyA9IGxheS5lbGVtKCJ1bCIsIHsKICAgICAgImNsYXNzIjogdSArICIgIiArIHsKICAgICAgICB5ZWFyOiAibGF5ZGF0ZS15ZWFyLWxpc3QiLAogICAgICAgIG1vbnRoOiAibGF5ZGF0ZS1tb250aC1saXN0IiwKICAgICAgICB0aW1lOiAibGF5ZGF0ZS10aW1lLWxpc3QiCiAgICAgIH1bZV0KICAgIH0pLAogICAgICAgIHMgPSBhLmVsZW1IZWFkZXJbdF0sCiAgICAgICAgbSA9IGxheShzWzJdKS5maW5kKCJzcGFuIiksCiAgICAgICAgYyA9IGEuZWxlbUNvbnRbdCB8fCAwXSwKICAgICAgICBoID0gbGF5KGMpLmZpbmQoIi4iICsgdSlbMF0sCiAgICAgICAgZiA9ICJjbiIgPT09IG4ubGFuZywKICAgICAgICBUID0gZiA/ICJcdTVFNzQiIDogIiIsCiAgICAgICAgRCA9IGEubGlzdFlNW3RdIHx8IHt9LAogICAgICAgIHcgPSBbImhvdXJzIiwgIm1pbnV0ZXMiLCAic2Vjb25kcyJdLAogICAgICAgIHggPSBbInN0YXJ0VGltZSIsICJlbmRUaW1lIl1bdF07CgogICAgaWYgKERbMF0gPCAxICYmIChEWzBdID0gMSksICJ5ZWFyIiA9PT0gZSkgewogICAgICB2YXIgTSwKICAgICAgICAgIEUgPSBNID0gRFswXSAtIDc7CiAgICAgIEUgPCAxICYmIChFID0gTSA9IDEpLCBsYXkuZWFjaChuZXcgQXJyYXkoMTUpLCBmdW5jdGlvbiAoZSkgewogICAgICAgIHZhciBpID0gbGF5LmVsZW0oImxpIiwgewogICAgICAgICAgImxheS15bSI6IE0KICAgICAgICB9KSwKICAgICAgICAgICAgbCA9IHsKICAgICAgICAgIHllYXI6IE0KICAgICAgICB9OwogICAgICAgIE0gPT0gRFswXSAmJiBsYXkoaSkuYWRkQ2xhc3MoeSksIGkuaW5uZXJIVE1MID0gTSArIFQsIG8uYXBwZW5kQ2hpbGQoaSksIE0gPCBhLmZpcnN0RGF0ZS55ZWFyID8gKGwubW9udGggPSBuLm1pbi5tb250aCwgbC5kYXRlID0gbi5taW4uZGF0ZSkgOiBNID49IGEuZmlyc3REYXRlLnllYXIgJiYgKGwubW9udGggPSBuLm1heC5tb250aCwgbC5kYXRlID0gbi5tYXguZGF0ZSksIGEubGltaXQobGF5KGkpLCBsLCB0KSwgTSsrOwogICAgICB9KSwgbGF5KG1bZiA/IDAgOiAxXSkuYXR0cigibGF5LXltIiwgTSAtIDggKyAiLSIgKyBEWzFdKS5odG1sKEUgKyBUICsgIiAtICIgKyAoTSAtIDEgKyBUKSk7CiAgICB9IGVsc2UgaWYgKCJtb250aCIgPT09IGUpIGxheS5lYWNoKG5ldyBBcnJheSgxMiksIGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBpID0gbGF5LmVsZW0oImxpIiwgewogICAgICAgICJsYXkteW0iOiBlCiAgICAgIH0pLAogICAgICAgICAgciA9IHsKICAgICAgICB5ZWFyOiBEWzBdLAogICAgICAgIG1vbnRoOiBlCiAgICAgIH07CiAgICAgIGUgKyAxID09IERbMV0gJiYgbGF5KGkpLmFkZENsYXNzKHkpLCBpLmlubmVySFRNTCA9IGwubW9udGhbZV0gKyAoZiA/ICJcdTY3MDgiIDogIiIpLCBvLmFwcGVuZENoaWxkKGkpLCBEWzBdIDwgYS5maXJzdERhdGUueWVhciA/IHIuZGF0ZSA9IG4ubWluLmRhdGUgOiBEWzBdID49IGEuZmlyc3REYXRlLnllYXIgJiYgKHIuZGF0ZSA9IG4ubWF4LmRhdGUpLCBhLmxpbWl0KGxheShpKSwgciwgdCk7CiAgICB9KSwgbGF5KG1bZiA/IDAgOiAxXSkuYXR0cigibGF5LXltIiwgRFswXSArICItIiArIERbMV0pLmh0bWwoRFswXSArIFQpO2Vsc2UgaWYgKCJ0aW1lIiA9PT0gZSkgewogICAgICB2YXIgQyA9IGZ1bmN0aW9uIEMoKSB7CiAgICAgICAgbGF5KG8pLmZpbmQoIm9sIikuZWFjaChmdW5jdGlvbiAoZSwgbikgewogICAgICAgICAgbGF5KG4pLmZpbmQoImxpIikuZWFjaChmdW5jdGlvbiAobiwgaSkgewogICAgICAgICAgICBhLmxpbWl0KGxheShpKSwgW3sKICAgICAgICAgICAgICBob3VyczogbgogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgaG91cnM6IGFbeF0uaG91cnMsCiAgICAgICAgICAgICAgbWludXRlczogbgogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgaG91cnM6IGFbeF0uaG91cnMsCiAgICAgICAgICAgICAgbWludXRlczogYVt4XS5taW51dGVzLAogICAgICAgICAgICAgIHNlY29uZHM6IG4KICAgICAgICAgICAgfV1bZV0sIHQsIFtbImhvdXJzIl0sIFsiaG91cnMiLCAibWludXRlcyJdLCBbImhvdXJzIiwgIm1pbnV0ZXMiLCAic2Vjb25kcyJdXVtlXSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KSwgbi5yYW5nZSB8fCBhLmxpbWl0KGxheShhLmZvb3RlcikuZmluZChwKSwgYVt4XSwgMCwgWyJob3VycyIsICJtaW51dGVzIiwgInNlY29uZHMiXSk7CiAgICAgIH07CgogICAgICBuLnJhbmdlID8gYVt4XSB8fCAoYVt4XSA9ICJzdGFydFRpbWUiID09PSB4ID8gaSA6IGEuZW5kRGF0ZSkgOiBhW3hdID0gaSwgbGF5LmVhY2goWzI0LCA2MCwgNjBdLCBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgIHZhciBuID0gbGF5LmVsZW0oImxpIiksCiAgICAgICAgICAgIGkgPSBbIjxwPiIgKyBsLnRpbWVbZV0gKyAiPC9wPjxvbD4iXTsKICAgICAgICBsYXkuZWFjaChuZXcgQXJyYXkodCksIGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICBpLnB1c2goIjxsaSIgKyAoYVt4XVt3W2VdXSA9PT0gdCA/ICcgY2xhc3M9IicgKyB5ICsgJyInIDogIiIpICsgIj4iICsgbGF5LmRpZ2l0KHQsIDIpICsgIjwvbGk+Iik7CiAgICAgICAgfSksIG4uaW5uZXJIVE1MID0gaS5qb2luKCIiKSArICI8L29sPiIsIG8uYXBwZW5kQ2hpbGQobik7CiAgICAgIH0pLCBDKCk7CiAgICB9CgogICAgaWYgKGggJiYgYy5yZW1vdmVDaGlsZChoKSwgYy5hcHBlbmRDaGlsZChvKSwgInllYXIiID09PSBlIHx8ICJtb250aCIgPT09IGUpIGxheShhLmVsZW1NYWluW3RdKS5hZGRDbGFzcygibGF5ZGF0ZS15bS1zaG93IiksIGxheShvKS5maW5kKCJsaSIpLm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGwgPSAwIHwgbGF5KHRoaXMpLmF0dHIoImxheS15bSIpOwoKICAgICAgaWYgKCFsYXkodGhpcykuaGFzQ2xhc3MoZCkpIHsKICAgICAgICAwID09PSB0ID8gKGlbZV0gPSBsLCBhLmxpbWl0KGxheShhLmZvb3RlcikuZmluZChwKSwgbnVsbCwgMCkpIDogYS5lbmREYXRlW2VdID0gbDsKICAgICAgICB2YXIgcyA9ICJ5ZWFyIiA9PT0gbi50eXBlIHx8ICJtb250aCIgPT09IG4udHlwZTsKICAgICAgICBzID8gKGxheShvKS5maW5kKCIuIiArIHkpLnJlbW92ZUNsYXNzKHkpLCBsYXkodGhpcykuYWRkQ2xhc3MoeSksICJtb250aCIgPT09IG4udHlwZSAmJiAieWVhciIgPT09IGUgJiYgKGEubGlzdFlNW3RdWzBdID0gbCwgciAmJiAoKHQgPyBhLmVuZERhdGUgOiBpKS55ZWFyID0gbCksIGEubGlzdCgibW9udGgiLCB0KSkpIDogKGEuY2hlY2tEYXRlKCJsaW1pdCIpLmNhbGVuZGFyKG51bGwsIHQpLCBhLmNsb3NlTGlzdCgpKSwgYS5zZXRCdG5TdGF0dXMoKSwgbi5yYW5nZSB8fCAoIm1vbnRoIiA9PT0gbi50eXBlICYmICJtb250aCIgPT09IGUgfHwgInllYXIiID09PSBuLnR5cGUgJiYgInllYXIiID09PSBlKSAmJiBhLnNldFZhbHVlKGEucGFyc2UoKSkucmVtb3ZlKCkuZG9uZSgpLCBhLmRvbmUobnVsbCwgImNoYW5nZSIpLCBsYXkoYS5mb290ZXIpLmZpbmQoIi4iICsgdikucmVtb3ZlQ2xhc3MoZCk7CiAgICAgIH0KICAgIH0pO2Vsc2UgewogICAgICB2YXIgSSA9IGxheS5lbGVtKCJzcGFuIiwgewogICAgICAgICJjbGFzcyI6IGcKICAgICAgfSksCiAgICAgICAgICBrID0gZnVuY3Rpb24gaygpIHsKICAgICAgICBsYXkobykuZmluZCgib2wiKS5lYWNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICAgICAgbiA9IGxheSh0KS5maW5kKCJsaSIpOwogICAgICAgICAgdC5zY3JvbGxUb3AgPSAzMCAqIChhW3hdW3dbZV1dIC0gMiksIHQuc2Nyb2xsVG9wIDw9IDAgJiYgbi5lYWNoKGZ1bmN0aW9uIChlLCBhKSB7CiAgICAgICAgICAgIGlmICghbGF5KHRoaXMpLmhhc0NsYXNzKGQpKSByZXR1cm4gdC5zY3JvbGxUb3AgPSAzMCAqIChlIC0gMiksICEwOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgICAgICBiID0gbGF5KHNbMl0pLmZpbmQoIi4iICsgZyk7CgogICAgICBrKCksIEkuaW5uZXJIVE1MID0gbi5yYW5nZSA/IFtsLnN0YXJ0VGltZSwgbC5lbmRUaW1lXVt0XSA6IGwudGltZVRpcHMsIGxheShhLmVsZW1NYWluW3RdKS5hZGRDbGFzcygibGF5ZGF0ZS10aW1lLXNob3ciKSwgYlswXSAmJiBiLnJlbW92ZSgpLCBzWzJdLmFwcGVuZENoaWxkKEkpLCBsYXkobykuZmluZCgib2wiKS5lYWNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdmFyIHQgPSB0aGlzOwogICAgICAgIGxheSh0KS5maW5kKCJsaSIpLm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBsID0gMCB8IHRoaXMuaW5uZXJIVE1MOwogICAgICAgICAgbGF5KHRoaXMpLmhhc0NsYXNzKGQpIHx8IChuLnJhbmdlID8gYVt4XVt3W2VdXSA9IGwgOiBpW3dbZV1dID0gbCwgbGF5KHQpLmZpbmQoIi4iICsgeSkucmVtb3ZlQ2xhc3MoeSksIGxheSh0aGlzKS5hZGRDbGFzcyh5KSwgQygpLCBrKCksIChhLmVuZERhdGUgfHwgInRpbWUiID09PSBuLnR5cGUpICYmIGEuZG9uZShudWxsLCAiY2hhbmdlIiksIGEuc2V0QnRuU3RhdHVzKCkpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBhOwogIH0sIEQucHJvdG90eXBlLmxpc3RZTSA9IFtdLCBELnByb3RvdHlwZS5jbG9zZUxpc3QgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXM7CiAgICBlLmNvbmZpZzsKICAgIGxheS5lYWNoKGUuZWxlbUNvbnQsIGZ1bmN0aW9uICh0LCBhKSB7CiAgICAgIGxheSh0aGlzKS5maW5kKCIuIiArIHUpLnJlbW92ZSgpLCBsYXkoZS5lbGVtTWFpblt0XSkucmVtb3ZlQ2xhc3MoImxheWRhdGUteW0tc2hvdyBsYXlkYXRlLXRpbWUtc2hvdyIpOwogICAgfSksIGxheShlLmVsZW0pLmZpbmQoIi4iICsgZykucmVtb3ZlKCk7CiAgfSwgRC5wcm90b3R5cGUuc2V0QnRuU3RhdHVzID0gZnVuY3Rpb24gKGUsIHQsIGEpIHsKICAgIHZhciBuLAogICAgICAgIGkgPSB0aGlzLAogICAgICAgIGwgPSBpLmNvbmZpZywKICAgICAgICByID0gaS5sYW5nKCksCiAgICAgICAgbyA9IGxheShpLmZvb3RlcikuZmluZChwKTsKICAgIGwucmFuZ2UgJiYgInRpbWUiICE9PSBsLnR5cGUgJiYgKHQgPSB0IHx8IGwuZGF0ZVRpbWUsIGEgPSBhIHx8IGkuZW5kRGF0ZSwgbiA9IGkubmV3RGF0ZSh0KS5nZXRUaW1lKCkgPiBpLm5ld0RhdGUoYSkuZ2V0VGltZSgpLCBpLmxpbWl0KG51bGwsIHQpIHx8IGkubGltaXQobnVsbCwgYSkgPyBvLmFkZENsYXNzKGQpIDogb1tuID8gImFkZENsYXNzIiA6ICJyZW1vdmVDbGFzcyJdKGQpLCBlICYmIG4gJiYgaS5oaW50KCJzdHJpbmciID09IHR5cGVvZiBlID8gci50aW1lb3V0LnJlcGxhY2UoL1x1NjVlNVx1NjcxZi9nLCBlKSA6IHIudGltZW91dCkpOwogIH0sIEQucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgIHZhciBhID0gdGhpcywKICAgICAgICBuID0gYS5jb25maWcsCiAgICAgICAgaSA9IHQgfHwgKCJlbmQiID09IGUgPyBsYXkuZXh0ZW5kKHt9LCBhLmVuZERhdGUsIGEuZW5kVGltZSkgOiBuLnJhbmdlID8gbGF5LmV4dGVuZCh7fSwgbi5kYXRlVGltZSwgYS5zdGFydFRpbWUpIDogbi5kYXRlVGltZSksCiAgICAgICAgciA9IGwucGFyc2UoaSwgYS5mb3JtYXQsIDEpOwogICAgcmV0dXJuIG4ucmFuZ2UgJiYgdm9pZCAwID09PSBlID8gciArICIgIiArIGEucmFuZ2VTdHIgKyAiICIgKyBhLnBhcnNlKCJlbmQiKSA6IHI7CiAgfSwgRC5wcm90b3R5cGUubmV3RGF0ZSA9IGZ1bmN0aW9uIChlKSB7CiAgICByZXR1cm4gZSA9IGUgfHwge30sIG5ldyBEYXRlKGUueWVhciB8fCAxLCBlLm1vbnRoIHx8IDAsIGUuZGF0ZSB8fCAxLCBlLmhvdXJzIHx8IDAsIGUubWludXRlcyB8fCAwLCBlLnNlY29uZHMgfHwgMCk7CiAgfSwgRC5wcm90b3R5cGUuc2V0VmFsdWUgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSB0aGlzLAogICAgICAgIGEgPSB0LmNvbmZpZywKICAgICAgICBuID0gdC5iaW5kRWxlbSB8fCBhLmVsZW1bMF07CiAgICByZXR1cm4gInN0YXRpYyIgPT09IGEucG9zaXRpb24gPyB0IDogKGUgPSBlIHx8ICIiLCB0LmlzSW5wdXQobikgPyBsYXkobikudmFsKGUpIDogdC5yYW5nZUVsZW0gPyAodC5yYW5nZUVsZW1bMF0udmFsKGUgPyB0LnBhcnNlKCJzdGFydCIpIDogIiIpLCB0LnJhbmdlRWxlbVsxXS52YWwoZSA/IHQucGFyc2UoImVuZCIpIDogIiIpKSA6ICgwID09PSBsYXkobikuZmluZCgiKiIpLmxlbmd0aCAmJiBsYXkobikuaHRtbChlKSwgbGF5KG4pLmF0dHIoImxheS1kYXRlIiwgZSkpLCB0KTsKICB9LCBELnByb3RvdHlwZS5wcmV2aWV3ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIHQgPSBlLmNvbmZpZzsKCiAgICBpZiAodC5pc1ByZXZpZXcpIHsKICAgICAgdmFyIGEgPSBsYXkoZS5lbGVtKS5maW5kKCIuIiArIFQpLAogICAgICAgICAgbiA9IHQucmFuZ2UgPyBlLmVuZERhdGUgPyBlLnBhcnNlKCkgOiAiIiA6IGUucGFyc2UoKTsKICAgICAgYS5odG1sKG4pLmNzcyh7CiAgICAgICAgY29sb3I6ICIjNUZCODc4IgogICAgICB9KSwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgYS5jc3MoewogICAgICAgICAgY29sb3I6ICIjNjY2IgogICAgICAgIH0pOwogICAgICB9LCAzMDApOwogICAgfQogIH0sIEQucHJvdG90eXBlLmRvbmUgPSBmdW5jdGlvbiAoZSwgdCkgewogICAgdmFyIGEgPSB0aGlzLAogICAgICAgIG4gPSBhLmNvbmZpZywKICAgICAgICBpID0gbGF5LmV4dGVuZCh7fSwgbGF5LmV4dGVuZChuLmRhdGVUaW1lLCBhLnN0YXJ0VGltZSkpLAogICAgICAgIGwgPSBsYXkuZXh0ZW5kKHt9LCBsYXkuZXh0ZW5kKGEuZW5kRGF0ZSwgYS5lbmRUaW1lKSk7CiAgICByZXR1cm4gbGF5LmVhY2goW2ksIGxdLCBmdW5jdGlvbiAoZSwgdCkgewogICAgICAibW9udGgiIGluIHQgJiYgbGF5LmV4dGVuZCh0LCB7CiAgICAgICAgbW9udGg6IHQubW9udGggKyAxCiAgICAgIH0pOwogICAgfSksIGEucHJldmlldygpLCBlID0gZSB8fCBbYS5wYXJzZSgpLCBpLCBsXSwgImZ1bmN0aW9uIiA9PSB0eXBlb2Ygblt0IHx8ICJkb25lIl0gJiYgblt0IHx8ICJkb25lIl0uYXBwbHkobiwgZSksIGE7CiAgfSwgRC5wcm90b3R5cGUuY2hvb3NlID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgIHZhciBhID0gdGhpcywKICAgICAgICBuID0gYS5jb25maWcsCiAgICAgICAgaSA9IGEudGhpc0RhdGVUaW1lKHQpLAogICAgICAgIGwgPSAobGF5KGEuZWxlbSkuZmluZCgidGQiKSwgZS5hdHRyKCJsYXkteW1kIikuc3BsaXQoIi0iKSk7CiAgICBsID0gewogICAgICB5ZWFyOiAwIHwgbFswXSwKICAgICAgbW9udGg6ICgwIHwgbFsxXSkgLSAxLAogICAgICBkYXRlOiAwIHwgbFsyXQogICAgfSwgZS5oYXNDbGFzcyhkKSB8fCAobGF5LmV4dGVuZChpLCBsKSwgbi5yYW5nZSA/IChsYXkuZWFjaChbInN0YXJ0VGltZSIsICJlbmRUaW1lIl0sIGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgIGFbdF0gPSBhW3RdIHx8IHsKICAgICAgICBob3VyczogMCwKICAgICAgICBtaW51dGVzOiAwLAogICAgICAgIHNlY29uZHM6IDAKICAgICAgfTsKICAgIH0pLCBhLmNhbGVuZGFyKG51bGwsIHQpLmRvbmUobnVsbCwgImNoYW5nZSIpKSA6ICJzdGF0aWMiID09PSBuLnBvc2l0aW9uID8gYS5jYWxlbmRhcigpLmRvbmUoKS5kb25lKG51bGwsICJjaGFuZ2UiKSA6ICJkYXRlIiA9PT0gbi50eXBlID8gYS5zZXRWYWx1ZShhLnBhcnNlKCkpLnJlbW92ZSgpLmRvbmUoKSA6ICJkYXRldGltZSIgPT09IG4udHlwZSAmJiBhLmNhbGVuZGFyKCkuZG9uZShudWxsLCAiY2hhbmdlIikpOwogIH0sIEQucHJvdG90eXBlLnRvb2wgPSBmdW5jdGlvbiAoZSwgdCkgewogICAgdmFyIGEgPSB0aGlzLAogICAgICAgIG4gPSBhLmNvbmZpZywKICAgICAgICBpID0gYS5sYW5nKCksCiAgICAgICAgbCA9IG4uZGF0ZVRpbWUsCiAgICAgICAgciA9ICJzdGF0aWMiID09PSBuLnBvc2l0aW9uLAogICAgICAgIG8gPSB7CiAgICAgIGRhdGV0aW1lOiBmdW5jdGlvbiBkYXRldGltZSgpIHsKICAgICAgICBsYXkoZSkuaGFzQ2xhc3MoZCkgfHwgKGEubGlzdCgidGltZSIsIDApLCBuLnJhbmdlICYmIGEubGlzdCgidGltZSIsIDEpLCBsYXkoZSkuYXR0cigibGF5LXR5cGUiLCAiZGF0ZSIpLmh0bWwoYS5sYW5nKCkuZGF0ZVRpcHMpKTsKICAgICAgfSwKICAgICAgZGF0ZTogZnVuY3Rpb24gZGF0ZSgpIHsKICAgICAgICBhLmNsb3NlTGlzdCgpLCBsYXkoZSkuYXR0cigibGF5LXR5cGUiLCAiZGF0ZXRpbWUiKS5odG1sKGEubGFuZygpLnRpbWVUaXBzKTsKICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICAgIHIgJiYgKGxheS5leHRlbmQobCwgYS5maXJzdERhdGUpLCBhLmNhbGVuZGFyKCkpLCBuLnJhbmdlICYmIChkZWxldGUgbi5kYXRlVGltZSwgZGVsZXRlIGEuZW5kRGF0ZSwgZGVsZXRlIGEuc3RhcnRUaW1lLCBkZWxldGUgYS5lbmRUaW1lKSwgYS5zZXRWYWx1ZSgiIikucmVtb3ZlKCksIGEuZG9uZShbIiIsIHt9LCB7fV0pOwogICAgICB9LAogICAgICBub3c6IGZ1bmN0aW9uIG5vdygpIHsKICAgICAgICB2YXIgZSA9IG5ldyBEYXRlKCk7CiAgICAgICAgbGF5LmV4dGVuZChsLCBhLnN5c3RlbURhdGUoKSwgewogICAgICAgICAgaG91cnM6IGUuZ2V0SG91cnMoKSwKICAgICAgICAgIG1pbnV0ZXM6IGUuZ2V0TWludXRlcygpLAogICAgICAgICAgc2Vjb25kczogZS5nZXRTZWNvbmRzKCkKICAgICAgICB9KSwgYS5zZXRWYWx1ZShhLnBhcnNlKCkpLnJlbW92ZSgpLCByICYmIGEuY2FsZW5kYXIoKSwgYS5kb25lKCk7CiAgICAgIH0sCiAgICAgIGNvbmZpcm06IGZ1bmN0aW9uIGNvbmZpcm0oKSB7CiAgICAgICAgaWYgKG4ucmFuZ2UpIHsKICAgICAgICAgIGlmIChsYXkoZSkuaGFzQ2xhc3MoZCkpIHJldHVybiBhLmhpbnQoInRpbWUiID09PSBuLnR5cGUgPyBpLnRpbWVvdXQucmVwbGFjZSgvXHU2NWU1XHU2NzFmL2csICJcdTY1RjZcdTk1RjQiKSA6IGkudGltZW91dCk7CiAgICAgICAgfSBlbHNlIGlmIChsYXkoZSkuaGFzQ2xhc3MoZCkpIHJldHVybiBhLmhpbnQoaS5pbnZhbGlkRGF0ZSk7CgogICAgICAgIGEuZG9uZSgpLCBhLnNldFZhbHVlKGEucGFyc2UoKSkucmVtb3ZlKCk7CiAgICAgIH0KICAgIH07CiAgICBvW3RdICYmIG9bdF0oKTsKICB9LCBELnByb3RvdHlwZS5jaGFuZ2UgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSB0aGlzLAogICAgICAgIGEgPSB0LmNvbmZpZywKICAgICAgICBuID0gdC50aGlzRGF0ZVRpbWUoZSksCiAgICAgICAgaSA9IGEucmFuZ2UgJiYgKCJ5ZWFyIiA9PT0gYS50eXBlIHx8ICJtb250aCIgPT09IGEudHlwZSksCiAgICAgICAgbCA9IHQuZWxlbUNvbnRbZSB8fCAwXSwKICAgICAgICByID0gdC5saXN0WU1bZV0sCiAgICAgICAgbyA9IGZ1bmN0aW9uIG8oX28pIHsKICAgICAgdmFyIHMgPSBsYXkobCkuZmluZCgiLmxheWRhdGUteWVhci1saXN0IilbMF0sCiAgICAgICAgICB5ID0gbGF5KGwpLmZpbmQoIi5sYXlkYXRlLW1vbnRoLWxpc3QiKVswXTsKICAgICAgcmV0dXJuIHMgJiYgKHJbMF0gPSBfbyA/IHJbMF0gLSAxNSA6IHJbMF0gKyAxNSwgdC5saXN0KCJ5ZWFyIiwgZSkpLCB5ICYmIChfbyA/IHJbMF0tLSA6IHJbMF0rKywgdC5saXN0KCJtb250aCIsIGUpKSwgKHMgfHwgeSkgJiYgKGxheS5leHRlbmQobiwgewogICAgICAgIHllYXI6IHJbMF0KICAgICAgfSksIGkgJiYgKG4ueWVhciA9IHJbMF0pLCBhLnJhbmdlIHx8IHQuZG9uZShudWxsLCAiY2hhbmdlIiksIGEucmFuZ2UgfHwgdC5saW1pdChsYXkodC5mb290ZXIpLmZpbmQocCksIHsKICAgICAgICB5ZWFyOiByWzBdCiAgICAgIH0pKSwgdC5zZXRCdG5TdGF0dXMoKSwgcyB8fCB5OwogICAgfTsKCiAgICByZXR1cm4gewogICAgICBwcmV2WWVhcjogZnVuY3Rpb24gcHJldlllYXIoKSB7CiAgICAgICAgbygic3ViIikgfHwgKG4ueWVhci0tLCB0LmNoZWNrRGF0ZSgibGltaXQiKS5jYWxlbmRhcihudWxsLCBlKSwgdC5kb25lKG51bGwsICJjaGFuZ2UiKSk7CiAgICAgIH0sCiAgICAgIHByZXZNb250aDogZnVuY3Rpb24gcHJldk1vbnRoKCkgewogICAgICAgIHZhciBhID0gdC5nZXRBc1lNKG4ueWVhciwgbi5tb250aCwgInN1YiIpOwogICAgICAgIGxheS5leHRlbmQobiwgewogICAgICAgICAgeWVhcjogYVswXSwKICAgICAgICAgIG1vbnRoOiBhWzFdCiAgICAgICAgfSksIHQuY2hlY2tEYXRlKCJsaW1pdCIpLmNhbGVuZGFyKG51bGwsIGUpLCB0LmRvbmUobnVsbCwgImNoYW5nZSIpOwogICAgICB9LAogICAgICBuZXh0TW9udGg6IGZ1bmN0aW9uIG5leHRNb250aCgpIHsKICAgICAgICB2YXIgYSA9IHQuZ2V0QXNZTShuLnllYXIsIG4ubW9udGgpOwogICAgICAgIGxheS5leHRlbmQobiwgewogICAgICAgICAgeWVhcjogYVswXSwKICAgICAgICAgIG1vbnRoOiBhWzFdCiAgICAgICAgfSksIHQuY2hlY2tEYXRlKCJsaW1pdCIpLmNhbGVuZGFyKG51bGwsIGUpLCB0LmRvbmUobnVsbCwgImNoYW5nZSIpOwogICAgICB9LAogICAgICBuZXh0WWVhcjogZnVuY3Rpb24gbmV4dFllYXIoKSB7CiAgICAgICAgbygpIHx8IChuLnllYXIrKywgdC5jaGVja0RhdGUoImxpbWl0IikuY2FsZW5kYXIobnVsbCwgZSksIHQuZG9uZShudWxsLCAiY2hhbmdlIikpOwogICAgICB9CiAgICB9OwogIH0sIEQucHJvdG90eXBlLmNoYW5nZUV2ZW50ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzOwogICAgZS5jb25maWc7CiAgICBsYXkoZS5lbGVtKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoZSkgewogICAgICBsYXkuc3RvcGUoZSk7CiAgICB9KS5vbigibW91c2Vkb3duIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgbGF5LnN0b3BlKGUpOwogICAgfSksIGxheS5lYWNoKGUuZWxlbUhlYWRlciwgZnVuY3Rpb24gKHQsIGEpIHsKICAgICAgbGF5KGFbMF0pLm9uKCJjbGljayIsIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgZS5jaGFuZ2UodCkucHJldlllYXIoKTsKICAgICAgfSksIGxheShhWzFdKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoYSkgewogICAgICAgIGUuY2hhbmdlKHQpLnByZXZNb250aCgpOwogICAgICB9KSwgbGF5KGFbMl0pLmZpbmQoInNwYW4iKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoYSkgewogICAgICAgIHZhciBuID0gbGF5KHRoaXMpLAogICAgICAgICAgICBpID0gbi5hdHRyKCJsYXkteW0iKSwKICAgICAgICAgICAgbCA9IG4uYXR0cigibGF5LXR5cGUiKTsKICAgICAgICBpICYmIChpID0gaS5zcGxpdCgiLSIpLCBlLmxpc3RZTVt0XSA9IFswIHwgaVswXSwgMCB8IGlbMV1dLCBlLmxpc3QobCwgdCksIGxheShlLmZvb3RlcikuZmluZCgiLiIgKyB2KS5hZGRDbGFzcyhkKSk7CiAgICAgIH0pLCBsYXkoYVszXSkub24oImNsaWNrIiwgZnVuY3Rpb24gKGEpIHsKICAgICAgICBlLmNoYW5nZSh0KS5uZXh0TW9udGgoKTsKICAgICAgfSksIGxheShhWzRdKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoYSkgewogICAgICAgIGUuY2hhbmdlKHQpLm5leHRZZWFyKCk7CiAgICAgIH0pOwogICAgfSksIGxheS5lYWNoKGUudGFibGUsIGZ1bmN0aW9uICh0LCBhKSB7CiAgICAgIHZhciBuID0gbGF5KGEpLmZpbmQoInRkIik7CiAgICAgIG4ub24oImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICAgIGUuY2hvb3NlKGxheSh0aGlzKSwgdCk7CiAgICAgIH0pOwogICAgfSksIGxheShlLmZvb3RlcikuZmluZCgic3BhbiIpLm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHQgPSBsYXkodGhpcykuYXR0cigibGF5LXR5cGUiKTsKICAgICAgZS50b29sKHRoaXMsIHQpOwogICAgfSk7CiAgfSwgRC5wcm90b3R5cGUuaXNJbnB1dCA9IGZ1bmN0aW9uIChlKSB7CiAgICByZXR1cm4gL2lucHV0fHRleHRhcmVhLy50ZXN0KGUudGFnTmFtZS50b0xvY2FsZUxvd2VyQ2FzZSgpKTsKICB9LCBELnByb3RvdHlwZS5ldmVudHMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgdCA9IGUuY29uZmlnLAogICAgICAgIGEgPSBmdW5jdGlvbiBhKF9hLCBuKSB7CiAgICAgIF9hLm9uKHQudHJpZ2dlciwgZnVuY3Rpb24gKCkgewogICAgICAgIG4gJiYgKGUuYmluZEVsZW0gPSB0aGlzKSwgZS5yZW5kZXIoKTsKICAgICAgfSk7CiAgICB9OwoKICAgIHQuZWxlbVswXSAmJiAhdC5lbGVtWzBdLmV2ZW50SGFuZGxlciAmJiAoYSh0LmVsZW0sICJiaW5kIiksIGEodC5ldmVudEVsZW0pLCB0LmVsZW1bMF0uZXZlbnRIYW5kbGVyID0gITApOwogIH0sIHIudGhhdCA9IHt9LCByLmdldFRoaXMgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSByLnRoYXRbZV07CiAgICByZXR1cm4gIXQgJiYgYSAmJiBsYXl1aS5oaW50KCkuZXJyb3IoZSA/IG8gKyAiIGluc3RhbmNlIHdpdGggSUQgJyIgKyBlICsgIicgbm90IGZvdW5kIiA6ICJJRCBhcmd1bWVudCByZXF1aXJlZCIpLCB0OwogIH0sIG4ucnVuID0gZnVuY3Rpb24gKGEpIHsKICAgIGEodCkub24oIm1vdXNlZG93biIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIGlmIChsLnRoaXNJZCkgewogICAgICAgIHZhciB0ID0gci5nZXRUaGlzKGwudGhpc0lkKTsKCiAgICAgICAgaWYgKHQpIHsKICAgICAgICAgIHZhciBuID0gdC5jb25maWc7CiAgICAgICAgICBlLnRhcmdldCAhPT0gbi5lbGVtWzBdICYmIGUudGFyZ2V0ICE9PSBuLmV2ZW50RWxlbVswXSAmJiBlLnRhcmdldCAhPT0gYShuLmNsb3NlU3RvcClbMF0gJiYgdC5yZW1vdmUoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pLm9uKCJrZXlkb3duIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKGwudGhpc0lkKSB7CiAgICAgICAgdmFyIHQgPSByLmdldFRoaXMobC50aGlzSWQpOwogICAgICAgIHQgJiYgMTMgPT09IGUua2V5Q29kZSAmJiBhKCIjIiArIHQuZWxlbUlEKVswXSAmJiB0LmVsZW1JRCA9PT0gRC50aGlzRWxlbURhdGUgJiYgKGUucHJldmVudERlZmF1bHQoKSwgYSh0LmZvb3RlcikuZmluZChwKVswXS5jbGljaygpKTsKICAgICAgfQogICAgfSksIGEoZSkub24oInJlc2l6ZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGwudGhpc0lkKSB7CiAgICAgICAgdmFyIGUgPSByLmdldFRoaXMobC50aGlzSWQpOwogICAgICAgIGlmIChlKSByZXR1cm4gISghZS5lbGVtIHx8ICFhKHMpWzBdKSAmJiB2b2lkIGUucG9zaXRpb24oKTsKICAgICAgfQogICAgfSk7CiAgfSwgbC5yZW5kZXIgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSBuZXcgRChlKTsKICAgIHJldHVybiByLmNhbGwodCk7CiAgfSwgbC5wYXJzZSA9IGZ1bmN0aW9uIChlLCB0LCBhKSB7CiAgICByZXR1cm4gZSA9IGUgfHwge30sICJzdHJpbmciID09IHR5cGVvZiB0ICYmICh0ID0gci5mb3JtYXRBcnIodCkpLCB0ID0gKHQgfHwgW10pLmNvbmNhdCgpLCBsYXkuZWFjaCh0LCBmdW5jdGlvbiAobiwgaSkgewogICAgICAveXl5eXx5Ly50ZXN0KGkpID8gdFtuXSA9IGxheS5kaWdpdChlLnllYXIsIGkubGVuZ3RoKSA6IC9NTXxNLy50ZXN0KGkpID8gdFtuXSA9IGxheS5kaWdpdChlLm1vbnRoICsgKGEgfHwgMCksIGkubGVuZ3RoKSA6IC9kZHxkLy50ZXN0KGkpID8gdFtuXSA9IGxheS5kaWdpdChlLmRhdGUsIGkubGVuZ3RoKSA6IC9ISHxILy50ZXN0KGkpID8gdFtuXSA9IGxheS5kaWdpdChlLmhvdXJzLCBpLmxlbmd0aCkgOiAvbW18bS8udGVzdChpKSA/IHRbbl0gPSBsYXkuZGlnaXQoZS5taW51dGVzLCBpLmxlbmd0aCkgOiAvc3N8cy8udGVzdChpKSAmJiAodFtuXSA9IGxheS5kaWdpdChlLnNlY29uZHMsIGkubGVuZ3RoKSk7CiAgICB9KSwgdC5qb2luKCIiKTsKICB9LCBsLmdldEVuZERhdGUgPSBmdW5jdGlvbiAoZSwgdCkgewogICAgdmFyIGEgPSBuZXcgRGF0ZSgpOwogICAgcmV0dXJuIGEuc2V0RnVsbFllYXIodCB8fCBhLmdldEZ1bGxZZWFyKCksIGUgfHwgYS5nZXRNb250aCgpICsgMSwgMSksIG5ldyBEYXRlKGEuZ2V0VGltZSgpIC0gODY0ZTUpLmdldERhdGUoKTsKICB9LCBhID8gKGwucmVhZHkoKSwgbGF5dWkuZGVmaW5lKCJsYXkiLCBmdW5jdGlvbiAoZSkgewogICAgbC5wYXRoID0gbGF5dWkuY2FjaGUuZGlyLCBuLnJ1bihsYXkpLCBlKG8sIGwpOwogIH0pKSA6ICJmdW5jdGlvbiIgPT0gdHlwZW9mIGRlZmluZSAmJiBkZWZpbmUuYW1kID8gZGVmaW5lKGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuLnJ1bihsYXkpLCBsOwogIH0pIDogZnVuY3Rpb24gKCkgewogICAgbC5yZWFkeSgpLCBuLnJ1bihlLmxheSksIGUubGF5ZGF0ZSA9IGw7CiAgfSgpOwp9KHdpbmRvdywgd2luZG93LmRvY3VtZW50KTsKIWZ1bmN0aW9uIChlLCB0KSB7CiAgIm9iamVjdCIgPT0gKHR5cGVvZiBtb2R1bGUgPT09ICJ1bmRlZmluZWQiID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKG1vZHVsZSkpICYmICJvYmplY3QiID09IF90eXBlb2YobW9kdWxlLmV4cG9ydHMpID8gbW9kdWxlLmV4cG9ydHMgPSBlLmRvY3VtZW50ID8gdChlLCAhMCkgOiBmdW5jdGlvbiAoZSkgewogICAgaWYgKCFlLmRvY3VtZW50KSB0aHJvdyBuZXcgRXJyb3IoImpRdWVyeSByZXF1aXJlcyBhIHdpbmRvdyB3aXRoIGEgZG9jdW1lbnQiKTsKICAgIHJldHVybiB0KGUpOwogIH0gOiB0KGUpOwp9KCJ1bmRlZmluZWQiICE9IHR5cGVvZiB3aW5kb3cgPyB3aW5kb3cgOiB0aGlzLCBmdW5jdGlvbiAoZSwgdCkgewogIGZ1bmN0aW9uIG4oZSkgewogICAgdmFyIHQgPSAhIWUgJiYgImxlbmd0aCIgaW4gZSAmJiBlLmxlbmd0aCwKICAgICAgICBuID0gcGUudHlwZShlKTsKICAgIHJldHVybiAiZnVuY3Rpb24iICE9PSBuICYmICFwZS5pc1dpbmRvdyhlKSAmJiAoImFycmF5IiA9PT0gbiB8fCAwID09PSB0IHx8ICJudW1iZXIiID09IHR5cGVvZiB0ICYmIHQgPiAwICYmIHQgLSAxIGluIGUpOwogIH0KCiAgZnVuY3Rpb24gcihlLCB0LCBuKSB7CiAgICBpZiAocGUuaXNGdW5jdGlvbih0KSkgcmV0dXJuIHBlLmdyZXAoZSwgZnVuY3Rpb24gKGUsIHIpIHsKICAgICAgcmV0dXJuICEhdC5jYWxsKGUsIHIsIGUpICE9PSBuOwogICAgfSk7CiAgICBpZiAodC5ub2RlVHlwZSkgcmV0dXJuIHBlLmdyZXAoZSwgZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuIGUgPT09IHQgIT09IG47CiAgICB9KTsKCiAgICBpZiAoInN0cmluZyIgPT0gdHlwZW9mIHQpIHsKICAgICAgaWYgKENlLnRlc3QodCkpIHJldHVybiBwZS5maWx0ZXIodCwgZSwgbik7CiAgICAgIHQgPSBwZS5maWx0ZXIodCwgZSk7CiAgICB9CgogICAgcmV0dXJuIHBlLmdyZXAoZSwgZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuIHBlLmluQXJyYXkoZSwgdCkgPiAtMSAhPT0gbjsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gaShlLCB0KSB7CiAgICBkbyB7CiAgICAgIGUgPSBlW3RdOwogICAgfSB3aGlsZSAoZSAmJiAxICE9PSBlLm5vZGVUeXBlKTsKCiAgICByZXR1cm4gZTsKICB9CgogIGZ1bmN0aW9uIG8oZSkgewogICAgdmFyIHQgPSB7fTsKICAgIHJldHVybiBwZS5lYWNoKGUubWF0Y2goRGUpIHx8IFtdLCBmdW5jdGlvbiAoZSwgbikgewogICAgICB0W25dID0gITA7CiAgICB9KSwgdDsKICB9CgogIGZ1bmN0aW9uIGEoKSB7CiAgICByZS5hZGRFdmVudExpc3RlbmVyID8gKHJlLnJlbW92ZUV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBzKSwgZS5yZW1vdmVFdmVudExpc3RlbmVyKCJsb2FkIiwgcykpIDogKHJlLmRldGFjaEV2ZW50KCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBzKSwgZS5kZXRhY2hFdmVudCgib25sb2FkIiwgcykpOwogIH0KCiAgZnVuY3Rpb24gcygpIHsKICAgIChyZS5hZGRFdmVudExpc3RlbmVyIHx8ICJsb2FkIiA9PT0gZS5ldmVudC50eXBlIHx8ICJjb21wbGV0ZSIgPT09IHJlLnJlYWR5U3RhdGUpICYmIChhKCksIHBlLnJlYWR5KCkpOwogIH0KCiAgZnVuY3Rpb24gdShlLCB0LCBuKSB7CiAgICBpZiAodm9pZCAwID09PSBuICYmIDEgPT09IGUubm9kZVR5cGUpIHsKICAgICAgdmFyIHIgPSAiZGF0YS0iICsgdC5yZXBsYWNlKF9lLCAiLSQxIikudG9Mb3dlckNhc2UoKTsKCiAgICAgIGlmIChuID0gZS5nZXRBdHRyaWJ1dGUociksICJzdHJpbmciID09IHR5cGVvZiBuKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIG4gPSAidHJ1ZSIgPT09IG4gfHwgImZhbHNlIiAhPT0gbiAmJiAoIm51bGwiID09PSBuID8gbnVsbCA6ICtuICsgIiIgPT09IG4gPyArbiA6IHFlLnRlc3QobikgPyBwZS5wYXJzZUpTT04obikgOiBuKTsKICAgICAgICB9IGNhdGNoIChpKSB7fQoKICAgICAgICBwZS5kYXRhKGUsIHQsIG4pOwogICAgICB9IGVsc2UgbiA9IHZvaWQgMDsKICAgIH0KCiAgICByZXR1cm4gbjsKICB9CgogIGZ1bmN0aW9uIGwoZSkgewogICAgdmFyIHQ7CgogICAgZm9yICh0IGluIGUpIHsKICAgICAgaWYgKCgiZGF0YSIgIT09IHQgfHwgIXBlLmlzRW1wdHlPYmplY3QoZVt0XSkpICYmICJ0b0pTT04iICE9PSB0KSByZXR1cm4gITE7CiAgICB9CgogICAgcmV0dXJuICEwOwogIH0KCiAgZnVuY3Rpb24gYyhlLCB0LCBuLCByKSB7CiAgICBpZiAoSGUoZSkpIHsKICAgICAgdmFyIGksCiAgICAgICAgICBvLAogICAgICAgICAgYSA9IHBlLmV4cGFuZG8sCiAgICAgICAgICBzID0gZS5ub2RlVHlwZSwKICAgICAgICAgIHUgPSBzID8gcGUuY2FjaGUgOiBlLAogICAgICAgICAgbCA9IHMgPyBlW2FdIDogZVthXSAmJiBhOwogICAgICBpZiAobCAmJiB1W2xdICYmIChyIHx8IHVbbF0uZGF0YSkgfHwgdm9pZCAwICE9PSBuIHx8ICJzdHJpbmciICE9IHR5cGVvZiB0KSByZXR1cm4gbCB8fCAobCA9IHMgPyBlW2FdID0gbmUucG9wKCkgfHwgcGUuZ3VpZCsrIDogYSksIHVbbF0gfHwgKHVbbF0gPSBzID8ge30gOiB7CiAgICAgICAgdG9KU09OOiBwZS5ub29wCiAgICAgIH0pLCAib2JqZWN0IiAhPSBfdHlwZW9mKHQpICYmICJmdW5jdGlvbiIgIT0gdHlwZW9mIHQgfHwgKHIgPyB1W2xdID0gcGUuZXh0ZW5kKHVbbF0sIHQpIDogdVtsXS5kYXRhID0gcGUuZXh0ZW5kKHVbbF0uZGF0YSwgdCkpLCBvID0gdVtsXSwgciB8fCAoby5kYXRhIHx8IChvLmRhdGEgPSB7fSksIG8gPSBvLmRhdGEpLCB2b2lkIDAgIT09IG4gJiYgKG9bcGUuY2FtZWxDYXNlKHQpXSA9IG4pLCAic3RyaW5nIiA9PSB0eXBlb2YgdCA/IChpID0gb1t0XSwgbnVsbCA9PSBpICYmIChpID0gb1twZS5jYW1lbENhc2UodCldKSkgOiBpID0gbywgaTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGYoZSwgdCwgbikgewogICAgaWYgKEhlKGUpKSB7CiAgICAgIHZhciByLAogICAgICAgICAgaSwKICAgICAgICAgIG8gPSBlLm5vZGVUeXBlLAogICAgICAgICAgYSA9IG8gPyBwZS5jYWNoZSA6IGUsCiAgICAgICAgICBzID0gbyA/IGVbcGUuZXhwYW5kb10gOiBwZS5leHBhbmRvOwoKICAgICAgaWYgKGFbc10pIHsKICAgICAgICBpZiAodCAmJiAociA9IG4gPyBhW3NdIDogYVtzXS5kYXRhKSkgewogICAgICAgICAgcGUuaXNBcnJheSh0KSA/IHQgPSB0LmNvbmNhdChwZS5tYXAodCwgcGUuY2FtZWxDYXNlKSkgOiB0IGluIHIgPyB0ID0gW3RdIDogKHQgPSBwZS5jYW1lbENhc2UodCksIHQgPSB0IGluIHIgPyBbdF0gOiB0LnNwbGl0KCIgIikpLCBpID0gdC5sZW5ndGg7CgogICAgICAgICAgZm9yICg7IGktLTspIHsKICAgICAgICAgICAgZGVsZXRlIHJbdFtpXV07CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKG4gPyAhbChyKSA6ICFwZS5pc0VtcHR5T2JqZWN0KHIpKSByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAobiB8fCAoZGVsZXRlIGFbc10uZGF0YSwgbChhW3NdKSkpICYmIChvID8gcGUuY2xlYW5EYXRhKFtlXSwgITApIDogZmUuZGVsZXRlRXhwYW5kbyB8fCBhICE9IGEud2luZG93ID8gZGVsZXRlIGFbc10gOiBhW3NdID0gdm9pZCAwKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZChlLCB0LCBuLCByKSB7CiAgICB2YXIgaSwKICAgICAgICBvID0gMSwKICAgICAgICBhID0gMjAsCiAgICAgICAgcyA9IHIgPyBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiByLmN1cigpOwogICAgfSA6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHBlLmNzcyhlLCB0LCAiIik7CiAgICB9LAogICAgICAgIHUgPSBzKCksCiAgICAgICAgbCA9IG4gJiYgblszXSB8fCAocGUuY3NzTnVtYmVyW3RdID8gIiIgOiAicHgiKSwKICAgICAgICBjID0gKHBlLmNzc051bWJlclt0XSB8fCAicHgiICE9PSBsICYmICt1KSAmJiBNZS5leGVjKHBlLmNzcyhlLCB0KSk7CgogICAgaWYgKGMgJiYgY1szXSAhPT0gbCkgewogICAgICBsID0gbCB8fCBjWzNdLCBuID0gbiB8fCBbXSwgYyA9ICt1IHx8IDE7CgogICAgICBkbyB7CiAgICAgICAgbyA9IG8gfHwgIi41IiwgYyAvPSBvLCBwZS5zdHlsZShlLCB0LCBjICsgbCk7CiAgICAgIH0gd2hpbGUgKG8gIT09IChvID0gcygpIC8gdSkgJiYgMSAhPT0gbyAmJiAtLWEpOwogICAgfQoKICAgIHJldHVybiBuICYmIChjID0gK2MgfHwgK3UgfHwgMCwgaSA9IG5bMV0gPyBjICsgKG5bMV0gKyAxKSAqIG5bMl0gOiArblsyXSwgciAmJiAoci51bml0ID0gbCwgci5zdGFydCA9IGMsIHIuZW5kID0gaSkpLCBpOwogIH0KCiAgZnVuY3Rpb24gcChlKSB7CiAgICB2YXIgdCA9IHplLnNwbGl0KCJ8IiksCiAgICAgICAgbiA9IGUuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgaWYgKG4uY3JlYXRlRWxlbWVudCkgZm9yICg7IHQubGVuZ3RoOykgewogICAgICBuLmNyZWF0ZUVsZW1lbnQodC5wb3AoKSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9CgogIGZ1bmN0aW9uIGgoZSwgdCkgewogICAgdmFyIG4sCiAgICAgICAgciwKICAgICAgICBpID0gMCwKICAgICAgICBvID0gInVuZGVmaW5lZCIgIT0gdHlwZW9mIGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPyBlLmdldEVsZW1lbnRzQnlUYWdOYW1lKHQgfHwgIioiKSA6ICJ1bmRlZmluZWQiICE9IHR5cGVvZiBlLnF1ZXJ5U2VsZWN0b3JBbGwgPyBlLnF1ZXJ5U2VsZWN0b3JBbGwodCB8fCAiKiIpIDogdm9pZCAwOwogICAgaWYgKCFvKSBmb3IgKG8gPSBbXSwgbiA9IGUuY2hpbGROb2RlcyB8fCBlOyBudWxsICE9IChyID0gbltpXSk7IGkrKykgewogICAgICAhdCB8fCBwZS5ub2RlTmFtZShyLCB0KSA/IG8ucHVzaChyKSA6IHBlLm1lcmdlKG8sIGgociwgdCkpOwogICAgfQogICAgcmV0dXJuIHZvaWQgMCA9PT0gdCB8fCB0ICYmIHBlLm5vZGVOYW1lKGUsIHQpID8gcGUubWVyZ2UoW2VdLCBvKSA6IG87CiAgfQoKICBmdW5jdGlvbiBnKGUsIHQpIHsKICAgIGZvciAodmFyIG4sIHIgPSAwOyBudWxsICE9IChuID0gZVtyXSk7IHIrKykgewogICAgICBwZS5fZGF0YShuLCAiZ2xvYmFsRXZhbCIsICF0IHx8IHBlLl9kYXRhKHRbcl0sICJnbG9iYWxFdmFsIikpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbShlKSB7CiAgICBCZS50ZXN0KGUudHlwZSkgJiYgKGUuZGVmYXVsdENoZWNrZWQgPSBlLmNoZWNrZWQpOwogIH0KCiAgZnVuY3Rpb24geShlLCB0LCBuLCByLCBpKSB7CiAgICBmb3IgKHZhciBvLCBhLCBzLCB1LCBsLCBjLCBmLCBkID0gZS5sZW5ndGgsIHkgPSBwKHQpLCB2ID0gW10sIHggPSAwOyB4IDwgZDsgeCsrKSB7CiAgICAgIGlmIChhID0gZVt4XSwgYSB8fCAwID09PSBhKSBpZiAoIm9iamVjdCIgPT09IHBlLnR5cGUoYSkpIHBlLm1lcmdlKHYsIGEubm9kZVR5cGUgPyBbYV0gOiBhKTtlbHNlIGlmIChVZS50ZXN0KGEpKSB7CiAgICAgICAgZm9yICh1ID0gdSB8fCB5LmFwcGVuZENoaWxkKHQuY3JlYXRlRWxlbWVudCgiZGl2IikpLCBsID0gKFdlLmV4ZWMoYSkgfHwgWyIiLCAiIl0pWzFdLnRvTG93ZXJDYXNlKCksIGYgPSBYZVtsXSB8fCBYZS5fZGVmYXVsdCwgdS5pbm5lckhUTUwgPSBmWzFdICsgcGUuaHRtbFByZWZpbHRlcihhKSArIGZbMl0sIG8gPSBmWzBdOyBvLS07KSB7CiAgICAgICAgICB1ID0gdS5sYXN0Q2hpbGQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWZlLmxlYWRpbmdXaGl0ZXNwYWNlICYmICRlLnRlc3QoYSkgJiYgdi5wdXNoKHQuY3JlYXRlVGV4dE5vZGUoJGUuZXhlYyhhKVswXSkpLCAhZmUudGJvZHkpIGZvciAoYSA9ICJ0YWJsZSIgIT09IGwgfHwgVmUudGVzdChhKSA/ICI8dGFibGU+IiAhPT0gZlsxXSB8fCBWZS50ZXN0KGEpID8gMCA6IHUgOiB1LmZpcnN0Q2hpbGQsIG8gPSBhICYmIGEuY2hpbGROb2Rlcy5sZW5ndGg7IG8tLTspIHsKICAgICAgICAgIHBlLm5vZGVOYW1lKGMgPSBhLmNoaWxkTm9kZXNbb10sICJ0Ym9keSIpICYmICFjLmNoaWxkTm9kZXMubGVuZ3RoICYmIGEucmVtb3ZlQ2hpbGQoYyk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHBlLm1lcmdlKHYsIHUuY2hpbGROb2RlcyksIHUudGV4dENvbnRlbnQgPSAiIjsgdS5maXJzdENoaWxkOykgewogICAgICAgICAgdS5yZW1vdmVDaGlsZCh1LmZpcnN0Q2hpbGQpOwogICAgICAgIH0KCiAgICAgICAgdSA9IHkubGFzdENoaWxkOwogICAgICB9IGVsc2Ugdi5wdXNoKHQuY3JlYXRlVGV4dE5vZGUoYSkpOwogICAgfQoKICAgIGZvciAodSAmJiB5LnJlbW92ZUNoaWxkKHUpLCBmZS5hcHBlbmRDaGVja2VkIHx8IHBlLmdyZXAoaCh2LCAiaW5wdXQiKSwgbSksIHggPSAwOyBhID0gdlt4KytdOykgewogICAgICBpZiAociAmJiBwZS5pbkFycmF5KGEsIHIpID4gLTEpIGkgJiYgaS5wdXNoKGEpO2Vsc2UgaWYgKHMgPSBwZS5jb250YWlucyhhLm93bmVyRG9jdW1lbnQsIGEpLCB1ID0gaCh5LmFwcGVuZENoaWxkKGEpLCAic2NyaXB0IiksIHMgJiYgZyh1KSwgbikgZm9yIChvID0gMDsgYSA9IHVbbysrXTspIHsKICAgICAgICBJZS50ZXN0KGEudHlwZSB8fCAiIikgJiYgbi5wdXNoKGEpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHUgPSBudWxsLCB5OwogIH0KCiAgZnVuY3Rpb24gdigpIHsKICAgIHJldHVybiAhMDsKICB9CgogIGZ1bmN0aW9uIHgoKSB7CiAgICByZXR1cm4gITE7CiAgfQoKICBmdW5jdGlvbiBiKCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIHJlLmFjdGl2ZUVsZW1lbnQ7CiAgICB9IGNhdGNoIChlKSB7fQogIH0KCiAgZnVuY3Rpb24gdyhlLCB0LCBuLCByLCBpLCBvKSB7CiAgICB2YXIgYSwgczsKCiAgICBpZiAoIm9iamVjdCIgPT0gX3R5cGVvZih0KSkgewogICAgICAic3RyaW5nIiAhPSB0eXBlb2YgbiAmJiAociA9IHIgfHwgbiwgbiA9IHZvaWQgMCk7CgogICAgICBmb3IgKHMgaW4gdCkgewogICAgICAgIHcoZSwgcywgbiwgciwgdFtzXSwgbyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBlOwogICAgfQoKICAgIGlmIChudWxsID09IHIgJiYgbnVsbCA9PSBpID8gKGkgPSBuLCByID0gbiA9IHZvaWQgMCkgOiBudWxsID09IGkgJiYgKCJzdHJpbmciID09IHR5cGVvZiBuID8gKGkgPSByLCByID0gdm9pZCAwKSA6IChpID0gciwgciA9IG4sIG4gPSB2b2lkIDApKSwgaSA9PT0gITEpIGkgPSB4O2Vsc2UgaWYgKCFpKSByZXR1cm4gZTsKICAgIHJldHVybiAxID09PSBvICYmIChhID0gaSwgaSA9IGZ1bmN0aW9uIGkoZSkgewogICAgICByZXR1cm4gcGUoKS5vZmYoZSksIGEuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sIGkuZ3VpZCA9IGEuZ3VpZCB8fCAoYS5ndWlkID0gcGUuZ3VpZCsrKSksIGUuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIHBlLmV2ZW50LmFkZCh0aGlzLCB0LCBpLCByLCBuKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gVChlLCB0KSB7CiAgICByZXR1cm4gcGUubm9kZU5hbWUoZSwgInRhYmxlIikgJiYgcGUubm9kZU5hbWUoMTEgIT09IHQubm9kZVR5cGUgPyB0IDogdC5maXJzdENoaWxkLCAidHIiKSA/IGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRib2R5IilbMF0gfHwgZS5hcHBlbmRDaGlsZChlLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGJvZHkiKSkgOiBlOwogIH0KCiAgZnVuY3Rpb24gQyhlKSB7CiAgICByZXR1cm4gZS50eXBlID0gKG51bGwgIT09IHBlLmZpbmQuYXR0cihlLCAidHlwZSIpKSArICIvIiArIGUudHlwZSwgZTsKICB9CgogIGZ1bmN0aW9uIEUoZSkgewogICAgdmFyIHQgPSBpdC5leGVjKGUudHlwZSk7CiAgICByZXR1cm4gdCA/IGUudHlwZSA9IHRbMV0gOiBlLnJlbW92ZUF0dHJpYnV0ZSgidHlwZSIpLCBlOwogIH0KCiAgZnVuY3Rpb24gTihlLCB0KSB7CiAgICBpZiAoMSA9PT0gdC5ub2RlVHlwZSAmJiBwZS5oYXNEYXRhKGUpKSB7CiAgICAgIHZhciBuLAogICAgICAgICAgciwKICAgICAgICAgIGksCiAgICAgICAgICBvID0gcGUuX2RhdGEoZSksCiAgICAgICAgICBhID0gcGUuX2RhdGEodCwgbyksCiAgICAgICAgICBzID0gby5ldmVudHM7CgogICAgICBpZiAocykgewogICAgICAgIGRlbGV0ZSBhLmhhbmRsZSwgYS5ldmVudHMgPSB7fTsKCiAgICAgICAgZm9yIChuIGluIHMpIHsKICAgICAgICAgIGZvciAociA9IDAsIGkgPSBzW25dLmxlbmd0aDsgciA8IGk7IHIrKykgewogICAgICAgICAgICBwZS5ldmVudC5hZGQodCwgbiwgc1tuXVtyXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBhLmRhdGEgJiYgKGEuZGF0YSA9IHBlLmV4dGVuZCh7fSwgYS5kYXRhKSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBrKGUsIHQpIHsKICAgIHZhciBuLCByLCBpOwoKICAgIGlmICgxID09PSB0Lm5vZGVUeXBlKSB7CiAgICAgIGlmIChuID0gdC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLCAhZmUubm9DbG9uZUV2ZW50ICYmIHRbcGUuZXhwYW5kb10pIHsKICAgICAgICBpID0gcGUuX2RhdGEodCk7CgogICAgICAgIGZvciAociBpbiBpLmV2ZW50cykgewogICAgICAgICAgcGUucmVtb3ZlRXZlbnQodCwgciwgaS5oYW5kbGUpOwogICAgICAgIH0KCiAgICAgICAgdC5yZW1vdmVBdHRyaWJ1dGUocGUuZXhwYW5kbyk7CiAgICAgIH0KCiAgICAgICJzY3JpcHQiID09PSBuICYmIHQudGV4dCAhPT0gZS50ZXh0ID8gKEModCkudGV4dCA9IGUudGV4dCwgRSh0KSkgOiAib2JqZWN0IiA9PT0gbiA/ICh0LnBhcmVudE5vZGUgJiYgKHQub3V0ZXJIVE1MID0gZS5vdXRlckhUTUwpLCBmZS5odG1sNUNsb25lICYmIGUuaW5uZXJIVE1MICYmICFwZS50cmltKHQuaW5uZXJIVE1MKSAmJiAodC5pbm5lckhUTUwgPSBlLmlubmVySFRNTCkpIDogImlucHV0IiA9PT0gbiAmJiBCZS50ZXN0KGUudHlwZSkgPyAodC5kZWZhdWx0Q2hlY2tlZCA9IHQuY2hlY2tlZCA9IGUuY2hlY2tlZCwgdC52YWx1ZSAhPT0gZS52YWx1ZSAmJiAodC52YWx1ZSA9IGUudmFsdWUpKSA6ICJvcHRpb24iID09PSBuID8gdC5kZWZhdWx0U2VsZWN0ZWQgPSB0LnNlbGVjdGVkID0gZS5kZWZhdWx0U2VsZWN0ZWQgOiAiaW5wdXQiICE9PSBuICYmICJ0ZXh0YXJlYSIgIT09IG4gfHwgKHQuZGVmYXVsdFZhbHVlID0gZS5kZWZhdWx0VmFsdWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gUyhlLCB0LCBuLCByKSB7CiAgICB0ID0gb2UuYXBwbHkoW10sIHQpOwogICAgdmFyIGksCiAgICAgICAgbywKICAgICAgICBhLAogICAgICAgIHMsCiAgICAgICAgdSwKICAgICAgICBsLAogICAgICAgIGMgPSAwLAogICAgICAgIGYgPSBlLmxlbmd0aCwKICAgICAgICBkID0gZiAtIDEsCiAgICAgICAgcCA9IHRbMF0sCiAgICAgICAgZyA9IHBlLmlzRnVuY3Rpb24ocCk7CiAgICBpZiAoZyB8fCBmID4gMSAmJiAic3RyaW5nIiA9PSB0eXBlb2YgcCAmJiAhZmUuY2hlY2tDbG9uZSAmJiBydC50ZXN0KHApKSByZXR1cm4gZS5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgIHZhciBvID0gZS5lcShpKTsKICAgICAgZyAmJiAodFswXSA9IHAuY2FsbCh0aGlzLCBpLCBvLmh0bWwoKSkpLCBTKG8sIHQsIG4sIHIpOwogICAgfSk7CgogICAgaWYgKGYgJiYgKGwgPSB5KHQsIGVbMF0ub3duZXJEb2N1bWVudCwgITEsIGUsIHIpLCBpID0gbC5maXJzdENoaWxkLCAxID09PSBsLmNoaWxkTm9kZXMubGVuZ3RoICYmIChsID0gaSksIGkgfHwgcikpIHsKICAgICAgZm9yIChzID0gcGUubWFwKGgobCwgInNjcmlwdCIpLCBDKSwgYSA9IHMubGVuZ3RoOyBjIDwgZjsgYysrKSB7CiAgICAgICAgbyA9IGwsIGMgIT09IGQgJiYgKG8gPSBwZS5jbG9uZShvLCAhMCwgITApLCBhICYmIHBlLm1lcmdlKHMsIGgobywgInNjcmlwdCIpKSksIG4uY2FsbChlW2NdLCBvLCBjKTsKICAgICAgfQoKICAgICAgaWYgKGEpIGZvciAodSA9IHNbcy5sZW5ndGggLSAxXS5vd25lckRvY3VtZW50LCBwZS5tYXAocywgRSksIGMgPSAwOyBjIDwgYTsgYysrKSB7CiAgICAgICAgbyA9IHNbY10sIEllLnRlc3Qoby50eXBlIHx8ICIiKSAmJiAhcGUuX2RhdGEobywgImdsb2JhbEV2YWwiKSAmJiBwZS5jb250YWlucyh1LCBvKSAmJiAoby5zcmMgPyBwZS5fZXZhbFVybCAmJiBwZS5fZXZhbFVybChvLnNyYykgOiBwZS5nbG9iYWxFdmFsKChvLnRleHQgfHwgby50ZXh0Q29udGVudCB8fCBvLmlubmVySFRNTCB8fCAiIikucmVwbGFjZShvdCwgIiIpKSk7CiAgICAgIH0KICAgICAgbCA9IGkgPSBudWxsOwogICAgfQoKICAgIHJldHVybiBlOwogIH0KCiAgZnVuY3Rpb24gQShlLCB0LCBuKSB7CiAgICBmb3IgKHZhciByLCBpID0gdCA/IHBlLmZpbHRlcih0LCBlKSA6IGUsIG8gPSAwOyBudWxsICE9IChyID0gaVtvXSk7IG8rKykgewogICAgICBuIHx8IDEgIT09IHIubm9kZVR5cGUgfHwgcGUuY2xlYW5EYXRhKGgocikpLCByLnBhcmVudE5vZGUgJiYgKG4gJiYgcGUuY29udGFpbnMoci5vd25lckRvY3VtZW50LCByKSAmJiBnKGgociwgInNjcmlwdCIpKSwgci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHIpKTsKICAgIH0KCiAgICByZXR1cm4gZTsKICB9CgogIGZ1bmN0aW9uIEQoZSwgdCkgewogICAgdmFyIG4gPSBwZSh0LmNyZWF0ZUVsZW1lbnQoZSkpLmFwcGVuZFRvKHQuYm9keSksCiAgICAgICAgciA9IHBlLmNzcyhuWzBdLCAiZGlzcGxheSIpOwogICAgcmV0dXJuIG4uZGV0YWNoKCksIHI7CiAgfQoKICBmdW5jdGlvbiBqKGUpIHsKICAgIHZhciB0ID0gcmUsCiAgICAgICAgbiA9IGx0W2VdOwogICAgcmV0dXJuIG4gfHwgKG4gPSBEKGUsIHQpLCAibm9uZSIgIT09IG4gJiYgbiB8fCAodXQgPSAodXQgfHwgcGUoIjxpZnJhbWUgZnJhbWVib3JkZXI9JzAnIHdpZHRoPScwJyBoZWlnaHQ9JzAnLz4iKSkuYXBwZW5kVG8odC5kb2N1bWVudEVsZW1lbnQpLCB0ID0gKHV0WzBdLmNvbnRlbnRXaW5kb3cgfHwgdXRbMF0uY29udGVudERvY3VtZW50KS5kb2N1bWVudCwgdC53cml0ZSgpLCB0LmNsb3NlKCksIG4gPSBEKGUsIHQpLCB1dC5kZXRhY2goKSksIGx0W2VdID0gbiksIG47CiAgfQoKICBmdW5jdGlvbiBMKGUsIHQpIHsKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiBlKCkgPyB2b2lkIGRlbGV0ZSB0aGlzLmdldCA6ICh0aGlzLmdldCA9IHQpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBIKGUpIHsKICAgIGlmIChlIGluIEV0KSByZXR1cm4gZTsKCiAgICBmb3IgKHZhciB0ID0gZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGUuc2xpY2UoMSksIG4gPSBDdC5sZW5ndGg7IG4tLTspIHsKICAgICAgaWYgKGUgPSBDdFtuXSArIHQsIGUgaW4gRXQpIHJldHVybiBlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcShlLCB0KSB7CiAgICBmb3IgKHZhciBuLCByLCBpLCBvID0gW10sIGEgPSAwLCBzID0gZS5sZW5ndGg7IGEgPCBzOyBhKyspIHsKICAgICAgciA9IGVbYV0sIHIuc3R5bGUgJiYgKG9bYV0gPSBwZS5fZGF0YShyLCAib2xkZGlzcGxheSIpLCBuID0gci5zdHlsZS5kaXNwbGF5LCB0ID8gKG9bYV0gfHwgIm5vbmUiICE9PSBuIHx8IChyLnN0eWxlLmRpc3BsYXkgPSAiIiksICIiID09PSByLnN0eWxlLmRpc3BsYXkgJiYgUmUocikgJiYgKG9bYV0gPSBwZS5fZGF0YShyLCAib2xkZGlzcGxheSIsIGooci5ub2RlTmFtZSkpKSkgOiAoaSA9IFJlKHIpLCAobiAmJiAibm9uZSIgIT09IG4gfHwgIWkpICYmIHBlLl9kYXRhKHIsICJvbGRkaXNwbGF5IiwgaSA/IG4gOiBwZS5jc3MociwgImRpc3BsYXkiKSkpKTsKICAgIH0KCiAgICBmb3IgKGEgPSAwOyBhIDwgczsgYSsrKSB7CiAgICAgIHIgPSBlW2FdLCByLnN0eWxlICYmICh0ICYmICJub25lIiAhPT0gci5zdHlsZS5kaXNwbGF5ICYmICIiICE9PSByLnN0eWxlLmRpc3BsYXkgfHwgKHIuc3R5bGUuZGlzcGxheSA9IHQgPyBvW2FdIHx8ICIiIDogIm5vbmUiKSk7CiAgICB9CgogICAgcmV0dXJuIGU7CiAgfQoKICBmdW5jdGlvbiBfKGUsIHQsIG4pIHsKICAgIHZhciByID0gYnQuZXhlYyh0KTsKICAgIHJldHVybiByID8gTWF0aC5tYXgoMCwgclsxXSAtIChuIHx8IDApKSArIChyWzJdIHx8ICJweCIpIDogdDsKICB9CgogIGZ1bmN0aW9uIEYoZSwgdCwgbiwgciwgaSkgewogICAgZm9yICh2YXIgbyA9IG4gPT09IChyID8gImJvcmRlciIgOiAiY29udGVudCIpID8gNCA6ICJ3aWR0aCIgPT09IHQgPyAxIDogMCwgYSA9IDA7IG8gPCA0OyBvICs9IDIpIHsKICAgICAgIm1hcmdpbiIgPT09IG4gJiYgKGEgKz0gcGUuY3NzKGUsIG4gKyBPZVtvXSwgITAsIGkpKSwgciA/ICgiY29udGVudCIgPT09IG4gJiYgKGEgLT0gcGUuY3NzKGUsICJwYWRkaW5nIiArIE9lW29dLCAhMCwgaSkpLCAibWFyZ2luIiAhPT0gbiAmJiAoYSAtPSBwZS5jc3MoZSwgImJvcmRlciIgKyBPZVtvXSArICJXaWR0aCIsICEwLCBpKSkpIDogKGEgKz0gcGUuY3NzKGUsICJwYWRkaW5nIiArIE9lW29dLCAhMCwgaSksICJwYWRkaW5nIiAhPT0gbiAmJiAoYSArPSBwZS5jc3MoZSwgImJvcmRlciIgKyBPZVtvXSArICJXaWR0aCIsICEwLCBpKSkpOwogICAgfQoKICAgIHJldHVybiBhOwogIH0KCiAgZnVuY3Rpb24gTShlLCB0LCBuKSB7CiAgICB2YXIgciA9ICEwLAogICAgICAgIGkgPSAid2lkdGgiID09PSB0ID8gZS5vZmZzZXRXaWR0aCA6IGUub2Zmc2V0SGVpZ2h0LAogICAgICAgIG8gPSBodChlKSwKICAgICAgICBhID0gZmUuYm94U2l6aW5nICYmICJib3JkZXItYm94IiA9PT0gcGUuY3NzKGUsICJib3hTaXppbmciLCAhMSwgbyk7CgogICAgaWYgKGkgPD0gMCB8fCBudWxsID09IGkpIHsKICAgICAgaWYgKGkgPSBndChlLCB0LCBvKSwgKGkgPCAwIHx8IG51bGwgPT0gaSkgJiYgKGkgPSBlLnN0eWxlW3RdKSwgZnQudGVzdChpKSkgcmV0dXJuIGk7CiAgICAgIHIgPSBhICYmIChmZS5ib3hTaXppbmdSZWxpYWJsZSgpIHx8IGkgPT09IGUuc3R5bGVbdF0pLCBpID0gcGFyc2VGbG9hdChpKSB8fCAwOwogICAgfQoKICAgIHJldHVybiBpICsgRihlLCB0LCBuIHx8IChhID8gImJvcmRlciIgOiAiY29udGVudCIpLCByLCBvKSArICJweCI7CiAgfQoKICBmdW5jdGlvbiBPKGUsIHQsIG4sIHIsIGkpIHsKICAgIHJldHVybiBuZXcgTy5wcm90b3R5cGUuaW5pdChlLCB0LCBuLCByLCBpKTsKICB9CgogIGZ1bmN0aW9uIFIoKSB7CiAgICByZXR1cm4gZS5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgTnQgPSB2b2lkIDA7CiAgICB9KSwgTnQgPSBwZS5ub3coKTsKICB9CgogIGZ1bmN0aW9uIFAoZSwgdCkgewogICAgdmFyIG4sCiAgICAgICAgciA9IHsKICAgICAgaGVpZ2h0OiBlCiAgICB9LAogICAgICAgIGkgPSAwOwoKICAgIGZvciAodCA9IHQgPyAxIDogMDsgaSA8IDQ7IGkgKz0gMiAtIHQpIHsKICAgICAgbiA9IE9lW2ldLCByWyJtYXJnaW4iICsgbl0gPSByWyJwYWRkaW5nIiArIG5dID0gZTsKICAgIH0KCiAgICByZXR1cm4gdCAmJiAoci5vcGFjaXR5ID0gci53aWR0aCA9IGUpLCByOwogIH0KCiAgZnVuY3Rpb24gQihlLCB0LCBuKSB7CiAgICBmb3IgKHZhciByLCBpID0gKCQudHdlZW5lcnNbdF0gfHwgW10pLmNvbmNhdCgkLnR3ZWVuZXJzWyIqIl0pLCBvID0gMCwgYSA9IGkubGVuZ3RoOyBvIDwgYTsgbysrKSB7CiAgICAgIGlmIChyID0gaVtvXS5jYWxsKG4sIHQsIGUpKSByZXR1cm4gcjsKICAgIH0KICB9CgogIGZ1bmN0aW9uIFcoZSwgdCwgbikgewogICAgdmFyIHIsCiAgICAgICAgaSwKICAgICAgICBvLAogICAgICAgIGEsCiAgICAgICAgcywKICAgICAgICB1LAogICAgICAgIGwsCiAgICAgICAgYywKICAgICAgICBmID0gdGhpcywKICAgICAgICBkID0ge30sCiAgICAgICAgcCA9IGUuc3R5bGUsCiAgICAgICAgaCA9IGUubm9kZVR5cGUgJiYgUmUoZSksCiAgICAgICAgZyA9IHBlLl9kYXRhKGUsICJmeHNob3ciKTsKCiAgICBuLnF1ZXVlIHx8IChzID0gcGUuX3F1ZXVlSG9va3MoZSwgImZ4IiksIG51bGwgPT0gcy51bnF1ZXVlZCAmJiAocy51bnF1ZXVlZCA9IDAsIHUgPSBzLmVtcHR5LmZpcmUsIHMuZW1wdHkuZmlyZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcy51bnF1ZXVlZCB8fCB1KCk7CiAgICB9KSwgcy51bnF1ZXVlZCsrLCBmLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgIGYuYWx3YXlzKGZ1bmN0aW9uICgpIHsKICAgICAgICBzLnVucXVldWVkLS0sIHBlLnF1ZXVlKGUsICJmeCIpLmxlbmd0aCB8fCBzLmVtcHR5LmZpcmUoKTsKICAgICAgfSk7CiAgICB9KSksIDEgPT09IGUubm9kZVR5cGUgJiYgKCJoZWlnaHQiIGluIHQgfHwgIndpZHRoIiBpbiB0KSAmJiAobi5vdmVyZmxvdyA9IFtwLm92ZXJmbG93LCBwLm92ZXJmbG93WCwgcC5vdmVyZmxvd1ldLCBsID0gcGUuY3NzKGUsICJkaXNwbGF5IiksIGMgPSAibm9uZSIgPT09IGwgPyBwZS5fZGF0YShlLCAib2xkZGlzcGxheSIpIHx8IGooZS5ub2RlTmFtZSkgOiBsLCAiaW5saW5lIiA9PT0gYyAmJiAibm9uZSIgPT09IHBlLmNzcyhlLCAiZmxvYXQiKSAmJiAoZmUuaW5saW5lQmxvY2tOZWVkc0xheW91dCAmJiAiaW5saW5lIiAhPT0gaihlLm5vZGVOYW1lKSA/IHAuem9vbSA9IDEgOiBwLmRpc3BsYXkgPSAiaW5saW5lLWJsb2NrIikpLCBuLm92ZXJmbG93ICYmIChwLm92ZXJmbG93ID0gImhpZGRlbiIsIGZlLnNocmlua1dyYXBCbG9ja3MoKSB8fCBmLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgIHAub3ZlcmZsb3cgPSBuLm92ZXJmbG93WzBdLCBwLm92ZXJmbG93WCA9IG4ub3ZlcmZsb3dbMV0sIHAub3ZlcmZsb3dZID0gbi5vdmVyZmxvd1syXTsKICAgIH0pKTsKCiAgICBmb3IgKHIgaW4gdCkgewogICAgICBpZiAoaSA9IHRbcl0sIFN0LmV4ZWMoaSkpIHsKICAgICAgICBpZiAoZGVsZXRlIHRbcl0sIG8gPSBvIHx8ICJ0b2dnbGUiID09PSBpLCBpID09PSAoaCA/ICJoaWRlIiA6ICJzaG93IikpIHsKICAgICAgICAgIGlmICgic2hvdyIgIT09IGkgfHwgIWcgfHwgdm9pZCAwID09PSBnW3JdKSBjb250aW51ZTsKICAgICAgICAgIGggPSAhMDsKICAgICAgICB9CgogICAgICAgIGRbcl0gPSBnICYmIGdbcl0gfHwgcGUuc3R5bGUoZSwgcik7CiAgICAgIH0gZWxzZSBsID0gdm9pZCAwOwogICAgfQoKICAgIGlmIChwZS5pc0VtcHR5T2JqZWN0KGQpKSAiaW5saW5lIiA9PT0gKCJub25lIiA9PT0gbCA/IGooZS5ub2RlTmFtZSkgOiBsKSAmJiAocC5kaXNwbGF5ID0gbCk7ZWxzZSB7CiAgICAgIGcgPyAiaGlkZGVuIiBpbiBnICYmIChoID0gZy5oaWRkZW4pIDogZyA9IHBlLl9kYXRhKGUsICJmeHNob3ciLCB7fSksIG8gJiYgKGcuaGlkZGVuID0gIWgpLCBoID8gcGUoZSkuc2hvdygpIDogZi5kb25lKGZ1bmN0aW9uICgpIHsKICAgICAgICBwZShlKS5oaWRlKCk7CiAgICAgIH0pLCBmLmRvbmUoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0OwoKICAgICAgICBwZS5fcmVtb3ZlRGF0YShlLCAiZnhzaG93Iik7CgogICAgICAgIGZvciAodCBpbiBkKSB7CiAgICAgICAgICBwZS5zdHlsZShlLCB0LCBkW3RdKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgZm9yIChyIGluIGQpIHsKICAgICAgICBhID0gQihoID8gZ1tyXSA6IDAsIHIsIGYpLCByIGluIGcgfHwgKGdbcl0gPSBhLnN0YXJ0LCBoICYmIChhLmVuZCA9IGEuc3RhcnQsIGEuc3RhcnQgPSAid2lkdGgiID09PSByIHx8ICJoZWlnaHQiID09PSByID8gMSA6IDApKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gSShlLCB0KSB7CiAgICB2YXIgbiwgciwgaSwgbywgYTsKCiAgICBmb3IgKG4gaW4gZSkgewogICAgICBpZiAociA9IHBlLmNhbWVsQ2FzZShuKSwgaSA9IHRbcl0sIG8gPSBlW25dLCBwZS5pc0FycmF5KG8pICYmIChpID0gb1sxXSwgbyA9IGVbbl0gPSBvWzBdKSwgbiAhPT0gciAmJiAoZVtyXSA9IG8sIGRlbGV0ZSBlW25dKSwgYSA9IHBlLmNzc0hvb2tzW3JdLCBhICYmICJleHBhbmQiIGluIGEpIHsKICAgICAgICBvID0gYS5leHBhbmQobyksIGRlbGV0ZSBlW3JdOwoKICAgICAgICBmb3IgKG4gaW4gbykgewogICAgICAgICAgbiBpbiBlIHx8IChlW25dID0gb1tuXSwgdFtuXSA9IGkpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHRbcl0gPSBpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gJChlLCB0LCBuKSB7CiAgICB2YXIgciwKICAgICAgICBpLAogICAgICAgIG8gPSAwLAogICAgICAgIGEgPSAkLnByZWZpbHRlcnMubGVuZ3RoLAogICAgICAgIHMgPSBwZS5EZWZlcnJlZCgpLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgIGRlbGV0ZSB1LmVsZW07CiAgICB9KSwKICAgICAgICB1ID0gZnVuY3Rpb24gdSgpIHsKICAgICAgaWYgKGkpIHJldHVybiAhMTsKCiAgICAgIGZvciAodmFyIHQgPSBOdCB8fCBSKCksIG4gPSBNYXRoLm1heCgwLCBsLnN0YXJ0VGltZSArIGwuZHVyYXRpb24gLSB0KSwgciA9IG4gLyBsLmR1cmF0aW9uIHx8IDAsIG8gPSAxIC0gciwgYSA9IDAsIHUgPSBsLnR3ZWVucy5sZW5ndGg7IGEgPCB1OyBhKyspIHsKICAgICAgICBsLnR3ZWVuc1thXS5ydW4obyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBzLm5vdGlmeVdpdGgoZSwgW2wsIG8sIG5dKSwgbyA8IDEgJiYgdSA/IG4gOiAocy5yZXNvbHZlV2l0aChlLCBbbF0pLCAhMSk7CiAgICB9LAogICAgICAgIGwgPSBzLnByb21pc2UoewogICAgICBlbGVtOiBlLAogICAgICBwcm9wczogcGUuZXh0ZW5kKHt9LCB0KSwKICAgICAgb3B0czogcGUuZXh0ZW5kKCEwLCB7CiAgICAgICAgc3BlY2lhbEVhc2luZzoge30sCiAgICAgICAgZWFzaW5nOiBwZS5lYXNpbmcuX2RlZmF1bHQKICAgICAgfSwgbiksCiAgICAgIG9yaWdpbmFsUHJvcGVydGllczogdCwKICAgICAgb3JpZ2luYWxPcHRpb25zOiBuLAogICAgICBzdGFydFRpbWU6IE50IHx8IFIoKSwKICAgICAgZHVyYXRpb246IG4uZHVyYXRpb24sCiAgICAgIHR3ZWVuczogW10sCiAgICAgIGNyZWF0ZVR3ZWVuOiBmdW5jdGlvbiBjcmVhdGVUd2Vlbih0LCBuKSB7CiAgICAgICAgdmFyIHIgPSBwZS5Ud2VlbihlLCBsLm9wdHMsIHQsIG4sIGwub3B0cy5zcGVjaWFsRWFzaW5nW3RdIHx8IGwub3B0cy5lYXNpbmcpOwogICAgICAgIHJldHVybiBsLnR3ZWVucy5wdXNoKHIpLCByOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbiBzdG9wKHQpIHsKICAgICAgICB2YXIgbiA9IDAsCiAgICAgICAgICAgIHIgPSB0ID8gbC50d2VlbnMubGVuZ3RoIDogMDsKICAgICAgICBpZiAoaSkgcmV0dXJuIHRoaXM7CgogICAgICAgIGZvciAoaSA9ICEwOyBuIDwgcjsgbisrKSB7CiAgICAgICAgICBsLnR3ZWVuc1tuXS5ydW4oMSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdCA/IChzLm5vdGlmeVdpdGgoZSwgW2wsIDEsIDBdKSwgcy5yZXNvbHZlV2l0aChlLCBbbCwgdF0pKSA6IHMucmVqZWN0V2l0aChlLCBbbCwgdF0pLCB0aGlzOwogICAgICB9CiAgICB9KSwKICAgICAgICBjID0gbC5wcm9wczsKCiAgICBmb3IgKEkoYywgbC5vcHRzLnNwZWNpYWxFYXNpbmcpOyBvIDwgYTsgbysrKSB7CiAgICAgIGlmIChyID0gJC5wcmVmaWx0ZXJzW29dLmNhbGwobCwgZSwgYywgbC5vcHRzKSkgcmV0dXJuIHBlLmlzRnVuY3Rpb24oci5zdG9wKSAmJiAocGUuX3F1ZXVlSG9va3MobC5lbGVtLCBsLm9wdHMucXVldWUpLnN0b3AgPSBwZS5wcm94eShyLnN0b3AsIHIpKSwgcjsKICAgIH0KCiAgICByZXR1cm4gcGUubWFwKGMsIEIsIGwpLCBwZS5pc0Z1bmN0aW9uKGwub3B0cy5zdGFydCkgJiYgbC5vcHRzLnN0YXJ0LmNhbGwoZSwgbCksIHBlLmZ4LnRpbWVyKHBlLmV4dGVuZCh1LCB7CiAgICAgIGVsZW06IGUsCiAgICAgIGFuaW06IGwsCiAgICAgIHF1ZXVlOiBsLm9wdHMucXVldWUKICAgIH0pKSwgbC5wcm9ncmVzcyhsLm9wdHMucHJvZ3Jlc3MpLmRvbmUobC5vcHRzLmRvbmUsIGwub3B0cy5jb21wbGV0ZSkuZmFpbChsLm9wdHMuZmFpbCkuYWx3YXlzKGwub3B0cy5hbHdheXMpOwogIH0KCiAgZnVuY3Rpb24geihlKSB7CiAgICByZXR1cm4gcGUuYXR0cihlLCAiY2xhc3MiKSB8fCAiIjsKICB9CgogIGZ1bmN0aW9uIFgoZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uICh0LCBuKSB7CiAgICAgICJzdHJpbmciICE9IHR5cGVvZiB0ICYmIChuID0gdCwgdCA9ICIqIik7CiAgICAgIHZhciByLAogICAgICAgICAgaSA9IDAsCiAgICAgICAgICBvID0gdC50b0xvd2VyQ2FzZSgpLm1hdGNoKERlKSB8fCBbXTsKICAgICAgaWYgKHBlLmlzRnVuY3Rpb24obikpIGZvciAoOyByID0gb1tpKytdOykgewogICAgICAgICIrIiA9PT0gci5jaGFyQXQoMCkgPyAociA9IHIuc2xpY2UoMSkgfHwgIioiLCAoZVtyXSA9IGVbcl0gfHwgW10pLnVuc2hpZnQobikpIDogKGVbcl0gPSBlW3JdIHx8IFtdKS5wdXNoKG4pOwogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gVShlLCB0LCBuLCByKSB7CiAgICBmdW5jdGlvbiBpKHMpIHsKICAgICAgdmFyIHU7CiAgICAgIHJldHVybiBvW3NdID0gITAsIHBlLmVhY2goZVtzXSB8fCBbXSwgZnVuY3Rpb24gKGUsIHMpIHsKICAgICAgICB2YXIgbCA9IHModCwgbiwgcik7CiAgICAgICAgcmV0dXJuICJzdHJpbmciICE9IHR5cGVvZiBsIHx8IGEgfHwgb1tsXSA/IGEgPyAhKHUgPSBsKSA6IHZvaWQgMCA6ICh0LmRhdGFUeXBlcy51bnNoaWZ0KGwpLCBpKGwpLCAhMSk7CiAgICAgIH0pLCB1OwogICAgfQoKICAgIHZhciBvID0ge30sCiAgICAgICAgYSA9IGUgPT09IFF0OwogICAgcmV0dXJuIGkodC5kYXRhVHlwZXNbMF0pIHx8ICFvWyIqIl0gJiYgaSgiKiIpOwogIH0KCiAgZnVuY3Rpb24gVihlLCB0KSB7CiAgICB2YXIgbiwKICAgICAgICByLAogICAgICAgIGkgPSBwZS5hamF4U2V0dGluZ3MuZmxhdE9wdGlvbnMgfHwge307CgogICAgZm9yIChyIGluIHQpIHsKICAgICAgdm9pZCAwICE9PSB0W3JdICYmICgoaVtyXSA/IGUgOiBuIHx8IChuID0ge30pKVtyXSA9IHRbcl0pOwogICAgfQoKICAgIHJldHVybiBuICYmIHBlLmV4dGVuZCghMCwgZSwgbiksIGU7CiAgfQoKICBmdW5jdGlvbiBZKGUsIHQsIG4pIHsKICAgIGZvciAodmFyIHIsIGksIG8sIGEsIHMgPSBlLmNvbnRlbnRzLCB1ID0gZS5kYXRhVHlwZXM7ICIqIiA9PT0gdVswXTspIHsKICAgICAgdS5zaGlmdCgpLCB2b2lkIDAgPT09IGkgJiYgKGkgPSBlLm1pbWVUeXBlIHx8IHQuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtVHlwZSIpKTsKICAgIH0KCiAgICBpZiAoaSkgZm9yIChhIGluIHMpIHsKICAgICAgaWYgKHNbYV0gJiYgc1thXS50ZXN0KGkpKSB7CiAgICAgICAgdS51bnNoaWZ0KGEpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBpZiAodVswXSBpbiBuKSBvID0gdVswXTtlbHNlIHsKICAgICAgZm9yIChhIGluIG4pIHsKICAgICAgICBpZiAoIXVbMF0gfHwgZS5jb252ZXJ0ZXJzW2EgKyAiICIgKyB1WzBdXSkgewogICAgICAgICAgbyA9IGE7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIHIgfHwgKHIgPSBhKTsKICAgICAgfQoKICAgICAgbyA9IG8gfHwgcjsKICAgIH0KICAgIGlmIChvKSByZXR1cm4gbyAhPT0gdVswXSAmJiB1LnVuc2hpZnQobyksIG5bb107CiAgfQoKICBmdW5jdGlvbiBKKGUsIHQsIG4sIHIpIHsKICAgIHZhciBpLAogICAgICAgIG8sCiAgICAgICAgYSwKICAgICAgICBzLAogICAgICAgIHUsCiAgICAgICAgbCA9IHt9LAogICAgICAgIGMgPSBlLmRhdGFUeXBlcy5zbGljZSgpOwogICAgaWYgKGNbMV0pIGZvciAoYSBpbiBlLmNvbnZlcnRlcnMpIHsKICAgICAgbFthLnRvTG93ZXJDYXNlKCldID0gZS5jb252ZXJ0ZXJzW2FdOwogICAgfQoKICAgIGZvciAobyA9IGMuc2hpZnQoKTsgbzspIHsKICAgICAgaWYgKGUucmVzcG9uc2VGaWVsZHNbb10gJiYgKG5bZS5yZXNwb25zZUZpZWxkc1tvXV0gPSB0KSwgIXUgJiYgciAmJiBlLmRhdGFGaWx0ZXIgJiYgKHQgPSBlLmRhdGFGaWx0ZXIodCwgZS5kYXRhVHlwZSkpLCB1ID0gbywgbyA9IGMuc2hpZnQoKSkgaWYgKCIqIiA9PT0gbykgbyA9IHU7ZWxzZSBpZiAoIioiICE9PSB1ICYmIHUgIT09IG8pIHsKICAgICAgICBpZiAoYSA9IGxbdSArICIgIiArIG9dIHx8IGxbIiogIiArIG9dLCAhYSkgZm9yIChpIGluIGwpIHsKICAgICAgICAgIGlmIChzID0gaS5zcGxpdCgiICIpLCBzWzFdID09PSBvICYmIChhID0gbFt1ICsgIiAiICsgc1swXV0gfHwgbFsiKiAiICsgc1swXV0pKSB7CiAgICAgICAgICAgIGEgPT09ICEwID8gYSA9IGxbaV0gOiBsW2ldICE9PSAhMCAmJiAobyA9IHNbMF0sIGMudW5zaGlmdChzWzFdKSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoYSAhPT0gITApIGlmIChhICYmIGVbInRocm93cyJdKSB0ID0gYSh0KTtlbHNlIHRyeSB7CiAgICAgICAgICB0ID0gYSh0KTsKICAgICAgICB9IGNhdGNoIChmKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzdGF0ZTogInBhcnNlcmVycm9yIiwKICAgICAgICAgICAgZXJyb3I6IGEgPyBmIDogIk5vIGNvbnZlcnNpb24gZnJvbSAiICsgdSArICIgdG8gIiArIG8KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgc3RhdGU6ICJzdWNjZXNzIiwKICAgICAgZGF0YTogdAogICAgfTsKICB9CgogIGZ1bmN0aW9uIEcoZSkgewogICAgcmV0dXJuIGUuc3R5bGUgJiYgZS5zdHlsZS5kaXNwbGF5IHx8IHBlLmNzcyhlLCAiZGlzcGxheSIpOwogIH0KCiAgZnVuY3Rpb24gSyhlKSB7CiAgICBpZiAoIXBlLmNvbnRhaW5zKGUub3duZXJEb2N1bWVudCB8fCByZSwgZSkpIHJldHVybiAhMDsKCiAgICBmb3IgKDsgZSAmJiAxID09PSBlLm5vZGVUeXBlOykgewogICAgICBpZiAoIm5vbmUiID09PSBHKGUpIHx8ICJoaWRkZW4iID09PSBlLnR5cGUpIHJldHVybiAhMDsKICAgICAgZSA9IGUucGFyZW50Tm9kZTsKICAgIH0KCiAgICByZXR1cm4gITE7CiAgfQoKICBmdW5jdGlvbiBRKGUsIHQsIG4sIHIpIHsKICAgIHZhciBpOwogICAgaWYgKHBlLmlzQXJyYXkodCkpIHBlLmVhY2godCwgZnVuY3Rpb24gKHQsIGkpIHsKICAgICAgbiB8fCBybi50ZXN0KGUpID8gcihlLCBpKSA6IFEoZSArICJbIiArICgib2JqZWN0IiA9PSBfdHlwZW9mKGkpICYmIG51bGwgIT0gaSA/IHQgOiAiIikgKyAiXSIsIGksIG4sIHIpOwogICAgfSk7ZWxzZSBpZiAobiB8fCAib2JqZWN0IiAhPT0gcGUudHlwZSh0KSkgcihlLCB0KTtlbHNlIGZvciAoaSBpbiB0KSB7CiAgICAgIFEoZSArICJbIiArIGkgKyAiXSIsIHRbaV0sIG4sIHIpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gWigpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBuZXcgZS5YTUxIdHRwUmVxdWVzdCgpOwogICAgfSBjYXRjaCAodCkge30KICB9CgogIGZ1bmN0aW9uIGVlKCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIG5ldyBlLkFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgICB9IGNhdGNoICh0KSB7fQogIH0KCiAgZnVuY3Rpb24gdGUoZSkgewogICAgcmV0dXJuIHBlLmlzV2luZG93KGUpID8gZSA6IDkgPT09IGUubm9kZVR5cGUgJiYgKGUuZGVmYXVsdFZpZXcgfHwgZS5wYXJlbnRXaW5kb3cpOwogIH0KCiAgdmFyIG5lID0gW10sCiAgICAgIHJlID0gZS5kb2N1bWVudCwKICAgICAgaWUgPSBuZS5zbGljZSwKICAgICAgb2UgPSBuZS5jb25jYXQsCiAgICAgIGFlID0gbmUucHVzaCwKICAgICAgc2UgPSBuZS5pbmRleE9mLAogICAgICB1ZSA9IHt9LAogICAgICBsZSA9IHVlLnRvU3RyaW5nLAogICAgICBjZSA9IHVlLmhhc093blByb3BlcnR5LAogICAgICBmZSA9IHt9LAogICAgICBkZSA9ICIxLjEyLjQiLAogICAgICBwZSA9IGZ1bmN0aW9uIHBlKGUsIHQpIHsKICAgIHJldHVybiBuZXcgcGUuZm4uaW5pdChlLCB0KTsKICB9LAogICAgICBoZSA9IC9eW1xzXHVGRUZGXHhBMF0rfFtcc1x1RkVGRlx4QTBdKyQvZywKICAgICAgZ2UgPSAvXi1tcy0vLAogICAgICBtZSA9IC8tKFtcZGEtel0pL2dpLAogICAgICB5ZSA9IGZ1bmN0aW9uIHllKGUsIHQpIHsKICAgIHJldHVybiB0LnRvVXBwZXJDYXNlKCk7CiAgfTsKCiAgcGUuZm4gPSBwZS5wcm90b3R5cGUgPSB7CiAgICBqcXVlcnk6IGRlLAogICAgY29uc3RydWN0b3I6IHBlLAogICAgc2VsZWN0b3I6ICIiLAogICAgbGVuZ3RoOiAwLAogICAgdG9BcnJheTogZnVuY3Rpb24gdG9BcnJheSgpIHsKICAgICAgcmV0dXJuIGllLmNhbGwodGhpcyk7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoZSkgewogICAgICByZXR1cm4gbnVsbCAhPSBlID8gZSA8IDAgPyB0aGlzW2UgKyB0aGlzLmxlbmd0aF0gOiB0aGlzW2VdIDogaWUuY2FsbCh0aGlzKTsKICAgIH0sCiAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uIHB1c2hTdGFjayhlKSB7CiAgICAgIHZhciB0ID0gcGUubWVyZ2UodGhpcy5jb25zdHJ1Y3RvcigpLCBlKTsKICAgICAgcmV0dXJuIHQucHJldk9iamVjdCA9IHRoaXMsIHQuY29udGV4dCA9IHRoaXMuY29udGV4dCwgdDsKICAgIH0sCiAgICBlYWNoOiBmdW5jdGlvbiBlYWNoKGUpIHsKICAgICAgcmV0dXJuIHBlLmVhY2godGhpcywgZSk7CiAgICB9LAogICAgbWFwOiBmdW5jdGlvbiBtYXAoZSkgewogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2socGUubWFwKHRoaXMsIGZ1bmN0aW9uICh0LCBuKSB7CiAgICAgICAgcmV0dXJuIGUuY2FsbCh0LCBuLCB0KTsKICAgICAgfSkpOwogICAgfSwKICAgIHNsaWNlOiBmdW5jdGlvbiBzbGljZSgpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGllLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfSwKICAgIGZpcnN0OiBmdW5jdGlvbiBmaXJzdCgpIHsKICAgICAgcmV0dXJuIHRoaXMuZXEoMCk7CiAgICB9LAogICAgbGFzdDogZnVuY3Rpb24gbGFzdCgpIHsKICAgICAgcmV0dXJuIHRoaXMuZXEoLTEpOwogICAgfSwKICAgIGVxOiBmdW5jdGlvbiBlcShlKSB7CiAgICAgIHZhciB0ID0gdGhpcy5sZW5ndGgsCiAgICAgICAgICBuID0gK2UgKyAoZSA8IDAgPyB0IDogMCk7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhuID49IDAgJiYgbiA8IHQgPyBbdGhpc1tuXV0gOiBbXSk7CiAgICB9LAogICAgZW5kOiBmdW5jdGlvbiBlbmQoKSB7CiAgICAgIHJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcigpOwogICAgfSwKICAgIHB1c2g6IGFlLAogICAgc29ydDogbmUuc29ydCwKICAgIHNwbGljZTogbmUuc3BsaWNlCiAgfSwgcGUuZXh0ZW5kID0gcGUuZm4uZXh0ZW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUsCiAgICAgICAgdCwKICAgICAgICBuLAogICAgICAgIHIsCiAgICAgICAgaSwKICAgICAgICBvLAogICAgICAgIGEgPSBhcmd1bWVudHNbMF0gfHwge30sCiAgICAgICAgcyA9IDEsCiAgICAgICAgdSA9IGFyZ3VtZW50cy5sZW5ndGgsCiAgICAgICAgbCA9ICExOwoKICAgIGZvciAoImJvb2xlYW4iID09IHR5cGVvZiBhICYmIChsID0gYSwgYSA9IGFyZ3VtZW50c1tzXSB8fCB7fSwgcysrKSwgIm9iamVjdCIgPT0gX3R5cGVvZihhKSB8fCBwZS5pc0Z1bmN0aW9uKGEpIHx8IChhID0ge30pLCBzID09PSB1ICYmIChhID0gdGhpcywgcy0tKTsgcyA8IHU7IHMrKykgewogICAgICBpZiAobnVsbCAhPSAoaSA9IGFyZ3VtZW50c1tzXSkpIGZvciAociBpbiBpKSB7CiAgICAgICAgZSA9IGFbcl0sIG4gPSBpW3JdLCBhICE9PSBuICYmIChsICYmIG4gJiYgKHBlLmlzUGxhaW5PYmplY3QobikgfHwgKHQgPSBwZS5pc0FycmF5KG4pKSkgPyAodCA/ICh0ID0gITEsIG8gPSBlICYmIHBlLmlzQXJyYXkoZSkgPyBlIDogW10pIDogbyA9IGUgJiYgcGUuaXNQbGFpbk9iamVjdChlKSA/IGUgOiB7fSwgYVtyXSA9IHBlLmV4dGVuZChsLCBvLCBuKSkgOiB2b2lkIDAgIT09IG4gJiYgKGFbcl0gPSBuKSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYTsKICB9LCBwZS5leHRlbmQoewogICAgZXhwYW5kbzogImpRdWVyeSIgKyAoZGUgKyBNYXRoLnJhbmRvbSgpKS5yZXBsYWNlKC9cRC9nLCAiIiksCiAgICBpc1JlYWR5OiAhMCwKICAgIGVycm9yOiBmdW5jdGlvbiBlcnJvcihlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihlKTsKICAgIH0sCiAgICBub29wOiBmdW5jdGlvbiBub29wKCkge30sCiAgICBpc0Z1bmN0aW9uOiBmdW5jdGlvbiBpc0Z1bmN0aW9uKGUpIHsKICAgICAgcmV0dXJuICJmdW5jdGlvbiIgPT09IHBlLnR5cGUoZSk7CiAgICB9LAogICAgaXNBcnJheTogQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoZSkgewogICAgICByZXR1cm4gImFycmF5IiA9PT0gcGUudHlwZShlKTsKICAgIH0sCiAgICBpc1dpbmRvdzogZnVuY3Rpb24gaXNXaW5kb3coZSkgewogICAgICByZXR1cm4gbnVsbCAhPSBlICYmIGUgPT0gZS53aW5kb3c7CiAgICB9LAogICAgaXNOdW1lcmljOiBmdW5jdGlvbiBpc051bWVyaWMoZSkgewogICAgICB2YXIgdCA9IGUgJiYgZS50b1N0cmluZygpOwogICAgICByZXR1cm4gIXBlLmlzQXJyYXkoZSkgJiYgdCAtIHBhcnNlRmxvYXQodCkgKyAxID49IDA7CiAgICB9LAogICAgaXNFbXB0eU9iamVjdDogZnVuY3Rpb24gaXNFbXB0eU9iamVjdChlKSB7CiAgICAgIHZhciB0OwoKICAgICAgZm9yICh0IGluIGUpIHsKICAgICAgICByZXR1cm4gITE7CiAgICAgIH0KCiAgICAgIHJldHVybiAhMDsKICAgIH0sCiAgICBpc1BsYWluT2JqZWN0OiBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KGUpIHsKICAgICAgdmFyIHQ7CiAgICAgIGlmICghZSB8fCAib2JqZWN0IiAhPT0gcGUudHlwZShlKSB8fCBlLm5vZGVUeXBlIHx8IHBlLmlzV2luZG93KGUpKSByZXR1cm4gITE7CgogICAgICB0cnkgewogICAgICAgIGlmIChlLmNvbnN0cnVjdG9yICYmICFjZS5jYWxsKGUsICJjb25zdHJ1Y3RvciIpICYmICFjZS5jYWxsKGUuY29uc3RydWN0b3IucHJvdG90eXBlLCAiaXNQcm90b3R5cGVPZiIpKSByZXR1cm4gITE7CiAgICAgIH0gY2F0Y2ggKG4pIHsKICAgICAgICByZXR1cm4gITE7CiAgICAgIH0KCiAgICAgIGlmICghZmUub3duRmlyc3QpIGZvciAodCBpbiBlKSB7CiAgICAgICAgcmV0dXJuIGNlLmNhbGwoZSwgdCk7CiAgICAgIH0KCiAgICAgIGZvciAodCBpbiBlKSB7CiAgICAgICAgOwogICAgICB9CgogICAgICByZXR1cm4gdm9pZCAwID09PSB0IHx8IGNlLmNhbGwoZSwgdCk7CiAgICB9LAogICAgdHlwZTogZnVuY3Rpb24gdHlwZShlKSB7CiAgICAgIHJldHVybiBudWxsID09IGUgPyBlICsgIiIgOiAib2JqZWN0IiA9PSBfdHlwZW9mKGUpIHx8ICJmdW5jdGlvbiIgPT0gdHlwZW9mIGUgPyB1ZVtsZS5jYWxsKGUpXSB8fCAib2JqZWN0IiA6IF90eXBlb2YoZSk7CiAgICB9LAogICAgZ2xvYmFsRXZhbDogZnVuY3Rpb24gZ2xvYmFsRXZhbCh0KSB7CiAgICAgIHQgJiYgcGUudHJpbSh0KSAmJiAoZS5leGVjU2NyaXB0IHx8IGZ1bmN0aW9uICh0KSB7CiAgICAgICAgZS5ldmFsLmNhbGwoZSwgdCk7CiAgICAgIH0pKHQpOwogICAgfSwKICAgIGNhbWVsQ2FzZTogZnVuY3Rpb24gY2FtZWxDYXNlKGUpIHsKICAgICAgcmV0dXJuIGUucmVwbGFjZShnZSwgIm1zLSIpLnJlcGxhY2UobWUsIHllKTsKICAgIH0sCiAgICBub2RlTmFtZTogZnVuY3Rpb24gbm9kZU5hbWUoZSwgdCkgewogICAgICByZXR1cm4gZS5ub2RlTmFtZSAmJiBlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IHQudG9Mb3dlckNhc2UoKTsKICAgIH0sCiAgICBlYWNoOiBmdW5jdGlvbiBlYWNoKGUsIHQpIHsKICAgICAgdmFyIHIsCiAgICAgICAgICBpID0gMDsKICAgICAgaWYgKG4oZSkpIGZvciAociA9IGUubGVuZ3RoOyBpIDwgciAmJiB0LmNhbGwoZVtpXSwgaSwgZVtpXSkgIT09ICExOyBpKyspIHsKICAgICAgICA7CiAgICAgIH0gZWxzZSBmb3IgKGkgaW4gZSkgewogICAgICAgIGlmICh0LmNhbGwoZVtpXSwgaSwgZVtpXSkgPT09ICExKSBicmVhazsKICAgICAgfQogICAgICByZXR1cm4gZTsKICAgIH0sCiAgICB0cmltOiBmdW5jdGlvbiB0cmltKGUpIHsKICAgICAgcmV0dXJuIG51bGwgPT0gZSA/ICIiIDogKGUgKyAiIikucmVwbGFjZShoZSwgIiIpOwogICAgfSwKICAgIG1ha2VBcnJheTogZnVuY3Rpb24gbWFrZUFycmF5KGUsIHQpIHsKICAgICAgdmFyIHIgPSB0IHx8IFtdOwogICAgICByZXR1cm4gbnVsbCAhPSBlICYmIChuKE9iamVjdChlKSkgPyBwZS5tZXJnZShyLCAic3RyaW5nIiA9PSB0eXBlb2YgZSA/IFtlXSA6IGUpIDogYWUuY2FsbChyLCBlKSksIHI7CiAgICB9LAogICAgaW5BcnJheTogZnVuY3Rpb24gaW5BcnJheShlLCB0LCBuKSB7CiAgICAgIHZhciByOwoKICAgICAgaWYgKHQpIHsKICAgICAgICBpZiAoc2UpIHJldHVybiBzZS5jYWxsKHQsIGUsIG4pOwoKICAgICAgICBmb3IgKHIgPSB0Lmxlbmd0aCwgbiA9IG4gPyBuIDwgMCA/IE1hdGgubWF4KDAsIHIgKyBuKSA6IG4gOiAwOyBuIDwgcjsgbisrKSB7CiAgICAgICAgICBpZiAobiBpbiB0ICYmIHRbbl0gPT09IGUpIHJldHVybiBuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIC0xOwogICAgfSwKICAgIG1lcmdlOiBmdW5jdGlvbiBtZXJnZShlLCB0KSB7CiAgICAgIGZvciAodmFyIG4gPSArdC5sZW5ndGgsIHIgPSAwLCBpID0gZS5sZW5ndGg7IHIgPCBuOykgewogICAgICAgIGVbaSsrXSA9IHRbcisrXTsKICAgICAgfQoKICAgICAgaWYgKG4gIT09IG4pIGZvciAoOyB2b2lkIDAgIT09IHRbcl07KSB7CiAgICAgICAgZVtpKytdID0gdFtyKytdOwogICAgICB9CiAgICAgIHJldHVybiBlLmxlbmd0aCA9IGksIGU7CiAgICB9LAogICAgZ3JlcDogZnVuY3Rpb24gZ3JlcChlLCB0LCBuKSB7CiAgICAgIGZvciAodmFyIHIsIGkgPSBbXSwgbyA9IDAsIGEgPSBlLmxlbmd0aCwgcyA9ICFuOyBvIDwgYTsgbysrKSB7CiAgICAgICAgciA9ICF0KGVbb10sIG8pLCByICE9PSBzICYmIGkucHVzaChlW29dKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGk7CiAgICB9LAogICAgbWFwOiBmdW5jdGlvbiBtYXAoZSwgdCwgcikgewogICAgICB2YXIgaSwKICAgICAgICAgIG8sCiAgICAgICAgICBhID0gMCwKICAgICAgICAgIHMgPSBbXTsKICAgICAgaWYgKG4oZSkpIGZvciAoaSA9IGUubGVuZ3RoOyBhIDwgaTsgYSsrKSB7CiAgICAgICAgbyA9IHQoZVthXSwgYSwgciksIG51bGwgIT0gbyAmJiBzLnB1c2gobyk7CiAgICAgIH0gZWxzZSBmb3IgKGEgaW4gZSkgewogICAgICAgIG8gPSB0KGVbYV0sIGEsIHIpLCBudWxsICE9IG8gJiYgcy5wdXNoKG8pOwogICAgICB9CiAgICAgIHJldHVybiBvZS5hcHBseShbXSwgcyk7CiAgICB9LAogICAgZ3VpZDogMSwKICAgIHByb3h5OiBmdW5jdGlvbiBwcm94eShlLCB0KSB7CiAgICAgIHZhciBuLCByLCBpOwogICAgICBpZiAoInN0cmluZyIgPT0gdHlwZW9mIHQgJiYgKGkgPSBlW3RdLCB0ID0gZSwgZSA9IGkpLCBwZS5pc0Z1bmN0aW9uKGUpKSByZXR1cm4gbiA9IGllLmNhbGwoYXJndW1lbnRzLCAyKSwgciA9IGZ1bmN0aW9uIHIoKSB7CiAgICAgICAgcmV0dXJuIGUuYXBwbHkodCB8fCB0aGlzLCBuLmNvbmNhdChpZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgfSwgci5ndWlkID0gZS5ndWlkID0gZS5ndWlkIHx8IHBlLmd1aWQrKywgcjsKICAgIH0sCiAgICBub3c6IGZ1bmN0aW9uIG5vdygpIHsKICAgICAgcmV0dXJuICtuZXcgRGF0ZSgpOwogICAgfSwKICAgIHN1cHBvcnQ6IGZlCiAgfSksICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiAocGUuZm5bU3ltYm9sLml0ZXJhdG9yXSA9IG5lW1N5bWJvbC5pdGVyYXRvcl0pLCBwZS5lYWNoKCJCb29sZWFuIE51bWJlciBTdHJpbmcgRnVuY3Rpb24gQXJyYXkgRGF0ZSBSZWdFeHAgT2JqZWN0IEVycm9yIFN5bWJvbCIuc3BsaXQoIiAiKSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgIHVlWyJbb2JqZWN0ICIgKyB0ICsgIl0iXSA9IHQudG9Mb3dlckNhc2UoKTsKICB9KTsKCiAgdmFyIHZlID0gZnVuY3Rpb24gKGUpIHsKICAgIGZ1bmN0aW9uIHQoZSwgdCwgbiwgcikgewogICAgICB2YXIgaSwKICAgICAgICAgIG8sCiAgICAgICAgICBhLAogICAgICAgICAgcywKICAgICAgICAgIHUsCiAgICAgICAgICBsLAogICAgICAgICAgZiwKICAgICAgICAgIHAsCiAgICAgICAgICBoID0gdCAmJiB0Lm93bmVyRG9jdW1lbnQsCiAgICAgICAgICBnID0gdCA/IHQubm9kZVR5cGUgOiA5OwogICAgICBpZiAobiA9IG4gfHwgW10sICJzdHJpbmciICE9IHR5cGVvZiBlIHx8ICFlIHx8IDEgIT09IGcgJiYgOSAhPT0gZyAmJiAxMSAhPT0gZykgcmV0dXJuIG47CgogICAgICBpZiAoIXIgJiYgKCh0ID8gdC5vd25lckRvY3VtZW50IHx8IHQgOiBCKSAhPT0gSCAmJiBMKHQpLCB0ID0gdCB8fCBILCBfKSkgewogICAgICAgIGlmICgxMSAhPT0gZyAmJiAobCA9IHllLmV4ZWMoZSkpKSBpZiAoaSA9IGxbMV0pIHsKICAgICAgICAgIGlmICg5ID09PSBnKSB7CiAgICAgICAgICAgIGlmICghKGEgPSB0LmdldEVsZW1lbnRCeUlkKGkpKSkgcmV0dXJuIG47CiAgICAgICAgICAgIGlmIChhLmlkID09PSBpKSByZXR1cm4gbi5wdXNoKGEpLCBuOwogICAgICAgICAgfSBlbHNlIGlmIChoICYmIChhID0gaC5nZXRFbGVtZW50QnlJZChpKSkgJiYgUih0LCBhKSAmJiBhLmlkID09PSBpKSByZXR1cm4gbi5wdXNoKGEpLCBuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAobFsyXSkgcmV0dXJuIFEuYXBwbHkobiwgdC5nZXRFbGVtZW50c0J5VGFnTmFtZShlKSksIG47CiAgICAgICAgICBpZiAoKGkgPSBsWzNdKSAmJiB3LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgdC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKSByZXR1cm4gUS5hcHBseShuLCB0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoaSkpLCBuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHcucXNhICYmICFYW2UgKyAiICJdICYmICghRiB8fCAhRi50ZXN0KGUpKSkgewogICAgICAgICAgaWYgKDEgIT09IGcpIGggPSB0LCBwID0gZTtlbHNlIGlmICgib2JqZWN0IiAhPT0gdC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgIGZvciAoKHMgPSB0LmdldEF0dHJpYnV0ZSgiaWQiKSkgPyBzID0gcy5yZXBsYWNlKHhlLCAiXFwkJiIpIDogdC5zZXRBdHRyaWJ1dGUoImlkIiwgcyA9IFApLCBmID0gTihlKSwgbyA9IGYubGVuZ3RoLCB1ID0gZGUudGVzdChzKSA/ICIjIiArIHMgOiAiW2lkPSciICsgcyArICInXSI7IG8tLTspIHsKICAgICAgICAgICAgICBmW29dID0gdSArICIgIiArIGQoZltvXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHAgPSBmLmpvaW4oIiwiKSwgaCA9IHZlLnRlc3QoZSkgJiYgYyh0LnBhcmVudE5vZGUpIHx8IHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocCkgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIFEuYXBwbHkobiwgaC5xdWVyeVNlbGVjdG9yQWxsKHApKSwgbjsKICAgICAgICAgIH0gY2F0Y2ggKG0pIHt9IGZpbmFsbHkgewogICAgICAgICAgICBzID09PSBQICYmIHQucmVtb3ZlQXR0cmlidXRlKCJpZCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIFMoZS5yZXBsYWNlKHNlLCAiJDEiKSwgdCwgbiwgcik7CiAgICB9CgogICAgZnVuY3Rpb24gbigpIHsKICAgICAgZnVuY3Rpb24gZShuLCByKSB7CiAgICAgICAgcmV0dXJuIHQucHVzaChuICsgIiAiKSA+IFQuY2FjaGVMZW5ndGggJiYgZGVsZXRlIGVbdC5zaGlmdCgpXSwgZVtuICsgIiAiXSA9IHI7CiAgICAgIH0KCiAgICAgIHZhciB0ID0gW107CiAgICAgIHJldHVybiBlOwogICAgfQoKICAgIGZ1bmN0aW9uIHIoZSkgewogICAgICByZXR1cm4gZVtQXSA9ICEwLCBlOwogICAgfQoKICAgIGZ1bmN0aW9uIGkoZSkgewogICAgICB2YXIgdCA9IEguY3JlYXRlRWxlbWVudCgiZGl2Iik7CgogICAgICB0cnkgewogICAgICAgIHJldHVybiAhIWUodCk7CiAgICAgIH0gY2F0Y2ggKG4pIHsKICAgICAgICByZXR1cm4gITE7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgdC5wYXJlbnROb2RlICYmIHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0KSwgdCA9IG51bGw7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBvKGUsIHQpIHsKICAgICAgZm9yICh2YXIgbiA9IGUuc3BsaXQoInwiKSwgciA9IG4ubGVuZ3RoOyByLS07KSB7CiAgICAgICAgVC5hdHRySGFuZGxlW25bcl1dID0gdDsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGEoZSwgdCkgewogICAgICB2YXIgbiA9IHQgJiYgZSwKICAgICAgICAgIHIgPSBuICYmIDEgPT09IGUubm9kZVR5cGUgJiYgMSA9PT0gdC5ub2RlVHlwZSAmJiAofnQuc291cmNlSW5kZXggfHwgVikgLSAofmUuc291cmNlSW5kZXggfHwgVik7CiAgICAgIGlmIChyKSByZXR1cm4gcjsKICAgICAgaWYgKG4pIGZvciAoOyBuID0gbi5uZXh0U2libGluZzspIHsKICAgICAgICBpZiAobiA9PT0gdCkgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHJldHVybiBlID8gMSA6IC0xOwogICAgfQoKICAgIGZ1bmN0aW9uIHMoZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKHQpIHsKICAgICAgICB2YXIgbiA9IHQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gImlucHV0IiA9PT0gbiAmJiB0LnR5cGUgPT09IGU7CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gdShlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAodCkgewogICAgICAgIHZhciBuID0gdC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybiAoImlucHV0IiA9PT0gbiB8fCAiYnV0dG9uIiA9PT0gbikgJiYgdC50eXBlID09PSBlOwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGwoZSkgewogICAgICByZXR1cm4gcihmdW5jdGlvbiAodCkgewogICAgICAgIHJldHVybiB0ID0gK3QsIHIoZnVuY3Rpb24gKG4sIHIpIHsKICAgICAgICAgIGZvciAodmFyIGksIG8gPSBlKFtdLCBuLmxlbmd0aCwgdCksIGEgPSBvLmxlbmd0aDsgYS0tOykgewogICAgICAgICAgICBuW2kgPSBvW2FdXSAmJiAobltpXSA9ICEocltpXSA9IG5baV0pKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gYyhlKSB7CiAgICAgIHJldHVybiBlICYmICJ1bmRlZmluZWQiICE9IHR5cGVvZiBlLmdldEVsZW1lbnRzQnlUYWdOYW1lICYmIGU7CiAgICB9CgogICAgZnVuY3Rpb24gZigpIHt9CgogICAgZnVuY3Rpb24gZChlKSB7CiAgICAgIGZvciAodmFyIHQgPSAwLCBuID0gZS5sZW5ndGgsIHIgPSAiIjsgdCA8IG47IHQrKykgewogICAgICAgIHIgKz0gZVt0XS52YWx1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHI7CiAgICB9CgogICAgZnVuY3Rpb24gcChlLCB0LCBuKSB7CiAgICAgIHZhciByID0gdC5kaXIsCiAgICAgICAgICBpID0gbiAmJiAicGFyZW50Tm9kZSIgPT09IHIsCiAgICAgICAgICBvID0gSSsrOwogICAgICByZXR1cm4gdC5maXJzdCA/IGZ1bmN0aW9uICh0LCBuLCBvKSB7CiAgICAgICAgZm9yICg7IHQgPSB0W3JdOykgewogICAgICAgICAgaWYgKDEgPT09IHQubm9kZVR5cGUgfHwgaSkgcmV0dXJuIGUodCwgbiwgbyk7CiAgICAgICAgfQogICAgICB9IDogZnVuY3Rpb24gKHQsIG4sIGEpIHsKICAgICAgICB2YXIgcywKICAgICAgICAgICAgdSwKICAgICAgICAgICAgbCwKICAgICAgICAgICAgYyA9IFtXLCBvXTsKCiAgICAgICAgaWYgKGEpIHsKICAgICAgICAgIGZvciAoOyB0ID0gdFtyXTspIHsKICAgICAgICAgICAgaWYgKCgxID09PSB0Lm5vZGVUeXBlIHx8IGkpICYmIGUodCwgbiwgYSkpIHJldHVybiAhMDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgZm9yICg7IHQgPSB0W3JdOykgewogICAgICAgICAgaWYgKDEgPT09IHQubm9kZVR5cGUgfHwgaSkgewogICAgICAgICAgICBpZiAobCA9IHRbUF0gfHwgKHRbUF0gPSB7fSksIHUgPSBsW3QudW5pcXVlSURdIHx8IChsW3QudW5pcXVlSURdID0ge30pLCAocyA9IHVbcl0pICYmIHNbMF0gPT09IFcgJiYgc1sxXSA9PT0gbykgcmV0dXJuIGNbMl0gPSBzWzJdOwogICAgICAgICAgICBpZiAodVtyXSA9IGMsIGNbMl0gPSBlKHQsIG4sIGEpKSByZXR1cm4gITA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGgoZSkgewogICAgICByZXR1cm4gZS5sZW5ndGggPiAxID8gZnVuY3Rpb24gKHQsIG4sIHIpIHsKICAgICAgICBmb3IgKHZhciBpID0gZS5sZW5ndGg7IGktLTspIHsKICAgICAgICAgIGlmICghZVtpXSh0LCBuLCByKSkgcmV0dXJuICExOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICEwOwogICAgICB9IDogZVswXTsKICAgIH0KCiAgICBmdW5jdGlvbiBnKGUsIG4sIHIpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIG8gPSBuLmxlbmd0aDsgaSA8IG87IGkrKykgewogICAgICAgIHQoZSwgbltpXSwgcik7CiAgICAgIH0KCiAgICAgIHJldHVybiByOwogICAgfQoKICAgIGZ1bmN0aW9uIG0oZSwgdCwgbiwgciwgaSkgewogICAgICBmb3IgKHZhciBvLCBhID0gW10sIHMgPSAwLCB1ID0gZS5sZW5ndGgsIGwgPSBudWxsICE9IHQ7IHMgPCB1OyBzKyspIHsKICAgICAgICAobyA9IGVbc10pICYmIChuICYmICFuKG8sIHIsIGkpIHx8IChhLnB1c2gobyksIGwgJiYgdC5wdXNoKHMpKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBhOwogICAgfQoKICAgIGZ1bmN0aW9uIHkoZSwgdCwgbiwgaSwgbywgYSkgewogICAgICByZXR1cm4gaSAmJiAhaVtQXSAmJiAoaSA9IHkoaSkpLCBvICYmICFvW1BdICYmIChvID0geShvLCBhKSksIHIoZnVuY3Rpb24gKHIsIGEsIHMsIHUpIHsKICAgICAgICB2YXIgbCwKICAgICAgICAgICAgYywKICAgICAgICAgICAgZiwKICAgICAgICAgICAgZCA9IFtdLAogICAgICAgICAgICBwID0gW10sCiAgICAgICAgICAgIGggPSBhLmxlbmd0aCwKICAgICAgICAgICAgeSA9IHIgfHwgZyh0IHx8ICIqIiwgcy5ub2RlVHlwZSA/IFtzXSA6IHMsIFtdKSwKICAgICAgICAgICAgdiA9ICFlIHx8ICFyICYmIHQgPyB5IDogbSh5LCBkLCBlLCBzLCB1KSwKICAgICAgICAgICAgeCA9IG4gPyBvIHx8IChyID8gZSA6IGggfHwgaSkgPyBbXSA6IGEgOiB2OwogICAgICAgIGlmIChuICYmIG4odiwgeCwgcywgdSksIGkpIGZvciAobCA9IG0oeCwgcCksIGkobCwgW10sIHMsIHUpLCBjID0gbC5sZW5ndGg7IGMtLTspIHsKICAgICAgICAgIChmID0gbFtjXSkgJiYgKHhbcFtjXV0gPSAhKHZbcFtjXV0gPSBmKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAocikgewogICAgICAgICAgaWYgKG8gfHwgZSkgewogICAgICAgICAgICBpZiAobykgewogICAgICAgICAgICAgIGZvciAobCA9IFtdLCBjID0geC5sZW5ndGg7IGMtLTspIHsKICAgICAgICAgICAgICAgIChmID0geFtjXSkgJiYgbC5wdXNoKHZbY10gPSBmKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIG8obnVsbCwgeCA9IFtdLCBsLCB1KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChjID0geC5sZW5ndGg7IGMtLTspIHsKICAgICAgICAgICAgICAoZiA9IHhbY10pICYmIChsID0gbyA/IGVlKHIsIGYpIDogZFtjXSkgPiAtMSAmJiAocltsXSA9ICEoYVtsXSA9IGYpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB4ID0gbSh4ID09PSBhID8geC5zcGxpY2UoaCwgeC5sZW5ndGgpIDogeCksIG8gPyBvKG51bGwsIGEsIHgsIHUpIDogUS5hcHBseShhLCB4KTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gdihlKSB7CiAgICAgIGZvciAodmFyIHQsIG4sIHIsIGkgPSBlLmxlbmd0aCwgbyA9IFQucmVsYXRpdmVbZVswXS50eXBlXSwgYSA9IG8gfHwgVC5yZWxhdGl2ZVsiICJdLCBzID0gbyA/IDEgOiAwLCB1ID0gcChmdW5jdGlvbiAoZSkgewogICAgICAgIHJldHVybiBlID09PSB0OwogICAgICB9LCBhLCAhMCksIGwgPSBwKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgcmV0dXJuIGVlKHQsIGUpID4gLTE7CiAgICAgIH0sIGEsICEwKSwgYyA9IFtmdW5jdGlvbiAoZSwgbiwgcikgewogICAgICAgIHZhciBpID0gIW8gJiYgKHIgfHwgbiAhPT0gQSkgfHwgKCh0ID0gbikubm9kZVR5cGUgPyB1KGUsIG4sIHIpIDogbChlLCBuLCByKSk7CiAgICAgICAgcmV0dXJuIHQgPSBudWxsLCBpOwogICAgICB9XTsgcyA8IGk7IHMrKykgewogICAgICAgIGlmIChuID0gVC5yZWxhdGl2ZVtlW3NdLnR5cGVdKSBjID0gW3AoaChjKSwgbildO2Vsc2UgewogICAgICAgICAgaWYgKG4gPSBULmZpbHRlcltlW3NdLnR5cGVdLmFwcGx5KG51bGwsIGVbc10ubWF0Y2hlcyksIG5bUF0pIHsKICAgICAgICAgICAgZm9yIChyID0gKytzOyByIDwgaSAmJiAhVC5yZWxhdGl2ZVtlW3JdLnR5cGVdOyByKyspIHsKICAgICAgICAgICAgICA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB5KHMgPiAxICYmIGgoYyksIHMgPiAxICYmIGQoZS5zbGljZSgwLCBzIC0gMSkuY29uY2F0KHsKICAgICAgICAgICAgICB2YWx1ZTogIiAiID09PSBlW3MgLSAyXS50eXBlID8gIioiIDogIiIKICAgICAgICAgICAgfSkpLnJlcGxhY2Uoc2UsICIkMSIpLCBuLCBzIDwgciAmJiB2KGUuc2xpY2UocywgcikpLCByIDwgaSAmJiB2KGUgPSBlLnNsaWNlKHIpKSwgciA8IGkgJiYgZChlKSk7CiAgICAgICAgICB9CgogICAgICAgICAgYy5wdXNoKG4pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGgoYyk7CiAgICB9CgogICAgZnVuY3Rpb24geChlLCBuKSB7CiAgICAgIHZhciBpID0gbi5sZW5ndGggPiAwLAogICAgICAgICAgbyA9IGUubGVuZ3RoID4gMCwKICAgICAgICAgIGEgPSBmdW5jdGlvbiBhKHIsIF9hMiwgcywgdSwgbCkgewogICAgICAgIHZhciBjLAogICAgICAgICAgICBmLAogICAgICAgICAgICBkLAogICAgICAgICAgICBwID0gMCwKICAgICAgICAgICAgaCA9ICIwIiwKICAgICAgICAgICAgZyA9IHIgJiYgW10sCiAgICAgICAgICAgIHkgPSBbXSwKICAgICAgICAgICAgdiA9IEEsCiAgICAgICAgICAgIHggPSByIHx8IG8gJiYgVC5maW5kLlRBRygiKiIsIGwpLAogICAgICAgICAgICBiID0gVyArPSBudWxsID09IHYgPyAxIDogTWF0aC5yYW5kb20oKSB8fCAuMSwKICAgICAgICAgICAgdyA9IHgubGVuZ3RoOwoKICAgICAgICBmb3IgKGwgJiYgKEEgPSBfYTIgPT09IEggfHwgX2EyIHx8IGwpOyBoICE9PSB3ICYmIG51bGwgIT0gKGMgPSB4W2hdKTsgaCsrKSB7CiAgICAgICAgICBpZiAobyAmJiBjKSB7CiAgICAgICAgICAgIGZvciAoZiA9IDAsIF9hMiB8fCBjLm93bmVyRG9jdW1lbnQgPT09IEggfHwgKEwoYyksIHMgPSAhXyk7IGQgPSBlW2YrK107KSB7CiAgICAgICAgICAgICAgaWYgKGQoYywgX2EyIHx8IEgsIHMpKSB7CiAgICAgICAgICAgICAgICB1LnB1c2goYyk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGwgJiYgKFcgPSBiKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpICYmICgoYyA9ICFkICYmIGMpICYmIHAtLSwgciAmJiBnLnB1c2goYykpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHAgKz0gaCwgaSAmJiBoICE9PSBwKSB7CiAgICAgICAgICBmb3IgKGYgPSAwOyBkID0gbltmKytdOykgewogICAgICAgICAgICBkKGcsIHksIF9hMiwgcyk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHIpIHsKICAgICAgICAgICAgaWYgKHAgPiAwKSBmb3IgKDsgaC0tOykgewogICAgICAgICAgICAgIGdbaF0gfHwgeVtoXSB8fCAoeVtoXSA9IEcuY2FsbCh1KSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeSA9IG0oeSk7CiAgICAgICAgICB9CgogICAgICAgICAgUS5hcHBseSh1LCB5KSwgbCAmJiAhciAmJiB5Lmxlbmd0aCA+IDAgJiYgcCArIG4ubGVuZ3RoID4gMSAmJiB0LnVuaXF1ZVNvcnQodSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbCAmJiAoVyA9IGIsIEEgPSB2KSwgZzsKICAgICAgfTsKCiAgICAgIHJldHVybiBpID8gcihhKSA6IGE7CiAgICB9CgogICAgdmFyIGIsCiAgICAgICAgdywKICAgICAgICBULAogICAgICAgIEMsCiAgICAgICAgRSwKICAgICAgICBOLAogICAgICAgIGssCiAgICAgICAgUywKICAgICAgICBBLAogICAgICAgIEQsCiAgICAgICAgaiwKICAgICAgICBMLAogICAgICAgIEgsCiAgICAgICAgcSwKICAgICAgICBfLAogICAgICAgIEYsCiAgICAgICAgTSwKICAgICAgICBPLAogICAgICAgIFIsCiAgICAgICAgUCA9ICJzaXp6bGUiICsgMSAqIG5ldyBEYXRlKCksCiAgICAgICAgQiA9IGUuZG9jdW1lbnQsCiAgICAgICAgVyA9IDAsCiAgICAgICAgSSA9IDAsCiAgICAgICAgJCA9IG4oKSwKICAgICAgICB6ID0gbigpLAogICAgICAgIFggPSBuKCksCiAgICAgICAgVSA9IGZ1bmN0aW9uIFUoZSwgdCkgewogICAgICByZXR1cm4gZSA9PT0gdCAmJiAoaiA9ICEwKSwgMDsKICAgIH0sCiAgICAgICAgViA9IDEgPDwgMzEsCiAgICAgICAgWSA9IHt9Lmhhc093blByb3BlcnR5LAogICAgICAgIEogPSBbXSwKICAgICAgICBHID0gSi5wb3AsCiAgICAgICAgSyA9IEoucHVzaCwKICAgICAgICBRID0gSi5wdXNoLAogICAgICAgIFogPSBKLnNsaWNlLAogICAgICAgIGVlID0gZnVuY3Rpb24gZWUoZSwgdCkgewogICAgICBmb3IgKHZhciBuID0gMCwgciA9IGUubGVuZ3RoOyBuIDwgcjsgbisrKSB7CiAgICAgICAgaWYgKGVbbl0gPT09IHQpIHJldHVybiBuOwogICAgICB9CgogICAgICByZXR1cm4gLTE7CiAgICB9LAogICAgICAgIHRlID0gImNoZWNrZWR8c2VsZWN0ZWR8YXN5bmN8YXV0b2ZvY3VzfGF1dG9wbGF5fGNvbnRyb2xzfGRlZmVyfGRpc2FibGVkfGhpZGRlbnxpc21hcHxsb29wfG11bHRpcGxlfG9wZW58cmVhZG9ubHl8cmVxdWlyZWR8c2NvcGVkIiwKICAgICAgICBuZSA9ICJbXFx4MjBcXHRcXHJcXG5cXGZdIiwKICAgICAgICByZSA9ICIoPzpcXFxcLnxbXFx3LV18W15cXHgwMC1cXHhhMF0pKyIsCiAgICAgICAgaWUgPSAiXFxbIiArIG5lICsgIiooIiArIHJlICsgIikoPzoiICsgbmUgKyAiKihbKl4kfCF+XT89KSIgKyBuZSArICIqKD86JygoPzpcXFxcLnxbXlxcXFwnXSkqKSd8XCIoKD86XFxcXC58W15cXFxcXCJdKSopXCJ8KCIgKyByZSArICIpKXwpIiArIG5lICsgIipcXF0iLAogICAgICAgIG9lID0gIjooIiArIHJlICsgIikoPzpcXCgoKCcoKD86XFxcXC58W15cXFxcJ10pKiknfFwiKCg/OlxcXFwufFteXFxcXFwiXSkqKVwiKXwoKD86XFxcXC58W15cXFxcKClbXFxdXXwiICsgaWUgKyAiKSopfC4qKVxcKXwpIiwKICAgICAgICBhZSA9IG5ldyBSZWdFeHAobmUgKyAiKyIsICJnIiksCiAgICAgICAgc2UgPSBuZXcgUmVnRXhwKCJeIiArIG5lICsgIit8KCg/Ol58W15cXFxcXSkoPzpcXFxcLikqKSIgKyBuZSArICIrJCIsICJnIiksCiAgICAgICAgdWUgPSBuZXcgUmVnRXhwKCJeIiArIG5lICsgIiosIiArIG5lICsgIioiKSwKICAgICAgICBsZSA9IG5ldyBSZWdFeHAoIl4iICsgbmUgKyAiKihbPit+XXwiICsgbmUgKyAiKSIgKyBuZSArICIqIiksCiAgICAgICAgY2UgPSBuZXcgUmVnRXhwKCI9IiArIG5lICsgIiooW15cXF0nXCJdKj8pIiArIG5lICsgIipcXF0iLCAiZyIpLAogICAgICAgIGZlID0gbmV3IFJlZ0V4cChvZSksCiAgICAgICAgZGUgPSBuZXcgUmVnRXhwKCJeIiArIHJlICsgIiQiKSwKICAgICAgICBwZSA9IHsKICAgICAgSUQ6IG5ldyBSZWdFeHAoIl4jKCIgKyByZSArICIpIiksCiAgICAgIENMQVNTOiBuZXcgUmVnRXhwKCJeXFwuKCIgKyByZSArICIpIiksCiAgICAgIFRBRzogbmV3IFJlZ0V4cCgiXigiICsgcmUgKyAifFsqXSkiKSwKICAgICAgQVRUUjogbmV3IFJlZ0V4cCgiXiIgKyBpZSksCiAgICAgIFBTRVVETzogbmV3IFJlZ0V4cCgiXiIgKyBvZSksCiAgICAgIENISUxEOiBuZXcgUmVnRXhwKCJeOihvbmx5fGZpcnN0fGxhc3R8bnRofG50aC1sYXN0KS0oY2hpbGR8b2YtdHlwZSkoPzpcXCgiICsgbmUgKyAiKihldmVufG9kZHwoKFsrLV18KShcXGQqKW58KSIgKyBuZSArICIqKD86KFsrLV18KSIgKyBuZSArICIqKFxcZCspfCkpIiArIG5lICsgIipcXCl8KSIsICJpIiksCiAgICAgIGJvb2w6IG5ldyBSZWdFeHAoIl4oPzoiICsgdGUgKyAiKSQiLCAiaSIpLAogICAgICBuZWVkc0NvbnRleHQ6IG5ldyBSZWdFeHAoIl4iICsgbmUgKyAiKls+K35dfDooZXZlbnxvZGR8ZXF8Z3R8bHR8bnRofGZpcnN0fGxhc3QpKD86XFwoIiArIG5lICsgIiooKD86LVxcZCk/XFxkKikiICsgbmUgKyAiKlxcKXwpKD89W14tXXwkKSIsICJpIikKICAgIH0sCiAgICAgICAgaGUgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24pJC9pLAogICAgICAgIGdlID0gL15oXGQkL2ksCiAgICAgICAgbWUgPSAvXltee10rXHtccypcW25hdGl2ZSBcdy8sCiAgICAgICAgeWUgPSAvXig/OiMoW1x3LV0rKXwoXHcrKXxcLihbXHctXSspKSQvLAogICAgICAgIHZlID0gL1srfl0vLAogICAgICAgIHhlID0gLyd8XFwvZywKICAgICAgICBiZSA9IG5ldyBSZWdFeHAoIlxcXFwoW1xcZGEtZl17MSw2fSIgKyBuZSArICI/fCgiICsgbmUgKyAiKXwuKSIsICJpZyIpLAogICAgICAgIHdlID0gZnVuY3Rpb24gd2UoZSwgdCwgbikgewogICAgICB2YXIgciA9ICIweCIgKyB0IC0gNjU1MzY7CiAgICAgIHJldHVybiByICE9PSByIHx8IG4gPyB0IDogciA8IDAgPyBTdHJpbmcuZnJvbUNoYXJDb2RlKHIgKyA2NTUzNikgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKHIgPj4gMTAgfCA1NTI5NiwgMTAyMyAmIHIgfCA1NjMyMCk7CiAgICB9LAogICAgICAgIFRlID0gZnVuY3Rpb24gVGUoKSB7CiAgICAgIEwoKTsKICAgIH07CgogICAgdHJ5IHsKICAgICAgUS5hcHBseShKID0gWi5jYWxsKEIuY2hpbGROb2RlcyksIEIuY2hpbGROb2RlcyksIEpbQi5jaGlsZE5vZGVzLmxlbmd0aF0ubm9kZVR5cGU7CiAgICB9IGNhdGNoIChDZSkgewogICAgICBRID0gewogICAgICAgIGFwcGx5OiBKLmxlbmd0aCA/IGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgICAgICBLLmFwcGx5KGUsIFouY2FsbCh0KSk7CiAgICAgICAgfSA6IGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgICAgICBmb3IgKHZhciBuID0gZS5sZW5ndGgsIHIgPSAwOyBlW24rK10gPSB0W3IrK107KSB7CiAgICAgICAgICAgIDsKICAgICAgICAgIH0KCiAgICAgICAgICBlLmxlbmd0aCA9IG4gLSAxOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KCiAgICB3ID0gdC5zdXBwb3J0ID0ge30sIEUgPSB0LmlzWE1MID0gZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIHQgPSBlICYmIChlLm93bmVyRG9jdW1lbnQgfHwgZSkuZG9jdW1lbnRFbGVtZW50OwogICAgICByZXR1cm4gISF0ICYmICJIVE1MIiAhPT0gdC5ub2RlTmFtZTsKICAgIH0sIEwgPSB0LnNldERvY3VtZW50ID0gZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIHQsCiAgICAgICAgICBuLAogICAgICAgICAgciA9IGUgPyBlLm93bmVyRG9jdW1lbnQgfHwgZSA6IEI7CiAgICAgIHJldHVybiByICE9PSBIICYmIDkgPT09IHIubm9kZVR5cGUgJiYgci5kb2N1bWVudEVsZW1lbnQgPyAoSCA9IHIsIHEgPSBILmRvY3VtZW50RWxlbWVudCwgXyA9ICFFKEgpLCAobiA9IEguZGVmYXVsdFZpZXcpICYmIG4udG9wICE9PSBuICYmIChuLmFkZEV2ZW50TGlzdGVuZXIgPyBuLmFkZEV2ZW50TGlzdGVuZXIoInVubG9hZCIsIFRlLCAhMSkgOiBuLmF0dGFjaEV2ZW50ICYmIG4uYXR0YWNoRXZlbnQoIm9udW5sb2FkIiwgVGUpKSwgdy5hdHRyaWJ1dGVzID0gaShmdW5jdGlvbiAoZSkgewogICAgICAgIHJldHVybiBlLmNsYXNzTmFtZSA9ICJpIiwgIWUuZ2V0QXR0cmlidXRlKCJjbGFzc05hbWUiKTsKICAgICAgfSksIHcuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPSBpKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgcmV0dXJuIGUuYXBwZW5kQ2hpbGQoSC5jcmVhdGVDb21tZW50KCIiKSksICFlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikubGVuZ3RoOwogICAgICB9KSwgdy5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lID0gbWUudGVzdChILmdldEVsZW1lbnRzQnlDbGFzc05hbWUpLCB3LmdldEJ5SWQgPSBpKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgcmV0dXJuIHEuYXBwZW5kQ2hpbGQoZSkuaWQgPSBQLCAhSC5nZXRFbGVtZW50c0J5TmFtZSB8fCAhSC5nZXRFbGVtZW50c0J5TmFtZShQKS5sZW5ndGg7CiAgICAgIH0pLCB3LmdldEJ5SWQgPyAoVC5maW5kLklEID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgICBpZiAoInVuZGVmaW5lZCIgIT0gdHlwZW9mIHQuZ2V0RWxlbWVudEJ5SWQgJiYgXykgewogICAgICAgICAgdmFyIG4gPSB0LmdldEVsZW1lbnRCeUlkKGUpOwogICAgICAgICAgcmV0dXJuIG4gPyBbbl0gOiBbXTsKICAgICAgICB9CiAgICAgIH0sIFQuZmlsdGVyLklEID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICB2YXIgdCA9IGUucmVwbGFjZShiZSwgd2UpOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZSkgewogICAgICAgICAgcmV0dXJuIGUuZ2V0QXR0cmlidXRlKCJpZCIpID09PSB0OwogICAgICAgIH07CiAgICAgIH0pIDogKGRlbGV0ZSBULmZpbmQuSUQsIFQuZmlsdGVyLklEID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICB2YXIgdCA9IGUucmVwbGFjZShiZSwgd2UpOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZSkgewogICAgICAgICAgdmFyIG4gPSAidW5kZWZpbmVkIiAhPSB0eXBlb2YgZS5nZXRBdHRyaWJ1dGVOb2RlICYmIGUuZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsKICAgICAgICAgIHJldHVybiBuICYmIG4udmFsdWUgPT09IHQ7CiAgICAgICAgfTsKICAgICAgfSksIFQuZmluZC5UQUcgPSB3LmdldEVsZW1lbnRzQnlUYWdOYW1lID8gZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgICByZXR1cm4gInVuZGVmaW5lZCIgIT0gdHlwZW9mIHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPyB0LmdldEVsZW1lbnRzQnlUYWdOYW1lKGUpIDogdy5xc2EgPyB0LnF1ZXJ5U2VsZWN0b3JBbGwoZSkgOiB2b2lkIDA7CiAgICAgIH0gOiBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgIHZhciBuLAogICAgICAgICAgICByID0gW10sCiAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICBvID0gdC5nZXRFbGVtZW50c0J5VGFnTmFtZShlKTsKCiAgICAgICAgaWYgKCIqIiA9PT0gZSkgewogICAgICAgICAgZm9yICg7IG4gPSBvW2krK107KSB7CiAgICAgICAgICAgIDEgPT09IG4ubm9kZVR5cGUgJiYgci5wdXNoKG4pOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiByOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG87CiAgICAgIH0sIFQuZmluZC5DTEFTUyA9IHcuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgIGlmICgidW5kZWZpbmVkIiAhPSB0eXBlb2YgdC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmIF8pIHJldHVybiB0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoZSk7CiAgICAgIH0sIE0gPSBbXSwgRiA9IFtdLCAody5xc2EgPSBtZS50ZXN0KEgucXVlcnlTZWxlY3RvckFsbCkpICYmIChpKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgcS5hcHBlbmRDaGlsZChlKS5pbm5lckhUTUwgPSAiPGEgaWQ9JyIgKyBQICsgIic+PC9hPjxzZWxlY3QgaWQ9JyIgKyBQICsgIi1cclxcJyBtc2FsbG93Y2FwdHVyZT0nJz48b3B0aW9uIHNlbGVjdGVkPScnPjwvb3B0aW9uPjwvc2VsZWN0PiIsIGUucXVlcnlTZWxlY3RvckFsbCgiW21zYWxsb3djYXB0dXJlXj0nJ10iKS5sZW5ndGggJiYgRi5wdXNoKCJbKl4kXT0iICsgbmUgKyAiKig/OicnfFwiXCIpIiksIGUucXVlcnlTZWxlY3RvckFsbCgiW3NlbGVjdGVkXSIpLmxlbmd0aCB8fCBGLnB1c2goIlxcWyIgKyBuZSArICIqKD86dmFsdWV8IiArIHRlICsgIikiKSwgZS5xdWVyeVNlbGVjdG9yQWxsKCJbaWR+PSIgKyBQICsgIi1dIikubGVuZ3RoIHx8IEYucHVzaCgifj0iKSwgZS5xdWVyeVNlbGVjdG9yQWxsKCI6Y2hlY2tlZCIpLmxlbmd0aCB8fCBGLnB1c2goIjpjaGVja2VkIiksIGUucXVlcnlTZWxlY3RvckFsbCgiYSMiICsgUCArICIrKiIpLmxlbmd0aCB8fCBGLnB1c2goIi4jLitbK35dIik7CiAgICAgIH0pLCBpKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdmFyIHQgPSBILmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgdC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAiaGlkZGVuIiksIGUuYXBwZW5kQ2hpbGQodCkuc2V0QXR0cmlidXRlKCJuYW1lIiwgIkQiKSwgZS5xdWVyeVNlbGVjdG9yQWxsKCJbbmFtZT1kXSIpLmxlbmd0aCAmJiBGLnB1c2goIm5hbWUiICsgbmUgKyAiKlsqXiR8IX5dPz0iKSwgZS5xdWVyeVNlbGVjdG9yQWxsKCI6ZW5hYmxlZCIpLmxlbmd0aCB8fCBGLnB1c2goIjplbmFibGVkIiwgIjpkaXNhYmxlZCIpLCBlLnF1ZXJ5U2VsZWN0b3JBbGwoIiosOngiKSwgRi5wdXNoKCIsLio6Iik7CiAgICAgIH0pKSwgKHcubWF0Y2hlc1NlbGVjdG9yID0gbWUudGVzdChPID0gcS5tYXRjaGVzIHx8IHEud2Via2l0TWF0Y2hlc1NlbGVjdG9yIHx8IHEubW96TWF0Y2hlc1NlbGVjdG9yIHx8IHEub01hdGNoZXNTZWxlY3RvciB8fCBxLm1zTWF0Y2hlc1NlbGVjdG9yKSkgJiYgaShmdW5jdGlvbiAoZSkgewogICAgICAgIHcuZGlzY29ubmVjdGVkTWF0Y2ggPSBPLmNhbGwoZSwgImRpdiIpLCBPLmNhbGwoZSwgIltzIT0nJ106eCIpLCBNLnB1c2goIiE9Iiwgb2UpOwogICAgICB9KSwgRiA9IEYubGVuZ3RoICYmIG5ldyBSZWdFeHAoRi5qb2luKCJ8IikpLCBNID0gTS5sZW5ndGggJiYgbmV3IFJlZ0V4cChNLmpvaW4oInwiKSksIHQgPSBtZS50ZXN0KHEuY29tcGFyZURvY3VtZW50UG9zaXRpb24pLCBSID0gdCB8fCBtZS50ZXN0KHEuY29udGFpbnMpID8gZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgICB2YXIgbiA9IDkgPT09IGUubm9kZVR5cGUgPyBlLmRvY3VtZW50RWxlbWVudCA6IGUsCiAgICAgICAgICAgIHIgPSB0ICYmIHQucGFyZW50Tm9kZTsKICAgICAgICByZXR1cm4gZSA9PT0gciB8fCAhKCFyIHx8IDEgIT09IHIubm9kZVR5cGUgfHwgIShuLmNvbnRhaW5zID8gbi5jb250YWlucyhyKSA6IGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgMTYgJiBlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKHIpKSk7CiAgICAgIH0gOiBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgIGlmICh0KSBmb3IgKDsgdCA9IHQucGFyZW50Tm9kZTspIHsKICAgICAgICAgIGlmICh0ID09PSBlKSByZXR1cm4gITA7CiAgICAgICAgfQogICAgICAgIHJldHVybiAhMTsKICAgICAgfSwgVSA9IHQgPyBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgIGlmIChlID09PSB0KSByZXR1cm4gaiA9ICEwLCAwOwogICAgICAgIHZhciBuID0gIWUuY29tcGFyZURvY3VtZW50UG9zaXRpb24gLSAhdC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbjsKICAgICAgICByZXR1cm4gbiA/IG4gOiAobiA9IChlLm93bmVyRG9jdW1lbnQgfHwgZSkgPT09ICh0Lm93bmVyRG9jdW1lbnQgfHwgdCkgPyBlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKHQpIDogMSwgMSAmIG4gfHwgIXcuc29ydERldGFjaGVkICYmIHQuY29tcGFyZURvY3VtZW50UG9zaXRpb24oZSkgPT09IG4gPyBlID09PSBIIHx8IGUub3duZXJEb2N1bWVudCA9PT0gQiAmJiBSKEIsIGUpID8gLTEgOiB0ID09PSBIIHx8IHQub3duZXJEb2N1bWVudCA9PT0gQiAmJiBSKEIsIHQpID8gMSA6IEQgPyBlZShELCBlKSAtIGVlKEQsIHQpIDogMCA6IDQgJiBuID8gLTEgOiAxKTsKICAgICAgfSA6IGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgICAgaWYgKGUgPT09IHQpIHJldHVybiBqID0gITAsIDA7CiAgICAgICAgdmFyIG4sCiAgICAgICAgICAgIHIgPSAwLAogICAgICAgICAgICBpID0gZS5wYXJlbnROb2RlLAogICAgICAgICAgICBvID0gdC5wYXJlbnROb2RlLAogICAgICAgICAgICBzID0gW2VdLAogICAgICAgICAgICB1ID0gW3RdOwogICAgICAgIGlmICghaSB8fCAhbykgcmV0dXJuIGUgPT09IEggPyAtMSA6IHQgPT09IEggPyAxIDogaSA/IC0xIDogbyA/IDEgOiBEID8gZWUoRCwgZSkgLSBlZShELCB0KSA6IDA7CiAgICAgICAgaWYgKGkgPT09IG8pIHJldHVybiBhKGUsIHQpOwoKICAgICAgICBmb3IgKG4gPSBlOyBuID0gbi5wYXJlbnROb2RlOykgewogICAgICAgICAgcy51bnNoaWZ0KG4pOwogICAgICAgIH0KCiAgICAgICAgZm9yIChuID0gdDsgbiA9IG4ucGFyZW50Tm9kZTspIHsKICAgICAgICAgIHUudW5zaGlmdChuKTsKICAgICAgICB9CgogICAgICAgIGZvciAoOyBzW3JdID09PSB1W3JdOykgewogICAgICAgICAgcisrOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHIgPyBhKHNbcl0sIHVbcl0pIDogc1tyXSA9PT0gQiA/IC0xIDogdVtyXSA9PT0gQiA/IDEgOiAwOwogICAgICB9LCBIKSA6IEg7CiAgICB9LCB0Lm1hdGNoZXMgPSBmdW5jdGlvbiAoZSwgbikgewogICAgICByZXR1cm4gdChlLCBudWxsLCBudWxsLCBuKTsKICAgIH0sIHQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24gKGUsIG4pIHsKICAgICAgaWYgKChlLm93bmVyRG9jdW1lbnQgfHwgZSkgIT09IEggJiYgTChlKSwgbiA9IG4ucmVwbGFjZShjZSwgIj0nJDEnXSIpLCB3Lm1hdGNoZXNTZWxlY3RvciAmJiBfICYmICFYW24gKyAiICJdICYmICghTSB8fCAhTS50ZXN0KG4pKSAmJiAoIUYgfHwgIUYudGVzdChuKSkpIHRyeSB7CiAgICAgICAgdmFyIHIgPSBPLmNhbGwoZSwgbik7CiAgICAgICAgaWYgKHIgfHwgdy5kaXNjb25uZWN0ZWRNYXRjaCB8fCBlLmRvY3VtZW50ICYmIDExICE9PSBlLmRvY3VtZW50Lm5vZGVUeXBlKSByZXR1cm4gcjsKICAgICAgfSBjYXRjaCAoaSkge30KICAgICAgcmV0dXJuIHQobiwgSCwgbnVsbCwgW2VdKS5sZW5ndGggPiAwOwogICAgfSwgdC5jb250YWlucyA9IGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgIHJldHVybiAoZS5vd25lckRvY3VtZW50IHx8IGUpICE9PSBIICYmIEwoZSksIFIoZSwgdCk7CiAgICB9LCB0LmF0dHIgPSBmdW5jdGlvbiAoZSwgdCkgewogICAgICAoZS5vd25lckRvY3VtZW50IHx8IGUpICE9PSBIICYmIEwoZSk7CiAgICAgIHZhciBuID0gVC5hdHRySGFuZGxlW3QudG9Mb3dlckNhc2UoKV0sCiAgICAgICAgICByID0gbiAmJiBZLmNhbGwoVC5hdHRySGFuZGxlLCB0LnRvTG93ZXJDYXNlKCkpID8gbihlLCB0LCAhXykgOiB2b2lkIDA7CiAgICAgIHJldHVybiB2b2lkIDAgIT09IHIgPyByIDogdy5hdHRyaWJ1dGVzIHx8ICFfID8gZS5nZXRBdHRyaWJ1dGUodCkgOiAociA9IGUuZ2V0QXR0cmlidXRlTm9kZSh0KSkgJiYgci5zcGVjaWZpZWQgPyByLnZhbHVlIDogbnVsbDsKICAgIH0sIHQuZXJyb3IgPSBmdW5jdGlvbiAoZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlN5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICIgKyBlKTsKICAgIH0sIHQudW5pcXVlU29ydCA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciB0LAogICAgICAgICAgbiA9IFtdLAogICAgICAgICAgciA9IDAsCiAgICAgICAgICBpID0gMDsKCiAgICAgIGlmIChqID0gIXcuZGV0ZWN0RHVwbGljYXRlcywgRCA9ICF3LnNvcnRTdGFibGUgJiYgZS5zbGljZSgwKSwgZS5zb3J0KFUpLCBqKSB7CiAgICAgICAgZm9yICg7IHQgPSBlW2krK107KSB7CiAgICAgICAgICB0ID09PSBlW2ldICYmIChyID0gbi5wdXNoKGkpKTsKICAgICAgICB9CgogICAgICAgIGZvciAoOyByLS07KSB7CiAgICAgICAgICBlLnNwbGljZShuW3JdLCAxKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBEID0gbnVsbCwgZTsKICAgIH0sIEMgPSB0LmdldFRleHQgPSBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgdCwKICAgICAgICAgIG4gPSAiIiwKICAgICAgICAgIHIgPSAwLAogICAgICAgICAgaSA9IGUubm9kZVR5cGU7CgogICAgICBpZiAoaSkgewogICAgICAgIGlmICgxID09PSBpIHx8IDkgPT09IGkgfHwgMTEgPT09IGkpIHsKICAgICAgICAgIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgZS50ZXh0Q29udGVudCkgcmV0dXJuIGUudGV4dENvbnRlbnQ7CgogICAgICAgICAgZm9yIChlID0gZS5maXJzdENoaWxkOyBlOyBlID0gZS5uZXh0U2libGluZykgewogICAgICAgICAgICBuICs9IEMoZSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICgzID09PSBpIHx8IDQgPT09IGkpIHJldHVybiBlLm5vZGVWYWx1ZTsKICAgICAgfSBlbHNlIGZvciAoOyB0ID0gZVtyKytdOykgewogICAgICAgIG4gKz0gQyh0KTsKICAgICAgfQoKICAgICAgcmV0dXJuIG47CiAgICB9LCBUID0gdC5zZWxlY3RvcnMgPSB7CiAgICAgIGNhY2hlTGVuZ3RoOiA1MCwKICAgICAgY3JlYXRlUHNldWRvOiByLAogICAgICBtYXRjaDogcGUsCiAgICAgIGF0dHJIYW5kbGU6IHt9LAogICAgICBmaW5kOiB7fSwKICAgICAgcmVsYXRpdmU6IHsKICAgICAgICAiPiI6IHsKICAgICAgICAgIGRpcjogInBhcmVudE5vZGUiLAogICAgICAgICAgZmlyc3Q6ICEwCiAgICAgICAgfSwKICAgICAgICAiICI6IHsKICAgICAgICAgIGRpcjogInBhcmVudE5vZGUiCiAgICAgICAgfSwKICAgICAgICAiKyI6IHsKICAgICAgICAgIGRpcjogInByZXZpb3VzU2libGluZyIsCiAgICAgICAgICBmaXJzdDogITAKICAgICAgICB9LAogICAgICAgICJ+IjogewogICAgICAgICAgZGlyOiAicHJldmlvdXNTaWJsaW5nIgogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlRmlsdGVyOiB7CiAgICAgICAgQVRUUjogZnVuY3Rpb24gQVRUUihlKSB7CiAgICAgICAgICByZXR1cm4gZVsxXSA9IGVbMV0ucmVwbGFjZShiZSwgd2UpLCBlWzNdID0gKGVbM10gfHwgZVs0XSB8fCBlWzVdIHx8ICIiKS5yZXBsYWNlKGJlLCB3ZSksICJ+PSIgPT09IGVbMl0gJiYgKGVbM10gPSAiICIgKyBlWzNdICsgIiAiKSwgZS5zbGljZSgwLCA0KTsKICAgICAgICB9LAogICAgICAgIENISUxEOiBmdW5jdGlvbiBDSElMRChlKSB7CiAgICAgICAgICByZXR1cm4gZVsxXSA9IGVbMV0udG9Mb3dlckNhc2UoKSwgIm50aCIgPT09IGVbMV0uc2xpY2UoMCwgMykgPyAoZVszXSB8fCB0LmVycm9yKGVbMF0pLCBlWzRdID0gKyhlWzRdID8gZVs1XSArIChlWzZdIHx8IDEpIDogMiAqICgiZXZlbiIgPT09IGVbM10gfHwgIm9kZCIgPT09IGVbM10pKSwgZVs1XSA9ICsoZVs3XSArIGVbOF0gfHwgIm9kZCIgPT09IGVbM10pKSA6IGVbM10gJiYgdC5lcnJvcihlWzBdKSwgZTsKICAgICAgICB9LAogICAgICAgIFBTRVVETzogZnVuY3Rpb24gUFNFVURPKGUpIHsKICAgICAgICAgIHZhciB0LAogICAgICAgICAgICAgIG4gPSAhZVs2XSAmJiBlWzJdOwogICAgICAgICAgcmV0dXJuIHBlLkNISUxELnRlc3QoZVswXSkgPyBudWxsIDogKGVbM10gPyBlWzJdID0gZVs0XSB8fCBlWzVdIHx8ICIiIDogbiAmJiBmZS50ZXN0KG4pICYmICh0ID0gTihuLCAhMCkpICYmICh0ID0gbi5pbmRleE9mKCIpIiwgbi5sZW5ndGggLSB0KSAtIG4ubGVuZ3RoKSAmJiAoZVswXSA9IGVbMF0uc2xpY2UoMCwgdCksIGVbMl0gPSBuLnNsaWNlKDAsIHQpKSwgZS5zbGljZSgwLCAzKSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBmaWx0ZXI6IHsKICAgICAgICBUQUc6IGZ1bmN0aW9uIFRBRyhlKSB7CiAgICAgICAgICB2YXIgdCA9IGUucmVwbGFjZShiZSwgd2UpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gIioiID09PSBlID8gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gITA7CiAgICAgICAgICB9IDogZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGUubm9kZU5hbWUgJiYgZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSB0OwogICAgICAgICAgfTsKICAgICAgICB9LAogICAgICAgIENMQVNTOiBmdW5jdGlvbiBDTEFTUyhlKSB7CiAgICAgICAgICB2YXIgdCA9ICRbZSArICIgIl07CiAgICAgICAgICByZXR1cm4gdCB8fCAodCA9IG5ldyBSZWdFeHAoIihefCIgKyBuZSArICIpIiArIGUgKyAiKCIgKyBuZSArICJ8JCkiKSkgJiYgJChlLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICByZXR1cm4gdC50ZXN0KCJzdHJpbmciID09IHR5cGVvZiBlLmNsYXNzTmFtZSAmJiBlLmNsYXNzTmFtZSB8fCAidW5kZWZpbmVkIiAhPSB0eXBlb2YgZS5nZXRBdHRyaWJ1dGUgJiYgZS5nZXRBdHRyaWJ1dGUoImNsYXNzIikgfHwgIiIpOwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBBVFRSOiBmdW5jdGlvbiBBVFRSKGUsIG4sIHIpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoaSkgewogICAgICAgICAgICB2YXIgbyA9IHQuYXR0cihpLCBlKTsKICAgICAgICAgICAgcmV0dXJuIG51bGwgPT0gbyA/ICIhPSIgPT09IG4gOiAhbiB8fCAobyArPSAiIiwgIj0iID09PSBuID8gbyA9PT0gciA6ICIhPSIgPT09IG4gPyBvICE9PSByIDogIl49IiA9PT0gbiA/IHIgJiYgMCA9PT0gby5pbmRleE9mKHIpIDogIio9IiA9PT0gbiA/IHIgJiYgby5pbmRleE9mKHIpID4gLTEgOiAiJD0iID09PSBuID8gciAmJiBvLnNsaWNlKC1yLmxlbmd0aCkgPT09IHIgOiAifj0iID09PSBuID8gKCIgIiArIG8ucmVwbGFjZShhZSwgIiAiKSArICIgIikuaW5kZXhPZihyKSA+IC0xIDogInw9IiA9PT0gbiAmJiAobyA9PT0gciB8fCBvLnNsaWNlKDAsIHIubGVuZ3RoICsgMSkgPT09IHIgKyAiLSIpKTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBDSElMRDogZnVuY3Rpb24gQ0hJTEQoZSwgdCwgbiwgciwgaSkgewogICAgICAgICAgdmFyIG8gPSAibnRoIiAhPT0gZS5zbGljZSgwLCAzKSwKICAgICAgICAgICAgICBhID0gImxhc3QiICE9PSBlLnNsaWNlKC00KSwKICAgICAgICAgICAgICBzID0gIm9mLXR5cGUiID09PSB0OwogICAgICAgICAgcmV0dXJuIDEgPT09IHIgJiYgMCA9PT0gaSA/IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIHJldHVybiAhIWUucGFyZW50Tm9kZTsKICAgICAgICAgIH0gOiBmdW5jdGlvbiAodCwgbiwgdSkgewogICAgICAgICAgICB2YXIgbCwKICAgICAgICAgICAgICAgIGMsCiAgICAgICAgICAgICAgICBmLAogICAgICAgICAgICAgICAgZCwKICAgICAgICAgICAgICAgIHAsCiAgICAgICAgICAgICAgICBoLAogICAgICAgICAgICAgICAgZyA9IG8gIT09IGEgPyAibmV4dFNpYmxpbmciIDogInByZXZpb3VzU2libGluZyIsCiAgICAgICAgICAgICAgICBtID0gdC5wYXJlbnROb2RlLAogICAgICAgICAgICAgICAgeSA9IHMgJiYgdC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAgICAgdiA9ICF1ICYmICFzLAogICAgICAgICAgICAgICAgeCA9ICExOwoKICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICBpZiAobykgewogICAgICAgICAgICAgICAgZm9yICg7IGc7KSB7CiAgICAgICAgICAgICAgICAgIGZvciAoZCA9IHQ7IGQgPSBkW2ddOykgewogICAgICAgICAgICAgICAgICAgIGlmIChzID8gZC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSB5IDogMSA9PT0gZC5ub2RlVHlwZSkgcmV0dXJuICExOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBoID0gZyA9ICJvbmx5IiA9PT0gZSAmJiAhaCAmJiAibmV4dFNpYmxpbmciOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiAhMDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChoID0gW2EgPyBtLmZpcnN0Q2hpbGQgOiBtLmxhc3RDaGlsZF0sIGEgJiYgdikgewogICAgICAgICAgICAgICAgZm9yIChkID0gbSwgZiA9IGRbUF0gfHwgKGRbUF0gPSB7fSksIGMgPSBmW2QudW5pcXVlSURdIHx8IChmW2QudW5pcXVlSURdID0ge30pLCBsID0gY1tlXSB8fCBbXSwgcCA9IGxbMF0gPT09IFcgJiYgbFsxXSwgeCA9IHAgJiYgbFsyXSwgZCA9IHAgJiYgbS5jaGlsZE5vZGVzW3BdOyBkID0gKytwICYmIGQgJiYgZFtnXSB8fCAoeCA9IHAgPSAwKSB8fCBoLnBvcCgpOykgewogICAgICAgICAgICAgICAgICBpZiAoMSA9PT0gZC5ub2RlVHlwZSAmJiArK3ggJiYgZCA9PT0gdCkgewogICAgICAgICAgICAgICAgICAgIGNbZV0gPSBbVywgcCwgeF07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHYgJiYgKGQgPSB0LCBmID0gZFtQXSB8fCAoZFtQXSA9IHt9KSwgYyA9IGZbZC51bmlxdWVJRF0gfHwgKGZbZC51bmlxdWVJRF0gPSB7fSksIGwgPSBjW2VdIHx8IFtdLCBwID0gbFswXSA9PT0gVyAmJiBsWzFdLCB4ID0gcCksIHggPT09ICExKSBmb3IgKDsgKGQgPSArK3AgJiYgZCAmJiBkW2ddIHx8ICh4ID0gcCA9IDApIHx8IGgucG9wKCkpICYmICgocyA/IGQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0geSA6IDEgIT09IGQubm9kZVR5cGUpIHx8ICErK3ggfHwgKHYgJiYgKGYgPSBkW1BdIHx8IChkW1BdID0ge30pLCBjID0gZltkLnVuaXF1ZUlEXSB8fCAoZltkLnVuaXF1ZUlEXSA9IHt9KSwgY1tlXSA9IFtXLCB4XSksIGQgIT09IHQpKTspIHsKICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiB4IC09IGksIHggPT09IHIgfHwgeCAlIHIgPT09IDAgJiYgeCAvIHIgPj0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9LAogICAgICAgIFBTRVVETzogZnVuY3Rpb24gUFNFVURPKGUsIG4pIHsKICAgICAgICAgIHZhciBpLAogICAgICAgICAgICAgIG8gPSBULnBzZXVkb3NbZV0gfHwgVC5zZXRGaWx0ZXJzW2UudG9Mb3dlckNhc2UoKV0gfHwgdC5lcnJvcigidW5zdXBwb3J0ZWQgcHNldWRvOiAiICsgZSk7CiAgICAgICAgICByZXR1cm4gb1tQXSA/IG8obikgOiBvLmxlbmd0aCA+IDEgPyAoaSA9IFtlLCBlLCAiIiwgbl0sIFQuc2V0RmlsdGVycy5oYXNPd25Qcm9wZXJ0eShlLnRvTG93ZXJDYXNlKCkpID8gcihmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICAgICBmb3IgKHZhciByLCBpID0gbyhlLCBuKSwgYSA9IGkubGVuZ3RoOyBhLS07KSB7CiAgICAgICAgICAgICAgciA9IGVlKGUsIGlbYV0pLCBlW3JdID0gISh0W3JdID0gaVthXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pIDogZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgcmV0dXJuIG8oZSwgMCwgaSk7CiAgICAgICAgICB9KSA6IG87CiAgICAgICAgfQogICAgICB9LAogICAgICBwc2V1ZG9zOiB7CiAgICAgICAgbm90OiByKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICB2YXIgdCA9IFtdLAogICAgICAgICAgICAgIG4gPSBbXSwKICAgICAgICAgICAgICBpID0gayhlLnJlcGxhY2Uoc2UsICIkMSIpKTsKICAgICAgICAgIHJldHVybiBpW1BdID8gcihmdW5jdGlvbiAoZSwgdCwgbiwgcikgewogICAgICAgICAgICBmb3IgKHZhciBvLCBhID0gaShlLCBudWxsLCByLCBbXSksIHMgPSBlLmxlbmd0aDsgcy0tOykgewogICAgICAgICAgICAgIChvID0gYVtzXSkgJiYgKGVbc10gPSAhKHRbc10gPSBvKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pIDogZnVuY3Rpb24gKGUsIHIsIG8pIHsKICAgICAgICAgICAgcmV0dXJuIHRbMF0gPSBlLCBpKHQsIG51bGwsIG8sIG4pLCB0WzBdID0gbnVsbCwgIW4ucG9wKCk7CiAgICAgICAgICB9OwogICAgICAgIH0pLAogICAgICAgIGhhczogcihmdW5jdGlvbiAoZSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuKSB7CiAgICAgICAgICAgIHJldHVybiB0KGUsIG4pLmxlbmd0aCA+IDA7CiAgICAgICAgICB9OwogICAgICAgIH0pLAogICAgICAgIGNvbnRhaW5zOiByKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICByZXR1cm4gZSA9IGUucmVwbGFjZShiZSwgd2UpLCBmdW5jdGlvbiAodCkgewogICAgICAgICAgICByZXR1cm4gKHQudGV4dENvbnRlbnQgfHwgdC5pbm5lclRleHQgfHwgQyh0KSkuaW5kZXhPZihlKSA+IC0xOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICBsYW5nOiByKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICByZXR1cm4gZGUudGVzdChlIHx8ICIiKSB8fCB0LmVycm9yKCJ1bnN1cHBvcnRlZCBsYW5nOiAiICsgZSksIGUgPSBlLnJlcGxhY2UoYmUsIHdlKS50b0xvd2VyQ2FzZSgpLCBmdW5jdGlvbiAodCkgewogICAgICAgICAgICB2YXIgbjsKCiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpZiAobiA9IF8gPyB0LmxhbmcgOiB0LmdldEF0dHJpYnV0ZSgieG1sOmxhbmciKSB8fCB0LmdldEF0dHJpYnV0ZSgibGFuZyIpKSByZXR1cm4gbiA9IG4udG9Mb3dlckNhc2UoKSwgbiA9PT0gZSB8fCAwID09PSBuLmluZGV4T2YoZSArICItIik7CiAgICAgICAgICAgIH0gd2hpbGUgKCh0ID0gdC5wYXJlbnROb2RlKSAmJiAxID09PSB0Lm5vZGVUeXBlKTsKCiAgICAgICAgICAgIHJldHVybiAhMTsKICAgICAgICAgIH07CiAgICAgICAgfSksCiAgICAgICAgdGFyZ2V0OiBmdW5jdGlvbiB0YXJnZXQodCkgewogICAgICAgICAgdmFyIG4gPSBlLmxvY2F0aW9uICYmIGUubG9jYXRpb24uaGFzaDsKICAgICAgICAgIHJldHVybiBuICYmIG4uc2xpY2UoMSkgPT09IHQuaWQ7CiAgICAgICAgfSwKICAgICAgICByb290OiBmdW5jdGlvbiByb290KGUpIHsKICAgICAgICAgIHJldHVybiBlID09PSBxOwogICAgICAgIH0sCiAgICAgICAgZm9jdXM6IGZ1bmN0aW9uIGZvY3VzKGUpIHsKICAgICAgICAgIHJldHVybiBlID09PSBILmFjdGl2ZUVsZW1lbnQgJiYgKCFILmhhc0ZvY3VzIHx8IEguaGFzRm9jdXMoKSkgJiYgISEoZS50eXBlIHx8IGUuaHJlZiB8fCB+ZS50YWJJbmRleCk7CiAgICAgICAgfSwKICAgICAgICBlbmFibGVkOiBmdW5jdGlvbiBlbmFibGVkKGUpIHsKICAgICAgICAgIHJldHVybiBlLmRpc2FibGVkID09PSAhMTsKICAgICAgICB9LAogICAgICAgIGRpc2FibGVkOiBmdW5jdGlvbiBkaXNhYmxlZChlKSB7CiAgICAgICAgICByZXR1cm4gZS5kaXNhYmxlZCA9PT0gITA7CiAgICAgICAgfSwKICAgICAgICBjaGVja2VkOiBmdW5jdGlvbiBjaGVja2VkKGUpIHsKICAgICAgICAgIHZhciB0ID0gZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuICJpbnB1dCIgPT09IHQgJiYgISFlLmNoZWNrZWQgfHwgIm9wdGlvbiIgPT09IHQgJiYgISFlLnNlbGVjdGVkOwogICAgICAgIH0sCiAgICAgICAgc2VsZWN0ZWQ6IGZ1bmN0aW9uIHNlbGVjdGVkKGUpIHsKICAgICAgICAgIHJldHVybiBlLnBhcmVudE5vZGUgJiYgZS5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXgsIGUuc2VsZWN0ZWQgPT09ICEwOwogICAgICAgIH0sCiAgICAgICAgZW1wdHk6IGZ1bmN0aW9uIGVtcHR5KGUpIHsKICAgICAgICAgIGZvciAoZSA9IGUuZmlyc3RDaGlsZDsgZTsgZSA9IGUubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgaWYgKGUubm9kZVR5cGUgPCA2KSByZXR1cm4gITE7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuICEwOwogICAgICAgIH0sCiAgICAgICAgcGFyZW50OiBmdW5jdGlvbiBwYXJlbnQoZSkgewogICAgICAgICAgcmV0dXJuICFULnBzZXVkb3MuZW1wdHkoZSk7CiAgICAgICAgfSwKICAgICAgICBoZWFkZXI6IGZ1bmN0aW9uIGhlYWRlcihlKSB7CiAgICAgICAgICByZXR1cm4gZ2UudGVzdChlLm5vZGVOYW1lKTsKICAgICAgICB9LAogICAgICAgIGlucHV0OiBmdW5jdGlvbiBpbnB1dChlKSB7CiAgICAgICAgICByZXR1cm4gaGUudGVzdChlLm5vZGVOYW1lKTsKICAgICAgICB9LAogICAgICAgIGJ1dHRvbjogZnVuY3Rpb24gYnV0dG9uKGUpIHsKICAgICAgICAgIHZhciB0ID0gZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuICJpbnB1dCIgPT09IHQgJiYgImJ1dHRvbiIgPT09IGUudHlwZSB8fCAiYnV0dG9uIiA9PT0gdDsKICAgICAgICB9LAogICAgICAgIHRleHQ6IGZ1bmN0aW9uIHRleHQoZSkgewogICAgICAgICAgdmFyIHQ7CiAgICAgICAgICByZXR1cm4gImlucHV0IiA9PT0gZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICYmICJ0ZXh0IiA9PT0gZS50eXBlICYmIChudWxsID09ICh0ID0gZS5nZXRBdHRyaWJ1dGUoInR5cGUiKSkgfHwgInRleHQiID09PSB0LnRvTG93ZXJDYXNlKCkpOwogICAgICAgIH0sCiAgICAgICAgZmlyc3Q6IGwoZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIFswXTsKICAgICAgICB9KSwKICAgICAgICBsYXN0OiBsKGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgICAgICByZXR1cm4gW3QgLSAxXTsKICAgICAgICB9KSwKICAgICAgICBlcTogbChmdW5jdGlvbiAoZSwgdCwgbikgewogICAgICAgICAgcmV0dXJuIFtuIDwgMCA/IG4gKyB0IDogbl07CiAgICAgICAgfSksCiAgICAgICAgZXZlbjogbChmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICAgZm9yICh2YXIgbiA9IDA7IG4gPCB0OyBuICs9IDIpIHsKICAgICAgICAgICAgZS5wdXNoKG4pOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBlOwogICAgICAgIH0pLAogICAgICAgIG9kZDogbChmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICAgZm9yICh2YXIgbiA9IDE7IG4gPCB0OyBuICs9IDIpIHsKICAgICAgICAgICAgZS5wdXNoKG4pOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBlOwogICAgICAgIH0pLAogICAgICAgIGx0OiBsKGZ1bmN0aW9uIChlLCB0LCBuKSB7CiAgICAgICAgICBmb3IgKHZhciByID0gbiA8IDAgPyBuICsgdCA6IG47IC0tciA+PSAwOykgewogICAgICAgICAgICBlLnB1c2gocik7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGU7CiAgICAgICAgfSksCiAgICAgICAgZ3Q6IGwoZnVuY3Rpb24gKGUsIHQsIG4pIHsKICAgICAgICAgIGZvciAodmFyIHIgPSBuIDwgMCA/IG4gKyB0IDogbjsgKytyIDwgdDspIHsKICAgICAgICAgICAgZS5wdXNoKHIpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBlOwogICAgICAgIH0pCiAgICAgIH0KICAgIH0sIFQucHNldWRvcy5udGggPSBULnBzZXVkb3MuZXE7CgogICAgZm9yIChiIGluIHsKICAgICAgcmFkaW86ICEwLAogICAgICBjaGVja2JveDogITAsCiAgICAgIGZpbGU6ICEwLAogICAgICBwYXNzd29yZDogITAsCiAgICAgIGltYWdlOiAhMAogICAgfSkgewogICAgICBULnBzZXVkb3NbYl0gPSBzKGIpOwogICAgfQoKICAgIGZvciAoYiBpbiB7CiAgICAgIHN1Ym1pdDogITAsCiAgICAgIHJlc2V0OiAhMAogICAgfSkgewogICAgICBULnBzZXVkb3NbYl0gPSB1KGIpOwogICAgfQoKICAgIHJldHVybiBmLnByb3RvdHlwZSA9IFQuZmlsdGVycyA9IFQucHNldWRvcywgVC5zZXRGaWx0ZXJzID0gbmV3IGYoKSwgTiA9IHQudG9rZW5pemUgPSBmdW5jdGlvbiAoZSwgbikgewogICAgICB2YXIgciwKICAgICAgICAgIGksCiAgICAgICAgICBvLAogICAgICAgICAgYSwKICAgICAgICAgIHMsCiAgICAgICAgICB1LAogICAgICAgICAgbCwKICAgICAgICAgIGMgPSB6W2UgKyAiICJdOwogICAgICBpZiAoYykgcmV0dXJuIG4gPyAwIDogYy5zbGljZSgwKTsKCiAgICAgIGZvciAocyA9IGUsIHUgPSBbXSwgbCA9IFQucHJlRmlsdGVyOyBzOykgewogICAgICAgIHIgJiYgIShpID0gdWUuZXhlYyhzKSkgfHwgKGkgJiYgKHMgPSBzLnNsaWNlKGlbMF0ubGVuZ3RoKSB8fCBzKSwgdS5wdXNoKG8gPSBbXSkpLCByID0gITEsIChpID0gbGUuZXhlYyhzKSkgJiYgKHIgPSBpLnNoaWZ0KCksIG8ucHVzaCh7CiAgICAgICAgICB2YWx1ZTogciwKICAgICAgICAgIHR5cGU6IGlbMF0ucmVwbGFjZShzZSwgIiAiKQogICAgICAgIH0pLCBzID0gcy5zbGljZShyLmxlbmd0aCkpOwoKICAgICAgICBmb3IgKGEgaW4gVC5maWx0ZXIpIHsKICAgICAgICAgICEoaSA9IHBlW2FdLmV4ZWMocykpIHx8IGxbYV0gJiYgIShpID0gbFthXShpKSkgfHwgKHIgPSBpLnNoaWZ0KCksIG8ucHVzaCh7CiAgICAgICAgICAgIHZhbHVlOiByLAogICAgICAgICAgICB0eXBlOiBhLAogICAgICAgICAgICBtYXRjaGVzOiBpCiAgICAgICAgICB9KSwgcyA9IHMuc2xpY2Uoci5sZW5ndGgpKTsKICAgICAgICB9CgogICAgICAgIGlmICghcikgYnJlYWs7CiAgICAgIH0KCiAgICAgIHJldHVybiBuID8gcy5sZW5ndGggOiBzID8gdC5lcnJvcihlKSA6IHooZSwgdSkuc2xpY2UoMCk7CiAgICB9LCBrID0gdC5jb21waWxlID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgdmFyIG4sCiAgICAgICAgICByID0gW10sCiAgICAgICAgICBpID0gW10sCiAgICAgICAgICBvID0gWFtlICsgIiAiXTsKCiAgICAgIGlmICghbykgewogICAgICAgIGZvciAodCB8fCAodCA9IE4oZSkpLCBuID0gdC5sZW5ndGg7IG4tLTspIHsKICAgICAgICAgIG8gPSB2KHRbbl0pLCBvW1BdID8gci5wdXNoKG8pIDogaS5wdXNoKG8pOwogICAgICAgIH0KCiAgICAgICAgbyA9IFgoZSwgeChpLCByKSksIG8uc2VsZWN0b3IgPSBlOwogICAgICB9CgogICAgICByZXR1cm4gbzsKICAgIH0sIFMgPSB0LnNlbGVjdCA9IGZ1bmN0aW9uIChlLCB0LCBuLCByKSB7CiAgICAgIHZhciBpLAogICAgICAgICAgbywKICAgICAgICAgIGEsCiAgICAgICAgICBzLAogICAgICAgICAgdSwKICAgICAgICAgIGwgPSAiZnVuY3Rpb24iID09IHR5cGVvZiBlICYmIGUsCiAgICAgICAgICBmID0gIXIgJiYgTihlID0gbC5zZWxlY3RvciB8fCBlKTsKCiAgICAgIGlmIChuID0gbiB8fCBbXSwgMSA9PT0gZi5sZW5ndGgpIHsKICAgICAgICBpZiAobyA9IGZbMF0gPSBmWzBdLnNsaWNlKDApLCBvLmxlbmd0aCA+IDIgJiYgIklEIiA9PT0gKGEgPSBvWzBdKS50eXBlICYmIHcuZ2V0QnlJZCAmJiA5ID09PSB0Lm5vZGVUeXBlICYmIF8gJiYgVC5yZWxhdGl2ZVtvWzFdLnR5cGVdKSB7CiAgICAgICAgICBpZiAodCA9IChULmZpbmQuSUQoYS5tYXRjaGVzWzBdLnJlcGxhY2UoYmUsIHdlKSwgdCkgfHwgW10pWzBdLCAhdCkgcmV0dXJuIG47CiAgICAgICAgICBsICYmICh0ID0gdC5wYXJlbnROb2RlKSwgZSA9IGUuc2xpY2Uoby5zaGlmdCgpLnZhbHVlLmxlbmd0aCk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKGkgPSBwZS5uZWVkc0NvbnRleHQudGVzdChlKSA/IDAgOiBvLmxlbmd0aDsgaS0tICYmIChhID0gb1tpXSwgIVQucmVsYXRpdmVbcyA9IGEudHlwZV0pOykgewogICAgICAgICAgaWYgKCh1ID0gVC5maW5kW3NdKSAmJiAociA9IHUoYS5tYXRjaGVzWzBdLnJlcGxhY2UoYmUsIHdlKSwgdmUudGVzdChvWzBdLnR5cGUpICYmIGModC5wYXJlbnROb2RlKSB8fCB0KSkpIHsKICAgICAgICAgICAgaWYgKG8uc3BsaWNlKGksIDEpLCBlID0gci5sZW5ndGggJiYgZChvKSwgIWUpIHJldHVybiBRLmFwcGx5KG4sIHIpLCBuOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiAobCB8fCBrKGUsIGYpKShyLCB0LCAhXywgbiwgIXQgfHwgdmUudGVzdChlKSAmJiBjKHQucGFyZW50Tm9kZSkgfHwgdCksIG47CiAgICB9LCB3LnNvcnRTdGFibGUgPSBQLnNwbGl0KCIiKS5zb3J0KFUpLmpvaW4oIiIpID09PSBQLCB3LmRldGVjdER1cGxpY2F0ZXMgPSAhIWosIEwoKSwgdy5zb3J0RGV0YWNoZWQgPSBpKGZ1bmN0aW9uIChlKSB7CiAgICAgIHJldHVybiAxICYgZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihILmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsKICAgIH0pLCBpKGZ1bmN0aW9uIChlKSB7CiAgICAgIHJldHVybiBlLmlubmVySFRNTCA9ICI8YSBocmVmPScjJz48L2E+IiwgIiMiID09PSBlLmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJocmVmIik7CiAgICB9KSB8fCBvKCJ0eXBlfGhyZWZ8aGVpZ2h0fHdpZHRoIiwgZnVuY3Rpb24gKGUsIHQsIG4pIHsKICAgICAgaWYgKCFuKSByZXR1cm4gZS5nZXRBdHRyaWJ1dGUodCwgInR5cGUiID09PSB0LnRvTG93ZXJDYXNlKCkgPyAxIDogMik7CiAgICB9KSwgdy5hdHRyaWJ1dGVzICYmIGkoZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuIGUuaW5uZXJIVE1MID0gIjxpbnB1dC8+IiwgZS5maXJzdENoaWxkLnNldEF0dHJpYnV0ZSgidmFsdWUiLCAiIiksICIiID09PSBlLmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpOwogICAgfSkgfHwgbygidmFsdWUiLCBmdW5jdGlvbiAoZSwgdCwgbikgewogICAgICBpZiAoIW4gJiYgImlucHV0IiA9PT0gZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKSByZXR1cm4gZS5kZWZhdWx0VmFsdWU7CiAgICB9KSwgaShmdW5jdGlvbiAoZSkgewogICAgICByZXR1cm4gbnVsbCA9PSBlLmdldEF0dHJpYnV0ZSgiZGlzYWJsZWQiKTsKICAgIH0pIHx8IG8odGUsIGZ1bmN0aW9uIChlLCB0LCBuKSB7CiAgICAgIHZhciByOwogICAgICBpZiAoIW4pIHJldHVybiBlW3RdID09PSAhMCA/IHQudG9Mb3dlckNhc2UoKSA6IChyID0gZS5nZXRBdHRyaWJ1dGVOb2RlKHQpKSAmJiByLnNwZWNpZmllZCA/IHIudmFsdWUgOiBudWxsOwogICAgfSksIHQ7CiAgfShlKTsKCiAgcGUuZmluZCA9IHZlLCBwZS5leHByID0gdmUuc2VsZWN0b3JzLCBwZS5leHByWyI6Il0gPSBwZS5leHByLnBzZXVkb3MsIHBlLnVuaXF1ZVNvcnQgPSBwZS51bmlxdWUgPSB2ZS51bmlxdWVTb3J0LCBwZS50ZXh0ID0gdmUuZ2V0VGV4dCwgcGUuaXNYTUxEb2MgPSB2ZS5pc1hNTCwgcGUuY29udGFpbnMgPSB2ZS5jb250YWluczsKCiAgdmFyIHhlID0gZnVuY3Rpb24geGUoZSwgdCwgbikgewogICAgZm9yICh2YXIgciA9IFtdLCBpID0gdm9pZCAwICE9PSBuOyAoZSA9IGVbdF0pICYmIDkgIT09IGUubm9kZVR5cGU7KSB7CiAgICAgIGlmICgxID09PSBlLm5vZGVUeXBlKSB7CiAgICAgICAgaWYgKGkgJiYgcGUoZSkuaXMobikpIGJyZWFrOwogICAgICAgIHIucHVzaChlKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByOwogIH0sCiAgICAgIGJlID0gZnVuY3Rpb24gYmUoZSwgdCkgewogICAgZm9yICh2YXIgbiA9IFtdOyBlOyBlID0gZS5uZXh0U2libGluZykgewogICAgICAxID09PSBlLm5vZGVUeXBlICYmIGUgIT09IHQgJiYgbi5wdXNoKGUpOwogICAgfQoKICAgIHJldHVybiBuOwogIH0sCiAgICAgIHdlID0gcGUuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQsCiAgICAgIFRlID0gL148KFtcdy1dKylccypcLz8+KD86PFwvXDE+fCkkLywKICAgICAgQ2UgPSAvXi5bXjojXFtcLixdKiQvOwoKICBwZS5maWx0ZXIgPSBmdW5jdGlvbiAoZSwgdCwgbikgewogICAgdmFyIHIgPSB0WzBdOwogICAgcmV0dXJuIG4gJiYgKGUgPSAiOm5vdCgiICsgZSArICIpIiksIDEgPT09IHQubGVuZ3RoICYmIDEgPT09IHIubm9kZVR5cGUgPyBwZS5maW5kLm1hdGNoZXNTZWxlY3RvcihyLCBlKSA/IFtyXSA6IFtdIDogcGUuZmluZC5tYXRjaGVzKGUsIHBlLmdyZXAodCwgZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuIDEgPT09IGUubm9kZVR5cGU7CiAgICB9KSk7CiAgfSwgcGUuZm4uZXh0ZW5kKHsKICAgIGZpbmQ6IGZ1bmN0aW9uIGZpbmQoZSkgewogICAgICB2YXIgdCwKICAgICAgICAgIG4gPSBbXSwKICAgICAgICAgIHIgPSB0aGlzLAogICAgICAgICAgaSA9IHIubGVuZ3RoOwogICAgICBpZiAoInN0cmluZyIgIT0gdHlwZW9mIGUpIHJldHVybiB0aGlzLnB1c2hTdGFjayhwZShlKS5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgIGZvciAodCA9IDA7IHQgPCBpOyB0KyspIHsKICAgICAgICAgIGlmIChwZS5jb250YWlucyhyW3RdLCB0aGlzKSkgcmV0dXJuICEwOwogICAgICAgIH0KICAgICAgfSkpOwoKICAgICAgZm9yICh0ID0gMDsgdCA8IGk7IHQrKykgewogICAgICAgIHBlLmZpbmQoZSwgclt0XSwgbik7CiAgICAgIH0KCiAgICAgIHJldHVybiBuID0gdGhpcy5wdXNoU3RhY2soaSA+IDEgPyBwZS51bmlxdWUobikgOiBuKSwgbi5zZWxlY3RvciA9IHRoaXMuc2VsZWN0b3IgPyB0aGlzLnNlbGVjdG9yICsgIiAiICsgZSA6IGUsIG47CiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbiBmaWx0ZXIoZSkgewogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2socih0aGlzLCBlIHx8IFtdLCAhMSkpOwogICAgfSwKICAgIG5vdDogZnVuY3Rpb24gbm90KGUpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHIodGhpcywgZSB8fCBbXSwgITApKTsKICAgIH0sCiAgICBpczogZnVuY3Rpb24gaXMoZSkgewogICAgICByZXR1cm4gISFyKHRoaXMsICJzdHJpbmciID09IHR5cGVvZiBlICYmIHdlLnRlc3QoZSkgPyBwZShlKSA6IGUgfHwgW10sICExKS5sZW5ndGg7CiAgICB9CiAgfSk7CgogIHZhciBFZSwKICAgICAgTmUgPSAvXig/OlxzKig8W1x3XFddKz4pW14+XSp8IyhbXHctXSopKSQvLAogICAgICBrZSA9IHBlLmZuLmluaXQgPSBmdW5jdGlvbiAoZSwgdCwgbikgewogICAgdmFyIHIsIGk7CiAgICBpZiAoIWUpIHJldHVybiB0aGlzOwoKICAgIGlmIChuID0gbiB8fCBFZSwgInN0cmluZyIgPT0gdHlwZW9mIGUpIHsKICAgICAgaWYgKHIgPSAiPCIgPT09IGUuY2hhckF0KDApICYmICI+IiA9PT0gZS5jaGFyQXQoZS5sZW5ndGggLSAxKSAmJiBlLmxlbmd0aCA+PSAzID8gW251bGwsIGUsIG51bGxdIDogTmUuZXhlYyhlKSwgIXIgfHwgIXJbMV0gJiYgdCkgcmV0dXJuICF0IHx8IHQuanF1ZXJ5ID8gKHQgfHwgbikuZmluZChlKSA6IHRoaXMuY29uc3RydWN0b3IodCkuZmluZChlKTsKCiAgICAgIGlmIChyWzFdKSB7CiAgICAgICAgaWYgKHQgPSB0IGluc3RhbmNlb2YgcGUgPyB0WzBdIDogdCwgcGUubWVyZ2UodGhpcywgcGUucGFyc2VIVE1MKHJbMV0sIHQgJiYgdC5ub2RlVHlwZSA/IHQub3duZXJEb2N1bWVudCB8fCB0IDogcmUsICEwKSksIFRlLnRlc3QoclsxXSkgJiYgcGUuaXNQbGFpbk9iamVjdCh0KSkgZm9yIChyIGluIHQpIHsKICAgICAgICAgIHBlLmlzRnVuY3Rpb24odGhpc1tyXSkgPyB0aGlzW3JdKHRbcl0pIDogdGhpcy5hdHRyKHIsIHRbcl0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgaWYgKGkgPSByZS5nZXRFbGVtZW50QnlJZChyWzJdKSwgaSAmJiBpLnBhcmVudE5vZGUpIHsKICAgICAgICBpZiAoaS5pZCAhPT0gclsyXSkgcmV0dXJuIEVlLmZpbmQoZSk7CiAgICAgICAgdGhpcy5sZW5ndGggPSAxLCB0aGlzWzBdID0gaTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuY29udGV4dCA9IHJlLCB0aGlzLnNlbGVjdG9yID0gZSwgdGhpczsKICAgIH0KCiAgICByZXR1cm4gZS5ub2RlVHlwZSA/ICh0aGlzLmNvbnRleHQgPSB0aGlzWzBdID0gZSwgdGhpcy5sZW5ndGggPSAxLCB0aGlzKSA6IHBlLmlzRnVuY3Rpb24oZSkgPyAidW5kZWZpbmVkIiAhPSB0eXBlb2Ygbi5yZWFkeSA/IG4ucmVhZHkoZSkgOiBlKHBlKSA6ICh2b2lkIDAgIT09IGUuc2VsZWN0b3IgJiYgKHRoaXMuc2VsZWN0b3IgPSBlLnNlbGVjdG9yLCB0aGlzLmNvbnRleHQgPSBlLmNvbnRleHQpLCBwZS5tYWtlQXJyYXkoZSwgdGhpcykpOwogIH07CgogIGtlLnByb3RvdHlwZSA9IHBlLmZuLCBFZSA9IHBlKHJlKTsKICB2YXIgU2UgPSAvXig/OnBhcmVudHN8cHJldig/OlVudGlsfEFsbCkpLywKICAgICAgQWUgPSB7CiAgICBjaGlsZHJlbjogITAsCiAgICBjb250ZW50czogITAsCiAgICBuZXh0OiAhMCwKICAgIHByZXY6ICEwCiAgfTsKICBwZS5mbi5leHRlbmQoewogICAgaGFzOiBmdW5jdGlvbiBoYXMoZSkgewogICAgICB2YXIgdCwKICAgICAgICAgIG4gPSBwZShlLCB0aGlzKSwKICAgICAgICAgIHIgPSBuLmxlbmd0aDsKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgICBmb3IgKHQgPSAwOyB0IDwgcjsgdCsrKSB7CiAgICAgICAgICBpZiAocGUuY29udGFpbnModGhpcywgblt0XSkpIHJldHVybiAhMDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGNsb3Nlc3Q6IGZ1bmN0aW9uIGNsb3Nlc3QoZSwgdCkgewogICAgICBmb3IgKHZhciBuLCByID0gMCwgaSA9IHRoaXMubGVuZ3RoLCBvID0gW10sIGEgPSB3ZS50ZXN0KGUpIHx8ICJzdHJpbmciICE9IHR5cGVvZiBlID8gcGUoZSwgdCB8fCB0aGlzLmNvbnRleHQpIDogMDsgciA8IGk7IHIrKykgewogICAgICAgIGZvciAobiA9IHRoaXNbcl07IG4gJiYgbiAhPT0gdDsgbiA9IG4ucGFyZW50Tm9kZSkgewogICAgICAgICAgaWYgKG4ubm9kZVR5cGUgPCAxMSAmJiAoYSA/IGEuaW5kZXgobikgPiAtMSA6IDEgPT09IG4ubm9kZVR5cGUgJiYgcGUuZmluZC5tYXRjaGVzU2VsZWN0b3IobiwgZSkpKSB7CiAgICAgICAgICAgIG8ucHVzaChuKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soby5sZW5ndGggPiAxID8gcGUudW5pcXVlU29ydChvKSA6IG8pOwogICAgfSwKICAgIGluZGV4OiBmdW5jdGlvbiBpbmRleChlKSB7CiAgICAgIHJldHVybiBlID8gInN0cmluZyIgPT0gdHlwZW9mIGUgPyBwZS5pbkFycmF5KHRoaXNbMF0sIHBlKGUpKSA6IHBlLmluQXJyYXkoZS5qcXVlcnkgPyBlWzBdIDogZSwgdGhpcykgOiB0aGlzWzBdICYmIHRoaXNbMF0ucGFyZW50Tm9kZSA/IHRoaXMuZmlyc3QoKS5wcmV2QWxsKCkubGVuZ3RoIDogLTE7CiAgICB9LAogICAgYWRkOiBmdW5jdGlvbiBhZGQoZSwgdCkgewogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2socGUudW5pcXVlU29ydChwZS5tZXJnZSh0aGlzLmdldCgpLCBwZShlLCB0KSkpKTsKICAgIH0sCiAgICBhZGRCYWNrOiBmdW5jdGlvbiBhZGRCYWNrKGUpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG51bGwgPT0gZSA/IHRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoZSkpOwogICAgfQogIH0pLCBwZS5lYWNoKHsKICAgIHBhcmVudDogZnVuY3Rpb24gcGFyZW50KGUpIHsKICAgICAgdmFyIHQgPSBlLnBhcmVudE5vZGU7CiAgICAgIHJldHVybiB0ICYmIDExICE9PSB0Lm5vZGVUeXBlID8gdCA6IG51bGw7CiAgICB9LAogICAgcGFyZW50czogZnVuY3Rpb24gcGFyZW50cyhlKSB7CiAgICAgIHJldHVybiB4ZShlLCAicGFyZW50Tm9kZSIpOwogICAgfSwKICAgIHBhcmVudHNVbnRpbDogZnVuY3Rpb24gcGFyZW50c1VudGlsKGUsIHQsIG4pIHsKICAgICAgcmV0dXJuIHhlKGUsICJwYXJlbnROb2RlIiwgbik7CiAgICB9LAogICAgbmV4dDogZnVuY3Rpb24gbmV4dChlKSB7CiAgICAgIHJldHVybiBpKGUsICJuZXh0U2libGluZyIpOwogICAgfSwKICAgIHByZXY6IGZ1bmN0aW9uIHByZXYoZSkgewogICAgICByZXR1cm4gaShlLCAicHJldmlvdXNTaWJsaW5nIik7CiAgICB9LAogICAgbmV4dEFsbDogZnVuY3Rpb24gbmV4dEFsbChlKSB7CiAgICAgIHJldHVybiB4ZShlLCAibmV4dFNpYmxpbmciKTsKICAgIH0sCiAgICBwcmV2QWxsOiBmdW5jdGlvbiBwcmV2QWxsKGUpIHsKICAgICAgcmV0dXJuIHhlKGUsICJwcmV2aW91c1NpYmxpbmciKTsKICAgIH0sCiAgICBuZXh0VW50aWw6IGZ1bmN0aW9uIG5leHRVbnRpbChlLCB0LCBuKSB7CiAgICAgIHJldHVybiB4ZShlLCAibmV4dFNpYmxpbmciLCBuKTsKICAgIH0sCiAgICBwcmV2VW50aWw6IGZ1bmN0aW9uIHByZXZVbnRpbChlLCB0LCBuKSB7CiAgICAgIHJldHVybiB4ZShlLCAicHJldmlvdXNTaWJsaW5nIiwgbik7CiAgICB9LAogICAgc2libGluZ3M6IGZ1bmN0aW9uIHNpYmxpbmdzKGUpIHsKICAgICAgcmV0dXJuIGJlKChlLnBhcmVudE5vZGUgfHwge30pLmZpcnN0Q2hpbGQsIGUpOwogICAgfSwKICAgIGNoaWxkcmVuOiBmdW5jdGlvbiBjaGlsZHJlbihlKSB7CiAgICAgIHJldHVybiBiZShlLmZpcnN0Q2hpbGQpOwogICAgfSwKICAgIGNvbnRlbnRzOiBmdW5jdGlvbiBjb250ZW50cyhlKSB7CiAgICAgIHJldHVybiBwZS5ub2RlTmFtZShlLCAiaWZyYW1lIikgPyBlLmNvbnRlbnREb2N1bWVudCB8fCBlLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQgOiBwZS5tZXJnZShbXSwgZS5jaGlsZE5vZGVzKTsKICAgIH0KICB9LCBmdW5jdGlvbiAoZSwgdCkgewogICAgcGUuZm5bZV0gPSBmdW5jdGlvbiAobiwgcikgewogICAgICB2YXIgaSA9IHBlLm1hcCh0aGlzLCB0LCBuKTsKICAgICAgcmV0dXJuICJVbnRpbCIgIT09IGUuc2xpY2UoLTUpICYmIChyID0gbiksIHIgJiYgInN0cmluZyIgPT0gdHlwZW9mIHIgJiYgKGkgPSBwZS5maWx0ZXIociwgaSkpLCB0aGlzLmxlbmd0aCA+IDEgJiYgKEFlW2VdIHx8IChpID0gcGUudW5pcXVlU29ydChpKSksIFNlLnRlc3QoZSkgJiYgKGkgPSBpLnJldmVyc2UoKSkpLCB0aGlzLnB1c2hTdGFjayhpKTsKICAgIH07CiAgfSk7CiAgdmFyIERlID0gL1xTKy9nOwogIHBlLkNhbGxiYWNrcyA9IGZ1bmN0aW9uIChlKSB7CiAgICBlID0gInN0cmluZyIgPT0gdHlwZW9mIGUgPyBvKGUpIDogcGUuZXh0ZW5kKHt9LCBlKTsKCiAgICB2YXIgdCwKICAgICAgICBuLAogICAgICAgIHIsCiAgICAgICAgaSwKICAgICAgICBhID0gW10sCiAgICAgICAgcyA9IFtdLAogICAgICAgIHUgPSAtMSwKICAgICAgICBsID0gZnVuY3Rpb24gbCgpIHsKICAgICAgZm9yIChpID0gZS5vbmNlLCByID0gdCA9ICEwOyBzLmxlbmd0aDsgdSA9IC0xKSB7CiAgICAgICAgZm9yIChuID0gcy5zaGlmdCgpOyArK3UgPCBhLmxlbmd0aDspIHsKICAgICAgICAgIGFbdV0uYXBwbHkoblswXSwgblsxXSkgPT09ICExICYmIGUuc3RvcE9uRmFsc2UgJiYgKHUgPSBhLmxlbmd0aCwgbiA9ICExKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGUubWVtb3J5IHx8IChuID0gITEpLCB0ID0gITEsIGkgJiYgKGEgPSBuID8gW10gOiAiIik7CiAgICB9LAogICAgICAgIGMgPSB7CiAgICAgIGFkZDogZnVuY3Rpb24gYWRkKCkgewogICAgICAgIHJldHVybiBhICYmIChuICYmICF0ICYmICh1ID0gYS5sZW5ndGggLSAxLCBzLnB1c2gobikpLCBmdW5jdGlvbiByKHQpIHsKICAgICAgICAgIHBlLmVhY2godCwgZnVuY3Rpb24gKHQsIG4pIHsKICAgICAgICAgICAgcGUuaXNGdW5jdGlvbihuKSA/IGUudW5pcXVlICYmIGMuaGFzKG4pIHx8IGEucHVzaChuKSA6IG4gJiYgbi5sZW5ndGggJiYgInN0cmluZyIgIT09IHBlLnR5cGUobikgJiYgcihuKTsKICAgICAgICAgIH0pOwogICAgICAgIH0oYXJndW1lbnRzKSwgbiAmJiAhdCAmJiBsKCkpLCB0aGlzOwogICAgICB9LAogICAgICByZW1vdmU6IGZ1bmN0aW9uIHJlbW92ZSgpIHsKICAgICAgICByZXR1cm4gcGUuZWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgICAgICBmb3IgKHZhciBuOyAobiA9IHBlLmluQXJyYXkodCwgYSwgbikpID4gLTE7KSB7CiAgICAgICAgICAgIGEuc3BsaWNlKG4sIDEpLCBuIDw9IHUgJiYgdS0tOwogICAgICAgICAgfQogICAgICAgIH0pLCB0aGlzOwogICAgICB9LAogICAgICBoYXM6IGZ1bmN0aW9uIGhhcyhlKSB7CiAgICAgICAgcmV0dXJuIGUgPyBwZS5pbkFycmF5KGUsIGEpID4gLTEgOiBhLmxlbmd0aCA+IDA7CiAgICAgIH0sCiAgICAgIGVtcHR5OiBmdW5jdGlvbiBlbXB0eSgpIHsKICAgICAgICByZXR1cm4gYSAmJiAoYSA9IFtdKSwgdGhpczsKICAgICAgfSwKICAgICAgZGlzYWJsZTogZnVuY3Rpb24gZGlzYWJsZSgpIHsKICAgICAgICByZXR1cm4gaSA9IHMgPSBbXSwgYSA9IG4gPSAiIiwgdGhpczsKICAgICAgfSwKICAgICAgZGlzYWJsZWQ6IGZ1bmN0aW9uIGRpc2FibGVkKCkgewogICAgICAgIHJldHVybiAhYTsKICAgICAgfSwKICAgICAgbG9jazogZnVuY3Rpb24gbG9jaygpIHsKICAgICAgICByZXR1cm4gaSA9ICEwLCBuIHx8IGMuZGlzYWJsZSgpLCB0aGlzOwogICAgICB9LAogICAgICBsb2NrZWQ6IGZ1bmN0aW9uIGxvY2tlZCgpIHsKICAgICAgICByZXR1cm4gISFpOwogICAgICB9LAogICAgICBmaXJlV2l0aDogZnVuY3Rpb24gZmlyZVdpdGgoZSwgbikgewogICAgICAgIHJldHVybiBpIHx8IChuID0gbiB8fCBbXSwgbiA9IFtlLCBuLnNsaWNlID8gbi5zbGljZSgpIDogbl0sIHMucHVzaChuKSwgdCB8fCBsKCkpLCB0aGlzOwogICAgICB9LAogICAgICBmaXJlOiBmdW5jdGlvbiBmaXJlKCkgewogICAgICAgIHJldHVybiBjLmZpcmVXaXRoKHRoaXMsIGFyZ3VtZW50cyksIHRoaXM7CiAgICAgIH0sCiAgICAgIGZpcmVkOiBmdW5jdGlvbiBmaXJlZCgpIHsKICAgICAgICByZXR1cm4gISFyOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBjOwogIH0sIHBlLmV4dGVuZCh7CiAgICBEZWZlcnJlZDogZnVuY3Rpb24gRGVmZXJyZWQoZSkgewogICAgICB2YXIgdCA9IFtbInJlc29sdmUiLCAiZG9uZSIsIHBlLkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgInJlc29sdmVkIl0sIFsicmVqZWN0IiwgImZhaWwiLCBwZS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZWplY3RlZCJdLCBbIm5vdGlmeSIsICJwcm9ncmVzcyIsIHBlLkNhbGxiYWNrcygibWVtb3J5IildXSwKICAgICAgICAgIG4gPSAicGVuZGluZyIsCiAgICAgICAgICByID0gewogICAgICAgIHN0YXRlOiBmdW5jdGlvbiBzdGF0ZSgpIHsKICAgICAgICAgIHJldHVybiBuOwogICAgICAgIH0sCiAgICAgICAgYWx3YXlzOiBmdW5jdGlvbiBhbHdheXMoKSB7CiAgICAgICAgICByZXR1cm4gaS5kb25lKGFyZ3VtZW50cykuZmFpbChhcmd1bWVudHMpLCB0aGlzOwogICAgICAgIH0sCiAgICAgICAgdGhlbjogZnVuY3Rpb24gdGhlbigpIHsKICAgICAgICAgIHZhciBlID0gYXJndW1lbnRzOwogICAgICAgICAgcmV0dXJuIHBlLkRlZmVycmVkKGZ1bmN0aW9uIChuKSB7CiAgICAgICAgICAgIHBlLmVhY2godCwgZnVuY3Rpb24gKHQsIG8pIHsKICAgICAgICAgICAgICB2YXIgYSA9IHBlLmlzRnVuY3Rpb24oZVt0XSkgJiYgZVt0XTsKICAgICAgICAgICAgICBpW29bMV1dKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBlID0gYSAmJiBhLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICBlICYmIHBlLmlzRnVuY3Rpb24oZS5wcm9taXNlKSA/IGUucHJvbWlzZSgpLnByb2dyZXNzKG4ubm90aWZ5KS5kb25lKG4ucmVzb2x2ZSkuZmFpbChuLnJlamVjdCkgOiBuW29bMF0gKyAiV2l0aCJdKHRoaXMgPT09IHIgPyBuLnByb21pc2UoKSA6IHRoaXMsIGEgPyBbZV0gOiBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSwgZSA9IG51bGw7CiAgICAgICAgICB9KS5wcm9taXNlKCk7CiAgICAgICAgfSwKICAgICAgICBwcm9taXNlOiBmdW5jdGlvbiBwcm9taXNlKGUpIHsKICAgICAgICAgIHJldHVybiBudWxsICE9IGUgPyBwZS5leHRlbmQoZSwgcikgOiByOwogICAgICAgIH0KICAgICAgfSwKICAgICAgICAgIGkgPSB7fTsKICAgICAgcmV0dXJuIHIucGlwZSA9IHIudGhlbiwgcGUuZWFjaCh0LCBmdW5jdGlvbiAoZSwgbykgewogICAgICAgIHZhciBhID0gb1syXSwKICAgICAgICAgICAgcyA9IG9bM107CiAgICAgICAgcltvWzFdXSA9IGEuYWRkLCBzICYmIGEuYWRkKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIG4gPSBzOwogICAgICAgIH0sIHRbMSBeIGVdWzJdLmRpc2FibGUsIHRbMl1bMl0ubG9jayksIGlbb1swXV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gaVtvWzBdICsgIldpdGgiXSh0aGlzID09PSBpID8gciA6IHRoaXMsIGFyZ3VtZW50cyksIHRoaXM7CiAgICAgICAgfSwgaVtvWzBdICsgIldpdGgiXSA9IGEuZmlyZVdpdGg7CiAgICAgIH0pLCByLnByb21pc2UoaSksIGUgJiYgZS5jYWxsKGksIGkpLCBpOwogICAgfSwKICAgIHdoZW46IGZ1bmN0aW9uIHdoZW4oZSkgewogICAgICB2YXIgdCwKICAgICAgICAgIG4sCiAgICAgICAgICByLAogICAgICAgICAgaSA9IDAsCiAgICAgICAgICBvID0gaWUuY2FsbChhcmd1bWVudHMpLAogICAgICAgICAgYSA9IG8ubGVuZ3RoLAogICAgICAgICAgcyA9IDEgIT09IGEgfHwgZSAmJiBwZS5pc0Z1bmN0aW9uKGUucHJvbWlzZSkgPyBhIDogMCwKICAgICAgICAgIHUgPSAxID09PSBzID8gZSA6IHBlLkRlZmVycmVkKCksCiAgICAgICAgICBsID0gZnVuY3Rpb24gbChlLCBuLCByKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICBuW2VdID0gdGhpcywgcltlXSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gaWUuY2FsbChhcmd1bWVudHMpIDogaSwgciA9PT0gdCA/IHUubm90aWZ5V2l0aChuLCByKSA6IC0tcyB8fCB1LnJlc29sdmVXaXRoKG4sIHIpOwogICAgICAgIH07CiAgICAgIH07CgogICAgICBpZiAoYSA+IDEpIGZvciAodCA9IG5ldyBBcnJheShhKSwgbiA9IG5ldyBBcnJheShhKSwgciA9IG5ldyBBcnJheShhKTsgaSA8IGE7IGkrKykgewogICAgICAgIG9baV0gJiYgcGUuaXNGdW5jdGlvbihvW2ldLnByb21pc2UpID8gb1tpXS5wcm9taXNlKCkucHJvZ3Jlc3MobChpLCBuLCB0KSkuZG9uZShsKGksIHIsIG8pKS5mYWlsKHUucmVqZWN0KSA6IC0tczsKICAgICAgfQogICAgICByZXR1cm4gcyB8fCB1LnJlc29sdmVXaXRoKHIsIG8pLCB1LnByb21pc2UoKTsKICAgIH0KICB9KTsKICB2YXIgamU7CiAgcGUuZm4ucmVhZHkgPSBmdW5jdGlvbiAoZSkgewogICAgcmV0dXJuIHBlLnJlYWR5LnByb21pc2UoKS5kb25lKGUpLCB0aGlzOwogIH0sIHBlLmV4dGVuZCh7CiAgICBpc1JlYWR5OiAhMSwKICAgIHJlYWR5V2FpdDogMSwKICAgIGhvbGRSZWFkeTogZnVuY3Rpb24gaG9sZFJlYWR5KGUpIHsKICAgICAgZSA/IHBlLnJlYWR5V2FpdCsrIDogcGUucmVhZHkoITApOwogICAgfSwKICAgIHJlYWR5OiBmdW5jdGlvbiByZWFkeShlKSB7CiAgICAgIChlID09PSAhMCA/IC0tcGUucmVhZHlXYWl0IDogcGUuaXNSZWFkeSkgfHwgKHBlLmlzUmVhZHkgPSAhMCwgZSAhPT0gITAgJiYgLS1wZS5yZWFkeVdhaXQgPiAwIHx8IChqZS5yZXNvbHZlV2l0aChyZSwgW3BlXSksIHBlLmZuLnRyaWdnZXJIYW5kbGVyICYmIChwZShyZSkudHJpZ2dlckhhbmRsZXIoInJlYWR5IiksIHBlKHJlKS5vZmYoInJlYWR5IikpKSk7CiAgICB9CiAgfSksIHBlLnJlYWR5LnByb21pc2UgPSBmdW5jdGlvbiAodCkgewogICAgaWYgKCFqZSkgaWYgKGplID0gcGUuRGVmZXJyZWQoKSwgImNvbXBsZXRlIiA9PT0gcmUucmVhZHlTdGF0ZSB8fCAibG9hZGluZyIgIT09IHJlLnJlYWR5U3RhdGUgJiYgIXJlLmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCkgZS5zZXRUaW1lb3V0KHBlLnJlYWR5KTtlbHNlIGlmIChyZS5hZGRFdmVudExpc3RlbmVyKSByZS5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgcyksIGUuYWRkRXZlbnRMaXN0ZW5lcigibG9hZCIsIHMpO2Vsc2UgewogICAgICByZS5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgcyksIGUuYXR0YWNoRXZlbnQoIm9ubG9hZCIsIHMpOwogICAgICB2YXIgbiA9ICExOwoKICAgICAgdHJ5IHsKICAgICAgICBuID0gbnVsbCA9PSBlLmZyYW1lRWxlbWVudCAmJiByZS5kb2N1bWVudEVsZW1lbnQ7CiAgICAgIH0gY2F0Y2ggKHIpIHt9CgogICAgICBuICYmIG4uZG9TY3JvbGwgJiYgIWZ1bmN0aW9uIGkoKSB7CiAgICAgICAgaWYgKCFwZS5pc1JlYWR5KSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBuLmRvU2Nyb2xsKCJsZWZ0Iik7CiAgICAgICAgICB9IGNhdGNoICh0KSB7CiAgICAgICAgICAgIHJldHVybiBlLnNldFRpbWVvdXQoaSwgNTApOwogICAgICAgICAgfQoKICAgICAgICAgIGEoKSwgcGUucmVhZHkoKTsKICAgICAgICB9CiAgICAgIH0oKTsKICAgIH0KICAgIHJldHVybiBqZS5wcm9taXNlKHQpOwogIH0sIHBlLnJlYWR5LnByb21pc2UoKTsKICB2YXIgTGU7CgogIGZvciAoTGUgaW4gcGUoZmUpKSB7CiAgICBicmVhazsKICB9CgogIGZlLm93bkZpcnN0ID0gIjAiID09PSBMZSwgZmUuaW5saW5lQmxvY2tOZWVkc0xheW91dCA9ICExLCBwZShmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSwgdCwgbiwgcjsKICAgIG4gPSByZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWzBdLCBuICYmIG4uc3R5bGUgJiYgKHQgPSByZS5jcmVhdGVFbGVtZW50KCJkaXYiKSwgciA9IHJlLmNyZWF0ZUVsZW1lbnQoImRpdiIpLCByLnN0eWxlLmNzc1RleHQgPSAicG9zaXRpb246YWJzb2x1dGU7Ym9yZGVyOjA7d2lkdGg6MDtoZWlnaHQ6MDt0b3A6MDtsZWZ0Oi05OTk5cHgiLCBuLmFwcGVuZENoaWxkKHIpLmFwcGVuZENoaWxkKHQpLCAidW5kZWZpbmVkIiAhPSB0eXBlb2YgdC5zdHlsZS56b29tICYmICh0LnN0eWxlLmNzc1RleHQgPSAiZGlzcGxheTppbmxpbmU7bWFyZ2luOjA7Ym9yZGVyOjA7cGFkZGluZzoxcHg7d2lkdGg6MXB4O3pvb206MSIsIGZlLmlubGluZUJsb2NrTmVlZHNMYXlvdXQgPSBlID0gMyA9PT0gdC5vZmZzZXRXaWR0aCwgZSAmJiAobi5zdHlsZS56b29tID0gMSkpLCBuLnJlbW92ZUNoaWxkKHIpKTsKICB9KSwgZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSByZS5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGZlLmRlbGV0ZUV4cGFuZG8gPSAhMDsKCiAgICB0cnkgewogICAgICBkZWxldGUgZS50ZXN0OwogICAgfSBjYXRjaCAodCkgewogICAgICBmZS5kZWxldGVFeHBhbmRvID0gITE7CiAgICB9CgogICAgZSA9IG51bGw7CiAgfSgpOwoKICB2YXIgSGUgPSBmdW5jdGlvbiBIZShlKSB7CiAgICB2YXIgdCA9IHBlLm5vRGF0YVsoZS5ub2RlTmFtZSArICIgIikudG9Mb3dlckNhc2UoKV0sCiAgICAgICAgbiA9ICtlLm5vZGVUeXBlIHx8IDE7CiAgICByZXR1cm4gKDEgPT09IG4gfHwgOSA9PT0gbikgJiYgKCF0IHx8IHQgIT09ICEwICYmIGUuZ2V0QXR0cmlidXRlKCJjbGFzc2lkIikgPT09IHQpOwogIH0sCiAgICAgIHFlID0gL14oPzpce1tcd1xXXSpcfXxcW1tcd1xXXSpcXSkkLywKICAgICAgX2UgPSAvKFtBLVpdKS9nOwoKICBwZS5leHRlbmQoewogICAgY2FjaGU6IHt9LAogICAgbm9EYXRhOiB7CiAgICAgICJhcHBsZXQgIjogITAsCiAgICAgICJlbWJlZCAiOiAhMCwKICAgICAgIm9iamVjdCAiOiAiY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwIgogICAgfSwKICAgIGhhc0RhdGE6IGZ1bmN0aW9uIGhhc0RhdGEoZSkgewogICAgICByZXR1cm4gZSA9IGUubm9kZVR5cGUgPyBwZS5jYWNoZVtlW3BlLmV4cGFuZG9dXSA6IGVbcGUuZXhwYW5kb10sICEhZSAmJiAhbChlKTsKICAgIH0sCiAgICBkYXRhOiBmdW5jdGlvbiBkYXRhKGUsIHQsIG4pIHsKICAgICAgcmV0dXJuIGMoZSwgdCwgbik7CiAgICB9LAogICAgcmVtb3ZlRGF0YTogZnVuY3Rpb24gcmVtb3ZlRGF0YShlLCB0KSB7CiAgICAgIHJldHVybiBmKGUsIHQpOwogICAgfSwKICAgIF9kYXRhOiBmdW5jdGlvbiBfZGF0YShlLCB0LCBuKSB7CiAgICAgIHJldHVybiBjKGUsIHQsIG4sICEwKTsKICAgIH0sCiAgICBfcmVtb3ZlRGF0YTogZnVuY3Rpb24gX3JlbW92ZURhdGEoZSwgdCkgewogICAgICByZXR1cm4gZihlLCB0LCAhMCk7CiAgICB9CiAgfSksIHBlLmZuLmV4dGVuZCh7CiAgICBkYXRhOiBmdW5jdGlvbiBkYXRhKGUsIHQpIHsKICAgICAgdmFyIG4sCiAgICAgICAgICByLAogICAgICAgICAgaSwKICAgICAgICAgIG8gPSB0aGlzWzBdLAogICAgICAgICAgYSA9IG8gJiYgby5hdHRyaWJ1dGVzOwoKICAgICAgaWYgKHZvaWQgMCA9PT0gZSkgewogICAgICAgIGlmICh0aGlzLmxlbmd0aCAmJiAoaSA9IHBlLmRhdGEobyksIDEgPT09IG8ubm9kZVR5cGUgJiYgIXBlLl9kYXRhKG8sICJwYXJzZWRBdHRycyIpKSkgewogICAgICAgICAgZm9yIChuID0gYS5sZW5ndGg7IG4tLTspIHsKICAgICAgICAgICAgYVtuXSAmJiAociA9IGFbbl0ubmFtZSwgMCA9PT0gci5pbmRleE9mKCJkYXRhLSIpICYmIChyID0gcGUuY2FtZWxDYXNlKHIuc2xpY2UoNSkpLCB1KG8sIHIsIGlbcl0pKSk7CiAgICAgICAgICB9CgogICAgICAgICAgcGUuX2RhdGEobywgInBhcnNlZEF0dHJzIiwgITApOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KCiAgICAgIHJldHVybiAib2JqZWN0IiA9PSBfdHlwZW9mKGUpID8gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBwZS5kYXRhKHRoaXMsIGUpOwogICAgICB9KSA6IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBwZS5kYXRhKHRoaXMsIGUsIHQpOwogICAgICB9KSA6IG8gPyB1KG8sIGUsIHBlLmRhdGEobywgZSkpIDogdm9pZCAwOwogICAgfSwKICAgIHJlbW92ZURhdGE6IGZ1bmN0aW9uIHJlbW92ZURhdGEoZSkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBwZS5yZW1vdmVEYXRhKHRoaXMsIGUpOwogICAgICB9KTsKICAgIH0KICB9KSwgcGUuZXh0ZW5kKHsKICAgIHF1ZXVlOiBmdW5jdGlvbiBxdWV1ZShlLCB0LCBuKSB7CiAgICAgIHZhciByOwogICAgICBpZiAoZSkgcmV0dXJuIHQgPSAodCB8fCAiZngiKSArICJxdWV1ZSIsIHIgPSBwZS5fZGF0YShlLCB0KSwgbiAmJiAoIXIgfHwgcGUuaXNBcnJheShuKSA/IHIgPSBwZS5fZGF0YShlLCB0LCBwZS5tYWtlQXJyYXkobikpIDogci5wdXNoKG4pKSwgciB8fCBbXTsKICAgIH0sCiAgICBkZXF1ZXVlOiBmdW5jdGlvbiBkZXF1ZXVlKGUsIHQpIHsKICAgICAgdCA9IHQgfHwgImZ4IjsKCiAgICAgIHZhciBuID0gcGUucXVldWUoZSwgdCksCiAgICAgICAgICByID0gbi5sZW5ndGgsCiAgICAgICAgICBpID0gbi5zaGlmdCgpLAogICAgICAgICAgbyA9IHBlLl9xdWV1ZUhvb2tzKGUsIHQpLAogICAgICAgICAgYSA9IGZ1bmN0aW9uIGEoKSB7CiAgICAgICAgcGUuZGVxdWV1ZShlLCB0KTsKICAgICAgfTsKCiAgICAgICJpbnByb2dyZXNzIiA9PT0gaSAmJiAoaSA9IG4uc2hpZnQoKSwgci0tKSwgaSAmJiAoImZ4IiA9PT0gdCAmJiBuLnVuc2hpZnQoImlucHJvZ3Jlc3MiKSwgZGVsZXRlIG8uc3RvcCwgaS5jYWxsKGUsIGEsIG8pKSwgIXIgJiYgbyAmJiBvLmVtcHR5LmZpcmUoKTsKICAgIH0sCiAgICBfcXVldWVIb29rczogZnVuY3Rpb24gX3F1ZXVlSG9va3MoZSwgdCkgewogICAgICB2YXIgbiA9IHQgKyAicXVldWVIb29rcyI7CiAgICAgIHJldHVybiBwZS5fZGF0YShlLCBuKSB8fCBwZS5fZGF0YShlLCBuLCB7CiAgICAgICAgZW1wdHk6IHBlLkNhbGxiYWNrcygib25jZSBtZW1vcnkiKS5hZGQoZnVuY3Rpb24gKCkgewogICAgICAgICAgcGUuX3JlbW92ZURhdGEoZSwgdCArICJxdWV1ZSIpLCBwZS5fcmVtb3ZlRGF0YShlLCBuKTsKICAgICAgICB9KQogICAgICB9KTsKICAgIH0KICB9KSwgcGUuZm4uZXh0ZW5kKHsKICAgIHF1ZXVlOiBmdW5jdGlvbiBxdWV1ZShlLCB0KSB7CiAgICAgIHZhciBuID0gMjsKICAgICAgcmV0dXJuICJzdHJpbmciICE9IHR5cGVvZiBlICYmICh0ID0gZSwgZSA9ICJmeCIsIG4tLSksIGFyZ3VtZW50cy5sZW5ndGggPCBuID8gcGUucXVldWUodGhpc1swXSwgZSkgOiB2b2lkIDAgPT09IHQgPyB0aGlzIDogdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbiA9IHBlLnF1ZXVlKHRoaXMsIGUsIHQpOwogICAgICAgIHBlLl9xdWV1ZUhvb2tzKHRoaXMsIGUpLCAiZngiID09PSBlICYmICJpbnByb2dyZXNzIiAhPT0gblswXSAmJiBwZS5kZXF1ZXVlKHRoaXMsIGUpOwogICAgICB9KTsKICAgIH0sCiAgICBkZXF1ZXVlOiBmdW5jdGlvbiBkZXF1ZXVlKGUpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgcGUuZGVxdWV1ZSh0aGlzLCBlKTsKICAgICAgfSk7CiAgICB9LAogICAgY2xlYXJRdWV1ZTogZnVuY3Rpb24gY2xlYXJRdWV1ZShlKSB7CiAgICAgIHJldHVybiB0aGlzLnF1ZXVlKGUgfHwgImZ4IiwgW10pOwogICAgfSwKICAgIHByb21pc2U6IGZ1bmN0aW9uIHByb21pc2UoZSwgdCkgewogICAgICB2YXIgbiwKICAgICAgICAgIHIgPSAxLAogICAgICAgICAgaSA9IHBlLkRlZmVycmVkKCksCiAgICAgICAgICBvID0gdGhpcywKICAgICAgICAgIGEgPSB0aGlzLmxlbmd0aCwKICAgICAgICAgIHMgPSBmdW5jdGlvbiBzKCkgewogICAgICAgIC0tciB8fCBpLnJlc29sdmVXaXRoKG8sIFtvXSk7CiAgICAgIH07CgogICAgICBmb3IgKCJzdHJpbmciICE9IHR5cGVvZiBlICYmICh0ID0gZSwgZSA9IHZvaWQgMCksIGUgPSBlIHx8ICJmeCI7IGEtLTspIHsKICAgICAgICBuID0gcGUuX2RhdGEob1thXSwgZSArICJxdWV1ZUhvb2tzIiksIG4gJiYgbi5lbXB0eSAmJiAocisrLCBuLmVtcHR5LmFkZChzKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBzKCksIGkucHJvbWlzZSh0KTsKICAgIH0KICB9KSwgZnVuY3Rpb24gKCkgewogICAgdmFyIGU7CgogICAgZmUuc2hyaW5rV3JhcEJsb2NrcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKG51bGwgIT0gZSkgcmV0dXJuIGU7CiAgICAgIGUgPSAhMTsKICAgICAgdmFyIHQsIG4sIHI7CiAgICAgIHJldHVybiBuID0gcmUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXSwgbiAmJiBuLnN0eWxlID8gKHQgPSByZS5jcmVhdGVFbGVtZW50KCJkaXYiKSwgciA9IHJlLmNyZWF0ZUVsZW1lbnQoImRpdiIpLCByLnN0eWxlLmNzc1RleHQgPSAicG9zaXRpb246YWJzb2x1dGU7Ym9yZGVyOjA7d2lkdGg6MDtoZWlnaHQ6MDt0b3A6MDtsZWZ0Oi05OTk5cHgiLCBuLmFwcGVuZENoaWxkKHIpLmFwcGVuZENoaWxkKHQpLCAidW5kZWZpbmVkIiAhPSB0eXBlb2YgdC5zdHlsZS56b29tICYmICh0LnN0eWxlLmNzc1RleHQgPSAiLXdlYmtpdC1ib3gtc2l6aW5nOmNvbnRlbnQtYm94Oy1tb3otYm94LXNpemluZzpjb250ZW50LWJveDtib3gtc2l6aW5nOmNvbnRlbnQtYm94O2Rpc3BsYXk6YmxvY2s7bWFyZ2luOjA7Ym9yZGVyOjA7cGFkZGluZzoxcHg7d2lkdGg6MXB4O3pvb206MSIsIHQuYXBwZW5kQ2hpbGQocmUuY3JlYXRlRWxlbWVudCgiZGl2IikpLnN0eWxlLndpZHRoID0gIjVweCIsIGUgPSAzICE9PSB0Lm9mZnNldFdpZHRoKSwgbi5yZW1vdmVDaGlsZChyKSwgZSkgOiB2b2lkIDA7CiAgICB9OwogIH0oKTsKCiAgdmFyIEZlID0gL1srLV0/KD86XGQqXC58KVxkKyg/OltlRV1bKy1dP1xkK3wpLy5zb3VyY2UsCiAgICAgIE1lID0gbmV3IFJlZ0V4cCgiXig/OihbKy1dKT18KSgiICsgRmUgKyAiKShbYS16JV0qKSQiLCAiaSIpLAogICAgICBPZSA9IFsiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0Il0sCiAgICAgIFJlID0gZnVuY3Rpb24gUmUoZSwgdCkgewogICAgcmV0dXJuIGUgPSB0IHx8IGUsICJub25lIiA9PT0gcGUuY3NzKGUsICJkaXNwbGF5IikgfHwgIXBlLmNvbnRhaW5zKGUub3duZXJEb2N1bWVudCwgZSk7CiAgfSwKICAgICAgUGUgPSBmdW5jdGlvbiBQZShlLCB0LCBuLCByLCBpLCBvLCBhKSB7CiAgICB2YXIgcyA9IDAsCiAgICAgICAgdSA9IGUubGVuZ3RoLAogICAgICAgIGwgPSBudWxsID09IG47CgogICAgaWYgKCJvYmplY3QiID09PSBwZS50eXBlKG4pKSB7CiAgICAgIGkgPSAhMDsKCiAgICAgIGZvciAocyBpbiBuKSB7CiAgICAgICAgUGUoZSwgdCwgcywgbltzXSwgITAsIG8sIGEpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHZvaWQgMCAhPT0gciAmJiAoaSA9ICEwLCBwZS5pc0Z1bmN0aW9uKHIpIHx8IChhID0gITApLCBsICYmIChhID8gKHQuY2FsbChlLCByKSwgdCA9IG51bGwpIDogKGwgPSB0LCB0ID0gZnVuY3Rpb24gdChlLCBfdDMsIG4pIHsKICAgICAgcmV0dXJuIGwuY2FsbChwZShlKSwgbik7CiAgICB9KSksIHQpKSBmb3IgKDsgcyA8IHU7IHMrKykgewogICAgICB0KGVbc10sIG4sIGEgPyByIDogci5jYWxsKGVbc10sIHMsIHQoZVtzXSwgbikpKTsKICAgIH0KCiAgICByZXR1cm4gaSA/IGUgOiBsID8gdC5jYWxsKGUpIDogdSA/IHQoZVswXSwgbikgOiBvOwogIH0sCiAgICAgIEJlID0gL14oPzpjaGVja2JveHxyYWRpbykkL2ksCiAgICAgIFdlID0gLzwoW1x3Oi1dKykvLAogICAgICBJZSA9IC9eJHxcLyg/OmphdmF8ZWNtYSlzY3JpcHQvaSwKICAgICAgJGUgPSAvXlxzKy8sCiAgICAgIHplID0gImFiYnJ8YXJ0aWNsZXxhc2lkZXxhdWRpb3xiZGl8Y2FudmFzfGRhdGF8ZGF0YWxpc3R8ZGV0YWlsc3xkaWFsb2d8ZmlnY2FwdGlvbnxmaWd1cmV8Zm9vdGVyfGhlYWRlcnxoZ3JvdXB8bWFpbnxtYXJrfG1ldGVyfG5hdnxvdXRwdXR8cGljdHVyZXxwcm9ncmVzc3xzZWN0aW9ufHN1bW1hcnl8dGVtcGxhdGV8dGltZXx2aWRlbyI7CgogICFmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHJlLmNyZWF0ZUVsZW1lbnQoImRpdiIpLAogICAgICAgIHQgPSByZS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgbiA9IHJlLmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICBlLmlubmVySFRNTCA9ICIgIDxsaW5rLz48dGFibGU+PC90YWJsZT48YSBocmVmPScvYSc+YTwvYT48aW5wdXQgdHlwZT0nY2hlY2tib3gnLz4iLCBmZS5sZWFkaW5nV2hpdGVzcGFjZSA9IDMgPT09IGUuZmlyc3RDaGlsZC5ub2RlVHlwZSwgZmUudGJvZHkgPSAhZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGJvZHkiKS5sZW5ndGgsIGZlLmh0bWxTZXJpYWxpemUgPSAhIWUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpbmsiKS5sZW5ndGgsIGZlLmh0bWw1Q2xvbmUgPSAiPDpuYXY+PC86bmF2PiIgIT09IHJlLmNyZWF0ZUVsZW1lbnQoIm5hdiIpLmNsb25lTm9kZSghMCkub3V0ZXJIVE1MLCBuLnR5cGUgPSAiY2hlY2tib3giLCBuLmNoZWNrZWQgPSAhMCwgdC5hcHBlbmRDaGlsZChuKSwgZmUuYXBwZW5kQ2hlY2tlZCA9IG4uY2hlY2tlZCwgZS5pbm5lckhUTUwgPSAiPHRleHRhcmVhPng8L3RleHRhcmVhPiIsIGZlLm5vQ2xvbmVDaGVja2VkID0gISFlLmNsb25lTm9kZSghMCkubGFzdENoaWxkLmRlZmF1bHRWYWx1ZSwgdC5hcHBlbmRDaGlsZChlKSwgbiA9IHJlLmNyZWF0ZUVsZW1lbnQoImlucHV0IiksIG4uc2V0QXR0cmlidXRlKCJ0eXBlIiwgInJhZGlvIiksIG4uc2V0QXR0cmlidXRlKCJjaGVja2VkIiwgImNoZWNrZWQiKSwgbi5zZXRBdHRyaWJ1dGUoIm5hbWUiLCAidCIpLCBlLmFwcGVuZENoaWxkKG4pLCBmZS5jaGVja0Nsb25lID0gZS5jbG9uZU5vZGUoITApLmNsb25lTm9kZSghMCkubGFzdENoaWxkLmNoZWNrZWQsIGZlLm5vQ2xvbmVFdmVudCA9ICEhZS5hZGRFdmVudExpc3RlbmVyLCBlW3BlLmV4cGFuZG9dID0gMSwgZmUuYXR0cmlidXRlcyA9ICFlLmdldEF0dHJpYnV0ZShwZS5leHBhbmRvKTsKICB9KCk7CiAgdmFyIFhlID0gewogICAgb3B0aW9uOiBbMSwgIjxzZWxlY3QgbXVsdGlwbGU9J211bHRpcGxlJz4iLCAiPC9zZWxlY3Q+Il0sCiAgICBsZWdlbmQ6IFsxLCAiPGZpZWxkc2V0PiIsICI8L2ZpZWxkc2V0PiJdLAogICAgYXJlYTogWzEsICI8bWFwPiIsICI8L21hcD4iXSwKICAgIHBhcmFtOiBbMSwgIjxvYmplY3Q+IiwgIjwvb2JqZWN0PiJdLAogICAgdGhlYWQ6IFsxLCAiPHRhYmxlPiIsICI8L3RhYmxlPiJdLAogICAgdHI6IFsyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiJdLAogICAgY29sOiBbMiwgIjx0YWJsZT48dGJvZHk+PC90Ym9keT48Y29sZ3JvdXA+IiwgIjwvY29sZ3JvdXA+PC90YWJsZT4iXSwKICAgIHRkOiBbMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iXSwKICAgIF9kZWZhdWx0OiBmZS5odG1sU2VyaWFsaXplID8gWzAsICIiLCAiIl0gOiBbMSwgIlg8ZGl2PiIsICI8L2Rpdj4iXQogIH07CiAgWGUub3B0Z3JvdXAgPSBYZS5vcHRpb24sIFhlLnRib2R5ID0gWGUudGZvb3QgPSBYZS5jb2xncm91cCA9IFhlLmNhcHRpb24gPSBYZS50aGVhZCwgWGUudGggPSBYZS50ZDsKICB2YXIgVWUgPSAvPHwmIz9cdys7LywKICAgICAgVmUgPSAvPHRib2R5L2k7CiAgIWZ1bmN0aW9uICgpIHsKICAgIHZhciB0LAogICAgICAgIG4sCiAgICAgICAgciA9IHJlLmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKICAgIGZvciAodCBpbiB7CiAgICAgIHN1Ym1pdDogITAsCiAgICAgIGNoYW5nZTogITAsCiAgICAgIGZvY3VzaW46ICEwCiAgICB9KSB7CiAgICAgIG4gPSAib24iICsgdCwgKGZlW3RdID0gbiBpbiBlKSB8fCAoci5zZXRBdHRyaWJ1dGUobiwgInQiKSwgZmVbdF0gPSByLmF0dHJpYnV0ZXNbbl0uZXhwYW5kbyA9PT0gITEpOwogICAgfQoKICAgIHIgPSBudWxsOwogIH0oKTsKICB2YXIgWWUgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYSkkL2ksCiAgICAgIEplID0gL15rZXkvLAogICAgICBHZSA9IC9eKD86bW91c2V8cG9pbnRlcnxjb250ZXh0bWVudXxkcmFnfGRyb3ApfGNsaWNrLywKICAgICAgS2UgPSAvXig/OmZvY3VzaW5mb2N1c3xmb2N1c291dGJsdXIpJC8sCiAgICAgIFFlID0gL14oW14uXSopKD86XC4oLispfCkvOwogIHBlLmV2ZW50ID0gewogICAgZ2xvYmFsOiB7fSwKICAgIGFkZDogZnVuY3Rpb24gYWRkKGUsIHQsIG4sIHIsIGkpIHsKICAgICAgdmFyIG8sCiAgICAgICAgICBhLAogICAgICAgICAgcywKICAgICAgICAgIHUsCiAgICAgICAgICBsLAogICAgICAgICAgYywKICAgICAgICAgIGYsCiAgICAgICAgICBkLAogICAgICAgICAgcCwKICAgICAgICAgIGgsCiAgICAgICAgICBnLAogICAgICAgICAgbSA9IHBlLl9kYXRhKGUpOwoKICAgICAgaWYgKG0pIHsKICAgICAgICBmb3IgKG4uaGFuZGxlciAmJiAodSA9IG4sIG4gPSB1LmhhbmRsZXIsIGkgPSB1LnNlbGVjdG9yKSwgbi5ndWlkIHx8IChuLmd1aWQgPSBwZS5ndWlkKyspLCAoYSA9IG0uZXZlbnRzKSB8fCAoYSA9IG0uZXZlbnRzID0ge30pLCAoYyA9IG0uaGFuZGxlKSB8fCAoYyA9IG0uaGFuZGxlID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIHJldHVybiAidW5kZWZpbmVkIiA9PSB0eXBlb2YgcGUgfHwgZSAmJiBwZS5ldmVudC50cmlnZ2VyZWQgPT09IGUudHlwZSA/IHZvaWQgMCA6IHBlLmV2ZW50LmRpc3BhdGNoLmFwcGx5KGMuZWxlbSwgYXJndW1lbnRzKTsKICAgICAgICB9LCBjLmVsZW0gPSBlKSwgdCA9ICh0IHx8ICIiKS5tYXRjaChEZSkgfHwgWyIiXSwgcyA9IHQubGVuZ3RoOyBzLS07KSB7CiAgICAgICAgICBvID0gUWUuZXhlYyh0W3NdKSB8fCBbXSwgcCA9IGcgPSBvWzFdLCBoID0gKG9bMl0gfHwgIiIpLnNwbGl0KCIuIikuc29ydCgpLCBwICYmIChsID0gcGUuZXZlbnQuc3BlY2lhbFtwXSB8fCB7fSwgcCA9IChpID8gbC5kZWxlZ2F0ZVR5cGUgOiBsLmJpbmRUeXBlKSB8fCBwLCBsID0gcGUuZXZlbnQuc3BlY2lhbFtwXSB8fCB7fSwgZiA9IHBlLmV4dGVuZCh7CiAgICAgICAgICAgIHR5cGU6IHAsCiAgICAgICAgICAgIG9yaWdUeXBlOiBnLAogICAgICAgICAgICBkYXRhOiByLAogICAgICAgICAgICBoYW5kbGVyOiBuLAogICAgICAgICAgICBndWlkOiBuLmd1aWQsCiAgICAgICAgICAgIHNlbGVjdG9yOiBpLAogICAgICAgICAgICBuZWVkc0NvbnRleHQ6IGkgJiYgcGUuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQudGVzdChpKSwKICAgICAgICAgICAgbmFtZXNwYWNlOiBoLmpvaW4oIi4iKQogICAgICAgICAgfSwgdSksIChkID0gYVtwXSkgfHwgKGQgPSBhW3BdID0gW10sIGQuZGVsZWdhdGVDb3VudCA9IDAsIGwuc2V0dXAgJiYgbC5zZXR1cC5jYWxsKGUsIHIsIGgsIGMpICE9PSAhMSB8fCAoZS5hZGRFdmVudExpc3RlbmVyID8gZS5hZGRFdmVudExpc3RlbmVyKHAsIGMsICExKSA6IGUuYXR0YWNoRXZlbnQgJiYgZS5hdHRhY2hFdmVudCgib24iICsgcCwgYykpKSwgbC5hZGQgJiYgKGwuYWRkLmNhbGwoZSwgZiksIGYuaGFuZGxlci5ndWlkIHx8IChmLmhhbmRsZXIuZ3VpZCA9IG4uZ3VpZCkpLCBpID8gZC5zcGxpY2UoZC5kZWxlZ2F0ZUNvdW50KyssIDAsIGYpIDogZC5wdXNoKGYpLCBwZS5ldmVudC5nbG9iYWxbcF0gPSAhMCk7CiAgICAgICAgfQoKICAgICAgICBlID0gbnVsbDsKICAgICAgfQogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24gcmVtb3ZlKGUsIHQsIG4sIHIsIGkpIHsKICAgICAgdmFyIG8sCiAgICAgICAgICBhLAogICAgICAgICAgcywKICAgICAgICAgIHUsCiAgICAgICAgICBsLAogICAgICAgICAgYywKICAgICAgICAgIGYsCiAgICAgICAgICBkLAogICAgICAgICAgcCwKICAgICAgICAgIGgsCiAgICAgICAgICBnLAogICAgICAgICAgbSA9IHBlLmhhc0RhdGEoZSkgJiYgcGUuX2RhdGEoZSk7CgogICAgICBpZiAobSAmJiAoYyA9IG0uZXZlbnRzKSkgewogICAgICAgIGZvciAodCA9ICh0IHx8ICIiKS5tYXRjaChEZSkgfHwgWyIiXSwgbCA9IHQubGVuZ3RoOyBsLS07KSB7CiAgICAgICAgICBpZiAocyA9IFFlLmV4ZWModFtsXSkgfHwgW10sIHAgPSBnID0gc1sxXSwgaCA9IChzWzJdIHx8ICIiKS5zcGxpdCgiLiIpLnNvcnQoKSwgcCkgewogICAgICAgICAgICBmb3IgKGYgPSBwZS5ldmVudC5zcGVjaWFsW3BdIHx8IHt9LCBwID0gKHIgPyBmLmRlbGVnYXRlVHlwZSA6IGYuYmluZFR5cGUpIHx8IHAsIGQgPSBjW3BdIHx8IFtdLCBzID0gc1syXSAmJiBuZXcgUmVnRXhwKCIoXnxcXC4pIiArIGguam9pbigiXFwuKD86LipcXC58KSIpICsgIihcXC58JCkiKSwgdSA9IG8gPSBkLmxlbmd0aDsgby0tOykgewogICAgICAgICAgICAgIGEgPSBkW29dLCAhaSAmJiBnICE9PSBhLm9yaWdUeXBlIHx8IG4gJiYgbi5ndWlkICE9PSBhLmd1aWQgfHwgcyAmJiAhcy50ZXN0KGEubmFtZXNwYWNlKSB8fCByICYmIHIgIT09IGEuc2VsZWN0b3IgJiYgKCIqKiIgIT09IHIgfHwgIWEuc2VsZWN0b3IpIHx8IChkLnNwbGljZShvLCAxKSwgYS5zZWxlY3RvciAmJiBkLmRlbGVnYXRlQ291bnQtLSwgZi5yZW1vdmUgJiYgZi5yZW1vdmUuY2FsbChlLCBhKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHUgJiYgIWQubGVuZ3RoICYmIChmLnRlYXJkb3duICYmIGYudGVhcmRvd24uY2FsbChlLCBoLCBtLmhhbmRsZSkgIT09ICExIHx8IHBlLnJlbW92ZUV2ZW50KGUsIHAsIG0uaGFuZGxlKSwgZGVsZXRlIGNbcF0pOwogICAgICAgICAgfSBlbHNlIGZvciAocCBpbiBjKSB7CiAgICAgICAgICAgIHBlLmV2ZW50LnJlbW92ZShlLCBwICsgdFtsXSwgbiwgciwgITApOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcGUuaXNFbXB0eU9iamVjdChjKSAmJiAoZGVsZXRlIG0uaGFuZGxlLCBwZS5fcmVtb3ZlRGF0YShlLCAiZXZlbnRzIikpOwogICAgICB9CiAgICB9LAogICAgdHJpZ2dlcjogZnVuY3Rpb24gdHJpZ2dlcih0LCBuLCByLCBpKSB7CiAgICAgIHZhciBvLAogICAgICAgICAgYSwKICAgICAgICAgIHMsCiAgICAgICAgICB1LAogICAgICAgICAgbCwKICAgICAgICAgIGMsCiAgICAgICAgICBmLAogICAgICAgICAgZCA9IFtyIHx8IHJlXSwKICAgICAgICAgIHAgPSBjZS5jYWxsKHQsICJ0eXBlIikgPyB0LnR5cGUgOiB0LAogICAgICAgICAgaCA9IGNlLmNhbGwodCwgIm5hbWVzcGFjZSIpID8gdC5uYW1lc3BhY2Uuc3BsaXQoIi4iKSA6IFtdOwoKICAgICAgaWYgKHMgPSBjID0gciA9IHIgfHwgcmUsIDMgIT09IHIubm9kZVR5cGUgJiYgOCAhPT0gci5ub2RlVHlwZSAmJiAhS2UudGVzdChwICsgcGUuZXZlbnQudHJpZ2dlcmVkKSAmJiAocC5pbmRleE9mKCIuIikgPiAtMSAmJiAoaCA9IHAuc3BsaXQoIi4iKSwgcCA9IGguc2hpZnQoKSwgaC5zb3J0KCkpLCBhID0gcC5pbmRleE9mKCI6IikgPCAwICYmICJvbiIgKyBwLCB0ID0gdFtwZS5leHBhbmRvXSA/IHQgOiBuZXcgcGUuRXZlbnQocCwgIm9iamVjdCIgPT0gX3R5cGVvZih0KSAmJiB0KSwgdC5pc1RyaWdnZXIgPSBpID8gMiA6IDMsIHQubmFtZXNwYWNlID0gaC5qb2luKCIuIiksIHQucm5hbWVzcGFjZSA9IHQubmFtZXNwYWNlID8gbmV3IFJlZ0V4cCgiKF58XFwuKSIgKyBoLmpvaW4oIlxcLig/Oi4qXFwufCkiKSArICIoXFwufCQpIikgOiBudWxsLCB0LnJlc3VsdCA9IHZvaWQgMCwgdC50YXJnZXQgfHwgKHQudGFyZ2V0ID0gciksIG4gPSBudWxsID09IG4gPyBbdF0gOiBwZS5tYWtlQXJyYXkobiwgW3RdKSwgbCA9IHBlLmV2ZW50LnNwZWNpYWxbcF0gfHwge30sIGkgfHwgIWwudHJpZ2dlciB8fCBsLnRyaWdnZXIuYXBwbHkociwgbikgIT09ICExKSkgewogICAgICAgIGlmICghaSAmJiAhbC5ub0J1YmJsZSAmJiAhcGUuaXNXaW5kb3cocikpIHsKICAgICAgICAgIGZvciAodSA9IGwuZGVsZWdhdGVUeXBlIHx8IHAsIEtlLnRlc3QodSArIHApIHx8IChzID0gcy5wYXJlbnROb2RlKTsgczsgcyA9IHMucGFyZW50Tm9kZSkgewogICAgICAgICAgICBkLnB1c2gocyksIGMgPSBzOwogICAgICAgICAgfQoKICAgICAgICAgIGMgPT09IChyLm93bmVyRG9jdW1lbnQgfHwgcmUpICYmIGQucHVzaChjLmRlZmF1bHRWaWV3IHx8IGMucGFyZW50V2luZG93IHx8IGUpOwogICAgICAgIH0KCiAgICAgICAgZm9yIChmID0gMDsgKHMgPSBkW2YrK10pICYmICF0LmlzUHJvcGFnYXRpb25TdG9wcGVkKCk7KSB7CiAgICAgICAgICB0LnR5cGUgPSBmID4gMSA/IHUgOiBsLmJpbmRUeXBlIHx8IHAsIG8gPSAocGUuX2RhdGEocywgImV2ZW50cyIpIHx8IHt9KVt0LnR5cGVdICYmIHBlLl9kYXRhKHMsICJoYW5kbGUiKSwgbyAmJiBvLmFwcGx5KHMsIG4pLCBvID0gYSAmJiBzW2FdLCBvICYmIG8uYXBwbHkgJiYgSGUocykgJiYgKHQucmVzdWx0ID0gby5hcHBseShzLCBuKSwgdC5yZXN1bHQgPT09ICExICYmIHQucHJldmVudERlZmF1bHQoKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodC50eXBlID0gcCwgIWkgJiYgIXQuaXNEZWZhdWx0UHJldmVudGVkKCkgJiYgKCFsLl9kZWZhdWx0IHx8IGwuX2RlZmF1bHQuYXBwbHkoZC5wb3AoKSwgbikgPT09ICExKSAmJiBIZShyKSAmJiBhICYmIHJbcF0gJiYgIXBlLmlzV2luZG93KHIpKSB7CiAgICAgICAgICBjID0gclthXSwgYyAmJiAoclthXSA9IG51bGwpLCBwZS5ldmVudC50cmlnZ2VyZWQgPSBwOwoKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJbcF0oKTsKICAgICAgICAgIH0gY2F0Y2ggKGcpIHt9CgogICAgICAgICAgcGUuZXZlbnQudHJpZ2dlcmVkID0gdm9pZCAwLCBjICYmIChyW2FdID0gYyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdC5yZXN1bHQ7CiAgICAgIH0KICAgIH0sCiAgICBkaXNwYXRjaDogZnVuY3Rpb24gZGlzcGF0Y2goZSkgewogICAgICBlID0gcGUuZXZlbnQuZml4KGUpOwogICAgICB2YXIgdCwKICAgICAgICAgIG4sCiAgICAgICAgICByLAogICAgICAgICAgaSwKICAgICAgICAgIG8sCiAgICAgICAgICBhID0gW10sCiAgICAgICAgICBzID0gaWUuY2FsbChhcmd1bWVudHMpLAogICAgICAgICAgdSA9IChwZS5fZGF0YSh0aGlzLCAiZXZlbnRzIikgfHwge30pW2UudHlwZV0gfHwgW10sCiAgICAgICAgICBsID0gcGUuZXZlbnQuc3BlY2lhbFtlLnR5cGVdIHx8IHt9OwoKICAgICAgaWYgKHNbMF0gPSBlLCBlLmRlbGVnYXRlVGFyZ2V0ID0gdGhpcywgIWwucHJlRGlzcGF0Y2ggfHwgbC5wcmVEaXNwYXRjaC5jYWxsKHRoaXMsIGUpICE9PSAhMSkgewogICAgICAgIGZvciAoYSA9IHBlLmV2ZW50LmhhbmRsZXJzLmNhbGwodGhpcywgZSwgdSksIHQgPSAwOyAoaSA9IGFbdCsrXSkgJiYgIWUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKTspIHsKICAgICAgICAgIGZvciAoZS5jdXJyZW50VGFyZ2V0ID0gaS5lbGVtLCBuID0gMDsgKG8gPSBpLmhhbmRsZXJzW24rK10pICYmICFlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCk7KSB7CiAgICAgICAgICAgIGUucm5hbWVzcGFjZSAmJiAhZS5ybmFtZXNwYWNlLnRlc3Qoby5uYW1lc3BhY2UpIHx8IChlLmhhbmRsZU9iaiA9IG8sIGUuZGF0YSA9IG8uZGF0YSwgciA9ICgocGUuZXZlbnQuc3BlY2lhbFtvLm9yaWdUeXBlXSB8fCB7fSkuaGFuZGxlIHx8IG8uaGFuZGxlcikuYXBwbHkoaS5lbGVtLCBzKSwgdm9pZCAwICE9PSByICYmIChlLnJlc3VsdCA9IHIpID09PSAhMSAmJiAoZS5wcmV2ZW50RGVmYXVsdCgpLCBlLnN0b3BQcm9wYWdhdGlvbigpKSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbC5wb3N0RGlzcGF0Y2ggJiYgbC5wb3N0RGlzcGF0Y2guY2FsbCh0aGlzLCBlKSwgZS5yZXN1bHQ7CiAgICAgIH0KICAgIH0sCiAgICBoYW5kbGVyczogZnVuY3Rpb24gaGFuZGxlcnMoZSwgdCkgewogICAgICB2YXIgbiwKICAgICAgICAgIHIsCiAgICAgICAgICBpLAogICAgICAgICAgbywKICAgICAgICAgIGEgPSBbXSwKICAgICAgICAgIHMgPSB0LmRlbGVnYXRlQ291bnQsCiAgICAgICAgICB1ID0gZS50YXJnZXQ7CiAgICAgIGlmIChzICYmIHUubm9kZVR5cGUgJiYgKCJjbGljayIgIT09IGUudHlwZSB8fCBpc05hTihlLmJ1dHRvbikgfHwgZS5idXR0b24gPCAxKSkgZm9yICg7IHUgIT0gdGhpczsgdSA9IHUucGFyZW50Tm9kZSB8fCB0aGlzKSB7CiAgICAgICAgaWYgKDEgPT09IHUubm9kZVR5cGUgJiYgKHUuZGlzYWJsZWQgIT09ICEwIHx8ICJjbGljayIgIT09IGUudHlwZSkpIHsKICAgICAgICAgIGZvciAociA9IFtdLCBuID0gMDsgbiA8IHM7IG4rKykgewogICAgICAgICAgICBvID0gdFtuXSwgaSA9IG8uc2VsZWN0b3IgKyAiICIsIHZvaWQgMCA9PT0gcltpXSAmJiAocltpXSA9IG8ubmVlZHNDb250ZXh0ID8gcGUoaSwgdGhpcykuaW5kZXgodSkgPiAtMSA6IHBlLmZpbmQoaSwgdGhpcywgbnVsbCwgW3VdKS5sZW5ndGgpLCByW2ldICYmIHIucHVzaChvKTsKICAgICAgICAgIH0KCiAgICAgICAgICByLmxlbmd0aCAmJiBhLnB1c2goewogICAgICAgICAgICBlbGVtOiB1LAogICAgICAgICAgICBoYW5kbGVyczogcgogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzIDwgdC5sZW5ndGggJiYgYS5wdXNoKHsKICAgICAgICBlbGVtOiB0aGlzLAogICAgICAgIGhhbmRsZXJzOiB0LnNsaWNlKHMpCiAgICAgIH0pLCBhOwogICAgfSwKICAgIGZpeDogZnVuY3Rpb24gZml4KGUpIHsKICAgICAgaWYgKGVbcGUuZXhwYW5kb10pIHJldHVybiBlOwogICAgICB2YXIgdCwKICAgICAgICAgIG4sCiAgICAgICAgICByLAogICAgICAgICAgaSA9IGUudHlwZSwKICAgICAgICAgIG8gPSBlLAogICAgICAgICAgYSA9IHRoaXMuZml4SG9va3NbaV07CgogICAgICBmb3IgKGEgfHwgKHRoaXMuZml4SG9va3NbaV0gPSBhID0gR2UudGVzdChpKSA/IHRoaXMubW91c2VIb29rcyA6IEplLnRlc3QoaSkgPyB0aGlzLmtleUhvb2tzIDoge30pLCByID0gYS5wcm9wcyA/IHRoaXMucHJvcHMuY29uY2F0KGEucHJvcHMpIDogdGhpcy5wcm9wcywgZSA9IG5ldyBwZS5FdmVudChvKSwgdCA9IHIubGVuZ3RoOyB0LS07KSB7CiAgICAgICAgbiA9IHJbdF0sIGVbbl0gPSBvW25dOwogICAgICB9CgogICAgICByZXR1cm4gZS50YXJnZXQgfHwgKGUudGFyZ2V0ID0gby5zcmNFbGVtZW50IHx8IHJlKSwgMyA9PT0gZS50YXJnZXQubm9kZVR5cGUgJiYgKGUudGFyZ2V0ID0gZS50YXJnZXQucGFyZW50Tm9kZSksIGUubWV0YUtleSA9ICEhZS5tZXRhS2V5LCBhLmZpbHRlciA/IGEuZmlsdGVyKGUsIG8pIDogZTsKICAgIH0sCiAgICBwcm9wczogImFsdEtleSBidWJibGVzIGNhbmNlbGFibGUgY3RybEtleSBjdXJyZW50VGFyZ2V0IGRldGFpbCBldmVudFBoYXNlIG1ldGFLZXkgcmVsYXRlZFRhcmdldCBzaGlmdEtleSB0YXJnZXQgdGltZVN0YW1wIHZpZXcgd2hpY2giLnNwbGl0KCIgIiksCiAgICBmaXhIb29rczoge30sCiAgICBrZXlIb29rczogewogICAgICBwcm9wczogImNoYXIgY2hhckNvZGUga2V5IGtleUNvZGUiLnNwbGl0KCIgIiksCiAgICAgIGZpbHRlcjogZnVuY3Rpb24gZmlsdGVyKGUsIHQpIHsKICAgICAgICByZXR1cm4gbnVsbCA9PSBlLndoaWNoICYmIChlLndoaWNoID0gbnVsbCAhPSB0LmNoYXJDb2RlID8gdC5jaGFyQ29kZSA6IHQua2V5Q29kZSksIGU7CiAgICAgIH0KICAgIH0sCiAgICBtb3VzZUhvb2tzOiB7CiAgICAgIHByb3BzOiAiYnV0dG9uIGJ1dHRvbnMgY2xpZW50WCBjbGllbnRZIGZyb21FbGVtZW50IG9mZnNldFggb2Zmc2V0WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkgdG9FbGVtZW50Ii5zcGxpdCgiICIpLAogICAgICBmaWx0ZXI6IGZ1bmN0aW9uIGZpbHRlcihlLCB0KSB7CiAgICAgICAgdmFyIG4sCiAgICAgICAgICAgIHIsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIG8gPSB0LmJ1dHRvbiwKICAgICAgICAgICAgYSA9IHQuZnJvbUVsZW1lbnQ7CiAgICAgICAgcmV0dXJuIG51bGwgPT0gZS5wYWdlWCAmJiBudWxsICE9IHQuY2xpZW50WCAmJiAociA9IGUudGFyZ2V0Lm93bmVyRG9jdW1lbnQgfHwgcmUsIGkgPSByLmRvY3VtZW50RWxlbWVudCwgbiA9IHIuYm9keSwgZS5wYWdlWCA9IHQuY2xpZW50WCArIChpICYmIGkuc2Nyb2xsTGVmdCB8fCBuICYmIG4uc2Nyb2xsTGVmdCB8fCAwKSAtIChpICYmIGkuY2xpZW50TGVmdCB8fCBuICYmIG4uY2xpZW50TGVmdCB8fCAwKSwgZS5wYWdlWSA9IHQuY2xpZW50WSArIChpICYmIGkuc2Nyb2xsVG9wIHx8IG4gJiYgbi5zY3JvbGxUb3AgfHwgMCkgLSAoaSAmJiBpLmNsaWVudFRvcCB8fCBuICYmIG4uY2xpZW50VG9wIHx8IDApKSwgIWUucmVsYXRlZFRhcmdldCAmJiBhICYmIChlLnJlbGF0ZWRUYXJnZXQgPSBhID09PSBlLnRhcmdldCA/IHQudG9FbGVtZW50IDogYSksIGUud2hpY2ggfHwgdm9pZCAwID09PSBvIHx8IChlLndoaWNoID0gMSAmIG8gPyAxIDogMiAmIG8gPyAzIDogNCAmIG8gPyAyIDogMCksIGU7CiAgICAgIH0KICAgIH0sCiAgICBzcGVjaWFsOiB7CiAgICAgIGxvYWQ6IHsKICAgICAgICBub0J1YmJsZTogITAKICAgICAgfSwKICAgICAgZm9jdXM6IHsKICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiB0cmlnZ2VyKCkgewogICAgICAgICAgaWYgKHRoaXMgIT09IGIoKSAmJiB0aGlzLmZvY3VzKSB0cnkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5mb2N1cygpLCAhMTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgfSwKICAgICAgICBkZWxlZ2F0ZVR5cGU6ICJmb2N1c2luIgogICAgICB9LAogICAgICBibHVyOiB7CiAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24gdHJpZ2dlcigpIHsKICAgICAgICAgIGlmICh0aGlzID09PSBiKCkgJiYgdGhpcy5ibHVyKSByZXR1cm4gdGhpcy5ibHVyKCksICExOwogICAgICAgIH0sCiAgICAgICAgZGVsZWdhdGVUeXBlOiAiZm9jdXNvdXQiCiAgICAgIH0sCiAgICAgIGNsaWNrOiB7CiAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24gdHJpZ2dlcigpIHsKICAgICAgICAgIGlmIChwZS5ub2RlTmFtZSh0aGlzLCAiaW5wdXQiKSAmJiAiY2hlY2tib3giID09PSB0aGlzLnR5cGUgJiYgdGhpcy5jbGljaykgcmV0dXJuIHRoaXMuY2xpY2soKSwgITE7CiAgICAgICAgfSwKICAgICAgICBfZGVmYXVsdDogZnVuY3Rpb24gX2RlZmF1bHQoZSkgewogICAgICAgICAgcmV0dXJuIHBlLm5vZGVOYW1lKGUudGFyZ2V0LCAiYSIpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYmVmb3JldW5sb2FkOiB7CiAgICAgICAgcG9zdERpc3BhdGNoOiBmdW5jdGlvbiBwb3N0RGlzcGF0Y2goZSkgewogICAgICAgICAgdm9pZCAwICE9PSBlLnJlc3VsdCAmJiBlLm9yaWdpbmFsRXZlbnQgJiYgKGUub3JpZ2luYWxFdmVudC5yZXR1cm5WYWx1ZSA9IGUucmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBzaW11bGF0ZTogZnVuY3Rpb24gc2ltdWxhdGUoZSwgdCwgbikgewogICAgICB2YXIgciA9IHBlLmV4dGVuZChuZXcgcGUuRXZlbnQoKSwgbiwgewogICAgICAgIHR5cGU6IGUsCiAgICAgICAgaXNTaW11bGF0ZWQ6ICEwCiAgICAgIH0pOwogICAgICBwZS5ldmVudC50cmlnZ2VyKHIsIG51bGwsIHQpLCByLmlzRGVmYXVsdFByZXZlbnRlZCgpICYmIG4ucHJldmVudERlZmF1bHQoKTsKICAgIH0KICB9LCBwZS5yZW1vdmVFdmVudCA9IHJlLnJlbW92ZUV2ZW50TGlzdGVuZXIgPyBmdW5jdGlvbiAoZSwgdCwgbikgewogICAgZS5yZW1vdmVFdmVudExpc3RlbmVyICYmIGUucmVtb3ZlRXZlbnRMaXN0ZW5lcih0LCBuKTsKICB9IDogZnVuY3Rpb24gKGUsIHQsIG4pIHsKICAgIHZhciByID0gIm9uIiArIHQ7CiAgICBlLmRldGFjaEV2ZW50ICYmICgidW5kZWZpbmVkIiA9PSB0eXBlb2YgZVtyXSAmJiAoZVtyXSA9IG51bGwpLCBlLmRldGFjaEV2ZW50KHIsIG4pKTsKICB9LCBwZS5FdmVudCA9IGZ1bmN0aW9uIChlLCB0KSB7CiAgICByZXR1cm4gdGhpcyBpbnN0YW5jZW9mIHBlLkV2ZW50ID8gKGUgJiYgZS50eXBlID8gKHRoaXMub3JpZ2luYWxFdmVudCA9IGUsIHRoaXMudHlwZSA9IGUudHlwZSwgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBlLmRlZmF1bHRQcmV2ZW50ZWQgfHwgdm9pZCAwID09PSBlLmRlZmF1bHRQcmV2ZW50ZWQgJiYgZS5yZXR1cm5WYWx1ZSA9PT0gITEgPyB2IDogeCkgOiB0aGlzLnR5cGUgPSBlLCB0ICYmIHBlLmV4dGVuZCh0aGlzLCB0KSwgdGhpcy50aW1lU3RhbXAgPSBlICYmIGUudGltZVN0YW1wIHx8IHBlLm5vdygpLCB2b2lkICh0aGlzW3BlLmV4cGFuZG9dID0gITApKSA6IG5ldyBwZS5FdmVudChlLCB0KTsKICB9LCBwZS5FdmVudC5wcm90b3R5cGUgPSB7CiAgICBjb25zdHJ1Y3RvcjogcGUuRXZlbnQsCiAgICBpc0RlZmF1bHRQcmV2ZW50ZWQ6IHgsCiAgICBpc1Byb3BhZ2F0aW9uU3RvcHBlZDogeCwKICAgIGlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOiB4LAogICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uIHByZXZlbnREZWZhdWx0KCkgewogICAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSB2LCBlICYmIChlLnByZXZlbnREZWZhdWx0ID8gZS5wcmV2ZW50RGVmYXVsdCgpIDogZS5yZXR1cm5WYWx1ZSA9ICExKTsKICAgIH0sCiAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uIHN0b3BQcm9wYWdhdGlvbigpIHsKICAgICAgdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CiAgICAgIHRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSB2LCBlICYmICF0aGlzLmlzU2ltdWxhdGVkICYmIChlLnN0b3BQcm9wYWdhdGlvbiAmJiBlLnN0b3BQcm9wYWdhdGlvbigpLCBlLmNhbmNlbEJ1YmJsZSA9ICEwKTsKICAgIH0sCiAgICBzdG9wSW1tZWRpYXRlUHJvcGFnYXRpb246IGZ1bmN0aW9uIHN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpIHsKICAgICAgdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CiAgICAgIHRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSB2LCBlICYmIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uICYmIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCksIHRoaXMuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICB9CiAgfSwgcGUuZWFjaCh7CiAgICBtb3VzZWVudGVyOiAibW91c2VvdmVyIiwKICAgIG1vdXNlbGVhdmU6ICJtb3VzZW91dCIsCiAgICBwb2ludGVyZW50ZXI6ICJwb2ludGVyb3ZlciIsCiAgICBwb2ludGVybGVhdmU6ICJwb2ludGVyb3V0IgogIH0sIGZ1bmN0aW9uIChlLCB0KSB7CiAgICBwZS5ldmVudC5zcGVjaWFsW2VdID0gewogICAgICBkZWxlZ2F0ZVR5cGU6IHQsCiAgICAgIGJpbmRUeXBlOiB0LAogICAgICBoYW5kbGU6IGZ1bmN0aW9uIGhhbmRsZShlKSB7CiAgICAgICAgdmFyIG4sCiAgICAgICAgICAgIHIgPSB0aGlzLAogICAgICAgICAgICBpID0gZS5yZWxhdGVkVGFyZ2V0LAogICAgICAgICAgICBvID0gZS5oYW5kbGVPYmo7CiAgICAgICAgcmV0dXJuIGkgJiYgKGkgPT09IHIgfHwgcGUuY29udGFpbnMociwgaSkpIHx8IChlLnR5cGUgPSBvLm9yaWdUeXBlLCBuID0gby5oYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyksIGUudHlwZSA9IHQpLCBuOwogICAgICB9CiAgICB9OwogIH0pLCBmZS5zdWJtaXQgfHwgKHBlLmV2ZW50LnNwZWNpYWwuc3VibWl0ID0gewogICAgc2V0dXA6IGZ1bmN0aW9uIHNldHVwKCkgewogICAgICByZXR1cm4gIXBlLm5vZGVOYW1lKHRoaXMsICJmb3JtIikgJiYgdm9pZCBwZS5ldmVudC5hZGQodGhpcywgImNsaWNrLl9zdWJtaXQga2V5cHJlc3MuX3N1Ym1pdCIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdmFyIHQgPSBlLnRhcmdldCwKICAgICAgICAgICAgbiA9IHBlLm5vZGVOYW1lKHQsICJpbnB1dCIpIHx8IHBlLm5vZGVOYW1lKHQsICJidXR0b24iKSA/IHBlLnByb3AodCwgImZvcm0iKSA6IHZvaWQgMDsKICAgICAgICBuICYmICFwZS5fZGF0YShuLCAic3VibWl0IikgJiYgKHBlLmV2ZW50LmFkZChuLCAic3VibWl0Ll9zdWJtaXQiLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgZS5fc3VibWl0QnViYmxlID0gITA7CiAgICAgICAgfSksIHBlLl9kYXRhKG4sICJzdWJtaXQiLCAhMCkpOwogICAgICB9KTsKICAgIH0sCiAgICBwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uIHBvc3REaXNwYXRjaChlKSB7CiAgICAgIGUuX3N1Ym1pdEJ1YmJsZSAmJiAoZGVsZXRlIGUuX3N1Ym1pdEJ1YmJsZSwgdGhpcy5wYXJlbnROb2RlICYmICFlLmlzVHJpZ2dlciAmJiBwZS5ldmVudC5zaW11bGF0ZSgic3VibWl0IiwgdGhpcy5wYXJlbnROb2RlLCBlKSk7CiAgICB9LAogICAgdGVhcmRvd246IGZ1bmN0aW9uIHRlYXJkb3duKCkgewogICAgICByZXR1cm4gIXBlLm5vZGVOYW1lKHRoaXMsICJmb3JtIikgJiYgdm9pZCBwZS5ldmVudC5yZW1vdmUodGhpcywgIi5fc3VibWl0Iik7CiAgICB9CiAgfSksIGZlLmNoYW5nZSB8fCAocGUuZXZlbnQuc3BlY2lhbC5jaGFuZ2UgPSB7CiAgICBzZXR1cDogZnVuY3Rpb24gc2V0dXAoKSB7CiAgICAgIHJldHVybiBZZS50ZXN0KHRoaXMubm9kZU5hbWUpID8gKCJjaGVja2JveCIgIT09IHRoaXMudHlwZSAmJiAicmFkaW8iICE9PSB0aGlzLnR5cGUgfHwgKHBlLmV2ZW50LmFkZCh0aGlzLCAicHJvcGVydHljaGFuZ2UuX2NoYW5nZSIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgImNoZWNrZWQiID09PSBlLm9yaWdpbmFsRXZlbnQucHJvcGVydHlOYW1lICYmICh0aGlzLl9qdXN0Q2hhbmdlZCA9ICEwKTsKICAgICAgfSksIHBlLmV2ZW50LmFkZCh0aGlzLCAiY2xpY2suX2NoYW5nZSIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdGhpcy5fanVzdENoYW5nZWQgJiYgIWUuaXNUcmlnZ2VyICYmICh0aGlzLl9qdXN0Q2hhbmdlZCA9ICExKSwgcGUuZXZlbnQuc2ltdWxhdGUoImNoYW5nZSIsIHRoaXMsIGUpOwogICAgICB9KSksICExKSA6IHZvaWQgcGUuZXZlbnQuYWRkKHRoaXMsICJiZWZvcmVhY3RpdmF0ZS5fY2hhbmdlIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICB2YXIgdCA9IGUudGFyZ2V0OwogICAgICAgIFllLnRlc3QodC5ub2RlTmFtZSkgJiYgIXBlLl9kYXRhKHQsICJjaGFuZ2UiKSAmJiAocGUuZXZlbnQuYWRkKHQsICJjaGFuZ2UuX2NoYW5nZSIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAhdGhpcy5wYXJlbnROb2RlIHx8IGUuaXNTaW11bGF0ZWQgfHwgZS5pc1RyaWdnZXIgfHwgcGUuZXZlbnQuc2ltdWxhdGUoImNoYW5nZSIsIHRoaXMucGFyZW50Tm9kZSwgZSk7CiAgICAgICAgfSksIHBlLl9kYXRhKHQsICJjaGFuZ2UiLCAhMCkpOwogICAgICB9KTsKICAgIH0sCiAgICBoYW5kbGU6IGZ1bmN0aW9uIGhhbmRsZShlKSB7CiAgICAgIHZhciB0ID0gZS50YXJnZXQ7CiAgICAgIGlmICh0aGlzICE9PSB0IHx8IGUuaXNTaW11bGF0ZWQgfHwgZS5pc1RyaWdnZXIgfHwgInJhZGlvIiAhPT0gdC50eXBlICYmICJjaGVja2JveCIgIT09IHQudHlwZSkgcmV0dXJuIGUuaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICB0ZWFyZG93bjogZnVuY3Rpb24gdGVhcmRvd24oKSB7CiAgICAgIHJldHVybiBwZS5ldmVudC5yZW1vdmUodGhpcywgIi5fY2hhbmdlIiksICFZZS50ZXN0KHRoaXMubm9kZU5hbWUpOwogICAgfQogIH0pLCBmZS5mb2N1c2luIHx8IHBlLmVhY2goewogICAgZm9jdXM6ICJmb2N1c2luIiwKICAgIGJsdXI6ICJmb2N1c291dCIKICB9LCBmdW5jdGlvbiAoZSwgdCkgewogICAgdmFyIG4gPSBmdW5jdGlvbiBuKGUpIHsKICAgICAgcGUuZXZlbnQuc2ltdWxhdGUodCwgZS50YXJnZXQsIHBlLmV2ZW50LmZpeChlKSk7CiAgICB9OwoKICAgIHBlLmV2ZW50LnNwZWNpYWxbdF0gPSB7CiAgICAgIHNldHVwOiBmdW5jdGlvbiBzZXR1cCgpIHsKICAgICAgICB2YXIgciA9IHRoaXMub3duZXJEb2N1bWVudCB8fCB0aGlzLAogICAgICAgICAgICBpID0gcGUuX2RhdGEociwgdCk7CgogICAgICAgIGkgfHwgci5hZGRFdmVudExpc3RlbmVyKGUsIG4sICEwKSwgcGUuX2RhdGEociwgdCwgKGkgfHwgMCkgKyAxKTsKICAgICAgfSwKICAgICAgdGVhcmRvd246IGZ1bmN0aW9uIHRlYXJkb3duKCkgewogICAgICAgIHZhciByID0gdGhpcy5vd25lckRvY3VtZW50IHx8IHRoaXMsCiAgICAgICAgICAgIGkgPSBwZS5fZGF0YShyLCB0KSAtIDE7CiAgICAgICAgaSA/IHBlLl9kYXRhKHIsIHQsIGkpIDogKHIucmVtb3ZlRXZlbnRMaXN0ZW5lcihlLCBuLCAhMCksIHBlLl9yZW1vdmVEYXRhKHIsIHQpKTsKICAgICAgfQogICAgfTsKICB9KSwgcGUuZm4uZXh0ZW5kKHsKICAgIG9uOiBmdW5jdGlvbiBvbihlLCB0LCBuLCByKSB7CiAgICAgIHJldHVybiB3KHRoaXMsIGUsIHQsIG4sIHIpOwogICAgfSwKICAgIG9uZTogZnVuY3Rpb24gb25lKGUsIHQsIG4sIHIpIHsKICAgICAgcmV0dXJuIHcodGhpcywgZSwgdCwgbiwgciwgMSk7CiAgICB9LAogICAgb2ZmOiBmdW5jdGlvbiBvZmYoZSwgdCwgbikgewogICAgICB2YXIgciwgaTsKICAgICAgaWYgKGUgJiYgZS5wcmV2ZW50RGVmYXVsdCAmJiBlLmhhbmRsZU9iaikgcmV0dXJuIHIgPSBlLmhhbmRsZU9iaiwgcGUoZS5kZWxlZ2F0ZVRhcmdldCkub2ZmKHIubmFtZXNwYWNlID8gci5vcmlnVHlwZSArICIuIiArIHIubmFtZXNwYWNlIDogci5vcmlnVHlwZSwgci5zZWxlY3Rvciwgci5oYW5kbGVyKSwgdGhpczsKCiAgICAgIGlmICgib2JqZWN0IiA9PSBfdHlwZW9mKGUpKSB7CiAgICAgICAgZm9yIChpIGluIGUpIHsKICAgICAgICAgIHRoaXMub2ZmKGksIHQsIGVbaV0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIHJldHVybiB0ICE9PSAhMSAmJiAiZnVuY3Rpb24iICE9IHR5cGVvZiB0IHx8IChuID0gdCwgdCA9IHZvaWQgMCksIG4gPT09ICExICYmIChuID0geCksIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgcGUuZXZlbnQucmVtb3ZlKHRoaXMsIGUsIG4sIHQpOwogICAgICB9KTsKICAgIH0sCiAgICB0cmlnZ2VyOiBmdW5jdGlvbiB0cmlnZ2VyKGUsIHQpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgcGUuZXZlbnQudHJpZ2dlcihlLCB0LCB0aGlzKTsKICAgICAgfSk7CiAgICB9LAogICAgdHJpZ2dlckhhbmRsZXI6IGZ1bmN0aW9uIHRyaWdnZXJIYW5kbGVyKGUsIHQpIHsKICAgICAgdmFyIG4gPSB0aGlzWzBdOwogICAgICBpZiAobikgcmV0dXJuIHBlLmV2ZW50LnRyaWdnZXIoZSwgdCwgbiwgITApOwogICAgfQogIH0pOwogIHZhciBaZSA9IC8galF1ZXJ5XGQrPSIoPzpudWxsfFxkKykiL2csCiAgICAgIGV0ID0gbmV3IFJlZ0V4cCgiPCg/OiIgKyB6ZSArICIpW1xccy8+XSIsICJpIiksCiAgICAgIHR0ID0gLzwoPyFhcmVhfGJyfGNvbHxlbWJlZHxocnxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtKSgoW1x3Oi1dKylbXj5dKilcLz4vZ2ksCiAgICAgIG50ID0gLzxzY3JpcHR8PHN0eWxlfDxsaW5rL2ksCiAgICAgIHJ0ID0gL2NoZWNrZWRccyooPzpbXj1dfD1ccyouY2hlY2tlZC4pL2ksCiAgICAgIGl0ID0gL150cnVlXC8oLiopLywKICAgICAgb3QgPSAvXlxzKjwhKD86XFtDREFUQVxbfC0tKXwoPzpcXVxdfC0tKT5ccyokL2csCiAgICAgIGF0ID0gcChyZSksCiAgICAgIHN0ID0gYXQuYXBwZW5kQ2hpbGQocmUuY3JlYXRlRWxlbWVudCgiZGl2IikpOwogIHBlLmV4dGVuZCh7CiAgICBodG1sUHJlZmlsdGVyOiBmdW5jdGlvbiBodG1sUHJlZmlsdGVyKGUpIHsKICAgICAgcmV0dXJuIGUucmVwbGFjZSh0dCwgIjwkMT48LyQyPiIpOwogICAgfSwKICAgIGNsb25lOiBmdW5jdGlvbiBjbG9uZShlLCB0LCBuKSB7CiAgICAgIHZhciByLAogICAgICAgICAgaSwKICAgICAgICAgIG8sCiAgICAgICAgICBhLAogICAgICAgICAgcywKICAgICAgICAgIHUgPSBwZS5jb250YWlucyhlLm93bmVyRG9jdW1lbnQsIGUpOwogICAgICBpZiAoZmUuaHRtbDVDbG9uZSB8fCBwZS5pc1hNTERvYyhlKSB8fCAhZXQudGVzdCgiPCIgKyBlLm5vZGVOYW1lICsgIj4iKSA/IG8gPSBlLmNsb25lTm9kZSghMCkgOiAoc3QuaW5uZXJIVE1MID0gZS5vdXRlckhUTUwsIHN0LnJlbW92ZUNoaWxkKG8gPSBzdC5maXJzdENoaWxkKSksICEoZmUubm9DbG9uZUV2ZW50ICYmIGZlLm5vQ2xvbmVDaGVja2VkIHx8IDEgIT09IGUubm9kZVR5cGUgJiYgMTEgIT09IGUubm9kZVR5cGUgfHwgcGUuaXNYTUxEb2MoZSkpKSBmb3IgKHIgPSBoKG8pLCBzID0gaChlKSwgYSA9IDA7IG51bGwgIT0gKGkgPSBzW2FdKTsgKythKSB7CiAgICAgICAgclthXSAmJiBrKGksIHJbYV0pOwogICAgICB9CiAgICAgIGlmICh0KSBpZiAobikgZm9yIChzID0gcyB8fCBoKGUpLCByID0gciB8fCBoKG8pLCBhID0gMDsgbnVsbCAhPSAoaSA9IHNbYV0pOyBhKyspIHsKICAgICAgICBOKGksIHJbYV0pOwogICAgICB9IGVsc2UgTihlLCBvKTsKICAgICAgcmV0dXJuIHIgPSBoKG8sICJzY3JpcHQiKSwgci5sZW5ndGggPiAwICYmIGcociwgIXUgJiYgaChlLCAic2NyaXB0IikpLCByID0gcyA9IGkgPSBudWxsLCBvOwogICAgfSwKICAgIGNsZWFuRGF0YTogZnVuY3Rpb24gY2xlYW5EYXRhKGUsIHQpIHsKICAgICAgZm9yICh2YXIgbiwgciwgaSwgbywgYSA9IDAsIHMgPSBwZS5leHBhbmRvLCB1ID0gcGUuY2FjaGUsIGwgPSBmZS5hdHRyaWJ1dGVzLCBjID0gcGUuZXZlbnQuc3BlY2lhbDsgbnVsbCAhPSAobiA9IGVbYV0pOyBhKyspIHsKICAgICAgICBpZiAoKHQgfHwgSGUobikpICYmIChpID0gbltzXSwgbyA9IGkgJiYgdVtpXSkpIHsKICAgICAgICAgIGlmIChvLmV2ZW50cykgZm9yIChyIGluIG8uZXZlbnRzKSB7CiAgICAgICAgICAgIGNbcl0gPyBwZS5ldmVudC5yZW1vdmUobiwgcikgOiBwZS5yZW1vdmVFdmVudChuLCByLCBvLmhhbmRsZSk7CiAgICAgICAgICB9CiAgICAgICAgICB1W2ldICYmIChkZWxldGUgdVtpXSwgbCB8fCAidW5kZWZpbmVkIiA9PSB0eXBlb2Ygbi5yZW1vdmVBdHRyaWJ1dGUgPyBuW3NdID0gdm9pZCAwIDogbi5yZW1vdmVBdHRyaWJ1dGUocyksIG5lLnB1c2goaSkpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pLCBwZS5mbi5leHRlbmQoewogICAgZG9tTWFuaXA6IFMsCiAgICBkZXRhY2g6IGZ1bmN0aW9uIGRldGFjaChlKSB7CiAgICAgIHJldHVybiBBKHRoaXMsIGUsICEwKTsKICAgIH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uIHJlbW92ZShlKSB7CiAgICAgIHJldHVybiBBKHRoaXMsIGUpOwogICAgfSwKICAgIHRleHQ6IGZ1bmN0aW9uIHRleHQoZSkgewogICAgICByZXR1cm4gUGUodGhpcywgZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4gdm9pZCAwID09PSBlID8gcGUudGV4dCh0aGlzKSA6IHRoaXMuZW1wdHkoKS5hcHBlbmQoKHRoaXNbMF0gJiYgdGhpc1swXS5vd25lckRvY3VtZW50IHx8IHJlKS5jcmVhdGVUZXh0Tm9kZShlKSk7CiAgICAgIH0sIG51bGwsIGUsIGFyZ3VtZW50cy5sZW5ndGgpOwogICAgfSwKICAgIGFwcGVuZDogZnVuY3Rpb24gYXBwZW5kKCkgewogICAgICByZXR1cm4gUyh0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgaWYgKDEgPT09IHRoaXMubm9kZVR5cGUgfHwgMTEgPT09IHRoaXMubm9kZVR5cGUgfHwgOSA9PT0gdGhpcy5ub2RlVHlwZSkgewogICAgICAgICAgdmFyIHQgPSBUKHRoaXMsIGUpOwogICAgICAgICAgdC5hcHBlbmRDaGlsZChlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIHByZXBlbmQ6IGZ1bmN0aW9uIHByZXBlbmQoKSB7CiAgICAgIHJldHVybiBTKHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24gKGUpIHsKICAgICAgICBpZiAoMSA9PT0gdGhpcy5ub2RlVHlwZSB8fCAxMSA9PT0gdGhpcy5ub2RlVHlwZSB8fCA5ID09PSB0aGlzLm5vZGVUeXBlKSB7CiAgICAgICAgICB2YXIgdCA9IFQodGhpcywgZSk7CiAgICAgICAgICB0Lmluc2VydEJlZm9yZShlLCB0LmZpcnN0Q2hpbGQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgYmVmb3JlOiBmdW5jdGlvbiBiZWZvcmUoKSB7CiAgICAgIHJldHVybiBTKHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24gKGUpIHsKICAgICAgICB0aGlzLnBhcmVudE5vZGUgJiYgdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZShlLCB0aGlzKTsKICAgICAgfSk7CiAgICB9LAogICAgYWZ0ZXI6IGZ1bmN0aW9uIGFmdGVyKCkgewogICAgICByZXR1cm4gUyh0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdGhpcy5wYXJlbnROb2RlICYmIHRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoZSwgdGhpcy5uZXh0U2libGluZyk7CiAgICAgIH0pOwogICAgfSwKICAgIGVtcHR5OiBmdW5jdGlvbiBlbXB0eSgpIHsKICAgICAgZm9yICh2YXIgZSwgdCA9IDA7IG51bGwgIT0gKGUgPSB0aGlzW3RdKTsgdCsrKSB7CiAgICAgICAgZm9yICgxID09PSBlLm5vZGVUeXBlICYmIHBlLmNsZWFuRGF0YShoKGUsICExKSk7IGUuZmlyc3RDaGlsZDspIHsKICAgICAgICAgIGUucmVtb3ZlQ2hpbGQoZS5maXJzdENoaWxkKTsKICAgICAgICB9CgogICAgICAgIGUub3B0aW9ucyAmJiBwZS5ub2RlTmFtZShlLCAic2VsZWN0IikgJiYgKGUub3B0aW9ucy5sZW5ndGggPSAwKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgY2xvbmU6IGZ1bmN0aW9uIGNsb25lKGUsIHQpIHsKICAgICAgcmV0dXJuIGUgPSBudWxsICE9IGUgJiYgZSwgdCA9IG51bGwgPT0gdCA/IGUgOiB0LCB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHBlLmNsb25lKHRoaXMsIGUsIHQpOwogICAgICB9KTsKICAgIH0sCiAgICBodG1sOiBmdW5jdGlvbiBodG1sKGUpIHsKICAgICAgcmV0dXJuIFBlKHRoaXMsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdmFyIHQgPSB0aGlzWzBdIHx8IHt9LAogICAgICAgICAgICBuID0gMCwKICAgICAgICAgICAgciA9IHRoaXMubGVuZ3RoOwogICAgICAgIGlmICh2b2lkIDAgPT09IGUpIHJldHVybiAxID09PSB0Lm5vZGVUeXBlID8gdC5pbm5lckhUTUwucmVwbGFjZShaZSwgIiIpIDogdm9pZCAwOwoKICAgICAgICBpZiAoInN0cmluZyIgPT0gdHlwZW9mIGUgJiYgIW50LnRlc3QoZSkgJiYgKGZlLmh0bWxTZXJpYWxpemUgfHwgIWV0LnRlc3QoZSkpICYmIChmZS5sZWFkaW5nV2hpdGVzcGFjZSB8fCAhJGUudGVzdChlKSkgJiYgIVhlWyhXZS5leGVjKGUpIHx8IFsiIiwgIiJdKVsxXS50b0xvd2VyQ2FzZSgpXSkgewogICAgICAgICAgZSA9IHBlLmh0bWxQcmVmaWx0ZXIoZSk7CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZm9yICg7IG4gPCByOyBuKyspIHsKICAgICAgICAgICAgICB0ID0gdGhpc1tuXSB8fCB7fSwgMSA9PT0gdC5ub2RlVHlwZSAmJiAocGUuY2xlYW5EYXRhKGgodCwgITEpKSwgdC5pbm5lckhUTUwgPSBlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdCA9IDA7CiAgICAgICAgICB9IGNhdGNoIChpKSB7fQogICAgICAgIH0KCiAgICAgICAgdCAmJiB0aGlzLmVtcHR5KCkuYXBwZW5kKGUpOwogICAgICB9LCBudWxsLCBlLCBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0sCiAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24gcmVwbGFjZVdpdGgoKSB7CiAgICAgIHZhciBlID0gW107CiAgICAgIHJldHVybiBTKHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24gKHQpIHsKICAgICAgICB2YXIgbiA9IHRoaXMucGFyZW50Tm9kZTsKICAgICAgICBwZS5pbkFycmF5KHRoaXMsIGUpIDwgMCAmJiAocGUuY2xlYW5EYXRhKGgodGhpcykpLCBuICYmIG4ucmVwbGFjZUNoaWxkKHQsIHRoaXMpKTsKICAgICAgfSwgZSk7CiAgICB9CiAgfSksIHBlLmVhY2goewogICAgYXBwZW5kVG86ICJhcHBlbmQiLAogICAgcHJlcGVuZFRvOiAicHJlcGVuZCIsCiAgICBpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAogICAgaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCiAgICByZXBsYWNlQWxsOiAicmVwbGFjZVdpdGgiCiAgfSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgIHBlLmZuW2VdID0gZnVuY3Rpb24gKGUpIHsKICAgICAgZm9yICh2YXIgbiwgciA9IDAsIGkgPSBbXSwgbyA9IHBlKGUpLCBhID0gby5sZW5ndGggLSAxOyByIDw9IGE7IHIrKykgewogICAgICAgIG4gPSByID09PSBhID8gdGhpcyA6IHRoaXMuY2xvbmUoITApLCBwZShvW3JdKVt0XShuKSwgYWUuYXBwbHkoaSwgbi5nZXQoKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhpKTsKICAgIH07CiAgfSk7CgogIHZhciB1dCwKICAgICAgbHQgPSB7CiAgICBIVE1MOiAiYmxvY2siLAogICAgQk9EWTogImJsb2NrIgogIH0sCiAgICAgIGN0ID0gL15tYXJnaW4vLAogICAgICBmdCA9IG5ldyBSZWdFeHAoIl4oIiArIEZlICsgIikoPyFweClbYS16JV0rJCIsICJpIiksCiAgICAgIGR0ID0gZnVuY3Rpb24gZHQoZSwgdCwgbiwgcikgewogICAgdmFyIGksCiAgICAgICAgbywKICAgICAgICBhID0ge307CgogICAgZm9yIChvIGluIHQpIHsKICAgICAgYVtvXSA9IGUuc3R5bGVbb10sIGUuc3R5bGVbb10gPSB0W29dOwogICAgfQoKICAgIGkgPSBuLmFwcGx5KGUsIHIgfHwgW10pOwoKICAgIGZvciAobyBpbiB0KSB7CiAgICAgIGUuc3R5bGVbb10gPSBhW29dOwogICAgfQoKICAgIHJldHVybiBpOwogIH0sCiAgICAgIHB0ID0gcmUuZG9jdW1lbnRFbGVtZW50OwoKICAhZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gdCgpIHsKICAgICAgdmFyIHQsCiAgICAgICAgICBjLAogICAgICAgICAgZiA9IHJlLmRvY3VtZW50RWxlbWVudDsKICAgICAgZi5hcHBlbmRDaGlsZCh1KSwgbC5zdHlsZS5jc3NUZXh0ID0gIi13ZWJraXQtYm94LXNpemluZzpib3JkZXItYm94O2JveC1zaXppbmc6Ym9yZGVyLWJveDtwb3NpdGlvbjpyZWxhdGl2ZTtkaXNwbGF5OmJsb2NrO21hcmdpbjphdXRvO2JvcmRlcjoxcHg7cGFkZGluZzoxcHg7dG9wOjElO3dpZHRoOjUwJSIsIG4gPSBpID0gcyA9ICExLCByID0gYSA9ICEwLCBlLmdldENvbXB1dGVkU3R5bGUgJiYgKGMgPSBlLmdldENvbXB1dGVkU3R5bGUobCksIG4gPSAiMSUiICE9PSAoYyB8fCB7fSkudG9wLCBzID0gIjJweCIgPT09IChjIHx8IHt9KS5tYXJnaW5MZWZ0LCBpID0gIjRweCIgPT09IChjIHx8IHsKICAgICAgICB3aWR0aDogIjRweCIKICAgICAgfSkud2lkdGgsIGwuc3R5bGUubWFyZ2luUmlnaHQgPSAiNTAlIiwgciA9ICI0cHgiID09PSAoYyB8fCB7CiAgICAgICAgbWFyZ2luUmlnaHQ6ICI0cHgiCiAgICAgIH0pLm1hcmdpblJpZ2h0LCB0ID0gbC5hcHBlbmRDaGlsZChyZS5jcmVhdGVFbGVtZW50KCJkaXYiKSksIHQuc3R5bGUuY3NzVGV4dCA9IGwuc3R5bGUuY3NzVGV4dCA9ICItd2Via2l0LWJveC1zaXppbmc6Y29udGVudC1ib3g7LW1vei1ib3gtc2l6aW5nOmNvbnRlbnQtYm94O2JveC1zaXppbmc6Y29udGVudC1ib3g7ZGlzcGxheTpibG9jazttYXJnaW46MDtib3JkZXI6MDtwYWRkaW5nOjAiLCB0LnN0eWxlLm1hcmdpblJpZ2h0ID0gdC5zdHlsZS53aWR0aCA9ICIwIiwgbC5zdHlsZS53aWR0aCA9ICIxcHgiLCBhID0gIXBhcnNlRmxvYXQoKGUuZ2V0Q29tcHV0ZWRTdHlsZSh0KSB8fCB7fSkubWFyZ2luUmlnaHQpLCBsLnJlbW92ZUNoaWxkKHQpKSwgbC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiLCBvID0gMCA9PT0gbC5nZXRDbGllbnRSZWN0cygpLmxlbmd0aCwgbyAmJiAobC5zdHlsZS5kaXNwbGF5ID0gIiIsIGwuaW5uZXJIVE1MID0gIjx0YWJsZT48dHI+PHRkPjwvdGQ+PHRkPnQ8L3RkPjwvdHI+PC90YWJsZT4iLCBsLmNoaWxkTm9kZXNbMF0uc3R5bGUuYm9yZGVyQ29sbGFwc2UgPSAic2VwYXJhdGUiLCB0ID0gbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGQiKSwgdFswXS5zdHlsZS5jc3NUZXh0ID0gIm1hcmdpbjowO2JvcmRlcjowO3BhZGRpbmc6MDtkaXNwbGF5Om5vbmUiLCBvID0gMCA9PT0gdFswXS5vZmZzZXRIZWlnaHQsIG8gJiYgKHRbMF0uc3R5bGUuZGlzcGxheSA9ICIiLCB0WzFdLnN0eWxlLmRpc3BsYXkgPSAibm9uZSIsIG8gPSAwID09PSB0WzBdLm9mZnNldEhlaWdodCkpLCBmLnJlbW92ZUNoaWxkKHUpOwogICAgfQoKICAgIHZhciBuLAogICAgICAgIHIsCiAgICAgICAgaSwKICAgICAgICBvLAogICAgICAgIGEsCiAgICAgICAgcywKICAgICAgICB1ID0gcmUuY3JlYXRlRWxlbWVudCgiZGl2IiksCiAgICAgICAgbCA9IHJlLmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgbC5zdHlsZSAmJiAobC5zdHlsZS5jc3NUZXh0ID0gImZsb2F0OmxlZnQ7b3BhY2l0eTouNSIsIGZlLm9wYWNpdHkgPSAiMC41IiA9PT0gbC5zdHlsZS5vcGFjaXR5LCBmZS5jc3NGbG9hdCA9ICEhbC5zdHlsZS5jc3NGbG9hdCwgbC5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICJjb250ZW50LWJveCIsIGwuY2xvbmVOb2RlKCEwKS5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICIiLCBmZS5jbGVhckNsb25lU3R5bGUgPSAiY29udGVudC1ib3giID09PSBsLnN0eWxlLmJhY2tncm91bmRDbGlwLCB1ID0gcmUuY3JlYXRlRWxlbWVudCgiZGl2IiksIHUuc3R5bGUuY3NzVGV4dCA9ICJib3JkZXI6MDt3aWR0aDo4cHg7aGVpZ2h0OjA7dG9wOjA7bGVmdDotOTk5OXB4O3BhZGRpbmc6MDttYXJnaW4tdG9wOjFweDtwb3NpdGlvbjphYnNvbHV0ZSIsIGwuaW5uZXJIVE1MID0gIiIsIHUuYXBwZW5kQ2hpbGQobCksIGZlLmJveFNpemluZyA9ICIiID09PSBsLnN0eWxlLmJveFNpemluZyB8fCAiIiA9PT0gbC5zdHlsZS5Nb3pCb3hTaXppbmcgfHwgIiIgPT09IGwuc3R5bGUuV2Via2l0Qm94U2l6aW5nLCBwZS5leHRlbmQoZmUsIHsKICAgICAgcmVsaWFibGVIaWRkZW5PZmZzZXRzOiBmdW5jdGlvbiByZWxpYWJsZUhpZGRlbk9mZnNldHMoKSB7CiAgICAgICAgcmV0dXJuIG51bGwgPT0gbiAmJiB0KCksIG87CiAgICAgIH0sCiAgICAgIGJveFNpemluZ1JlbGlhYmxlOiBmdW5jdGlvbiBib3hTaXppbmdSZWxpYWJsZSgpIHsKICAgICAgICByZXR1cm4gbnVsbCA9PSBuICYmIHQoKSwgaTsKICAgICAgfSwKICAgICAgcGl4ZWxNYXJnaW5SaWdodDogZnVuY3Rpb24gcGl4ZWxNYXJnaW5SaWdodCgpIHsKICAgICAgICByZXR1cm4gbnVsbCA9PSBuICYmIHQoKSwgcjsKICAgICAgfSwKICAgICAgcGl4ZWxQb3NpdGlvbjogZnVuY3Rpb24gcGl4ZWxQb3NpdGlvbigpIHsKICAgICAgICByZXR1cm4gbnVsbCA9PSBuICYmIHQoKSwgbjsKICAgICAgfSwKICAgICAgcmVsaWFibGVNYXJnaW5SaWdodDogZnVuY3Rpb24gcmVsaWFibGVNYXJnaW5SaWdodCgpIHsKICAgICAgICByZXR1cm4gbnVsbCA9PSBuICYmIHQoKSwgYTsKICAgICAgfSwKICAgICAgcmVsaWFibGVNYXJnaW5MZWZ0OiBmdW5jdGlvbiByZWxpYWJsZU1hcmdpbkxlZnQoKSB7CiAgICAgICAgcmV0dXJuIG51bGwgPT0gbiAmJiB0KCksIHM7CiAgICAgIH0KICAgIH0pKTsKICB9KCk7CiAgdmFyIGh0LAogICAgICBndCwKICAgICAgbXQgPSAvXih0b3B8cmlnaHR8Ym90dG9tfGxlZnQpJC87CiAgZS5nZXRDb21wdXRlZFN0eWxlID8gKGh0ID0gZnVuY3Rpb24gaHQodCkgewogICAgdmFyIG4gPSB0Lm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXc7CiAgICByZXR1cm4gbiAmJiBuLm9wZW5lciB8fCAobiA9IGUpLCBuLmdldENvbXB1dGVkU3R5bGUodCk7CiAgfSwgZ3QgPSBmdW5jdGlvbiBndChlLCB0LCBuKSB7CiAgICB2YXIgciwKICAgICAgICBpLAogICAgICAgIG8sCiAgICAgICAgYSwKICAgICAgICBzID0gZS5zdHlsZTsKICAgIHJldHVybiBuID0gbiB8fCBodChlKSwgYSA9IG4gPyBuLmdldFByb3BlcnR5VmFsdWUodCkgfHwgblt0XSA6IHZvaWQgMCwgIiIgIT09IGEgJiYgdm9pZCAwICE9PSBhIHx8IHBlLmNvbnRhaW5zKGUub3duZXJEb2N1bWVudCwgZSkgfHwgKGEgPSBwZS5zdHlsZShlLCB0KSksIG4gJiYgIWZlLnBpeGVsTWFyZ2luUmlnaHQoKSAmJiBmdC50ZXN0KGEpICYmIGN0LnRlc3QodCkgJiYgKHIgPSBzLndpZHRoLCBpID0gcy5taW5XaWR0aCwgbyA9IHMubWF4V2lkdGgsIHMubWluV2lkdGggPSBzLm1heFdpZHRoID0gcy53aWR0aCA9IGEsIGEgPSBuLndpZHRoLCBzLndpZHRoID0gciwgcy5taW5XaWR0aCA9IGksIHMubWF4V2lkdGggPSBvKSwgdm9pZCAwID09PSBhID8gYSA6IGEgKyAiIjsKICB9KSA6IHB0LmN1cnJlbnRTdHlsZSAmJiAoaHQgPSBmdW5jdGlvbiBodChlKSB7CiAgICByZXR1cm4gZS5jdXJyZW50U3R5bGU7CiAgfSwgZ3QgPSBmdW5jdGlvbiBndChlLCB0LCBuKSB7CiAgICB2YXIgciwKICAgICAgICBpLAogICAgICAgIG8sCiAgICAgICAgYSwKICAgICAgICBzID0gZS5zdHlsZTsKICAgIHJldHVybiBuID0gbiB8fCBodChlKSwgYSA9IG4gPyBuW3RdIDogdm9pZCAwLCBudWxsID09IGEgJiYgcyAmJiBzW3RdICYmIChhID0gc1t0XSksIGZ0LnRlc3QoYSkgJiYgIW10LnRlc3QodCkgJiYgKHIgPSBzLmxlZnQsIGkgPSBlLnJ1bnRpbWVTdHlsZSwgbyA9IGkgJiYgaS5sZWZ0LCBvICYmIChpLmxlZnQgPSBlLmN1cnJlbnRTdHlsZS5sZWZ0KSwgcy5sZWZ0ID0gImZvbnRTaXplIiA9PT0gdCA/ICIxZW0iIDogYSwgYSA9IHMucGl4ZWxMZWZ0ICsgInB4Iiwgcy5sZWZ0ID0gciwgbyAmJiAoaS5sZWZ0ID0gbykpLCB2b2lkIDAgPT09IGEgPyBhIDogYSArICIiIHx8ICJhdXRvIjsKICB9KTsKICB2YXIgeXQgPSAvYWxwaGFcKFteKV0qXCkvaSwKICAgICAgdnQgPSAvb3BhY2l0eVxzKj1ccyooW14pXSopL2ksCiAgICAgIHh0ID0gL14obm9uZXx0YWJsZSg/IS1jW2VhXSkuKykvLAogICAgICBidCA9IG5ldyBSZWdFeHAoIl4oIiArIEZlICsgIikoLiopJCIsICJpIiksCiAgICAgIHd0ID0gewogICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICB2aXNpYmlsaXR5OiAiaGlkZGVuIiwKICAgIGRpc3BsYXk6ICJibG9jayIKICB9LAogICAgICBUdCA9IHsKICAgIGxldHRlclNwYWNpbmc6ICIwIiwKICAgIGZvbnRXZWlnaHQ6ICI0MDAiCiAgfSwKICAgICAgQ3QgPSBbIldlYmtpdCIsICJPIiwgIk1veiIsICJtcyJdLAogICAgICBFdCA9IHJlLmNyZWF0ZUVsZW1lbnQoImRpdiIpLnN0eWxlOwogIHBlLmV4dGVuZCh7CiAgICBjc3NIb29rczogewogICAgICBvcGFjaXR5OiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoZSwgdCkgewogICAgICAgICAgaWYgKHQpIHsKICAgICAgICAgICAgdmFyIG4gPSBndChlLCAib3BhY2l0eSIpOwogICAgICAgICAgICByZXR1cm4gIiIgPT09IG4gPyAiMSIgOiBuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGNzc051bWJlcjogewogICAgICBhbmltYXRpb25JdGVyYXRpb25Db3VudDogITAsCiAgICAgIGNvbHVtbkNvdW50OiAhMCwKICAgICAgZmlsbE9wYWNpdHk6ICEwLAogICAgICBmbGV4R3JvdzogITAsCiAgICAgIGZsZXhTaHJpbms6ICEwLAogICAgICBmb250V2VpZ2h0OiAhMCwKICAgICAgbGluZUhlaWdodDogITAsCiAgICAgIG9wYWNpdHk6ICEwLAogICAgICBvcmRlcjogITAsCiAgICAgIG9ycGhhbnM6ICEwLAogICAgICB3aWRvd3M6ICEwLAogICAgICB6SW5kZXg6ICEwLAogICAgICB6b29tOiAhMAogICAgfSwKICAgIGNzc1Byb3BzOiB7CiAgICAgICJmbG9hdCI6IGZlLmNzc0Zsb2F0ID8gImNzc0Zsb2F0IiA6ICJzdHlsZUZsb2F0IgogICAgfSwKICAgIHN0eWxlOiBmdW5jdGlvbiBzdHlsZShlLCB0LCBuLCByKSB7CiAgICAgIGlmIChlICYmIDMgIT09IGUubm9kZVR5cGUgJiYgOCAhPT0gZS5ub2RlVHlwZSAmJiBlLnN0eWxlKSB7CiAgICAgICAgdmFyIGksCiAgICAgICAgICAgIG8sCiAgICAgICAgICAgIGEsCiAgICAgICAgICAgIHMgPSBwZS5jYW1lbENhc2UodCksCiAgICAgICAgICAgIHUgPSBlLnN0eWxlOwogICAgICAgIGlmICh0ID0gcGUuY3NzUHJvcHNbc10gfHwgKHBlLmNzc1Byb3BzW3NdID0gSChzKSB8fCBzKSwgYSA9IHBlLmNzc0hvb2tzW3RdIHx8IHBlLmNzc0hvb2tzW3NdLCB2b2lkIDAgPT09IG4pIHJldHVybiBhICYmICJnZXQiIGluIGEgJiYgdm9pZCAwICE9PSAoaSA9IGEuZ2V0KGUsICExLCByKSkgPyBpIDogdVt0XTsKICAgICAgICBpZiAobyA9IF90eXBlb2YobiksICJzdHJpbmciID09PSBvICYmIChpID0gTWUuZXhlYyhuKSkgJiYgaVsxXSAmJiAobiA9IGQoZSwgdCwgaSksIG8gPSAibnVtYmVyIiksIG51bGwgIT0gbiAmJiBuID09PSBuICYmICgibnVtYmVyIiA9PT0gbyAmJiAobiArPSBpICYmIGlbM10gfHwgKHBlLmNzc051bWJlcltzXSA/ICIiIDogInB4IikpLCBmZS5jbGVhckNsb25lU3R5bGUgfHwgIiIgIT09IG4gfHwgMCAhPT0gdC5pbmRleE9mKCJiYWNrZ3JvdW5kIikgfHwgKHVbdF0gPSAiaW5oZXJpdCIpLCAhKGEgJiYgInNldCIgaW4gYSAmJiB2b2lkIDAgPT09IChuID0gYS5zZXQoZSwgbiwgcikpKSkpIHRyeSB7CiAgICAgICAgICB1W3RdID0gbjsKICAgICAgICB9IGNhdGNoIChsKSB7fQogICAgICB9CiAgICB9LAogICAgY3NzOiBmdW5jdGlvbiBjc3MoZSwgdCwgbiwgcikgewogICAgICB2YXIgaSwKICAgICAgICAgIG8sCiAgICAgICAgICBhLAogICAgICAgICAgcyA9IHBlLmNhbWVsQ2FzZSh0KTsKICAgICAgcmV0dXJuIHQgPSBwZS5jc3NQcm9wc1tzXSB8fCAocGUuY3NzUHJvcHNbc10gPSBIKHMpIHx8IHMpLCBhID0gcGUuY3NzSG9va3NbdF0gfHwgcGUuY3NzSG9va3Nbc10sIGEgJiYgImdldCIgaW4gYSAmJiAobyA9IGEuZ2V0KGUsICEwLCBuKSksIHZvaWQgMCA9PT0gbyAmJiAobyA9IGd0KGUsIHQsIHIpKSwgIm5vcm1hbCIgPT09IG8gJiYgdCBpbiBUdCAmJiAobyA9IFR0W3RdKSwgIiIgPT09IG4gfHwgbiA/IChpID0gcGFyc2VGbG9hdChvKSwgbiA9PT0gITAgfHwgaXNGaW5pdGUoaSkgPyBpIHx8IDAgOiBvKSA6IG87CiAgICB9CiAgfSksIHBlLmVhY2goWyJoZWlnaHQiLCAid2lkdGgiXSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgIHBlLmNzc0hvb2tzW3RdID0gewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldChlLCBuLCByKSB7CiAgICAgICAgaWYgKG4pIHJldHVybiB4dC50ZXN0KHBlLmNzcyhlLCAiZGlzcGxheSIpKSAmJiAwID09PSBlLm9mZnNldFdpZHRoID8gZHQoZSwgd3QsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBNKGUsIHQsIHIpOwogICAgICAgIH0pIDogTShlLCB0LCByKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoZSwgbiwgcikgewogICAgICAgIHZhciBpID0gciAmJiBodChlKTsKICAgICAgICByZXR1cm4gXyhlLCBuLCByID8gRihlLCB0LCByLCBmZS5ib3hTaXppbmcgJiYgImJvcmRlci1ib3giID09PSBwZS5jc3MoZSwgImJveFNpemluZyIsICExLCBpKSwgaSkgOiAwKTsKICAgICAgfQogICAgfTsKICB9KSwgZmUub3BhY2l0eSB8fCAocGUuY3NzSG9va3Mub3BhY2l0eSA9IHsKICAgIGdldDogZnVuY3Rpb24gZ2V0KGUsIHQpIHsKICAgICAgcmV0dXJuIHZ0LnRlc3QoKHQgJiYgZS5jdXJyZW50U3R5bGUgPyBlLmN1cnJlbnRTdHlsZS5maWx0ZXIgOiBlLnN0eWxlLmZpbHRlcikgfHwgIiIpID8gLjAxICogcGFyc2VGbG9hdChSZWdFeHAuJDEpICsgIiIgOiB0ID8gIjEiIDogIiI7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiBzZXQoZSwgdCkgewogICAgICB2YXIgbiA9IGUuc3R5bGUsCiAgICAgICAgICByID0gZS5jdXJyZW50U3R5bGUsCiAgICAgICAgICBpID0gcGUuaXNOdW1lcmljKHQpID8gImFscGhhKG9wYWNpdHk9IiArIDEwMCAqIHQgKyAiKSIgOiAiIiwKICAgICAgICAgIG8gPSByICYmIHIuZmlsdGVyIHx8IG4uZmlsdGVyIHx8ICIiOwogICAgICBuLnpvb20gPSAxLCAodCA+PSAxIHx8ICIiID09PSB0KSAmJiAiIiA9PT0gcGUudHJpbShvLnJlcGxhY2UoeXQsICIiKSkgJiYgbi5yZW1vdmVBdHRyaWJ1dGUgJiYgKG4ucmVtb3ZlQXR0cmlidXRlKCJmaWx0ZXIiKSwgIiIgPT09IHQgfHwgciAmJiAhci5maWx0ZXIpIHx8IChuLmZpbHRlciA9IHl0LnRlc3QobykgPyBvLnJlcGxhY2UoeXQsIGkpIDogbyArICIgIiArIGkpOwogICAgfQogIH0pLCBwZS5jc3NIb29rcy5tYXJnaW5SaWdodCA9IEwoZmUucmVsaWFibGVNYXJnaW5SaWdodCwgZnVuY3Rpb24gKGUsIHQpIHsKICAgIGlmICh0KSByZXR1cm4gZHQoZSwgewogICAgICBkaXNwbGF5OiAiaW5saW5lLWJsb2NrIgogICAgfSwgZ3QsIFtlLCAibWFyZ2luUmlnaHQiXSk7CiAgfSksIHBlLmNzc0hvb2tzLm1hcmdpbkxlZnQgPSBMKGZlLnJlbGlhYmxlTWFyZ2luTGVmdCwgZnVuY3Rpb24gKGUsIHQpIHsKICAgIGlmICh0KSByZXR1cm4gKHBhcnNlRmxvYXQoZ3QoZSwgIm1hcmdpbkxlZnQiKSkgfHwgKHBlLmNvbnRhaW5zKGUub3duZXJEb2N1bWVudCwgZSkgPyBlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQgLSBkdChlLCB7CiAgICAgIG1hcmdpbkxlZnQ6IDAKICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdDsKICAgIH0pIDogMCkpICsgInB4IjsKICB9KSwgcGUuZWFjaCh7CiAgICBtYXJnaW46ICIiLAogICAgcGFkZGluZzogIiIsCiAgICBib3JkZXI6ICJXaWR0aCIKICB9LCBmdW5jdGlvbiAoZSwgdCkgewogICAgcGUuY3NzSG9va3NbZSArIHRdID0gewogICAgICBleHBhbmQ6IGZ1bmN0aW9uIGV4cGFuZChuKSB7CiAgICAgICAgZm9yICh2YXIgciA9IDAsIGkgPSB7fSwgbyA9ICJzdHJpbmciID09IHR5cGVvZiBuID8gbi5zcGxpdCgiICIpIDogW25dOyByIDwgNDsgcisrKSB7CiAgICAgICAgICBpW2UgKyBPZVtyXSArIHRdID0gb1tyXSB8fCBvW3IgLSAyXSB8fCBvWzBdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgIH0sIGN0LnRlc3QoZSkgfHwgKHBlLmNzc0hvb2tzW2UgKyB0XS5zZXQgPSBfKTsKICB9KSwgcGUuZm4uZXh0ZW5kKHsKICAgIGNzczogZnVuY3Rpb24gY3NzKGUsIHQpIHsKICAgICAgcmV0dXJuIFBlKHRoaXMsIGZ1bmN0aW9uIChlLCB0LCBuKSB7CiAgICAgICAgdmFyIHIsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIG8gPSB7fSwKICAgICAgICAgICAgYSA9IDA7CgogICAgICAgIGlmIChwZS5pc0FycmF5KHQpKSB7CiAgICAgICAgICBmb3IgKHIgPSBodChlKSwgaSA9IHQubGVuZ3RoOyBhIDwgaTsgYSsrKSB7CiAgICAgICAgICAgIG9bdFthXV0gPSBwZS5jc3MoZSwgdFthXSwgITEsIHIpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBvOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZvaWQgMCAhPT0gbiA/IHBlLnN0eWxlKGUsIHQsIG4pIDogcGUuY3NzKGUsIHQpOwogICAgICB9LCBlLCB0LCBhcmd1bWVudHMubGVuZ3RoID4gMSk7CiAgICB9LAogICAgc2hvdzogZnVuY3Rpb24gc2hvdygpIHsKICAgICAgcmV0dXJuIHEodGhpcywgITApOwogICAgfSwKICAgIGhpZGU6IGZ1bmN0aW9uIGhpZGUoKSB7CiAgICAgIHJldHVybiBxKHRoaXMpOwogICAgfSwKICAgIHRvZ2dsZTogZnVuY3Rpb24gdG9nZ2xlKGUpIHsKICAgICAgcmV0dXJuICJib29sZWFuIiA9PSB0eXBlb2YgZSA/IGUgPyB0aGlzLnNob3coKSA6IHRoaXMuaGlkZSgpIDogdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBSZSh0aGlzKSA/IHBlKHRoaXMpLnNob3coKSA6IHBlKHRoaXMpLmhpZGUoKTsKICAgICAgfSk7CiAgICB9CiAgfSksIHBlLlR3ZWVuID0gTywgTy5wcm90b3R5cGUgPSB7CiAgICBjb25zdHJ1Y3RvcjogTywKICAgIGluaXQ6IGZ1bmN0aW9uIGluaXQoZSwgdCwgbiwgciwgaSwgbykgewogICAgICB0aGlzLmVsZW0gPSBlLCB0aGlzLnByb3AgPSBuLCB0aGlzLmVhc2luZyA9IGkgfHwgcGUuZWFzaW5nLl9kZWZhdWx0LCB0aGlzLm9wdGlvbnMgPSB0LCB0aGlzLnN0YXJ0ID0gdGhpcy5ub3cgPSB0aGlzLmN1cigpLCB0aGlzLmVuZCA9IHIsIHRoaXMudW5pdCA9IG8gfHwgKHBlLmNzc051bWJlcltuXSA/ICIiIDogInB4Iik7CiAgICB9LAogICAgY3VyOiBmdW5jdGlvbiBjdXIoKSB7CiAgICAgIHZhciBlID0gTy5wcm9wSG9va3NbdGhpcy5wcm9wXTsKICAgICAgcmV0dXJuIGUgJiYgZS5nZXQgPyBlLmdldCh0aGlzKSA6IE8ucHJvcEhvb2tzLl9kZWZhdWx0LmdldCh0aGlzKTsKICAgIH0sCiAgICBydW46IGZ1bmN0aW9uIHJ1bihlKSB7CiAgICAgIHZhciB0LAogICAgICAgICAgbiA9IE8ucHJvcEhvb2tzW3RoaXMucHJvcF07CiAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuZHVyYXRpb24gPyB0aGlzLnBvcyA9IHQgPSBwZS5lYXNpbmdbdGhpcy5lYXNpbmddKGUsIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIGUsIDAsIDEsIHRoaXMub3B0aW9ucy5kdXJhdGlvbikgOiB0aGlzLnBvcyA9IHQgPSBlLCB0aGlzLm5vdyA9ICh0aGlzLmVuZCAtIHRoaXMuc3RhcnQpICogdCArIHRoaXMuc3RhcnQsIHRoaXMub3B0aW9ucy5zdGVwICYmIHRoaXMub3B0aW9ucy5zdGVwLmNhbGwodGhpcy5lbGVtLCB0aGlzLm5vdywgdGhpcyksIG4gJiYgbi5zZXQgPyBuLnNldCh0aGlzKSA6IE8ucHJvcEhvb2tzLl9kZWZhdWx0LnNldCh0aGlzKSwgdGhpczsKICAgIH0KICB9LCBPLnByb3RvdHlwZS5pbml0LnByb3RvdHlwZSA9IE8ucHJvdG90eXBlLCBPLnByb3BIb29rcyA9IHsKICAgIF9kZWZhdWx0OiB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KGUpIHsKICAgICAgICB2YXIgdDsKICAgICAgICByZXR1cm4gMSAhPT0gZS5lbGVtLm5vZGVUeXBlIHx8IG51bGwgIT0gZS5lbGVtW2UucHJvcF0gJiYgbnVsbCA9PSBlLmVsZW0uc3R5bGVbZS5wcm9wXSA/IGUuZWxlbVtlLnByb3BdIDogKHQgPSBwZS5jc3MoZS5lbGVtLCBlLnByb3AsICIiKSwgdCAmJiAiYXV0byIgIT09IHQgPyB0IDogMCk7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgICBwZS5meC5zdGVwW2UucHJvcF0gPyBwZS5meC5zdGVwW2UucHJvcF0oZSkgOiAxICE9PSBlLmVsZW0ubm9kZVR5cGUgfHwgbnVsbCA9PSBlLmVsZW0uc3R5bGVbcGUuY3NzUHJvcHNbZS5wcm9wXV0gJiYgIXBlLmNzc0hvb2tzW2UucHJvcF0gPyBlLmVsZW1bZS5wcm9wXSA9IGUubm93IDogcGUuc3R5bGUoZS5lbGVtLCBlLnByb3AsIGUubm93ICsgZS51bml0KTsKICAgICAgfQogICAgfQogIH0sIE8ucHJvcEhvb2tzLnNjcm9sbFRvcCA9IE8ucHJvcEhvb2tzLnNjcm9sbExlZnQgPSB7CiAgICBzZXQ6IGZ1bmN0aW9uIHNldChlKSB7CiAgICAgIGUuZWxlbS5ub2RlVHlwZSAmJiBlLmVsZW0ucGFyZW50Tm9kZSAmJiAoZS5lbGVtW2UucHJvcF0gPSBlLm5vdyk7CiAgICB9CiAgfSwgcGUuZWFzaW5nID0gewogICAgbGluZWFyOiBmdW5jdGlvbiBsaW5lYXIoZSkgewogICAgICByZXR1cm4gZTsKICAgIH0sCiAgICBzd2luZzogZnVuY3Rpb24gc3dpbmcoZSkgewogICAgICByZXR1cm4gLjUgLSBNYXRoLmNvcyhlICogTWF0aC5QSSkgLyAyOwogICAgfSwKICAgIF9kZWZhdWx0OiAic3dpbmciCiAgfSwgcGUuZnggPSBPLnByb3RvdHlwZS5pbml0LCBwZS5meC5zdGVwID0ge307CiAgdmFyIE50LAogICAgICBrdCwKICAgICAgU3QgPSAvXig/OnRvZ2dsZXxzaG93fGhpZGUpJC8sCiAgICAgIEF0ID0gL3F1ZXVlSG9va3MkLzsKICBwZS5BbmltYXRpb24gPSBwZS5leHRlbmQoJCwgewogICAgdHdlZW5lcnM6IHsKICAgICAgIioiOiBbZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgICB2YXIgbiA9IHRoaXMuY3JlYXRlVHdlZW4oZSwgdCk7CiAgICAgICAgcmV0dXJuIGQobi5lbGVtLCBlLCBNZS5leGVjKHQpLCBuKSwgbjsKICAgICAgfV0KICAgIH0sCiAgICB0d2VlbmVyOiBmdW5jdGlvbiB0d2VlbmVyKGUsIHQpIHsKICAgICAgcGUuaXNGdW5jdGlvbihlKSA/ICh0ID0gZSwgZSA9IFsiKiJdKSA6IGUgPSBlLm1hdGNoKERlKTsKCiAgICAgIGZvciAodmFyIG4sIHIgPSAwLCBpID0gZS5sZW5ndGg7IHIgPCBpOyByKyspIHsKICAgICAgICBuID0gZVtyXSwgJC50d2VlbmVyc1tuXSA9ICQudHdlZW5lcnNbbl0gfHwgW10sICQudHdlZW5lcnNbbl0udW5zaGlmdCh0KTsKICAgICAgfQogICAgfSwKICAgIHByZWZpbHRlcnM6IFtXXSwKICAgIHByZWZpbHRlcjogZnVuY3Rpb24gcHJlZmlsdGVyKGUsIHQpIHsKICAgICAgdCA/ICQucHJlZmlsdGVycy51bnNoaWZ0KGUpIDogJC5wcmVmaWx0ZXJzLnB1c2goZSk7CiAgICB9CiAgfSksIHBlLnNwZWVkID0gZnVuY3Rpb24gKGUsIHQsIG4pIHsKICAgIHZhciByID0gZSAmJiAib2JqZWN0IiA9PSBfdHlwZW9mKGUpID8gcGUuZXh0ZW5kKHt9LCBlKSA6IHsKICAgICAgY29tcGxldGU6IG4gfHwgIW4gJiYgdCB8fCBwZS5pc0Z1bmN0aW9uKGUpICYmIGUsCiAgICAgIGR1cmF0aW9uOiBlLAogICAgICBlYXNpbmc6IG4gJiYgdCB8fCB0ICYmICFwZS5pc0Z1bmN0aW9uKHQpICYmIHQKICAgIH07CiAgICByZXR1cm4gci5kdXJhdGlvbiA9IHBlLmZ4Lm9mZiA/IDAgOiAibnVtYmVyIiA9PSB0eXBlb2Ygci5kdXJhdGlvbiA/IHIuZHVyYXRpb24gOiByLmR1cmF0aW9uIGluIHBlLmZ4LnNwZWVkcyA/IHBlLmZ4LnNwZWVkc1tyLmR1cmF0aW9uXSA6IHBlLmZ4LnNwZWVkcy5fZGVmYXVsdCwgbnVsbCAhPSByLnF1ZXVlICYmIHIucXVldWUgIT09ICEwIHx8IChyLnF1ZXVlID0gImZ4IiksIHIub2xkID0gci5jb21wbGV0ZSwgci5jb21wbGV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcGUuaXNGdW5jdGlvbihyLm9sZCkgJiYgci5vbGQuY2FsbCh0aGlzKSwgci5xdWV1ZSAmJiBwZS5kZXF1ZXVlKHRoaXMsIHIucXVldWUpOwogICAgfSwgcjsKICB9LCBwZS5mbi5leHRlbmQoewogICAgZmFkZVRvOiBmdW5jdGlvbiBmYWRlVG8oZSwgdCwgbiwgcikgewogICAgICByZXR1cm4gdGhpcy5maWx0ZXIoUmUpLmNzcygib3BhY2l0eSIsIDApLnNob3coKS5lbmQoKS5hbmltYXRlKHsKICAgICAgICBvcGFjaXR5OiB0CiAgICAgIH0sIGUsIG4sIHIpOwogICAgfSwKICAgIGFuaW1hdGU6IGZ1bmN0aW9uIGFuaW1hdGUoZSwgdCwgbiwgcikgewogICAgICB2YXIgaSA9IHBlLmlzRW1wdHlPYmplY3QoZSksCiAgICAgICAgICBvID0gcGUuc3BlZWQodCwgbiwgciksCiAgICAgICAgICBhID0gZnVuY3Rpb24gYSgpIHsKICAgICAgICB2YXIgdCA9ICQodGhpcywgcGUuZXh0ZW5kKHt9LCBlKSwgbyk7CiAgICAgICAgKGkgfHwgcGUuX2RhdGEodGhpcywgImZpbmlzaCIpKSAmJiB0LnN0b3AoITApOwogICAgICB9OwoKICAgICAgcmV0dXJuIGEuZmluaXNoID0gYSwgaSB8fCBvLnF1ZXVlID09PSAhMSA/IHRoaXMuZWFjaChhKSA6IHRoaXMucXVldWUoby5xdWV1ZSwgYSk7CiAgICB9LAogICAgc3RvcDogZnVuY3Rpb24gc3RvcChlLCB0LCBuKSB7CiAgICAgIHZhciByID0gZnVuY3Rpb24gcihlKSB7CiAgICAgICAgdmFyIHQgPSBlLnN0b3A7CiAgICAgICAgZGVsZXRlIGUuc3RvcCwgdChuKTsKICAgICAgfTsKCiAgICAgIHJldHVybiAic3RyaW5nIiAhPSB0eXBlb2YgZSAmJiAobiA9IHQsIHQgPSBlLCBlID0gdm9pZCAwKSwgdCAmJiBlICE9PSAhMSAmJiB0aGlzLnF1ZXVlKGUgfHwgImZ4IiwgW10pLCB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0ID0gITAsCiAgICAgICAgICAgIGkgPSBudWxsICE9IGUgJiYgZSArICJxdWV1ZUhvb2tzIiwKICAgICAgICAgICAgbyA9IHBlLnRpbWVycywKICAgICAgICAgICAgYSA9IHBlLl9kYXRhKHRoaXMpOwoKICAgICAgICBpZiAoaSkgYVtpXSAmJiBhW2ldLnN0b3AgJiYgcihhW2ldKTtlbHNlIGZvciAoaSBpbiBhKSB7CiAgICAgICAgICBhW2ldICYmIGFbaV0uc3RvcCAmJiBBdC50ZXN0KGkpICYmIHIoYVtpXSk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKGkgPSBvLmxlbmd0aDsgaS0tOykgewogICAgICAgICAgb1tpXS5lbGVtICE9PSB0aGlzIHx8IG51bGwgIT0gZSAmJiBvW2ldLnF1ZXVlICE9PSBlIHx8IChvW2ldLmFuaW0uc3RvcChuKSwgdCA9ICExLCBvLnNwbGljZShpLCAxKSk7CiAgICAgICAgfQoKICAgICAgICAhdCAmJiBuIHx8IHBlLmRlcXVldWUodGhpcywgZSk7CiAgICAgIH0pOwogICAgfSwKICAgIGZpbmlzaDogZnVuY3Rpb24gZmluaXNoKGUpIHsKICAgICAgcmV0dXJuIGUgIT09ICExICYmIChlID0gZSB8fCAiZngiKSwgdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdCwKICAgICAgICAgICAgbiA9IHBlLl9kYXRhKHRoaXMpLAogICAgICAgICAgICByID0gbltlICsgInF1ZXVlIl0sCiAgICAgICAgICAgIGkgPSBuW2UgKyAicXVldWVIb29rcyJdLAogICAgICAgICAgICBvID0gcGUudGltZXJzLAogICAgICAgICAgICBhID0gciA/IHIubGVuZ3RoIDogMDsKCiAgICAgICAgZm9yIChuLmZpbmlzaCA9ICEwLCBwZS5xdWV1ZSh0aGlzLCBlLCBbXSksIGkgJiYgaS5zdG9wICYmIGkuc3RvcC5jYWxsKHRoaXMsICEwKSwgdCA9IG8ubGVuZ3RoOyB0LS07KSB7CiAgICAgICAgICBvW3RdLmVsZW0gPT09IHRoaXMgJiYgb1t0XS5xdWV1ZSA9PT0gZSAmJiAob1t0XS5hbmltLnN0b3AoITApLCBvLnNwbGljZSh0LCAxKSk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHQgPSAwOyB0IDwgYTsgdCsrKSB7CiAgICAgICAgICByW3RdICYmIHJbdF0uZmluaXNoICYmIHJbdF0uZmluaXNoLmNhbGwodGhpcyk7CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgbi5maW5pc2g7CiAgICAgIH0pOwogICAgfQogIH0pLCBwZS5lYWNoKFsidG9nZ2xlIiwgInNob3ciLCAiaGlkZSJdLCBmdW5jdGlvbiAoZSwgdCkgewogICAgdmFyIG4gPSBwZS5mblt0XTsKCiAgICBwZS5mblt0XSA9IGZ1bmN0aW9uIChlLCByLCBpKSB7CiAgICAgIHJldHVybiBudWxsID09IGUgfHwgImJvb2xlYW4iID09IHR5cGVvZiBlID8gbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogdGhpcy5hbmltYXRlKFAodCwgITApLCBlLCByLCBpKTsKICAgIH07CiAgfSksIHBlLmVhY2goewogICAgc2xpZGVEb3duOiBQKCJzaG93IiksCiAgICBzbGlkZVVwOiBQKCJoaWRlIiksCiAgICBzbGlkZVRvZ2dsZTogUCgidG9nZ2xlIiksCiAgICBmYWRlSW46IHsKICAgICAgb3BhY2l0eTogInNob3ciCiAgICB9LAogICAgZmFkZU91dDogewogICAgICBvcGFjaXR5OiAiaGlkZSIKICAgIH0sCiAgICBmYWRlVG9nZ2xlOiB7CiAgICAgIG9wYWNpdHk6ICJ0b2dnbGUiCiAgICB9CiAgfSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgIHBlLmZuW2VdID0gZnVuY3Rpb24gKGUsIG4sIHIpIHsKICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0ZSh0LCBlLCBuLCByKTsKICAgIH07CiAgfSksIHBlLnRpbWVycyA9IFtdLCBwZS5meC50aWNrID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUsCiAgICAgICAgdCA9IHBlLnRpbWVycywKICAgICAgICBuID0gMDsKCiAgICBmb3IgKE50ID0gcGUubm93KCk7IG4gPCB0Lmxlbmd0aDsgbisrKSB7CiAgICAgIGUgPSB0W25dLCBlKCkgfHwgdFtuXSAhPT0gZSB8fCB0LnNwbGljZShuLS0sIDEpOwogICAgfQoKICAgIHQubGVuZ3RoIHx8IHBlLmZ4LnN0b3AoKSwgTnQgPSB2b2lkIDA7CiAgfSwgcGUuZngudGltZXIgPSBmdW5jdGlvbiAoZSkgewogICAgcGUudGltZXJzLnB1c2goZSksIGUoKSA/IHBlLmZ4LnN0YXJ0KCkgOiBwZS50aW1lcnMucG9wKCk7CiAgfSwgcGUuZnguaW50ZXJ2YWwgPSAxMywgcGUuZnguc3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICBrdCB8fCAoa3QgPSBlLnNldEludGVydmFsKHBlLmZ4LnRpY2ssIHBlLmZ4LmludGVydmFsKSk7CiAgfSwgcGUuZnguc3RvcCA9IGZ1bmN0aW9uICgpIHsKICAgIGUuY2xlYXJJbnRlcnZhbChrdCksIGt0ID0gbnVsbDsKICB9LCBwZS5meC5zcGVlZHMgPSB7CiAgICBzbG93OiA2MDAsCiAgICBmYXN0OiAyMDAsCiAgICBfZGVmYXVsdDogNDAwCiAgfSwgcGUuZm4uZGVsYXkgPSBmdW5jdGlvbiAodCwgbikgewogICAgcmV0dXJuIHQgPSBwZS5meCA/IHBlLmZ4LnNwZWVkc1t0XSB8fCB0IDogdCwgbiA9IG4gfHwgImZ4IiwgdGhpcy5xdWV1ZShuLCBmdW5jdGlvbiAobiwgcikgewogICAgICB2YXIgaSA9IGUuc2V0VGltZW91dChuLCB0KTsKCiAgICAgIHIuc3RvcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBlLmNsZWFyVGltZW91dChpKTsKICAgICAgfTsKICAgIH0pOwogIH0sIGZ1bmN0aW9uICgpIHsKICAgIHZhciBlLAogICAgICAgIHQgPSByZS5jcmVhdGVFbGVtZW50KCJpbnB1dCIpLAogICAgICAgIG4gPSByZS5jcmVhdGVFbGVtZW50KCJkaXYiKSwKICAgICAgICByID0gcmUuY3JlYXRlRWxlbWVudCgic2VsZWN0IiksCiAgICAgICAgaSA9IHIuYXBwZW5kQ2hpbGQocmUuY3JlYXRlRWxlbWVudCgib3B0aW9uIikpOwogICAgbiA9IHJlLmNyZWF0ZUVsZW1lbnQoImRpdiIpLCBuLnNldEF0dHJpYnV0ZSgiY2xhc3NOYW1lIiwgInQiKSwgbi5pbm5lckhUTUwgPSAiICA8bGluay8+PHRhYmxlPjwvdGFibGU+PGEgaHJlZj0nL2EnPmE8L2E+PGlucHV0IHR5cGU9J2NoZWNrYm94Jy8+IiwgZSA9IG4uZ2V0RWxlbWVudHNCeVRhZ05hbWUoImEiKVswXSwgdC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAiY2hlY2tib3giKSwgbi5hcHBlbmRDaGlsZCh0KSwgZSA9IG4uZ2V0RWxlbWVudHNCeVRhZ05hbWUoImEiKVswXSwgZS5zdHlsZS5jc3NUZXh0ID0gInRvcDoxcHgiLCBmZS5nZXRTZXRBdHRyaWJ1dGUgPSAidCIgIT09IG4uY2xhc3NOYW1lLCBmZS5zdHlsZSA9IC90b3AvLnRlc3QoZS5nZXRBdHRyaWJ1dGUoInN0eWxlIikpLCBmZS5ocmVmTm9ybWFsaXplZCA9ICIvYSIgPT09IGUuZ2V0QXR0cmlidXRlKCJocmVmIiksIGZlLmNoZWNrT24gPSAhIXQudmFsdWUsIGZlLm9wdFNlbGVjdGVkID0gaS5zZWxlY3RlZCwgZmUuZW5jdHlwZSA9ICEhcmUuY3JlYXRlRWxlbWVudCgiZm9ybSIpLmVuY3R5cGUsIHIuZGlzYWJsZWQgPSAhMCwgZmUub3B0RGlzYWJsZWQgPSAhaS5kaXNhYmxlZCwgdCA9IHJlLmNyZWF0ZUVsZW1lbnQoImlucHV0IiksIHQuc2V0QXR0cmlidXRlKCJ2YWx1ZSIsICIiKSwgZmUuaW5wdXQgPSAiIiA9PT0gdC5nZXRBdHRyaWJ1dGUoInZhbHVlIiksIHQudmFsdWUgPSAidCIsIHQuc2V0QXR0cmlidXRlKCJ0eXBlIiwgInJhZGlvIiksIGZlLnJhZGlvVmFsdWUgPSAidCIgPT09IHQudmFsdWU7CiAgfSgpOwogIHZhciBEdCA9IC9cci9nLAogICAgICBqdCA9IC9bXHgyMFx0XHJcblxmXSsvZzsKICBwZS5mbi5leHRlbmQoewogICAgdmFsOiBmdW5jdGlvbiB2YWwoZSkgewogICAgICB2YXIgdCwKICAgICAgICAgIG4sCiAgICAgICAgICByLAogICAgICAgICAgaSA9IHRoaXNbMF07CiAgICAgIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIHIgPSBwZS5pc0Z1bmN0aW9uKGUpLCB0aGlzLmVhY2goZnVuY3Rpb24gKG4pIHsKICAgICAgICAgIHZhciBpOwogICAgICAgICAgMSA9PT0gdGhpcy5ub2RlVHlwZSAmJiAoaSA9IHIgPyBlLmNhbGwodGhpcywgbiwgcGUodGhpcykudmFsKCkpIDogZSwgbnVsbCA9PSBpID8gaSA9ICIiIDogIm51bWJlciIgPT0gdHlwZW9mIGkgPyBpICs9ICIiIDogcGUuaXNBcnJheShpKSAmJiAoaSA9IHBlLm1hcChpLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICByZXR1cm4gbnVsbCA9PSBlID8gIiIgOiBlICsgIiI7CiAgICAgICAgICB9KSksIHQgPSBwZS52YWxIb29rc1t0aGlzLnR5cGVdIHx8IHBlLnZhbEhvb2tzW3RoaXMubm9kZU5hbWUudG9Mb3dlckNhc2UoKV0sIHQgJiYgInNldCIgaW4gdCAmJiB2b2lkIDAgIT09IHQuc2V0KHRoaXMsIGksICJ2YWx1ZSIpIHx8ICh0aGlzLnZhbHVlID0gaSkpOwogICAgICAgIH0pOwogICAgICAgIGlmIChpKSByZXR1cm4gdCA9IHBlLnZhbEhvb2tzW2kudHlwZV0gfHwgcGUudmFsSG9va3NbaS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpXSwgdCAmJiAiZ2V0IiBpbiB0ICYmIHZvaWQgMCAhPT0gKG4gPSB0LmdldChpLCAidmFsdWUiKSkgPyBuIDogKG4gPSBpLnZhbHVlLCAic3RyaW5nIiA9PSB0eXBlb2YgbiA/IG4ucmVwbGFjZShEdCwgIiIpIDogbnVsbCA9PSBuID8gIiIgOiBuKTsKICAgICAgfQogICAgfQogIH0pLCBwZS5leHRlbmQoewogICAgdmFsSG9va3M6IHsKICAgICAgb3B0aW9uOiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoZSkgewogICAgICAgICAgdmFyIHQgPSBwZS5maW5kLmF0dHIoZSwgInZhbHVlIik7CiAgICAgICAgICByZXR1cm4gbnVsbCAhPSB0ID8gdCA6IHBlLnRyaW0ocGUudGV4dChlKSkucmVwbGFjZShqdCwgIiAiKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNlbGVjdDogewogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KGUpIHsKICAgICAgICAgIGZvciAodmFyIHQsIG4sIHIgPSBlLm9wdGlvbnMsIGkgPSBlLnNlbGVjdGVkSW5kZXgsIG8gPSAic2VsZWN0LW9uZSIgPT09IGUudHlwZSB8fCBpIDwgMCwgYSA9IG8gPyBudWxsIDogW10sIHMgPSBvID8gaSArIDEgOiByLmxlbmd0aCwgdSA9IGkgPCAwID8gcyA6IG8gPyBpIDogMDsgdSA8IHM7IHUrKykgewogICAgICAgICAgICBpZiAobiA9IHJbdV0sIChuLnNlbGVjdGVkIHx8IHUgPT09IGkpICYmIChmZS5vcHREaXNhYmxlZCA/ICFuLmRpc2FibGVkIDogbnVsbCA9PT0gbi5nZXRBdHRyaWJ1dGUoImRpc2FibGVkIikpICYmICghbi5wYXJlbnROb2RlLmRpc2FibGVkIHx8ICFwZS5ub2RlTmFtZShuLnBhcmVudE5vZGUsICJvcHRncm91cCIpKSkgewogICAgICAgICAgICAgIGlmICh0ID0gcGUobikudmFsKCksIG8pIHJldHVybiB0OwogICAgICAgICAgICAgIGEucHVzaCh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBhOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoZSwgdCkgewogICAgICAgICAgZm9yICh2YXIgbiwgciwgaSA9IGUub3B0aW9ucywgbyA9IHBlLm1ha2VBcnJheSh0KSwgYSA9IGkubGVuZ3RoOyBhLS07KSB7CiAgICAgICAgICAgIGlmIChyID0gaVthXSwgcGUuaW5BcnJheShwZS52YWxIb29rcy5vcHRpb24uZ2V0KHIpLCBvKSA+IC0xKSB0cnkgewogICAgICAgICAgICAgIHIuc2VsZWN0ZWQgPSBuID0gITA7CiAgICAgICAgICAgIH0gY2F0Y2ggKHMpIHsKICAgICAgICAgICAgICByLnNjcm9sbEhlaWdodDsKICAgICAgICAgICAgfSBlbHNlIHIuc2VsZWN0ZWQgPSAhMTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gbiB8fCAoZS5zZWxlY3RlZEluZGV4ID0gLTEpLCBpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pLCBwZS5lYWNoKFsicmFkaW8iLCAiY2hlY2tib3giXSwgZnVuY3Rpb24gKCkgewogICAgcGUudmFsSG9va3NbdGhpc10gPSB7CiAgICAgIHNldDogZnVuY3Rpb24gc2V0KGUsIHQpIHsKICAgICAgICBpZiAocGUuaXNBcnJheSh0KSkgcmV0dXJuIGUuY2hlY2tlZCA9IHBlLmluQXJyYXkocGUoZSkudmFsKCksIHQpID4gLTE7CiAgICAgIH0KICAgIH0sIGZlLmNoZWNrT24gfHwgKHBlLnZhbEhvb2tzW3RoaXNdLmdldCA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIHJldHVybiBudWxsID09PSBlLmdldEF0dHJpYnV0ZSgidmFsdWUiKSA/ICJvbiIgOiBlLnZhbHVlOwogICAgfSk7CiAgfSk7CiAgdmFyIEx0LAogICAgICBIdCwKICAgICAgcXQgPSBwZS5leHByLmF0dHJIYW5kbGUsCiAgICAgIF90ID0gL14oPzpjaGVja2VkfHNlbGVjdGVkKSQvaSwKICAgICAgRnQgPSBmZS5nZXRTZXRBdHRyaWJ1dGUsCiAgICAgIE10ID0gZmUuaW5wdXQ7CiAgcGUuZm4uZXh0ZW5kKHsKICAgIGF0dHI6IGZ1bmN0aW9uIGF0dHIoZSwgdCkgewogICAgICByZXR1cm4gUGUodGhpcywgcGUuYXR0ciwgZSwgdCwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgfSwKICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uIHJlbW92ZUF0dHIoZSkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBwZS5yZW1vdmVBdHRyKHRoaXMsIGUpOwogICAgICB9KTsKICAgIH0KICB9KSwgcGUuZXh0ZW5kKHsKICAgIGF0dHI6IGZ1bmN0aW9uIGF0dHIoZSwgdCwgbikgewogICAgICB2YXIgciwKICAgICAgICAgIGksCiAgICAgICAgICBvID0gZS5ub2RlVHlwZTsKICAgICAgaWYgKDMgIT09IG8gJiYgOCAhPT0gbyAmJiAyICE9PSBvKSByZXR1cm4gInVuZGVmaW5lZCIgPT0gdHlwZW9mIGUuZ2V0QXR0cmlidXRlID8gcGUucHJvcChlLCB0LCBuKSA6ICgxID09PSBvICYmIHBlLmlzWE1MRG9jKGUpIHx8ICh0ID0gdC50b0xvd2VyQ2FzZSgpLCBpID0gcGUuYXR0ckhvb2tzW3RdIHx8IChwZS5leHByLm1hdGNoLmJvb2wudGVzdCh0KSA/IEh0IDogTHQpKSwgdm9pZCAwICE9PSBuID8gbnVsbCA9PT0gbiA/IHZvaWQgcGUucmVtb3ZlQXR0cihlLCB0KSA6IGkgJiYgInNldCIgaW4gaSAmJiB2b2lkIDAgIT09IChyID0gaS5zZXQoZSwgbiwgdCkpID8gciA6IChlLnNldEF0dHJpYnV0ZSh0LCBuICsgIiIpLCBuKSA6IGkgJiYgImdldCIgaW4gaSAmJiBudWxsICE9PSAociA9IGkuZ2V0KGUsIHQpKSA/IHIgOiAociA9IHBlLmZpbmQuYXR0cihlLCB0KSwgbnVsbCA9PSByID8gdm9pZCAwIDogcikpOwogICAgfSwKICAgIGF0dHJIb29rczogewogICAgICB0eXBlOiB7CiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoZSwgdCkgewogICAgICAgICAgaWYgKCFmZS5yYWRpb1ZhbHVlICYmICJyYWRpbyIgPT09IHQgJiYgcGUubm9kZU5hbWUoZSwgImlucHV0IikpIHsKICAgICAgICAgICAgdmFyIG4gPSBlLnZhbHVlOwogICAgICAgICAgICByZXR1cm4gZS5zZXRBdHRyaWJ1dGUoInR5cGUiLCB0KSwgbiAmJiAoZS52YWx1ZSA9IG4pLCB0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uIHJlbW92ZUF0dHIoZSwgdCkgewogICAgICB2YXIgbiwKICAgICAgICAgIHIsCiAgICAgICAgICBpID0gMCwKICAgICAgICAgIG8gPSB0ICYmIHQubWF0Y2goRGUpOwogICAgICBpZiAobyAmJiAxID09PSBlLm5vZGVUeXBlKSBmb3IgKDsgbiA9IG9baSsrXTspIHsKICAgICAgICByID0gcGUucHJvcEZpeFtuXSB8fCBuLCBwZS5leHByLm1hdGNoLmJvb2wudGVzdChuKSA/IE10ICYmIEZ0IHx8ICFfdC50ZXN0KG4pID8gZVtyXSA9ICExIDogZVtwZS5jYW1lbENhc2UoImRlZmF1bHQtIiArIG4pXSA9IGVbcl0gPSAhMSA6IHBlLmF0dHIoZSwgbiwgIiIpLCBlLnJlbW92ZUF0dHJpYnV0ZShGdCA/IG4gOiByKTsKICAgICAgfQogICAgfQogIH0pLCBIdCA9IHsKICAgIHNldDogZnVuY3Rpb24gc2V0KGUsIHQsIG4pIHsKICAgICAgcmV0dXJuIHQgPT09ICExID8gcGUucmVtb3ZlQXR0cihlLCBuKSA6IE10ICYmIEZ0IHx8ICFfdC50ZXN0KG4pID8gZS5zZXRBdHRyaWJ1dGUoIUZ0ICYmIHBlLnByb3BGaXhbbl0gfHwgbiwgbikgOiBlW3BlLmNhbWVsQ2FzZSgiZGVmYXVsdC0iICsgbildID0gZVtuXSA9ICEwLCBuOwogICAgfQogIH0sIHBlLmVhY2gocGUuZXhwci5tYXRjaC5ib29sLnNvdXJjZS5tYXRjaCgvXHcrL2cpLCBmdW5jdGlvbiAoZSwgdCkgewogICAgdmFyIG4gPSBxdFt0XSB8fCBwZS5maW5kLmF0dHI7CiAgICBNdCAmJiBGdCB8fCAhX3QudGVzdCh0KSA/IHF0W3RdID0gZnVuY3Rpb24gKGUsIHQsIHIpIHsKICAgICAgdmFyIGksIG87CiAgICAgIHJldHVybiByIHx8IChvID0gcXRbdF0sIHF0W3RdID0gaSwgaSA9IG51bGwgIT0gbihlLCB0LCByKSA/IHQudG9Mb3dlckNhc2UoKSA6IG51bGwsIHF0W3RdID0gbyksIGk7CiAgICB9IDogcXRbdF0gPSBmdW5jdGlvbiAoZSwgdCwgbikgewogICAgICBpZiAoIW4pIHJldHVybiBlW3BlLmNhbWVsQ2FzZSgiZGVmYXVsdC0iICsgdCldID8gdC50b0xvd2VyQ2FzZSgpIDogbnVsbDsKICAgIH07CiAgfSksIE10ICYmIEZ0IHx8IChwZS5hdHRySG9va3MudmFsdWUgPSB7CiAgICBzZXQ6IGZ1bmN0aW9uIHNldChlLCB0LCBuKSB7CiAgICAgIHJldHVybiBwZS5ub2RlTmFtZShlLCAiaW5wdXQiKSA/IHZvaWQgKGUuZGVmYXVsdFZhbHVlID0gdCkgOiBMdCAmJiBMdC5zZXQoZSwgdCwgbik7CiAgICB9CiAgfSksIEZ0IHx8IChMdCA9IHsKICAgIHNldDogZnVuY3Rpb24gc2V0KGUsIHQsIG4pIHsKICAgICAgdmFyIHIgPSBlLmdldEF0dHJpYnV0ZU5vZGUobik7CiAgICAgIGlmIChyIHx8IGUuc2V0QXR0cmlidXRlTm9kZShyID0gZS5vd25lckRvY3VtZW50LmNyZWF0ZUF0dHJpYnV0ZShuKSksIHIudmFsdWUgPSB0ICs9ICIiLCAidmFsdWUiID09PSBuIHx8IHQgPT09IGUuZ2V0QXR0cmlidXRlKG4pKSByZXR1cm4gdDsKICAgIH0KICB9LCBxdC5pZCA9IHF0Lm5hbWUgPSBxdC5jb29yZHMgPSBmdW5jdGlvbiAoZSwgdCwgbikgewogICAgdmFyIHI7CiAgICBpZiAoIW4pIHJldHVybiAociA9IGUuZ2V0QXR0cmlidXRlTm9kZSh0KSkgJiYgIiIgIT09IHIudmFsdWUgPyByLnZhbHVlIDogbnVsbDsKICB9LCBwZS52YWxIb29rcy5idXR0b24gPSB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldChlLCB0KSB7CiAgICAgIHZhciBuID0gZS5nZXRBdHRyaWJ1dGVOb2RlKHQpOwogICAgICBpZiAobiAmJiBuLnNwZWNpZmllZCkgcmV0dXJuIG4udmFsdWU7CiAgICB9LAogICAgc2V0OiBMdC5zZXQKICB9LCBwZS5hdHRySG9va3MuY29udGVudGVkaXRhYmxlID0gewogICAgc2V0OiBmdW5jdGlvbiBzZXQoZSwgdCwgbikgewogICAgICBMdC5zZXQoZSwgIiIgIT09IHQgJiYgdCwgbik7CiAgICB9CiAgfSwgcGUuZWFjaChbIndpZHRoIiwgImhlaWdodCJdLCBmdW5jdGlvbiAoZSwgdCkgewogICAgcGUuYXR0ckhvb2tzW3RdID0gewogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChlLCBuKSB7CiAgICAgICAgaWYgKCIiID09PSBuKSByZXR1cm4gZS5zZXRBdHRyaWJ1dGUodCwgImF1dG8iKSwgbjsKICAgICAgfQogICAgfTsKICB9KSksIGZlLnN0eWxlIHx8IChwZS5hdHRySG9va3Muc3R5bGUgPSB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldChlKSB7CiAgICAgIHJldHVybiBlLnN0eWxlLmNzc1RleHQgfHwgdm9pZCAwOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUsIHQpIHsKICAgICAgcmV0dXJuIGUuc3R5bGUuY3NzVGV4dCA9IHQgKyAiIjsKICAgIH0KICB9KTsKICB2YXIgT3QgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b258b2JqZWN0KSQvaSwKICAgICAgUnQgPSAvXig/OmF8YXJlYSkkL2k7CiAgcGUuZm4uZXh0ZW5kKHsKICAgIHByb3A6IGZ1bmN0aW9uIHByb3AoZSwgdCkgewogICAgICByZXR1cm4gUGUodGhpcywgcGUucHJvcCwgZSwgdCwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgfSwKICAgIHJlbW92ZVByb3A6IGZ1bmN0aW9uIHJlbW92ZVByb3AoZSkgewogICAgICByZXR1cm4gZSA9IHBlLnByb3BGaXhbZV0gfHwgZSwgdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdGhpc1tlXSA9IHZvaWQgMCwgZGVsZXRlIHRoaXNbZV07CiAgICAgICAgfSBjYXRjaCAodCkge30KICAgICAgfSk7CiAgICB9CiAgfSksIHBlLmV4dGVuZCh7CiAgICBwcm9wOiBmdW5jdGlvbiBwcm9wKGUsIHQsIG4pIHsKICAgICAgdmFyIHIsCiAgICAgICAgICBpLAogICAgICAgICAgbyA9IGUubm9kZVR5cGU7CiAgICAgIGlmICgzICE9PSBvICYmIDggIT09IG8gJiYgMiAhPT0gbykgcmV0dXJuIDEgPT09IG8gJiYgcGUuaXNYTUxEb2MoZSkgfHwgKHQgPSBwZS5wcm9wRml4W3RdIHx8IHQsIGkgPSBwZS5wcm9wSG9va3NbdF0pLCB2b2lkIDAgIT09IG4gPyBpICYmICJzZXQiIGluIGkgJiYgdm9pZCAwICE9PSAociA9IGkuc2V0KGUsIG4sIHQpKSA/IHIgOiBlW3RdID0gbiA6IGkgJiYgImdldCIgaW4gaSAmJiBudWxsICE9PSAociA9IGkuZ2V0KGUsIHQpKSA/IHIgOiBlW3RdOwogICAgfSwKICAgIHByb3BIb29rczogewogICAgICB0YWJJbmRleDogewogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KGUpIHsKICAgICAgICAgIHZhciB0ID0gcGUuZmluZC5hdHRyKGUsICJ0YWJpbmRleCIpOwogICAgICAgICAgcmV0dXJuIHQgPyBwYXJzZUludCh0LCAxMCkgOiBPdC50ZXN0KGUubm9kZU5hbWUpIHx8IFJ0LnRlc3QoZS5ub2RlTmFtZSkgJiYgZS5ocmVmID8gMCA6IC0xOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHByb3BGaXg6IHsKICAgICAgImZvciI6ICJodG1sRm9yIiwKICAgICAgImNsYXNzIjogImNsYXNzTmFtZSIKICAgIH0KICB9KSwgZmUuaHJlZk5vcm1hbGl6ZWQgfHwgcGUuZWFjaChbImhyZWYiLCAic3JjIl0sIGZ1bmN0aW9uIChlLCB0KSB7CiAgICBwZS5wcm9wSG9va3NbdF0gPSB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KGUpIHsKICAgICAgICByZXR1cm4gZS5nZXRBdHRyaWJ1dGUodCwgNCk7CiAgICAgIH0KICAgIH07CiAgfSksIGZlLm9wdFNlbGVjdGVkIHx8IChwZS5wcm9wSG9va3Muc2VsZWN0ZWQgPSB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldChlKSB7CiAgICAgIHZhciB0ID0gZS5wYXJlbnROb2RlOwogICAgICByZXR1cm4gdCAmJiAodC5zZWxlY3RlZEluZGV4LCB0LnBhcmVudE5vZGUgJiYgdC5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXgpLCBudWxsOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgdmFyIHQgPSBlLnBhcmVudE5vZGU7CiAgICAgIHQgJiYgKHQuc2VsZWN0ZWRJbmRleCwgdC5wYXJlbnROb2RlICYmIHQucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4KTsKICAgIH0KICB9KSwgcGUuZWFjaChbInRhYkluZGV4IiwgInJlYWRPbmx5IiwgIm1heExlbmd0aCIsICJjZWxsU3BhY2luZyIsICJjZWxsUGFkZGluZyIsICJyb3dTcGFuIiwgImNvbFNwYW4iLCAidXNlTWFwIiwgImZyYW1lQm9yZGVyIiwgImNvbnRlbnRFZGl0YWJsZSJdLCBmdW5jdGlvbiAoKSB7CiAgICBwZS5wcm9wRml4W3RoaXMudG9Mb3dlckNhc2UoKV0gPSB0aGlzOwogIH0pLCBmZS5lbmN0eXBlIHx8IChwZS5wcm9wRml4LmVuY3R5cGUgPSAiZW5jb2RpbmciKTsKICB2YXIgUHQgPSAvW1x0XHJcblxmXS9nOwogIHBlLmZuLmV4dGVuZCh7CiAgICBhZGRDbGFzczogZnVuY3Rpb24gYWRkQ2xhc3MoZSkgewogICAgICB2YXIgdCwKICAgICAgICAgIG4sCiAgICAgICAgICByLAogICAgICAgICAgaSwKICAgICAgICAgIG8sCiAgICAgICAgICBhLAogICAgICAgICAgcywKICAgICAgICAgIHUgPSAwOwogICAgICBpZiAocGUuaXNGdW5jdGlvbihlKSkgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAodCkgewogICAgICAgIHBlKHRoaXMpLmFkZENsYXNzKGUuY2FsbCh0aGlzLCB0LCB6KHRoaXMpKSk7CiAgICAgIH0pOwogICAgICBpZiAoInN0cmluZyIgPT0gdHlwZW9mIGUgJiYgZSkgZm9yICh0ID0gZS5tYXRjaChEZSkgfHwgW107IG4gPSB0aGlzW3UrK107KSB7CiAgICAgICAgaWYgKGkgPSB6KG4pLCByID0gMSA9PT0gbi5ub2RlVHlwZSAmJiAoIiAiICsgaSArICIgIikucmVwbGFjZShQdCwgIiAiKSkgewogICAgICAgICAgZm9yIChhID0gMDsgbyA9IHRbYSsrXTspIHsKICAgICAgICAgICAgci5pbmRleE9mKCIgIiArIG8gKyAiICIpIDwgMCAmJiAociArPSBvICsgIiAiKTsKICAgICAgICAgIH0KCiAgICAgICAgICBzID0gcGUudHJpbShyKSwgaSAhPT0gcyAmJiBwZS5hdHRyKG4sICJjbGFzcyIsIHMpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICByZW1vdmVDbGFzczogZnVuY3Rpb24gcmVtb3ZlQ2xhc3MoZSkgewogICAgICB2YXIgdCwKICAgICAgICAgIG4sCiAgICAgICAgICByLAogICAgICAgICAgaSwKICAgICAgICAgIG8sCiAgICAgICAgICBhLAogICAgICAgICAgcywKICAgICAgICAgIHUgPSAwOwogICAgICBpZiAocGUuaXNGdW5jdGlvbihlKSkgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAodCkgewogICAgICAgIHBlKHRoaXMpLnJlbW92ZUNsYXNzKGUuY2FsbCh0aGlzLCB0LCB6KHRoaXMpKSk7CiAgICAgIH0pOwogICAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiB0aGlzLmF0dHIoImNsYXNzIiwgIiIpOwogICAgICBpZiAoInN0cmluZyIgPT0gdHlwZW9mIGUgJiYgZSkgZm9yICh0ID0gZS5tYXRjaChEZSkgfHwgW107IG4gPSB0aGlzW3UrK107KSB7CiAgICAgICAgaWYgKGkgPSB6KG4pLCByID0gMSA9PT0gbi5ub2RlVHlwZSAmJiAoIiAiICsgaSArICIgIikucmVwbGFjZShQdCwgIiAiKSkgewogICAgICAgICAgZm9yIChhID0gMDsgbyA9IHRbYSsrXTspIHsKICAgICAgICAgICAgZm9yICg7IHIuaW5kZXhPZigiICIgKyBvICsgIiAiKSA+IC0xOykgewogICAgICAgICAgICAgIHIgPSByLnJlcGxhY2UoIiAiICsgbyArICIgIiwgIiAiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHMgPSBwZS50cmltKHIpLCBpICE9PSBzICYmIHBlLmF0dHIobiwgImNsYXNzIiwgcyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiB0b2dnbGVDbGFzcyhlLCB0KSB7CiAgICAgIHZhciBuID0gX3R5cGVvZihlKTsKCiAgICAgIHJldHVybiAiYm9vbGVhbiIgPT0gdHlwZW9mIHQgJiYgInN0cmluZyIgPT09IG4gPyB0ID8gdGhpcy5hZGRDbGFzcyhlKSA6IHRoaXMucmVtb3ZlQ2xhc3MoZSkgOiBwZS5pc0Z1bmN0aW9uKGUpID8gdGhpcy5lYWNoKGZ1bmN0aW9uIChuKSB7CiAgICAgICAgcGUodGhpcykudG9nZ2xlQ2xhc3MoZS5jYWxsKHRoaXMsIG4sIHoodGhpcyksIHQpLCB0KTsKICAgICAgfSkgOiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0LCByLCBpLCBvOwogICAgICAgIGlmICgic3RyaW5nIiA9PT0gbikgZm9yIChyID0gMCwgaSA9IHBlKHRoaXMpLCBvID0gZS5tYXRjaChEZSkgfHwgW107IHQgPSBvW3IrK107KSB7CiAgICAgICAgICBpLmhhc0NsYXNzKHQpID8gaS5yZW1vdmVDbGFzcyh0KSA6IGkuYWRkQ2xhc3ModCk7CiAgICAgICAgfSBlbHNlIHZvaWQgMCAhPT0gZSAmJiAiYm9vbGVhbiIgIT09IG4gfHwgKHQgPSB6KHRoaXMpLCB0ICYmIHBlLl9kYXRhKHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgdCksIHBlLmF0dHIodGhpcywgImNsYXNzIiwgdCB8fCBlID09PSAhMSA/ICIiIDogcGUuX2RhdGEodGhpcywgIl9fY2xhc3NOYW1lX18iKSB8fCAiIikpOwogICAgICB9KTsKICAgIH0sCiAgICBoYXNDbGFzczogZnVuY3Rpb24gaGFzQ2xhc3MoZSkgewogICAgICB2YXIgdCwKICAgICAgICAgIG4sCiAgICAgICAgICByID0gMDsKCiAgICAgIGZvciAodCA9ICIgIiArIGUgKyAiICI7IG4gPSB0aGlzW3IrK107KSB7CiAgICAgICAgaWYgKDEgPT09IG4ubm9kZVR5cGUgJiYgKCIgIiArIHoobikgKyAiICIpLnJlcGxhY2UoUHQsICIgIikuaW5kZXhPZih0KSA+IC0xKSByZXR1cm4gITA7CiAgICAgIH0KCiAgICAgIHJldHVybiAhMTsKICAgIH0KICB9KSwgcGUuZWFjaCgiYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgbW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCBtb3VzZWVudGVyIG1vdXNlbGVhdmUgY2hhbmdlIHNlbGVjdCBzdWJtaXQga2V5ZG93biBrZXlwcmVzcyBrZXl1cCBlcnJvciBjb250ZXh0bWVudSIuc3BsaXQoIiAiKSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgIHBlLmZuW3RdID0gZnVuY3Rpb24gKGUsIG4pIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAwID8gdGhpcy5vbih0LCBudWxsLCBlLCBuKSA6IHRoaXMudHJpZ2dlcih0KTsKICAgIH07CiAgfSksIHBlLmZuLmV4dGVuZCh7CiAgICBob3ZlcjogZnVuY3Rpb24gaG92ZXIoZSwgdCkgewogICAgICByZXR1cm4gdGhpcy5tb3VzZWVudGVyKGUpLm1vdXNlbGVhdmUodCB8fCBlKTsKICAgIH0KICB9KTsKICB2YXIgQnQgPSBlLmxvY2F0aW9uLAogICAgICBXdCA9IHBlLm5vdygpLAogICAgICBJdCA9IC9cPy8sCiAgICAgICR0ID0gLygsKXwoXFt8eyl8KH18XSl8Iig/OlteIlxcXHJcbl18XFxbIlxcXC9iZm5ydF18XFx1W1xkYS1mQS1GXXs0fSkqIlxzKjo/fHRydWV8ZmFsc2V8bnVsbHwtPyg/ITBcZClcZCsoPzpcLlxkK3wpKD86W2VFXVsrLV0/XGQrfCkvZzsKICBwZS5wYXJzZUpTT04gPSBmdW5jdGlvbiAodCkgewogICAgaWYgKGUuSlNPTiAmJiBlLkpTT04ucGFyc2UpIHJldHVybiBlLkpTT04ucGFyc2UodCArICIiKTsKICAgIHZhciBuLAogICAgICAgIHIgPSBudWxsLAogICAgICAgIGkgPSBwZS50cmltKHQgKyAiIik7CiAgICByZXR1cm4gaSAmJiAhcGUudHJpbShpLnJlcGxhY2UoJHQsIGZ1bmN0aW9uIChlLCB0LCBpLCBvKSB7CiAgICAgIHJldHVybiBuICYmIHQgJiYgKHIgPSAwKSwgMCA9PT0gciA/IGUgOiAobiA9IGkgfHwgdCwgciArPSAhbyAtICFpLCAiIik7CiAgICB9KSkgPyBGdW5jdGlvbigicmV0dXJuICIgKyBpKSgpIDogcGUuZXJyb3IoIkludmFsaWQgSlNPTjogIiArIHQpOwogIH0sIHBlLnBhcnNlWE1MID0gZnVuY3Rpb24gKHQpIHsKICAgIHZhciBuLCByOwogICAgaWYgKCF0IHx8ICJzdHJpbmciICE9IHR5cGVvZiB0KSByZXR1cm4gbnVsbDsKCiAgICB0cnkgewogICAgICBlLkRPTVBhcnNlciA/IChyID0gbmV3IGUuRE9NUGFyc2VyKCksIG4gPSByLnBhcnNlRnJvbVN0cmluZyh0LCAidGV4dC94bWwiKSkgOiAobiA9IG5ldyBlLkFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxET00iKSwgbi5hc3luYyA9ICJmYWxzZSIsIG4ubG9hZFhNTCh0KSk7CiAgICB9IGNhdGNoIChpKSB7CiAgICAgIG4gPSB2b2lkIDA7CiAgICB9CgogICAgcmV0dXJuIG4gJiYgbi5kb2N1bWVudEVsZW1lbnQgJiYgIW4uZ2V0RWxlbWVudHNCeVRhZ05hbWUoInBhcnNlcmVycm9yIikubGVuZ3RoIHx8IHBlLmVycm9yKCJJbnZhbGlkIFhNTDogIiArIHQpLCBuOwogIH07CiAgdmFyIHp0ID0gLyMuKiQvLAogICAgICBYdCA9IC8oWz8mXSlfPVteJl0qLywKICAgICAgVXQgPSAvXiguKj8pOlsgXHRdKihbXlxyXG5dKilccj8kL2dtLAogICAgICBWdCA9IC9eKD86YWJvdXR8YXBwfGFwcC1zdG9yYWdlfC4rLWV4dGVuc2lvbnxmaWxlfHJlc3x3aWRnZXQpOiQvLAogICAgICBZdCA9IC9eKD86R0VUfEhFQUQpJC8sCiAgICAgIEp0ID0gL15cL1wvLywKICAgICAgR3QgPSAvXihbXHcuKy1dKzopKD86XC9cLyg/OlteXC8/I10qQHwpKFteXC8/IzpdKikoPzo6KFxkKyl8KXwpLywKICAgICAgS3QgPSB7fSwKICAgICAgUXQgPSB7fSwKICAgICAgWnQgPSAiKi8iLmNvbmNhdCgiKiIpLAogICAgICBlbiA9IEJ0LmhyZWYsCiAgICAgIHRuID0gR3QuZXhlYyhlbi50b0xvd2VyQ2FzZSgpKSB8fCBbXTsKICBwZS5leHRlbmQoewogICAgYWN0aXZlOiAwLAogICAgbGFzdE1vZGlmaWVkOiB7fSwKICAgIGV0YWc6IHt9LAogICAgYWpheFNldHRpbmdzOiB7CiAgICAgIHVybDogZW4sCiAgICAgIHR5cGU6ICJHRVQiLAogICAgICBpc0xvY2FsOiBWdC50ZXN0KHRuWzFdKSwKICAgICAgZ2xvYmFsOiAhMCwKICAgICAgcHJvY2Vzc0RhdGE6ICEwLAogICAgICBhc3luYzogITAsCiAgICAgIGNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PVVURi04IiwKICAgICAgYWNjZXB0czogewogICAgICAgICIqIjogWnQsCiAgICAgICAgdGV4dDogInRleHQvcGxhaW4iLAogICAgICAgIGh0bWw6ICJ0ZXh0L2h0bWwiLAogICAgICAgIHhtbDogImFwcGxpY2F0aW9uL3htbCwgdGV4dC94bWwiLAogICAgICAgIGpzb246ICJhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L2phdmFzY3JpcHQiCiAgICAgIH0sCiAgICAgIGNvbnRlbnRzOiB7CiAgICAgICAgeG1sOiAvXGJ4bWxcYi8sCiAgICAgICAgaHRtbDogL1xiaHRtbC8sCiAgICAgICAganNvbjogL1xianNvblxiLwogICAgICB9LAogICAgICByZXNwb25zZUZpZWxkczogewogICAgICAgIHhtbDogInJlc3BvbnNlWE1MIiwKICAgICAgICB0ZXh0OiAicmVzcG9uc2VUZXh0IiwKICAgICAgICBqc29uOiAicmVzcG9uc2VKU09OIgogICAgICB9LAogICAgICBjb252ZXJ0ZXJzOiB7CiAgICAgICAgIiogdGV4dCI6IFN0cmluZywKICAgICAgICAidGV4dCBodG1sIjogITAsCiAgICAgICAgInRleHQganNvbiI6IHBlLnBhcnNlSlNPTiwKICAgICAgICAidGV4dCB4bWwiOiBwZS5wYXJzZVhNTAogICAgICB9LAogICAgICBmbGF0T3B0aW9uczogewogICAgICAgIHVybDogITAsCiAgICAgICAgY29udGV4dDogITAKICAgICAgfQogICAgfSwKICAgIGFqYXhTZXR1cDogZnVuY3Rpb24gYWpheFNldHVwKGUsIHQpIHsKICAgICAgcmV0dXJuIHQgPyBWKFYoZSwgcGUuYWpheFNldHRpbmdzKSwgdCkgOiBWKHBlLmFqYXhTZXR0aW5ncywgZSk7CiAgICB9LAogICAgYWpheFByZWZpbHRlcjogWChLdCksCiAgICBhamF4VHJhbnNwb3J0OiBYKFF0KSwKICAgIGFqYXg6IGZ1bmN0aW9uIGFqYXgodCwgbikgewogICAgICBmdW5jdGlvbiByKHQsIG4sIHIsIGkpIHsKICAgICAgICB2YXIgbywKICAgICAgICAgICAgZiwKICAgICAgICAgICAgdiwKICAgICAgICAgICAgeCwKICAgICAgICAgICAgdywKICAgICAgICAgICAgQyA9IG47CiAgICAgICAgMiAhPT0gYiAmJiAoYiA9IDIsIHUgJiYgZS5jbGVhclRpbWVvdXQodSksIGMgPSB2b2lkIDAsIHMgPSBpIHx8ICIiLCBULnJlYWR5U3RhdGUgPSB0ID4gMCA/IDQgOiAwLCBvID0gdCA+PSAyMDAgJiYgdCA8IDMwMCB8fCAzMDQgPT09IHQsIHIgJiYgKHggPSBZKGQsIFQsIHIpKSwgeCA9IEooZCwgeCwgVCwgbyksIG8gPyAoZC5pZk1vZGlmaWVkICYmICh3ID0gVC5nZXRSZXNwb25zZUhlYWRlcigiTGFzdC1Nb2RpZmllZCIpLCB3ICYmIChwZS5sYXN0TW9kaWZpZWRbYV0gPSB3KSwgdyA9IFQuZ2V0UmVzcG9uc2VIZWFkZXIoImV0YWciKSwgdyAmJiAocGUuZXRhZ1thXSA9IHcpKSwgMjA0ID09PSB0IHx8ICJIRUFEIiA9PT0gZC50eXBlID8gQyA9ICJub2NvbnRlbnQiIDogMzA0ID09PSB0ID8gQyA9ICJub3Rtb2RpZmllZCIgOiAoQyA9IHguc3RhdGUsIGYgPSB4LmRhdGEsIHYgPSB4LmVycm9yLCBvID0gIXYpKSA6ICh2ID0gQywgIXQgJiYgQyB8fCAoQyA9ICJlcnJvciIsIHQgPCAwICYmICh0ID0gMCkpKSwgVC5zdGF0dXMgPSB0LCBULnN0YXR1c1RleHQgPSAobiB8fCBDKSArICIiLCBvID8gZy5yZXNvbHZlV2l0aChwLCBbZiwgQywgVF0pIDogZy5yZWplY3RXaXRoKHAsIFtULCBDLCB2XSksIFQuc3RhdHVzQ29kZSh5KSwgeSA9IHZvaWQgMCwgbCAmJiBoLnRyaWdnZXIobyA/ICJhamF4U3VjY2VzcyIgOiAiYWpheEVycm9yIiwgW1QsIGQsIG8gPyBmIDogdl0pLCBtLmZpcmVXaXRoKHAsIFtULCBDXSksIGwgJiYgKGgudHJpZ2dlcigiYWpheENvbXBsZXRlIiwgW1QsIGRdKSwgLS1wZS5hY3RpdmUgfHwgcGUuZXZlbnQudHJpZ2dlcigiYWpheFN0b3AiKSkpOwogICAgICB9CgogICAgICAib2JqZWN0IiA9PSBfdHlwZW9mKHQpICYmIChuID0gdCwgdCA9IHZvaWQgMCksIG4gPSBuIHx8IHt9OwogICAgICB2YXIgaSwKICAgICAgICAgIG8sCiAgICAgICAgICBhLAogICAgICAgICAgcywKICAgICAgICAgIHUsCiAgICAgICAgICBsLAogICAgICAgICAgYywKICAgICAgICAgIGYsCiAgICAgICAgICBkID0gcGUuYWpheFNldHVwKHt9LCBuKSwKICAgICAgICAgIHAgPSBkLmNvbnRleHQgfHwgZCwKICAgICAgICAgIGggPSBkLmNvbnRleHQgJiYgKHAubm9kZVR5cGUgfHwgcC5qcXVlcnkpID8gcGUocCkgOiBwZS5ldmVudCwKICAgICAgICAgIGcgPSBwZS5EZWZlcnJlZCgpLAogICAgICAgICAgbSA9IHBlLkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwKICAgICAgICAgIHkgPSBkLnN0YXR1c0NvZGUgfHwge30sCiAgICAgICAgICB2ID0ge30sCiAgICAgICAgICB4ID0ge30sCiAgICAgICAgICBiID0gMCwKICAgICAgICAgIHcgPSAiY2FuY2VsZWQiLAogICAgICAgICAgVCA9IHsKICAgICAgICByZWFkeVN0YXRlOiAwLAogICAgICAgIGdldFJlc3BvbnNlSGVhZGVyOiBmdW5jdGlvbiBnZXRSZXNwb25zZUhlYWRlcihlKSB7CiAgICAgICAgICB2YXIgdDsKCiAgICAgICAgICBpZiAoMiA9PT0gYikgewogICAgICAgICAgICBpZiAoIWYpIGZvciAoZiA9IHt9OyB0ID0gVXQuZXhlYyhzKTspIHsKICAgICAgICAgICAgICBmW3RbMV0udG9Mb3dlckNhc2UoKV0gPSB0WzJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHQgPSBmW2UudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIG51bGwgPT0gdCA/IG51bGwgOiB0OwogICAgICAgIH0sCiAgICAgICAgZ2V0QWxsUmVzcG9uc2VIZWFkZXJzOiBmdW5jdGlvbiBnZXRBbGxSZXNwb25zZUhlYWRlcnMoKSB7CiAgICAgICAgICByZXR1cm4gMiA9PT0gYiA/IHMgOiBudWxsOwogICAgICAgIH0sCiAgICAgICAgc2V0UmVxdWVzdEhlYWRlcjogZnVuY3Rpb24gc2V0UmVxdWVzdEhlYWRlcihlLCB0KSB7CiAgICAgICAgICB2YXIgbiA9IGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBiIHx8IChlID0geFtuXSA9IHhbbl0gfHwgZSwgdltlXSA9IHQpLCB0aGlzOwogICAgICAgIH0sCiAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogZnVuY3Rpb24gb3ZlcnJpZGVNaW1lVHlwZShlKSB7CiAgICAgICAgICByZXR1cm4gYiB8fCAoZC5taW1lVHlwZSA9IGUpLCB0aGlzOwogICAgICAgIH0sCiAgICAgICAgc3RhdHVzQ29kZTogZnVuY3Rpb24gc3RhdHVzQ29kZShlKSB7CiAgICAgICAgICB2YXIgdDsKICAgICAgICAgIGlmIChlKSBpZiAoYiA8IDIpIGZvciAodCBpbiBlKSB7CiAgICAgICAgICAgIHlbdF0gPSBbeVt0XSwgZVt0XV07CiAgICAgICAgICB9IGVsc2UgVC5hbHdheXMoZVtULnN0YXR1c10pOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICBhYm9ydDogZnVuY3Rpb24gYWJvcnQoZSkgewogICAgICAgICAgdmFyIHQgPSBlIHx8IHc7CiAgICAgICAgICByZXR1cm4gYyAmJiBjLmFib3J0KHQpLCByKDAsIHQpLCB0aGlzOwogICAgICAgIH0KICAgICAgfTsKICAgICAgaWYgKGcucHJvbWlzZShUKS5jb21wbGV0ZSA9IG0uYWRkLCBULnN1Y2Nlc3MgPSBULmRvbmUsIFQuZXJyb3IgPSBULmZhaWwsIGQudXJsID0gKCh0IHx8IGQudXJsIHx8IGVuKSArICIiKS5yZXBsYWNlKHp0LCAiIikucmVwbGFjZShKdCwgdG5bMV0gKyAiLy8iKSwgZC50eXBlID0gbi5tZXRob2QgfHwgbi50eXBlIHx8IGQubWV0aG9kIHx8IGQudHlwZSwgZC5kYXRhVHlwZXMgPSBwZS50cmltKGQuZGF0YVR5cGUgfHwgIioiKS50b0xvd2VyQ2FzZSgpLm1hdGNoKERlKSB8fCBbIiJdLCBudWxsID09IGQuY3Jvc3NEb21haW4gJiYgKGkgPSBHdC5leGVjKGQudXJsLnRvTG93ZXJDYXNlKCkpLCBkLmNyb3NzRG9tYWluID0gISghaSB8fCBpWzFdID09PSB0blsxXSAmJiBpWzJdID09PSB0blsyXSAmJiAoaVszXSB8fCAoImh0dHA6IiA9PT0gaVsxXSA/ICI4MCIgOiAiNDQzIikpID09PSAodG5bM10gfHwgKCJodHRwOiIgPT09IHRuWzFdID8gIjgwIiA6ICI0NDMiKSkpKSwgZC5kYXRhICYmIGQucHJvY2Vzc0RhdGEgJiYgInN0cmluZyIgIT0gdHlwZW9mIGQuZGF0YSAmJiAoZC5kYXRhID0gcGUucGFyYW0oZC5kYXRhLCBkLnRyYWRpdGlvbmFsKSksIFUoS3QsIGQsIG4sIFQpLCAyID09PSBiKSByZXR1cm4gVDsKICAgICAgbCA9IHBlLmV2ZW50ICYmIGQuZ2xvYmFsLCBsICYmIDAgPT09IHBlLmFjdGl2ZSsrICYmIHBlLmV2ZW50LnRyaWdnZXIoImFqYXhTdGFydCIpLCBkLnR5cGUgPSBkLnR5cGUudG9VcHBlckNhc2UoKSwgZC5oYXNDb250ZW50ID0gIVl0LnRlc3QoZC50eXBlKSwgYSA9IGQudXJsLCBkLmhhc0NvbnRlbnQgfHwgKGQuZGF0YSAmJiAoYSA9IGQudXJsICs9IChJdC50ZXN0KGEpID8gIiYiIDogIj8iKSArIGQuZGF0YSwgZGVsZXRlIGQuZGF0YSksIGQuY2FjaGUgPT09ICExICYmIChkLnVybCA9IFh0LnRlc3QoYSkgPyBhLnJlcGxhY2UoWHQsICIkMV89IiArIFd0KyspIDogYSArIChJdC50ZXN0KGEpID8gIiYiIDogIj8iKSArICJfPSIgKyBXdCsrKSksIGQuaWZNb2RpZmllZCAmJiAocGUubGFzdE1vZGlmaWVkW2FdICYmIFQuc2V0UmVxdWVzdEhlYWRlcigiSWYtTW9kaWZpZWQtU2luY2UiLCBwZS5sYXN0TW9kaWZpZWRbYV0pLCBwZS5ldGFnW2FdICYmIFQuc2V0UmVxdWVzdEhlYWRlcigiSWYtTm9uZS1NYXRjaCIsIHBlLmV0YWdbYV0pKSwgKGQuZGF0YSAmJiBkLmhhc0NvbnRlbnQgJiYgZC5jb250ZW50VHlwZSAhPT0gITEgfHwgbi5jb250ZW50VHlwZSkgJiYgVC5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LVR5cGUiLCBkLmNvbnRlbnRUeXBlKSwgVC5zZXRSZXF1ZXN0SGVhZGVyKCJBY2NlcHQiLCBkLmRhdGFUeXBlc1swXSAmJiBkLmFjY2VwdHNbZC5kYXRhVHlwZXNbMF1dID8gZC5hY2NlcHRzW2QuZGF0YVR5cGVzWzBdXSArICgiKiIgIT09IGQuZGF0YVR5cGVzWzBdID8gIiwgIiArIFp0ICsgIjsgcT0wLjAxIiA6ICIiKSA6IGQuYWNjZXB0c1siKiJdKTsKCiAgICAgIGZvciAobyBpbiBkLmhlYWRlcnMpIHsKICAgICAgICBULnNldFJlcXVlc3RIZWFkZXIobywgZC5oZWFkZXJzW29dKTsKICAgICAgfQoKICAgICAgaWYgKGQuYmVmb3JlU2VuZCAmJiAoZC5iZWZvcmVTZW5kLmNhbGwocCwgVCwgZCkgPT09ICExIHx8IDIgPT09IGIpKSByZXR1cm4gVC5hYm9ydCgpOwogICAgICB3ID0gImFib3J0IjsKCiAgICAgIGZvciAobyBpbiB7CiAgICAgICAgc3VjY2VzczogMSwKICAgICAgICBlcnJvcjogMSwKICAgICAgICBjb21wbGV0ZTogMQogICAgICB9KSB7CiAgICAgICAgVFtvXShkW29dKTsKICAgICAgfQoKICAgICAgaWYgKGMgPSBVKFF0LCBkLCBuLCBUKSkgewogICAgICAgIGlmIChULnJlYWR5U3RhdGUgPSAxLCBsICYmIGgudHJpZ2dlcigiYWpheFNlbmQiLCBbVCwgZF0pLCAyID09PSBiKSByZXR1cm4gVDsKICAgICAgICBkLmFzeW5jICYmIGQudGltZW91dCA+IDAgJiYgKHUgPSBlLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgVC5hYm9ydCgidGltZW91dCIpOwogICAgICAgIH0sIGQudGltZW91dCkpOwoKICAgICAgICB0cnkgewogICAgICAgICAgYiA9IDEsIGMuc2VuZCh2LCByKTsKICAgICAgICB9IGNhdGNoIChDKSB7CiAgICAgICAgICBpZiAoIShiIDwgMikpIHRocm93IEM7CiAgICAgICAgICByKC0xLCBDKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSByKC0xLCAiTm8gVHJhbnNwb3J0Iik7CgogICAgICByZXR1cm4gVDsKICAgIH0sCiAgICBnZXRKU09OOiBmdW5jdGlvbiBnZXRKU09OKGUsIHQsIG4pIHsKICAgICAgcmV0dXJuIHBlLmdldChlLCB0LCBuLCAianNvbiIpOwogICAgfSwKICAgIGdldFNjcmlwdDogZnVuY3Rpb24gZ2V0U2NyaXB0KGUsIHQpIHsKICAgICAgcmV0dXJuIHBlLmdldChlLCB2b2lkIDAsIHQsICJzY3JpcHQiKTsKICAgIH0KICB9KSwgcGUuZWFjaChbImdldCIsICJwb3N0Il0sIGZ1bmN0aW9uIChlLCB0KSB7CiAgICBwZVt0XSA9IGZ1bmN0aW9uIChlLCBuLCByLCBpKSB7CiAgICAgIHJldHVybiBwZS5pc0Z1bmN0aW9uKG4pICYmIChpID0gaSB8fCByLCByID0gbiwgbiA9IHZvaWQgMCksIHBlLmFqYXgocGUuZXh0ZW5kKHsKICAgICAgICB1cmw6IGUsCiAgICAgICAgdHlwZTogdCwKICAgICAgICBkYXRhVHlwZTogaSwKICAgICAgICBkYXRhOiBuLAogICAgICAgIHN1Y2Nlc3M6IHIKICAgICAgfSwgcGUuaXNQbGFpbk9iamVjdChlKSAmJiBlKSk7CiAgICB9OwogIH0pLCBwZS5fZXZhbFVybCA9IGZ1bmN0aW9uIChlKSB7CiAgICByZXR1cm4gcGUuYWpheCh7CiAgICAgIHVybDogZSwKICAgICAgdHlwZTogIkdFVCIsCiAgICAgIGRhdGFUeXBlOiAic2NyaXB0IiwKICAgICAgY2FjaGU6ICEwLAogICAgICBhc3luYzogITEsCiAgICAgIGdsb2JhbDogITEsCiAgICAgICJ0aHJvd3MiOiAhMAogICAgfSk7CiAgfSwgcGUuZm4uZXh0ZW5kKHsKICAgIHdyYXBBbGw6IGZ1bmN0aW9uIHdyYXBBbGwoZSkgewogICAgICBpZiAocGUuaXNGdW5jdGlvbihlKSkgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAodCkgewogICAgICAgIHBlKHRoaXMpLndyYXBBbGwoZS5jYWxsKHRoaXMsIHQpKTsKICAgICAgfSk7CgogICAgICBpZiAodGhpc1swXSkgewogICAgICAgIHZhciB0ID0gcGUoZSwgdGhpc1swXS5vd25lckRvY3VtZW50KS5lcSgwKS5jbG9uZSghMCk7CiAgICAgICAgdGhpc1swXS5wYXJlbnROb2RlICYmIHQuaW5zZXJ0QmVmb3JlKHRoaXNbMF0pLCB0Lm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmb3IgKHZhciBlID0gdGhpczsgZS5maXJzdENoaWxkICYmIDEgPT09IGUuZmlyc3RDaGlsZC5ub2RlVHlwZTspIHsKICAgICAgICAgICAgZSA9IGUuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZTsKICAgICAgICB9KS5hcHBlbmQodGhpcyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHdyYXBJbm5lcjogZnVuY3Rpb24gd3JhcElubmVyKGUpIHsKICAgICAgcmV0dXJuIHBlLmlzRnVuY3Rpb24oZSkgPyB0aGlzLmVhY2goZnVuY3Rpb24gKHQpIHsKICAgICAgICBwZSh0aGlzKS53cmFwSW5uZXIoZS5jYWxsKHRoaXMsIHQpKTsKICAgICAgfSkgOiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0ID0gcGUodGhpcyksCiAgICAgICAgICAgIG4gPSB0LmNvbnRlbnRzKCk7CiAgICAgICAgbi5sZW5ndGggPyBuLndyYXBBbGwoZSkgOiB0LmFwcGVuZChlKTsKICAgICAgfSk7CiAgICB9LAogICAgd3JhcDogZnVuY3Rpb24gd3JhcChlKSB7CiAgICAgIHZhciB0ID0gcGUuaXNGdW5jdGlvbihlKTsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAobikgewogICAgICAgIHBlKHRoaXMpLndyYXBBbGwodCA/IGUuY2FsbCh0aGlzLCBuKSA6IGUpOwogICAgICB9KTsKICAgIH0sCiAgICB1bndyYXA6IGZ1bmN0aW9uIHVud3JhcCgpIHsKICAgICAgcmV0dXJuIHRoaXMucGFyZW50KCkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgcGUubm9kZU5hbWUodGhpcywgImJvZHkiKSB8fCBwZSh0aGlzKS5yZXBsYWNlV2l0aCh0aGlzLmNoaWxkTm9kZXMpOwogICAgICB9KS5lbmQoKTsKICAgIH0KICB9KSwgcGUuZXhwci5maWx0ZXJzLmhpZGRlbiA9IGZ1bmN0aW9uIChlKSB7CiAgICByZXR1cm4gZmUucmVsaWFibGVIaWRkZW5PZmZzZXRzKCkgPyBlLm9mZnNldFdpZHRoIDw9IDAgJiYgZS5vZmZzZXRIZWlnaHQgPD0gMCAmJiAhZS5nZXRDbGllbnRSZWN0cygpLmxlbmd0aCA6IEsoZSk7CiAgfSwgcGUuZXhwci5maWx0ZXJzLnZpc2libGUgPSBmdW5jdGlvbiAoZSkgewogICAgcmV0dXJuICFwZS5leHByLmZpbHRlcnMuaGlkZGVuKGUpOwogIH07CiAgdmFyIG5uID0gLyUyMC9nLAogICAgICBybiA9IC9cW1xdJC8sCiAgICAgIG9uID0gL1xyP1xuL2csCiAgICAgIGFuID0gL14oPzpzdWJtaXR8YnV0dG9ufGltYWdlfHJlc2V0fGZpbGUpJC9pLAogICAgICBzbiA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGtleWdlbikvaTsKICBwZS5wYXJhbSA9IGZ1bmN0aW9uIChlLCB0KSB7CiAgICB2YXIgbiwKICAgICAgICByID0gW10sCiAgICAgICAgaSA9IGZ1bmN0aW9uIGkoZSwgdCkgewogICAgICB0ID0gcGUuaXNGdW5jdGlvbih0KSA/IHQoKSA6IG51bGwgPT0gdCA/ICIiIDogdCwgcltyLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoZSkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQodCk7CiAgICB9OwoKICAgIGlmICh2b2lkIDAgPT09IHQgJiYgKHQgPSBwZS5hamF4U2V0dGluZ3MgJiYgcGUuYWpheFNldHRpbmdzLnRyYWRpdGlvbmFsKSwgcGUuaXNBcnJheShlKSB8fCBlLmpxdWVyeSAmJiAhcGUuaXNQbGFpbk9iamVjdChlKSkgcGUuZWFjaChlLCBmdW5jdGlvbiAoKSB7CiAgICAgIGkodGhpcy5uYW1lLCB0aGlzLnZhbHVlKTsKICAgIH0pO2Vsc2UgZm9yIChuIGluIGUpIHsKICAgICAgUShuLCBlW25dLCB0LCBpKTsKICAgIH0KICAgIHJldHVybiByLmpvaW4oIiYiKS5yZXBsYWNlKG5uLCAiKyIpOwogIH0sIHBlLmZuLmV4dGVuZCh7CiAgICBzZXJpYWxpemU6IGZ1bmN0aW9uIHNlcmlhbGl6ZSgpIHsKICAgICAgcmV0dXJuIHBlLnBhcmFtKHRoaXMuc2VyaWFsaXplQXJyYXkoKSk7CiAgICB9LAogICAgc2VyaWFsaXplQXJyYXk6IGZ1bmN0aW9uIHNlcmlhbGl6ZUFycmF5KCkgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBlID0gcGUucHJvcCh0aGlzLCAiZWxlbWVudHMiKTsKICAgICAgICByZXR1cm4gZSA/IHBlLm1ha2VBcnJheShlKSA6IHRoaXM7CiAgICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGUgPSB0aGlzLnR5cGU7CiAgICAgICAgcmV0dXJuIHRoaXMubmFtZSAmJiAhcGUodGhpcykuaXMoIjpkaXNhYmxlZCIpICYmIHNuLnRlc3QodGhpcy5ub2RlTmFtZSkgJiYgIWFuLnRlc3QoZSkgJiYgKHRoaXMuY2hlY2tlZCB8fCAhQmUudGVzdChlKSk7CiAgICAgIH0pLm1hcChmdW5jdGlvbiAoZSwgdCkgewogICAgICAgIHZhciBuID0gcGUodGhpcykudmFsKCk7CiAgICAgICAgcmV0dXJuIG51bGwgPT0gbiA/IG51bGwgOiBwZS5pc0FycmF5KG4pID8gcGUubWFwKG4sIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBuYW1lOiB0Lm5hbWUsCiAgICAgICAgICAgIHZhbHVlOiBlLnJlcGxhY2Uob24sICJcclxuIikKICAgICAgICAgIH07CiAgICAgICAgfSkgOiB7CiAgICAgICAgICBuYW1lOiB0Lm5hbWUsCiAgICAgICAgICB2YWx1ZTogbi5yZXBsYWNlKG9uLCAiXHJcbiIpCiAgICAgICAgfTsKICAgICAgfSkuZ2V0KCk7CiAgICB9CiAgfSksIHBlLmFqYXhTZXR0aW5ncy54aHIgPSB2b2lkIDAgIT09IGUuQWN0aXZlWE9iamVjdCA/IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmlzTG9jYWwgPyBlZSgpIDogcmUuZG9jdW1lbnRNb2RlID4gOCA/IFooKSA6IC9eKGdldHxwb3N0fGhlYWR8cHV0fGRlbGV0ZXxvcHRpb25zKSQvaS50ZXN0KHRoaXMudHlwZSkgJiYgWigpIHx8IGVlKCk7CiAgfSA6IFo7CiAgdmFyIHVuID0gMCwKICAgICAgbG4gPSB7fSwKICAgICAgY24gPSBwZS5hamF4U2V0dGluZ3MueGhyKCk7CiAgZS5hdHRhY2hFdmVudCAmJiBlLmF0dGFjaEV2ZW50KCJvbnVubG9hZCIsIGZ1bmN0aW9uICgpIHsKICAgIGZvciAodmFyIGUgaW4gbG4pIHsKICAgICAgbG5bZV0odm9pZCAwLCAhMCk7CiAgICB9CiAgfSksIGZlLmNvcnMgPSAhIWNuICYmICJ3aXRoQ3JlZGVudGlhbHMiIGluIGNuLCBjbiA9IGZlLmFqYXggPSAhIWNuLCBjbiAmJiBwZS5hamF4VHJhbnNwb3J0KGZ1bmN0aW9uICh0KSB7CiAgICBpZiAoIXQuY3Jvc3NEb21haW4gfHwgZmUuY29ycykgewogICAgICB2YXIgX247CgogICAgICByZXR1cm4gewogICAgICAgIHNlbmQ6IGZ1bmN0aW9uIHNlbmQociwgaSkgewogICAgICAgICAgdmFyIG8sCiAgICAgICAgICAgICAgYSA9IHQueGhyKCksCiAgICAgICAgICAgICAgcyA9ICsrdW47CiAgICAgICAgICBpZiAoYS5vcGVuKHQudHlwZSwgdC51cmwsIHQuYXN5bmMsIHQudXNlcm5hbWUsIHQucGFzc3dvcmQpLCB0LnhockZpZWxkcykgZm9yIChvIGluIHQueGhyRmllbGRzKSB7CiAgICAgICAgICAgIGFbb10gPSB0LnhockZpZWxkc1tvXTsKICAgICAgICAgIH0KICAgICAgICAgIHQubWltZVR5cGUgJiYgYS5vdmVycmlkZU1pbWVUeXBlICYmIGEub3ZlcnJpZGVNaW1lVHlwZSh0Lm1pbWVUeXBlKSwgdC5jcm9zc0RvbWFpbiB8fCByWyJYLVJlcXVlc3RlZC1XaXRoIl0gfHwgKHJbIlgtUmVxdWVzdGVkLVdpdGgiXSA9ICJYTUxIdHRwUmVxdWVzdCIpOwoKICAgICAgICAgIGZvciAobyBpbiByKSB7CiAgICAgICAgICAgIHZvaWQgMCAhPT0gcltvXSAmJiBhLnNldFJlcXVlc3RIZWFkZXIobywgcltvXSArICIiKTsKICAgICAgICAgIH0KCiAgICAgICAgICBhLnNlbmQodC5oYXNDb250ZW50ICYmIHQuZGF0YSB8fCBudWxsKSwgX24gPSBmdW5jdGlvbiBuKGUsIHIpIHsKICAgICAgICAgICAgdmFyIG8sIHUsIGw7CiAgICAgICAgICAgIGlmIChfbiAmJiAociB8fCA0ID09PSBhLnJlYWR5U3RhdGUpKSBpZiAoZGVsZXRlIGxuW3NdLCBfbiA9IHZvaWQgMCwgYS5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBwZS5ub29wLCByKSA0ICE9PSBhLnJlYWR5U3RhdGUgJiYgYS5hYm9ydCgpO2Vsc2UgewogICAgICAgICAgICAgIGwgPSB7fSwgbyA9IGEuc3RhdHVzLCAic3RyaW5nIiA9PSB0eXBlb2YgYS5yZXNwb25zZVRleHQgJiYgKGwudGV4dCA9IGEucmVzcG9uc2VUZXh0KTsKCiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHUgPSBhLnN0YXR1c1RleHQ7CiAgICAgICAgICAgICAgfSBjYXRjaCAoYykgewogICAgICAgICAgICAgICAgdSA9ICIiOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgbyB8fCAhdC5pc0xvY2FsIHx8IHQuY3Jvc3NEb21haW4gPyAxMjIzID09PSBvICYmIChvID0gMjA0KSA6IG8gPSBsLnRleHQgPyAyMDAgOiA0MDQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbCAmJiBpKG8sIHUsIGwsIGEuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkpOwogICAgICAgICAgfSwgdC5hc3luYyA/IDQgPT09IGEucmVhZHlTdGF0ZSA/IGUuc2V0VGltZW91dChfbikgOiBhLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGxuW3NdID0gX24gOiBfbigpOwogICAgICAgIH0sCiAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uIGFib3J0KCkgewogICAgICAgICAgX24gJiYgX24odm9pZCAwLCAhMCk7CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH0pLCBwZS5hamF4U2V0dXAoewogICAgYWNjZXB0czogewogICAgICBzY3JpcHQ6ICJ0ZXh0L2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2VjbWFzY3JpcHQsIGFwcGxpY2F0aW9uL3gtZWNtYXNjcmlwdCIKICAgIH0sCiAgICBjb250ZW50czogewogICAgICBzY3JpcHQ6IC9cYig/OmphdmF8ZWNtYSlzY3JpcHRcYi8KICAgIH0sCiAgICBjb252ZXJ0ZXJzOiB7CiAgICAgICJ0ZXh0IHNjcmlwdCI6IGZ1bmN0aW9uIHRleHRTY3JpcHQoZSkgewogICAgICAgIHJldHVybiBwZS5nbG9iYWxFdmFsKGUpLCBlOwogICAgICB9CiAgICB9CiAgfSksIHBlLmFqYXhQcmVmaWx0ZXIoInNjcmlwdCIsIGZ1bmN0aW9uIChlKSB7CiAgICB2b2lkIDAgPT09IGUuY2FjaGUgJiYgKGUuY2FjaGUgPSAhMSksIGUuY3Jvc3NEb21haW4gJiYgKGUudHlwZSA9ICJHRVQiLCBlLmdsb2JhbCA9ICExKTsKICB9KSwgcGUuYWpheFRyYW5zcG9ydCgic2NyaXB0IiwgZnVuY3Rpb24gKGUpIHsKICAgIGlmIChlLmNyb3NzRG9tYWluKSB7CiAgICAgIHZhciB0LAogICAgICAgICAgbiA9IHJlLmhlYWQgfHwgcGUoImhlYWQiKVswXSB8fCByZS5kb2N1bWVudEVsZW1lbnQ7CiAgICAgIHJldHVybiB7CiAgICAgICAgc2VuZDogZnVuY3Rpb24gc2VuZChyLCBpKSB7CiAgICAgICAgICB0ID0gcmUuY3JlYXRlRWxlbWVudCgic2NyaXB0IiksIHQuYXN5bmMgPSAhMCwgZS5zY3JpcHRDaGFyc2V0ICYmICh0LmNoYXJzZXQgPSBlLnNjcmlwdENoYXJzZXQpLCB0LnNyYyA9IGUudXJsLCB0Lm9ubG9hZCA9IHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKGUsIG4pIHsKICAgICAgICAgICAgKG4gfHwgIXQucmVhZHlTdGF0ZSB8fCAvbG9hZGVkfGNvbXBsZXRlLy50ZXN0KHQucmVhZHlTdGF0ZSkpICYmICh0Lm9ubG9hZCA9IHQub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbCwgdC5wYXJlbnROb2RlICYmIHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0KSwgdCA9IG51bGwsIG4gfHwgaSgyMDAsICJzdWNjZXNzIikpOwogICAgICAgICAgfSwgbi5pbnNlcnRCZWZvcmUodCwgbi5maXJzdENoaWxkKTsKICAgICAgICB9LAogICAgICAgIGFib3J0OiBmdW5jdGlvbiBhYm9ydCgpIHsKICAgICAgICAgIHQgJiYgdC5vbmxvYWQodm9pZCAwLCAhMCk7CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH0pOwogIHZhciBmbiA9IFtdLAogICAgICBkbiA9IC8oPSlcPyg/PSZ8JCl8XD9cPy87CiAgcGUuYWpheFNldHVwKHsKICAgIGpzb25wOiAiY2FsbGJhY2siLAogICAganNvbnBDYWxsYmFjazogZnVuY3Rpb24ganNvbnBDYWxsYmFjaygpIHsKICAgICAgdmFyIGUgPSBmbi5wb3AoKSB8fCBwZS5leHBhbmRvICsgIl8iICsgV3QrKzsKICAgICAgcmV0dXJuIHRoaXNbZV0gPSAhMCwgZTsKICAgIH0KICB9KSwgcGUuYWpheFByZWZpbHRlcigianNvbiBqc29ucCIsIGZ1bmN0aW9uICh0LCBuLCByKSB7CiAgICB2YXIgaSwKICAgICAgICBvLAogICAgICAgIGEsCiAgICAgICAgcyA9IHQuanNvbnAgIT09ICExICYmIChkbi50ZXN0KHQudXJsKSA/ICJ1cmwiIDogInN0cmluZyIgPT0gdHlwZW9mIHQuZGF0YSAmJiAwID09PSAodC5jb250ZW50VHlwZSB8fCAiIikuaW5kZXhPZigiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIikgJiYgZG4udGVzdCh0LmRhdGEpICYmICJkYXRhIik7CiAgICBpZiAocyB8fCAianNvbnAiID09PSB0LmRhdGFUeXBlc1swXSkgcmV0dXJuIGkgPSB0Lmpzb25wQ2FsbGJhY2sgPSBwZS5pc0Z1bmN0aW9uKHQuanNvbnBDYWxsYmFjaykgPyB0Lmpzb25wQ2FsbGJhY2soKSA6IHQuanNvbnBDYWxsYmFjaywgcyA/IHRbc10gPSB0W3NdLnJlcGxhY2UoZG4sICIkMSIgKyBpKSA6IHQuanNvbnAgIT09ICExICYmICh0LnVybCArPSAoSXQudGVzdCh0LnVybCkgPyAiJiIgOiAiPyIpICsgdC5qc29ucCArICI9IiArIGkpLCB0LmNvbnZlcnRlcnNbInNjcmlwdCBqc29uIl0gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBhIHx8IHBlLmVycm9yKGkgKyAiIHdhcyBub3QgY2FsbGVkIiksIGFbMF07CiAgICB9LCB0LmRhdGFUeXBlc1swXSA9ICJqc29uIiwgbyA9IGVbaV0sIGVbaV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgIGEgPSBhcmd1bWVudHM7CiAgICB9LCByLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgIHZvaWQgMCA9PT0gbyA/IHBlKGUpLnJlbW92ZVByb3AoaSkgOiBlW2ldID0gbywgdFtpXSAmJiAodC5qc29ucENhbGxiYWNrID0gbi5qc29ucENhbGxiYWNrLCBmbi5wdXNoKGkpKSwgYSAmJiBwZS5pc0Z1bmN0aW9uKG8pICYmIG8oYVswXSksIGEgPSBvID0gdm9pZCAwOwogICAgfSksICJzY3JpcHQiOwogIH0pLCBwZS5wYXJzZUhUTUwgPSBmdW5jdGlvbiAoZSwgdCwgbikgewogICAgaWYgKCFlIHx8ICJzdHJpbmciICE9IHR5cGVvZiBlKSByZXR1cm4gbnVsbDsKICAgICJib29sZWFuIiA9PSB0eXBlb2YgdCAmJiAobiA9IHQsIHQgPSAhMSksIHQgPSB0IHx8IHJlOwogICAgdmFyIHIgPSBUZS5leGVjKGUpLAogICAgICAgIGkgPSAhbiAmJiBbXTsKICAgIHJldHVybiByID8gW3QuY3JlYXRlRWxlbWVudChyWzFdKV0gOiAociA9IHkoW2VdLCB0LCBpKSwgaSAmJiBpLmxlbmd0aCAmJiBwZShpKS5yZW1vdmUoKSwgcGUubWVyZ2UoW10sIHIuY2hpbGROb2RlcykpOwogIH07CiAgdmFyIHBuID0gcGUuZm4ubG9hZDsKICByZXR1cm4gcGUuZm4ubG9hZCA9IGZ1bmN0aW9uIChlLCB0LCBuKSB7CiAgICBpZiAoInN0cmluZyIgIT0gdHlwZW9mIGUgJiYgcG4pIHJldHVybiBwbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdmFyIHIsCiAgICAgICAgaSwKICAgICAgICBvLAogICAgICAgIGEgPSB0aGlzLAogICAgICAgIHMgPSBlLmluZGV4T2YoIiAiKTsKICAgIHJldHVybiBzID4gLTEgJiYgKHIgPSBwZS50cmltKGUuc2xpY2UocywgZS5sZW5ndGgpKSwgZSA9IGUuc2xpY2UoMCwgcykpLCBwZS5pc0Z1bmN0aW9uKHQpID8gKG4gPSB0LCB0ID0gdm9pZCAwKSA6IHQgJiYgIm9iamVjdCIgPT0gX3R5cGVvZih0KSAmJiAoaSA9ICJQT1NUIiksIGEubGVuZ3RoID4gMCAmJiBwZS5hamF4KHsKICAgICAgdXJsOiBlLAogICAgICB0eXBlOiBpIHx8ICJHRVQiLAogICAgICBkYXRhVHlwZTogImh0bWwiLAogICAgICBkYXRhOiB0CiAgICB9KS5kb25lKGZ1bmN0aW9uIChlKSB7CiAgICAgIG8gPSBhcmd1bWVudHMsIGEuaHRtbChyID8gcGUoIjxkaXY+IikuYXBwZW5kKHBlLnBhcnNlSFRNTChlKSkuZmluZChyKSA6IGUpOwogICAgfSkuYWx3YXlzKG4gJiYgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgYS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBuLmFwcGx5KHRoaXMsIG8gfHwgW2UucmVzcG9uc2VUZXh0LCB0LCBlXSk7CiAgICAgIH0pOwogICAgfSksIHRoaXM7CiAgfSwgcGUuZWFjaChbImFqYXhTdGFydCIsICJhamF4U3RvcCIsICJhamF4Q29tcGxldGUiLCAiYWpheEVycm9yIiwgImFqYXhTdWNjZXNzIiwgImFqYXhTZW5kIl0sIGZ1bmN0aW9uIChlLCB0KSB7CiAgICBwZS5mblt0XSA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIHJldHVybiB0aGlzLm9uKHQsIGUpOwogICAgfTsKICB9KSwgcGUuZXhwci5maWx0ZXJzLmFuaW1hdGVkID0gZnVuY3Rpb24gKGUpIHsKICAgIHJldHVybiBwZS5ncmVwKHBlLnRpbWVycywgZnVuY3Rpb24gKHQpIHsKICAgICAgcmV0dXJuIGUgPT09IHQuZWxlbTsKICAgIH0pLmxlbmd0aDsKICB9LCBwZS5vZmZzZXQgPSB7CiAgICBzZXRPZmZzZXQ6IGZ1bmN0aW9uIHNldE9mZnNldChlLCB0LCBuKSB7CiAgICAgIHZhciByLAogICAgICAgICAgaSwKICAgICAgICAgIG8sCiAgICAgICAgICBhLAogICAgICAgICAgcywKICAgICAgICAgIHUsCiAgICAgICAgICBsLAogICAgICAgICAgYyA9IHBlLmNzcyhlLCAicG9zaXRpb24iKSwKICAgICAgICAgIGYgPSBwZShlKSwKICAgICAgICAgIGQgPSB7fTsKICAgICAgInN0YXRpYyIgPT09IGMgJiYgKGUuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiKSwgcyA9IGYub2Zmc2V0KCksIG8gPSBwZS5jc3MoZSwgInRvcCIpLCB1ID0gcGUuY3NzKGUsICJsZWZ0IiksIGwgPSAoImFic29sdXRlIiA9PT0gYyB8fCAiZml4ZWQiID09PSBjKSAmJiBwZS5pbkFycmF5KCJhdXRvIiwgW28sIHVdKSA+IC0xLCBsID8gKHIgPSBmLnBvc2l0aW9uKCksIGEgPSByLnRvcCwgaSA9IHIubGVmdCkgOiAoYSA9IHBhcnNlRmxvYXQobykgfHwgMCwgaSA9IHBhcnNlRmxvYXQodSkgfHwgMCksIHBlLmlzRnVuY3Rpb24odCkgJiYgKHQgPSB0LmNhbGwoZSwgbiwgcGUuZXh0ZW5kKHt9LCBzKSkpLCBudWxsICE9IHQudG9wICYmIChkLnRvcCA9IHQudG9wIC0gcy50b3AgKyBhKSwgbnVsbCAhPSB0LmxlZnQgJiYgKGQubGVmdCA9IHQubGVmdCAtIHMubGVmdCArIGkpLCAidXNpbmciIGluIHQgPyB0LnVzaW5nLmNhbGwoZSwgZCkgOiBmLmNzcyhkKTsKICAgIH0KICB9LCBwZS5mbi5leHRlbmQoewogICAgb2Zmc2V0OiBmdW5jdGlvbiBvZmZzZXQoZSkgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIHZvaWQgMCA9PT0gZSA/IHRoaXMgOiB0aGlzLmVhY2goZnVuY3Rpb24gKHQpIHsKICAgICAgICBwZS5vZmZzZXQuc2V0T2Zmc2V0KHRoaXMsIGUsIHQpOwogICAgICB9KTsKICAgICAgdmFyIHQsCiAgICAgICAgICBuLAogICAgICAgICAgciA9IHsKICAgICAgICB0b3A6IDAsCiAgICAgICAgbGVmdDogMAogICAgICB9LAogICAgICAgICAgaSA9IHRoaXNbMF0sCiAgICAgICAgICBvID0gaSAmJiBpLm93bmVyRG9jdW1lbnQ7CiAgICAgIGlmIChvKSByZXR1cm4gdCA9IG8uZG9jdW1lbnRFbGVtZW50LCBwZS5jb250YWlucyh0LCBpKSA/ICgidW5kZWZpbmVkIiAhPSB0eXBlb2YgaS5nZXRCb3VuZGluZ0NsaWVudFJlY3QgJiYgKHIgPSBpLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpKSwgbiA9IHRlKG8pLCB7CiAgICAgICAgdG9wOiByLnRvcCArIChuLnBhZ2VZT2Zmc2V0IHx8IHQuc2Nyb2xsVG9wKSAtICh0LmNsaWVudFRvcCB8fCAwKSwKICAgICAgICBsZWZ0OiByLmxlZnQgKyAobi5wYWdlWE9mZnNldCB8fCB0LnNjcm9sbExlZnQpIC0gKHQuY2xpZW50TGVmdCB8fCAwKQogICAgICB9KSA6IHI7CiAgICB9LAogICAgcG9zaXRpb246IGZ1bmN0aW9uIHBvc2l0aW9uKCkgewogICAgICBpZiAodGhpc1swXSkgewogICAgICAgIHZhciBlLAogICAgICAgICAgICB0LAogICAgICAgICAgICBuID0gewogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgbGVmdDogMAogICAgICAgIH0sCiAgICAgICAgICAgIHIgPSB0aGlzWzBdOwogICAgICAgIHJldHVybiAiZml4ZWQiID09PSBwZS5jc3MociwgInBvc2l0aW9uIikgPyB0ID0gci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSA6IChlID0gdGhpcy5vZmZzZXRQYXJlbnQoKSwgdCA9IHRoaXMub2Zmc2V0KCksIHBlLm5vZGVOYW1lKGVbMF0sICJodG1sIikgfHwgKG4gPSBlLm9mZnNldCgpKSwgbi50b3AgKz0gcGUuY3NzKGVbMF0sICJib3JkZXJUb3BXaWR0aCIsICEwKSwgbi5sZWZ0ICs9IHBlLmNzcyhlWzBdLCAiYm9yZGVyTGVmdFdpZHRoIiwgITApKSwgewogICAgICAgICAgdG9wOiB0LnRvcCAtIG4udG9wIC0gcGUuY3NzKHIsICJtYXJnaW5Ub3AiLCAhMCksCiAgICAgICAgICBsZWZ0OiB0LmxlZnQgLSBuLmxlZnQgLSBwZS5jc3MociwgIm1hcmdpbkxlZnQiLCAhMCkKICAgICAgICB9OwogICAgICB9CiAgICB9LAogICAgb2Zmc2V0UGFyZW50OiBmdW5jdGlvbiBvZmZzZXRQYXJlbnQoKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgZm9yICh2YXIgZSA9IHRoaXMub2Zmc2V0UGFyZW50OyBlICYmICFwZS5ub2RlTmFtZShlLCAiaHRtbCIpICYmICJzdGF0aWMiID09PSBwZS5jc3MoZSwgInBvc2l0aW9uIik7KSB7CiAgICAgICAgICBlID0gZS5vZmZzZXRQYXJlbnQ7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZSB8fCBwdDsKICAgICAgfSk7CiAgICB9CiAgfSksIHBlLmVhY2goewogICAgc2Nyb2xsTGVmdDogInBhZ2VYT2Zmc2V0IiwKICAgIHNjcm9sbFRvcDogInBhZ2VZT2Zmc2V0IgogIH0sIGZ1bmN0aW9uIChlLCB0KSB7CiAgICB2YXIgbiA9IC9ZLy50ZXN0KHQpOwoKICAgIHBlLmZuW2VdID0gZnVuY3Rpb24gKHIpIHsKICAgICAgcmV0dXJuIFBlKHRoaXMsIGZ1bmN0aW9uIChlLCByLCBpKSB7CiAgICAgICAgdmFyIG8gPSB0ZShlKTsKICAgICAgICByZXR1cm4gdm9pZCAwID09PSBpID8gbyA/IHQgaW4gbyA/IG9bdF0gOiBvLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFtyXSA6IGVbcl0gOiB2b2lkIChvID8gby5zY3JvbGxUbyhuID8gcGUobykuc2Nyb2xsTGVmdCgpIDogaSwgbiA/IGkgOiBwZShvKS5zY3JvbGxUb3AoKSkgOiBlW3JdID0gaSk7CiAgICAgIH0sIGUsIHIsIGFyZ3VtZW50cy5sZW5ndGgsIG51bGwpOwogICAgfTsKICB9KSwgcGUuZWFjaChbInRvcCIsICJsZWZ0Il0sIGZ1bmN0aW9uIChlLCB0KSB7CiAgICBwZS5jc3NIb29rc1t0XSA9IEwoZmUucGl4ZWxQb3NpdGlvbiwgZnVuY3Rpb24gKGUsIG4pIHsKICAgICAgaWYgKG4pIHJldHVybiBuID0gZ3QoZSwgdCksIGZ0LnRlc3QobikgPyBwZShlKS5wb3NpdGlvbigpW3RdICsgInB4IiA6IG47CiAgICB9KTsKICB9KSwgcGUuZWFjaCh7CiAgICBIZWlnaHQ6ICJoZWlnaHQiLAogICAgV2lkdGg6ICJ3aWR0aCIKICB9LCBmdW5jdGlvbiAoZSwgdCkgewogICAgcGUuZWFjaCh7CiAgICAgIHBhZGRpbmc6ICJpbm5lciIgKyBlLAogICAgICBjb250ZW50OiB0LAogICAgICAiIjogIm91dGVyIiArIGUKICAgIH0sIGZ1bmN0aW9uIChuLCByKSB7CiAgICAgIHBlLmZuW3JdID0gZnVuY3Rpb24gKHIsIGkpIHsKICAgICAgICB2YXIgbyA9IGFyZ3VtZW50cy5sZW5ndGggJiYgKG4gfHwgImJvb2xlYW4iICE9IHR5cGVvZiByKSwKICAgICAgICAgICAgYSA9IG4gfHwgKHIgPT09ICEwIHx8IGkgPT09ICEwID8gIm1hcmdpbiIgOiAiYm9yZGVyIik7CiAgICAgICAgcmV0dXJuIFBlKHRoaXMsIGZ1bmN0aW9uICh0LCBuLCByKSB7CiAgICAgICAgICB2YXIgaTsKICAgICAgICAgIHJldHVybiBwZS5pc1dpbmRvdyh0KSA/IHQuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WyJjbGllbnQiICsgZV0gOiA5ID09PSB0Lm5vZGVUeXBlID8gKGkgPSB0LmRvY3VtZW50RWxlbWVudCwgTWF0aC5tYXgodC5ib2R5WyJzY3JvbGwiICsgZV0sIGlbInNjcm9sbCIgKyBlXSwgdC5ib2R5WyJvZmZzZXQiICsgZV0sIGlbIm9mZnNldCIgKyBlXSwgaVsiY2xpZW50IiArIGVdKSkgOiB2b2lkIDAgPT09IHIgPyBwZS5jc3ModCwgbiwgYSkgOiBwZS5zdHlsZSh0LCBuLCByLCBhKTsKICAgICAgICB9LCB0LCBvID8gciA6IHZvaWQgMCwgbywgbnVsbCk7CiAgICAgIH07CiAgICB9KTsKICB9KSwgcGUuZm4uZXh0ZW5kKHsKICAgIGJpbmQ6IGZ1bmN0aW9uIGJpbmQoZSwgdCwgbikgewogICAgICByZXR1cm4gdGhpcy5vbihlLCBudWxsLCB0LCBuKTsKICAgIH0sCiAgICB1bmJpbmQ6IGZ1bmN0aW9uIHVuYmluZChlLCB0KSB7CiAgICAgIHJldHVybiB0aGlzLm9mZihlLCBudWxsLCB0KTsKICAgIH0sCiAgICBkZWxlZ2F0ZTogZnVuY3Rpb24gZGVsZWdhdGUoZSwgdCwgbiwgcikgewogICAgICByZXR1cm4gdGhpcy5vbih0LCBlLCBuLCByKTsKICAgIH0sCiAgICB1bmRlbGVnYXRlOiBmdW5jdGlvbiB1bmRlbGVnYXRlKGUsIHQsIG4pIHsKICAgICAgcmV0dXJuIDEgPT09IGFyZ3VtZW50cy5sZW5ndGggPyB0aGlzLm9mZihlLCAiKioiKSA6IHRoaXMub2ZmKHQsIGUgfHwgIioqIiwgbik7CiAgICB9CiAgfSksIHBlLmZuLnNpemUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5sZW5ndGg7CiAgfSwgcGUuZm4uYW5kU2VsZiA9IHBlLmZuLmFkZEJhY2ssIGxheXVpLmRlZmluZShmdW5jdGlvbiAoZSkgewogICAgbGF5dWkuJCA9IHBlLCBlKCJqcXVlcnkiLCBwZSk7CiAgfSksIHBlOwp9KTsKIWZ1bmN0aW9uIChlLCB0KSB7CiAgInVzZSBzdHJpY3QiOwoKICB2YXIgaSwKICAgICAgbiwKICAgICAgYSA9IGUubGF5dWkgJiYgbGF5dWkuZGVmaW5lLAogICAgICBvID0gewogICAgZ2V0UGF0aDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgdCA9IGRvY3VtZW50LmN1cnJlbnRTY3JpcHQgPyBkb2N1bWVudC5jdXJyZW50U2NyaXB0LnNyYyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICBmb3IgKHZhciBlLCB0ID0gZG9jdW1lbnQuc2NyaXB0cywgaSA9IHQubGVuZ3RoIC0gMSwgbiA9IGk7IG4gPiAwOyBuLS0pIHsKICAgICAgICAgIGlmICgiaW50ZXJhY3RpdmUiID09PSB0W25dLnJlYWR5U3RhdGUpIHsKICAgICAgICAgICAgZSA9IHRbbl0uc3JjOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBlIHx8IHRbaV0uc3JjOwogICAgICB9KCksCiAgICAgICAgICBpID0gZS5MQVlVSV9HTE9CQUwgfHwge307CiAgICAgIHJldHVybiBpLmxheWVyX2RpciB8fCB0LnN1YnN0cmluZygwLCB0Lmxhc3RJbmRleE9mKCIvIikgKyAxKTsKICAgIH0oKSwKICAgIGNvbmZpZzoge30sCiAgICBlbmQ6IHt9LAogICAgbWluSW5kZXg6IDAsCiAgICBtaW5MZWZ0OiBbXSwKICAgIGJ0bjogWyImI3g3ODZFOyYjeDVCOUE7IiwgIiYjeDUzRDY7JiN4NkQ4ODsiXSwKICAgIHR5cGU6IFsiZGlhbG9nIiwgInBhZ2UiLCAiaWZyYW1lIiwgImxvYWRpbmciLCAidGlwcyJdLAogICAgZ2V0U3R5bGU6IGZ1bmN0aW9uIGdldFN0eWxlKHQsIGkpIHsKICAgICAgdmFyIG4gPSB0LmN1cnJlbnRTdHlsZSA/IHQuY3VycmVudFN0eWxlIDogZS5nZXRDb21wdXRlZFN0eWxlKHQsIG51bGwpOwogICAgICByZXR1cm4gbltuLmdldFByb3BlcnR5VmFsdWUgPyAiZ2V0UHJvcGVydHlWYWx1ZSIgOiAiZ2V0QXR0cmlidXRlIl0oaSk7CiAgICB9LAogICAgbGluazogZnVuY3Rpb24gbGluayh0LCBpLCBuKSB7CiAgICAgIGlmIChyLnBhdGgpIHsKICAgICAgICB2YXIgYSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF0sCiAgICAgICAgICAgIHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaW5rIik7CiAgICAgICAgInN0cmluZyIgPT0gdHlwZW9mIGkgJiYgKG4gPSBpKTsKICAgICAgICB2YXIgbCA9IChuIHx8IHQpLnJlcGxhY2UoL1wufFwvL2csICIiKSwKICAgICAgICAgICAgZiA9ICJsYXl1aWNzcy0iICsgbCwKICAgICAgICAgICAgYyA9ICJjcmVhdGluZyIsCiAgICAgICAgICAgIHUgPSAwOwogICAgICAgIHMucmVsID0gInN0eWxlc2hlZXQiLCBzLmhyZWYgPSByLnBhdGggKyB0LCBzLmlkID0gZiwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZikgfHwgYS5hcHBlbmRDaGlsZChzKSwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgaSAmJiAhZnVuY3Rpb24gZCh0KSB7CiAgICAgICAgICB2YXIgbiA9IDEwMCwKICAgICAgICAgICAgICBhID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZik7CiAgICAgICAgICByZXR1cm4gKyt1ID4gMWU0IC8gbiA/IGUuY29uc29sZSAmJiBjb25zb2xlLmVycm9yKGwgKyAiLmNzczogSW52YWxpZCIpIDogdm9pZCAoMTk4OSA9PT0gcGFyc2VJbnQoby5nZXRTdHlsZShhLCAid2lkdGgiKSkgPyAodCA9PT0gYyAmJiBhLnJlbW92ZUF0dHJpYnV0ZSgibGF5LXN0YXR1cyIpLCBhLmdldEF0dHJpYnV0ZSgibGF5LXN0YXR1cyIpID09PSBjID8gc2V0VGltZW91dChkLCBuKSA6IGkoKSkgOiAoYS5zZXRBdHRyaWJ1dGUoImxheS1zdGF0dXMiLCBjKSwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGQoYyk7CiAgICAgICAgICB9LCBuKSkpOwogICAgICAgIH0oKTsKICAgICAgfQogICAgfQogIH0sCiAgICAgIHIgPSB7CiAgICB2OiAiMy41LjEiLAogICAgaWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7CiAgICAgIHJldHVybiAhIShlLkFjdGl2ZVhPYmplY3QgfHwgIkFjdGl2ZVhPYmplY3QiIGluIGUpICYmICgodC5tYXRjaCgvbXNpZVxzKFxkKykvKSB8fCBbXSlbMV0gfHwgIjExIik7CiAgICB9KCksCiAgICBpbmRleDogZS5sYXllciAmJiBlLmxheWVyLnYgPyAxZTUgOiAwLAogICAgcGF0aDogby5nZXRQYXRoLAogICAgY29uZmlnOiBmdW5jdGlvbiBjb25maWcoZSwgdCkgewogICAgICByZXR1cm4gZSA9IGUgfHwge30sIHIuY2FjaGUgPSBvLmNvbmZpZyA9IGkuZXh0ZW5kKHt9LCBvLmNvbmZpZywgZSksIHIucGF0aCA9IG8uY29uZmlnLnBhdGggfHwgci5wYXRoLCAic3RyaW5nIiA9PSB0eXBlb2YgZS5leHRlbmQgJiYgKGUuZXh0ZW5kID0gW2UuZXh0ZW5kXSksIG8uY29uZmlnLnBhdGggJiYgci5yZWFkeSgpLCBlLmV4dGVuZCA/IChhID8gbGF5dWkuYWRkY3NzKCJtb2R1bGVzL2xheWVyLyIgKyBlLmV4dGVuZCkgOiBvLmxpbmsoInRoZW1lLyIgKyBlLmV4dGVuZCksIHRoaXMpIDogdGhpczsKICAgIH0sCiAgICByZWFkeTogZnVuY3Rpb24gcmVhZHkoZSkgewogICAgICB2YXIgdCA9ICJsYXllciIsCiAgICAgICAgICBpID0gIiIsCiAgICAgICAgICBuID0gKGEgPyAibW9kdWxlcy9sYXllci8iIDogInRoZW1lLyIpICsgImRlZmF1bHQvbGF5ZXIuY3NzP3Y9IiArIHIudiArIGk7CiAgICAgIHJldHVybiBhID8gbGF5dWkuYWRkY3NzKG4sIGUsIHQpIDogby5saW5rKG4sIGUsIHQpLCB0aGlzOwogICAgfSwKICAgIGFsZXJ0OiBmdW5jdGlvbiBhbGVydChlLCB0LCBuKSB7CiAgICAgIHZhciBhID0gImZ1bmN0aW9uIiA9PSB0eXBlb2YgdDsKICAgICAgcmV0dXJuIGEgJiYgKG4gPSB0KSwgci5vcGVuKGkuZXh0ZW5kKHsKICAgICAgICBjb250ZW50OiBlLAogICAgICAgIHllczogbgogICAgICB9LCBhID8ge30gOiB0KSk7CiAgICB9LAogICAgY29uZmlybTogZnVuY3Rpb24gY29uZmlybShlLCB0LCBuLCBhKSB7CiAgICAgIHZhciBzID0gImZ1bmN0aW9uIiA9PSB0eXBlb2YgdDsKICAgICAgcmV0dXJuIHMgJiYgKGEgPSBuLCBuID0gdCksIHIub3BlbihpLmV4dGVuZCh7CiAgICAgICAgY29udGVudDogZSwKICAgICAgICBidG46IG8uYnRuLAogICAgICAgIHllczogbiwKICAgICAgICBidG4yOiBhCiAgICAgIH0sIHMgPyB7fSA6IHQpKTsKICAgIH0sCiAgICBtc2c6IGZ1bmN0aW9uIG1zZyhlLCBuLCBhKSB7CiAgICAgIHZhciBzID0gImZ1bmN0aW9uIiA9PSB0eXBlb2YgbiwKICAgICAgICAgIGYgPSBvLmNvbmZpZy5za2luLAogICAgICAgICAgYyA9IChmID8gZiArICIgIiArIGYgKyAiLW1zZyIgOiAiIikgfHwgImxheXVpLWxheWVyLW1zZyIsCiAgICAgICAgICB1ID0gbC5hbmltLmxlbmd0aCAtIDE7CiAgICAgIHJldHVybiBzICYmIChhID0gbiksIHIub3BlbihpLmV4dGVuZCh7CiAgICAgICAgY29udGVudDogZSwKICAgICAgICB0aW1lOiAzZTMsCiAgICAgICAgc2hhZGU6ICExLAogICAgICAgIHNraW46IGMsCiAgICAgICAgdGl0bGU6ICExLAogICAgICAgIGNsb3NlQnRuOiAhMSwKICAgICAgICBidG46ICExLAogICAgICAgIHJlc2l6ZTogITEsCiAgICAgICAgZW5kOiBhCiAgICAgIH0sIHMgJiYgIW8uY29uZmlnLnNraW4gPyB7CiAgICAgICAgc2tpbjogYyArICIgbGF5dWktbGF5ZXItaHVpIiwKICAgICAgICBhbmltOiB1CiAgICAgIH0gOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIG4gPSBuIHx8IHt9LCAobi5pY29uID09PSAtMSB8fCBuLmljb24gPT09IHQgJiYgIW8uY29uZmlnLnNraW4pICYmIChuLnNraW4gPSBjICsgIiAiICsgKG4uc2tpbiB8fCAibGF5dWktbGF5ZXItaHVpIikpLCBuOwogICAgICB9KCkpKTsKICAgIH0sCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKGUsIHQpIHsKICAgICAgcmV0dXJuIHIub3BlbihpLmV4dGVuZCh7CiAgICAgICAgdHlwZTogMywKICAgICAgICBpY29uOiBlIHx8IDAsCiAgICAgICAgcmVzaXplOiAhMSwKICAgICAgICBzaGFkZTogLjAxCiAgICAgIH0sIHQpKTsKICAgIH0sCiAgICB0aXBzOiBmdW5jdGlvbiB0aXBzKGUsIHQsIG4pIHsKICAgICAgcmV0dXJuIHIub3BlbihpLmV4dGVuZCh7CiAgICAgICAgdHlwZTogNCwKICAgICAgICBjb250ZW50OiBbZSwgdF0sCiAgICAgICAgY2xvc2VCdG46ICExLAogICAgICAgIHRpbWU6IDNlMywKICAgICAgICBzaGFkZTogITEsCiAgICAgICAgcmVzaXplOiAhMSwKICAgICAgICBmaXhlZDogITEsCiAgICAgICAgbWF4V2lkdGg6IDI2MAogICAgICB9LCBuKSk7CiAgICB9CiAgfSwKICAgICAgcyA9IGZ1bmN0aW9uIHMoZSkgewogICAgdmFyIHQgPSB0aGlzLAogICAgICAgIGEgPSBmdW5jdGlvbiBhKCkgewogICAgICB0LmNyZWF0KCk7CiAgICB9OwoKICAgIHQuaW5kZXggPSArK3IuaW5kZXgsIHQuY29uZmlnLm1heFdpZHRoID0gaShuKS53aWR0aCgpIC0gMzAsIHQuY29uZmlnID0gaS5leHRlbmQoe30sIHQuY29uZmlnLCBvLmNvbmZpZywgZSksIGRvY3VtZW50LmJvZHkgPyBhKCkgOiBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgYSgpOwogICAgfSwgMzApOwogIH07CgogIHMucHQgPSBzLnByb3RvdHlwZTsKICB2YXIgbCA9IFsibGF5dWktbGF5ZXIiLCAiLmxheXVpLWxheWVyLXRpdGxlIiwgIi5sYXl1aS1sYXllci1tYWluIiwgIi5sYXl1aS1sYXllci1kaWFsb2ciLCAibGF5dWktbGF5ZXItaWZyYW1lIiwgImxheXVpLWxheWVyLWNvbnRlbnQiLCAibGF5dWktbGF5ZXItYnRuIiwgImxheXVpLWxheWVyLWNsb3NlIl07CiAgbC5hbmltID0gWyJsYXllci1hbmltLTAwIiwgImxheWVyLWFuaW0tMDEiLCAibGF5ZXItYW5pbS0wMiIsICJsYXllci1hbmltLTAzIiwgImxheWVyLWFuaW0tMDQiLCAibGF5ZXItYW5pbS0wNSIsICJsYXllci1hbmltLTA2Il0sIGwuU0hBREUgPSAibGF5dWktbGF5ZXItc2hhZGUiLCBsLk1PVkUgPSAibGF5dWktbGF5ZXItbW92ZSIsIHMucHQuY29uZmlnID0gewogICAgdHlwZTogMCwKICAgIHNoYWRlOiAuMywKICAgIGZpeGVkOiAhMCwKICAgIG1vdmU6IGxbMV0sCiAgICB0aXRsZTogIiYjeDRGRTE7JiN4NjA2RjsiLAogICAgb2Zmc2V0OiAiYXV0byIsCiAgICBhcmVhOiAiYXV0byIsCiAgICBjbG9zZUJ0bjogMSwKICAgIHRpbWU6IDAsCiAgICB6SW5kZXg6IDE5ODkxMDE0LAogICAgbWF4V2lkdGg6IDM2MCwKICAgIGFuaW06IDAsCiAgICBpc091dEFuaW06ICEwLAogICAgbWluU3RhY2s6ICEwLAogICAgaWNvbjogLTEsCiAgICBtb3ZlVHlwZTogMSwKICAgIHJlc2l6ZTogITAsCiAgICBzY3JvbGxiYXI6ICEwLAogICAgdGlwczogMgogIH0sIHMucHQudmVzc2VsID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgIHZhciBuID0gdGhpcywKICAgICAgICBhID0gbi5pbmRleCwKICAgICAgICByID0gbi5jb25maWcsCiAgICAgICAgcyA9IHIuekluZGV4ICsgYSwKICAgICAgICBmID0gIm9iamVjdCIgPT0gX3R5cGVvZihyLnRpdGxlKSwKICAgICAgICBjID0gci5tYXhtaW4gJiYgKDEgPT09IHIudHlwZSB8fCAyID09PSByLnR5cGUpLAogICAgICAgIHUgPSByLnRpdGxlID8gJzxkaXYgY2xhc3M9ImxheXVpLWxheWVyLXRpdGxlIiBzdHlsZT0iJyArIChmID8gci50aXRsZVsxXSA6ICIiKSArICciPicgKyAoZiA/IHIudGl0bGVbMF0gOiByLnRpdGxlKSArICI8L2Rpdj4iIDogIiI7CgogICAgcmV0dXJuIHIuekluZGV4ID0gcywgdChbci5zaGFkZSA/ICc8ZGl2IGNsYXNzPSInICsgbC5TSEFERSArICciIGlkPSInICsgbC5TSEFERSArIGEgKyAnIiB0aW1lcz0iJyArIGEgKyAnIiBzdHlsZT0iJyArICgiei1pbmRleDoiICsgKHMgLSAxKSArICI7ICIpICsgJyI+PC9kaXY+JyA6ICIiLCAnPGRpdiBjbGFzcz0iJyArIGxbMF0gKyAoIiBsYXl1aS1sYXllci0iICsgby50eXBlW3IudHlwZV0pICsgKDAgIT0gci50eXBlICYmIDIgIT0gci50eXBlIHx8IHIuc2hhZGUgPyAiIiA6ICIgbGF5dWktbGF5ZXItYm9yZGVyIikgKyAiICIgKyAoci5za2luIHx8ICIiKSArICciIGlkPSInICsgbFswXSArIGEgKyAnIiB0eXBlPSInICsgby50eXBlW3IudHlwZV0gKyAnIiB0aW1lcz0iJyArIGEgKyAnIiBzaG93dGltZT0iJyArIHIudGltZSArICciIGNvblR5cGU9IicgKyAoZSA/ICJvYmplY3QiIDogInN0cmluZyIpICsgJyIgc3R5bGU9InotaW5kZXg6ICcgKyBzICsgIjsgd2lkdGg6IiArIHIuYXJlYVswXSArICI7aGVpZ2h0OiIgKyByLmFyZWFbMV0gKyAiO3Bvc2l0aW9uOiIgKyAoci5maXhlZCA/ICJmaXhlZDsiIDogImFic29sdXRlOyIpICsgJyI+JyArIChlICYmIDIgIT0gci50eXBlID8gIiIgOiB1KSArICc8ZGl2IGlkPSInICsgKHIuaWQgfHwgIiIpICsgJyIgY2xhc3M9ImxheXVpLWxheWVyLWNvbnRlbnQnICsgKDAgPT0gci50eXBlICYmIHIuaWNvbiAhPT0gLTEgPyAiIGxheXVpLWxheWVyLXBhZGRpbmciIDogIiIpICsgKDMgPT0gci50eXBlID8gIiBsYXl1aS1sYXllci1sb2FkaW5nIiArIHIuaWNvbiA6ICIiKSArICciPicgKyAoMCA9PSByLnR5cGUgJiYgci5pY29uICE9PSAtMSA/ICc8aSBjbGFzcz0ibGF5dWktbGF5ZXItaWNvIGxheXVpLWxheWVyLWljbycgKyByLmljb24gKyAnIj48L2k+JyA6ICIiKSArICgxID09IHIudHlwZSAmJiBlID8gIiIgOiByLmNvbnRlbnQgfHwgIiIpICsgJzwvZGl2PjxzcGFuIGNsYXNzPSJsYXl1aS1sYXllci1zZXR3aW4iPicgKyBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlID0gYyA/ICc8YSBjbGFzcz0ibGF5dWktbGF5ZXItbWluIiBocmVmPSJqYXZhc2NyaXB0OjsiPjxjaXRlPjwvY2l0ZT48L2E+PGEgY2xhc3M9ImxheXVpLWxheWVyLWljbyBsYXl1aS1sYXllci1tYXgiIGhyZWY9ImphdmFzY3JpcHQ6OyI+PC9hPicgOiAiIjsKICAgICAgcmV0dXJuIHIuY2xvc2VCdG4gJiYgKGUgKz0gJzxhIGNsYXNzPSJsYXl1aS1sYXllci1pY28gJyArIGxbN10gKyAiICIgKyBsWzddICsgKHIudGl0bGUgPyByLmNsb3NlQnRuIDogNCA9PSByLnR5cGUgPyAiMSIgOiAiMiIpICsgJyIgaHJlZj0iamF2YXNjcmlwdDo7Ij48L2E+JyksIGU7CiAgICB9KCkgKyAiPC9zcGFuPiIgKyAoci5idG4gPyBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlID0gIiI7CiAgICAgICJzdHJpbmciID09IHR5cGVvZiByLmJ0biAmJiAoci5idG4gPSBbci5idG5dKTsKCiAgICAgIGZvciAodmFyIHQgPSAwLCBpID0gci5idG4ubGVuZ3RoOyB0IDwgaTsgdCsrKSB7CiAgICAgICAgZSArPSAnPGEgY2xhc3M9IicgKyBsWzZdICsgdCArICciPicgKyByLmJ0blt0XSArICI8L2E+IjsKICAgICAgfQoKICAgICAgcmV0dXJuICc8ZGl2IGNsYXNzPSInICsgbFs2XSArICIgbGF5dWktbGF5ZXItYnRuLSIgKyAoci5idG5BbGlnbiB8fCAiIikgKyAnIj4nICsgZSArICI8L2Rpdj4iOwogICAgfSgpIDogIiIpICsgKHIucmVzaXplID8gJzxzcGFuIGNsYXNzPSJsYXl1aS1sYXllci1yZXNpemUiPjwvc3Bhbj4nIDogIiIpICsgIjwvZGl2PiJdLCB1LCBpKCc8ZGl2IGNsYXNzPSInICsgbC5NT1ZFICsgJyIgaWQ9IicgKyBsLk1PVkUgKyAnIj48L2Rpdj4nKSksIG47CiAgfSwgcy5wdC5jcmVhdCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICB0ID0gZS5jb25maWcsCiAgICAgICAgYSA9IGUuaW5kZXgsCiAgICAgICAgcyA9IHQuY29udGVudCwKICAgICAgICBmID0gIm9iamVjdCIgPT0gX3R5cGVvZihzKSwKICAgICAgICBjID0gaSgiYm9keSIpOwoKICAgIGlmICghdC5pZCB8fCAhaSgiIyIgKyB0LmlkKVswXSkgewogICAgICBzd2l0Y2ggKCJzdHJpbmciID09IHR5cGVvZiB0LmFyZWEgJiYgKHQuYXJlYSA9ICJhdXRvIiA9PT0gdC5hcmVhID8gWyIiLCAiIl0gOiBbdC5hcmVhLCAiIl0pLCB0LnNoaWZ0ICYmICh0LmFuaW0gPSB0LnNoaWZ0KSwgNiA9PSByLmllICYmICh0LmZpeGVkID0gITEpLCB0LnR5cGUpIHsKICAgICAgICBjYXNlIDA6CiAgICAgICAgICB0LmJ0biA9ICJidG4iIGluIHQgPyB0LmJ0biA6IG8uYnRuWzBdLCByLmNsb3NlQWxsKCJkaWFsb2ciKTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIDI6CiAgICAgICAgICB2YXIgcyA9IHQuY29udGVudCA9IGYgPyB0LmNvbnRlbnQgOiBbdC5jb250ZW50IHx8ICIiLCAiYXV0byJdOwogICAgICAgICAgdC5jb250ZW50ID0gJzxpZnJhbWUgc2Nyb2xsaW5nPSInICsgKHQuY29udGVudFsxXSB8fCAiYXV0byIpICsgJyIgYWxsb3d0cmFuc3BhcmVuY3k9InRydWUiIGlkPSInICsgbFs0XSArIGEgKyAnIiBuYW1lPSInICsgbFs0XSArIGEgKyAnIiBvbmxvYWQ9InRoaXMuY2xhc3NOYW1lPVwnXCc7IiBjbGFzcz0ibGF5dWktbGF5ZXItbG9hZCIgZnJhbWVib3JkZXI9IjAiIHNyYz0iJyArIHQuY29udGVudFswXSArICciPjwvaWZyYW1lPic7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAzOgogICAgICAgICAgZGVsZXRlIHQudGl0bGUsIGRlbGV0ZSB0LmNsb3NlQnRuLCB0Lmljb24gPT09IC0xICYmIDAgPT09IHQuaWNvbiwgci5jbG9zZUFsbCgibG9hZGluZyIpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgNDoKICAgICAgICAgIGYgfHwgKHQuY29udGVudCA9IFt0LmNvbnRlbnQsICJib2R5Il0pLCB0LmZvbGxvdyA9IHQuY29udGVudFsxXSwgdC5jb250ZW50ID0gdC5jb250ZW50WzBdICsgJzxpIGNsYXNzPSJsYXl1aS1sYXllci1UaXBzRyI+PC9pPicsIGRlbGV0ZSB0LnRpdGxlLCB0LnRpcHMgPSAib2JqZWN0IiA9PSBfdHlwZW9mKHQudGlwcykgPyB0LnRpcHMgOiBbdC50aXBzLCAhMF0sIHQudGlwc01vcmUgfHwgci5jbG9zZUFsbCgidGlwcyIpOwogICAgICB9CgogICAgICBpZiAoZS52ZXNzZWwoZiwgZnVuY3Rpb24gKG4sIHIsIHUpIHsKICAgICAgICBjLmFwcGVuZChuWzBdKSwgZiA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIDIgPT0gdC50eXBlIHx8IDQgPT0gdC50eXBlID8gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpKCJib2R5IikuYXBwZW5kKG5bMV0pOwogICAgICAgICAgfSgpIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzLnBhcmVudHMoIi4iICsgbFswXSlbMF0gfHwgKHMuZGF0YSgiZGlzcGxheSIsIHMuY3NzKCJkaXNwbGF5IikpLnNob3coKS5hZGRDbGFzcygibGF5dWktbGF5ZXItd3JhcCIpLndyYXAoblsxXSksIGkoIiMiICsgbFswXSArIGEpLmZpbmQoIi4iICsgbFs1XSkuYmVmb3JlKHIpKTsKICAgICAgICAgIH0oKTsKICAgICAgICB9KCkgOiBjLmFwcGVuZChuWzFdKSwgaSgiIyIgKyBsLk1PVkUpWzBdIHx8IGMuYXBwZW5kKG8ubW92ZUVsZW0gPSB1KSwgZS5sYXllcm8gPSBpKCIjIiArIGxbMF0gKyBhKSwgZS5zaGFkZW8gPSBpKCIjIiArIGwuU0hBREUgKyBhKSwgdC5zY3JvbGxiYXIgfHwgbC5odG1sLmNzcygib3ZlcmZsb3ciLCAiaGlkZGVuIikuYXR0cigibGF5ZXItZnVsbCIsIGEpOwogICAgICB9KS5hdXRvKGEpLCBlLnNoYWRlby5jc3MoewogICAgICAgICJiYWNrZ3JvdW5kLWNvbG9yIjogdC5zaGFkZVsxXSB8fCAiIzAwMCIsCiAgICAgICAgb3BhY2l0eTogdC5zaGFkZVswXSB8fCB0LnNoYWRlCiAgICAgIH0pLCAyID09IHQudHlwZSAmJiA2ID09IHIuaWUgJiYgZS5sYXllcm8uZmluZCgiaWZyYW1lIikuYXR0cigic3JjIiwgc1swXSksIDQgPT0gdC50eXBlID8gZS50aXBzKCkgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgZS5vZmZzZXQoKSwgcGFyc2VJbnQoby5nZXRTdHlsZShkb2N1bWVudC5nZXRFbGVtZW50QnlJZChsLk1PVkUpLCAiei1pbmRleCIpKSB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBlLmxheWVyby5jc3MoInZpc2liaWxpdHkiLCAiaGlkZGVuIiksIHIucmVhZHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBlLm9mZnNldCgpLCBlLmxheWVyby5jc3MoInZpc2liaWxpdHkiLCAidmlzaWJsZSIpOwogICAgICAgICAgfSk7CiAgICAgICAgfSgpOwogICAgICB9KCksIHQuZml4ZWQgJiYgbi5vbigicmVzaXplIiwgZnVuY3Rpb24gKCkgewogICAgICAgIGUub2Zmc2V0KCksICgvXlxkKyUkLy50ZXN0KHQuYXJlYVswXSkgfHwgL15cZCslJC8udGVzdCh0LmFyZWFbMV0pKSAmJiBlLmF1dG8oYSksIDQgPT0gdC50eXBlICYmIGUudGlwcygpOwogICAgICB9KSwgdC50aW1lIDw9IDAgfHwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgci5jbG9zZShlLmluZGV4KTsKICAgICAgfSwgdC50aW1lKSwgZS5tb3ZlKCkuY2FsbGJhY2soKSwgbC5hbmltW3QuYW5pbV0pIHsKICAgICAgICB2YXIgdSA9ICJsYXllci1hbmltICIgKyBsLmFuaW1bdC5hbmltXTsKICAgICAgICBlLmxheWVyby5hZGRDbGFzcyh1KS5vbmUoIndlYmtpdEFuaW1hdGlvbkVuZCBtb3pBbmltYXRpb25FbmQgTVNBbmltYXRpb25FbmQgb2FuaW1hdGlvbmVuZCBhbmltYXRpb25lbmQiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpKHRoaXMpLnJlbW92ZUNsYXNzKHUpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICB0LmlzT3V0QW5pbSAmJiBlLmxheWVyby5kYXRhKCJpc091dEFuaW0iLCAhMCk7CiAgICB9CiAgfSwgcy5wdC5hdXRvID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gdGhpcywKICAgICAgICBhID0gdC5jb25maWcsCiAgICAgICAgbyA9IGkoIiMiICsgbFswXSArIGUpOwogICAgIiIgPT09IGEuYXJlYVswXSAmJiBhLm1heFdpZHRoID4gMCAmJiAoci5pZSAmJiByLmllIDwgOCAmJiBhLmJ0biAmJiBvLndpZHRoKG8uaW5uZXJXaWR0aCgpKSwgby5vdXRlcldpZHRoKCkgPiBhLm1heFdpZHRoICYmIG8ud2lkdGgoYS5tYXhXaWR0aCkpOwoKICAgIHZhciBzID0gW28uaW5uZXJXaWR0aCgpLCBvLmlubmVySGVpZ2h0KCldLAogICAgICAgIGYgPSBvLmZpbmQobFsxXSkub3V0ZXJIZWlnaHQoKSB8fCAwLAogICAgICAgIGMgPSBvLmZpbmQoIi4iICsgbFs2XSkub3V0ZXJIZWlnaHQoKSB8fCAwLAogICAgICAgIHUgPSBmdW5jdGlvbiB1KGUpIHsKICAgICAgZSA9IG8uZmluZChlKSwgZS5oZWlnaHQoc1sxXSAtIGYgLSBjIC0gMiAqICgwIHwgcGFyc2VGbG9hdChlLmNzcygicGFkZGluZy10b3AiKSkpKTsKICAgIH07CgogICAgc3dpdGNoIChhLnR5cGUpIHsKICAgICAgY2FzZSAyOgogICAgICAgIHUoImlmcmFtZSIpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICAiIiA9PT0gYS5hcmVhWzFdID8gYS5tYXhIZWlnaHQgPiAwICYmIG8ub3V0ZXJIZWlnaHQoKSA+IGEubWF4SGVpZ2h0ID8gKHNbMV0gPSBhLm1heEhlaWdodCwgdSgiLiIgKyBsWzVdKSkgOiBhLmZpeGVkICYmIHNbMV0gPj0gbi5oZWlnaHQoKSAmJiAoc1sxXSA9IG4uaGVpZ2h0KCksIHUoIi4iICsgbFs1XSkpIDogdSgiLiIgKyBsWzVdKTsKICAgIH0KCiAgICByZXR1cm4gdDsKICB9LCBzLnB0Lm9mZnNldCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICB0ID0gZS5jb25maWcsCiAgICAgICAgaSA9IGUubGF5ZXJvLAogICAgICAgIGEgPSBbaS5vdXRlcldpZHRoKCksIGkub3V0ZXJIZWlnaHQoKV0sCiAgICAgICAgbyA9ICJvYmplY3QiID09IF90eXBlb2YodC5vZmZzZXQpOwoKICAgIGUub2Zmc2V0VG9wID0gKG4uaGVpZ2h0KCkgLSBhWzFdKSAvIDIsIGUub2Zmc2V0TGVmdCA9IChuLndpZHRoKCkgLSBhWzBdKSAvIDIsIG8gPyAoZS5vZmZzZXRUb3AgPSB0Lm9mZnNldFswXSwgZS5vZmZzZXRMZWZ0ID0gdC5vZmZzZXRbMV0gfHwgZS5vZmZzZXRMZWZ0KSA6ICJhdXRvIiAhPT0gdC5vZmZzZXQgJiYgKCJ0IiA9PT0gdC5vZmZzZXQgPyBlLm9mZnNldFRvcCA9IDAgOiAiciIgPT09IHQub2Zmc2V0ID8gZS5vZmZzZXRMZWZ0ID0gbi53aWR0aCgpIC0gYVswXSA6ICJiIiA9PT0gdC5vZmZzZXQgPyBlLm9mZnNldFRvcCA9IG4uaGVpZ2h0KCkgLSBhWzFdIDogImwiID09PSB0Lm9mZnNldCA/IGUub2Zmc2V0TGVmdCA9IDAgOiAibHQiID09PSB0Lm9mZnNldCA/IChlLm9mZnNldFRvcCA9IDAsIGUub2Zmc2V0TGVmdCA9IDApIDogImxiIiA9PT0gdC5vZmZzZXQgPyAoZS5vZmZzZXRUb3AgPSBuLmhlaWdodCgpIC0gYVsxXSwgZS5vZmZzZXRMZWZ0ID0gMCkgOiAicnQiID09PSB0Lm9mZnNldCA/IChlLm9mZnNldFRvcCA9IDAsIGUub2Zmc2V0TGVmdCA9IG4ud2lkdGgoKSAtIGFbMF0pIDogInJiIiA9PT0gdC5vZmZzZXQgPyAoZS5vZmZzZXRUb3AgPSBuLmhlaWdodCgpIC0gYVsxXSwgZS5vZmZzZXRMZWZ0ID0gbi53aWR0aCgpIC0gYVswXSkgOiBlLm9mZnNldFRvcCA9IHQub2Zmc2V0KSwgdC5maXhlZCB8fCAoZS5vZmZzZXRUb3AgPSAvJSQvLnRlc3QoZS5vZmZzZXRUb3ApID8gbi5oZWlnaHQoKSAqIHBhcnNlRmxvYXQoZS5vZmZzZXRUb3ApIC8gMTAwIDogcGFyc2VGbG9hdChlLm9mZnNldFRvcCksIGUub2Zmc2V0TGVmdCA9IC8lJC8udGVzdChlLm9mZnNldExlZnQpID8gbi53aWR0aCgpICogcGFyc2VGbG9hdChlLm9mZnNldExlZnQpIC8gMTAwIDogcGFyc2VGbG9hdChlLm9mZnNldExlZnQpLCBlLm9mZnNldFRvcCArPSBuLnNjcm9sbFRvcCgpLCBlLm9mZnNldExlZnQgKz0gbi5zY3JvbGxMZWZ0KCkpLCBpLmF0dHIoIm1pbkxlZnQiKSAmJiAoZS5vZmZzZXRUb3AgPSBuLmhlaWdodCgpIC0gKGkuZmluZChsWzFdKS5vdXRlckhlaWdodCgpIHx8IDApLCBlLm9mZnNldExlZnQgPSBpLmNzcygibGVmdCIpKSwgaS5jc3MoewogICAgICB0b3A6IGUub2Zmc2V0VG9wLAogICAgICBsZWZ0OiBlLm9mZnNldExlZnQKICAgIH0pOwogIH0sIHMucHQudGlwcyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICB0ID0gZS5jb25maWcsCiAgICAgICAgYSA9IGUubGF5ZXJvLAogICAgICAgIG8gPSBbYS5vdXRlcldpZHRoKCksIGEub3V0ZXJIZWlnaHQoKV0sCiAgICAgICAgciA9IGkodC5mb2xsb3cpOwogICAgclswXSB8fCAociA9IGkoImJvZHkiKSk7CiAgICB2YXIgcyA9IHsKICAgICAgd2lkdGg6IHIub3V0ZXJXaWR0aCgpLAogICAgICBoZWlnaHQ6IHIub3V0ZXJIZWlnaHQoKSwKICAgICAgdG9wOiByLm9mZnNldCgpLnRvcCwKICAgICAgbGVmdDogci5vZmZzZXQoKS5sZWZ0CiAgICB9LAogICAgICAgIGYgPSBhLmZpbmQoIi5sYXl1aS1sYXllci1UaXBzRyIpLAogICAgICAgIGMgPSB0LnRpcHNbMF07CiAgICB0LnRpcHNbMV0gfHwgZi5yZW1vdmUoKSwgcy5hdXRvTGVmdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgcy5sZWZ0ICsgb1swXSAtIG4ud2lkdGgoKSA+IDAgPyAocy50aXBMZWZ0ID0gcy5sZWZ0ICsgcy53aWR0aCAtIG9bMF0sIGYuY3NzKHsKICAgICAgICByaWdodDogMTIsCiAgICAgICAgbGVmdDogImF1dG8iCiAgICAgIH0pKSA6IHMudGlwTGVmdCA9IHMubGVmdDsKICAgIH0sIHMud2hlcmUgPSBbZnVuY3Rpb24gKCkgewogICAgICBzLmF1dG9MZWZ0KCksIHMudGlwVG9wID0gcy50b3AgLSBvWzFdIC0gMTAsIGYucmVtb3ZlQ2xhc3MoImxheXVpLWxheWVyLVRpcHNCIikuYWRkQ2xhc3MoImxheXVpLWxheWVyLVRpcHNUIikuY3NzKCJib3JkZXItcmlnaHQtY29sb3IiLCB0LnRpcHNbMV0pOwogICAgfSwgZnVuY3Rpb24gKCkgewogICAgICBzLnRpcExlZnQgPSBzLmxlZnQgKyBzLndpZHRoICsgMTAsIHMudGlwVG9wID0gcy50b3AsIGYucmVtb3ZlQ2xhc3MoImxheXVpLWxheWVyLVRpcHNMIikuYWRkQ2xhc3MoImxheXVpLWxheWVyLVRpcHNSIikuY3NzKCJib3JkZXItYm90dG9tLWNvbG9yIiwgdC50aXBzWzFdKTsKICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgcy5hdXRvTGVmdCgpLCBzLnRpcFRvcCA9IHMudG9wICsgcy5oZWlnaHQgKyAxMCwgZi5yZW1vdmVDbGFzcygibGF5dWktbGF5ZXItVGlwc1QiKS5hZGRDbGFzcygibGF5dWktbGF5ZXItVGlwc0IiKS5jc3MoImJvcmRlci1yaWdodC1jb2xvciIsIHQudGlwc1sxXSk7CiAgICB9LCBmdW5jdGlvbiAoKSB7CiAgICAgIHMudGlwTGVmdCA9IHMubGVmdCAtIG9bMF0gLSAxMCwgcy50aXBUb3AgPSBzLnRvcCwgZi5yZW1vdmVDbGFzcygibGF5dWktbGF5ZXItVGlwc1IiKS5hZGRDbGFzcygibGF5dWktbGF5ZXItVGlwc0wiKS5jc3MoImJvcmRlci1ib3R0b20tY29sb3IiLCB0LnRpcHNbMV0pOwogICAgfV0sIHMud2hlcmVbYyAtIDFdKCksIDEgPT09IGMgPyBzLnRvcCAtIChuLnNjcm9sbFRvcCgpICsgb1sxXSArIDE2KSA8IDAgJiYgcy53aGVyZVsyXSgpIDogMiA9PT0gYyA/IG4ud2lkdGgoKSAtIChzLmxlZnQgKyBzLndpZHRoICsgb1swXSArIDE2KSA+IDAgfHwgcy53aGVyZVszXSgpIDogMyA9PT0gYyA/IHMudG9wIC0gbi5zY3JvbGxUb3AoKSArIHMuaGVpZ2h0ICsgb1sxXSArIDE2IC0gbi5oZWlnaHQoKSA+IDAgJiYgcy53aGVyZVswXSgpIDogNCA9PT0gYyAmJiBvWzBdICsgMTYgLSBzLmxlZnQgPiAwICYmIHMud2hlcmVbMV0oKSwgYS5maW5kKCIuIiArIGxbNV0pLmNzcyh7CiAgICAgICJiYWNrZ3JvdW5kLWNvbG9yIjogdC50aXBzWzFdLAogICAgICAicGFkZGluZy1yaWdodCI6IHQuY2xvc2VCdG4gPyAiMzBweCIgOiAiIgogICAgfSksIGEuY3NzKHsKICAgICAgbGVmdDogcy50aXBMZWZ0IC0gKHQuZml4ZWQgPyBuLnNjcm9sbExlZnQoKSA6IDApLAogICAgICB0b3A6IHMudGlwVG9wIC0gKHQuZml4ZWQgPyBuLnNjcm9sbFRvcCgpIDogMCkKICAgIH0pOwogIH0sIHMucHQubW92ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICB0ID0gZS5jb25maWcsCiAgICAgICAgYSA9IGkoZG9jdW1lbnQpLAogICAgICAgIHMgPSBlLmxheWVybywKICAgICAgICBsID0gcy5maW5kKHQubW92ZSksCiAgICAgICAgZiA9IHMuZmluZCgiLmxheXVpLWxheWVyLXJlc2l6ZSIpLAogICAgICAgIGMgPSB7fTsKICAgIHJldHVybiB0Lm1vdmUgJiYgbC5jc3MoImN1cnNvciIsICJtb3ZlIiksIGwub24oIm1vdXNlZG93biIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIGUucHJldmVudERlZmF1bHQoKSwgdC5tb3ZlICYmIChjLm1vdmVTdGFydCA9ICEwLCBjLm9mZnNldCA9IFtlLmNsaWVudFggLSBwYXJzZUZsb2F0KHMuY3NzKCJsZWZ0IikpLCBlLmNsaWVudFkgLSBwYXJzZUZsb2F0KHMuY3NzKCJ0b3AiKSldLCBvLm1vdmVFbGVtLmNzcygiY3Vyc29yIiwgIm1vdmUiKS5zaG93KCkpOwogICAgfSksIGYub24oIm1vdXNlZG93biIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIGUucHJldmVudERlZmF1bHQoKSwgYy5yZXNpemVTdGFydCA9ICEwLCBjLm9mZnNldCA9IFtlLmNsaWVudFgsIGUuY2xpZW50WV0sIGMuYXJlYSA9IFtzLm91dGVyV2lkdGgoKSwgcy5vdXRlckhlaWdodCgpXSwgby5tb3ZlRWxlbS5jc3MoImN1cnNvciIsICJzZS1yZXNpemUiKS5zaG93KCk7CiAgICB9KSwgYS5vbigibW91c2Vtb3ZlIiwgZnVuY3Rpb24gKGkpIHsKICAgICAgaWYgKGMubW92ZVN0YXJ0KSB7CiAgICAgICAgdmFyIGEgPSBpLmNsaWVudFggLSBjLm9mZnNldFswXSwKICAgICAgICAgICAgbyA9IGkuY2xpZW50WSAtIGMub2Zmc2V0WzFdLAogICAgICAgICAgICBsID0gImZpeGVkIiA9PT0gcy5jc3MoInBvc2l0aW9uIik7CgogICAgICAgIGlmIChpLnByZXZlbnREZWZhdWx0KCksIGMuc3RYID0gbCA/IDAgOiBuLnNjcm9sbExlZnQoKSwgYy5zdFkgPSBsID8gMCA6IG4uc2Nyb2xsVG9wKCksICF0Lm1vdmVPdXQpIHsKICAgICAgICAgIHZhciBmID0gbi53aWR0aCgpIC0gcy5vdXRlcldpZHRoKCkgKyBjLnN0WCwKICAgICAgICAgICAgICB1ID0gbi5oZWlnaHQoKSAtIHMub3V0ZXJIZWlnaHQoKSArIGMuc3RZOwogICAgICAgICAgYSA8IGMuc3RYICYmIChhID0gYy5zdFgpLCBhID4gZiAmJiAoYSA9IGYpLCBvIDwgYy5zdFkgJiYgKG8gPSBjLnN0WSksIG8gPiB1ICYmIChvID0gdSk7CiAgICAgICAgfQoKICAgICAgICBzLmNzcyh7CiAgICAgICAgICBsZWZ0OiBhLAogICAgICAgICAgdG9wOiBvCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmICh0LnJlc2l6ZSAmJiBjLnJlc2l6ZVN0YXJ0KSB7CiAgICAgICAgdmFyIGEgPSBpLmNsaWVudFggLSBjLm9mZnNldFswXSwKICAgICAgICAgICAgbyA9IGkuY2xpZW50WSAtIGMub2Zmc2V0WzFdOwogICAgICAgIGkucHJldmVudERlZmF1bHQoKSwgci5zdHlsZShlLmluZGV4LCB7CiAgICAgICAgICB3aWR0aDogYy5hcmVhWzBdICsgYSwKICAgICAgICAgIGhlaWdodDogYy5hcmVhWzFdICsgbwogICAgICAgIH0pLCBjLmlzUmVzaXplID0gITAsIHQucmVzaXppbmcgJiYgdC5yZXNpemluZyhzKTsKICAgICAgfQogICAgfSkub24oIm1vdXNldXAiLCBmdW5jdGlvbiAoZSkgewogICAgICBjLm1vdmVTdGFydCAmJiAoZGVsZXRlIGMubW92ZVN0YXJ0LCBvLm1vdmVFbGVtLmhpZGUoKSwgdC5tb3ZlRW5kICYmIHQubW92ZUVuZChzKSksIGMucmVzaXplU3RhcnQgJiYgKGRlbGV0ZSBjLnJlc2l6ZVN0YXJ0LCBvLm1vdmVFbGVtLmhpZGUoKSk7CiAgICB9KSwgZTsKICB9LCBzLnB0LmNhbGxiYWNrID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gZSgpIHsKICAgICAgdmFyIGUgPSBhLmNhbmNlbCAmJiBhLmNhbmNlbCh0LmluZGV4LCBuKTsKICAgICAgZSA9PT0gITEgfHwgci5jbG9zZSh0LmluZGV4KTsKICAgIH0KCiAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgbiA9IHQubGF5ZXJvLAogICAgICAgIGEgPSB0LmNvbmZpZzsKICAgIHQub3BlbkxheWVyKCksIGEuc3VjY2VzcyAmJiAoMiA9PSBhLnR5cGUgPyBuLmZpbmQoImlmcmFtZSIpLm9uKCJsb2FkIiwgZnVuY3Rpb24gKCkgewogICAgICBhLnN1Y2Nlc3MobiwgdC5pbmRleCwgdCk7CiAgICB9KSA6IGEuc3VjY2VzcyhuLCB0LmluZGV4LCB0KSksIDYgPT0gci5pZSAmJiB0LklFNihuKSwgbi5maW5kKCIuIiArIGxbNl0pLmNoaWxkcmVuKCJhIikub24oImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IGkodGhpcykuaW5kZXgoKTsKICAgICAgaWYgKDAgPT09IGUpIGEueWVzID8gYS55ZXModC5pbmRleCwgbikgOiBhLmJ0bjEgPyBhLmJ0bjEodC5pbmRleCwgbikgOiByLmNsb3NlKHQuaW5kZXgpO2Vsc2UgewogICAgICAgIHZhciBvID0gYVsiYnRuIiArIChlICsgMSldICYmIGFbImJ0biIgKyAoZSArIDEpXSh0LmluZGV4LCBuKTsKICAgICAgICBvID09PSAhMSB8fCByLmNsb3NlKHQuaW5kZXgpOwogICAgICB9CiAgICB9KSwgbi5maW5kKCIuIiArIGxbN10pLm9uKCJjbGljayIsIGUpLCBhLnNoYWRlQ2xvc2UgJiYgdC5zaGFkZW8ub24oImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICByLmNsb3NlKHQuaW5kZXgpOwogICAgfSksIG4uZmluZCgiLmxheXVpLWxheWVyLW1pbiIpLm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSBhLm1pbiAmJiBhLm1pbihuLCB0LmluZGV4KTsKICAgICAgZSA9PT0gITEgfHwgci5taW4odC5pbmRleCwgYSk7CiAgICB9KSwgbi5maW5kKCIubGF5dWktbGF5ZXItbWF4Iikub24oImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICBpKHRoaXMpLmhhc0NsYXNzKCJsYXl1aS1sYXllci1tYXhtaW4iKSA/IChyLnJlc3RvcmUodC5pbmRleCksIGEucmVzdG9yZSAmJiBhLnJlc3RvcmUobiwgdC5pbmRleCkpIDogKHIuZnVsbCh0LmluZGV4LCBhKSwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgYS5mdWxsICYmIGEuZnVsbChuLCB0LmluZGV4KTsKICAgICAgfSwgMTAwKSk7CiAgICB9KSwgYS5lbmQgJiYgKG8uZW5kW3QuaW5kZXhdID0gYS5lbmQpOwogIH0sIG8ucmVzZWxlY3QgPSBmdW5jdGlvbiAoKSB7CiAgICBpLmVhY2goaSgic2VsZWN0IiksIGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgIHZhciBuID0gaSh0aGlzKTsKICAgICAgbi5wYXJlbnRzKCIuIiArIGxbMF0pWzBdIHx8IDEgPT0gbi5hdHRyKCJsYXllciIpICYmIGkoIi4iICsgbFswXSkubGVuZ3RoIDwgMSAmJiBuLnJlbW92ZUF0dHIoImxheWVyIikuc2hvdygpLCBuID0gbnVsbDsKICAgIH0pOwogIH0sIHMucHQuSUU2ID0gZnVuY3Rpb24gKGUpIHsKICAgIGkoInNlbGVjdCIpLmVhY2goZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgdmFyIG4gPSBpKHRoaXMpOwogICAgICBuLnBhcmVudHMoIi4iICsgbFswXSlbMF0gfHwgIm5vbmUiID09PSBuLmNzcygiZGlzcGxheSIpIHx8IG4uYXR0cih7CiAgICAgICAgbGF5ZXI6ICIxIgogICAgICB9KS5oaWRlKCksIG4gPSBudWxsOwogICAgfSk7CiAgfSwgcy5wdC5vcGVuTGF5ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXM7CiAgICByLnpJbmRleCA9IGUuY29uZmlnLnpJbmRleCwgci5zZXRUb3AgPSBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgdCA9IGZ1bmN0aW9uIHQoKSB7CiAgICAgICAgci56SW5kZXgrKywgZS5jc3MoInotaW5kZXgiLCByLnpJbmRleCArIDEpOwogICAgICB9OwoKICAgICAgcmV0dXJuIHIuekluZGV4ID0gcGFyc2VJbnQoZVswXS5zdHlsZS56SW5kZXgpLCBlLm9uKCJtb3VzZWRvd24iLCB0KSwgci56SW5kZXg7CiAgICB9OwogIH0sIG8ucmVjb3JkID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gW2Uud2lkdGgoKSwgZS5oZWlnaHQoKSwgZS5wb3NpdGlvbigpLnRvcCwgZS5wb3NpdGlvbigpLmxlZnQgKyBwYXJzZUZsb2F0KGUuY3NzKCJtYXJnaW4tbGVmdCIpKV07CiAgICBlLmZpbmQoIi5sYXl1aS1sYXllci1tYXgiKS5hZGRDbGFzcygibGF5dWktbGF5ZXItbWF4bWluIiksIGUuYXR0cih7CiAgICAgIGFyZWE6IHQKICAgIH0pOwogIH0sIG8ucmVzY29sbGJhciA9IGZ1bmN0aW9uIChlKSB7CiAgICBsLmh0bWwuYXR0cigibGF5ZXItZnVsbCIpID09IGUgJiYgKGwuaHRtbFswXS5zdHlsZS5yZW1vdmVQcm9wZXJ0eSA/IGwuaHRtbFswXS5zdHlsZS5yZW1vdmVQcm9wZXJ0eSgib3ZlcmZsb3ciKSA6IGwuaHRtbFswXS5zdHlsZS5yZW1vdmVBdHRyaWJ1dGUoIm92ZXJmbG93IiksIGwuaHRtbC5yZW1vdmVBdHRyKCJsYXllci1mdWxsIikpOwogIH0sIGUubGF5ZXIgPSByLCByLmdldENoaWxkRnJhbWUgPSBmdW5jdGlvbiAoZSwgdCkgewogICAgcmV0dXJuIHQgPSB0IHx8IGkoIi4iICsgbFs0XSkuYXR0cigidGltZXMiKSwgaSgiIyIgKyBsWzBdICsgdCkuZmluZCgiaWZyYW1lIikuY29udGVudHMoKS5maW5kKGUpOwogIH0sIHIuZ2V0RnJhbWVJbmRleCA9IGZ1bmN0aW9uIChlKSB7CiAgICByZXR1cm4gaSgiIyIgKyBlKS5wYXJlbnRzKCIuIiArIGxbNF0pLmF0dHIoInRpbWVzIik7CiAgfSwgci5pZnJhbWVBdXRvID0gZnVuY3Rpb24gKGUpIHsKICAgIGlmIChlKSB7CiAgICAgIHZhciB0ID0gci5nZXRDaGlsZEZyYW1lKCJodG1sIiwgZSkub3V0ZXJIZWlnaHQoKSwKICAgICAgICAgIG4gPSBpKCIjIiArIGxbMF0gKyBlKSwKICAgICAgICAgIGEgPSBuLmZpbmQobFsxXSkub3V0ZXJIZWlnaHQoKSB8fCAwLAogICAgICAgICAgbyA9IG4uZmluZCgiLiIgKyBsWzZdKS5vdXRlckhlaWdodCgpIHx8IDA7CiAgICAgIG4uY3NzKHsKICAgICAgICBoZWlnaHQ6IHQgKyBhICsgbwogICAgICB9KSwgbi5maW5kKCJpZnJhbWUiKS5jc3MoewogICAgICAgIGhlaWdodDogdAogICAgICB9KTsKICAgIH0KICB9LCByLmlmcmFtZVNyYyA9IGZ1bmN0aW9uIChlLCB0KSB7CiAgICBpKCIjIiArIGxbMF0gKyBlKS5maW5kKCJpZnJhbWUiKS5hdHRyKCJzcmMiLCB0KTsKICB9LCByLnN0eWxlID0gZnVuY3Rpb24gKGUsIHQsIG4pIHsKICAgIHZhciBhID0gaSgiIyIgKyBsWzBdICsgZSksCiAgICAgICAgciA9IGEuZmluZCgiLmxheXVpLWxheWVyLWNvbnRlbnQiKSwKICAgICAgICBzID0gYS5hdHRyKCJ0eXBlIiksCiAgICAgICAgZiA9IGEuZmluZChsWzFdKS5vdXRlckhlaWdodCgpIHx8IDAsCiAgICAgICAgYyA9IGEuZmluZCgiLiIgKyBsWzZdKS5vdXRlckhlaWdodCgpIHx8IDA7CiAgICBhLmF0dHIoIm1pbkxlZnQiKTsKICAgIHMgIT09IG8udHlwZVszXSAmJiBzICE9PSBvLnR5cGVbNF0gJiYgKG4gfHwgKHBhcnNlRmxvYXQodC53aWR0aCkgPD0gMjYwICYmICh0LndpZHRoID0gMjYwKSwgcGFyc2VGbG9hdCh0LmhlaWdodCkgLSBmIC0gYyA8PSA2NCAmJiAodC5oZWlnaHQgPSA2NCArIGYgKyBjKSksIGEuY3NzKHQpLCBjID0gYS5maW5kKCIuIiArIGxbNl0pLm91dGVySGVpZ2h0KCksIHMgPT09IG8udHlwZVsyXSA/IGEuZmluZCgiaWZyYW1lIikuY3NzKHsKICAgICAgaGVpZ2h0OiBwYXJzZUZsb2F0KHQuaGVpZ2h0KSAtIGYgLSBjCiAgICB9KSA6IHIuY3NzKHsKICAgICAgaGVpZ2h0OiBwYXJzZUZsb2F0KHQuaGVpZ2h0KSAtIGYgLSBjIC0gcGFyc2VGbG9hdChyLmNzcygicGFkZGluZy10b3AiKSkgLSBwYXJzZUZsb2F0KHIuY3NzKCJwYWRkaW5nLWJvdHRvbSIpKQogICAgfSkpOwogIH0sIHIubWluID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgIHQgPSB0IHx8IHt9OwogICAgdmFyIGEgPSBpKCIjIiArIGxbMF0gKyBlKSwKICAgICAgICBzID0gaSgiIyIgKyBsLlNIQURFICsgZSksCiAgICAgICAgZiA9IGEuZmluZChsWzFdKS5vdXRlckhlaWdodCgpIHx8IDAsCiAgICAgICAgYyA9IGEuYXR0cigibWluTGVmdCIpIHx8IDE4MSAqIG8ubWluSW5kZXggKyAicHgiLAogICAgICAgIHUgPSBhLmNzcygicG9zaXRpb24iKSwKICAgICAgICBkID0gewogICAgICB3aWR0aDogMTgwLAogICAgICBoZWlnaHQ6IGYsCiAgICAgIHBvc2l0aW9uOiAiZml4ZWQiLAogICAgICBvdmVyZmxvdzogImhpZGRlbiIKICAgIH07CiAgICBvLnJlY29yZChhKSwgby5taW5MZWZ0WzBdICYmIChjID0gby5taW5MZWZ0WzBdLCBvLm1pbkxlZnQuc2hpZnQoKSksIHQubWluU3RhY2sgJiYgKGQubGVmdCA9IGMsIGQudG9wID0gbi5oZWlnaHQoKSAtIGYsIGEuYXR0cigibWluTGVmdCIpIHx8IG8ubWluSW5kZXgrKywgYS5hdHRyKCJtaW5MZWZ0IiwgYykpLCBhLmF0dHIoInBvc2l0aW9uIiwgdSksIHIuc3R5bGUoZSwgZCwgITApLCBhLmZpbmQoIi5sYXl1aS1sYXllci1taW4iKS5oaWRlKCksICJwYWdlIiA9PT0gYS5hdHRyKCJ0eXBlIikgJiYgYS5maW5kKGxbNF0pLmhpZGUoKSwgby5yZXNjb2xsYmFyKGUpLCBzLmhpZGUoKTsKICB9LCByLnJlc3RvcmUgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSBpKCIjIiArIGxbMF0gKyBlKSwKICAgICAgICBuID0gaSgiIyIgKyBsLlNIQURFICsgZSksCiAgICAgICAgYSA9IHQuYXR0cigiYXJlYSIpLnNwbGl0KCIsIik7CiAgICB0LmF0dHIoInR5cGUiKTsKICAgIHIuc3R5bGUoZSwgewogICAgICB3aWR0aDogcGFyc2VGbG9hdChhWzBdKSwKICAgICAgaGVpZ2h0OiBwYXJzZUZsb2F0KGFbMV0pLAogICAgICB0b3A6IHBhcnNlRmxvYXQoYVsyXSksCiAgICAgIGxlZnQ6IHBhcnNlRmxvYXQoYVszXSksCiAgICAgIHBvc2l0aW9uOiB0LmF0dHIoInBvc2l0aW9uIiksCiAgICAgIG92ZXJmbG93OiAidmlzaWJsZSIKICAgIH0sICEwKSwgdC5maW5kKCIubGF5dWktbGF5ZXItbWF4IikucmVtb3ZlQ2xhc3MoImxheXVpLWxheWVyLW1heG1pbiIpLCB0LmZpbmQoIi5sYXl1aS1sYXllci1taW4iKS5zaG93KCksICJwYWdlIiA9PT0gdC5hdHRyKCJ0eXBlIikgJiYgdC5maW5kKGxbNF0pLnNob3coKSwgby5yZXNjb2xsYmFyKGUpLCBuLnNob3coKTsKICB9LCByLmZ1bGwgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQsCiAgICAgICAgYSA9IGkoIiMiICsgbFswXSArIGUpOwogICAgby5yZWNvcmQoYSksIGwuaHRtbC5hdHRyKCJsYXllci1mdWxsIikgfHwgbC5odG1sLmNzcygib3ZlcmZsb3ciLCAiaGlkZGVuIikuYXR0cigibGF5ZXItZnVsbCIsIGUpLCBjbGVhclRpbWVvdXQodCksIHQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHQgPSAiZml4ZWQiID09PSBhLmNzcygicG9zaXRpb24iKTsKICAgICAgci5zdHlsZShlLCB7CiAgICAgICAgdG9wOiB0ID8gMCA6IG4uc2Nyb2xsVG9wKCksCiAgICAgICAgbGVmdDogdCA/IDAgOiBuLnNjcm9sbExlZnQoKSwKICAgICAgICB3aWR0aDogbi53aWR0aCgpLAogICAgICAgIGhlaWdodDogbi5oZWlnaHQoKQogICAgICB9LCAhMCksIGEuZmluZCgiLmxheXVpLWxheWVyLW1pbiIpLmhpZGUoKTsKICAgIH0sIDEwMCk7CiAgfSwgci50aXRsZSA9IGZ1bmN0aW9uIChlLCB0KSB7CiAgICB2YXIgbiA9IGkoIiMiICsgbFswXSArICh0IHx8IHIuaW5kZXgpKS5maW5kKGxbMV0pOwogICAgbi5odG1sKGUpOwogIH0sIHIuY2xvc2UgPSBmdW5jdGlvbiAoZSwgdCkgewogICAgdmFyIG4gPSBpKCIjIiArIGxbMF0gKyBlKSwKICAgICAgICBhID0gbi5hdHRyKCJ0eXBlIiksCiAgICAgICAgcyA9ICJsYXllci1hbmltLWNsb3NlIjsKCiAgICBpZiAoblswXSkgewogICAgICB2YXIgZiA9ICJsYXl1aS1sYXllci13cmFwIiwKICAgICAgICAgIGMgPSBmdW5jdGlvbiBjKCkgewogICAgICAgIGlmIChhID09PSBvLnR5cGVbMV0gJiYgIm9iamVjdCIgPT09IG4uYXR0cigiY29uVHlwZSIpKSB7CiAgICAgICAgICBuLmNoaWxkcmVuKCI6bm90KC4iICsgbFs1XSArICIpIikucmVtb3ZlKCk7CgogICAgICAgICAgZm9yICh2YXIgciA9IG4uZmluZCgiLiIgKyBmKSwgcyA9IDA7IHMgPCAyOyBzKyspIHsKICAgICAgICAgICAgci51bndyYXAoKTsKICAgICAgICAgIH0KCiAgICAgICAgICByLmNzcygiZGlzcGxheSIsIHIuZGF0YSgiZGlzcGxheSIpKS5yZW1vdmVDbGFzcyhmKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGEgPT09IG8udHlwZVsyXSkgdHJ5IHsKICAgICAgICAgICAgdmFyIGMgPSBpKCIjIiArIGxbNF0gKyBlKVswXTsKICAgICAgICAgICAgYy5jb250ZW50V2luZG93LmRvY3VtZW50LndyaXRlKCIiKSwgYy5jb250ZW50V2luZG93LmNsb3NlKCksIG4uZmluZCgiLiIgKyBsWzVdKVswXS5yZW1vdmVDaGlsZChjKTsKICAgICAgICAgIH0gY2F0Y2ggKHUpIHt9CiAgICAgICAgICBuWzBdLmlubmVySFRNTCA9ICIiLCBuLnJlbW92ZSgpOwogICAgICAgIH0KCiAgICAgICAgImZ1bmN0aW9uIiA9PSB0eXBlb2Ygby5lbmRbZV0gJiYgby5lbmRbZV0oKSwgZGVsZXRlIG8uZW5kW2VdLCAiZnVuY3Rpb24iID09IHR5cGVvZiB0ICYmIHQoKTsKICAgICAgfTsKCiAgICAgIG4uZGF0YSgiaXNPdXRBbmltIikgJiYgbi5hZGRDbGFzcygibGF5ZXItYW5pbSAiICsgcyksIGkoIiNsYXl1aS1sYXllci1tb3ZlcywgIyIgKyBsLlNIQURFICsgZSkucmVtb3ZlKCksIDYgPT0gci5pZSAmJiBvLnJlc2VsZWN0KCksIG8ucmVzY29sbGJhcihlKSwgbi5hdHRyKCJtaW5MZWZ0IikgJiYgKG8ubWluSW5kZXgtLSwgby5taW5MZWZ0LnB1c2gobi5hdHRyKCJtaW5MZWZ0IikpKSwgci5pZSAmJiByLmllIDwgMTAgfHwgIW4uZGF0YSgiaXNPdXRBbmltIikgPyBjKCkgOiBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBjKCk7CiAgICAgIH0sIDIwMCk7CiAgICB9CiAgfSwgci5jbG9zZUFsbCA9IGZ1bmN0aW9uIChlLCB0KSB7CiAgICAiZnVuY3Rpb24iID09IHR5cGVvZiBlICYmICh0ID0gZSwgZSA9IG51bGwpOwogICAgdmFyIG4gPSBpKCIuIiArIGxbMF0pOwogICAgaS5lYWNoKG4sIGZ1bmN0aW9uIChhKSB7CiAgICAgIHZhciBvID0gaSh0aGlzKSwKICAgICAgICAgIHMgPSBlID8gby5hdHRyKCJ0eXBlIikgPT09IGUgOiAxOwogICAgICBzICYmIHIuY2xvc2Uoby5hdHRyKCJ0aW1lcyIpLCBhID09PSBuLmxlbmd0aCAtIDEgPyB0IDogbnVsbCksIHMgPSBudWxsOwogICAgfSksIDAgPT09IG4ubGVuZ3RoICYmICJmdW5jdGlvbiIgPT0gdHlwZW9mIHQgJiYgdCgpOwogIH07CgogIHZhciBmID0gci5jYWNoZSB8fCB7fSwKICAgICAgYyA9IGZ1bmN0aW9uIGMoZSkgewogICAgcmV0dXJuIGYuc2tpbiA/ICIgIiArIGYuc2tpbiArICIgIiArIGYuc2tpbiArICItIiArIGUgOiAiIjsKICB9OwoKICByLnByb21wdCA9IGZ1bmN0aW9uIChlLCB0KSB7CiAgICB2YXIgYSA9ICIiOwoKICAgIGlmIChlID0gZSB8fCB7fSwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgZSAmJiAodCA9IGUpLCBlLmFyZWEpIHsKICAgICAgdmFyIG8gPSBlLmFyZWE7CiAgICAgIGEgPSAnc3R5bGU9IndpZHRoOiAnICsgb1swXSArICI7IGhlaWdodDogIiArIG9bMV0gKyAnOyInLCBkZWxldGUgZS5hcmVhOwogICAgfQoKICAgIHZhciBzLAogICAgICAgIGwgPSAyID09IGUuZm9ybVR5cGUgPyAnPHRleHRhcmVhIGNsYXNzPSJsYXl1aS1sYXllci1pbnB1dCInICsgYSArICI+PC90ZXh0YXJlYT4iIDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gJzxpbnB1dCB0eXBlPSInICsgKDEgPT0gZS5mb3JtVHlwZSA/ICJwYXNzd29yZCIgOiAidGV4dCIpICsgJyIgY2xhc3M9ImxheXVpLWxheWVyLWlucHV0Ij4nOwogICAgfSgpLAogICAgICAgIGYgPSBlLnN1Y2Nlc3M7CiAgICByZXR1cm4gZGVsZXRlIGUuc3VjY2Vzcywgci5vcGVuKGkuZXh0ZW5kKHsKICAgICAgdHlwZTogMSwKICAgICAgYnRuOiBbIiYjeDc4NkU7JiN4NUI5QTsiLCAiJiN4NTNENjsmI3g2RDg4OyJdLAogICAgICBjb250ZW50OiBsLAogICAgICBza2luOiAibGF5dWktbGF5ZXItcHJvbXB0IiArIGMoInByb21wdCIpLAogICAgICBtYXhXaWR0aDogbi53aWR0aCgpLAogICAgICBzdWNjZXNzOiBmdW5jdGlvbiBzdWNjZXNzKHQpIHsKICAgICAgICBzID0gdC5maW5kKCIubGF5dWktbGF5ZXItaW5wdXQiKSwgcy52YWwoZS52YWx1ZSB8fCAiIikuZm9jdXMoKSwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgZiAmJiBmKHQpOwogICAgICB9LAogICAgICByZXNpemU6ICExLAogICAgICB5ZXM6IGZ1bmN0aW9uIHllcyhpKSB7CiAgICAgICAgdmFyIG4gPSBzLnZhbCgpOwogICAgICAgICIiID09PSBuID8gcy5mb2N1cygpIDogbi5sZW5ndGggPiAoZS5tYXhsZW5ndGggfHwgNTAwKSA/IHIudGlwcygiJiN4NjcwMDsmI3g1OTFBOyYjeDhGOTM7JiN4NTE2NTsiICsgKGUubWF4bGVuZ3RoIHx8IDUwMCkgKyAiJiN4NEUyQTsmI3g1QjU3OyYjeDY1NzA7IiwgcywgewogICAgICAgICAgdGlwczogMQogICAgICAgIH0pIDogdCAmJiB0KG4sIGksIHMpOwogICAgICB9CiAgICB9LCBlKSk7CiAgfSwgci50YWIgPSBmdW5jdGlvbiAoZSkgewogICAgZSA9IGUgfHwge307CiAgICB2YXIgdCA9IGUudGFiIHx8IHt9LAogICAgICAgIG4gPSAibGF5dWktdGhpcyIsCiAgICAgICAgYSA9IGUuc3VjY2VzczsKICAgIHJldHVybiBkZWxldGUgZS5zdWNjZXNzLCByLm9wZW4oaS5leHRlbmQoewogICAgICB0eXBlOiAxLAogICAgICBza2luOiAibGF5dWktbGF5ZXItdGFiIiArIGMoInRhYiIpLAogICAgICByZXNpemU6ICExLAogICAgICB0aXRsZTogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBlID0gdC5sZW5ndGgsCiAgICAgICAgICAgIGkgPSAxLAogICAgICAgICAgICBhID0gIiI7CiAgICAgICAgaWYgKGUgPiAwKSBmb3IgKGEgPSAnPHNwYW4gY2xhc3M9IicgKyBuICsgJyI+JyArIHRbMF0udGl0bGUgKyAiPC9zcGFuPiI7IGkgPCBlOyBpKyspIHsKICAgICAgICAgIGEgKz0gIjxzcGFuPiIgKyB0W2ldLnRpdGxlICsgIjwvc3Bhbj4iOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYTsKICAgICAgfSgpLAogICAgICBjb250ZW50OiAnPHVsIGNsYXNzPSJsYXl1aS1sYXllci10YWJtYWluIj4nICsgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBlID0gdC5sZW5ndGgsCiAgICAgICAgICAgIGkgPSAxLAogICAgICAgICAgICBhID0gIiI7CiAgICAgICAgaWYgKGUgPiAwKSBmb3IgKGEgPSAnPGxpIGNsYXNzPSJsYXl1aS1sYXllci10YWJsaSAnICsgbiArICciPicgKyAodFswXS5jb250ZW50IHx8ICJubyBjb250ZW50IikgKyAiPC9saT4iOyBpIDwgZTsgaSsrKSB7CiAgICAgICAgICBhICs9ICc8bGkgY2xhc3M9ImxheXVpLWxheWVyLXRhYmxpIj4nICsgKHRbaV0uY29udGVudCB8fCAibm8gIGNvbnRlbnQiKSArICI8L2xpPiI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhOwogICAgICB9KCkgKyAiPC91bD4iLAogICAgICBzdWNjZXNzOiBmdW5jdGlvbiBzdWNjZXNzKHQpIHsKICAgICAgICB2YXIgbyA9IHQuZmluZCgiLmxheXVpLWxheWVyLXRpdGxlIikuY2hpbGRyZW4oKSwKICAgICAgICAgICAgciA9IHQuZmluZCgiLmxheXVpLWxheWVyLXRhYm1haW4iKS5jaGlsZHJlbigpOwogICAgICAgIG8ub24oIm1vdXNlZG93biIsIGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICB0LnN0b3BQcm9wYWdhdGlvbiA/IHQuc3RvcFByb3BhZ2F0aW9uKCkgOiB0LmNhbmNlbEJ1YmJsZSA9ICEwOwogICAgICAgICAgdmFyIGEgPSBpKHRoaXMpLAogICAgICAgICAgICAgIG8gPSBhLmluZGV4KCk7CiAgICAgICAgICBhLmFkZENsYXNzKG4pLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MobiksIHIuZXEobykuc2hvdygpLnNpYmxpbmdzKCkuaGlkZSgpLCAiZnVuY3Rpb24iID09IHR5cGVvZiBlLmNoYW5nZSAmJiBlLmNoYW5nZShvKTsKICAgICAgICB9KSwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgYSAmJiBhKHQpOwogICAgICB9CiAgICB9LCBlKSk7CiAgfSwgci5waG90b3MgPSBmdW5jdGlvbiAodCwgbiwgYSkgewogICAgZnVuY3Rpb24gbyhlLCB0LCBpKSB7CiAgICAgIHZhciBuID0gbmV3IEltYWdlKCk7CiAgICAgIHJldHVybiBuLnNyYyA9IGUsIG4uY29tcGxldGUgPyB0KG4pIDogKG4ub25sb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgIG4ub25sb2FkID0gbnVsbCwgdChuKTsKICAgICAgfSwgdm9pZCAobi5vbmVycm9yID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICBuLm9uZXJyb3IgPSBudWxsLCBpKGUpOwogICAgICB9KSk7CiAgICB9CgogICAgdmFyIHMgPSB7fTsKCiAgICBpZiAodCA9IHQgfHwge30sIHQucGhvdG9zKSB7CiAgICAgIHZhciBsID0gISgic3RyaW5nIiA9PSB0eXBlb2YgdC5waG90b3MgfHwgdC5waG90b3MgaW5zdGFuY2VvZiBpKSwKICAgICAgICAgIGYgPSBsID8gdC5waG90b3MgOiB7fSwKICAgICAgICAgIHUgPSBmLmRhdGEgfHwgW10sCiAgICAgICAgICBkID0gZi5zdGFydCB8fCAwOwogICAgICBzLmltZ0luZGV4ID0gKDAgfCBkKSArIDEsIHQuaW1nID0gdC5pbWcgfHwgImltZyI7CiAgICAgIHZhciB5ID0gdC5zdWNjZXNzOwoKICAgICAgaWYgKGRlbGV0ZSB0LnN1Y2Nlc3MsIGwpIHsKICAgICAgICBpZiAoMCA9PT0gdS5sZW5ndGgpIHJldHVybiByLm1zZygiJiN4NkNBMTsmI3g2NzA5OyYjeDU2RkU7JiN4NzI0NzsiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcCA9IGkodC5waG90b3MpLAogICAgICAgICAgICBoID0gZnVuY3Rpb24gaCgpIHsKICAgICAgICAgIHUgPSBbXSwgcC5maW5kKHQuaW1nKS5lYWNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIHZhciB0ID0gaSh0aGlzKTsKICAgICAgICAgICAgdC5hdHRyKCJsYXllci1pbmRleCIsIGUpLCB1LnB1c2goewogICAgICAgICAgICAgIGFsdDogdC5hdHRyKCJhbHQiKSwKICAgICAgICAgICAgICBwaWQ6IHQuYXR0cigibGF5ZXItcGlkIiksCiAgICAgICAgICAgICAgc3JjOiB0LmF0dHIoImxheWVyLXNyYyIpIHx8IHQuYXR0cigic3JjIiksCiAgICAgICAgICAgICAgdGh1bWI6IHQuYXR0cigic3JjIikKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBpZiAoaCgpLCAwID09PSB1Lmxlbmd0aCkgcmV0dXJuOwogICAgICAgIGlmIChuIHx8IHAub24oImNsaWNrIiwgdC5pbWcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGgoKTsKICAgICAgICAgIHZhciBlID0gaSh0aGlzKSwKICAgICAgICAgICAgICBuID0gZS5hdHRyKCJsYXllci1pbmRleCIpOwogICAgICAgICAgci5waG90b3MoaS5leHRlbmQodCwgewogICAgICAgICAgICBwaG90b3M6IHsKICAgICAgICAgICAgICBzdGFydDogbiwKICAgICAgICAgICAgICBkYXRhOiB1LAogICAgICAgICAgICAgIHRhYjogdC50YWIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZnVsbDogdC5mdWxsCiAgICAgICAgICB9KSwgITApOwogICAgICAgIH0pLCAhbikgcmV0dXJuOwogICAgICB9CgogICAgICBzLmltZ3ByZXYgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIHMuaW1nSW5kZXgtLSwgcy5pbWdJbmRleCA8IDEgJiYgKHMuaW1nSW5kZXggPSB1Lmxlbmd0aCksIHMudGFiaW1nKGUpOwogICAgICB9LCBzLmltZ25leHQgPSBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgIHMuaW1nSW5kZXgrKywgcy5pbWdJbmRleCA+IHUubGVuZ3RoICYmIChzLmltZ0luZGV4ID0gMSwgdCkgfHwgcy50YWJpbWcoZSk7CiAgICAgIH0sIHMua2V5dXAgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIGlmICghcy5lbmQpIHsKICAgICAgICAgIHZhciB0ID0gZS5rZXlDb2RlOwogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpLCAzNyA9PT0gdCA/IHMuaW1ncHJldighMCkgOiAzOSA9PT0gdCA/IHMuaW1nbmV4dCghMCkgOiAyNyA9PT0gdCAmJiByLmNsb3NlKHMuaW5kZXgpOwogICAgICAgIH0KICAgICAgfSwgcy50YWJpbWcgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIGlmICghKHUubGVuZ3RoIDw9IDEpKSByZXR1cm4gZi5zdGFydCA9IHMuaW1nSW5kZXggLSAxLCByLmNsb3NlKHMuaW5kZXgpLCByLnBob3Rvcyh0LCAhMCwgZSk7CiAgICAgIH0sIHMuZXZlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcy5iaWdpbWcuZmluZCgiLmxheXVpLWxheWVyLWltZ3ByZXYiKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpLCBzLmltZ3ByZXYoITApOwogICAgICAgIH0pLCBzLmJpZ2ltZy5maW5kKCIubGF5dWktbGF5ZXItaW1nbmV4dCIpLm9uKCJjbGljayIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCksIHMuaW1nbmV4dCghMCk7CiAgICAgICAgfSksIGkoZG9jdW1lbnQpLm9uKCJrZXl1cCIsIHMua2V5dXApOwogICAgICB9LCBzLmxvYWRpID0gci5sb2FkKDEsIHsKICAgICAgICBzaGFkZTogISgic2hhZGUiIGluIHQpICYmIC45LAogICAgICAgIHNjcm9sbGJhcjogITEKICAgICAgfSksIG8odVtkXS5zcmMsIGZ1bmN0aW9uIChuKSB7CiAgICAgICAgci5jbG9zZShzLmxvYWRpKSwgYSAmJiAodC5hbmltID0gLTEpLCBzLmluZGV4ID0gci5vcGVuKGkuZXh0ZW5kKHsKICAgICAgICAgIHR5cGU6IDEsCiAgICAgICAgICBpZDogImxheXVpLWxheWVyLXBob3RvcyIsCiAgICAgICAgICBhcmVhOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBhID0gW24ud2lkdGgsIG4uaGVpZ2h0XSwKICAgICAgICAgICAgICAgIG8gPSBbaShlKS53aWR0aCgpIC0gMTAwLCBpKGUpLmhlaWdodCgpIC0gMTAwXTsKCiAgICAgICAgICAgIGlmICghdC5mdWxsICYmIChhWzBdID4gb1swXSB8fCBhWzFdID4gb1sxXSkpIHsKICAgICAgICAgICAgICB2YXIgciA9IFthWzBdIC8gb1swXSwgYVsxXSAvIG9bMV1dOwogICAgICAgICAgICAgIHJbMF0gPiByWzFdID8gKGFbMF0gPSBhWzBdIC8gclswXSwgYVsxXSA9IGFbMV0gLyByWzBdKSA6IHJbMF0gPCByWzFdICYmIChhWzBdID0gYVswXSAvIHJbMV0sIGFbMV0gPSBhWzFdIC8gclsxXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBbYVswXSArICJweCIsIGFbMV0gKyAicHgiXTsKICAgICAgICAgIH0oKSwKICAgICAgICAgIHRpdGxlOiAhMSwKICAgICAgICAgIHNoYWRlOiAuOSwKICAgICAgICAgIHNoYWRlQ2xvc2U6ICEwLAogICAgICAgICAgY2xvc2VCdG46ICExLAogICAgICAgICAgbW92ZTogIi5sYXl1aS1sYXllci1waGltZyBpbWciLAogICAgICAgICAgbW92ZVR5cGU6IDEsCiAgICAgICAgICBzY3JvbGxiYXI6ICExLAogICAgICAgICAgbW92ZU91dDogITAsCiAgICAgICAgICBhbmltOiA1LAogICAgICAgICAgaXNPdXRBbmltOiAhMSwKICAgICAgICAgIHNraW46ICJsYXl1aS1sYXllci1waG90b3MiICsgYygicGhvdG9zIiksCiAgICAgICAgICBjb250ZW50OiAnPGRpdiBjbGFzcz0ibGF5dWktbGF5ZXItcGhpbWciPjxpbWcgc3JjPSInICsgdVtkXS5zcmMgKyAnIiBhbHQ9IicgKyAodVtkXS5hbHQgfHwgIiIpICsgJyIgbGF5ZXItcGlkPSInICsgdVtkXS5waWQgKyAnIj4nICsgZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdS5sZW5ndGggPiAxID8gJzxkaXYgY2xhc3M9ImxheXVpLWxheWVyLWltZ3NlZSI+PHNwYW4gY2xhc3M9ImxheXVpLWxheWVyLWltZ3VpZGUiPjxhIGhyZWY9ImphdmFzY3JpcHQ6OyIgY2xhc3M9ImxheXVpLWxheWVyLWljb25leHQgbGF5dWktbGF5ZXItaW1ncHJldiI+PC9hPjxhIGhyZWY9ImphdmFzY3JpcHQ6OyIgY2xhc3M9ImxheXVpLWxheWVyLWljb25leHQgbGF5dWktbGF5ZXItaW1nbmV4dCI+PC9hPjwvc3Bhbj48ZGl2IGNsYXNzPSJsYXl1aS1sYXllci1pbWdiYXIiIHN0eWxlPSJkaXNwbGF5OicgKyAoYSA/ICJibG9jayIgOiAiIikgKyAnIj48c3BhbiBjbGFzcz0ibGF5dWktbGF5ZXItaW1ndGl0Ij48YSBocmVmPSJqYXZhc2NyaXB0OjsiPicgKyAodVtkXS5hbHQgfHwgIiIpICsgIjwvYT48ZW0+IiArIHMuaW1nSW5kZXggKyAiIC8gIiArIHUubGVuZ3RoICsgIjwvZW0+PC9zcGFuPjwvZGl2PjwvZGl2PiIgOiAiIjsKICAgICAgICAgIH0oKSArICI8L2Rpdj4iLAogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gc3VjY2VzcyhlLCBpKSB7CiAgICAgICAgICAgIHMuYmlnaW1nID0gZS5maW5kKCIubGF5dWktbGF5ZXItcGhpbWciKSwgcy5pbWdzZWUgPSBlLmZpbmQoIi5sYXl1aS1sYXllci1pbWdiYXIiKSwgcy5ldmVudChlKSwgdC50YWIgJiYgdC50YWIodVtkXSwgZSksICJmdW5jdGlvbiIgPT0gdHlwZW9mIHkgJiYgeShlKTsKICAgICAgICAgIH0sCiAgICAgICAgICBlbmQ6IGZ1bmN0aW9uIGVuZCgpIHsKICAgICAgICAgICAgcy5lbmQgPSAhMCwgaShkb2N1bWVudCkub2ZmKCJrZXl1cCIsIHMua2V5dXApOwogICAgICAgICAgfQogICAgICAgIH0sIHQpKTsKICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgIHIuY2xvc2Uocy5sb2FkaSksIHIubXNnKCImI3g1RjUzOyYjeDUyNEQ7JiN4NTZGRTsmI3g3MjQ3OyYjeDU3MzA7JiN4NTc0MDsmI3g1RjAyOyYjeDVFMzg7PGJyPiYjeDY2MkY7JiN4NTQyNjsmI3g3RUU3OyYjeDdFRUQ7JiN4NjdFNTsmI3g3NzBCOyYjeDRFMEI7JiN4NEUwMDsmI3g1RjIwOyYjeEZGMUY7IiwgewogICAgICAgICAgdGltZTogM2U0LAogICAgICAgICAgYnRuOiBbIiYjeDRFMEI7JiN4NEUwMDsmI3g1RjIwOyIsICImI3g0RTBEOyYjeDc3MEI7JiN4NEU4NjsiXSwKICAgICAgICAgIHllczogZnVuY3Rpb24geWVzKCkgewogICAgICAgICAgICB1Lmxlbmd0aCA+IDEgJiYgcy5pbWduZXh0KCEwLCAhMCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH0sIG8ucnVuID0gZnVuY3Rpb24gKHQpIHsKICAgIGkgPSB0LCBuID0gaShlKSwgbC5odG1sID0gaSgiaHRtbCIpLCByLm9wZW4gPSBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgdCA9IG5ldyBzKGUpOwogICAgICByZXR1cm4gdC5pbmRleDsKICAgIH07CiAgfSwgZS5sYXl1aSAmJiBsYXl1aS5kZWZpbmUgPyAoci5yZWFkeSgpLCBsYXl1aS5kZWZpbmUoImpxdWVyeSIsIGZ1bmN0aW9uICh0KSB7CiAgICByLnBhdGggPSBsYXl1aS5jYWNoZS5kaXIsIG8ucnVuKGxheXVpLiQpLCBlLmxheWVyID0gciwgdCgibGF5ZXIiLCByKTsKICB9KSkgOiAiZnVuY3Rpb24iID09IHR5cGVvZiBkZWZpbmUgJiYgZGVmaW5lLmFtZCA/IGRlZmluZShbImpxdWVyeSJdLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gby5ydW4oZS5qUXVlcnkpLCByOwogIH0pIDogZnVuY3Rpb24gKCkgewogICAgci5yZWFkeSgpLCBvLnJ1bihlLmpRdWVyeSk7CiAgfSgpOwp9KHdpbmRvdyk7CmxheXVpLmRlZmluZSgianF1ZXJ5IiwgZnVuY3Rpb24gKGUpIHsKICAidXNlIHN0cmljdCI7CgogIHZhciB0ID0gbGF5dWkuJCwKICAgICAgaSA9IGxheXVpLmhpbnQoKSwKICAgICAgbiA9IHsKICAgIGZpeGJhcjogZnVuY3Rpb24gZml4YmFyKGUpIHsKICAgICAgdmFyIGksCiAgICAgICAgICBuLAogICAgICAgICAgciA9ICJsYXl1aS1maXhiYXIiLAogICAgICAgICAgYSA9ICJsYXl1aS1maXhiYXItdG9wIiwKICAgICAgICAgIG8gPSB0KGRvY3VtZW50KSwKICAgICAgICAgIGwgPSB0KCJib2R5Iik7CiAgICAgIGUgPSB0LmV4dGVuZCh7CiAgICAgICAgc2hvd0hlaWdodDogMjAwCiAgICAgIH0sIGUpLCBlLmJhcjEgPSBlLmJhcjEgPT09ICEwID8gIiYjeGU2MDY7IiA6IGUuYmFyMSwgZS5iYXIyID0gZS5iYXIyID09PSAhMCA/ICImI3hlNjA3OyIgOiBlLmJhcjIsIGUuYmdjb2xvciA9IGUuYmdjb2xvciA/ICJiYWNrZ3JvdW5kLWNvbG9yOiIgKyBlLmJnY29sb3IgOiAiIjsKCiAgICAgIHZhciBjID0gW2UuYmFyMSwgZS5iYXIyLCAiJiN4ZTYwNDsiXSwKICAgICAgICAgIGcgPSB0KFsnPHVsIGNsYXNzPSInICsgciArICciPicsIGUuYmFyMSA/ICc8bGkgY2xhc3M9ImxheXVpLWljb24iIGxheS10eXBlPSJiYXIxIiBzdHlsZT0iJyArIGUuYmdjb2xvciArICciPicgKyBjWzBdICsgIjwvbGk+IiA6ICIiLCBlLmJhcjIgPyAnPGxpIGNsYXNzPSJsYXl1aS1pY29uIiBsYXktdHlwZT0iYmFyMiIgc3R5bGU9IicgKyBlLmJnY29sb3IgKyAnIj4nICsgY1sxXSArICI8L2xpPiIgOiAiIiwgJzxsaSBjbGFzcz0ibGF5dWktaWNvbiAnICsgYSArICciIGxheS10eXBlPSJ0b3AiIHN0eWxlPSInICsgZS5iZ2NvbG9yICsgJyI+JyArIGNbMl0gKyAiPC9saT4iLCAiPC91bD4iXS5qb2luKCIiKSksCiAgICAgICAgICB1ID0gZy5maW5kKCIuIiArIGEpLAogICAgICAgICAgcyA9IGZ1bmN0aW9uIHMoKSB7CiAgICAgICAgdmFyIHQgPSBvLnNjcm9sbFRvcCgpOwogICAgICAgIHQgPj0gZS5zaG93SGVpZ2h0ID8gaSB8fCAodS5zaG93KCksIGkgPSAxKSA6IGkgJiYgKHUuaGlkZSgpLCBpID0gMCk7CiAgICAgIH07CgogICAgICB0KCIuIiArIHIpWzBdIHx8ICgib2JqZWN0IiA9PSBfdHlwZW9mKGUuY3NzKSAmJiBnLmNzcyhlLmNzcyksIGwuYXBwZW5kKGcpLCBzKCksIGcuZmluZCgibGkiKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGkgPSB0KHRoaXMpLAogICAgICAgICAgICBuID0gaS5hdHRyKCJsYXktdHlwZSIpOwogICAgICAgICJ0b3AiID09PSBuICYmIHQoImh0bWwsYm9keSIpLmFuaW1hdGUoewogICAgICAgICAgc2Nyb2xsVG9wOiAwCiAgICAgICAgfSwgMjAwKSwgZS5jbGljayAmJiBlLmNsaWNrLmNhbGwodGhpcywgbik7CiAgICAgIH0pLCBvLm9uKCJzY3JvbGwiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KG4pLCBuID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzKCk7CiAgICAgICAgfSwgMTAwKTsKICAgICAgfSkpOwogICAgfSwKICAgIGNvdW50ZG93bjogZnVuY3Rpb24gY291bnRkb3duKGUsIHQsIGkpIHsKICAgICAgdmFyIG4gPSB0aGlzLAogICAgICAgICAgciA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIHQsCiAgICAgICAgICBhID0gbmV3IERhdGUoZSkuZ2V0VGltZSgpLAogICAgICAgICAgbyA9IG5ldyBEYXRlKCF0IHx8IHIgPyBuZXcgRGF0ZSgpLmdldFRpbWUoKSA6IHQpLmdldFRpbWUoKSwKICAgICAgICAgIGwgPSBhIC0gbywKICAgICAgICAgIGMgPSBbTWF0aC5mbG9vcihsIC8gODY0ZTUpLCBNYXRoLmZsb29yKGwgLyAzNmU1KSAlIDI0LCBNYXRoLmZsb29yKGwgLyA2ZTQpICUgNjAsIE1hdGguZmxvb3IobCAvIDFlMykgJSA2MF07CiAgICAgIHIgJiYgKGkgPSB0KTsKICAgICAgdmFyIGcgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBuLmNvdW50ZG93bihlLCBvICsgMWUzLCBpKTsKICAgICAgfSwgMWUzKTsKICAgICAgcmV0dXJuIGkgJiYgaShsID4gMCA/IGMgOiBbMCwgMCwgMCwgMF0sIHQsIGcpLCBsIDw9IDAgJiYgY2xlYXJUaW1lb3V0KGcpLCBnOwogICAgfSwKICAgIHRpbWVBZ286IGZ1bmN0aW9uIHRpbWVBZ28oZSwgdCkgewogICAgICB2YXIgaSA9IHRoaXMsCiAgICAgICAgICBuID0gW1tdLCBbXV0sCiAgICAgICAgICByID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBuZXcgRGF0ZShlKS5nZXRUaW1lKCk7CiAgICAgIHJldHVybiByID4gMjY3ODRlNSA/IChyID0gbmV3IERhdGUoZSksIG5bMF1bMF0gPSBpLmRpZ2l0KHIuZ2V0RnVsbFllYXIoKSwgNCksIG5bMF1bMV0gPSBpLmRpZ2l0KHIuZ2V0TW9udGgoKSArIDEpLCBuWzBdWzJdID0gaS5kaWdpdChyLmdldERhdGUoKSksIHQgfHwgKG5bMV1bMF0gPSBpLmRpZ2l0KHIuZ2V0SG91cnMoKSksIG5bMV1bMV0gPSBpLmRpZ2l0KHIuZ2V0TWludXRlcygpKSwgblsxXVsyXSA9IGkuZGlnaXQoci5nZXRTZWNvbmRzKCkpKSwgblswXS5qb2luKCItIikgKyAiICIgKyBuWzFdLmpvaW4oIjoiKSkgOiByID49IDg2NGU1ID8gKHIgLyAxZTMgLyA2MCAvIDYwIC8gMjQgfCAwKSArICJcdTU5MjlcdTUyNEQiIDogciA+PSAzNmU1ID8gKHIgLyAxZTMgLyA2MCAvIDYwIHwgMCkgKyAiXHU1QzBGXHU2NUY2XHU1MjREIiA6IHIgPj0gMThlNCA/IChyIC8gMWUzIC8gNjAgfCAwKSArICJcdTUyMDZcdTk0OUZcdTUyNEQiIDogciA8IDAgPyAiXHU2NzJBXHU2NzY1IiA6ICJcdTUyMUFcdTUyMUEiOwogICAgfSwKICAgIGRpZ2l0OiBmdW5jdGlvbiBkaWdpdChlLCB0KSB7CiAgICAgIHZhciBpID0gIiI7CiAgICAgIGUgPSBTdHJpbmcoZSksIHQgPSB0IHx8IDI7CgogICAgICBmb3IgKHZhciBuID0gZS5sZW5ndGg7IG4gPCB0OyBuKyspIHsKICAgICAgICBpICs9ICIwIjsKICAgICAgfQoKICAgICAgcmV0dXJuIGUgPCBNYXRoLnBvdygxMCwgdCkgPyBpICsgKDAgfCBlKSA6IGU7CiAgICB9LAogICAgdG9EYXRlU3RyaW5nOiBmdW5jdGlvbiB0b0RhdGVTdHJpbmcoZSwgdCkgewogICAgICBpZiAobnVsbCA9PT0gZSB8fCAiIiA9PT0gZSkgcmV0dXJuICIiOwogICAgICB2YXIgbiA9IHRoaXMsCiAgICAgICAgICByID0gbmV3IERhdGUoZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChlKSByZXR1cm4gaXNOYU4oZSkgPyBlIDogInN0cmluZyIgPT0gdHlwZW9mIGUgPyBwYXJzZUludChlKSA6IGU7CiAgICAgIH0oKSB8fCBuZXcgRGF0ZSgpKSwKICAgICAgICAgIGEgPSBbbi5kaWdpdChyLmdldEZ1bGxZZWFyKCksIDQpLCBuLmRpZ2l0KHIuZ2V0TW9udGgoKSArIDEpLCBuLmRpZ2l0KHIuZ2V0RGF0ZSgpKV0sCiAgICAgICAgICBvID0gW24uZGlnaXQoci5nZXRIb3VycygpKSwgbi5kaWdpdChyLmdldE1pbnV0ZXMoKSksIG4uZGlnaXQoci5nZXRTZWNvbmRzKCkpXTsKICAgICAgcmV0dXJuIHIuZ2V0RGF0ZSgpID8gKHQgPSB0IHx8ICJ5eXl5LU1NLWRkIEhIOm1tOnNzIiwgdC5yZXBsYWNlKC95eXl5L2csIGFbMF0pLnJlcGxhY2UoL01NL2csIGFbMV0pLnJlcGxhY2UoL2RkL2csIGFbMl0pLnJlcGxhY2UoL0hIL2csIG9bMF0pLnJlcGxhY2UoL21tL2csIG9bMV0pLnJlcGxhY2UoL3NzL2csIG9bMl0pKSA6IChpLmVycm9yKCdJbnZhbGlkIE1zZWMgZm9yICJ1dGlsLnRvRGF0ZVN0cmluZyhNc2VjKSInKSwgIiIpOwogICAgfSwKICAgIGVzY2FwZTogZnVuY3Rpb24gZXNjYXBlKGUpIHsKICAgICAgcmV0dXJuIFN0cmluZyhlIHx8ICIiKS5yZXBsYWNlKC8mKD8hIz9bYS16QS1aMC05XSs7KS9nLCAiJmFtcDsiKS5yZXBsYWNlKC88L2csICImbHQ7IikucmVwbGFjZSgvPi9nLCAiJmd0OyIpLnJlcGxhY2UoLycvZywgIiYjMzk7IikucmVwbGFjZSgvIi9nLCAiJnF1b3Q7Iik7CiAgICB9LAogICAgdW5lc2NhcGU6IGZ1bmN0aW9uIHVuZXNjYXBlKGUpIHsKICAgICAgcmV0dXJuIFN0cmluZyhlIHx8ICIiKS5yZXBsYWNlKC9cJmFtcDsvZywgIiYiKS5yZXBsYWNlKC9cJmx0Oy9nLCAiPCIpLnJlcGxhY2UoL1wmZ3Q7L2csICI+IikucmVwbGFjZSgvXCYjMzk7LywgIiciKS5yZXBsYWNlKC9cJnF1b3Q7LywgJyInKTsKICAgIH0sCiAgICB0b1Zpc2libGVBcmVhOiBmdW5jdGlvbiB0b1Zpc2libGVBcmVhKGUpIHsKICAgICAgaWYgKGUgPSB0LmV4dGVuZCh7CiAgICAgICAgbWFyZ2luOiAxNjAsCiAgICAgICAgZHVyYXRpb246IDIwMCwKICAgICAgICB0eXBlOiAieSIKICAgICAgfSwgZSksIGUuc2Nyb2xsRWxlbVswXSAmJiBlLnRoaXNFbGVtWzBdKSB7CiAgICAgICAgdmFyIGkgPSBlLnNjcm9sbEVsZW0sCiAgICAgICAgICAgIG4gPSBlLnRoaXNFbGVtLAogICAgICAgICAgICByID0gInkiID09PSBlLnR5cGUsCiAgICAgICAgICAgIGEgPSByID8gInNjcm9sbFRvcCIgOiAic2Nyb2xsTGVmdCIsCiAgICAgICAgICAgIG8gPSByID8gInRvcCIgOiAibGVmdCIsCiAgICAgICAgICAgIGwgPSBpW2FdKCksCiAgICAgICAgICAgIGMgPSBpW3IgPyAiaGVpZ2h0IiA6ICJ3aWR0aCJdKCksCiAgICAgICAgICAgIGcgPSBpLm9mZnNldCgpW29dLAogICAgICAgICAgICB1ID0gbi5vZmZzZXQoKVtvXSAtIGcsCiAgICAgICAgICAgIHMgPSB7fTsKICAgICAgICAodSA+IGMgLSBlLm1hcmdpbiB8fCB1IDwgZS5tYXJnaW4pICYmIChzW2FdID0gdSAtIGMgLyAyICsgbCwgaS5hbmltYXRlKHMsIGUuZHVyYXRpb24pKTsKICAgICAgfQogICAgfSwKICAgIGV2ZW50OiBmdW5jdGlvbiBldmVudChlLCBpLCByKSB7CiAgICAgIHZhciBhID0gdCgiYm9keSIpOwogICAgICByZXR1cm4gciA9IHIgfHwgImNsaWNrIiwgaSA9IG4uZXZlbnRbZV0gPSB0LmV4dGVuZCghMCwgbi5ldmVudFtlXSwgaSkgfHwge30sIG4uZXZlbnQuVVRJTF9FVkVOVF9DQUxMQkFDSyA9IG4uZXZlbnQuVVRJTF9FVkVOVF9DQUxMQkFDSyB8fCB7fSwgYS5vZmYociwgIipbIiArIGUgKyAiXSIsIG4uZXZlbnQuVVRJTF9FVkVOVF9DQUxMQkFDS1tlXSksIG4uZXZlbnQuVVRJTF9FVkVOVF9DQUxMQkFDS1tlXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbiA9IHQodGhpcyksCiAgICAgICAgICAgIHIgPSBuLmF0dHIoZSk7CiAgICAgICAgImZ1bmN0aW9uIiA9PSB0eXBlb2YgaVtyXSAmJiBpW3JdLmNhbGwodGhpcywgbik7CiAgICAgIH0sIGEub24ociwgIipbIiArIGUgKyAiXSIsIG4uZXZlbnQuVVRJTF9FVkVOVF9DQUxMQkFDS1tlXSksIGk7CiAgICB9CiAgfTsKICBlKCJ1dGlsIiwgbik7Cn0pOwpsYXl1aS5kZWZpbmUoImpxdWVyeSIsIGZ1bmN0aW9uICh0KSB7CiAgInVzZSBzdHJpY3QiOwoKICB2YXIgaSA9IGxheXVpLiQsCiAgICAgIGEgPSAobGF5dWkuaGludCgpLCBsYXl1aS5kZXZpY2UoKSksCiAgICAgIGUgPSAiZWxlbWVudCIsCiAgICAgIGwgPSAibGF5dWktdGhpcyIsCiAgICAgIG4gPSAibGF5dWktc2hvdyIsCiAgICAgIHMgPSBmdW5jdGlvbiBzKCkgewogICAgdGhpcy5jb25maWcgPSB7fTsKICB9OwoKICBzLnByb3RvdHlwZS5zZXQgPSBmdW5jdGlvbiAodCkgewogICAgdmFyIGEgPSB0aGlzOwogICAgcmV0dXJuIGkuZXh0ZW5kKCEwLCBhLmNvbmZpZywgdCksIGE7CiAgfSwgcy5wcm90b3R5cGUub24gPSBmdW5jdGlvbiAodCwgaSkgewogICAgcmV0dXJuIGxheXVpLm9uZXZlbnQuY2FsbCh0aGlzLCBlLCB0LCBpKTsKICB9LCBzLnByb3RvdHlwZS50YWJBZGQgPSBmdW5jdGlvbiAodCwgYSkgewogICAgdmFyIGUgPSAiLmxheXVpLXRhYi10aXRsZSIsCiAgICAgICAgbCA9IGkoIi5sYXl1aS10YWJbbGF5LWZpbHRlcj0iICsgdCArICJdIiksCiAgICAgICAgbiA9IGwuY2hpbGRyZW4oZSksCiAgICAgICAgcyA9IG4uY2hpbGRyZW4oIi5sYXl1aS10YWItYmFyIiksCiAgICAgICAgbyA9IGwuY2hpbGRyZW4oIi5sYXl1aS10YWItY29udGVudCIpLAogICAgICAgIHIgPSAiPGxpIiArIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHQgPSBbXTsKICAgICAgcmV0dXJuIGxheXVpLmVhY2goYSwgZnVuY3Rpb24gKGksIGEpIHsKICAgICAgICAvXih0aXRsZXxjb250ZW50KSQvLnRlc3QoaSkgfHwgdC5wdXNoKCJsYXktIiArIGkgKyAnPSInICsgYSArICciJyk7CiAgICAgIH0pLCB0Lmxlbmd0aCA+IDAgJiYgdC51bnNoaWZ0KCIiKSwgdC5qb2luKCIgIik7CiAgICB9KCkgKyAiPiIgKyAoYS50aXRsZSB8fCAidW5uYW1pbmciKSArICI8L2xpPiI7CgogICAgcmV0dXJuIHNbMF0gPyBzLmJlZm9yZShyKSA6IG4uYXBwZW5kKHIpLCBvLmFwcGVuZCgnPGRpdiBjbGFzcz0ibGF5dWktdGFiLWl0ZW0iPicgKyAoYS5jb250ZW50IHx8ICIiKSArICI8L2Rpdj4iKSwgYi5oaWRlVGFiTW9yZSghMCksIGIudGFiQXV0bygpLCB0aGlzOwogIH0sIHMucHJvdG90eXBlLnRhYkRlbGV0ZSA9IGZ1bmN0aW9uICh0LCBhKSB7CiAgICB2YXIgZSA9ICIubGF5dWktdGFiLXRpdGxlIiwKICAgICAgICBsID0gaSgiLmxheXVpLXRhYltsYXktZmlsdGVyPSIgKyB0ICsgIl0iKSwKICAgICAgICBuID0gbC5jaGlsZHJlbihlKSwKICAgICAgICBzID0gbi5maW5kKCc+bGlbbGF5LWlkPSInICsgYSArICciXScpOwogICAgcmV0dXJuIGIudGFiRGVsZXRlKG51bGwsIHMpLCB0aGlzOwogIH0sIHMucHJvdG90eXBlLnRhYkNoYW5nZSA9IGZ1bmN0aW9uICh0LCBhKSB7CiAgICB2YXIgZSA9ICIubGF5dWktdGFiLXRpdGxlIiwKICAgICAgICBsID0gaSgiLmxheXVpLXRhYltsYXktZmlsdGVyPSIgKyB0ICsgIl0iKSwKICAgICAgICBuID0gbC5jaGlsZHJlbihlKSwKICAgICAgICBzID0gbi5maW5kKCc+bGlbbGF5LWlkPSInICsgYSArICciXScpOwogICAgcmV0dXJuIGIudGFiQ2xpY2suY2FsbChzWzBdLCBudWxsLCBudWxsLCBzKSwgdGhpczsKICB9LCBzLnByb3RvdHlwZS50YWIgPSBmdW5jdGlvbiAodCkgewogICAgdCA9IHQgfHwge30sIG0ub24oImNsaWNrIiwgdC5oZWFkZXJFbGVtLCBmdW5jdGlvbiAoYSkgewogICAgICB2YXIgZSA9IGkodGhpcykuaW5kZXgoKTsKICAgICAgYi50YWJDbGljay5jYWxsKHRoaXMsIGEsIGUsIG51bGwsIHQpOwogICAgfSk7CiAgfSwgcy5wcm90b3R5cGUucHJvZ3Jlc3MgPSBmdW5jdGlvbiAodCwgYSkgewogICAgdmFyIGUgPSAibGF5dWktcHJvZ3Jlc3MiLAogICAgICAgIGwgPSBpKCIuIiArIGUgKyAiW2xheS1maWx0ZXI9IiArIHQgKyAiXSIpLAogICAgICAgIG4gPSBsLmZpbmQoIi4iICsgZSArICItYmFyIiksCiAgICAgICAgcyA9IG4uZmluZCgiLiIgKyBlICsgIi10ZXh0Iik7CiAgICByZXR1cm4gbi5jc3MoIndpZHRoIiwgYSkuYXR0cigibGF5LXBlcmNlbnQiLCBhKSwgcy50ZXh0KGEpLCB0aGlzOwogIH07CiAgdmFyIG8gPSAiLmxheXVpLW5hdiIsCiAgICAgIHIgPSAibGF5dWktbmF2LWl0ZW0iLAogICAgICBjID0gImxheXVpLW5hdi1iYXIiLAogICAgICB1ID0gImxheXVpLW5hdi10cmVlIiwKICAgICAgeSA9ICJsYXl1aS1uYXYtY2hpbGQiLAogICAgICBkID0gImxheXVpLW5hdi1jaGlsZC1jIiwKICAgICAgZiA9ICJsYXl1aS1uYXYtbW9yZSIsCiAgICAgIGggPSAibGF5dWktaWNvbi1kb3duIiwKICAgICAgcCA9ICJsYXl1aS1hbmltIGxheXVpLWFuaW0tdXBiaXQiLAogICAgICBiID0gewogICAgdGFiQ2xpY2s6IGZ1bmN0aW9uIHRhYkNsaWNrKHQsIGEsIHMsIG8pIHsKICAgICAgbyA9IG8gfHwge307CiAgICAgIHZhciByID0gcyB8fCBpKHRoaXMpLAogICAgICAgICAgYSA9IGEgfHwgci5wYXJlbnQoKS5jaGlsZHJlbigibGkiKS5pbmRleChyKSwKICAgICAgICAgIGMgPSBvLmhlYWRlckVsZW0gPyByLnBhcmVudCgpIDogci5wYXJlbnRzKCIubGF5dWktdGFiIikuZXEoMCksCiAgICAgICAgICB1ID0gby5ib2R5RWxlbSA/IGkoby5ib2R5RWxlbSkgOiBjLmNoaWxkcmVuKCIubGF5dWktdGFiLWNvbnRlbnQiKS5jaGlsZHJlbigiLmxheXVpLXRhYi1pdGVtIiksCiAgICAgICAgICB5ID0gci5maW5kKCJhIiksCiAgICAgICAgICBkID0gImphdmFzY3JpcHQ6OyIgIT09IHkuYXR0cigiaHJlZiIpICYmICJfYmxhbmsiID09PSB5LmF0dHIoInRhcmdldCIpLAogICAgICAgICAgZiA9ICJzdHJpbmciID09IHR5cGVvZiByLmF0dHIoImxheS11bnNlbGVjdCIpLAogICAgICAgICAgaCA9IGMuYXR0cigibGF5LWZpbHRlciIpOwogICAgICBkIHx8IGYgfHwgKHIuYWRkQ2xhc3MobCkuc2libGluZ3MoKS5yZW1vdmVDbGFzcyhsKSwgdS5lcShhKS5hZGRDbGFzcyhuKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKG4pKSwgbGF5dWkuZXZlbnQuY2FsbCh0aGlzLCBlLCAidGFiKCIgKyBoICsgIikiLCB7CiAgICAgICAgZWxlbTogYywKICAgICAgICBpbmRleDogYQogICAgICB9KTsKICAgIH0sCiAgICB0YWJEZWxldGU6IGZ1bmN0aW9uIHRhYkRlbGV0ZSh0LCBhKSB7CiAgICAgIHZhciBuID0gYSB8fCBpKHRoaXMpLnBhcmVudCgpLAogICAgICAgICAgcyA9IG4uaW5kZXgoKSwKICAgICAgICAgIG8gPSBuLnBhcmVudHMoIi5sYXl1aS10YWIiKS5lcSgwKSwKICAgICAgICAgIHIgPSBvLmNoaWxkcmVuKCIubGF5dWktdGFiLWNvbnRlbnQiKS5jaGlsZHJlbigiLmxheXVpLXRhYi1pdGVtIiksCiAgICAgICAgICBjID0gby5hdHRyKCJsYXktZmlsdGVyIik7CiAgICAgIG4uaGFzQ2xhc3MobCkgJiYgKG4ubmV4dCgpWzBdID8gYi50YWJDbGljay5jYWxsKG4ubmV4dCgpWzBdLCBudWxsLCBzICsgMSkgOiBuLnByZXYoKVswXSAmJiBiLnRhYkNsaWNrLmNhbGwobi5wcmV2KClbMF0sIG51bGwsIHMgLSAxKSksIG4ucmVtb3ZlKCksIHIuZXEocykucmVtb3ZlKCksIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIGIudGFiQXV0bygpOwogICAgICB9LCA1MCksIGxheXVpLmV2ZW50LmNhbGwodGhpcywgZSwgInRhYkRlbGV0ZSgiICsgYyArICIpIiwgewogICAgICAgIGVsZW06IG8sCiAgICAgICAgaW5kZXg6IHMKICAgICAgfSk7CiAgICB9LAogICAgdGFiQXV0bzogZnVuY3Rpb24gdGFiQXV0bygpIHsKICAgICAgdmFyIHQgPSAibGF5dWktdGFiLW1vcmUiLAogICAgICAgICAgZSA9ICJsYXl1aS10YWItYmFyIiwKICAgICAgICAgIGwgPSAibGF5dWktdGFiLWNsb3NlIiwKICAgICAgICAgIG4gPSB0aGlzOwogICAgICBpKCIubGF5dWktdGFiIikuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHMgPSBpKHRoaXMpLAogICAgICAgICAgICBvID0gcy5jaGlsZHJlbigiLmxheXVpLXRhYi10aXRsZSIpLAogICAgICAgICAgICByID0gKHMuY2hpbGRyZW4oIi5sYXl1aS10YWItY29udGVudCIpLmNoaWxkcmVuKCIubGF5dWktdGFiLWl0ZW0iKSwgJ2xheS1zdG9wZT0idGFibW9yZSInKSwKICAgICAgICAgICAgYyA9IGkoJzxzcGFuIGNsYXNzPSJsYXl1aS11bnNlbGVjdCBsYXl1aS10YWItYmFyIiAnICsgciArICI+PGkgIiArIHIgKyAnIGNsYXNzPSJsYXl1aS1pY29uIj4mI3hlNjFhOzwvaT48L3NwYW4+Jyk7CiAgICAgICAgaWYgKG4gPT09IHdpbmRvdyAmJiA4ICE9IGEuaWUgJiYgYi5oaWRlVGFiTW9yZSghMCksIHMuYXR0cigibGF5LWFsbG93Q2xvc2UiKSAmJiBvLmZpbmQoImxpIikuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgdCA9IGkodGhpcyk7CgogICAgICAgICAgaWYgKCF0LmZpbmQoIi4iICsgbClbMF0pIHsKICAgICAgICAgICAgdmFyIGEgPSBpKCc8aSBjbGFzcz0ibGF5dWktaWNvbiBsYXl1aS1pY29uLWNsb3NlIGxheXVpLXVuc2VsZWN0ICcgKyBsICsgJyI+PC9pPicpOwogICAgICAgICAgICBhLm9uKCJjbGljayIsIGIudGFiRGVsZXRlKSwgdC5hcHBlbmQoYSk7CiAgICAgICAgICB9CiAgICAgICAgfSksICJzdHJpbmciICE9IHR5cGVvZiBzLmF0dHIoImxheS11bmF1dG8iKSkgaWYgKG8ucHJvcCgic2Nyb2xsV2lkdGgiKSA+IG8ub3V0ZXJXaWR0aCgpICsgMSkgewogICAgICAgICAgaWYgKG8uZmluZCgiLiIgKyBlKVswXSkgcmV0dXJuOwogICAgICAgICAgby5hcHBlbmQoYyksIHMuYXR0cigib3ZlcmZsb3ciLCAiIiksIGMub24oImNsaWNrIiwgZnVuY3Rpb24gKGkpIHsKICAgICAgICAgICAgb1t0aGlzLnRpdGxlID8gInJlbW92ZUNsYXNzIiA6ICJhZGRDbGFzcyJdKHQpLCB0aGlzLnRpdGxlID0gdGhpcy50aXRsZSA/ICIiIDogIlx1NjUzNlx1N0YyOSI7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2Ugby5maW5kKCIuIiArIGUpLnJlbW92ZSgpLCBzLnJlbW92ZUF0dHIoIm92ZXJmbG93Iik7CiAgICAgIH0pOwogICAgfSwKICAgIGhpZGVUYWJNb3JlOiBmdW5jdGlvbiBoaWRlVGFiTW9yZSh0KSB7CiAgICAgIHZhciBhID0gaSgiLmxheXVpLXRhYi10aXRsZSIpOwogICAgICB0ICE9PSAhMCAmJiAidGFibW9yZSIgPT09IGkodC50YXJnZXQpLmF0dHIoImxheS1zdG9wZSIpIHx8IChhLnJlbW92ZUNsYXNzKCJsYXl1aS10YWItbW9yZSIpLCBhLmZpbmQoIi5sYXl1aS10YWItYmFyIikuYXR0cigidGl0bGUiLCAiIikpOwogICAgfSwKICAgIGNsaWNrVGhpczogZnVuY3Rpb24gY2xpY2tUaGlzKCkgewogICAgICB2YXIgdCA9IGkodGhpcyksCiAgICAgICAgICBhID0gdC5wYXJlbnRzKG8pLAogICAgICAgICAgbiA9IGEuYXR0cigibGF5LWZpbHRlciIpLAogICAgICAgICAgcyA9IHQucGFyZW50KCksCiAgICAgICAgICBjID0gdC5zaWJsaW5ncygiLiIgKyB5KSwKICAgICAgICAgIGQgPSAic3RyaW5nIiA9PSB0eXBlb2Ygcy5hdHRyKCJsYXktdW5zZWxlY3QiKTsKICAgICAgImphdmFzY3JpcHQ6OyIgIT09IHQuYXR0cigiaHJlZiIpICYmICJfYmxhbmsiID09PSB0LmF0dHIoInRhcmdldCIpIHx8IGQgfHwgY1swXSB8fCAoYS5maW5kKCIuIiArIGwpLnJlbW92ZUNsYXNzKGwpLCBzLmFkZENsYXNzKGwpKSwgYS5oYXNDbGFzcyh1KSAmJiAoYy5yZW1vdmVDbGFzcyhwKSwgY1swXSAmJiAoc1sibm9uZSIgPT09IGMuY3NzKCJkaXNwbGF5IikgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIl0ociArICJlZCIpLCAiYWxsIiA9PT0gYS5hdHRyKCJsYXktc2hyaW5rIikgJiYgcy5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKHIgKyAiZWQiKSkpLCBsYXl1aS5ldmVudC5jYWxsKHRoaXMsIGUsICJuYXYoIiArIG4gKyAiKSIsIHQpOwogICAgfSwKICAgIGNvbGxhcHNlOiBmdW5jdGlvbiBjb2xsYXBzZSgpIHsKICAgICAgdmFyIHQgPSBpKHRoaXMpLAogICAgICAgICAgYSA9IHQuZmluZCgiLmxheXVpLWNvbGxhLWljb24iKSwKICAgICAgICAgIGwgPSB0LnNpYmxpbmdzKCIubGF5dWktY29sbGEtY29udGVudCIpLAogICAgICAgICAgcyA9IHQucGFyZW50cygiLmxheXVpLWNvbGxhcHNlIikuZXEoMCksCiAgICAgICAgICBvID0gcy5hdHRyKCJsYXktZmlsdGVyIiksCiAgICAgICAgICByID0gIm5vbmUiID09PSBsLmNzcygiZGlzcGxheSIpOwoKICAgICAgaWYgKCJzdHJpbmciID09IHR5cGVvZiBzLmF0dHIoImxheS1hY2NvcmRpb24iKSkgewogICAgICAgIHZhciBjID0gcy5jaGlsZHJlbigiLmxheXVpLWNvbGxhLWl0ZW0iKS5jaGlsZHJlbigiLiIgKyBuKTsKICAgICAgICBjLnNpYmxpbmdzKCIubGF5dWktY29sbGEtdGl0bGUiKS5jaGlsZHJlbigiLmxheXVpLWNvbGxhLWljb24iKS5odG1sKCImI3hlNjAyOyIpLCBjLnJlbW92ZUNsYXNzKG4pOwogICAgICB9CgogICAgICBsW3IgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIl0obiksIGEuaHRtbChyID8gIiYjeGU2MWE7IiA6ICImI3hlNjAyOyIpLCBsYXl1aS5ldmVudC5jYWxsKHRoaXMsIGUsICJjb2xsYXBzZSgiICsgbyArICIpIiwgewogICAgICAgIHRpdGxlOiB0LAogICAgICAgIGNvbnRlbnQ6IGwsCiAgICAgICAgc2hvdzogcgogICAgICB9KTsKICAgIH0KICB9OwogIHMucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAodCwgZSkgewogICAgdmFyIGwgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBlID8gJ1tsYXktZmlsdGVyPSInICsgZSArICciXScgOiAiIjsKICAgIH0oKSwKICAgICAgICBzID0gewogICAgICB0YWI6IGZ1bmN0aW9uIHRhYigpIHsKICAgICAgICBiLnRhYkF1dG8uY2FsbCh7fSk7CiAgICAgIH0sCiAgICAgIG5hdjogZnVuY3Rpb24gbmF2KCkgewogICAgICAgIHZhciB0ID0gMjAwLAogICAgICAgICAgICBlID0ge30sCiAgICAgICAgICAgIHMgPSB7fSwKICAgICAgICAgICAgdiA9IHt9LAogICAgICAgICAgICBtID0gImxheXVpLW5hdi10aXRsZSIsCiAgICAgICAgICAgIEMgPSBmdW5jdGlvbiBDKGwsIG8sIHIpIHsKICAgICAgICAgIHZhciBjID0gaSh0aGlzKSwKICAgICAgICAgICAgICBoID0gYy5maW5kKCIuIiArIHkpOwoKICAgICAgICAgIGlmIChvLmhhc0NsYXNzKHUpKSB7CiAgICAgICAgICAgIGlmICghaFswXSkgewogICAgICAgICAgICAgIHZhciBiID0gYy5jaGlsZHJlbigiLiIgKyBtKTsKICAgICAgICAgICAgICBsLmNzcyh7CiAgICAgICAgICAgICAgICB0b3A6IGMub2Zmc2V0KCkudG9wIC0gby5vZmZzZXQoKS50b3AsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IChiWzBdID8gYiA6IGMpLm91dGVySGVpZ2h0KCksCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBoLmFkZENsYXNzKHApLCBoLmhhc0NsYXNzKGQpICYmIGguY3NzKHsKICAgICAgICAgICAgbGVmdDogLShoLm91dGVyV2lkdGgoKSAtIGMud2lkdGgoKSkgLyAyCiAgICAgICAgICB9KSwgaFswXSA/IGwuY3NzKHsKICAgICAgICAgICAgbGVmdDogbC5wb3NpdGlvbigpLmxlZnQgKyBsLndpZHRoKCkgLyAyLAogICAgICAgICAgICB3aWR0aDogMCwKICAgICAgICAgICAgb3BhY2l0eTogMAogICAgICAgICAgfSkgOiBsLmNzcyh7CiAgICAgICAgICAgIGxlZnQ6IGMucG9zaXRpb24oKS5sZWZ0ICsgcGFyc2VGbG9hdChjLmNzcygibWFyZ2luTGVmdCIpKSwKICAgICAgICAgICAgdG9wOiBjLnBvc2l0aW9uKCkudG9wICsgYy5oZWlnaHQoKSAtIGwuaGVpZ2h0KCkKICAgICAgICAgIH0pLCBlW3JdID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGwuY3NzKHsKICAgICAgICAgICAgICB3aWR0aDogaFswXSA/IDAgOiBjLndpZHRoKCksCiAgICAgICAgICAgICAgb3BhY2l0eTogaFswXSA/IDAgOiAxCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgYS5pZSAmJiBhLmllIDwgMTAgPyAwIDogdCksIGNsZWFyVGltZW91dCh2W3JdKSwgImJsb2NrIiA9PT0gaC5jc3MoImRpc3BsYXkiKSAmJiBjbGVhclRpbWVvdXQoc1tyXSksIHNbcl0gPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaC5hZGRDbGFzcyhuKSwgYy5maW5kKCIuIiArIGYpLmFkZENsYXNzKGYgKyAiZCIpOwogICAgICAgICAgfSwgMzAwKTsKICAgICAgICB9OwoKICAgICAgICBpKG8gKyBsKS5lYWNoKGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICB2YXIgbCA9IGkodGhpcyksCiAgICAgICAgICAgICAgbyA9IGkoJzxzcGFuIGNsYXNzPSInICsgYyArICciPjwvc3Bhbj4nKSwKICAgICAgICAgICAgICBkID0gbC5maW5kKCIuIiArIHIpOwogICAgICAgICAgbC5maW5kKCIuIiArIGMpWzBdIHx8IChsLmFwcGVuZChvKSwgKGwuaGFzQ2xhc3ModSkgPyBkLmZpbmQoImRkLD4uIiArIG0pIDogZCkub24oIm1vdXNlZW50ZXIiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIEMuY2FsbCh0aGlzLCBvLCBsLCBhKTsKICAgICAgICAgIH0pLm9uKCJtb3VzZWxlYXZlIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBsLmhhc0NsYXNzKHUpID8gby5jc3MoewogICAgICAgICAgICAgIGhlaWdodDogMCwKICAgICAgICAgICAgICBvcGFjaXR5OiAwCiAgICAgICAgICAgIH0pIDogKGNsZWFyVGltZW91dChzW2FdKSwgc1thXSA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGwuZmluZCgiLiIgKyB5KS5yZW1vdmVDbGFzcyhuKSwgbC5maW5kKCIuIiArIGYpLnJlbW92ZUNsYXNzKGYgKyAiZCIpOwogICAgICAgICAgICB9LCAzMDApKTsKICAgICAgICAgIH0pLCBsLm9uKCJtb3VzZWxlYXZlIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQoZVthXSksIHZbYV0gPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBsLmhhc0NsYXNzKHUpIHx8IG8uY3NzKHsKICAgICAgICAgICAgICAgIHdpZHRoOiAwLAogICAgICAgICAgICAgICAgbGVmdDogby5wb3NpdGlvbigpLmxlZnQgKyBvLndpZHRoKCkgLyAyLAogICAgICAgICAgICAgICAgb3BhY2l0eTogMAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCB0KTsKICAgICAgICAgIH0pKSwgZC5maW5kKCJhIikuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB0ID0gaSh0aGlzKSwKICAgICAgICAgICAgICAgIGEgPSAodC5wYXJlbnQoKSwgdC5zaWJsaW5ncygiLiIgKyB5KSk7CiAgICAgICAgICAgIGFbMF0gJiYgIXQuY2hpbGRyZW4oIi4iICsgZilbMF0gJiYgdC5hcHBlbmQoJzxpIGNsYXNzPSJsYXl1aS1pY29uICcgKyBoICsgIiAiICsgZiArICciPjwvaT4nKSwgdC5vZmYoImNsaWNrIiwgYi5jbGlja1RoaXMpLm9uKCJjbGljayIsIGIuY2xpY2tUaGlzKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9LAogICAgICBicmVhZGNydW1iOiBmdW5jdGlvbiBicmVhZGNydW1iKCkgewogICAgICAgIHZhciB0ID0gIi5sYXl1aS1icmVhZGNydW1iIjsKICAgICAgICBpKHQgKyBsKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciB0ID0gaSh0aGlzKSwKICAgICAgICAgICAgICBhID0gImxheS1zZXBhcmF0b3IiLAogICAgICAgICAgICAgIGUgPSB0LmF0dHIoYSkgfHwgIi8iLAogICAgICAgICAgICAgIGwgPSB0LmZpbmQoImEiKTsKICAgICAgICAgIGwubmV4dCgic3BhblsiICsgYSArICJdIilbMF0gfHwgKGwuZWFjaChmdW5jdGlvbiAodCkgewogICAgICAgICAgICB0ICE9PSBsLmxlbmd0aCAtIDEgJiYgaSh0aGlzKS5hZnRlcigiPHNwYW4gIiArIGEgKyAiPiIgKyBlICsgIjwvc3Bhbj4iKTsKICAgICAgICAgIH0pLCB0LmNzcygidmlzaWJpbGl0eSIsICJ2aXNpYmxlIikpOwogICAgICAgIH0pOwogICAgICB9LAogICAgICBwcm9ncmVzczogZnVuY3Rpb24gcHJvZ3Jlc3MoKSB7CiAgICAgICAgdmFyIHQgPSAibGF5dWktcHJvZ3Jlc3MiOwogICAgICAgIGkoIi4iICsgdCArIGwpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGEgPSBpKHRoaXMpLAogICAgICAgICAgICAgIGUgPSBhLmZpbmQoIi5sYXl1aS1wcm9ncmVzcy1iYXIiKSwKICAgICAgICAgICAgICBsID0gZS5hdHRyKCJsYXktcGVyY2VudCIpOwogICAgICAgICAgZS5jc3MoIndpZHRoIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gL14uK1wvLiskLy50ZXN0KGwpID8gMTAwICogbmV3IEZ1bmN0aW9uKCJyZXR1cm4gIiArIGwpKCkgKyAiJSIgOiBsOwogICAgICAgICAgfSgpKSwgYS5hdHRyKCJsYXktc2hvd1BlcmNlbnQiKSAmJiBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZS5odG1sKCc8c3BhbiBjbGFzcz0iJyArIHQgKyAnLXRleHQiPicgKyBsICsgIjwvc3Bhbj4iKTsKICAgICAgICAgIH0sIDM1MCk7CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGNvbGxhcHNlOiBmdW5jdGlvbiBjb2xsYXBzZSgpIHsKICAgICAgICB2YXIgdCA9ICJsYXl1aS1jb2xsYXBzZSI7CiAgICAgICAgaSgiLiIgKyB0ICsgbCkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgdCA9IGkodGhpcykuZmluZCgiLmxheXVpLWNvbGxhLWl0ZW0iKTsKICAgICAgICAgIHQuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB0ID0gaSh0aGlzKSwKICAgICAgICAgICAgICAgIGEgPSB0LmZpbmQoIi5sYXl1aS1jb2xsYS10aXRsZSIpLAogICAgICAgICAgICAgICAgZSA9IHQuZmluZCgiLmxheXVpLWNvbGxhLWNvbnRlbnQiKSwKICAgICAgICAgICAgICAgIGwgPSAibm9uZSIgPT09IGUuY3NzKCJkaXNwbGF5Iik7CiAgICAgICAgICAgIGEuZmluZCgiLmxheXVpLWNvbGxhLWljb24iKS5yZW1vdmUoKSwgYS5hcHBlbmQoJzxpIGNsYXNzPSJsYXl1aS1pY29uIGxheXVpLWNvbGxhLWljb24iPicgKyAobCA/ICImI3hlNjAyOyIgOiAiJiN4ZTYxYTsiKSArICI8L2k+IiksIGEub2ZmKCJjbGljayIsIGIuY29sbGFwc2UpLm9uKCJjbGljayIsIGIuY29sbGFwc2UpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIHNbdF0gPyBzW3RdKCkgOiBsYXl1aS5lYWNoKHMsIGZ1bmN0aW9uICh0LCBpKSB7CiAgICAgIGkoKTsKICAgIH0pOwogIH0sIHMucHJvdG90eXBlLnJlbmRlciA9IHMucHJvdG90eXBlLmluaXQ7CiAgdmFyIHYgPSBuZXcgcygpLAogICAgICBtID0gaShkb2N1bWVudCk7CiAgaShmdW5jdGlvbiAoKSB7CiAgICB2LnJlbmRlcigpOwogIH0pOwogIHZhciBDID0gIi5sYXl1aS10YWItdGl0bGUgbGkiOwogIG0ub24oImNsaWNrIiwgQywgYi50YWJDbGljayksIG0ub24oImNsaWNrIiwgYi5oaWRlVGFiTW9yZSksIGkod2luZG93KS5vbigicmVzaXplIiwgYi50YWJBdXRvKSwgdChlLCB2KTsKfSk7CmxheXVpLmRlZmluZSgibGF5ZXIiLCBmdW5jdGlvbiAoZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIHQgPSBsYXl1aS4kLAogICAgICBpID0gbGF5dWkubGF5ZXIsCiAgICAgIG4gPSBsYXl1aS5oaW50KCksCiAgICAgIG8gPSBsYXl1aS5kZXZpY2UoKSwKICAgICAgYSA9IHsKICAgIGNvbmZpZzoge30sCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChlKSB7CiAgICAgIHZhciBpID0gdGhpczsKICAgICAgcmV0dXJuIGkuY29uZmlnID0gdC5leHRlbmQoe30sIGkuY29uZmlnLCBlKSwgaTsKICAgIH0sCiAgICBvbjogZnVuY3Rpb24gb24oZSwgdCkgewogICAgICByZXR1cm4gbGF5dWkub25ldmVudC5jYWxsKHRoaXMsIHIsIGUsIHQpOwogICAgfQogIH0sCiAgICAgIGwgPSBmdW5jdGlvbiBsKCkgewogICAgdmFyIGUgPSB0aGlzOwogICAgcmV0dXJuIHsKICAgICAgdXBsb2FkOiBmdW5jdGlvbiB1cGxvYWQodCkgewogICAgICAgIGUudXBsb2FkLmNhbGwoZSwgdCk7CiAgICAgIH0sCiAgICAgIHJlbG9hZDogZnVuY3Rpb24gcmVsb2FkKHQpIHsKICAgICAgICBlLnJlbG9hZC5jYWxsKGUsIHQpOwogICAgICB9LAogICAgICBjb25maWc6IGUuY29uZmlnCiAgICB9OwogIH0sCiAgICAgIHIgPSAidXBsb2FkIiwKICAgICAgdSA9ICJsYXl1aS11cGxvYWQtZmlsZSIsCiAgICAgIGMgPSAibGF5dWktdXBsb2FkLWZvcm0iLAogICAgICBmID0gImxheXVpLXVwbG9hZC1pZnJhbWUiLAogICAgICBzID0gImxheXVpLXVwbG9hZC1jaG9vc2UiLAogICAgICBwID0gZnVuY3Rpb24gcChlKSB7CiAgICB2YXIgaSA9IHRoaXM7CiAgICBpLmNvbmZpZyA9IHQuZXh0ZW5kKHt9LCBpLmNvbmZpZywgYS5jb25maWcsIGUpLCBpLnJlbmRlcigpOwogIH07CgogIHAucHJvdG90eXBlLmNvbmZpZyA9IHsKICAgIGFjY2VwdDogImltYWdlcyIsCiAgICBleHRzOiAiIiwKICAgIGF1dG86ICEwLAogICAgYmluZEFjdGlvbjogIiIsCiAgICB1cmw6ICIiLAogICAgZmllbGQ6ICJmaWxlIiwKICAgIGFjY2VwdE1pbWU6ICIiLAogICAgbWV0aG9kOiAicG9zdCIsCiAgICBkYXRhOiB7fSwKICAgIGRyYWc6ICEwLAogICAgc2l6ZTogMCwKICAgIG51bWJlcjogMCwKICAgIG11bHRpcGxlOiAhMQogIH0sIHAucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgaSA9IHRoaXMsCiAgICAgICAgZSA9IGkuY29uZmlnOwogICAgZS5lbGVtID0gdChlLmVsZW0pLCBlLmJpbmRBY3Rpb24gPSB0KGUuYmluZEFjdGlvbiksIGkuZmlsZSgpLCBpLmV2ZW50cygpOwogIH0sIHAucHJvdG90eXBlLmZpbGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgaSA9IGUuY29uZmlnLAogICAgICAgIG4gPSBlLmVsZW1GaWxlID0gdChbJzxpbnB1dCBjbGFzcz0iJyArIHUgKyAnIiB0eXBlPSJmaWxlIiBhY2NlcHQ9IicgKyBpLmFjY2VwdE1pbWUgKyAnIiBuYW1lPSInICsgaS5maWVsZCArICciJywgaS5tdWx0aXBsZSA/ICIgbXVsdGlwbGUiIDogIiIsICI+Il0uam9pbigiIikpLAogICAgICAgIGEgPSBpLmVsZW0ubmV4dCgpOwogICAgKGEuaGFzQ2xhc3ModSkgfHwgYS5oYXNDbGFzcyhjKSkgJiYgYS5yZW1vdmUoKSwgby5pZSAmJiBvLmllIDwgMTAgJiYgaS5lbGVtLndyYXAoJzxkaXYgY2xhc3M9ImxheXVpLXVwbG9hZC13cmFwIj48L2Rpdj4nKSwgZS5pc0ZpbGUoKSA/IChlLmVsZW1GaWxlID0gaS5lbGVtLCBpLmZpZWxkID0gaS5lbGVtWzBdLm5hbWUpIDogaS5lbGVtLmFmdGVyKG4pLCBvLmllICYmIG8uaWUgPCAxMCAmJiBlLmluaXRJRSgpOwogIH0sIHAucHJvdG90eXBlLmluaXRJRSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICBpID0gZS5jb25maWcsCiAgICAgICAgbiA9IHQoJzxpZnJhbWUgaWQ9IicgKyBmICsgJyIgY2xhc3M9IicgKyBmICsgJyIgbmFtZT0iJyArIGYgKyAnIiBmcmFtZWJvcmRlcj0iMCI+PC9pZnJhbWU+JyksCiAgICAgICAgbyA9IHQoWyc8Zm9ybSB0YXJnZXQ9IicgKyBmICsgJyIgY2xhc3M9IicgKyBjICsgJyIgbWV0aG9kPSJwb3N0IiBrZXk9InNldC1taW5lIiBlbmN0eXBlPSJtdWx0aXBhcnQvZm9ybS1kYXRhIiBhY3Rpb249IicgKyBpLnVybCArICciPicsICI8L2Zvcm0+Il0uam9pbigiIikpOwogICAgdCgiIyIgKyBmKVswXSB8fCB0KCJib2R5IikuYXBwZW5kKG4pLCBpLmVsZW0ubmV4dCgpLmhhc0NsYXNzKGMpIHx8IChlLmVsZW1GaWxlLndyYXAobyksIGkuZWxlbS5uZXh0KCIuIiArIGMpLmFwcGVuZChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlID0gW107CiAgICAgIHJldHVybiBsYXl1aS5lYWNoKGkuZGF0YSwgZnVuY3Rpb24gKHQsIGkpIHsKICAgICAgICBpID0gImZ1bmN0aW9uIiA9PSB0eXBlb2YgaSA/IGkoKSA6IGksIGUucHVzaCgnPGlucHV0IHR5cGU9ImhpZGRlbiIgbmFtZT0iJyArIHQgKyAnIiB2YWx1ZT0iJyArIGkgKyAnIj4nKTsKICAgICAgfSksIGUuam9pbigiIik7CiAgICB9KCkpKTsKICB9LCBwLnByb3RvdHlwZS5tc2cgPSBmdW5jdGlvbiAoZSkgewogICAgcmV0dXJuIGkubXNnKGUsIHsKICAgICAgaWNvbjogMiwKICAgICAgc2hpZnQ6IDYKICAgIH0pOwogIH0sIHAucHJvdG90eXBlLmlzRmlsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcy5jb25maWcuZWxlbVswXTsKICAgIGlmIChlKSByZXR1cm4gImlucHV0IiA9PT0gZS50YWdOYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCkgJiYgImZpbGUiID09PSBlLnR5cGU7CiAgfSwgcC5wcm90b3R5cGUucHJldmlldyA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IHRoaXM7CiAgICB3aW5kb3cuRmlsZVJlYWRlciAmJiBsYXl1aS5lYWNoKHQuY2hvb3NlRmlsZXMsIGZ1bmN0aW9uICh0LCBpKSB7CiAgICAgIHZhciBuID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgbi5yZWFkQXNEYXRhVVJMKGkpLCBuLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBlICYmIGUodCwgaSwgdGhpcy5yZXN1bHQpOwogICAgICB9OwogICAgfSk7CiAgfSwgcC5wcm90b3R5cGUudXBsb2FkID0gZnVuY3Rpb24gKGUsIGkpIHsKICAgIHZhciBuLAogICAgICAgIGEgPSB0aGlzLAogICAgICAgIGwgPSBhLmNvbmZpZywKICAgICAgICByID0gYS5lbGVtRmlsZVswXSwKICAgICAgICB1ID0gZnVuY3Rpb24gdSgpIHsKICAgICAgdmFyIGkgPSAwLAogICAgICAgICAgbiA9IDAsCiAgICAgICAgICBvID0gZSB8fCBhLmZpbGVzIHx8IGEuY2hvb3NlRmlsZXMgfHwgci5maWxlcywKICAgICAgICAgIHUgPSBmdW5jdGlvbiB1KCkgewogICAgICAgIGwubXVsdGlwbGUgJiYgaSArIG4gPT09IGEuZmlsZUxlbmd0aCAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiBsLmFsbERvbmUgJiYgbC5hbGxEb25lKHsKICAgICAgICAgIHRvdGFsOiBhLmZpbGVMZW5ndGgsCiAgICAgICAgICBzdWNjZXNzZnVsOiBpLAogICAgICAgICAgYWJvcnRlZDogbgogICAgICAgIH0pOwogICAgICB9OwoKICAgICAgbGF5dWkuZWFjaChvLCBmdW5jdGlvbiAoZSwgbykgewogICAgICAgIHZhciByID0gbmV3IEZvcm1EYXRhKCk7CiAgICAgICAgci5hcHBlbmQobC5maWVsZCwgbyksIGxheXVpLmVhY2gobC5kYXRhLCBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICAgdCA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIHQgPyB0KCkgOiB0LCByLmFwcGVuZChlLCB0KTsKICAgICAgICB9KTsKICAgICAgICB2YXIgYyA9IHsKICAgICAgICAgIHVybDogbC51cmwsCiAgICAgICAgICB0eXBlOiAicG9zdCIsCiAgICAgICAgICBkYXRhOiByLAogICAgICAgICAgY29udGVudFR5cGU6ICExLAogICAgICAgICAgcHJvY2Vzc0RhdGE6ICExLAogICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwKICAgICAgICAgIGhlYWRlcnM6IGwuaGVhZGVycyB8fCB7fSwKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIHN1Y2Nlc3ModCkgewogICAgICAgICAgICBpKyssIGQoZSwgdCksIHUoKTsKICAgICAgICAgIH0sCiAgICAgICAgICBlcnJvcjogZnVuY3Rpb24gZXJyb3IoKSB7CiAgICAgICAgICAgIG4rKywgYS5tc2coIlx1OEJGN1x1NkM0Mlx1NEUwQVx1NEYyMFx1NjNBNVx1NTNFM1x1NTFGQVx1NzNCMFx1NUYwMlx1NUUzOCIpLCBtKGUpLCB1KCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAiZnVuY3Rpb24iID09IHR5cGVvZiBsLnByb2dyZXNzICYmIChjLnhociA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBpID0gdC5hamF4U2V0dGluZ3MueGhyKCk7CiAgICAgICAgICByZXR1cm4gaS51cGxvYWQuYWRkRXZlbnRMaXN0ZW5lcigicHJvZ3Jlc3MiLCBmdW5jdGlvbiAodCkgewogICAgICAgICAgICBpZiAodC5sZW5ndGhDb21wdXRhYmxlKSB7CiAgICAgICAgICAgICAgdmFyIGkgPSBNYXRoLmZsb29yKHQubG9hZGVkIC8gdC50b3RhbCAqIDEwMCk7CiAgICAgICAgICAgICAgbC5wcm9ncmVzcyhpLCBsLml0ZW0gPyBsLml0ZW1bMF0gOiBsLmVsZW1bMF0sIHQsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KSwgaTsKICAgICAgICB9KSwgdC5hamF4KGMpOwogICAgICB9KTsKICAgIH0sCiAgICAgICAgYyA9IGZ1bmN0aW9uIGMoKSB7CiAgICAgIHZhciBlID0gdCgiIyIgKyBmKTsKICAgICAgYS5lbGVtRmlsZS5wYXJlbnQoKS5zdWJtaXQoKSwgY2xlYXJJbnRlcnZhbChwLnRpbWVyKSwgcC50aW1lciA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdCwKICAgICAgICAgICAgaSA9IGUuY29udGVudHMoKS5maW5kKCJib2R5Iik7CgogICAgICAgIHRyeSB7CiAgICAgICAgICB0ID0gaS50ZXh0KCk7CiAgICAgICAgfSBjYXRjaCAobikgewogICAgICAgICAgYS5tc2coIlx1ODNCN1x1NTNENlx1NEUwQVx1NEYyMFx1NTQwRVx1NzY4NFx1NTRDRFx1NUU5NFx1NEZFMVx1NjA2Rlx1NTFGQVx1NzNCMFx1NUYwMlx1NUUzOCIpLCBjbGVhckludGVydmFsKHAudGltZXIpLCBtKCk7CiAgICAgICAgfQoKICAgICAgICB0ICYmIChjbGVhckludGVydmFsKHAudGltZXIpLCBpLmh0bWwoIiIpLCBkKDAsIHQpKTsKICAgICAgfSwgMzApOwogICAgfSwKICAgICAgICBkID0gZnVuY3Rpb24gZChlLCB0KSB7CiAgICAgIGlmIChhLmVsZW1GaWxlLm5leHQoIi4iICsgcykucmVtb3ZlKCksIHIudmFsdWUgPSAiIiwgIm9iamVjdCIgIT0gX3R5cGVvZih0KSkgdHJ5IHsKICAgICAgICB0ID0gSlNPTi5wYXJzZSh0KTsKICAgICAgfSBjYXRjaCAoaSkgewogICAgICAgIHJldHVybiB0ID0ge30sIGEubXNnKCJcdThCRjdcdTVCRjlcdTRFMEFcdTRGMjBcdTYzQTVcdTUzRTNcdThGRDRcdTU2REVcdTY3MDlcdTY1NDhKU09OIik7CiAgICAgIH0KICAgICAgImZ1bmN0aW9uIiA9PSB0eXBlb2YgbC5kb25lICYmIGwuZG9uZSh0LCBlIHx8IDAsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgYS51cGxvYWQoZSk7CiAgICAgIH0pOwogICAgfSwKICAgICAgICBtID0gZnVuY3Rpb24gbShlKSB7CiAgICAgIGwuYXV0byAmJiAoci52YWx1ZSA9ICIiKSwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgbC5lcnJvciAmJiBsLmVycm9yKGUgfHwgMCwgZnVuY3Rpb24gKGUpIHsKICAgICAgICBhLnVwbG9hZChlKTsKICAgICAgfSk7CiAgICB9LAogICAgICAgIGggPSBsLmV4dHMsCiAgICAgICAgdiA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHQgPSBbXTsKICAgICAgcmV0dXJuIGxheXVpLmVhY2goZSB8fCBhLmNob29zZUZpbGVzLCBmdW5jdGlvbiAoZSwgaSkgewogICAgICAgIHQucHVzaChpLm5hbWUpOwogICAgICB9KSwgdDsKICAgIH0oKSwKICAgICAgICBnID0gewogICAgICBwcmV2aWV3OiBmdW5jdGlvbiBwcmV2aWV3KGUpIHsKICAgICAgICBhLnByZXZpZXcoZSk7CiAgICAgIH0sCiAgICAgIHVwbG9hZDogZnVuY3Rpb24gdXBsb2FkKGUsIHQpIHsKICAgICAgICB2YXIgaSA9IHt9OwogICAgICAgIGlbZV0gPSB0LCBhLnVwbG9hZChpKTsKICAgICAgfSwKICAgICAgcHVzaEZpbGU6IGZ1bmN0aW9uIHB1c2hGaWxlKCkgewogICAgICAgIHJldHVybiBhLmZpbGVzID0gYS5maWxlcyB8fCB7fSwgbGF5dWkuZWFjaChhLmNob29zZUZpbGVzLCBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICAgYS5maWxlc1tlXSA9IHQ7CiAgICAgICAgfSksIGEuZmlsZXM7CiAgICAgIH0sCiAgICAgIHJlc2V0RmlsZTogZnVuY3Rpb24gcmVzZXRGaWxlKGUsIHQsIGkpIHsKICAgICAgICB2YXIgbiA9IG5ldyBGaWxlKFt0XSwgaSk7CiAgICAgICAgYS5maWxlcyA9IGEuZmlsZXMgfHwge30sIGEuZmlsZXNbZV0gPSBuOwogICAgICB9CiAgICB9LAogICAgICAgIHkgPSBmdW5jdGlvbiB5KCkgewogICAgICBpZiAoISgoImNob29zZSIgPT09IGkgfHwgbC5hdXRvKSAmJiAobC5jaG9vc2UgJiYgbC5jaG9vc2UoZyksICJjaG9vc2UiID09PSBpKSB8fCBsLmJlZm9yZSAmJiBsLmJlZm9yZShnKSA9PT0gITEpKSByZXR1cm4gby5pZSA/IG8uaWUgPiA5ID8gdSgpIDogYygpIDogdm9pZCB1KCk7CiAgICB9OwoKICAgIGlmICh2ID0gMCA9PT0gdi5sZW5ndGggPyByLnZhbHVlLm1hdGNoKC9bXlwvXFxdK1wuLisvZykgfHwgW10gfHwgIiIgOiB2LCAwICE9PSB2Lmxlbmd0aCkgewogICAgICBzd2l0Y2ggKGwuYWNjZXB0KSB7CiAgICAgICAgY2FzZSAiZmlsZSI6CiAgICAgICAgICBpZiAoaCAmJiAhUmVnRXhwKCJcXHdcXC4oIiArIGggKyAiKSQiLCAiaSIpLnRlc3QoZXNjYXBlKHYpKSkgcmV0dXJuIGEubXNnKCJcdTkwMDlcdTYyRTlcdTc2ODRcdTY1ODdcdTRFRjZcdTRFMkRcdTUzMDVcdTU0MkJcdTRFMERcdTY1MkZcdTYzMDFcdTc2ODRcdTY4M0NcdTVGMEYiKSwgci52YWx1ZSA9ICIiOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgInZpZGVvIjoKICAgICAgICAgIGlmICghUmVnRXhwKCJcXHdcXC4oIiArIChoIHx8ICJhdml8bXA0fHdtYXxybXZifHJtfGZsYXNofDNncHxmbHYiKSArICIpJCIsICJpIikudGVzdChlc2NhcGUodikpKSByZXR1cm4gYS5tc2coIlx1OTAwOVx1NjJFOVx1NzY4NFx1ODlDNlx1OTg5MVx1NEUyRFx1NTMwNVx1NTQyQlx1NEUwRFx1NjUyRlx1NjMwMVx1NzY4NFx1NjgzQ1x1NUYwRiIpLCByLnZhbHVlID0gIiI7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAiYXVkaW8iOgogICAgICAgICAgaWYgKCFSZWdFeHAoIlxcd1xcLigiICsgKGggfHwgIm1wM3x3YXZ8bWlkIikgKyAiKSQiLCAiaSIpLnRlc3QoZXNjYXBlKHYpKSkgcmV0dXJuIGEubXNnKCJcdTkwMDlcdTYyRTlcdTc2ODRcdTk3RjNcdTk4OTFcdTRFMkRcdTUzMDVcdTU0MkJcdTRFMERcdTY1MkZcdTYzMDFcdTc2ODRcdTY4M0NcdTVGMEYiKSwgci52YWx1ZSA9ICIiOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBpZiAobGF5dWkuZWFjaCh2LCBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICAgICBSZWdFeHAoIlxcd1xcLigiICsgKGggfHwgImpwZ3xwbmd8Z2lmfGJtcHxqcGVnJCIpICsgIikiLCAiaSIpLnRlc3QoZXNjYXBlKHQpKSB8fCAobiA9ICEwKTsKICAgICAgICAgIH0pLCBuKSByZXR1cm4gYS5tc2coIlx1OTAwOVx1NjJFOVx1NzY4NFx1NTZGRVx1NzI0N1x1NEUyRFx1NTMwNVx1NTQyQlx1NEUwRFx1NjUyRlx1NjMwMVx1NzY4NFx1NjgzQ1x1NUYwRiIpLCByLnZhbHVlID0gIiI7CiAgICAgIH0KCiAgICAgIGlmIChhLmZpbGVMZW5ndGggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHQgPSAwLAogICAgICAgICAgICBpID0gZSB8fCBhLmZpbGVzIHx8IGEuY2hvb3NlRmlsZXMgfHwgci5maWxlczsKICAgICAgICByZXR1cm4gbGF5dWkuZWFjaChpLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB0Kys7CiAgICAgICAgfSksIHQ7CiAgICAgIH0oKSwgbC5udW1iZXIgJiYgYS5maWxlTGVuZ3RoID4gbC5udW1iZXIpIHJldHVybiBhLm1zZygiXHU1NDBDXHU2NUY2XHU2NzAwXHU1OTFBXHU1M0VBXHU4MEZEXHU0RTBBXHU0RjIwXHU3Njg0XHU2NTcwXHU5MUNGXHU0RTNBXHVGRjFBIiArIGwubnVtYmVyKTsKCiAgICAgIGlmIChsLnNpemUgPiAwICYmICEoby5pZSAmJiBvLmllIDwgMTApKSB7CiAgICAgICAgdmFyIEY7CiAgICAgICAgaWYgKGxheXVpLmVhY2goYS5jaG9vc2VGaWxlcywgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgICAgIGlmICh0LnNpemUgPiAxMDI0ICogbC5zaXplKSB7CiAgICAgICAgICAgIHZhciBpID0gbC5zaXplIC8gMTAyNDsKICAgICAgICAgICAgaSA9IGkgPj0gMSA/IGkudG9GaXhlZCgyKSArICJNQiIgOiBsLnNpemUgKyAiS0IiLCByLnZhbHVlID0gIiIsIEYgPSBpOwogICAgICAgICAgfQogICAgICAgIH0pLCBGKSByZXR1cm4gYS5tc2coIlx1NjU4N1x1NEVGNlx1NEUwRFx1ODBGRFx1OEQ4NVx1OEZDNyIgKyBGKTsKICAgICAgfQoKICAgICAgeSgpOwogICAgfQogIH0sIHAucHJvdG90eXBlLnJlbG9hZCA9IGZ1bmN0aW9uIChlKSB7CiAgICBlID0gZSB8fCB7fSwgZGVsZXRlIGUuZWxlbSwgZGVsZXRlIGUuYmluZEFjdGlvbjsKICAgIHZhciBpID0gdGhpcywKICAgICAgICBlID0gaS5jb25maWcgPSB0LmV4dGVuZCh7fSwgaS5jb25maWcsIGEuY29uZmlnLCBlKSwKICAgICAgICBuID0gZS5lbGVtLm5leHQoKTsKICAgIG4uYXR0cih7CiAgICAgIG5hbWU6IGUubmFtZSwKICAgICAgYWNjZXB0OiBlLmFjY2VwdE1pbWUsCiAgICAgIG11bHRpcGxlOiBlLm11bHRpcGxlCiAgICB9KTsKICB9LCBwLnByb3RvdHlwZS5ldmVudHMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgaSA9IGUuY29uZmlnLAogICAgICAgIGEgPSBmdW5jdGlvbiBhKHQpIHsKICAgICAgZS5jaG9vc2VGaWxlcyA9IHt9LCBsYXl1aS5lYWNoKHQsIGZ1bmN0aW9uICh0LCBpKSB7CiAgICAgICAgdmFyIG4gPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICBlLmNob29zZUZpbGVzW24gKyAiLSIgKyB0XSA9IGk7CiAgICAgIH0pOwogICAgfSwKICAgICAgICBsID0gZnVuY3Rpb24gbCh0LCBuKSB7CiAgICAgIHZhciBvID0gZS5lbGVtRmlsZSwKICAgICAgICAgIGEgPSAoaS5pdGVtID8gaS5pdGVtIDogaS5lbGVtLCB0Lmxlbmd0aCA+IDEgPyB0Lmxlbmd0aCArICJcdTRFMkFcdTY1ODdcdTRFRjYiIDogKHRbMF0gfHwge30pLm5hbWUgfHwgb1swXS52YWx1ZS5tYXRjaCgvW15cL1xcXStcLi4rL2cpIHx8IFtdIHx8ICIiKTsKICAgICAgby5uZXh0KCkuaGFzQ2xhc3MocykgJiYgby5uZXh0KCkucmVtb3ZlKCksIGUudXBsb2FkKG51bGwsICJjaG9vc2UiKSwgZS5pc0ZpbGUoKSB8fCBpLmNob29zZSB8fCBvLmFmdGVyKCc8c3BhbiBjbGFzcz0ibGF5dWktaW5saW5lICcgKyBzICsgJyI+JyArIGEgKyAiPC9zcGFuPiIpOwogICAgfTsKCiAgICBpLmVsZW0ub2ZmKCJ1cGxvYWQuc3RhcnQiKS5vbigidXBsb2FkLnN0YXJ0IiwgZnVuY3Rpb24gKCkgewogICAgICB2YXIgbyA9IHQodGhpcyksCiAgICAgICAgICBhID0gby5hdHRyKCJsYXktZGF0YSIpOwogICAgICBpZiAoYSkgdHJ5IHsKICAgICAgICBhID0gbmV3IEZ1bmN0aW9uKCJyZXR1cm4gIiArIGEpKCksIGUuY29uZmlnID0gdC5leHRlbmQoe30sIGksIGEpOwogICAgICB9IGNhdGNoIChsKSB7CiAgICAgICAgbi5lcnJvcigiVXBsb2FkIGVsZW1lbnQgcHJvcGVydHkgbGF5LWRhdGEgY29uZmlndXJhdGlvbiBpdGVtIGhhcyBhIHN5bnRheCBlcnJvcjogIiArIGEpOwogICAgICB9CiAgICAgIGUuY29uZmlnLml0ZW0gPSBvLCBlLmVsZW1GaWxlWzBdLmNsaWNrKCk7CiAgICB9KSwgby5pZSAmJiBvLmllIDwgMTAgfHwgaS5lbGVtLm9mZigidXBsb2FkLm92ZXIiKS5vbigidXBsb2FkLm92ZXIiLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlID0gdCh0aGlzKTsKICAgICAgZS5hdHRyKCJsYXktb3ZlciIsICIiKTsKICAgIH0pLm9mZigidXBsb2FkLmxlYXZlIikub24oInVwbG9hZC5sZWF2ZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSB0KHRoaXMpOwogICAgICBlLnJlbW92ZUF0dHIoImxheS1vdmVyIik7CiAgICB9KS5vZmYoInVwbG9hZC5kcm9wIikub24oInVwbG9hZC5kcm9wIiwgZnVuY3Rpb24gKG4sIG8pIHsKICAgICAgdmFyIHIgPSB0KHRoaXMpLAogICAgICAgICAgdSA9IG8ub3JpZ2luYWxFdmVudC5kYXRhVHJhbnNmZXIuZmlsZXMgfHwgW107CiAgICAgIHIucmVtb3ZlQXR0cigibGF5LW92ZXIiKSwgYSh1KSwgaS5hdXRvID8gZS51cGxvYWQodSkgOiBsKHUpOwogICAgfSksIGUuZWxlbUZpbGUub2ZmKCJ1cGxvYWQuY2hhbmdlIikub24oInVwbG9hZC5jaGFuZ2UiLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB0ID0gdGhpcy5maWxlcyB8fCBbXTsKICAgICAgYSh0KSwgaS5hdXRvID8gZS51cGxvYWQoKSA6IGwodCk7CiAgICB9KSwgaS5iaW5kQWN0aW9uLm9mZigidXBsb2FkLmFjdGlvbiIpLm9uKCJ1cGxvYWQuYWN0aW9uIiwgZnVuY3Rpb24gKCkgewogICAgICBlLnVwbG9hZCgpOwogICAgfSksIGkuZWxlbS5kYXRhKCJoYXZlRXZlbnRzIikgfHwgKGUuZWxlbUZpbGUub24oImNoYW5nZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgdCh0aGlzKS50cmlnZ2VyKCJ1cGxvYWQuY2hhbmdlIik7CiAgICB9KSwgaS5lbGVtLm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgZS5pc0ZpbGUoKSB8fCB0KHRoaXMpLnRyaWdnZXIoInVwbG9hZC5zdGFydCIpOwogICAgfSksIGkuZHJhZyAmJiBpLmVsZW0ub24oImRyYWdvdmVyIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpLCB0KHRoaXMpLnRyaWdnZXIoInVwbG9hZC5vdmVyIik7CiAgICB9KS5vbigiZHJhZ2xlYXZlIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgdCh0aGlzKS50cmlnZ2VyKCJ1cGxvYWQubGVhdmUiKTsKICAgIH0pLm9uKCJkcm9wIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpLCB0KHRoaXMpLnRyaWdnZXIoInVwbG9hZC5kcm9wIiwgZSk7CiAgICB9KSwgaS5iaW5kQWN0aW9uLm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgdCh0aGlzKS50cmlnZ2VyKCJ1cGxvYWQuYWN0aW9uIik7CiAgICB9KSwgaS5lbGVtLmRhdGEoImhhdmVFdmVudHMiLCAhMCkpOwogIH0sIGEucmVuZGVyID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gbmV3IHAoZSk7CiAgICByZXR1cm4gbC5jYWxsKHQpOwogIH0sIGUociwgYSk7Cn0pOwpsYXl1aS5kZWZpbmUoWyJqcXVlcnkiLCAibGF5dHBsIiwgImxheSJdLCBmdW5jdGlvbiAoZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIGkgPSBsYXl1aS4kLAogICAgICBuID0gbGF5dWkubGF5dHBsLAogICAgICB0ID0gbGF5dWkuaGludCgpLAogICAgICBhID0gbGF5dWkuZGV2aWNlKCksCiAgICAgIGwgPSBhLm1vYmlsZSA/ICJjbGljayIgOiAibW91c2Vkb3duIiwKICAgICAgciA9ICJkcm9wZG93biIsCiAgICAgIG8gPSAibGF5dWlfIiArIHIgKyAiX2luZGV4IiwKICAgICAgdSA9IHsKICAgIGNvbmZpZzoge30sCiAgICBpbmRleDogbGF5dWlbcl0gPyBsYXl1aVtyXS5pbmRleCArIDFlNCA6IDAsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChlKSB7CiAgICAgIHZhciBuID0gdGhpczsKICAgICAgcmV0dXJuIG4uY29uZmlnID0gaS5leHRlbmQoe30sIG4uY29uZmlnLCBlKSwgbjsKICAgIH0sCiAgICBvbjogZnVuY3Rpb24gb24oZSwgaSkgewogICAgICByZXR1cm4gbGF5dWkub25ldmVudC5jYWxsKHRoaXMsIHIsIGUsIGkpOwogICAgfQogIH0sCiAgICAgIGQgPSBmdW5jdGlvbiBkKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIGkgPSBlLmNvbmZpZywKICAgICAgICBuID0gaS5pZDsKICAgIHJldHVybiBkLnRoYXRbbl0gPSBlLCB7CiAgICAgIGNvbmZpZzogaSwKICAgICAgcmVsb2FkOiBmdW5jdGlvbiByZWxvYWQoaSkgewogICAgICAgIGUucmVsb2FkLmNhbGwoZSwgaSk7CiAgICAgIH0KICAgIH07CiAgfSwKICAgICAgcyA9ICJsYXl1aS1kcm9wZG93biIsCiAgICAgIG0gPSAibGF5dWktbWVudS1pdGVtLXVwIiwKICAgICAgYyA9ICJsYXl1aS1tZW51LWl0ZW0tZG93biIsCiAgICAgIHAgPSAibGF5dWktbWVudS1ib2R5LXRpdGxlIiwKICAgICAgeSA9ICJsYXl1aS1tZW51LWl0ZW0tZ3JvdXAiLAogICAgICBmID0gImxheXVpLW1lbnUtaXRlbS1wYXJlbnQiLAogICAgICB2ID0gImxheXVpLW1lbnUtaXRlbS1kaXZpZGVyIiwKICAgICAgZyA9ICJsYXl1aS1tZW51LWl0ZW0tY2hlY2tlZCIsCiAgICAgIGggPSAibGF5dWktbWVudS1pdGVtLWNoZWNrZWQyIiwKICAgICAgdyA9ICJsYXl1aS1tZW51LWJvZHktcGFuZWwiLAogICAgICBDID0gImxheXVpLW1lbnUtYm9keS1wYW5lbC1sZWZ0IiwKICAgICAgViA9ICIuIiArIHkgKyAiPi4iICsgcCwKICAgICAgayA9IGZ1bmN0aW9uIGsoZSkgewogICAgdmFyIG4gPSB0aGlzOwogICAgbi5pbmRleCA9ICsrdS5pbmRleCwgbi5jb25maWcgPSBpLmV4dGVuZCh7fSwgbi5jb25maWcsIHUuY29uZmlnLCBlKSwgbi5pbml0KCk7CiAgfTsKCiAgay5wcm90b3R5cGUuY29uZmlnID0gewogICAgdHJpZ2dlcjogImNsaWNrIiwKICAgIGNvbnRlbnQ6ICIiLAogICAgY2xhc3NOYW1lOiAiIiwKICAgIHN0eWxlOiAiIiwKICAgIHNob3c6ICExLAogICAgaXNBbGxvd1NwcmVhZDogITAsCiAgICBpc1NwcmVhZEl0ZW06ICEwLAogICAgZGF0YTogW10sCiAgICBkZWxheTogMzAwCiAgfSwgay5wcm90b3R5cGUucmVsb2FkID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBuID0gdGhpczsKICAgIG4uY29uZmlnID0gaS5leHRlbmQoe30sIG4uY29uZmlnLCBlKSwgbi5pbml0KCEwKTsKICB9LCBrLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBuID0gdGhpcywKICAgICAgICB0ID0gbi5jb25maWcsCiAgICAgICAgYSA9IHQuZWxlbSA9IGkodC5lbGVtKTsKICAgIGlmIChhLmxlbmd0aCA+IDEpIHJldHVybiBsYXl1aS5lYWNoKGEsIGZ1bmN0aW9uICgpIHsKICAgICAgdS5yZW5kZXIoaS5leHRlbmQoe30sIHQsIHsKICAgICAgICBlbGVtOiB0aGlzCiAgICAgIH0pKTsKICAgIH0pLCBuOwoKICAgIGlmICghZSAmJiBhWzBdICYmIGEuZGF0YShvKSkgewogICAgICB2YXIgbCA9IGQuZ2V0VGhpcyhhLmRhdGEobykpOwogICAgICBpZiAoIWwpIHJldHVybjsKICAgICAgcmV0dXJuIGwucmVsb2FkKHQpOwogICAgfQoKICAgIHQuaWQgPSAiaWQiIGluIHQgPyB0LmlkIDogbi5pbmRleCwgdC5zaG93ICYmIG4ucmVuZGVyKGUpLCBuLmV2ZW50cygpOwogIH0sIGsucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgYSA9IHQuY29uZmlnLAogICAgICAgIHIgPSBpKCJib2R5IiksCiAgICAgICAgcyA9IGZ1bmN0aW9uIHMoKSB7CiAgICAgIHZhciBlID0gaSgnPHVsIGNsYXNzPSJsYXl1aS1tZW51IGxheXVpLWRyb3Bkb3duLW1lbnUiPjwvdWw+Jyk7CiAgICAgIHJldHVybiBhLmRhdGEubGVuZ3RoID4gMCA/IG0oZSwgYS5kYXRhKSA6IGUuaHRtbCgnPGxpIGNsYXNzPSJsYXl1aS1tZW51LWl0ZW0tbm9uZSI+bm8gbWVudTwvbGk+JyksIGU7CiAgICB9LAogICAgICAgIG0gPSBmdW5jdGlvbiBtKGUsIHQpIHsKICAgICAgcmV0dXJuIGxheXVpLmVhY2godCwgZnVuY3Rpb24gKHQsIGwpIHsKICAgICAgICB2YXIgciA9IGwuY2hpbGQgJiYgbC5jaGlsZC5sZW5ndGggPiAwLAogICAgICAgICAgICBvID0gImlzU3ByZWFkSXRlbSIgaW4gbCA/IGwuaXNTcHJlYWRJdGVtIDogYS5pc1NwcmVhZEl0ZW0sCiAgICAgICAgICAgIHUgPSBsLnRlbXBsZXQgPyBuKGwudGVtcGxldCkucmVuZGVyKGwpIDogYS50ZW1wbGV0ID8gbihhLnRlbXBsZXQpLnJlbmRlcihsKSA6IGwudGl0bGUsCiAgICAgICAgICAgIGQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gciAmJiAobC50eXBlID0gbC50eXBlIHx8ICJwYXJlbnQiKSwgbC50eXBlID8gewogICAgICAgICAgICBncm91cDogImdyb3VwIiwKICAgICAgICAgICAgcGFyZW50OiAicGFyZW50IiwKICAgICAgICAgICAgIi0iOiAiLSIKICAgICAgICAgIH1bbC50eXBlXSB8fCAicGFyZW50IiA6ICIiOwogICAgICAgIH0oKTsKCiAgICAgICAgaWYgKCItIiA9PT0gZCB8fCBsLnRpdGxlIHx8IGwuaWQgfHwgcikgewogICAgICAgICAgdmFyIHMgPSBpKFsiPGxpIiArIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGUgPSB7CiAgICAgICAgICAgICAgZ3JvdXA6ICJsYXl1aS1tZW51LWl0ZW0tZ3JvdXAiICsgKGEuaXNBbGxvd1NwcmVhZCA/IG8gPyAiIGxheXVpLW1lbnUtaXRlbS1kb3duIiA6ICIgbGF5dWktbWVudS1pdGVtLXVwIiA6ICIiKSwKICAgICAgICAgICAgICBwYXJlbnQ6IGYsCiAgICAgICAgICAgICAgIi0iOiAibGF5dWktbWVudS1pdGVtLWRpdmlkZXIiCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiByIHx8IGQgPyAnIGNsYXNzPSInICsgZVtkXSArICciJyA6ICIiOwogICAgICAgICAgfSgpICsgIj4iLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBlID0gImhyZWYiIGluIGwgPyAnPGEgaHJlZj0iJyArIGwuaHJlZiArICciIHRhcmdldD0iJyArIChsLnRhcmdldCB8fCAiX3NlbGYiKSArICciPicgKyB1ICsgIjwvYT4iIDogdTsKICAgICAgICAgICAgcmV0dXJuIHIgPyAnPGRpdiBjbGFzcz0iJyArIHAgKyAnIj4nICsgZSArIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gInBhcmVudCIgPT09IGQgPyAnPGkgY2xhc3M9ImxheXVpLWljb24gbGF5dWktaWNvbi1yaWdodCI+PC9pPicgOiAiZ3JvdXAiID09PSBkICYmIGEuaXNBbGxvd1NwcmVhZCA/ICc8aSBjbGFzcz0ibGF5dWktaWNvbiBsYXl1aS1pY29uLScgKyAobyA/ICJ1cCIgOiAiZG93biIpICsgJyI+PC9pPicgOiAiIjsKICAgICAgICAgICAgfSgpICsgIjwvZGl2PiIgOiAnPGRpdiBjbGFzcz0iJyArIHAgKyAnIj4nICsgZSArICI8L2Rpdj4iOwogICAgICAgICAgfSgpLCAiPC9saT4iXS5qb2luKCIiKSk7CgogICAgICAgICAgaWYgKHMuZGF0YSgiaXRlbSIsIGwpLCByKSB7CiAgICAgICAgICAgIHZhciBjID0gaSgnPGRpdiBjbGFzcz0ibGF5dWktcGFuZWwgbGF5dWktbWVudS1ib2R5LXBhbmVsIj48L2Rpdj4nKSwKICAgICAgICAgICAgICAgIHkgPSBpKCI8dWw+PC91bD4iKTsKICAgICAgICAgICAgInBhcmVudCIgPT09IGQgPyAoYy5hcHBlbmQobSh5LCBsLmNoaWxkKSksIHMuYXBwZW5kKGMpKSA6IHMuYXBwZW5kKG0oeSwgbC5jaGlsZCkpOwogICAgICAgICAgfQoKICAgICAgICAgIGUuYXBwZW5kKHMpOwogICAgICAgIH0KICAgICAgfSksIGU7CiAgICB9LAogICAgICAgIGMgPSBbJzxkaXYgY2xhc3M9ImxheXVpLWRyb3Bkb3duIGxheXVpLWJvcmRlci1ib3ggbGF5dWktcGFuZWwgbGF5dWktYW5pbSBsYXl1aS1hbmltLWRvd25iaXQiPicsICI8L2Rpdj4iXS5qb2luKCIiKTsKCiAgICAoImNvbnRleHRtZW51IiA9PT0gYS50cmlnZ2VyIHx8IGxheS5pc1RvcEVsZW0oYS5lbGVtWzBdKSkgJiYgKGUgPSAhMCksICFlICYmIGEuZWxlbS5kYXRhKG8gKyAiX29wZW5lZCIpIHx8ICh0LmVsZW1WaWV3ID0gaShjKSwgdC5lbGVtVmlldy5hcHBlbmQoYS5jb250ZW50IHx8IHMoKSksIGEuY2xhc3NOYW1lICYmIHQuZWxlbVZpZXcuYWRkQ2xhc3MoYS5jbGFzc05hbWUpLCBhLnN0eWxlICYmIHQuZWxlbVZpZXcuYXR0cigic3R5bGUiLCBhLnN0eWxlKSwgdS50aGlzSWQgPSBhLmlkLCB0LnJlbW92ZSgpLCByLmFwcGVuZCh0LmVsZW1WaWV3KSwgYS5lbGVtLmRhdGEobyArICJfb3BlbmVkIiwgITApLCB0LnBvc2l0aW9uKCksIGQucHJldkVsZW0gPSB0LmVsZW1WaWV3LCBkLnByZXZFbGVtLmRhdGEoInByZXZFbGVtIiwgYS5lbGVtKSwgdC5lbGVtVmlldy5maW5kKCIubGF5dWktbWVudSIpLm9uKGwsIGZ1bmN0aW9uIChlKSB7CiAgICAgIGxheXVpLnN0b3BlKGUpOwogICAgfSksIHQuZWxlbVZpZXcuZmluZCgiLmxheXVpLW1lbnUgbGkiKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgbiA9IGkodGhpcyksCiAgICAgICAgICBsID0gbi5kYXRhKCJpdGVtIikgfHwge30sCiAgICAgICAgICByID0gbC5jaGlsZCAmJiBsLmNoaWxkLmxlbmd0aCA+IDA7CiAgICAgIHIgfHwgIi0iID09PSBsLnR5cGUgfHwgKHQucmVtb3ZlKCksICJmdW5jdGlvbiIgPT0gdHlwZW9mIGEuY2xpY2sgJiYgYS5jbGljayhsLCBuKSk7CiAgICB9KSwgdC5lbGVtVmlldy5maW5kKFYpLm9uKCJjbGljayIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBuID0gaSh0aGlzKSwKICAgICAgICAgIHQgPSBuLnBhcmVudCgpLAogICAgICAgICAgbCA9IHQuZGF0YSgiaXRlbSIpIHx8IHt9OwogICAgICAiZ3JvdXAiID09PSBsLnR5cGUgJiYgYS5pc0FsbG93U3ByZWFkICYmIGQuc3ByZWFkKHQpOwogICAgfSksICJtb3VzZWVudGVyIiA9PT0gYS50cmlnZ2VyICYmIHQuZWxlbVZpZXcub24oIm1vdXNlZW50ZXIiLCBmdW5jdGlvbiAoKSB7CiAgICAgIGNsZWFyVGltZW91dChkLnRpbWVyKTsKICAgIH0pLm9uKCJtb3VzZWxlYXZlIiwgZnVuY3Rpb24gKCkgewogICAgICB0LmRlbGF5UmVtb3ZlKCk7CiAgICB9KSk7CiAgfSwgay5wcm90b3R5cGUucG9zaXRpb24gPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIGkgPSB0aGlzLAogICAgICAgIG4gPSBpLmNvbmZpZzsKICAgIGxheS5wb3NpdGlvbihuLmVsZW1bMF0sIGkuZWxlbVZpZXdbMF0sIHsKICAgICAgcG9zaXRpb246IG4ucG9zaXRpb24sCiAgICAgIGU6IGkuZSwKICAgICAgY2xpY2tUeXBlOiAiY29udGV4dG1lbnUiID09PSBuLnRyaWdnZXIgPyAicmlnaHQiIDogbnVsbCwKICAgICAgYWxpZ246IG4uYWxpZ24gfHwgbnVsbAogICAgfSk7CiAgfSwgay5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIGkgPSAoZS5jb25maWcsIGQucHJldkVsZW0pOwogICAgaSAmJiAoaS5kYXRhKCJwcmV2RWxlbSIpICYmIGkuZGF0YSgicHJldkVsZW0iKS5kYXRhKG8gKyAiX29wZW5lZCIsICExKSwgaS5yZW1vdmUoKSk7CiAgfSwgay5wcm90b3R5cGUuZGVsYXlSZW1vdmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgaSA9IGUuY29uZmlnOwogICAgY2xlYXJUaW1lb3V0KGQudGltZXIpLCBkLnRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGUucmVtb3ZlKCk7CiAgICB9LCBpLmRlbGF5KTsKICB9LCBrLnByb3RvdHlwZS5ldmVudHMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgaSA9IGUuY29uZmlnOwogICAgImhvdmVyIiA9PT0gaS50cmlnZ2VyICYmIChpLnRyaWdnZXIgPSAibW91c2VlbnRlciIpLCBlLnByZXZFbGVtICYmIGUucHJldkVsZW0ub2ZmKGkudHJpZ2dlciwgZS5wcmV2RWxlbUNhbGxiYWNrKSwgZS5wcmV2RWxlbSA9IGkuZWxlbSwgZS5wcmV2RWxlbUNhbGxiYWNrID0gZnVuY3Rpb24gKG4pIHsKICAgICAgY2xlYXJUaW1lb3V0KGQudGltZXIpLCBlLmUgPSBuLCBlLnJlbmRlcigpLCBuLnByZXZlbnREZWZhdWx0KCksICJmdW5jdGlvbiIgPT0gdHlwZW9mIGkucmVhZHkgJiYgaS5yZWFkeShlLmVsZW1WaWV3LCBpLmVsZW0sIGUuZS50YXJnZXQpOwogICAgfSwgaS5lbGVtLm9uKGkudHJpZ2dlciwgZS5wcmV2RWxlbUNhbGxiYWNrKSwgIm1vdXNlZW50ZXIiID09PSBpLnRyaWdnZXIgJiYgaS5lbGVtLm9uKCJtb3VzZWxlYXZlIiwgZnVuY3Rpb24gKCkgewogICAgICBlLmRlbGF5UmVtb3ZlKCk7CiAgICB9KTsKICB9LCBkLnRoYXQgPSB7fSwgZC5nZXRUaGlzID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBpID0gZC50aGF0W2VdOwogICAgcmV0dXJuIGkgfHwgdC5lcnJvcihlID8gciArICIgaW5zdGFuY2Ugd2l0aCBJRCAnIiArIGUgKyAiJyBub3QgZm91bmQiIDogIklEIGFyZ3VtZW50IHJlcXVpcmVkIiksIGk7CiAgfSwgZC5zcHJlYWQgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIGkgPSBlLmNoaWxkcmVuKCIuIiArIHApLmZpbmQoIi5sYXl1aS1pY29uIik7CiAgICBlLmhhc0NsYXNzKG0pID8gKGUucmVtb3ZlQ2xhc3MobSkuYWRkQ2xhc3MoYyksIGkucmVtb3ZlQ2xhc3MoImxheXVpLWljb24tZG93biIpLmFkZENsYXNzKCJsYXl1aS1pY29uLXVwIikpIDogKGUucmVtb3ZlQ2xhc3MoYykuYWRkQ2xhc3MobSksIGkucmVtb3ZlQ2xhc3MoImxheXVpLWljb24tdXAiKS5hZGRDbGFzcygibGF5dWktaWNvbi1kb3duIikpOwogIH0sICFmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IGkod2luZG93KSwKICAgICAgICBuID0gaShkb2N1bWVudCk7CiAgICBlLm9uKCJyZXNpemUiLCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh1LnRoaXNJZCkgewogICAgICAgIHZhciBlID0gZC5nZXRUaGlzKHUudGhpc0lkKTsKCiAgICAgICAgaWYgKGUpIHsKICAgICAgICAgIGlmICghZS5lbGVtVmlld1swXSB8fCAhaSgiLiIgKyBzKVswXSkgcmV0dXJuICExOwogICAgICAgICAgdmFyIG4gPSBlLmNvbmZpZzsKICAgICAgICAgICJjb250ZXh0bWVudSIgPT09IG4udHJpZ2dlciA/IGUucmVtb3ZlKCkgOiBlLnBvc2l0aW9uKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KSwgbi5vbihsLCBmdW5jdGlvbiAoZSkgewogICAgICBpZiAodS50aGlzSWQpIHsKICAgICAgICB2YXIgaSA9IGQuZ2V0VGhpcyh1LnRoaXNJZCk7CgogICAgICAgIGlmIChpKSB7CiAgICAgICAgICB2YXIgbiA9IGkuY29uZmlnOwogICAgICAgICAgIWxheS5pc1RvcEVsZW0obi5lbGVtWzBdKSAmJiAiY29udGV4dG1lbnUiICE9PSBuLnRyaWdnZXIgJiYgKGUudGFyZ2V0ID09PSBuLmVsZW1bMF0gfHwgbi5lbGVtLmZpbmQoZS50YXJnZXQpWzBdIHx8IGUudGFyZ2V0ID09PSBpLmVsZW1WaWV3WzBdIHx8IGkuZWxlbVZpZXcgJiYgaS5lbGVtVmlldy5maW5kKGUudGFyZ2V0KVswXSkgfHwgaS5yZW1vdmUoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHQgPSAiLmxheXVpLW1lbnU6bm90KC5sYXl1aS1kcm9wZG93bi1tZW51KSBsaSI7CiAgICBuLm9uKCJjbGljayIsIHQsIGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBuID0gaSh0aGlzKSwKICAgICAgICAgIHQgPSBuLnBhcmVudHMoIi5sYXl1aS1tZW51IikuZXEoMCksCiAgICAgICAgICBhID0gbi5oYXNDbGFzcyh5KSB8fCBuLmhhc0NsYXNzKGYpLAogICAgICAgICAgbCA9IHQuYXR0cigibGF5LWZpbHRlciIpIHx8IHQuYXR0cigiaWQiKSwKICAgICAgICAgIG8gPSBsYXkub3B0aW9ucyh0aGlzKTsKICAgICAgbi5oYXNDbGFzcyh2KSB8fCBhIHx8ICh0LmZpbmQoIi4iICsgZykucmVtb3ZlQ2xhc3MoZyksIHQuZmluZCgiLiIgKyBoKS5yZW1vdmVDbGFzcyhoKSwgbi5hZGRDbGFzcyhnKSwgbi5wYXJlbnRzKCIuIiArIGYpLmFkZENsYXNzKGgpLCBsYXl1aS5ldmVudC5jYWxsKHRoaXMsIHIsICJjbGljaygiICsgbCArICIpIiwgbykpOwogICAgfSksIG4ub24oImNsaWNrIiwgdCArIFYsIGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBuID0gaSh0aGlzKSwKICAgICAgICAgIHQgPSBuLnBhcmVudHMoIi4iICsgeSArICI6ZXEoMCkiKSwKICAgICAgICAgIGEgPSBsYXkub3B0aW9ucyh0WzBdKTsKICAgICAgImlzQWxsb3dTcHJlYWQiIGluIGEgJiYgIWEuaXNBbGxvd1NwcmVhZCB8fCBkLnNwcmVhZCh0KTsKICAgIH0pOwogICAgdmFyIGEgPSAiLmxheXVpLW1lbnUgLiIgKyBmOwogICAgbi5vbigibW91c2VlbnRlciIsIGEsIGZ1bmN0aW9uIChuKSB7CiAgICAgIHZhciB0ID0gaSh0aGlzKSwKICAgICAgICAgIGEgPSB0LmZpbmQoIi4iICsgdyk7CgogICAgICBpZiAoYVswXSkgewogICAgICAgIHZhciBsID0gYVswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICBsLnJpZ2h0ID4gZS53aWR0aCgpICYmIChhLmFkZENsYXNzKEMpLCBsID0gYVswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwgbC5sZWZ0IDwgMCAmJiBhLnJlbW92ZUNsYXNzKEMpKSwgbC5ib3R0b20gPiBlLmhlaWdodCgpICYmIGEuZXEoMCkuY3NzKCJtYXJnaW4tdG9wIiwgLShsLmJvdHRvbSAtIGUuaGVpZ2h0KCkpKTsKICAgICAgfQogICAgfSkub24oIm1vdXNlbGVhdmUiLCBhLCBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgbiA9IGkodGhpcyksCiAgICAgICAgICB0ID0gbi5jaGlsZHJlbigiLiIgKyB3KTsKICAgICAgdC5yZW1vdmVDbGFzcyhDKSwgdC5jc3MoIm1hcmdpbi10b3AiLCAwKTsKICAgIH0pOwogIH0oKSwgdS5yZWxvYWQgPSBmdW5jdGlvbiAoZSwgaSkgewogICAgdmFyIG4gPSBkLmdldFRoaXMoZSk7CiAgICByZXR1cm4gbiA/IChuLnJlbG9hZChpKSwgZC5jYWxsKG4pKSA6IHRoaXM7CiAgfSwgdS5yZW5kZXIgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIGkgPSBuZXcgayhlKTsKICAgIHJldHVybiBkLmNhbGwoaSk7CiAgfSwgZShyLCB1KTsKfSk7CmxheXVpLmRlZmluZSgianF1ZXJ5IiwgZnVuY3Rpb24gKGUpIHsKICAidXNlIHN0cmljdCI7CgogIHZhciBpID0gbGF5dWkuanF1ZXJ5LAogICAgICB0ID0gewogICAgY29uZmlnOiB7fSwKICAgIGluZGV4OiBsYXl1aS5zbGlkZXIgPyBsYXl1aS5zbGlkZXIuaW5kZXggKyAxZTQgOiAwLAogICAgc2V0OiBmdW5jdGlvbiBzZXQoZSkgewogICAgICB2YXIgdCA9IHRoaXM7CiAgICAgIHJldHVybiB0LmNvbmZpZyA9IGkuZXh0ZW5kKHt9LCB0LmNvbmZpZywgZSksIHQ7CiAgICB9LAogICAgb246IGZ1bmN0aW9uIG9uKGUsIGkpIHsKICAgICAgcmV0dXJuIGxheXVpLm9uZXZlbnQuY2FsbCh0aGlzLCBuLCBlLCBpKTsKICAgIH0KICB9LAogICAgICBhID0gZnVuY3Rpb24gYSgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICBpID0gZS5jb25maWc7CiAgICByZXR1cm4gewogICAgICBzZXRWYWx1ZTogZnVuY3Rpb24gc2V0VmFsdWUodCwgYSkgewogICAgICAgIHJldHVybiBpLnZhbHVlID0gdCwgZS5zbGlkZSgic2V0IiwgdCwgYSB8fCAwKTsKICAgICAgfSwKICAgICAgY29uZmlnOiBpCiAgICB9OwogIH0sCiAgICAgIG4gPSAic2xpZGVyIiwKICAgICAgbCA9ICJsYXl1aS1kaXNhYmxlZCIsCiAgICAgIHMgPSAibGF5dWktc2xpZGVyIiwKICAgICAgciA9ICJsYXl1aS1zbGlkZXItYmFyIiwKICAgICAgbyA9ICJsYXl1aS1zbGlkZXItd3JhcCIsCiAgICAgIHUgPSAibGF5dWktc2xpZGVyLXdyYXAtYnRuIiwKICAgICAgZCA9ICJsYXl1aS1zbGlkZXItdGlwcyIsCiAgICAgIHYgPSAibGF5dWktc2xpZGVyLWlucHV0IiwKICAgICAgYyA9ICJsYXl1aS1zbGlkZXItaW5wdXQtdHh0IiwKICAgICAgcCA9ICJsYXl1aS1zbGlkZXItaW5wdXQtYnRuIiwKICAgICAgbSA9ICJsYXl1aS1zbGlkZXItaG92ZXIiLAogICAgICBmID0gZnVuY3Rpb24gZihlKSB7CiAgICB2YXIgYSA9IHRoaXM7CiAgICBhLmluZGV4ID0gKyt0LmluZGV4LCBhLmNvbmZpZyA9IGkuZXh0ZW5kKHt9LCBhLmNvbmZpZywgdC5jb25maWcsIGUpLCBhLnJlbmRlcigpOwogIH07CgogIGYucHJvdG90eXBlLmNvbmZpZyA9IHsKICAgIHR5cGU6ICJkZWZhdWx0IiwKICAgIG1pbjogMCwKICAgIG1heDogMTAwLAogICAgdmFsdWU6IDAsCiAgICBzdGVwOiAxLAogICAgc2hvd3N0ZXA6ICExLAogICAgdGlwczogITAsCiAgICBpbnB1dDogITEsCiAgICByYW5nZTogITEsCiAgICBoZWlnaHQ6IDIwMCwKICAgIGRpc2FibGVkOiAhMSwKICAgIHRoZW1lOiAiIzAwOTY4OCIKICB9LCBmLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgdCA9IGUuY29uZmlnOwoKICAgIGlmICh0LnN0ZXAgPCAxICYmICh0LnN0ZXAgPSAxKSwgdC5tYXggPCB0Lm1pbiAmJiAodC5tYXggPSB0Lm1pbiArIHQuc3RlcCksIHQucmFuZ2UpIHsKICAgICAgdC52YWx1ZSA9ICJvYmplY3QiID09IF90eXBlb2YodC52YWx1ZSkgPyB0LnZhbHVlIDogW3QubWluLCB0LnZhbHVlXTsKICAgICAgdmFyIGEgPSBNYXRoLm1pbih0LnZhbHVlWzBdLCB0LnZhbHVlWzFdKSwKICAgICAgICAgIG4gPSBNYXRoLm1heCh0LnZhbHVlWzBdLCB0LnZhbHVlWzFdKTsKICAgICAgdC52YWx1ZVswXSA9IGEgPiB0Lm1pbiA/IGEgOiB0Lm1pbiwgdC52YWx1ZVsxXSA9IG4gPiB0Lm1pbiA/IG4gOiB0Lm1pbiwgdC52YWx1ZVswXSA9IHQudmFsdWVbMF0gPiB0Lm1heCA/IHQubWF4IDogdC52YWx1ZVswXSwgdC52YWx1ZVsxXSA9IHQudmFsdWVbMV0gPiB0Lm1heCA/IHQubWF4IDogdC52YWx1ZVsxXTsKICAgICAgdmFyIHIgPSBNYXRoLmZsb29yKCh0LnZhbHVlWzBdIC0gdC5taW4pIC8gKHQubWF4IC0gdC5taW4pICogMTAwKSwKICAgICAgICAgIHYgPSBNYXRoLmZsb29yKCh0LnZhbHVlWzFdIC0gdC5taW4pIC8gKHQubWF4IC0gdC5taW4pICogMTAwKSwKICAgICAgICAgIHAgPSB2IC0gciArICIlIjsKICAgICAgciArPSAiJSIsIHYgKz0gIiUiOwogICAgfSBlbHNlIHsKICAgICAgIm9iamVjdCIgPT0gX3R5cGVvZih0LnZhbHVlKSAmJiAodC52YWx1ZSA9IE1hdGgubWluLmFwcGx5KG51bGwsIHQudmFsdWUpKSwgdC52YWx1ZSA8IHQubWluICYmICh0LnZhbHVlID0gdC5taW4pLCB0LnZhbHVlID4gdC5tYXggJiYgKHQudmFsdWUgPSB0Lm1heCk7CiAgICAgIHZhciBwID0gTWF0aC5mbG9vcigodC52YWx1ZSAtIHQubWluKSAvICh0Lm1heCAtIHQubWluKSAqIDEwMCkgKyAiJSI7CiAgICB9CgogICAgdmFyIG0gPSB0LmRpc2FibGVkID8gIiNjMmMyYzIiIDogdC50aGVtZSwKICAgICAgICBmID0gJzxkaXYgY2xhc3M9ImxheXVpLXNsaWRlciAnICsgKCJ2ZXJ0aWNhbCIgPT09IHQudHlwZSA/ICJsYXl1aS1zbGlkZXItdmVydGljYWwiIDogIiIpICsgJyI+JyArICh0LnRpcHMgPyAnPGRpdiBjbGFzcz0ibGF5dWktc2xpZGVyLXRpcHMiPjwvZGl2PicgOiAiIikgKyAnPGRpdiBjbGFzcz0ibGF5dWktc2xpZGVyLWJhciIgc3R5bGU9ImJhY2tncm91bmQ6JyArIG0gKyAiOyAiICsgKCJ2ZXJ0aWNhbCIgPT09IHQudHlwZSA/ICJoZWlnaHQiIDogIndpZHRoIikgKyAiOiIgKyBwICsgIjsiICsgKCJ2ZXJ0aWNhbCIgPT09IHQudHlwZSA/ICJib3R0b20iIDogImxlZnQiKSArICI6IiArIChyIHx8IDApICsgJzsiPjwvZGl2PjxkaXYgY2xhc3M9ImxheXVpLXNsaWRlci13cmFwIiBzdHlsZT0iJyArICgidmVydGljYWwiID09PSB0LnR5cGUgPyAiYm90dG9tIiA6ICJsZWZ0IikgKyAiOiIgKyAociB8fCBwKSArICc7Ij48ZGl2IGNsYXNzPSJsYXl1aS1zbGlkZXItd3JhcC1idG4iIHN0eWxlPSJib3JkZXI6IDJweCBzb2xpZCAnICsgbSArICc7Ij48L2Rpdj48L2Rpdj4nICsgKHQucmFuZ2UgPyAnPGRpdiBjbGFzcz0ibGF5dWktc2xpZGVyLXdyYXAiIHN0eWxlPSInICsgKCJ2ZXJ0aWNhbCIgPT09IHQudHlwZSA/ICJib3R0b20iIDogImxlZnQiKSArICI6IiArIHYgKyAnOyI+PGRpdiBjbGFzcz0ibGF5dWktc2xpZGVyLXdyYXAtYnRuIiBzdHlsZT0iYm9yZGVyOiAycHggc29saWQgJyArIG0gKyAnOyI+PC9kaXY+PC9kaXY+JyA6ICIiKSArICI8L2Rpdj4iLAogICAgICAgIGggPSBpKHQuZWxlbSksCiAgICAgICAgeSA9IGgubmV4dCgiLiIgKyBzKTsKCiAgICBpZiAoeVswXSAmJiB5LnJlbW92ZSgpLCBlLmVsZW1UZW1wID0gaShmKSwgdC5yYW5nZSA/IChlLmVsZW1UZW1wLmZpbmQoIi4iICsgbykuZXEoMCkuZGF0YSgidmFsdWUiLCB0LnZhbHVlWzBdKSwgZS5lbGVtVGVtcC5maW5kKCIuIiArIG8pLmVxKDEpLmRhdGEoInZhbHVlIiwgdC52YWx1ZVsxXSkpIDogZS5lbGVtVGVtcC5maW5kKCIuIiArIG8pLmRhdGEoInZhbHVlIiwgdC52YWx1ZSksIGguaHRtbChlLmVsZW1UZW1wKSwgInZlcnRpY2FsIiA9PT0gdC50eXBlICYmIGUuZWxlbVRlbXAuaGVpZ2h0KHQuaGVpZ2h0ICsgInB4IiksIHQuc2hvd3N0ZXApIHsKICAgICAgZm9yICh2YXIgZyA9ICh0Lm1heCAtIHQubWluKSAvIHQuc3RlcCwgYiA9ICIiLCB4ID0gMTsgeCA8IGcgKyAxOyB4KyspIHsKICAgICAgICB2YXIgVCA9IDEwMCAqIHggLyBnOwogICAgICAgIFQgPCAxMDAgJiYgKGIgKz0gJzxkaXYgY2xhc3M9ImxheXVpLXNsaWRlci1zdGVwIiBzdHlsZT0iJyArICgidmVydGljYWwiID09PSB0LnR5cGUgPyAiYm90dG9tIiA6ICJsZWZ0IikgKyAiOiIgKyBUICsgJyUiPjwvZGl2PicpOwogICAgICB9CgogICAgICBlLmVsZW1UZW1wLmFwcGVuZChiKTsKICAgIH0KCiAgICBpZiAodC5pbnB1dCAmJiAhdC5yYW5nZSkgewogICAgICB2YXIgdyA9IGkoJzxkaXYgY2xhc3M9ImxheXVpLXNsaWRlci1pbnB1dCBsYXl1aS1pbnB1dCI+PGRpdiBjbGFzcz0ibGF5dWktc2xpZGVyLWlucHV0LXR4dCI+PGlucHV0IHR5cGU9InRleHQiIGNsYXNzPSJsYXl1aS1pbnB1dCI+PC9kaXY+PGRpdiBjbGFzcz0ibGF5dWktc2xpZGVyLWlucHV0LWJ0biI+PGkgY2xhc3M9ImxheXVpLWljb24gbGF5dWktaWNvbi11cCI+PC9pPjxpIGNsYXNzPSJsYXl1aS1pY29uIGxheXVpLWljb24tZG93biI+PC9pPjwvZGl2PjwvZGl2PicpOwogICAgICBoLmNzcygicG9zaXRpb24iLCAicmVsYXRpdmUiKSwgaC5hcHBlbmQodyksIGguZmluZCgiLiIgKyBjKS5jaGlsZHJlbigiaW5wdXQiKS52YWwodC52YWx1ZSksICJ2ZXJ0aWNhbCIgPT09IHQudHlwZSA/IHcuY3NzKHsKICAgICAgICBsZWZ0OiAwLAogICAgICAgIHRvcDogLTQ4CiAgICAgIH0pIDogZS5lbGVtVGVtcC5jc3MoIm1hcmdpbi1yaWdodCIsIHcub3V0ZXJXaWR0aCgpICsgMTUpOwogICAgfQoKICAgIHQuZGlzYWJsZWQgPyAoZS5lbGVtVGVtcC5hZGRDbGFzcyhsKSwgZS5lbGVtVGVtcC5maW5kKCIuIiArIHUpLmFkZENsYXNzKGwpKSA6IGUuc2xpZGUoKSwgZS5lbGVtVGVtcC5maW5kKCIuIiArIHUpLm9uKCJtb3VzZW92ZXIiLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhID0gInZlcnRpY2FsIiA9PT0gdC50eXBlID8gdC5oZWlnaHQgOiBlLmVsZW1UZW1wWzBdLm9mZnNldFdpZHRoLAogICAgICAgICAgbiA9IGUuZWxlbVRlbXAuZmluZCgiLiIgKyBvKSwKICAgICAgICAgIGwgPSAidmVydGljYWwiID09PSB0LnR5cGUgPyBhIC0gaSh0aGlzKS5wYXJlbnQoKVswXS5vZmZzZXRUb3AgLSBuLmhlaWdodCgpIDogaSh0aGlzKS5wYXJlbnQoKVswXS5vZmZzZXRMZWZ0LAogICAgICAgICAgcyA9IGwgLyBhICogMTAwLAogICAgICAgICAgciA9IGkodGhpcykucGFyZW50KCkuZGF0YSgidmFsdWUiKSwKICAgICAgICAgIHUgPSB0LnNldFRpcHMgPyB0LnNldFRpcHMocikgOiByOwogICAgICBlLmVsZW1UZW1wLmZpbmQoIi4iICsgZCkuaHRtbCh1KSwgInZlcnRpY2FsIiA9PT0gdC50eXBlID8gZS5lbGVtVGVtcC5maW5kKCIuIiArIGQpLmNzcyh7CiAgICAgICAgYm90dG9tOiBzICsgIiUiLAogICAgICAgICJtYXJnaW4tYm90dG9tIjogIjIwcHgiLAogICAgICAgIGRpc3BsYXk6ICJpbmxpbmUtYmxvY2siCiAgICAgIH0pIDogZS5lbGVtVGVtcC5maW5kKCIuIiArIGQpLmNzcyh7CiAgICAgICAgbGVmdDogcyArICIlIiwKICAgICAgICBkaXNwbGF5OiAiaW5saW5lLWJsb2NrIgogICAgICB9KTsKICAgIH0pLm9uKCJtb3VzZW91dCIsIGZ1bmN0aW9uICgpIHsKICAgICAgZS5lbGVtVGVtcC5maW5kKCIuIiArIGQpLmNzcygiZGlzcGxheSIsICJub25lIik7CiAgICB9KTsKICB9LCBmLnByb3RvdHlwZS5zbGlkZSA9IGZ1bmN0aW9uIChlLCB0LCBhKSB7CiAgICB2YXIgbiA9IHRoaXMsCiAgICAgICAgbCA9IG4uY29uZmlnLAogICAgICAgIHMgPSBuLmVsZW1UZW1wLAogICAgICAgIGYgPSBmdW5jdGlvbiBmKCkgewogICAgICByZXR1cm4gInZlcnRpY2FsIiA9PT0gbC50eXBlID8gbC5oZWlnaHQgOiBzWzBdLm9mZnNldFdpZHRoOwogICAgfSwKICAgICAgICBoID0gcy5maW5kKCIuIiArIG8pLAogICAgICAgIHkgPSBzLm5leHQoIi4iICsgdiksCiAgICAgICAgZyA9IHkuY2hpbGRyZW4oIi4iICsgYykuY2hpbGRyZW4oImlucHV0IikudmFsKCksCiAgICAgICAgYiA9IDEwMCAvICgobC5tYXggLSBsLm1pbikgLyBNYXRoLmNlaWwobC5zdGVwKSksCiAgICAgICAgeCA9IGZ1bmN0aW9uIHgoZSwgaSkgewogICAgICBlID0gTWF0aC5jZWlsKGUpICogYiA+IDEwMCA/IE1hdGguY2VpbChlKSAqIGIgOiBNYXRoLnJvdW5kKGUpICogYiwgZSA9IGUgPiAxMDAgPyAxMDAgOiBlLCBoLmVxKGkpLmNzcygidmVydGljYWwiID09PSBsLnR5cGUgPyAiYm90dG9tIiA6ICJsZWZ0IiwgZSArICIlIik7CiAgICAgIHZhciB0ID0gVChoWzBdLm9mZnNldExlZnQpLAogICAgICAgICAgYSA9IGwucmFuZ2UgPyBUKGhbMV0ub2Zmc2V0TGVmdCkgOiAwOwogICAgICAidmVydGljYWwiID09PSBsLnR5cGUgPyAocy5maW5kKCIuIiArIGQpLmNzcyh7CiAgICAgICAgYm90dG9tOiBlICsgIiUiLAogICAgICAgICJtYXJnaW4tYm90dG9tIjogIjIwcHgiCiAgICAgIH0pLCB0ID0gVChmKCkgLSBoWzBdLm9mZnNldFRvcCAtIGguaGVpZ2h0KCkpLCBhID0gbC5yYW5nZSA/IFQoZigpIC0gaFsxXS5vZmZzZXRUb3AgLSBoLmhlaWdodCgpKSA6IDApIDogcy5maW5kKCIuIiArIGQpLmNzcygibGVmdCIsIGUgKyAiJSIpLCB0ID0gdCA+IDEwMCA/IDEwMCA6IHQsIGEgPSBhID4gMTAwID8gMTAwIDogYTsKICAgICAgdmFyIG4gPSBNYXRoLm1pbih0LCBhKSwKICAgICAgICAgIG8gPSBNYXRoLmFicyh0IC0gYSk7CiAgICAgICJ2ZXJ0aWNhbCIgPT09IGwudHlwZSA/IHMuZmluZCgiLiIgKyByKS5jc3MoewogICAgICAgIGhlaWdodDogbyArICIlIiwKICAgICAgICBib3R0b206IG4gKyAiJSIKICAgICAgfSkgOiBzLmZpbmQoIi4iICsgcikuY3NzKHsKICAgICAgICB3aWR0aDogbyArICIlIiwKICAgICAgICBsZWZ0OiBuICsgIiUiCiAgICAgIH0pOwogICAgICB2YXIgdSA9IGwubWluICsgTWF0aC5yb3VuZCgobC5tYXggLSBsLm1pbikgKiBlIC8gMTAwKTsKCiAgICAgIGlmIChnID0gdSwgeS5jaGlsZHJlbigiLiIgKyBjKS5jaGlsZHJlbigiaW5wdXQiKS52YWwoZyksIGguZXEoaSkuZGF0YSgidmFsdWUiLCB1KSwgcy5maW5kKCIuIiArIGQpLmh0bWwobC5zZXRUaXBzID8gbC5zZXRUaXBzKHUpIDogdSksIGwucmFuZ2UpIHsKICAgICAgICB2YXIgdiA9IFtoLmVxKDApLmRhdGEoInZhbHVlIiksIGguZXEoMSkuZGF0YSgidmFsdWUiKV07CiAgICAgICAgdlswXSA+IHZbMV0gJiYgdi5yZXZlcnNlKCk7CiAgICAgIH0KCiAgICAgIGwuY2hhbmdlICYmIGwuY2hhbmdlKGwucmFuZ2UgPyB2IDogdSk7CiAgICB9LAogICAgICAgIFQgPSBmdW5jdGlvbiBUKGUpIHsKICAgICAgdmFyIGkgPSBlIC8gZigpICogMTAwIC8gYiwKICAgICAgICAgIHQgPSBNYXRoLnJvdW5kKGkpICogYjsKICAgICAgcmV0dXJuIGUgPT0gZigpICYmICh0ID0gTWF0aC5jZWlsKGkpICogYiksIHQ7CiAgICB9LAogICAgICAgIHcgPSBpKFsnPGRpdiBjbGFzcz0ibGF5dWktYXV4aWxpYXItbW92aW5nIiBpZD0iTEFZLXNsaWRlci1tb3ZpbmciPjwvZGl2J10uam9pbigiIikpLAogICAgICAgIE0gPSBmdW5jdGlvbiBNKGUsIHQpIHsKICAgICAgdmFyIGEgPSBmdW5jdGlvbiBhKCkgewogICAgICAgIHQgJiYgdCgpLCB3LnJlbW92ZSgpOwogICAgICB9OwoKICAgICAgaSgiI0xBWS1zbGlkZXItbW92aW5nIilbMF0gfHwgaSgiYm9keSIpLmFwcGVuZCh3KSwgdy5vbigibW91c2Vtb3ZlIiwgZSksIHcub24oIm1vdXNldXAiLCBhKS5vbigibW91c2VsZWF2ZSIsIGEpOwogICAgfTsKCiAgICBpZiAoInNldCIgPT09IGUpIHJldHVybiB4KHQsIGEpOwogICAgcy5maW5kKCIuIiArIHUpLmVhY2goZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIHQgPSBpKHRoaXMpOwogICAgICB0Lm9uKCJtb3VzZWRvd24iLCBmdW5jdGlvbiAoaSkgewogICAgICAgIGkgPSBpIHx8IHdpbmRvdy5ldmVudDsKICAgICAgICB2YXIgYSA9IHQucGFyZW50KClbMF0ub2Zmc2V0TGVmdCwKICAgICAgICAgICAgbiA9IGkuY2xpZW50WDsKICAgICAgICAidmVydGljYWwiID09PSBsLnR5cGUgJiYgKGEgPSBmKCkgLSB0LnBhcmVudCgpWzBdLm9mZnNldFRvcCAtIGguaGVpZ2h0KCksIG4gPSBpLmNsaWVudFkpOwoKICAgICAgICB2YXIgciA9IGZ1bmN0aW9uIHIoaSkgewogICAgICAgICAgaSA9IGkgfHwgd2luZG93LmV2ZW50OwogICAgICAgICAgdmFyIHIgPSBhICsgKCJ2ZXJ0aWNhbCIgPT09IGwudHlwZSA/IG4gLSBpLmNsaWVudFkgOiBpLmNsaWVudFggLSBuKTsKICAgICAgICAgIHIgPCAwICYmIChyID0gMCksIHIgPiBmKCkgJiYgKHIgPSBmKCkpOwogICAgICAgICAgdmFyIG8gPSByIC8gZigpICogMTAwIC8gYjsKICAgICAgICAgIHgobywgZSksIHQuYWRkQ2xhc3MobSksIHMuZmluZCgiLiIgKyBkKS5zaG93KCksIGkucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9LAogICAgICAgICAgICBvID0gZnVuY3Rpb24gbygpIHsKICAgICAgICAgIHQucmVtb3ZlQ2xhc3MobSksIHMuZmluZCgiLiIgKyBkKS5oaWRlKCk7CiAgICAgICAgfTsKCiAgICAgICAgTShyLCBvKTsKICAgICAgfSk7CiAgICB9KSwgcy5vbigiY2xpY2siLCBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgdCA9IGkoIi4iICsgdSk7CgogICAgICBpZiAoIXQuaXMoZXZlbnQudGFyZ2V0KSAmJiAwID09PSB0LmhhcyhldmVudC50YXJnZXQpLmxlbmd0aCAmJiB0Lmxlbmd0aCkgewogICAgICAgIHZhciBhLAogICAgICAgICAgICBuID0gInZlcnRpY2FsIiA9PT0gbC50eXBlID8gZigpIC0gZS5jbGllbnRZICsgaSh0aGlzKS5vZmZzZXQoKS50b3AgOiBlLmNsaWVudFggLSBpKHRoaXMpLm9mZnNldCgpLmxlZnQ7CiAgICAgICAgbiA8IDAgJiYgKG4gPSAwKSwgbiA+IGYoKSAmJiAobiA9IGYoKSk7CiAgICAgICAgdmFyIHMgPSBuIC8gZigpICogMTAwIC8gYjsKICAgICAgICBhID0gbC5yYW5nZSA/ICJ2ZXJ0aWNhbCIgPT09IGwudHlwZSA/IE1hdGguYWJzKG4gLSBwYXJzZUludChpKGhbMF0pLmNzcygiYm90dG9tIikpKSA+IE1hdGguYWJzKG4gLSBwYXJzZUludChpKGhbMV0pLmNzcygiYm90dG9tIikpKSA/IDEgOiAwIDogTWF0aC5hYnMobiAtIGhbMF0ub2Zmc2V0TGVmdCkgPiBNYXRoLmFicyhuIC0gaFsxXS5vZmZzZXRMZWZ0KSA/IDEgOiAwIDogMCwgeChzLCBhKSwgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9KSwgeS5jaGlsZHJlbigiLiIgKyBwKS5jaGlsZHJlbigiaSIpLmVhY2goZnVuY3Rpb24gKGUpIHsKICAgICAgaSh0aGlzKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZyA9IHkuY2hpbGRyZW4oIi4iICsgYykuY2hpbGRyZW4oImlucHV0IikudmFsKCksIGcgPSAxID09IGUgPyBnIC0gbC5zdGVwIDwgbC5taW4gPyBsLm1pbiA6IE51bWJlcihnKSAtIGwuc3RlcCA6IE51bWJlcihnKSArIGwuc3RlcCA+IGwubWF4ID8gbC5tYXggOiBOdW1iZXIoZykgKyBsLnN0ZXA7CiAgICAgICAgdmFyIGkgPSAoZyAtIGwubWluKSAvIChsLm1heCAtIGwubWluKSAqIDEwMCAvIGI7CiAgICAgICAgeChpLCAwKTsKICAgICAgfSk7CiAgICB9KTsKCiAgICB2YXIgcSA9IGZ1bmN0aW9uIHEoKSB7CiAgICAgIHZhciBlID0gdGhpcy52YWx1ZTsKICAgICAgZSA9IGlzTmFOKGUpID8gMCA6IGUsIGUgPSBlIDwgbC5taW4gPyBsLm1pbiA6IGUsIGUgPSBlID4gbC5tYXggPyBsLm1heCA6IGUsIHRoaXMudmFsdWUgPSBlOwogICAgICB2YXIgaSA9IChlIC0gbC5taW4pIC8gKGwubWF4IC0gbC5taW4pICogMTAwIC8gYjsKICAgICAgeChpLCAwKTsKICAgIH07CgogICAgeS5jaGlsZHJlbigiLiIgKyBjKS5jaGlsZHJlbigiaW5wdXQiKS5vbigia2V5ZG93biIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIDEzID09PSBlLmtleUNvZGUgJiYgKGUucHJldmVudERlZmF1bHQoKSwgcS5jYWxsKHRoaXMpKTsKICAgIH0pLm9uKCJjaGFuZ2UiLCBxKTsKICB9LCBmLnByb3RvdHlwZS5ldmVudHMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXM7CiAgICBlLmNvbmZpZzsKICB9LCB0LnJlbmRlciA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgaSA9IG5ldyBmKGUpOwogICAgcmV0dXJuIGEuY2FsbChpKTsKICB9LCBlKG4sIHQpOwp9KTsKbGF5dWkuZGVmaW5lKFsianF1ZXJ5IiwgImxheSJdLCBmdW5jdGlvbiAoZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIGkgPSBsYXl1aS5qcXVlcnksCiAgICAgIHIgPSBsYXl1aS5sYXksCiAgICAgIG8gPSBsYXl1aS5kZXZpY2UoKSwKICAgICAgbiA9IG8ubW9iaWxlID8gImNsaWNrIiA6ICJtb3VzZWRvd24iLAogICAgICBsID0gewogICAgY29uZmlnOiB7fSwKICAgIGluZGV4OiBsYXl1aS5jb2xvcnBpY2tlciA/IGxheXVpLmNvbG9ycGlja2VyLmluZGV4ICsgMWU0IDogMCwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgdmFyIHIgPSB0aGlzOwogICAgICByZXR1cm4gci5jb25maWcgPSBpLmV4dGVuZCh7fSwgci5jb25maWcsIGUpLCByOwogICAgfSwKICAgIG9uOiBmdW5jdGlvbiBvbihlLCBpKSB7CiAgICAgIHJldHVybiBsYXl1aS5vbmV2ZW50LmNhbGwodGhpcywgImNvbG9ycGlja2VyIiwgZSwgaSk7CiAgICB9CiAgfSwKICAgICAgdCA9IGZ1bmN0aW9uIHQoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgaSA9IGUuY29uZmlnOwogICAgcmV0dXJuIHsKICAgICAgY29uZmlnOiBpCiAgICB9OwogIH0sCiAgICAgIGMgPSAiY29sb3JwaWNrZXIiLAogICAgICBhID0gImxheXVpLXNob3ciLAogICAgICBzID0gImxheXVpLWNvbG9ycGlja2VyIiwKICAgICAgZiA9ICIubGF5dWktY29sb3JwaWNrZXItbWFpbiIsCiAgICAgIGQgPSAibGF5dWktaWNvbi1kb3duIiwKICAgICAgdSA9ICJsYXl1aS1pY29uLWNsb3NlIiwKICAgICAgcCA9ICJsYXl1aS1jb2xvcnBpY2tlci10cmlnZ2VyLXNwYW4iLAogICAgICBnID0gImxheXVpLWNvbG9ycGlja2VyLXRyaWdnZXItaSIsCiAgICAgIHYgPSAibGF5dWktY29sb3JwaWNrZXItc2lkZSIsCiAgICAgIGggPSAibGF5dWktY29sb3JwaWNrZXItc2lkZS1zbGlkZXIiLAogICAgICBiID0gImxheXVpLWNvbG9ycGlja2VyLWJhc2lzIiwKICAgICAgayA9ICJsYXl1aS1jb2xvcnBpY2tlci1hbHBoYS1iZ2NvbG9yIiwKICAgICAgeSA9ICJsYXl1aS1jb2xvcnBpY2tlci1hbHBoYS1zbGlkZXIiLAogICAgICBtID0gImxheXVpLWNvbG9ycGlja2VyLWJhc2lzLWN1cnNvciIsCiAgICAgIHggPSAibGF5dWktY29sb3JwaWNrZXItbWFpbi1pbnB1dCIsCiAgICAgIFAgPSBmdW5jdGlvbiBQKGUpIHsKICAgIHZhciBpID0gewogICAgICBoOiAwLAogICAgICBzOiAwLAogICAgICBiOiAwCiAgICB9LAogICAgICAgIHIgPSBNYXRoLm1pbihlLnIsIGUuZywgZS5iKSwKICAgICAgICBvID0gTWF0aC5tYXgoZS5yLCBlLmcsIGUuYiksCiAgICAgICAgbiA9IG8gLSByOwogICAgcmV0dXJuIGkuYiA9IG8sIGkucyA9IDAgIT0gbyA/IDI1NSAqIG4gLyBvIDogMCwgMCAhPSBpLnMgPyBlLnIgPT0gbyA/IGkuaCA9IChlLmcgLSBlLmIpIC8gbiA6IGUuZyA9PSBvID8gaS5oID0gMiArIChlLmIgLSBlLnIpIC8gbiA6IGkuaCA9IDQgKyAoZS5yIC0gZS5nKSAvIG4gOiBpLmggPSAtMSwgbyA9PSByICYmIChpLmggPSAwKSwgaS5oICo9IDYwLCBpLmggPCAwICYmIChpLmggKz0gMzYwKSwgaS5zICo9IDEwMCAvIDI1NSwgaS5iICo9IDEwMCAvIDI1NSwgaTsKICB9LAogICAgICBDID0gZnVuY3Rpb24gQyhlKSB7CiAgICB2YXIgZSA9IGUuaW5kZXhPZigiIyIpID4gLTEgPyBlLnN1YnN0cmluZygxKSA6IGU7CgogICAgaWYgKDMgPT0gZS5sZW5ndGgpIHsKICAgICAgdmFyIGkgPSBlLnNwbGl0KCIiKTsKICAgICAgZSA9IGlbMF0gKyBpWzBdICsgaVsxXSArIGlbMV0gKyBpWzJdICsgaVsyXTsKICAgIH0KCiAgICBlID0gcGFyc2VJbnQoZSwgMTYpOwogICAgdmFyIHIgPSB7CiAgICAgIHI6IGUgPj4gMTYsCiAgICAgIGc6ICg2NTI4MCAmIGUpID4+IDgsCiAgICAgIGI6IDI1NSAmIGUKICAgIH07CiAgICByZXR1cm4gUChyKTsKICB9LAogICAgICBCID0gZnVuY3Rpb24gQihlKSB7CiAgICB2YXIgaSA9IHt9LAogICAgICAgIHIgPSBlLmgsCiAgICAgICAgbyA9IDI1NSAqIGUucyAvIDEwMCwKICAgICAgICBuID0gMjU1ICogZS5iIC8gMTAwOwogICAgaWYgKDAgPT0gbykgaS5yID0gaS5nID0gaS5iID0gbjtlbHNlIHsKICAgICAgdmFyIGwgPSBuLAogICAgICAgICAgdCA9ICgyNTUgLSBvKSAqIG4gLyAyNTUsCiAgICAgICAgICBjID0gKGwgLSB0KSAqIChyICUgNjApIC8gNjA7CiAgICAgIDM2MCA9PSByICYmIChyID0gMCksIHIgPCA2MCA/IChpLnIgPSBsLCBpLmIgPSB0LCBpLmcgPSB0ICsgYykgOiByIDwgMTIwID8gKGkuZyA9IGwsIGkuYiA9IHQsIGkuciA9IGwgLSBjKSA6IHIgPCAxODAgPyAoaS5nID0gbCwgaS5yID0gdCwgaS5iID0gdCArIGMpIDogciA8IDI0MCA/IChpLmIgPSBsLCBpLnIgPSB0LCBpLmcgPSBsIC0gYykgOiByIDwgMzAwID8gKGkuYiA9IGwsIGkuZyA9IHQsIGkuciA9IHQgKyBjKSA6IHIgPCAzNjAgPyAoaS5yID0gbCwgaS5nID0gdCwgaS5iID0gbCAtIGMpIDogKGkuciA9IDAsIGkuZyA9IDAsIGkuYiA9IDApOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgcjogTWF0aC5yb3VuZChpLnIpLAogICAgICBnOiBNYXRoLnJvdW5kKGkuZyksCiAgICAgIGI6IE1hdGgucm91bmQoaS5iKQogICAgfTsKICB9LAogICAgICB3ID0gZnVuY3Rpb24gdyhlKSB7CiAgICB2YXIgciA9IEIoZSksCiAgICAgICAgbyA9IFtyLnIudG9TdHJpbmcoMTYpLCByLmcudG9TdHJpbmcoMTYpLCByLmIudG9TdHJpbmcoMTYpXTsKICAgIHJldHVybiBpLmVhY2gobywgZnVuY3Rpb24gKGUsIGkpIHsKICAgICAgMSA9PSBpLmxlbmd0aCAmJiAob1tlXSA9ICIwIiArIGkpOwogICAgfSksIG8uam9pbigiIik7CiAgfSwKICAgICAgRCA9IGZ1bmN0aW9uIEQoZSkgewogICAgdmFyIGkgPSAvWzAtOV17MSwzfS9nLAogICAgICAgIHIgPSBlLm1hdGNoKGkpIHx8IFtdOwogICAgcmV0dXJuIHsKICAgICAgcjogclswXSwKICAgICAgZzogclsxXSwKICAgICAgYjogclsyXQogICAgfTsKICB9LAogICAgICBqID0gaSh3aW5kb3cpLAogICAgICBFID0gaShkb2N1bWVudCksCiAgICAgIEYgPSBmdW5jdGlvbiBGKGUpIHsKICAgIHZhciByID0gdGhpczsKICAgIHIuaW5kZXggPSArK2wuaW5kZXgsIHIuY29uZmlnID0gaS5leHRlbmQoe30sIHIuY29uZmlnLCBsLmNvbmZpZywgZSksIHIucmVuZGVyKCk7CiAgfTsKCiAgRi5wcm90b3R5cGUuY29uZmlnID0gewogICAgY29sb3I6ICIiLAogICAgc2l6ZTogbnVsbCwKICAgIGFscGhhOiAhMSwKICAgIGZvcm1hdDogImhleCIsCiAgICBwcmVkZWZpbmU6ICExLAogICAgY29sb3JzOiBbIiMwMDk2ODgiLCAiIzVGQjg3OCIsICIjMUU5RkZGIiwgIiNGRjU3MjIiLCAiI0ZGQjgwMCIsICIjMDFBQUVEIiwgIiM5OTkiLCAiI2MwMCIsICIjZmY4YzAwIiwgIiNmZmQ3MDAiLCAiIzkwZWU5MCIsICIjMDBjZWQxIiwgIiMxZTkwZmYiLCAiI2M3MTU4NSIsICJyZ2IoMCwgMTg2LCAxODkpIiwgInJnYigyNTUsIDEyMCwgMCkiLCAicmdiKDI1MCwgMjEyLCAwKSIsICIjMzkzRDQ5IiwgInJnYmEoMCwwLDAsLjUpIiwgInJnYmEoMjU1LCA2OSwgMCwgMC42OCkiLCAicmdiYSgxNDQsIDI0MCwgMTQ0LCAwLjUpIiwgInJnYmEoMzEsIDE0NywgMjU1LCAwLjczKSJdCiAgfSwgRi5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIHIgPSBlLmNvbmZpZywKICAgICAgICBvID0gaShbJzxkaXYgY2xhc3M9ImxheXVpLXVuc2VsZWN0IGxheXVpLWNvbG9ycGlja2VyIj4nLCAiPHNwYW4gIiArICgicmdiIiA9PSByLmZvcm1hdCAmJiByLmFscGhhID8gJ2NsYXNzPSJsYXl1aS1jb2xvcnBpY2tlci10cmlnZ2VyLWJnY29sb3IiJyA6ICIiKSArICI+IiwgJzxzcGFuIGNsYXNzPSJsYXl1aS1jb2xvcnBpY2tlci10cmlnZ2VyLXNwYW4iICcsICdsYXktdHlwZT0iJyArICgicmdiIiA9PSByLmZvcm1hdCA/IHIuYWxwaGEgPyAicmdiYSIgOiAidG9yZ2IiIDogIiIpICsgJyIgJywgJ3N0eWxlPSInICsgZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9ICIiOwogICAgICByZXR1cm4gci5jb2xvciA/IChlID0gci5jb2xvciwgKHIuY29sb3IubWF0Y2goL1swLTldezEsM30vZykgfHwgW10pLmxlbmd0aCA+IDMgJiYgKHIuYWxwaGEgJiYgInJnYiIgPT0gci5mb3JtYXQgfHwgKGUgPSAiIyIgKyB3KFAoRChyLmNvbG9yKSkpKSksICJiYWNrZ3JvdW5kOiAiICsgZSkgOiBlOwogICAgfSgpICsgJyI+JywgJzxpIGNsYXNzPSJsYXl1aS1pY29uIGxheXVpLWNvbG9ycGlja2VyLXRyaWdnZXItaSAnICsgKHIuY29sb3IgPyBkIDogdSkgKyAnIj48L2k+JywgIjwvc3Bhbj4iLCAiPC9zcGFuPiIsICI8L2Rpdj4iXS5qb2luKCIiKSksCiAgICAgICAgbiA9IGkoci5lbGVtKTsKICAgIHIuc2l6ZSAmJiBvLmFkZENsYXNzKCJsYXl1aS1jb2xvcnBpY2tlci0iICsgci5zaXplKSwgbi5hZGRDbGFzcygibGF5dWktaW5saW5lIikuaHRtbChlLmVsZW1Db2xvckJveCA9IG8pLCBlLmNvbG9yID0gZS5lbGVtQ29sb3JCb3guZmluZCgiLiIgKyBwKVswXS5zdHlsZS5iYWNrZ3JvdW5kLCBlLmV2ZW50cygpOwogIH0sIEYucHJvdG90eXBlLnJlbmRlclBpY2tlciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICByID0gZS5jb25maWcsCiAgICAgICAgbyA9IGUuZWxlbUNvbG9yQm94WzBdLAogICAgICAgIG4gPSBlLmVsZW1QaWNrZXIgPSBpKFsnPGRpdiBpZD0ibGF5dWktY29sb3JwaWNrZXInICsgZS5pbmRleCArICciIGRhdGEtaW5kZXg9IicgKyBlLmluZGV4ICsgJyIgY2xhc3M9ImxheXVpLWFuaW0gbGF5dWktYW5pbS1kb3duYml0IGxheXVpLWNvbG9ycGlja2VyLW1haW4iPicsICc8ZGl2IGNsYXNzPSJsYXl1aS1jb2xvcnBpY2tlci1tYWluLXdyYXBwZXIiPicsICc8ZGl2IGNsYXNzPSJsYXl1aS1jb2xvcnBpY2tlci1iYXNpcyI+JywgJzxkaXYgY2xhc3M9ImxheXVpLWNvbG9ycGlja2VyLWJhc2lzLXdoaXRlIj48L2Rpdj4nLCAnPGRpdiBjbGFzcz0ibGF5dWktY29sb3JwaWNrZXItYmFzaXMtYmxhY2siPjwvZGl2PicsICc8ZGl2IGNsYXNzPSJsYXl1aS1jb2xvcnBpY2tlci1iYXNpcy1jdXJzb3IiPjwvZGl2PicsICI8L2Rpdj4iLCAnPGRpdiBjbGFzcz0ibGF5dWktY29sb3JwaWNrZXItc2lkZSI+JywgJzxkaXYgY2xhc3M9ImxheXVpLWNvbG9ycGlja2VyLXNpZGUtc2xpZGVyIj48L2Rpdj4nLCAiPC9kaXY+IiwgIjwvZGl2PiIsICc8ZGl2IGNsYXNzPSJsYXl1aS1jb2xvcnBpY2tlci1tYWluLWFscGhhICcgKyAoci5hbHBoYSA/IGEgOiAiIikgKyAnIj4nLCAnPGRpdiBjbGFzcz0ibGF5dWktY29sb3JwaWNrZXItYWxwaGEtYmdjb2xvciI+JywgJzxkaXYgY2xhc3M9ImxheXVpLWNvbG9ycGlja2VyLWFscGhhLXNsaWRlciI+PC9kaXY+JywgIjwvZGl2PiIsICI8L2Rpdj4iLCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChyLnByZWRlZmluZSkgewogICAgICAgIHZhciBlID0gWyc8ZGl2IGNsYXNzPSJsYXl1aS1jb2xvcnBpY2tlci1tYWluLXByZSI+J107CiAgICAgICAgcmV0dXJuIGxheXVpLmVhY2goci5jb2xvcnMsIGZ1bmN0aW9uIChpLCByKSB7CiAgICAgICAgICBlLnB1c2goWyc8ZGl2IGNsYXNzPSJsYXl1aS1jb2xvcnBpY2tlci1wcmUnICsgKChyLm1hdGNoKC9bMC05XXsxLDN9L2cpIHx8IFtdKS5sZW5ndGggPiAzID8gIiBsYXl1aS1jb2xvcnBpY2tlci1wcmUtaXNhbHBoYSIgOiAiIikgKyAnIj4nLCAnPGRpdiBzdHlsZT0iYmFja2dyb3VuZDonICsgciArICciPjwvZGl2PicsICI8L2Rpdj4iXS5qb2luKCIiKSk7CiAgICAgICAgfSksIGUucHVzaCgiPC9kaXY+IiksIGUuam9pbigiIik7CiAgICAgIH0KCiAgICAgIHJldHVybiAiIjsKICAgIH0oKSwgJzxkaXYgY2xhc3M9ImxheXVpLWNvbG9ycGlja2VyLW1haW4taW5wdXQiPicsICc8ZGl2IGNsYXNzPSJsYXl1aS1pbmxpbmUiPicsICc8aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9ImxheXVpLWlucHV0Ij4nLCAiPC9kaXY+IiwgJzxkaXYgY2xhc3M9ImxheXVpLWJ0bi1jb250YWluZXIiPicsICI8YnV0dG9uIGNsYXNzPVwibGF5dWktYnRuIGxheXVpLWJ0bi1wcmltYXJ5IGxheXVpLWJ0bi1zbVwiIGNvbG9ycGlja2VyLWV2ZW50cz1cImNsZWFyXCI+XHU2RTA1XHU3QTdBPC9idXR0b24+IiwgIjxidXR0b24gY2xhc3M9XCJsYXl1aS1idG4gbGF5dWktYnRuLXNtXCIgY29sb3JwaWNrZXItZXZlbnRzPVwiY29uZmlybVwiPlx1Nzg2RVx1NUI5QTwvYnV0dG9uPiIsICI8L2RpdiIsICI8L2Rpdj4iLCAiPC9kaXY+Il0uam9pbigiIikpOwogICAgZS5lbGVtQ29sb3JCb3guZmluZCgiLiIgKyBwKVswXTsKICAgIGkoZilbMF0gJiYgaShmKS5kYXRhKCJpbmRleCIpID09IGUuaW5kZXggPyBlLnJlbW92ZVBpY2tlcihGLnRoaXNFbGVtSW5kKSA6IChlLnJlbW92ZVBpY2tlcihGLnRoaXNFbGVtSW5kKSwgaSgiYm9keSIpLmFwcGVuZChuKSksIEYudGhpc0VsZW1JbmQgPSBlLmluZGV4LCBGLnRoaXNDb2xvciA9IG8uc3R5bGUuYmFja2dyb3VuZCwgZS5wb3NpdGlvbigpLCBlLnBpY2tlckV2ZW50cygpOwogIH0sIEYucHJvdG90eXBlLnJlbW92ZVBpY2tlciA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgciA9IHRoaXM7CiAgICByLmNvbmZpZzsKICAgIHJldHVybiBpKCIjbGF5dWktY29sb3JwaWNrZXIiICsgKGUgfHwgci5pbmRleCkpLnJlbW92ZSgpLCByOwogIH0sIEYucHJvdG90eXBlLnBvc2l0aW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIGkgPSBlLmNvbmZpZzsKICAgIHJldHVybiByLnBvc2l0aW9uKGUuYmluZEVsZW0gfHwgZS5lbGVtQ29sb3JCb3hbMF0sIGUuZWxlbVBpY2tlclswXSwgewogICAgICBwb3NpdGlvbjogaS5wb3NpdGlvbiwKICAgICAgYWxpZ246ICJjZW50ZXIiCiAgICB9KSwgZTsKICB9LCBGLnByb3RvdHlwZS52YWwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgaSA9IChlLmNvbmZpZywgZS5lbGVtQ29sb3JCb3guZmluZCgiLiIgKyBwKSksCiAgICAgICAgciA9IGUuZWxlbVBpY2tlci5maW5kKCIuIiArIHgpLAogICAgICAgIG8gPSBpWzBdLAogICAgICAgIG4gPSBvLnN0eWxlLmJhY2tncm91bmRDb2xvcjsKCiAgICBpZiAobikgewogICAgICB2YXIgbCA9IFAoRChuKSksCiAgICAgICAgICB0ID0gaS5hdHRyKCJsYXktdHlwZSIpOwoKICAgICAgaWYgKGUuc2VsZWN0KGwuaCwgbC5zLCBsLmIpLCAidG9yZ2IiID09PSB0ICYmIHIuZmluZCgiaW5wdXQiKS52YWwobiksICJyZ2JhIiA9PT0gdCkgewogICAgICAgIHZhciBjID0gRChuKTsKICAgICAgICBpZiAoMyA9PSAobi5tYXRjaCgvWzAtOV17MSwzfS9nKSB8fCBbXSkubGVuZ3RoKSByLmZpbmQoImlucHV0IikudmFsKCJyZ2JhKCIgKyBjLnIgKyAiLCAiICsgYy5nICsgIiwgIiArIGMuYiArICIsIDEpIiksIGUuZWxlbVBpY2tlci5maW5kKCIuIiArIHkpLmNzcygibGVmdCIsIDI4MCk7ZWxzZSB7CiAgICAgICAgICByLmZpbmQoImlucHV0IikudmFsKG4pOwogICAgICAgICAgdmFyIGEgPSAyODAgKiBuLnNsaWNlKG4ubGFzdEluZGV4T2YoIiwiKSArIDEsIG4ubGVuZ3RoIC0gMSk7CiAgICAgICAgICBlLmVsZW1QaWNrZXIuZmluZCgiLiIgKyB5KS5jc3MoImxlZnQiLCBhKTsKICAgICAgICB9CiAgICAgICAgZS5lbGVtUGlja2VyLmZpbmQoIi4iICsgaylbMF0uc3R5bGUuYmFja2dyb3VuZCA9ICJsaW5lYXItZ3JhZGllbnQodG8gcmlnaHQsIHJnYmEoIiArIGMuciArICIsICIgKyBjLmcgKyAiLCAiICsgYy5iICsgIiwgMCksIHJnYigiICsgYy5yICsgIiwgIiArIGMuZyArICIsICIgKyBjLmIgKyAiKSkiOwogICAgICB9CiAgICB9IGVsc2UgZS5zZWxlY3QoMCwgMTAwLCAxMDApLCByLmZpbmQoImlucHV0IikudmFsKCIiKSwgZS5lbGVtUGlja2VyLmZpbmQoIi4iICsgaylbMF0uc3R5bGUuYmFja2dyb3VuZCA9ICIiLCBlLmVsZW1QaWNrZXIuZmluZCgiLiIgKyB5KS5jc3MoImxlZnQiLCAyODApOwogIH0sIEYucHJvdG90eXBlLnNpZGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgciA9IGUuY29uZmlnLAogICAgICAgIG8gPSBlLmVsZW1Db2xvckJveC5maW5kKCIuIiArIHApLAogICAgICAgIG4gPSBvLmF0dHIoImxheS10eXBlIiksCiAgICAgICAgbCA9IGUuZWxlbVBpY2tlci5maW5kKCIuIiArIHYpLAogICAgICAgIHQgPSBlLmVsZW1QaWNrZXIuZmluZCgiLiIgKyBoKSwKICAgICAgICBjID0gZS5lbGVtUGlja2VyLmZpbmQoIi4iICsgYiksCiAgICAgICAgYSA9IGUuZWxlbVBpY2tlci5maW5kKCIuIiArIG0pLAogICAgICAgIHMgPSBlLmVsZW1QaWNrZXIuZmluZCgiLiIgKyBrKSwKICAgICAgICBmID0gZS5lbGVtUGlja2VyLmZpbmQoIi4iICsgeSksCiAgICAgICAgQyA9IHRbMF0ub2Zmc2V0VG9wIC8gMTgwICogMzYwLAogICAgICAgIHcgPSAxMDAgLSAoYVswXS5vZmZzZXRUb3AgKyAzKSAvIDE4MCAqIDEwMCwKICAgICAgICBFID0gKGFbMF0ub2Zmc2V0TGVmdCArIDMpIC8gMjYwICogMTAwLAogICAgICAgIEYgPSBNYXRoLnJvdW5kKGZbMF0ub2Zmc2V0TGVmdCAvIDI4MCAqIDEwMCkgLyAxMDAsCiAgICAgICAgSCA9IGUuZWxlbUNvbG9yQm94LmZpbmQoIi4iICsgZyksCiAgICAgICAgTSA9IGUuZWxlbVBpY2tlci5maW5kKCIubGF5dWktY29sb3JwaWNrZXItcHJlIikuY2hpbGRyZW4oImRpdiIpLAogICAgICAgIFkgPSBmdW5jdGlvbiBZKGksIGwsIHQsIGMpIHsKICAgICAgZS5zZWxlY3QoaSwgbCwgdCk7CiAgICAgIHZhciBhID0gQih7CiAgICAgICAgaDogaSwKICAgICAgICBzOiBsLAogICAgICAgIGI6IHQKICAgICAgfSk7CgogICAgICBpZiAoSC5hZGRDbGFzcyhkKS5yZW1vdmVDbGFzcyh1KSwgb1swXS5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYigiICsgYS5yICsgIiwgIiArIGEuZyArICIsICIgKyBhLmIgKyAiKSIsICJ0b3JnYiIgPT09IG4gJiYgZS5lbGVtUGlja2VyLmZpbmQoIi4iICsgeCkuZmluZCgiaW5wdXQiKS52YWwoInJnYigiICsgYS5yICsgIiwgIiArIGEuZyArICIsICIgKyBhLmIgKyAiKSIpLCAicmdiYSIgPT09IG4pIHsKICAgICAgICB2YXIgcCA9IDA7CiAgICAgICAgcCA9IDI4MCAqIGMsIGYuY3NzKCJsZWZ0IiwgcCksIGUuZWxlbVBpY2tlci5maW5kKCIuIiArIHgpLmZpbmQoImlucHV0IikudmFsKCJyZ2JhKCIgKyBhLnIgKyAiLCAiICsgYS5nICsgIiwgIiArIGEuYiArICIsICIgKyBjICsgIikiKSwgb1swXS5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoIiArIGEuciArICIsICIgKyBhLmcgKyAiLCAiICsgYS5iICsgIiwgIiArIGMgKyAiKSIsIHNbMF0uc3R5bGUuYmFja2dyb3VuZCA9ICJsaW5lYXItZ3JhZGllbnQodG8gcmlnaHQsIHJnYmEoIiArIGEuciArICIsICIgKyBhLmcgKyAiLCAiICsgYS5iICsgIiwgMCksIHJnYigiICsgYS5yICsgIiwgIiArIGEuZyArICIsICIgKyBhLmIgKyAiKSkiOwogICAgICB9CgogICAgICByLmNoYW5nZSAmJiByLmNoYW5nZShlLmVsZW1QaWNrZXIuZmluZCgiLiIgKyB4KS5maW5kKCJpbnB1dCIpLnZhbCgpKTsKICAgIH0sCiAgICAgICAgSSA9IGkoWyc8ZGl2IGNsYXNzPSJsYXl1aS1hdXhpbGlhci1tb3ZpbmciIGlkPSJMQVktY29sb3JwaWNrZXItbW92aW5nIj48L2Rpdj4nXS5qb2luKCIiKSksCiAgICAgICAgTCA9IGZ1bmN0aW9uIEwoZSkgewogICAgICBpKCIjTEFZLWNvbG9ycGlja2VyLW1vdmluZyIpWzBdIHx8IGkoImJvZHkiKS5hcHBlbmQoSSksIEkub24oIm1vdXNlbW92ZSIsIGUpLCBJLm9uKCJtb3VzZXVwIiwgZnVuY3Rpb24gKCkgewogICAgICAgIEkucmVtb3ZlKCk7CiAgICAgIH0pLm9uKCJtb3VzZWxlYXZlIiwgZnVuY3Rpb24gKCkgewogICAgICAgIEkucmVtb3ZlKCk7CiAgICAgIH0pOwogICAgfTsKCiAgICB0Lm9uKCJtb3VzZWRvd24iLCBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgaSA9IHRoaXMub2Zmc2V0VG9wLAogICAgICAgICAgciA9IGUuY2xpZW50WSwKICAgICAgICAgIG8gPSBmdW5jdGlvbiBvKGUpIHsKICAgICAgICB2YXIgbyA9IGkgKyAoZS5jbGllbnRZIC0gciksCiAgICAgICAgICAgIG4gPSBsWzBdLm9mZnNldEhlaWdodDsKICAgICAgICBvIDwgMCAmJiAobyA9IDApLCBvID4gbiAmJiAobyA9IG4pOwogICAgICAgIHZhciB0ID0gbyAvIDE4MCAqIDM2MDsKICAgICAgICBDID0gdCwgWSh0LCBFLCB3LCBGKSwgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9OwoKICAgICAgTChvKSwgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgfSksIGwub24oImNsaWNrIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIHIgPSBlLmNsaWVudFkgLSBpKHRoaXMpLm9mZnNldCgpLnRvcDsKICAgICAgciA8IDAgJiYgKHIgPSAwKSwgciA+IHRoaXMub2Zmc2V0SGVpZ2h0ICYmIChyID0gdGhpcy5vZmZzZXRIZWlnaHQpOwogICAgICB2YXIgbyA9IHIgLyAxODAgKiAzNjA7CiAgICAgIEMgPSBvLCBZKG8sIEUsIHcsIEYpLCBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB9KSwgYS5vbigibW91c2Vkb3duIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIGkgPSB0aGlzLm9mZnNldFRvcCwKICAgICAgICAgIHIgPSB0aGlzLm9mZnNldExlZnQsCiAgICAgICAgICBvID0gZS5jbGllbnRZLAogICAgICAgICAgbiA9IGUuY2xpZW50WCwKICAgICAgICAgIGwgPSBmdW5jdGlvbiBsKGUpIHsKICAgICAgICB2YXIgbCA9IGkgKyAoZS5jbGllbnRZIC0gbyksCiAgICAgICAgICAgIHQgPSByICsgKGUuY2xpZW50WCAtIG4pLAogICAgICAgICAgICBhID0gY1swXS5vZmZzZXRIZWlnaHQgLSAzLAogICAgICAgICAgICBzID0gY1swXS5vZmZzZXRXaWR0aCAtIDM7CiAgICAgICAgbCA8IC0zICYmIChsID0gLTMpLCBsID4gYSAmJiAobCA9IGEpLCB0IDwgLTMgJiYgKHQgPSAtMyksIHQgPiBzICYmICh0ID0gcyk7CiAgICAgICAgdmFyIGYgPSAodCArIDMpIC8gMjYwICogMTAwLAogICAgICAgICAgICBkID0gMTAwIC0gKGwgKyAzKSAvIDE4MCAqIDEwMDsKICAgICAgICB3ID0gZCwgRSA9IGYsIFkoQywgZiwgZCwgRiksIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgfTsKCiAgICAgIGxheXVpLnN0b3BlKGUpLCBMKGwpLCBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB9KSwgYy5vbigibW91c2Vkb3duIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIHIgPSBlLmNsaWVudFkgLSBpKHRoaXMpLm9mZnNldCgpLnRvcCAtIDMgKyBqLnNjcm9sbFRvcCgpLAogICAgICAgICAgbyA9IGUuY2xpZW50WCAtIGkodGhpcykub2Zmc2V0KCkubGVmdCAtIDMgKyBqLnNjcm9sbExlZnQoKTsKICAgICAgciA8IC0zICYmIChyID0gLTMpLCByID4gdGhpcy5vZmZzZXRIZWlnaHQgLSAzICYmIChyID0gdGhpcy5vZmZzZXRIZWlnaHQgLSAzKSwgbyA8IC0zICYmIChvID0gLTMpLCBvID4gdGhpcy5vZmZzZXRXaWR0aCAtIDMgJiYgKG8gPSB0aGlzLm9mZnNldFdpZHRoIC0gMyk7CiAgICAgIHZhciBuID0gKG8gKyAzKSAvIDI2MCAqIDEwMCwKICAgICAgICAgIGwgPSAxMDAgLSAociArIDMpIC8gMTgwICogMTAwOwogICAgICB3ID0gbCwgRSA9IG4sIFkoQywgbiwgbCwgRiksIGxheXVpLnN0b3BlKGUpLCBlLnByZXZlbnREZWZhdWx0KCksIGEudHJpZ2dlcihlLCAibW91c2Vkb3duIik7CiAgICB9KSwgZi5vbigibW91c2Vkb3duIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIGkgPSB0aGlzLm9mZnNldExlZnQsCiAgICAgICAgICByID0gZS5jbGllbnRYLAogICAgICAgICAgbyA9IGZ1bmN0aW9uIG8oZSkgewogICAgICAgIHZhciBvID0gaSArIChlLmNsaWVudFggLSByKSwKICAgICAgICAgICAgbiA9IHNbMF0ub2Zmc2V0V2lkdGg7CiAgICAgICAgbyA8IDAgJiYgKG8gPSAwKSwgbyA+IG4gJiYgKG8gPSBuKTsKICAgICAgICB2YXIgbCA9IE1hdGgucm91bmQobyAvIDI4MCAqIDEwMCkgLyAxMDA7CiAgICAgICAgRiA9IGwsIFkoQywgRSwgdywgbCksIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgfTsKCiAgICAgIEwobyksIGUucHJldmVudERlZmF1bHQoKTsKICAgIH0pLCBzLm9uKCJjbGljayIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciByID0gZS5jbGllbnRYIC0gaSh0aGlzKS5vZmZzZXQoKS5sZWZ0OwogICAgICByIDwgMCAmJiAociA9IDApLCByID4gdGhpcy5vZmZzZXRXaWR0aCAmJiAociA9IHRoaXMub2Zmc2V0V2lkdGgpOwogICAgICB2YXIgbyA9IE1hdGgucm91bmQociAvIDI4MCAqIDEwMCkgLyAxMDA7CiAgICAgIEYgPSBvLCBZKEMsIEUsIHcsIG8pLCBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB9KSwgTS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgaSh0aGlzKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgaSh0aGlzKS5wYXJlbnQoIi5sYXl1aS1jb2xvcnBpY2tlci1wcmUiKS5hZGRDbGFzcygic2VsZWN0ZWQiKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKCJzZWxlY3RlZCIpOwogICAgICAgIHZhciBlLAogICAgICAgICAgICByID0gdGhpcy5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IsCiAgICAgICAgICAgIG8gPSBQKEQocikpLAogICAgICAgICAgICBuID0gci5zbGljZShyLmxhc3RJbmRleE9mKCIsIikgKyAxLCByLmxlbmd0aCAtIDEpOwogICAgICAgIEMgPSBvLmgsIEUgPSBvLnMsIHcgPSBvLmIsIDMgPT0gKHIubWF0Y2goL1swLTldezEsM30vZykgfHwgW10pLmxlbmd0aCAmJiAobiA9IDEpLCBGID0gbiwgZSA9IDI4MCAqIG4sIFkoby5oLCBvLnMsIG8uYiwgbik7CiAgICAgIH0pOwogICAgfSk7CiAgfSwgRi5wcm90b3R5cGUuc2VsZWN0ID0gZnVuY3Rpb24gKGUsIGksIHIsIG8pIHsKICAgIHZhciBuID0gdGhpcywKICAgICAgICBsID0gKG4uY29uZmlnLCB3KHsKICAgICAgaDogZSwKICAgICAgczogMTAwLAogICAgICBiOiAxMDAKICAgIH0pKSwKICAgICAgICB0ID0gdyh7CiAgICAgIGg6IGUsCiAgICAgIHM6IGksCiAgICAgIGI6IHIKICAgIH0pLAogICAgICAgIGMgPSBlIC8gMzYwICogMTgwLAogICAgICAgIGEgPSAxODAgLSByIC8gMTAwICogMTgwIC0gMywKICAgICAgICBzID0gaSAvIDEwMCAqIDI2MCAtIDM7CiAgICBuLmVsZW1QaWNrZXIuZmluZCgiLiIgKyBoKS5jc3MoInRvcCIsIGMpLCBuLmVsZW1QaWNrZXIuZmluZCgiLiIgKyBiKVswXS5zdHlsZS5iYWNrZ3JvdW5kID0gIiMiICsgbCwgbi5lbGVtUGlja2VyLmZpbmQoIi4iICsgbSkuY3NzKHsKICAgICAgdG9wOiBhLAogICAgICBsZWZ0OiBzCiAgICB9KSwgImNoYW5nZSIgIT09IG8gJiYgbi5lbGVtUGlja2VyLmZpbmQoIi4iICsgeCkuZmluZCgiaW5wdXQiKS52YWwoIiMiICsgdCk7CiAgfSwgRi5wcm90b3R5cGUucGlja2VyRXZlbnRzID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIHIgPSBlLmNvbmZpZywKICAgICAgICBvID0gZS5lbGVtQ29sb3JCb3guZmluZCgiLiIgKyBwKSwKICAgICAgICBuID0gZS5lbGVtUGlja2VyLmZpbmQoIi4iICsgeCArICIgaW5wdXQiKSwKICAgICAgICBsID0gewogICAgICBjbGVhcjogZnVuY3Rpb24gY2xlYXIoaSkgewogICAgICAgIG9bMF0uc3R5bGUuYmFja2dyb3VuZCA9ICIiLCBlLmVsZW1Db2xvckJveC5maW5kKCIuIiArIGcpLnJlbW92ZUNsYXNzKGQpLmFkZENsYXNzKHUpLCBlLmNvbG9yID0gIiIsIHIuZG9uZSAmJiByLmRvbmUoIiIpLCBlLnJlbW92ZVBpY2tlcigpOwogICAgICB9LAogICAgICBjb25maXJtOiBmdW5jdGlvbiBjb25maXJtKGksIGwpIHsKICAgICAgICB2YXIgdCA9IG4udmFsKCksCiAgICAgICAgICAgIGMgPSB0LAogICAgICAgICAgICBhID0ge307CgogICAgICAgIGlmICh0LmluZGV4T2YoIiwiKSA+IC0xKSB7CiAgICAgICAgICBpZiAoYSA9IFAoRCh0KSksIGUuc2VsZWN0KGEuaCwgYS5zLCBhLmIpLCBvWzBdLnN0eWxlLmJhY2tncm91bmQgPSBjID0gIiMiICsgdyhhKSwgKHQubWF0Y2goL1swLTldezEsM30vZykgfHwgW10pLmxlbmd0aCA+IDMgJiYgInJnYmEiID09PSBvLmF0dHIoImxheS10eXBlIikpIHsKICAgICAgICAgICAgdmFyIHMgPSAyODAgKiB0LnNsaWNlKHQubGFzdEluZGV4T2YoIiwiKSArIDEsIHQubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgIGUuZWxlbVBpY2tlci5maW5kKCIuIiArIHkpLmNzcygibGVmdCIsIHMpLCBvWzBdLnN0eWxlLmJhY2tncm91bmQgPSB0LCBjID0gdDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgYSA9IEModCksIG9bMF0uc3R5bGUuYmFja2dyb3VuZCA9IGMgPSAiIyIgKyB3KGEpLCBlLmVsZW1Db2xvckJveC5maW5kKCIuIiArIGcpLnJlbW92ZUNsYXNzKHUpLmFkZENsYXNzKGQpOwoKICAgICAgICByZXR1cm4gImNoYW5nZSIgPT09IGwgPyAoZS5zZWxlY3QoYS5oLCBhLnMsIGEuYiwgbCksIHZvaWQgKHIuY2hhbmdlICYmIHIuY2hhbmdlKGMpKSkgOiAoZS5jb2xvciA9IHQsIHIuZG9uZSAmJiByLmRvbmUodCksIHZvaWQgZS5yZW1vdmVQaWNrZXIoKSk7CiAgICAgIH0KICAgIH07CiAgICBlLmVsZW1QaWNrZXIub24oImNsaWNrIiwgIipbY29sb3JwaWNrZXItZXZlbnRzXSIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSBpKHRoaXMpLAogICAgICAgICAgciA9IGUuYXR0cigiY29sb3JwaWNrZXItZXZlbnRzIik7CiAgICAgIGxbcl0gJiYgbFtyXS5jYWxsKHRoaXMsIGUpOwogICAgfSksIG4ub24oImtleXVwIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIHIgPSBpKHRoaXMpOwogICAgICBsLmNvbmZpcm0uY2FsbCh0aGlzLCByLCAxMyA9PT0gZS5rZXlDb2RlID8gbnVsbCA6ICJjaGFuZ2UiKTsKICAgIH0pOwogIH0sIEYucHJvdG90eXBlLmV2ZW50cyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICByID0gZS5jb25maWcsCiAgICAgICAgbyA9IGUuZWxlbUNvbG9yQm94LmZpbmQoIi4iICsgcCk7CiAgICBlLmVsZW1Db2xvckJveC5vbigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgIGUucmVuZGVyUGlja2VyKCksIGkoZilbMF0gJiYgKGUudmFsKCksIGUuc2lkZSgpKTsKICAgIH0pLCByLmVsZW1bMF0gJiYgIWUuZWxlbUNvbG9yQm94WzBdLmV2ZW50SGFuZGxlciAmJiAoRS5vbihuLCBmdW5jdGlvbiAocikgewogICAgICBpZiAoIWkoci50YXJnZXQpLmhhc0NsYXNzKHMpICYmICFpKHIudGFyZ2V0KS5wYXJlbnRzKCIuIiArIHMpWzBdICYmICFpKHIudGFyZ2V0KS5oYXNDbGFzcyhmLnJlcGxhY2UoL1wuL2csICIiKSkgJiYgIWkoci50YXJnZXQpLnBhcmVudHMoZilbMF0gJiYgZS5lbGVtUGlja2VyKSB7CiAgICAgICAgaWYgKGUuY29sb3IpIHsKICAgICAgICAgIHZhciBuID0gUChEKGUuY29sb3IpKTsKICAgICAgICAgIGUuc2VsZWN0KG4uaCwgbi5zLCBuLmIpOwogICAgICAgIH0gZWxzZSBlLmVsZW1Db2xvckJveC5maW5kKCIuIiArIGcpLnJlbW92ZUNsYXNzKGQpLmFkZENsYXNzKHUpOwoKICAgICAgICBvWzBdLnN0eWxlLmJhY2tncm91bmQgPSBlLmNvbG9yIHx8ICIiLCBlLnJlbW92ZVBpY2tlcigpOwogICAgICB9CiAgICB9KSwgai5vbigicmVzaXplIiwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gISghZS5lbGVtUGlja2VyIHx8ICFpKGYpWzBdKSAmJiB2b2lkIGUucG9zaXRpb24oKTsKICAgIH0pLCBlLmVsZW1Db2xvckJveFswXS5ldmVudEhhbmRsZXIgPSAhMCk7CiAgfSwgbC5yZW5kZXIgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIGkgPSBuZXcgRihlKTsKICAgIHJldHVybiB0LmNhbGwoaSk7CiAgfSwgZShjLCBsKTsKfSk7CmxheXVpLmRlZmluZSgibGF5ZXIiLCBmdW5jdGlvbiAoZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIHQgPSBsYXl1aS4kLAogICAgICBpID0gbGF5dWkubGF5ZXIsCiAgICAgIGEgPSBsYXl1aS5oaW50KCksCiAgICAgIG4gPSBsYXl1aS5kZXZpY2UoKSwKICAgICAgbCA9ICJmb3JtIiwKICAgICAgciA9ICIubGF5dWktZm9ybSIsCiAgICAgIG8gPSAibGF5dWktdGhpcyIsCiAgICAgIHMgPSAibGF5dWktaGlkZSIsCiAgICAgIGMgPSAibGF5dWktZGlzYWJsZWQiLAogICAgICB1ID0gZnVuY3Rpb24gdSgpIHsKICAgIHRoaXMuY29uZmlnID0gewogICAgICB2ZXJpZnk6IHsKICAgICAgICByZXF1aXJlZDogWy9bXFNdKy8sICJcdTVGQzVcdTU4NkJcdTk4NzlcdTRFMERcdTgwRkRcdTRFM0FcdTdBN0EiXSwKICAgICAgICBwaG9uZTogWy9eMVxkezEwfSQvLCAiXHU4QkY3XHU4RjkzXHU1MTY1XHU2QjYzXHU3ODZFXHU3Njg0XHU2MjRCXHU2NzNBXHU1M0Y3Il0sCiAgICAgICAgZW1haWw6IFsvXihbYS16QS1aMC05X1wuXC1dKStcQCgoW2EtekEtWjAtOVwtXSkrXC4pKyhbYS16QS1aMC05XXsyLDR9KSskLywgIlx1OTBBRVx1N0JCMVx1NjgzQ1x1NUYwRlx1NEUwRFx1NkI2M1x1Nzg2RSJdLAogICAgICAgIHVybDogWy9eKCN8KGh0dHAocz8pKTpcL1wvfFwvXC8pW15cc10rXC5bXlxzXSskLywgIlx1OTRGRVx1NjNBNVx1NjgzQ1x1NUYwRlx1NEUwRFx1NkI2M1x1Nzg2RSJdLAogICAgICAgIG51bWJlcjogZnVuY3Rpb24gbnVtYmVyKGUpIHsKICAgICAgICAgIGlmICghZSB8fCBpc05hTihlKSkgcmV0dXJuICJcdTUzRUFcdTgwRkRcdTU4NkJcdTUxOTlcdTY1NzBcdTVCNTciOwogICAgICAgIH0sCiAgICAgICAgZGF0ZTogWy9eKFxkezR9KVstXC9dKFxkezF9fDBcZHsxfXwxWzAtMl0pKFstXC9dKFxkezF9fDBcZHsxfXxbMS0yXVswLTldfDNbMC0xXSkpKiQvLCAiXHU2NUU1XHU2NzFGXHU2ODNDXHU1RjBGXHU0RTBEXHU2QjYzXHU3ODZFIl0sCiAgICAgICAgaWRlbnRpdHk6IFsvKF5cZHsxNX0kKXwoXlxkezE3fSh4fFh8XGQpJCkvLCAiXHU4QkY3XHU4RjkzXHU1MTY1XHU2QjYzXHU3ODZFXHU3Njg0XHU4RUFCXHU0RUZEXHU4QkMxXHU1M0Y3Il0KICAgICAgfSwKICAgICAgYXV0b2NvbXBsZXRlOiBudWxsCiAgICB9OwogIH07CgogIHUucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgaSA9IHRoaXM7CiAgICByZXR1cm4gdC5leHRlbmQoITAsIGkuY29uZmlnLCBlKSwgaTsKICB9LCB1LnByb3RvdHlwZS52ZXJpZnkgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIGkgPSB0aGlzOwogICAgcmV0dXJuIHQuZXh0ZW5kKCEwLCBpLmNvbmZpZy52ZXJpZnksIGUpLCBpOwogIH0sIHUucHJvdG90eXBlLm9uID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgIHJldHVybiBsYXl1aS5vbmV2ZW50LmNhbGwodGhpcywgbCwgZSwgdCk7CiAgfSwgdS5wcm90b3R5cGUudmFsID0gZnVuY3Rpb24gKGUsIGkpIHsKICAgIHZhciBhID0gdGhpcywKICAgICAgICBuID0gdChyICsgJ1tsYXktZmlsdGVyPSInICsgZSArICciXScpOwogICAgcmV0dXJuIG4uZWFjaChmdW5jdGlvbiAoZSwgYSkgewogICAgICB2YXIgbiA9IHQodGhpcyk7CiAgICAgIGxheXVpLmVhY2goaSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgICB2YXIgaSwKICAgICAgICAgICAgYSA9IG4uZmluZCgnW25hbWU9IicgKyBlICsgJyJdJyk7CiAgICAgICAgYVswXSAmJiAoaSA9IGFbMF0udHlwZSwgImNoZWNrYm94IiA9PT0gaSA/IGFbMF0uY2hlY2tlZCA9IHQgOiAicmFkaW8iID09PSBpID8gYS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHRoaXMudmFsdWUgPT0gdCAmJiAodGhpcy5jaGVja2VkID0gITApOwogICAgICAgIH0pIDogYS52YWwodCkpOwogICAgICB9KTsKICAgIH0pLCBmLnJlbmRlcihudWxsLCBlKSwgYS5nZXRWYWx1ZShlKTsKICB9LCB1LnByb3RvdHlwZS5nZXRWYWx1ZSA9IGZ1bmN0aW9uIChlLCBpKSB7CiAgICBpID0gaSB8fCB0KHIgKyAnW2xheS1maWx0ZXI9IicgKyBlICsgJyJdJykuZXEoMCk7CiAgICB2YXIgYSA9IHt9LAogICAgICAgIG4gPSB7fSwKICAgICAgICBsID0gaS5maW5kKCJpbnB1dCxzZWxlY3QsdGV4dGFyZWEiKTsKICAgIHJldHVybiBsYXl1aS5lYWNoKGwsIGZ1bmN0aW9uIChlLCBpKSB7CiAgICAgIHZhciBsOwogICAgICB0KHRoaXMpOwoKICAgICAgaWYgKGkubmFtZSA9IChpLm5hbWUgfHwgIiIpLnJlcGxhY2UoL15ccyp8XHMqJi8sICIiKSwgaS5uYW1lKSB7CiAgICAgICAgaWYgKC9eLipcW1xdJC8udGVzdChpLm5hbWUpKSB7CiAgICAgICAgICB2YXIgciA9IGkubmFtZS5tYXRjaCgvXiguKilcW1xdJC9nKVswXTsKICAgICAgICAgIGFbcl0gPSAwIHwgYVtyXSwgbCA9IGkubmFtZS5yZXBsYWNlKC9eKC4qKVxbXF0kLywgIiQxWyIgKyBhW3JdKysgKyAiXSIpOwogICAgICAgIH0KCiAgICAgICAgL15jaGVja2JveHxyYWRpbyQvLnRlc3QoaS50eXBlKSAmJiAhaS5jaGVja2VkIHx8IChuW2wgfHwgaS5uYW1lXSA9IGkudmFsdWUpOwogICAgICB9CiAgICB9KSwgbjsKICB9LCB1LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoZSwgaSkgewogICAgdmFyIG4gPSB0aGlzLAogICAgICAgIHUgPSBuLmNvbmZpZywKICAgICAgICBkID0gdChyICsgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gaSA/ICdbbGF5LWZpbHRlcj0iJyArIGkgKyAnIl0nIDogIiI7CiAgICB9KCkpLAogICAgICAgIGYgPSB7CiAgICAgIGlucHV0OiBmdW5jdGlvbiBpbnB1dCgpIHsKICAgICAgICB2YXIgZSA9IGQuZmluZCgiaW5wdXQsdGV4dGFyZWEiKTsKICAgICAgICB1LmF1dG9jb21wbGV0ZSAmJiBlLmF0dHIoImF1dG9jb21wbGV0ZSIsIHUuYXV0b2NvbXBsZXRlKTsKICAgICAgfSwKICAgICAgc2VsZWN0OiBmdW5jdGlvbiBzZWxlY3QoKSB7CiAgICAgICAgdmFyIGUsCiAgICAgICAgICAgIGkgPSAiXHU4QkY3XHU5MDA5XHU2MkU5IiwKICAgICAgICAgICAgYSA9ICJsYXl1aS1mb3JtLXNlbGVjdCIsCiAgICAgICAgICAgIG4gPSAibGF5dWktc2VsZWN0LXRpdGxlIiwKICAgICAgICAgICAgciA9ICJsYXl1aS1zZWxlY3Qtbm9uZSIsCiAgICAgICAgICAgIHUgPSAiIiwKICAgICAgICAgICAgZiA9IGQuZmluZCgic2VsZWN0IiksCiAgICAgICAgICAgIHYgPSBmdW5jdGlvbiB2KGksIGwpIHsKICAgICAgICAgIHQoaS50YXJnZXQpLnBhcmVudCgpLmhhc0NsYXNzKG4pICYmICFsIHx8ICh0KCIuIiArIGEpLnJlbW92ZUNsYXNzKGEgKyAiZWQgIiArIGEgKyAidXAiKSwgZSAmJiB1ICYmIGUudmFsKHUpKSwgZSA9IG51bGw7CiAgICAgICAgfSwKICAgICAgICAgICAgeSA9IGZ1bmN0aW9uIHkoaSwgZCwgZikgewogICAgICAgICAgdmFyIHksCiAgICAgICAgICAgICAgcCA9IHQodGhpcyksCiAgICAgICAgICAgICAgbSA9IGkuZmluZCgiLiIgKyBuKSwKICAgICAgICAgICAgICBnID0gbS5maW5kKCJpbnB1dCIpLAogICAgICAgICAgICAgIGsgPSBpLmZpbmQoImRsIiksCiAgICAgICAgICAgICAgeCA9IGsuY2hpbGRyZW4oImRkIiksCiAgICAgICAgICAgICAgYiA9IHRoaXMuc2VsZWN0ZWRJbmRleDsKCiAgICAgICAgICBpZiAoIWQpIHsKICAgICAgICAgICAgdmFyIEMgPSBmdW5jdGlvbiBDKCkgewogICAgICAgICAgICAgIHZhciBlID0gaS5vZmZzZXQoKS50b3AgKyBpLm91dGVySGVpZ2h0KCkgKyA1IC0gaC5zY3JvbGxUb3AoKSwKICAgICAgICAgICAgICAgICAgdCA9IGsub3V0ZXJIZWlnaHQoKTsKICAgICAgICAgICAgICBiID0gcFswXS5zZWxlY3RlZEluZGV4LCBpLmFkZENsYXNzKGEgKyAiZWQiKSwgeC5yZW1vdmVDbGFzcyhzKSwgeSA9IG51bGwsIHguZXEoYikuYWRkQ2xhc3Mobykuc2libGluZ3MoKS5yZW1vdmVDbGFzcyhvKSwgZSArIHQgPiBoLmhlaWdodCgpICYmIGUgPj0gdCAmJiBpLmFkZENsYXNzKGEgKyAidXAiKSwgVCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdyA9IGZ1bmN0aW9uIHcoZSkgewogICAgICAgICAgICAgIGkucmVtb3ZlQ2xhc3MoYSArICJlZCAiICsgYSArICJ1cCIpLCBnLmJsdXIoKSwgeSA9IG51bGwsIGUgfHwgJChnLnZhbCgpLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgdmFyIGkgPSBwWzBdLnNlbGVjdGVkSW5kZXg7CiAgICAgICAgICAgICAgICBlICYmICh1ID0gdChwWzBdLm9wdGlvbnNbaV0pLmh0bWwoKSwgMCA9PT0gaSAmJiB1ID09PSBnLmF0dHIoInBsYWNlaG9sZGVyIikgJiYgKHUgPSAiIiksIGcudmFsKHUgfHwgIiIpKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFQgPSBmdW5jdGlvbiBUKCkgewogICAgICAgICAgICAgIHZhciBlID0gay5jaGlsZHJlbigiZGQuIiArIG8pOwoKICAgICAgICAgICAgICBpZiAoZVswXSkgewogICAgICAgICAgICAgICAgdmFyIHQgPSBlLnBvc2l0aW9uKCkudG9wLAogICAgICAgICAgICAgICAgICAgIGkgPSBrLmhlaWdodCgpLAogICAgICAgICAgICAgICAgICAgIGEgPSBlLmhlaWdodCgpOwogICAgICAgICAgICAgICAgdCA+IGkgJiYgay5zY3JvbGxUb3AodCArIGsuc2Nyb2xsVG9wKCkgLSBpICsgYSAtIDUpLCB0IDwgMCAmJiBrLnNjcm9sbFRvcCh0ICsgay5zY3JvbGxUb3AoKSAtIDUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIG0ub24oImNsaWNrIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICBpLmhhc0NsYXNzKGEgKyAiZWQiKSA/IHcoKSA6ICh2KGUsICEwKSwgQygpKSwgay5maW5kKCIuIiArIHIpLnJlbW92ZSgpOwogICAgICAgICAgICB9KSwgbS5maW5kKCIubGF5dWktZWRnZSIpLm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBnLmZvY3VzKCk7CiAgICAgICAgICAgIH0pLCBnLm9uKCJrZXl1cCIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgdmFyIHQgPSBlLmtleUNvZGU7CiAgICAgICAgICAgICAgOSA9PT0gdCAmJiBDKCk7CiAgICAgICAgICAgIH0pLm9uKCJrZXlkb3duIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICB2YXIgdCA9IGUua2V5Q29kZTsKICAgICAgICAgICAgICA5ID09PSB0ICYmIHcoKTsKCiAgICAgICAgICAgICAgdmFyIGkgPSBmdW5jdGlvbiBpKHQsIGEpIHsKICAgICAgICAgICAgICAgIHZhciBuLCBsOwogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgICAgIHZhciByID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICB2YXIgZSA9IGsuY2hpbGRyZW4oImRkLiIgKyBvKTsKCiAgICAgICAgICAgICAgICAgIGlmIChrLmNoaWxkcmVuKCJkZC4iICsgcylbMF0gJiYgIm5leHQiID09PSB0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSBrLmNoaWxkcmVuKCJkZDpub3QoLiIgKyBzICsgIiwuIiArIGMgKyAiKSIpLAogICAgICAgICAgICAgICAgICAgICAgICBuID0gaS5lcSgwKS5pbmRleCgpOwogICAgICAgICAgICAgICAgICAgIGlmIChuID49IDAgJiYgbiA8IGUuaW5kZXgoKSAmJiAhaS5oYXNDbGFzcyhvKSkgcmV0dXJuIGkuZXEoMCkucHJldigpWzBdID8gaS5lcSgwKS5wcmV2KCkgOiBrLmNoaWxkcmVuKCI6bGFzdCIpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICByZXR1cm4gYSAmJiBhWzBdID8gYSA6IHkgJiYgeVswXSA/IHkgOiBlOwogICAgICAgICAgICAgICAgfSgpOwoKICAgICAgICAgICAgICAgIHJldHVybiBsID0gclt0XSgpLCBuID0gclt0XSgiZGQ6bm90KC4iICsgcyArICIpIiksIGxbMF0gPyAoeSA9IHJbdF0oKSwgblswXSAmJiAhbi5oYXNDbGFzcyhjKSB8fCAheVswXSA/IChuLmFkZENsYXNzKG8pLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MobyksIHZvaWQgVCgpKSA6IGkodCwgeSkpIDogeSA9IG51bGw7CiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgMzggPT09IHQgJiYgaSgicHJldiIpLCA0MCA9PT0gdCAmJiBpKCJuZXh0IiksIDEzID09PSB0ICYmIChlLnByZXZlbnREZWZhdWx0KCksIGsuY2hpbGRyZW4oImRkLiIgKyBvKS50cmlnZ2VyKCJjbGljayIpKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB2YXIgJCA9IGZ1bmN0aW9uICQoZSwgaSwgYSkgewogICAgICAgICAgICAgIHZhciBuID0gMDsKICAgICAgICAgICAgICBsYXl1aS5lYWNoKHgsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBpID0gdCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICBsID0gaS50ZXh0KCksCiAgICAgICAgICAgICAgICAgICAgciA9IGwuaW5kZXhPZihlKSA9PT0gLTE7CiAgICAgICAgICAgICAgICAoIiIgPT09IGUgfHwgImJsdXIiID09PSBhID8gZSAhPT0gbCA6IHIpICYmIG4rKywgImtleXVwIiA9PT0gYSAmJiBpW3IgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIl0ocyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdmFyIGwgPSBuID09PSB4Lmxlbmd0aDsKICAgICAgICAgICAgICByZXR1cm4gaShsKSwgbDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHEgPSBmdW5jdGlvbiBxKGUpIHsKICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMudmFsdWUsCiAgICAgICAgICAgICAgICAgIGkgPSBlLmtleUNvZGU7CiAgICAgICAgICAgICAgcmV0dXJuIDkgIT09IGkgJiYgMTMgIT09IGkgJiYgMzcgIT09IGkgJiYgMzggIT09IGkgJiYgMzkgIT09IGkgJiYgNDAgIT09IGkgJiYgKCQodCwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIGUgPyBrLmZpbmQoIi4iICsgcilbMF0gfHwgay5hcHBlbmQoJzxwIGNsYXNzPSInICsgciArICJcIj5cdTY1RTBcdTUzMzlcdTkxNERcdTk4Nzk8L3A+IikgOiBrLmZpbmQoIi4iICsgcikucmVtb3ZlKCk7CiAgICAgICAgICAgICAgfSwgImtleXVwIiksICIiID09PSB0ICYmIGsuZmluZCgiLiIgKyByKS5yZW1vdmUoKSwgdm9pZCBUKCkpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZiAmJiBnLm9uKCJrZXl1cCIsIHEpLm9uKCJibHVyIiwgZnVuY3Rpb24gKGkpIHsKICAgICAgICAgICAgICB2YXIgYSA9IHBbMF0uc2VsZWN0ZWRJbmRleDsKICAgICAgICAgICAgICBlID0gZywgdSA9IHQocFswXS5vcHRpb25zW2FdKS5odG1sKCksIDAgPT09IGEgJiYgdSA9PT0gZy5hdHRyKCJwbGFjZWhvbGRlciIpICYmICh1ID0gIiIpLCBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICQoZy52YWwoKSwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgdSB8fCBnLnZhbCgiIik7CiAgICAgICAgICAgICAgICB9LCAiYmx1ciIpOwogICAgICAgICAgICAgIH0sIDIwMCk7CiAgICAgICAgICAgIH0pLCB4Lm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB2YXIgZSA9IHQodGhpcyksCiAgICAgICAgICAgICAgICAgIGEgPSBlLmF0dHIoImxheS12YWx1ZSIpLAogICAgICAgICAgICAgICAgICBuID0gcC5hdHRyKCJsYXktZmlsdGVyIik7CiAgICAgICAgICAgICAgcmV0dXJuICFlLmhhc0NsYXNzKGMpICYmIChlLmhhc0NsYXNzKCJsYXl1aS1zZWxlY3QtdGlwcyIpID8gZy52YWwoIiIpIDogKGcudmFsKGUudGV4dCgpKSwgZS5hZGRDbGFzcyhvKSksIGUuc2libGluZ3MoKS5yZW1vdmVDbGFzcyhvKSwgcC52YWwoYSkucmVtb3ZlQ2xhc3MoImxheXVpLWZvcm0tZGFuZ2VyIiksIGxheXVpLmV2ZW50LmNhbGwodGhpcywgbCwgInNlbGVjdCgiICsgbiArICIpIiwgewogICAgICAgICAgICAgICAgZWxlbTogcFswXSwKICAgICAgICAgICAgICAgIHZhbHVlOiBhLAogICAgICAgICAgICAgICAgb3RoaXM6IGkKICAgICAgICAgICAgICB9KSwgdyghMCksICExKTsKICAgICAgICAgICAgfSksIGkuZmluZCgiZGw+ZHQiKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgIHJldHVybiAhMTsKICAgICAgICAgICAgfSksIHQoZG9jdW1lbnQpLm9mZigiY2xpY2siLCB2KS5vbigiY2xpY2siLCB2KTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmLmVhY2goZnVuY3Rpb24gKGUsIGwpIHsKICAgICAgICAgIHZhciByID0gdCh0aGlzKSwKICAgICAgICAgICAgICBzID0gci5uZXh0KCIuIiArIGEpLAogICAgICAgICAgICAgIHUgPSB0aGlzLmRpc2FibGVkLAogICAgICAgICAgICAgIGQgPSBsLnZhbHVlLAogICAgICAgICAgICAgIGYgPSB0KGwub3B0aW9uc1tsLnNlbGVjdGVkSW5kZXhdKSwKICAgICAgICAgICAgICB2ID0gbC5vcHRpb25zWzBdOwogICAgICAgICAgaWYgKCJzdHJpbmciID09IHR5cGVvZiByLmF0dHIoImxheS1pZ25vcmUiKSkgcmV0dXJuIHIuc2hvdygpOwogICAgICAgICAgdmFyIGggPSAic3RyaW5nIiA9PSB0eXBlb2Ygci5hdHRyKCJsYXktc2VhcmNoIiksCiAgICAgICAgICAgICAgcCA9IHYgPyB2LnZhbHVlID8gaSA6IHYuaW5uZXJIVE1MIHx8IGkgOiBpLAogICAgICAgICAgICAgIG0gPSB0KFsnPGRpdiBjbGFzcz0iJyArIChoID8gIiIgOiAibGF5dWktdW5zZWxlY3QgIikgKyBhLCAodSA/ICIgbGF5dWktc2VsZWN0LWRpc2FibGVkIiA6ICIiKSArICciPicsICc8ZGl2IGNsYXNzPSInICsgbiArICciPicsICc8aW5wdXQgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9IicgKyB0LnRyaW0ocCkgKyAnIiAnICsgKCd2YWx1ZT0iJyArIHQudHJpbShkID8gZi5odG1sKCkgOiAiIikgKyAnIicpICsgKCF1ICYmIGggPyAiIiA6ICIgcmVhZG9ubHkiKSArICcgY2xhc3M9ImxheXVpLWlucHV0JyArIChoID8gIiIgOiAiIGxheXVpLXVuc2VsZWN0IikgKyAodSA/ICIgIiArIGMgOiAiIikgKyAnIj4nLCAnPGkgY2xhc3M9ImxheXVpLWVkZ2UiPjwvaT48L2Rpdj4nLCAnPGRsIGNsYXNzPSJsYXl1aS1hbmltIGxheXVpLWFuaW0tdXBiaXQnICsgKHIuZmluZCgib3B0Z3JvdXAiKVswXSA/ICIgbGF5dWktc2VsZWN0LWdyb3VwIiA6ICIiKSArICciPicsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIHZhciBhID0gW107CiAgICAgICAgICAgIHJldHVybiBsYXl1aS5lYWNoKGUsIGZ1bmN0aW9uIChlLCBuKSB7CiAgICAgICAgICAgICAgMCAhPT0gZSB8fCBuLnZhbHVlID8gIm9wdGdyb3VwIiA9PT0gbi50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPyBhLnB1c2goIjxkdD4iICsgbi5sYWJlbCArICI8L2R0PiIpIDogYS5wdXNoKCc8ZGQgbGF5LXZhbHVlPSInICsgbi52YWx1ZSArICciIGNsYXNzPSInICsgKGQgPT09IG4udmFsdWUgPyBvIDogIiIpICsgKG4uZGlzYWJsZWQgPyAiICIgKyBjIDogIiIpICsgJyI+JyArIHQudHJpbShuLmlubmVySFRNTCkgKyAiPC9kZD4iKSA6IGEucHVzaCgnPGRkIGxheS12YWx1ZT0iIiBjbGFzcz0ibGF5dWktc2VsZWN0LXRpcHMiPicgKyB0LnRyaW0obi5pbm5lckhUTUwgfHwgaSkgKyAiPC9kZD4iKTsKICAgICAgICAgICAgfSksIDAgPT09IGEubGVuZ3RoICYmIGEucHVzaCgnPGRkIGxheS12YWx1ZT0iIiBjbGFzcz0iJyArIGMgKyAiXCI+XHU2Q0ExXHU2NzA5XHU5MDA5XHU5ODc5PC9kZD4iKSwgYS5qb2luKCIiKTsKICAgICAgICAgIH0oci5maW5kKCIqIikpICsgIjwvZGw+IiwgIjwvZGl2PiJdLmpvaW4oIiIpKTsKICAgICAgICAgIHNbMF0gJiYgcy5yZW1vdmUoKSwgci5hZnRlcihtKSwgeS5jYWxsKHRoaXMsIG0sIHUsIGgpOwogICAgICAgIH0pOwogICAgICB9LAogICAgICBjaGVja2JveDogZnVuY3Rpb24gY2hlY2tib3goKSB7CiAgICAgICAgdmFyIGUgPSB7CiAgICAgICAgICBjaGVja2JveDogWyJsYXl1aS1mb3JtLWNoZWNrYm94IiwgImxheXVpLWZvcm0tY2hlY2tlZCIsICJjaGVja2JveCJdLAogICAgICAgICAgX3N3aXRjaDogWyJsYXl1aS1mb3JtLXN3aXRjaCIsICJsYXl1aS1mb3JtLW9uc3dpdGNoIiwgInN3aXRjaCJdCiAgICAgICAgfSwKICAgICAgICAgICAgaSA9IGQuZmluZCgiaW5wdXRbdHlwZT1jaGVja2JveF0iKSwKICAgICAgICAgICAgYSA9IGZ1bmN0aW9uIGEoZSwgaSkgewogICAgICAgICAgdmFyIGEgPSB0KHRoaXMpOwogICAgICAgICAgZS5vbigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB0ID0gYS5hdHRyKCJsYXktZmlsdGVyIiksCiAgICAgICAgICAgICAgICBuID0gKGEuYXR0cigibGF5LXRleHQiKSB8fCAiIikuc3BsaXQoInwiKTsKICAgICAgICAgICAgYVswXS5kaXNhYmxlZCB8fCAoYVswXS5jaGVja2VkID8gKGFbMF0uY2hlY2tlZCA9ICExLCBlLnJlbW92ZUNsYXNzKGlbMV0pLmZpbmQoImVtIikudGV4dChuWzFdKSkgOiAoYVswXS5jaGVja2VkID0gITAsIGUuYWRkQ2xhc3MoaVsxXSkuZmluZCgiZW0iKS50ZXh0KG5bMF0pKSwgbGF5dWkuZXZlbnQuY2FsbChhWzBdLCBsLCBpWzJdICsgIigiICsgdCArICIpIiwgewogICAgICAgICAgICAgIGVsZW06IGFbMF0sCiAgICAgICAgICAgICAgdmFsdWU6IGFbMF0udmFsdWUsCiAgICAgICAgICAgICAgb3RoaXM6IGUKICAgICAgICAgICAgfSkpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgaS5lYWNoKGZ1bmN0aW9uIChpLCBuKSB7CiAgICAgICAgICB2YXIgbCA9IHQodGhpcyksCiAgICAgICAgICAgICAgciA9IGwuYXR0cigibGF5LXNraW4iKSwKICAgICAgICAgICAgICBvID0gKGwuYXR0cigibGF5LXRleHQiKSB8fCAiIikuc3BsaXQoInwiKSwKICAgICAgICAgICAgICBzID0gdGhpcy5kaXNhYmxlZDsKICAgICAgICAgICJzd2l0Y2giID09PSByICYmIChyID0gIl8iICsgcik7CiAgICAgICAgICB2YXIgdSA9IGVbcl0gfHwgZS5jaGVja2JveDsKICAgICAgICAgIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgbC5hdHRyKCJsYXktaWdub3JlIikpIHJldHVybiBsLnNob3coKTsKICAgICAgICAgIHZhciBkID0gbC5uZXh0KCIuIiArIHVbMF0pLAogICAgICAgICAgICAgIGYgPSB0KFsnPGRpdiBjbGFzcz0ibGF5dWktdW5zZWxlY3QgJyArIHVbMF0sIG4uY2hlY2tlZCA/ICIgIiArIHVbMV0gOiAiIiwgcyA/ICIgbGF5dWktY2hlY2tib3gtZGlzYWJsZWQgIiArIGMgOiAiIiwgJyInLCByID8gJyBsYXktc2tpbj0iJyArIHIgKyAnIicgOiAiIiwgIj4iLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBlID0gbi50aXRsZS5yZXBsYWNlKC9ccy9nLCAiIiksCiAgICAgICAgICAgICAgICB0ID0gewogICAgICAgICAgICAgIGNoZWNrYm94OiBbZSA/ICI8c3Bhbj4iICsgbi50aXRsZSArICI8L3NwYW4+IiA6ICIiLCAnPGkgY2xhc3M9ImxheXVpLWljb24gbGF5dWktaWNvbi1vayI+PC9pPiddLmpvaW4oIiIpLAogICAgICAgICAgICAgIF9zd2l0Y2g6ICI8ZW0+IiArICgobi5jaGVja2VkID8gb1swXSA6IG9bMV0pIHx8ICIiKSArICI8L2VtPjxpPjwvaT4iCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiB0W3JdIHx8IHQuY2hlY2tib3g7CiAgICAgICAgICB9KCksICI8L2Rpdj4iXS5qb2luKCIiKSk7CiAgICAgICAgICBkWzBdICYmIGQucmVtb3ZlKCksIGwuYWZ0ZXIoZiksIGEuY2FsbCh0aGlzLCBmLCB1KTsKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgcmFkaW86IGZ1bmN0aW9uIHJhZGlvKCkgewogICAgICAgIHZhciBlID0gImxheXVpLWZvcm0tcmFkaW8iLAogICAgICAgICAgICBpID0gWyImI3hlNjQzOyIsICImI3hlNjNmOyJdLAogICAgICAgICAgICBhID0gZC5maW5kKCJpbnB1dFt0eXBlPXJhZGlvXSIpLAogICAgICAgICAgICBuID0gZnVuY3Rpb24gbihhKSB7CiAgICAgICAgICB2YXIgbiA9IHQodGhpcyksCiAgICAgICAgICAgICAgbyA9ICJsYXl1aS1hbmltLXNjYWxlU3ByaW5nIjsKICAgICAgICAgIGEub24oImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgcyA9IG5bMF0ubmFtZSwKICAgICAgICAgICAgICAgIGMgPSBuLnBhcmVudHMociksCiAgICAgICAgICAgICAgICB1ID0gbi5hdHRyKCJsYXktZmlsdGVyIiksCiAgICAgICAgICAgICAgICBkID0gYy5maW5kKCJpbnB1dFtuYW1lPSIgKyBzLnJlcGxhY2UoLyhcLnwjfFxbfFxdKS9nLCAiXFwkMSIpICsgIl0iKTsKICAgICAgICAgICAgblswXS5kaXNhYmxlZCB8fCAobGF5dWkuZWFjaChkLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdmFyIGEgPSB0KHRoaXMpLm5leHQoIi4iICsgZSk7CiAgICAgICAgICAgICAgdGhpcy5jaGVja2VkID0gITEsIGEucmVtb3ZlQ2xhc3MoZSArICJlZCIpLCBhLmZpbmQoIi5sYXl1aS1pY29uIikucmVtb3ZlQ2xhc3MobykuaHRtbChpWzFdKTsKICAgICAgICAgICAgfSksIG5bMF0uY2hlY2tlZCA9ICEwLCBhLmFkZENsYXNzKGUgKyAiZWQiKSwgYS5maW5kKCIubGF5dWktaWNvbiIpLmFkZENsYXNzKG8pLmh0bWwoaVswXSksIGxheXVpLmV2ZW50LmNhbGwoblswXSwgbCwgInJhZGlvKCIgKyB1ICsgIikiLCB7CiAgICAgICAgICAgICAgZWxlbTogblswXSwKICAgICAgICAgICAgICB2YWx1ZTogblswXS52YWx1ZSwKICAgICAgICAgICAgICBvdGhpczogYQogICAgICAgICAgICB9KSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBhLmVhY2goZnVuY3Rpb24gKGEsIGwpIHsKICAgICAgICAgIHZhciByID0gdCh0aGlzKSwKICAgICAgICAgICAgICBvID0gci5uZXh0KCIuIiArIGUpLAogICAgICAgICAgICAgIHMgPSB0aGlzLmRpc2FibGVkOwogICAgICAgICAgaWYgKCJzdHJpbmciID09IHR5cGVvZiByLmF0dHIoImxheS1pZ25vcmUiKSkgcmV0dXJuIHIuc2hvdygpOwogICAgICAgICAgb1swXSAmJiBvLnJlbW92ZSgpOwogICAgICAgICAgdmFyIHUgPSB0KFsnPGRpdiBjbGFzcz0ibGF5dWktdW5zZWxlY3QgJyArIGUsIGwuY2hlY2tlZCA/ICIgIiArIGUgKyAiZWQiIDogIiIsIChzID8gIiBsYXl1aS1yYWRpby1kaXNhYmxlZCAiICsgYyA6ICIiKSArICciPicsICc8aSBjbGFzcz0ibGF5dWktYW5pbSBsYXl1aS1pY29uIj4nICsgaVtsLmNoZWNrZWQgPyAwIDogMV0gKyAiPC9pPiIsICI8ZGl2PiIgKyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBlID0gbC50aXRsZSB8fCAiIjsKICAgICAgICAgICAgcmV0dXJuICJzdHJpbmciID09IHR5cGVvZiByLm5leHQoKS5hdHRyKCJsYXktcmFkaW8iKSAmJiAoZSA9IHIubmV4dCgpLmh0bWwoKSksIGU7CiAgICAgICAgICB9KCkgKyAiPC9kaXY+IiwgIjwvZGl2PiJdLmpvaW4oIiIpKTsKICAgICAgICAgIHIuYWZ0ZXIodSksIG4uY2FsbCh0aGlzLCB1KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICAgIHJldHVybiBlID8gZltlXSA/IGZbZV0oKSA6IGEuZXJyb3IoIlx1NEUwRFx1NjUyRlx1NjMwMVx1NzY4NCBcIiIgKyBlICsgIlwiIFx1ODg2OFx1NTM1NVx1NkUzMlx1NjdEMyIpIDogbGF5dWkuZWFjaChmLCBmdW5jdGlvbiAoZSwgdCkgewogICAgICB0KCk7CiAgICB9KSwgbjsKICB9OwoKICB2YXIgZCA9IGZ1bmN0aW9uIGQoKSB7CiAgICB2YXIgZSA9IG51bGwsCiAgICAgICAgYSA9IGYuY29uZmlnLnZlcmlmeSwKICAgICAgICBvID0gImxheXVpLWZvcm0tZGFuZ2VyIiwKICAgICAgICBzID0ge30sCiAgICAgICAgYyA9IHQodGhpcyksCiAgICAgICAgdSA9IGMucGFyZW50cyhyKS5lcSgwKSwKICAgICAgICBkID0gdS5maW5kKCIqW2xheS12ZXJpZnldIiksCiAgICAgICAgaCA9IGMucGFyZW50cygiZm9ybSIpWzBdLAogICAgICAgIHkgPSBjLmF0dHIoImxheS1maWx0ZXIiKTsKICAgIHJldHVybiBsYXl1aS5lYWNoKGQsIGZ1bmN0aW9uIChsLCByKSB7CiAgICAgIHZhciBzID0gdCh0aGlzKSwKICAgICAgICAgIGMgPSBzLmF0dHIoImxheS12ZXJpZnkiKS5zcGxpdCgifCIpLAogICAgICAgICAgdSA9IHMuYXR0cigibGF5LXZlclR5cGUiKSwKICAgICAgICAgIGQgPSBzLnZhbCgpOwogICAgICBpZiAocy5yZW1vdmVDbGFzcyhvKSwgbGF5dWkuZWFjaChjLCBmdW5jdGlvbiAodCwgbCkgewogICAgICAgIHZhciBjLAogICAgICAgICAgICBmID0gIiIsCiAgICAgICAgICAgIGggPSAiZnVuY3Rpb24iID09IHR5cGVvZiBhW2xdOwoKICAgICAgICBpZiAoYVtsXSkgewogICAgICAgICAgdmFyIGMgPSBoID8gZiA9IGFbbF0oZCwgcikgOiAhYVtsXVswXS50ZXN0KGQpLAogICAgICAgICAgICAgIHkgPSAic2VsZWN0IiA9PT0gci50YWdOYW1lLnRvTG93ZXJDYXNlKCkgfHwgL15jaGVja2JveHxyYWRpbyQvLnRlc3Qoci50eXBlKTsKICAgICAgICAgIGlmIChmID0gZiB8fCBhW2xdWzFdLCAicmVxdWlyZWQiID09PSBsICYmIChmID0gcy5hdHRyKCJsYXktcmVxVGV4dCIpIHx8IGYpLCBjKSByZXR1cm4gInRpcHMiID09PSB1ID8gaS50aXBzKGYsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuICJzdHJpbmciICE9IHR5cGVvZiBzLmF0dHIoImxheS1pZ25vcmUiKSAmJiB5ID8gcy5uZXh0KCkgOiBzOwogICAgICAgICAgfSgpLCB7CiAgICAgICAgICAgIHRpcHM6IDEKICAgICAgICAgIH0pIDogImFsZXJ0IiA9PT0gdSA/IGkuYWxlcnQoZiwgewogICAgICAgICAgICB0aXRsZTogIlx1NjNEMFx1NzkzQSIsCiAgICAgICAgICAgIHNoYWRlQ2xvc2U6ICEwCiAgICAgICAgICB9KSA6IC9cYnN0cmluZ3xudW1iZXJcYi8udGVzdChfdHlwZW9mKGYpKSAmJiBpLm1zZyhmLCB7CiAgICAgICAgICAgIGljb246IDUsCiAgICAgICAgICAgIHNoaWZ0OiA2CiAgICAgICAgICB9KSwgbi5tb2JpbGUgPyB2LnNjcm9sbFRvcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmV0dXJuICh5ID8gcy5uZXh0KCkgOiBzKS5vZmZzZXQoKS50b3AgLSAxNTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9KCkpIDogc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICh5ID8gcy5uZXh0KCkuZmluZCgiaW5wdXQiKSA6IHIpLmZvY3VzKCk7CiAgICAgICAgICB9LCA3KSwgcy5hZGRDbGFzcyhvKSwgZSA9ICEwOwogICAgICAgIH0KICAgICAgfSksIGUpIHJldHVybiBlOwogICAgfSksICFlICYmIChzID0gZi5nZXRWYWx1ZShudWxsLCB1KSwgbGF5dWkuZXZlbnQuY2FsbCh0aGlzLCBsLCAic3VibWl0KCIgKyB5ICsgIikiLCB7CiAgICAgIGVsZW06IHRoaXMsCiAgICAgIGZvcm06IGgsCiAgICAgIGZpZWxkOiBzCiAgICB9KSk7CiAgfSwKICAgICAgZiA9IG5ldyB1KCksCiAgICAgIHYgPSB0KGRvY3VtZW50KSwKICAgICAgaCA9IHQod2luZG93KTsKCiAgdChmdW5jdGlvbiAoKSB7CiAgICBmLnJlbmRlcigpOwogIH0pLCB2Lm9uKCJyZXNldCIsIHIsIGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdCh0aGlzKS5hdHRyKCJsYXktZmlsdGVyIik7CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgZi5yZW5kZXIobnVsbCwgZSk7CiAgICB9LCA1MCk7CiAgfSksIHYub24oInN1Ym1pdCIsIHIsIGQpLm9uKCJjbGljayIsICIqW2xheS1zdWJtaXRdIiwgZCksIGUobCwgZik7Cn0pOwpsYXl1aS5kZWZpbmUoImZvcm0iLCBmdW5jdGlvbiAoZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIGkgPSBsYXl1aS4kLAogICAgICBhID0gbGF5dWkuZm9ybSwKICAgICAgbiA9IGxheXVpLmxheWVyLAogICAgICB0ID0gInRyZWUiLAogICAgICByID0gewogICAgY29uZmlnOiB7fSwKICAgIGluZGV4OiBsYXl1aVt0XSA/IGxheXVpW3RdLmluZGV4ICsgMWU0IDogMCwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgdmFyIGEgPSB0aGlzOwogICAgICByZXR1cm4gYS5jb25maWcgPSBpLmV4dGVuZCh7fSwgYS5jb25maWcsIGUpLCBhOwogICAgfSwKICAgIG9uOiBmdW5jdGlvbiBvbihlLCBpKSB7CiAgICAgIHJldHVybiBsYXl1aS5vbmV2ZW50LmNhbGwodGhpcywgdCwgZSwgaSk7CiAgICB9CiAgfSwKICAgICAgbCA9IGZ1bmN0aW9uIGwoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgaSA9IGUuY29uZmlnLAogICAgICAgIGEgPSBpLmlkIHx8IGUuaW5kZXg7CiAgICByZXR1cm4gbC50aGF0W2FdID0gZSwgbC5jb25maWdbYV0gPSBpLCB7CiAgICAgIGNvbmZpZzogaSwKICAgICAgcmVsb2FkOiBmdW5jdGlvbiByZWxvYWQoaSkgewogICAgICAgIGUucmVsb2FkLmNhbGwoZSwgaSk7CiAgICAgIH0sCiAgICAgIGdldENoZWNrZWQ6IGZ1bmN0aW9uIGdldENoZWNrZWQoKSB7CiAgICAgICAgcmV0dXJuIGUuZ2V0Q2hlY2tlZC5jYWxsKGUpOwogICAgICB9LAogICAgICBzZXRDaGVja2VkOiBmdW5jdGlvbiBzZXRDaGVja2VkKGkpIHsKICAgICAgICByZXR1cm4gZS5zZXRDaGVja2VkLmNhbGwoZSwgaSk7CiAgICAgIH0KICAgIH07CiAgfSwKICAgICAgYyA9ICJsYXl1aS1oaWRlIiwKICAgICAgZCA9ICJsYXl1aS1kaXNhYmxlZCIsCiAgICAgIHMgPSAibGF5dWktdHJlZS1zZXQiLAogICAgICBvID0gImxheXVpLXRyZWUtaWNvbkNsaWNrIiwKICAgICAgaCA9ICJsYXl1aS1pY29uLWFkZGl0aW9uIiwKICAgICAgdSA9ICJsYXl1aS1pY29uLXN1YnRyYWN0aW9uIiwKICAgICAgcCA9ICJsYXl1aS10cmVlLWVudHJ5IiwKICAgICAgZiA9ICJsYXl1aS10cmVlLW1haW4iLAogICAgICB5ID0gImxheXVpLXRyZWUtdHh0IiwKICAgICAgdiA9ICJsYXl1aS10cmVlLXBhY2siLAogICAgICBDID0gImxheXVpLXRyZWUtc3ByZWFkIiwKICAgICAgayA9ICJsYXl1aS10cmVlLXNldExpbmVTaG9ydCIsCiAgICAgIG0gPSAibGF5dWktdHJlZS1zaG93TGluZSIsCiAgICAgIHggPSAibGF5dWktdHJlZS1saW5lRXh0ZW5kIiwKICAgICAgYiA9IGZ1bmN0aW9uIGIoZSkgewogICAgdmFyIGEgPSB0aGlzOwogICAgYS5pbmRleCA9ICsrci5pbmRleCwgYS5jb25maWcgPSBpLmV4dGVuZCh7fSwgYS5jb25maWcsIHIuY29uZmlnLCBlKSwgYS5yZW5kZXIoKTsKICB9OwoKICBiLnByb3RvdHlwZS5jb25maWcgPSB7CiAgICBkYXRhOiBbXSwKICAgIHNob3dDaGVja2JveDogITEsCiAgICBzaG93TGluZTogITAsCiAgICBhY2NvcmRpb246ICExLAogICAgb25seUljb25Db250cm9sOiAhMSwKICAgIGlzSnVtcDogITEsCiAgICBlZGl0OiAhMSwKICAgIHRleHQ6IHsKICAgICAgZGVmYXVsdE5vZGVOYW1lOiAiXHU2NzJBXHU1NDdEXHU1NDBEIiwKICAgICAgbm9uZTogIlx1NjVFMFx1NjU3MFx1NjM2RSIKICAgIH0KICB9LCBiLnByb3RvdHlwZS5yZWxvYWQgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIGEgPSB0aGlzOwogICAgbGF5dWkuZWFjaChlLCBmdW5jdGlvbiAoZSwgaSkgewogICAgICAiYXJyYXkiID09PSBsYXl1aS5fdHlwZW9mKGkpICYmIGRlbGV0ZSBhLmNvbmZpZ1tlXTsKICAgIH0pLCBhLmNvbmZpZyA9IGkuZXh0ZW5kKCEwLCB7fSwgYS5jb25maWcsIGUpLCBhLnJlbmRlcigpOwogIH0sIGIucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICBhID0gZS5jb25maWc7CiAgICBlLmNoZWNraWRzID0gW107CiAgICB2YXIgbiA9IGkoJzxkaXYgY2xhc3M9ImxheXVpLXRyZWUnICsgKGEuc2hvd0NoZWNrYm94ID8gIiBsYXl1aS1mb3JtIiA6ICIiKSArIChhLnNob3dMaW5lID8gIiBsYXl1aS10cmVlLWxpbmUiIDogIiIpICsgJyIgbGF5LWZpbHRlcj0iTEFZLXRyZWUtJyArIGUuaW5kZXggKyAnIj48L2Rpdj4nKTsKICAgIGUudHJlZShuKTsKICAgIHZhciB0ID0gYS5lbGVtID0gaShhLmVsZW0pOwoKICAgIGlmICh0WzBdKSB7CiAgICAgIGlmIChlLmtleSA9IGEuaWQgfHwgZS5pbmRleCwgZS5lbGVtID0gbiwgZS5lbGVtTm9uZSA9IGkoJzxkaXYgY2xhc3M9ImxheXVpLXRyZWUtZW1wdHlUZXh0Ij4nICsgYS50ZXh0Lm5vbmUgKyAiPC9kaXY+IiksIHQuaHRtbChlLmVsZW0pLCAwID09IGUuZWxlbS5maW5kKCIubGF5dWktdHJlZS1zZXQiKS5sZW5ndGgpIHJldHVybiBlLmVsZW0uYXBwZW5kKGUuZWxlbU5vbmUpOwogICAgICBhLnNob3dDaGVja2JveCAmJiBlLnJlbmRlckZvcm0oImNoZWNrYm94IiksIGUuZWxlbS5maW5kKCIubGF5dWktdHJlZS1zZXQiKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZSA9IGkodGhpcyk7CiAgICAgICAgZS5wYXJlbnQoIi5sYXl1aS10cmVlLXBhY2siKVswXSB8fCBlLmFkZENsYXNzKCJsYXl1aS10cmVlLXNldEhpZGUiKSwgIWUubmV4dCgpWzBdICYmIGUucGFyZW50cygiLmxheXVpLXRyZWUtcGFjayIpLmVxKDEpLmhhc0NsYXNzKCJsYXl1aS10cmVlLWxpbmVFeHRlbmQiKSAmJiBlLmFkZENsYXNzKGspLCBlLm5leHQoKVswXSB8fCBlLnBhcmVudHMoIi5sYXl1aS10cmVlLXNldCIpLmVxKDApLm5leHQoKVswXSB8fCBlLmFkZENsYXNzKGspOwogICAgICB9KSwgZS5ldmVudHMoKTsKICAgIH0KICB9LCBiLnByb3RvdHlwZS5yZW5kZXJGb3JtID0gZnVuY3Rpb24gKGUpIHsKICAgIGEucmVuZGVyKGUsICJMQVktdHJlZS0iICsgdGhpcy5pbmRleCk7CiAgfSwgYi5wcm90b3R5cGUudHJlZSA9IGZ1bmN0aW9uIChlLCBhKSB7CiAgICB2YXIgbiA9IHRoaXMsCiAgICAgICAgdCA9IG4uY29uZmlnLAogICAgICAgIHIgPSBhIHx8IHQuZGF0YTsKICAgIGxheXVpLmVhY2gociwgZnVuY3Rpb24gKGEsIHIpIHsKICAgICAgdmFyIGwgPSByLmNoaWxkcmVuICYmIHIuY2hpbGRyZW4ubGVuZ3RoID4gMCwKICAgICAgICAgIG8gPSBpKCc8ZGl2IGNsYXNzPSJsYXl1aS10cmVlLXBhY2siICcgKyAoci5zcHJlYWQgPyAnc3R5bGU9ImRpc3BsYXk6IGJsb2NrOyInIDogIiIpICsgIj48L2Rpdj4iKSwKICAgICAgICAgIGggPSBpKFsnPGRpdiBkYXRhLWlkPSInICsgci5pZCArICciIGNsYXNzPSJsYXl1aS10cmVlLXNldCcgKyAoci5zcHJlYWQgPyAiIGxheXVpLXRyZWUtc3ByZWFkIiA6ICIiKSArIChyLmNoZWNrZWQgPyAiIGxheXVpLXRyZWUtY2hlY2tlZEZpcnN0IiA6ICIiKSArICciPicsICc8ZGl2IGNsYXNzPSJsYXl1aS10cmVlLWVudHJ5Ij4nLCAnPGRpdiBjbGFzcz0ibGF5dWktdHJlZS1tYWluIj4nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHQuc2hvd0xpbmUgPyBsID8gJzxzcGFuIGNsYXNzPSJsYXl1aS10cmVlLWljb25DbGljayBsYXl1aS10cmVlLWljb24iPjxpIGNsYXNzPSJsYXl1aS1pY29uICcgKyAoci5zcHJlYWQgPyAibGF5dWktaWNvbi1zdWJ0cmFjdGlvbiIgOiAibGF5dWktaWNvbi1hZGRpdGlvbiIpICsgJyI+PC9pPjwvc3Bhbj4nIDogJzxzcGFuIGNsYXNzPSJsYXl1aS10cmVlLWljb25DbGljayI+PGkgY2xhc3M9ImxheXVpLWljb24gbGF5dWktaWNvbi1maWxlIj48L2k+PC9zcGFuPicgOiAnPHNwYW4gY2xhc3M9ImxheXVpLXRyZWUtaWNvbkNsaWNrIj48aSBjbGFzcz0ibGF5dWktdHJlZS1pY29uQXJyb3cgJyArIChsID8gIiIgOiBjKSArICciPjwvaT48L3NwYW4+JzsKICAgICAgfSgpLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHQuc2hvd0NoZWNrYm94ID8gJzxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iJyArIChyLmZpZWxkIHx8ICJsYXl1aVRyZWVDaGVja18iICsgci5pZCkgKyAnIiBzYW1lPSJsYXl1aVRyZWVDaGVjayIgbGF5LXNraW49InByaW1hcnkiICcgKyAoci5kaXNhYmxlZCA/ICJkaXNhYmxlZCIgOiAiIikgKyAnIHZhbHVlPSInICsgci5pZCArICciPicgOiAiIjsKICAgICAgfSgpLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHQuaXNKdW1wICYmIHIuaHJlZiA/ICc8YSBocmVmPSInICsgci5ocmVmICsgJyIgdGFyZ2V0PSJfYmxhbmsiIGNsYXNzPSInICsgeSArICciPicgKyAoci50aXRsZSB8fCByLmxhYmVsIHx8IHQudGV4dC5kZWZhdWx0Tm9kZU5hbWUpICsgIjwvYT4iIDogJzxzcGFuIGNsYXNzPSInICsgeSArIChyLmRpc2FibGVkID8gIiAiICsgZCA6ICIiKSArICciPicgKyAoci50aXRsZSB8fCByLmxhYmVsIHx8IHQudGV4dC5kZWZhdWx0Tm9kZU5hbWUpICsgIjwvc3Bhbj4iOwogICAgICB9KCksICI8L2Rpdj4iLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCF0LmVkaXQpIHJldHVybiAiIjsKICAgICAgICB2YXIgZSA9IHsKICAgICAgICAgIGFkZDogJzxpIGNsYXNzPSJsYXl1aS1pY29uIGxheXVpLWljb24tYWRkLTEiICBkYXRhLXR5cGU9ImFkZCI+PC9pPicsCiAgICAgICAgICB1cGRhdGU6ICc8aSBjbGFzcz0ibGF5dWktaWNvbiBsYXl1aS1pY29uLWVkaXQiIGRhdGEtdHlwZT0idXBkYXRlIj48L2k+JywKICAgICAgICAgIGRlbDogJzxpIGNsYXNzPSJsYXl1aS1pY29uIGxheXVpLWljb24tZGVsZXRlIiBkYXRhLXR5cGU9ImRlbCI+PC9pPicKICAgICAgICB9LAogICAgICAgICAgICBpID0gWyc8ZGl2IGNsYXNzPSJsYXl1aS1idG4tZ3JvdXAgbGF5dWktdHJlZS1idG5Hcm91cCI+J107CiAgICAgICAgcmV0dXJuIHQuZWRpdCA9PT0gITAgJiYgKHQuZWRpdCA9IFsidXBkYXRlIiwgImRlbCJdKSwgIm9iamVjdCIgPT0gX3R5cGVvZih0LmVkaXQpID8gKGxheXVpLmVhY2godC5lZGl0LCBmdW5jdGlvbiAoYSwgbikgewogICAgICAgICAgaS5wdXNoKGVbbl0gfHwgIiIpOwogICAgICAgIH0pLCBpLmpvaW4oIiIpICsgIjwvZGl2PiIpIDogdm9pZCAwOwogICAgICB9KCksICI8L2Rpdj48L2Rpdj4iXS5qb2luKCIiKSk7CiAgICAgIGwgJiYgKGguYXBwZW5kKG8pLCBuLnRyZWUobywgci5jaGlsZHJlbikpLCBlLmFwcGVuZChoKSwgaC5wcmV2KCIuIiArIHMpWzBdICYmIGgucHJldigpLmNoaWxkcmVuKCIubGF5dWktdHJlZS1wYWNrIikuYWRkQ2xhc3MoImxheXVpLXRyZWUtc2hvd0xpbmUiKSwgbCB8fCBoLnBhcmVudCgiLmxheXVpLXRyZWUtcGFjayIpLmFkZENsYXNzKCJsYXl1aS10cmVlLWxpbmVFeHRlbmQiKSwgbi5zcHJlYWQoaCwgciksIHQuc2hvd0NoZWNrYm94ICYmIChyLmNoZWNrZWQgJiYgbi5jaGVja2lkcy5wdXNoKHIuaWQpLCBuLmNoZWNrQ2xpY2soaCwgcikpLCB0LmVkaXQgJiYgbi5vcGVyYXRlKGgsIHIpOwogICAgfSk7CiAgfSwgYi5wcm90b3R5cGUuc3ByZWFkID0gZnVuY3Rpb24gKGUsIGEpIHsKICAgIHZhciBuID0gdGhpcywKICAgICAgICB0ID0gbi5jb25maWcsCiAgICAgICAgciA9IGUuY2hpbGRyZW4oIi4iICsgcCksCiAgICAgICAgbCA9IHIuY2hpbGRyZW4oIi4iICsgZiksCiAgICAgICAgYyA9IHIuZmluZCgiLiIgKyBvKSwKICAgICAgICBrID0gci5maW5kKCIuIiArIHkpLAogICAgICAgIG0gPSB0Lm9ubHlJY29uQ29udHJvbCA/IGMgOiBsLAogICAgICAgIHggPSAiIjsKICAgIG0ub24oImNsaWNrIiwgZnVuY3Rpb24gKGkpIHsKICAgICAgdmFyIGEgPSBlLmNoaWxkcmVuKCIuIiArIHYpLAogICAgICAgICAgbiA9IG0uY2hpbGRyZW4oIi5sYXl1aS1pY29uIilbMF0gPyBtLmNoaWxkcmVuKCIubGF5dWktaWNvbiIpIDogbS5maW5kKCIubGF5dWktdHJlZS1pY29uIikuY2hpbGRyZW4oIi5sYXl1aS1pY29uIik7CgogICAgICBpZiAoYVswXSkgewogICAgICAgIGlmIChlLmhhc0NsYXNzKEMpKSBlLnJlbW92ZUNsYXNzKEMpLCBhLnNsaWRlVXAoMjAwKSwgbi5yZW1vdmVDbGFzcyh1KS5hZGRDbGFzcyhoKTtlbHNlIGlmIChlLmFkZENsYXNzKEMpLCBhLnNsaWRlRG93bigyMDApLCBuLmFkZENsYXNzKHUpLnJlbW92ZUNsYXNzKGgpLCB0LmFjY29yZGlvbikgewogICAgICAgICAgdmFyIHIgPSBlLnNpYmxpbmdzKCIuIiArIHMpOwogICAgICAgICAgci5yZW1vdmVDbGFzcyhDKSwgci5jaGlsZHJlbigiLiIgKyB2KS5zbGlkZVVwKDIwMCksIHIuZmluZCgiLmxheXVpLXRyZWUtaWNvbiIpLmNoaWxkcmVuKCIubGF5dWktaWNvbiIpLnJlbW92ZUNsYXNzKHUpLmFkZENsYXNzKGgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHggPSAibm9ybWFsIjsKICAgIH0pLCBrLm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG4gPSBpKHRoaXMpOwogICAgICBuLmhhc0NsYXNzKGQpIHx8ICh4ID0gZS5oYXNDbGFzcyhDKSA/IHQub25seUljb25Db250cm9sID8gIm9wZW4iIDogImNsb3NlIiA6IHQub25seUljb25Db250cm9sID8gImNsb3NlIiA6ICJvcGVuIiwgdC5jbGljayAmJiB0LmNsaWNrKHsKICAgICAgICBlbGVtOiBlLAogICAgICAgIHN0YXRlOiB4LAogICAgICAgIGRhdGE6IGEKICAgICAgfSkpOwogICAgfSk7CiAgfSwgYi5wcm90b3R5cGUuc2V0Q2hlY2tib3ggPSBmdW5jdGlvbiAoZSwgaSwgYSkgewogICAgdmFyIG4gPSB0aGlzLAogICAgICAgIHQgPSAobi5jb25maWcsIGEucHJvcCgiY2hlY2tlZCIpKTsKCiAgICBpZiAoIWEucHJvcCgiZGlzYWJsZWQiKSkgewogICAgICBpZiAoIm9iamVjdCIgPT0gX3R5cGVvZihpLmNoaWxkcmVuKSB8fCBlLmZpbmQoIi4iICsgdilbMF0pIHsKICAgICAgICB2YXIgciA9IGUuZmluZCgiLiIgKyB2KS5maW5kKCdpbnB1dFtzYW1lPSJsYXl1aVRyZWVDaGVjayJdJyk7CiAgICAgICAgci5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHRoaXMuZGlzYWJsZWQgfHwgKHRoaXMuY2hlY2tlZCA9IHQpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICB2YXIgbCA9IGZ1bmN0aW9uIGwoZSkgewogICAgICAgIGlmIChlLnBhcmVudHMoIi4iICsgcylbMF0pIHsKICAgICAgICAgIHZhciBpLAogICAgICAgICAgICAgIGEgPSBlLnBhcmVudCgiLiIgKyB2KSwKICAgICAgICAgICAgICBuID0gYS5wYXJlbnQoKSwKICAgICAgICAgICAgICByID0gYS5wcmV2KCkuZmluZCgnaW5wdXRbc2FtZT0ibGF5dWlUcmVlQ2hlY2siXScpOwogICAgICAgICAgdCA/IHIucHJvcCgiY2hlY2tlZCIsIHQpIDogKGEuZmluZCgnaW5wdXRbc2FtZT0ibGF5dWlUcmVlQ2hlY2siXScpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLmNoZWNrZWQgJiYgKGkgPSAhMCk7CiAgICAgICAgICB9KSwgaSB8fCByLnByb3AoImNoZWNrZWQiLCAhMSkpLCBsKG4pOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGwoZSksIG4ucmVuZGVyRm9ybSgiY2hlY2tib3giKTsKICAgIH0KICB9LCBiLnByb3RvdHlwZS5jaGVja0NsaWNrID0gZnVuY3Rpb24gKGUsIGEpIHsKICAgIHZhciBuID0gdGhpcywKICAgICAgICB0ID0gbi5jb25maWcsCiAgICAgICAgciA9IGUuY2hpbGRyZW4oIi4iICsgcCksCiAgICAgICAgbCA9IHIuY2hpbGRyZW4oIi4iICsgZik7CiAgICBsLm9uKCJjbGljayIsICdpbnB1dFtzYW1lPSJsYXl1aVRyZWVDaGVjayJdKycsIGZ1bmN0aW9uIChyKSB7CiAgICAgIGxheXVpLnN0b3BlKHIpOwogICAgICB2YXIgbCA9IGkodGhpcykucHJldigpLAogICAgICAgICAgYyA9IGwucHJvcCgiY2hlY2tlZCIpOwogICAgICBsLnByb3AoImRpc2FibGVkIikgfHwgKG4uc2V0Q2hlY2tib3goZSwgYSwgbCksIHQub25jaGVjayAmJiB0Lm9uY2hlY2soewogICAgICAgIGVsZW06IGUsCiAgICAgICAgY2hlY2tlZDogYywKICAgICAgICBkYXRhOiBhCiAgICAgIH0pKTsKICAgIH0pOwogIH0sIGIucHJvdG90eXBlLm9wZXJhdGUgPSBmdW5jdGlvbiAoZSwgYSkgewogICAgdmFyIHQgPSB0aGlzLAogICAgICAgIHIgPSB0LmNvbmZpZywKICAgICAgICBsID0gZS5jaGlsZHJlbigiLiIgKyBwKSwKICAgICAgICBkID0gbC5jaGlsZHJlbigiLiIgKyBmKTsKICAgIGwuY2hpbGRyZW4oIi5sYXl1aS10cmVlLWJ0bkdyb3VwIikub24oImNsaWNrIiwgIi5sYXl1aS1pY29uIiwgZnVuY3Rpb24gKGwpIHsKICAgICAgbGF5dWkuc3RvcGUobCk7CiAgICAgIHZhciBmID0gaSh0aGlzKS5kYXRhKCJ0eXBlIiksCiAgICAgICAgICBiID0gZS5jaGlsZHJlbigiLiIgKyB2KSwKICAgICAgICAgIGcgPSB7CiAgICAgICAgZGF0YTogYSwKICAgICAgICB0eXBlOiBmLAogICAgICAgIGVsZW06IGUKICAgICAgfTsKCiAgICAgIGlmICgiYWRkIiA9PSBmKSB7CiAgICAgICAgYlswXSB8fCAoci5zaG93TGluZSA/IChkLmZpbmQoIi4iICsgbykuYWRkQ2xhc3MoImxheXVpLXRyZWUtaWNvbiIpLCBkLmZpbmQoIi4iICsgbykuY2hpbGRyZW4oIi5sYXl1aS1pY29uIikuYWRkQ2xhc3MoaCkucmVtb3ZlQ2xhc3MoImxheXVpLWljb24tZmlsZSIpKSA6IGQuZmluZCgiLmxheXVpLXRyZWUtaWNvbkFycm93IikucmVtb3ZlQ2xhc3MoYyksIGUuYXBwZW5kKCc8ZGl2IGNsYXNzPSJsYXl1aS10cmVlLXBhY2siPjwvZGl2PicpKTsKICAgICAgICB2YXIgdyA9IHIub3BlcmF0ZSAmJiByLm9wZXJhdGUoZyksCiAgICAgICAgICAgIE4gPSB7fTsKICAgICAgICBpZiAoTi50aXRsZSA9IHIudGV4dC5kZWZhdWx0Tm9kZU5hbWUsIE4uaWQgPSB3LCB0LnRyZWUoZS5jaGlsZHJlbigiLiIgKyB2KSwgW05dKSwgci5zaG93TGluZSkgaWYgKGJbMF0pIGIuaGFzQ2xhc3MoeCkgfHwgYi5hZGRDbGFzcyh4KSwgZS5maW5kKCIuIiArIHYpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgaSh0aGlzKS5jaGlsZHJlbigiLiIgKyBzKS5sYXN0KCkuYWRkQ2xhc3Moayk7CiAgICAgICAgfSksIGIuY2hpbGRyZW4oIi4iICsgcykubGFzdCgpLnByZXYoKS5oYXNDbGFzcyhrKSA/IGIuY2hpbGRyZW4oIi4iICsgcykubGFzdCgpLnByZXYoKS5yZW1vdmVDbGFzcyhrKSA6IGIuY2hpbGRyZW4oIi4iICsgcykubGFzdCgpLnJlbW92ZUNsYXNzKGspLCAhZS5wYXJlbnQoIi4iICsgdilbMF0gJiYgZS5uZXh0KClbMF0gJiYgYi5jaGlsZHJlbigiLiIgKyBzKS5sYXN0KCkucmVtb3ZlQ2xhc3Moayk7ZWxzZSB7CiAgICAgICAgICB2YXIgVCA9IGUuc2libGluZ3MoIi4iICsgcyksCiAgICAgICAgICAgICAgTCA9IDEsCiAgICAgICAgICAgICAgSSA9IGUucGFyZW50KCIuIiArIHYpOwogICAgICAgICAgbGF5dWkuZWFjaChULCBmdW5jdGlvbiAoZSwgYSkgewogICAgICAgICAgICBpKGEpLmNoaWxkcmVuKCIuIiArIHYpWzBdIHx8IChMID0gMCk7CiAgICAgICAgICB9KSwgMSA9PSBMID8gKFQuY2hpbGRyZW4oIi4iICsgdikuYWRkQ2xhc3MobSksIFQuY2hpbGRyZW4oIi4iICsgdikuY2hpbGRyZW4oIi4iICsgcykucmVtb3ZlQ2xhc3MoayksIGUuY2hpbGRyZW4oIi4iICsgdikuYWRkQ2xhc3MobSksIEkucmVtb3ZlQ2xhc3MoeCksIEkuY2hpbGRyZW4oIi4iICsgcykubGFzdCgpLmNoaWxkcmVuKCIuIiArIHYpLmNoaWxkcmVuKCIuIiArIHMpLmxhc3QoKS5hZGRDbGFzcyhrKSkgOiBlLmNoaWxkcmVuKCIuIiArIHYpLmNoaWxkcmVuKCIuIiArIHMpLmFkZENsYXNzKGspOwogICAgICAgIH0KICAgICAgICBpZiAoIXIuc2hvd0NoZWNrYm94KSByZXR1cm47CgogICAgICAgIGlmIChkLmZpbmQoJ2lucHV0W3NhbWU9ImxheXVpVHJlZUNoZWNrIl0nKVswXS5jaGVja2VkKSB7CiAgICAgICAgICB2YXIgQSA9IGUuY2hpbGRyZW4oIi4iICsgdikuY2hpbGRyZW4oIi4iICsgcykubGFzdCgpOwogICAgICAgICAgQS5maW5kKCdpbnB1dFtzYW1lPSJsYXl1aVRyZWVDaGVjayJdJylbMF0uY2hlY2tlZCA9ICEwOwogICAgICAgIH0KCiAgICAgICAgdC5yZW5kZXJGb3JtKCJjaGVja2JveCIpOwogICAgICB9IGVsc2UgaWYgKCJ1cGRhdGUiID09IGYpIHsKICAgICAgICB2YXIgRiA9IGQuY2hpbGRyZW4oIi4iICsgeSkuaHRtbCgpOwogICAgICAgIGQuY2hpbGRyZW4oIi4iICsgeSkuaHRtbCgiIiksIGQuYXBwZW5kKCc8aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9ImxheXVpLXRyZWUtZWRpdElucHV0Ij4nKSwgZC5jaGlsZHJlbigiLmxheXVpLXRyZWUtZWRpdElucHV0IikudmFsKEYpLmZvY3VzKCk7CgogICAgICAgIHZhciBqID0gZnVuY3Rpb24gaihlKSB7CiAgICAgICAgICB2YXIgaSA9IGUudmFsKCkudHJpbSgpOwogICAgICAgICAgaSA9IGkgPyBpIDogci50ZXh0LmRlZmF1bHROb2RlTmFtZSwgZS5yZW1vdmUoKSwgZC5jaGlsZHJlbigiLiIgKyB5KS5odG1sKGkpLCBnLmRhdGEudGl0bGUgPSBpLCByLm9wZXJhdGUgJiYgci5vcGVyYXRlKGcpOwogICAgICAgIH07CgogICAgICAgIGQuY2hpbGRyZW4oIi5sYXl1aS10cmVlLWVkaXRJbnB1dCIpLmJsdXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgaihpKHRoaXMpKTsKICAgICAgICB9KSwgZC5jaGlsZHJlbigiLmxheXVpLXRyZWUtZWRpdElucHV0Iikub24oImtleWRvd24iLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgMTMgPT09IGUua2V5Q29kZSAmJiAoZS5wcmV2ZW50RGVmYXVsdCgpLCBqKGkodGhpcykpKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIG4uY29uZmlybSgiXHU3ODZFXHU4QkE0XHU1MjIwXHU5NjY0XHU4QkU1XHU4MjgyXHU3MEI5IFwiPHNwYW4gc3R5bGU9XCJjb2xvcjogIzk5OTtcIj4iICsgKGEudGl0bGUgfHwgIiIpICsgIjwvc3Bhbj5cIiBcdTU0MTdcdUZGMUYiLCBmdW5jdGlvbiAoYSkgewogICAgICAgIGlmIChyLm9wZXJhdGUgJiYgci5vcGVyYXRlKGcpLCBnLnN0YXR1cyA9ICJyZW1vdmUiLCBuLmNsb3NlKGEpLCAhZS5wcmV2KCIuIiArIHMpWzBdICYmICFlLm5leHQoIi4iICsgcylbMF0gJiYgIWUucGFyZW50KCIuIiArIHYpWzBdKSByZXR1cm4gZS5yZW1vdmUoKSwgdm9pZCB0LmVsZW0uYXBwZW5kKHQuZWxlbU5vbmUpOwoKICAgICAgICBpZiAoZS5zaWJsaW5ncygiLiIgKyBzKS5jaGlsZHJlbigiLiIgKyBwKVswXSkgewogICAgICAgICAgaWYgKHIuc2hvd0NoZWNrYm94KSB7CiAgICAgICAgICAgIHZhciBsID0gZnVuY3Rpb24gbChlKSB7CiAgICAgICAgICAgICAgaWYgKGUucGFyZW50cygiLiIgKyBzKVswXSkgewogICAgICAgICAgICAgICAgdmFyIGEgPSBlLnNpYmxpbmdzKCIuIiArIHMpLmNoaWxkcmVuKCIuIiArIHApLAogICAgICAgICAgICAgICAgICAgIG4gPSBlLnBhcmVudCgiLiIgKyB2KS5wcmV2KCksCiAgICAgICAgICAgICAgICAgICAgciA9IG4uZmluZCgnaW5wdXRbc2FtZT0ibGF5dWlUcmVlQ2hlY2siXScpWzBdLAogICAgICAgICAgICAgICAgICAgIGMgPSAxLAogICAgICAgICAgICAgICAgICAgIGQgPSAwOwogICAgICAgICAgICAgICAgMCA9PSByLmNoZWNrZWQgJiYgKGEuZWFjaChmdW5jdGlvbiAoZSwgYSkgewogICAgICAgICAgICAgICAgICB2YXIgbiA9IGkoYSkuZmluZCgnaW5wdXRbc2FtZT0ibGF5dWlUcmVlQ2hlY2siXScpWzBdOwogICAgICAgICAgICAgICAgICAwICE9IG4uY2hlY2tlZCB8fCBuLmRpc2FibGVkIHx8IChjID0gMCksIG4uZGlzYWJsZWQgfHwgKGQgPSAxKTsKICAgICAgICAgICAgICAgIH0pLCAxID09IGMgJiYgMSA9PSBkICYmIChyLmNoZWNrZWQgPSAhMCwgdC5yZW5kZXJGb3JtKCJjaGVja2JveCIpLCBsKG4ucGFyZW50KCIuIiArIHMpKSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGwoZSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHIuc2hvd0xpbmUpIHsKICAgICAgICAgICAgdmFyIGQgPSBlLnNpYmxpbmdzKCIuIiArIHMpLAogICAgICAgICAgICAgICAgaCA9IDEsCiAgICAgICAgICAgICAgICBmID0gZS5wYXJlbnQoIi4iICsgdik7CiAgICAgICAgICAgIGxheXVpLmVhY2goZCwgZnVuY3Rpb24gKGUsIGEpIHsKICAgICAgICAgICAgICBpKGEpLmNoaWxkcmVuKCIuIiArIHYpWzBdIHx8IChoID0gMCk7CiAgICAgICAgICAgIH0pLCAxID09IGggPyAoYlswXSB8fCAoZi5yZW1vdmVDbGFzcyh4KSwgZC5jaGlsZHJlbigiLiIgKyB2KS5hZGRDbGFzcyhtKSwgZC5jaGlsZHJlbigiLiIgKyB2KS5jaGlsZHJlbigiLiIgKyBzKS5yZW1vdmVDbGFzcyhrKSksIGUubmV4dCgpWzBdID8gZi5jaGlsZHJlbigiLiIgKyBzKS5sYXN0KCkuY2hpbGRyZW4oIi4iICsgdikuY2hpbGRyZW4oIi4iICsgcykubGFzdCgpLmFkZENsYXNzKGspIDogZS5wcmV2KCkuY2hpbGRyZW4oIi4iICsgdikuY2hpbGRyZW4oIi4iICsgcykubGFzdCgpLmFkZENsYXNzKGspLCBlLm5leHQoKVswXSB8fCBlLnBhcmVudHMoIi4iICsgcylbMV0gfHwgZS5wYXJlbnRzKCIuIiArIHMpLmVxKDApLm5leHQoKVswXSB8fCBlLnByZXYoIi4iICsgcykuYWRkQ2xhc3MoaykpIDogIWUubmV4dCgpWzBdICYmIGUuaGFzQ2xhc3MoaykgJiYgZS5wcmV2KCkuYWRkQ2xhc3Moayk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciB5ID0gZS5wYXJlbnQoIi4iICsgdikucHJldigpOwoKICAgICAgICAgIGlmIChyLnNob3dMaW5lKSB7CiAgICAgICAgICAgIHkuZmluZCgiLiIgKyBvKS5yZW1vdmVDbGFzcygibGF5dWktdHJlZS1pY29uIiksIHkuZmluZCgiLiIgKyBvKS5jaGlsZHJlbigiLmxheXVpLWljb24iKS5yZW1vdmVDbGFzcyh1KS5hZGRDbGFzcygibGF5dWktaWNvbi1maWxlIik7CiAgICAgICAgICAgIHZhciB3ID0geS5wYXJlbnRzKCIuIiArIHYpLmVxKDApOwogICAgICAgICAgICB3LmFkZENsYXNzKHgpLCB3LmNoaWxkcmVuKCIuIiArIHMpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGkodGhpcykuY2hpbGRyZW4oIi4iICsgdikuY2hpbGRyZW4oIi4iICsgcykubGFzdCgpLmFkZENsYXNzKGspOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB5LmZpbmQoIi5sYXl1aS10cmVlLWljb25BcnJvdyIpLmFkZENsYXNzKGMpOwoKICAgICAgICAgIGUucGFyZW50cygiLiIgKyBzKS5lcSgwKS5yZW1vdmVDbGFzcyhDKSwgZS5wYXJlbnQoIi4iICsgdikucmVtb3ZlKCk7CiAgICAgICAgfQoKICAgICAgICBlLnJlbW92ZSgpOwogICAgICB9KTsKICAgIH0pOwogIH0sIGIucHJvdG90eXBlLmV2ZW50cyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICBhID0gZS5jb25maWc7CiAgICBlLmVsZW0uZmluZCgiLmxheXVpLXRyZWUtY2hlY2tlZEZpcnN0Iik7CiAgICBlLnNldENoZWNrZWQoZS5jaGVja2lkcyksIGUuZWxlbS5maW5kKCIubGF5dWktdHJlZS1zZWFyY2giKS5vbigia2V5dXAiLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBuID0gaSh0aGlzKSwKICAgICAgICAgIHQgPSBuLnZhbCgpLAogICAgICAgICAgciA9IG4ubmV4dEFsbCgpLAogICAgICAgICAgbCA9IFtdOwogICAgICByLmZpbmQoIi4iICsgeSkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGUgPSBpKHRoaXMpLnBhcmVudHMoIi4iICsgcCk7CgogICAgICAgIGlmIChpKHRoaXMpLmh0bWwoKS5pbmRleE9mKHQpICE9IC0xKSB7CiAgICAgICAgICBsLnB1c2goaSh0aGlzKS5wYXJlbnQoKSk7CgogICAgICAgICAgdmFyIGEgPSBmdW5jdGlvbiBhKGUpIHsKICAgICAgICAgICAgZS5hZGRDbGFzcygibGF5dWktdHJlZS1zZWFyY2hTaG93IiksIGUucGFyZW50KCIuIiArIHYpWzBdICYmIGEoZS5wYXJlbnQoIi4iICsgdikucGFyZW50KCIuIiArIHMpKTsKICAgICAgICAgIH07CgogICAgICAgICAgYShlLnBhcmVudCgiLiIgKyBzKSk7CiAgICAgICAgfQogICAgICB9KSwgci5maW5kKCIuIiArIHApLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBlID0gaSh0aGlzKS5wYXJlbnQoIi4iICsgcyk7CiAgICAgICAgZS5oYXNDbGFzcygibGF5dWktdHJlZS1zZWFyY2hTaG93IikgfHwgZS5hZGRDbGFzcyhjKTsKICAgICAgfSksIDAgPT0gci5maW5kKCIubGF5dWktdHJlZS1zZWFyY2hTaG93IikubGVuZ3RoICYmIGUuZWxlbS5hcHBlbmQoZS5lbGVtTm9uZSksIGEub25zZWFyY2ggJiYgYS5vbnNlYXJjaCh7CiAgICAgICAgZWxlbTogbAogICAgICB9KTsKICAgIH0pLCBlLmVsZW0uZmluZCgiLmxheXVpLXRyZWUtc2VhcmNoIikub24oImtleWRvd24iLCBmdW5jdGlvbiAoKSB7CiAgICAgIGkodGhpcykubmV4dEFsbCgpLmZpbmQoIi4iICsgcCkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGUgPSBpKHRoaXMpLnBhcmVudCgiLiIgKyBzKTsKICAgICAgICBlLnJlbW92ZUNsYXNzKCJsYXl1aS10cmVlLXNlYXJjaFNob3cgIiArIGMpOwogICAgICB9KSwgaSgiLmxheXVpLXRyZWUtZW1wdHlUZXh0IilbMF0gJiYgaSgiLmxheXVpLXRyZWUtZW1wdHlUZXh0IikucmVtb3ZlKCk7CiAgICB9KTsKICB9LCBiLnByb3RvdHlwZS5nZXRDaGVja2VkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIGEgPSBlLmNvbmZpZywKICAgICAgICBuID0gW10sCiAgICAgICAgdCA9IFtdOwogICAgZS5lbGVtLmZpbmQoIi5sYXl1aS1mb3JtLWNoZWNrZWQiKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgbi5wdXNoKGkodGhpcykucHJldigpWzBdLnZhbHVlKTsKICAgIH0pOwoKICAgIHZhciByID0gZnVuY3Rpb24gcihlLCBhKSB7CiAgICAgIGxheXVpLmVhY2goZSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgICBsYXl1aS5lYWNoKG4sIGZ1bmN0aW9uIChlLCBuKSB7CiAgICAgICAgICBpZiAodC5pZCA9PSBuKSB7CiAgICAgICAgICAgIHZhciBsID0gaS5leHRlbmQoe30sIHQpOwogICAgICAgICAgICByZXR1cm4gZGVsZXRlIGwuY2hpbGRyZW4sIGEucHVzaChsKSwgdC5jaGlsZHJlbiAmJiAobC5jaGlsZHJlbiA9IFtdLCByKHQuY2hpbGRyZW4sIGwuY2hpbGRyZW4pKSwgITA7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfTsKCiAgICByZXR1cm4gcihpLmV4dGVuZCh7fSwgYS5kYXRhKSwgdCksIHQ7CiAgfSwgYi5wcm90b3R5cGUuc2V0Q2hlY2tlZCA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgYSA9IHRoaXM7CiAgICBhLmNvbmZpZzsKICAgIGEuZWxlbS5maW5kKCIuIiArIHMpLmVhY2goZnVuY3Rpb24gKGEsIG4pIHsKICAgICAgdmFyIHQgPSBpKHRoaXMpLmRhdGEoImlkIiksCiAgICAgICAgICByID0gaShuKS5jaGlsZHJlbigiLiIgKyBwKS5maW5kKCdpbnB1dFtzYW1lPSJsYXl1aVRyZWVDaGVjayJdJyksCiAgICAgICAgICBsID0gci5uZXh0KCk7CgogICAgICBpZiAoIm51bWJlciIgPT0gdHlwZW9mIGUpIHsKICAgICAgICBpZiAodCA9PSBlKSByZXR1cm4gclswXS5jaGVja2VkIHx8IGwuY2xpY2soKSwgITE7CiAgICAgIH0gZWxzZSAib2JqZWN0IiA9PSBfdHlwZW9mKGUpICYmIGxheXVpLmVhY2goZSwgZnVuY3Rpb24gKGUsIGkpIHsKICAgICAgICBpZiAoaSA9PSB0ICYmICFyWzBdLmNoZWNrZWQpIHJldHVybiBsLmNsaWNrKCksICEwOwogICAgICB9KTsKICAgIH0pOwogIH0sIGwudGhhdCA9IHt9LCBsLmNvbmZpZyA9IHt9LCByLnJlbG9hZCA9IGZ1bmN0aW9uIChlLCBpKSB7CiAgICB2YXIgYSA9IGwudGhhdFtlXTsKICAgIHJldHVybiBhLnJlbG9hZChpKSwgbC5jYWxsKGEpOwogIH0sIHIuZ2V0Q2hlY2tlZCA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgaSA9IGwudGhhdFtlXTsKICAgIHJldHVybiBpLmdldENoZWNrZWQoKTsKICB9LCByLnNldENoZWNrZWQgPSBmdW5jdGlvbiAoZSwgaSkgewogICAgdmFyIGEgPSBsLnRoYXRbZV07CiAgICByZXR1cm4gYS5zZXRDaGVja2VkKGkpOwogIH0sIHIucmVuZGVyID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBpID0gbmV3IGIoZSk7CiAgICByZXR1cm4gbC5jYWxsKGkpOwogIH0sIGUodCwgcik7Cn0pOwpsYXl1aS5kZWZpbmUoWyJsYXl0cGwiLCAiZm9ybSJdLCBmdW5jdGlvbiAoZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIGEgPSBsYXl1aS4kLAogICAgICB0ID0gbGF5dWkubGF5dHBsLAogICAgICBpID0gbGF5dWkuZm9ybSwKICAgICAgbiA9ICJ0cmFuc2ZlciIsCiAgICAgIGwgPSB7CiAgICBjb25maWc6IHt9LAogICAgaW5kZXg6IGxheXVpW25dID8gbGF5dWlbbl0uaW5kZXggKyAxZTQgOiAwLAogICAgc2V0OiBmdW5jdGlvbiBzZXQoZSkgewogICAgICB2YXIgdCA9IHRoaXM7CiAgICAgIHJldHVybiB0LmNvbmZpZyA9IGEuZXh0ZW5kKHt9LCB0LmNvbmZpZywgZSksIHQ7CiAgICB9LAogICAgb246IGZ1bmN0aW9uIG9uKGUsIGEpIHsKICAgICAgcmV0dXJuIGxheXVpLm9uZXZlbnQuY2FsbCh0aGlzLCBuLCBlLCBhKTsKICAgIH0KICB9LAogICAgICByID0gZnVuY3Rpb24gcigpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICBhID0gZS5jb25maWcsCiAgICAgICAgdCA9IGEuaWQgfHwgZS5pbmRleDsKICAgIHJldHVybiByLnRoYXRbdF0gPSBlLCByLmNvbmZpZ1t0XSA9IGEsIHsKICAgICAgY29uZmlnOiBhLAogICAgICByZWxvYWQ6IGZ1bmN0aW9uIHJlbG9hZChhKSB7CiAgICAgICAgZS5yZWxvYWQuY2FsbChlLCBhKTsKICAgICAgfSwKICAgICAgZ2V0RGF0YTogZnVuY3Rpb24gZ2V0RGF0YSgpIHsKICAgICAgICByZXR1cm4gZS5nZXREYXRhLmNhbGwoZSk7CiAgICAgIH0KICAgIH07CiAgfSwKICAgICAgYyA9ICJsYXl1aS1oaWRlIiwKICAgICAgbyA9ICJsYXl1aS1idG4tZGlzYWJsZWQiLAogICAgICBkID0gImxheXVpLW5vbmUiLAogICAgICBzID0gImxheXVpLXRyYW5zZmVyLWJveCIsCiAgICAgIHUgPSAibGF5dWktdHJhbnNmZXItaGVhZGVyIiwKICAgICAgaCA9ICJsYXl1aS10cmFuc2Zlci1zZWFyY2giLAogICAgICBmID0gImxheXVpLXRyYW5zZmVyLWFjdGl2ZSIsCiAgICAgIHkgPSAibGF5dWktdHJhbnNmZXItZGF0YSIsCiAgICAgIHAgPSBmdW5jdGlvbiBwKGUpIHsKICAgIHJldHVybiBlID0gZSB8fCB7fSwgWyc8ZGl2IGNsYXNzPSJsYXl1aS10cmFuc2Zlci1ib3giIGRhdGEtaW5kZXg9IicgKyBlLmluZGV4ICsgJyI+JywgJzxkaXYgY2xhc3M9ImxheXVpLXRyYW5zZmVyLWhlYWRlciI+JywgJzxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iJyArIGUuY2hlY2tBbGxOYW1lICsgJyIgbGF5LWZpbHRlcj0ibGF5VHJhbnNmZXJDaGVja2JveCIgbGF5LXR5cGU9ImFsbCIgbGF5LXNraW49InByaW1hcnkiIHRpdGxlPSJ7eyBkLmRhdGEudGl0bGVbJyArIGUuaW5kZXggKyAiXSB8fCAnbGlzdCIgKyAoZS5pbmRleCArIDEpICsgIicgfX1cIj4iLCAiPC9kaXY+IiwgInt7IyBpZihkLmRhdGEuc2hvd1NlYXJjaCl7IH19IiwgJzxkaXYgY2xhc3M9ImxheXVpLXRyYW5zZmVyLXNlYXJjaCI+JywgJzxpIGNsYXNzPSJsYXl1aS1pY29uIGxheXVpLWljb24tc2VhcmNoIj48L2k+JywgIjxpbnB1dCB0eXBlPVwiaW5wdXRcIiBjbGFzcz1cImxheXVpLWlucHV0XCIgcGxhY2Vob2xkZXI9XCJcdTUxNzNcdTk1MkVcdThCQ0RcdTY0MUNcdTdEMjJcIj4iLCAiPC9kaXY+IiwgInt7IyB9IH19IiwgJzx1bCBjbGFzcz0ibGF5dWktdHJhbnNmZXItZGF0YSI+PC91bD4nLCAiPC9kaXY+Il0uam9pbigiIik7CiAgfSwKICAgICAgdiA9IFsnPGRpdiBjbGFzcz0ibGF5dWktdHJhbnNmZXIgbGF5dWktZm9ybSBsYXl1aS1ib3JkZXItYm94IiBsYXktZmlsdGVyPSJMQVktdHJhbnNmZXIte3sgZC5pbmRleCB9fSI+JywgcCh7CiAgICBpbmRleDogMCwKICAgIGNoZWNrQWxsTmFtZTogImxheVRyYW5zZmVyTGVmdENoZWNrQWxsIgogIH0pLCAnPGRpdiBjbGFzcz0ibGF5dWktdHJhbnNmZXItYWN0aXZlIj4nLCAnPGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJsYXl1aS1idG4gbGF5dWktYnRuLXNtIGxheXVpLWJ0bi1wcmltYXJ5IGxheXVpLWJ0bi1kaXNhYmxlZCIgZGF0YS1pbmRleD0iMCI+JywgJzxpIGNsYXNzPSJsYXl1aS1pY29uIGxheXVpLWljb24tbmV4dCI+PC9pPicsICI8L2J1dHRvbj4iLCAnPGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJsYXl1aS1idG4gbGF5dWktYnRuLXNtIGxheXVpLWJ0bi1wcmltYXJ5IGxheXVpLWJ0bi1kaXNhYmxlZCIgZGF0YS1pbmRleD0iMSI+JywgJzxpIGNsYXNzPSJsYXl1aS1pY29uIGxheXVpLWljb24tcHJldiI+PC9pPicsICI8L2J1dHRvbj4iLCAiPC9kaXY+IiwgcCh7CiAgICBpbmRleDogMSwKICAgIGNoZWNrQWxsTmFtZTogImxheVRyYW5zZmVyUmlnaHRDaGVja0FsbCIKICB9KSwgIjwvZGl2PiJdLmpvaW4oIiIpLAogICAgICB4ID0gZnVuY3Rpb24geChlKSB7CiAgICB2YXIgdCA9IHRoaXM7CiAgICB0LmluZGV4ID0gKytsLmluZGV4LCB0LmNvbmZpZyA9IGEuZXh0ZW5kKHt9LCB0LmNvbmZpZywgbC5jb25maWcsIGUpLCB0LnJlbmRlcigpOwogIH07CgogIHgucHJvdG90eXBlLmNvbmZpZyA9IHsKICAgIHRpdGxlOiBbIlx1NTIxN1x1ODg2OFx1NEUwMCIsICJcdTUyMTdcdTg4NjhcdTRFOEMiXSwKICAgIHdpZHRoOiAyMDAsCiAgICBoZWlnaHQ6IDM2MCwKICAgIGRhdGE6IFtdLAogICAgdmFsdWU6IFtdLAogICAgc2hvd1NlYXJjaDogITEsCiAgICBpZDogIiIsCiAgICB0ZXh0OiB7CiAgICAgIG5vbmU6ICJcdTY1RTBcdTY1NzBcdTYzNkUiLAogICAgICBzZWFyY2hOb25lOiAiXHU2NUUwXHU1MzM5XHU5MTREXHU2NTcwXHU2MzZFIgogICAgfQogIH0sIHgucHJvdG90eXBlLnJlbG9hZCA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IHRoaXM7CiAgICB0LmNvbmZpZyA9IGEuZXh0ZW5kKHt9LCB0LmNvbmZpZywgZSksIHQucmVuZGVyKCk7CiAgfSwgeC5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIGkgPSBlLmNvbmZpZywKICAgICAgICBuID0gZS5lbGVtID0gYSh0KHYpLnJlbmRlcih7CiAgICAgIGRhdGE6IGksCiAgICAgIGluZGV4OiBlLmluZGV4CiAgICB9KSksCiAgICAgICAgbCA9IGkuZWxlbSA9IGEoaS5lbGVtKTsKICAgIGxbMF0gJiYgKGkuZGF0YSA9IGkuZGF0YSB8fCBbXSwgaS52YWx1ZSA9IGkudmFsdWUgfHwgW10sIGUua2V5ID0gaS5pZCB8fCBlLmluZGV4LCBsLmh0bWwoZS5lbGVtKSwgZS5sYXlCb3ggPSBlLmVsZW0uZmluZCgiLiIgKyBzKSwgZS5sYXlIZWFkZXIgPSBlLmVsZW0uZmluZCgiLiIgKyB1KSwgZS5sYXlTZWFyY2ggPSBlLmVsZW0uZmluZCgiLiIgKyBoKSwgZS5sYXlEYXRhID0gbi5maW5kKCIuIiArIHkpLCBlLmxheUJ0biA9IG4uZmluZCgiLiIgKyBmICsgIiAubGF5dWktYnRuIiksIGUubGF5Qm94LmNzcyh7CiAgICAgIHdpZHRoOiBpLndpZHRoLAogICAgICBoZWlnaHQ6IGkuaGVpZ2h0CiAgICB9KSwgZS5sYXlEYXRhLmNzcyh7CiAgICAgIGhlaWdodDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBpLmhlaWdodCAtIGUubGF5SGVhZGVyLm91dGVySGVpZ2h0KCkgLSBlLmxheVNlYXJjaC5vdXRlckhlaWdodCgpIC0gMjsKICAgICAgfSgpCiAgICB9KSwgZS5yZW5kZXJEYXRhKCksIGUuZXZlbnRzKCkpOwogIH0sIHgucHJvdG90eXBlLnJlbmRlckRhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgYSA9IChlLmNvbmZpZywgW3sKICAgICAgY2hlY2tOYW1lOiAibGF5VHJhbnNmZXJMZWZ0Q2hlY2siLAogICAgICB2aWV3czogW10KICAgIH0sIHsKICAgICAgY2hlY2tOYW1lOiAibGF5VHJhbnNmZXJSaWdodENoZWNrIiwKICAgICAgdmlld3M6IFtdCiAgICB9XSk7CiAgICBlLnBhcnNlRGF0YShmdW5jdGlvbiAoZSkgewogICAgICB2YXIgdCA9IGUuc2VsZWN0ZWQgPyAxIDogMCwKICAgICAgICAgIGkgPSBbIjxsaT4iLCAnPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuYW1lPSInICsgYVt0XS5jaGVja05hbWUgKyAnIiBsYXktc2tpbj0icHJpbWFyeSIgbGF5LWZpbHRlcj0ibGF5VHJhbnNmZXJDaGVja2JveCIgdGl0bGU9IicgKyBlLnRpdGxlICsgJyInICsgKGUuZGlzYWJsZWQgPyAiIGRpc2FibGVkIiA6ICIiKSArIChlLmNoZWNrZWQgPyAiIGNoZWNrZWQiIDogIiIpICsgJyB2YWx1ZT0iJyArIGUudmFsdWUgKyAnIj4nLCAiPC9saT4iXS5qb2luKCIiKTsKICAgICAgYVt0XS52aWV3cy5wdXNoKGkpLCBkZWxldGUgZS5zZWxlY3RlZDsKICAgIH0pLCBlLmxheURhdGEuZXEoMCkuaHRtbChhWzBdLnZpZXdzLmpvaW4oIiIpKSwgZS5sYXlEYXRhLmVxKDEpLmh0bWwoYVsxXS52aWV3cy5qb2luKCIiKSksIGUucmVuZGVyQ2hlY2tCdG4oKTsKICB9LCB4LnByb3RvdHlwZS5yZW5kZXJGb3JtID0gZnVuY3Rpb24gKGUpIHsKICAgIGkucmVuZGVyKGUsICJMQVktdHJhbnNmZXItIiArIHRoaXMuaW5kZXgpOwogIH0sIHgucHJvdG90eXBlLnJlbmRlckNoZWNrQnRuID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gdGhpcywKICAgICAgICBpID0gdC5jb25maWc7CiAgICBlID0gZSB8fCB7fSwgdC5sYXlCb3guZWFjaChmdW5jdGlvbiAobikgewogICAgICB2YXIgbCA9IGEodGhpcyksCiAgICAgICAgICByID0gbC5maW5kKCIuIiArIHkpLAogICAgICAgICAgZCA9IGwuZmluZCgiLiIgKyB1KS5maW5kKCdpbnB1dFt0eXBlPSJjaGVja2JveCJdJyksCiAgICAgICAgICBzID0gci5maW5kKCdpbnB1dFt0eXBlPSJjaGVja2JveCJdJyksCiAgICAgICAgICBoID0gMCwKICAgICAgICAgIGYgPSAhMTsKCiAgICAgIGlmIChzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBlID0gYSh0aGlzKS5kYXRhKCJoaWRlIik7CiAgICAgICAgKHRoaXMuY2hlY2tlZCB8fCB0aGlzLmRpc2FibGVkIHx8IGUpICYmIGgrKywgdGhpcy5jaGVja2VkICYmICFlICYmIChmID0gITApOwogICAgICB9KSwgZC5wcm9wKCJjaGVja2VkIiwgZiAmJiBoID09PSBzLmxlbmd0aCksIHQubGF5QnRuLmVxKG4pW2YgPyAicmVtb3ZlQ2xhc3MiIDogImFkZENsYXNzIl0obyksICFlLnN0b3BOb25lKSB7CiAgICAgICAgdmFyIHAgPSByLmNoaWxkcmVuKCJsaTpub3QoLiIgKyBjICsgIikiKS5sZW5ndGg7CiAgICAgICAgdC5ub25lVmlldyhyLCBwID8gIiIgOiBpLnRleHQubm9uZSk7CiAgICAgIH0KICAgIH0pLCB0LnJlbmRlckZvcm0oImNoZWNrYm94Iik7CiAgfSwgeC5wcm90b3R5cGUubm9uZVZpZXcgPSBmdW5jdGlvbiAoZSwgdCkgewogICAgdmFyIGkgPSBhKCc8cCBjbGFzcz0ibGF5dWktbm9uZSI+JyArICh0IHx8ICIiKSArICI8L3A+Iik7CiAgICBlLmZpbmQoIi4iICsgZClbMF0gJiYgZS5maW5kKCIuIiArIGQpLnJlbW92ZSgpLCB0LnJlcGxhY2UoL1xzL2csICIiKSAmJiBlLmFwcGVuZChpKTsKICB9LCB4LnByb3RvdHlwZS5zZXRWYWx1ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICB0ID0gZS5jb25maWcsCiAgICAgICAgaSA9IFtdOwogICAgcmV0dXJuIGUubGF5Qm94LmVxKDEpLmZpbmQoIi4iICsgeSArICcgaW5wdXRbdHlwZT0iY2hlY2tib3giXScpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IGEodGhpcykuZGF0YSgiaGlkZSIpOwogICAgICBlIHx8IGkucHVzaCh0aGlzLnZhbHVlKTsKICAgIH0pLCB0LnZhbHVlID0gaSwgZTsKICB9LCB4LnByb3RvdHlwZS5wYXJzZURhdGEgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSB0aGlzLAogICAgICAgIGkgPSB0LmNvbmZpZywKICAgICAgICBuID0gW107CiAgICByZXR1cm4gbGF5dWkuZWFjaChpLmRhdGEsIGZ1bmN0aW9uICh0LCBsKSB7CiAgICAgIGwgPSAoImZ1bmN0aW9uIiA9PSB0eXBlb2YgaS5wYXJzZURhdGEgPyBpLnBhcnNlRGF0YShsKSA6IGwpIHx8IGwsIG4ucHVzaChsID0gYS5leHRlbmQoe30sIGwpKSwgbGF5dWkuZWFjaChpLnZhbHVlLCBmdW5jdGlvbiAoZSwgYSkgewogICAgICAgIGEgPT0gbC52YWx1ZSAmJiAobC5zZWxlY3RlZCA9ICEwKTsKICAgICAgfSksIGUgJiYgZShsKTsKICAgIH0pLCBpLmRhdGEgPSBuLCB0OwogIH0sIHgucHJvdG90eXBlLmdldERhdGEgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIGEgPSB0aGlzLAogICAgICAgIHQgPSBhLmNvbmZpZywKICAgICAgICBpID0gW107CiAgICByZXR1cm4gYS5zZXRWYWx1ZSgpLCBsYXl1aS5lYWNoKGUgfHwgdC52YWx1ZSwgZnVuY3Rpb24gKGUsIGEpIHsKICAgICAgbGF5dWkuZWFjaCh0LmRhdGEsIGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgICAgZGVsZXRlIHQuc2VsZWN0ZWQsIGEgPT0gdC52YWx1ZSAmJiBpLnB1c2godCk7CiAgICAgIH0pOwogICAgfSksIGk7CiAgfSwgeC5wcm90b3R5cGUuZXZlbnRzID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIHQgPSBlLmNvbmZpZzsKICAgIGUuZWxlbS5vbigiY2xpY2siLCAnaW5wdXRbbGF5LWZpbHRlcj0ibGF5VHJhbnNmZXJDaGVja2JveCJdKycsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHQgPSBhKHRoaXMpLnByZXYoKSwKICAgICAgICAgIGkgPSB0WzBdLmNoZWNrZWQsCiAgICAgICAgICBuID0gdC5wYXJlbnRzKCIuIiArIHMpLmVxKDApLmZpbmQoIi4iICsgeSk7CiAgICAgIHRbMF0uZGlzYWJsZWQgfHwgKCJhbGwiID09PSB0LmF0dHIoImxheS10eXBlIikgJiYgbi5maW5kKCdpbnB1dFt0eXBlPSJjaGVja2JveCJdJykuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5kaXNhYmxlZCB8fCAodGhpcy5jaGVja2VkID0gaSk7CiAgICAgIH0pLCBlLnJlbmRlckNoZWNrQnRuKHsKICAgICAgICBzdG9wTm9uZTogITAKICAgICAgfSkpOwogICAgfSksIGUubGF5QnRuLm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGkgPSBhKHRoaXMpLAogICAgICAgICAgbiA9IGkuZGF0YSgiaW5kZXgiKSwKICAgICAgICAgIGwgPSBlLmxheUJveC5lcShuKSwKICAgICAgICAgIHIgPSBbXTsKCiAgICAgIGlmICghaS5oYXNDbGFzcyhvKSkgewogICAgICAgIGUubGF5Qm94LmVxKG4pLmVhY2goZnVuY3Rpb24gKHQpIHsKICAgICAgICAgIHZhciBpID0gYSh0aGlzKSwKICAgICAgICAgICAgICBuID0gaS5maW5kKCIuIiArIHkpOwogICAgICAgICAgbi5jaGlsZHJlbigibGkiKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHQgPSBhKHRoaXMpLAogICAgICAgICAgICAgICAgaSA9IHQuZmluZCgnaW5wdXRbdHlwZT0iY2hlY2tib3giXScpLAogICAgICAgICAgICAgICAgbiA9IGkuZGF0YSgiaGlkZSIpOwogICAgICAgICAgICBpWzBdLmNoZWNrZWQgJiYgIW4gJiYgKGlbMF0uY2hlY2tlZCA9ICExLCBsLnNpYmxpbmdzKCIuIiArIHMpLmZpbmQoIi4iICsgeSkuYXBwZW5kKHQuY2xvbmUoKSksIHQucmVtb3ZlKCksIHIucHVzaChpWzBdLnZhbHVlKSksIGUuc2V0VmFsdWUoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pLCBlLnJlbmRlckNoZWNrQnRuKCk7CiAgICAgICAgdmFyIGMgPSBsLnNpYmxpbmdzKCIuIiArIHMpLmZpbmQoIi4iICsgaCArICIgaW5wdXQiKTsKICAgICAgICAiIiA9PT0gYy52YWwoKSB8fCBjLnRyaWdnZXIoImtleXVwIiksIHQub25jaGFuZ2UgJiYgdC5vbmNoYW5nZShlLmdldERhdGEociksIG4pOwogICAgICB9CiAgICB9KSwgZS5sYXlTZWFyY2guZmluZCgiaW5wdXQiKS5vbigia2V5dXAiLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBpID0gdGhpcy52YWx1ZSwKICAgICAgICAgIG4gPSBhKHRoaXMpLnBhcmVudHMoIi4iICsgaCkuZXEoMCkuc2libGluZ3MoIi4iICsgeSksCiAgICAgICAgICBsID0gbi5jaGlsZHJlbigibGkiKTsKICAgICAgbC5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZSA9IGEodGhpcyksCiAgICAgICAgICAgIHQgPSBlLmZpbmQoJ2lucHV0W3R5cGU9ImNoZWNrYm94Il0nKSwKICAgICAgICAgICAgbiA9IHRbMF0udGl0bGUuaW5kZXhPZihpKSAhPT0gLTE7CiAgICAgICAgZVtuID8gInJlbW92ZUNsYXNzIiA6ICJhZGRDbGFzcyJdKGMpLCB0LmRhdGEoImhpZGUiLCAhbik7CiAgICAgIH0pLCBlLnJlbmRlckNoZWNrQnRuKCk7CiAgICAgIHZhciByID0gbC5sZW5ndGggPT09IG4uY2hpbGRyZW4oImxpLiIgKyBjKS5sZW5ndGg7CiAgICAgIGUubm9uZVZpZXcobiwgciA/IHQudGV4dC5zZWFyY2hOb25lIDogIiIpOwogICAgfSk7CiAgfSwgci50aGF0ID0ge30sIHIuY29uZmlnID0ge30sIGwucmVsb2FkID0gZnVuY3Rpb24gKGUsIGEpIHsKICAgIHZhciB0ID0gci50aGF0W2VdOwogICAgcmV0dXJuIHQucmVsb2FkKGEpLCByLmNhbGwodCk7CiAgfSwgbC5nZXREYXRhID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBhID0gci50aGF0W2VdOwogICAgcmV0dXJuIGEuZ2V0RGF0YSgpOwogIH0sIGwucmVuZGVyID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBhID0gbmV3IHgoZSk7CiAgICByZXR1cm4gci5jYWxsKGEpOwogIH0sIGUobiwgbCk7Cn0pOwpsYXl1aS5kZWZpbmUoWyJsYXl0cGwiLCAibGF5cGFnZSIsICJsYXllciIsICJmb3JtIiwgInV0aWwiXSwgZnVuY3Rpb24gKGUpIHsKICAidXNlIHN0cmljdCI7CgogIHZhciB0ID0gbGF5dWkuJCwKICAgICAgaSA9IGxheXVpLmxheXRwbCwKICAgICAgYSA9IGxheXVpLmxheXBhZ2UsCiAgICAgIGwgPSBsYXl1aS5sYXllciwKICAgICAgbiA9IGxheXVpLmZvcm0sCiAgICAgIG8gPSBsYXl1aS51dGlsLAogICAgICByID0gbGF5dWkuaGludCgpLAogICAgICBjID0gbGF5dWkuZGV2aWNlKCksCiAgICAgIGQgPSB7CiAgICBjb25maWc6IHsKICAgICAgY2hlY2tOYW1lOiAiTEFZX0NIRUNLRUQiLAogICAgICBpbmRleE5hbWU6ICJMQVlfVEFCTEVfSU5ERVgiCiAgICB9LAogICAgY2FjaGU6IHt9LAogICAgaW5kZXg6IGxheXVpLnRhYmxlID8gbGF5dWkudGFibGUuaW5kZXggKyAxZTQgOiAwLAogICAgc2V0OiBmdW5jdGlvbiBzZXQoZSkgewogICAgICB2YXIgaSA9IHRoaXM7CiAgICAgIHJldHVybiBpLmNvbmZpZyA9IHQuZXh0ZW5kKHt9LCBpLmNvbmZpZywgZSksIGk7CiAgICB9LAogICAgb246IGZ1bmN0aW9uIG9uKGUsIHQpIHsKICAgICAgcmV0dXJuIGxheXVpLm9uZXZlbnQuY2FsbCh0aGlzLCBoLCBlLCB0KTsKICAgIH0KICB9LAogICAgICBzID0gZnVuY3Rpb24gcygpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICB0ID0gZS5jb25maWcsCiAgICAgICAgaSA9IHQuaWQgfHwgdC5pbmRleDsKICAgIHJldHVybiBpICYmIChzLnRoYXRbaV0gPSBlLCBzLmNvbmZpZ1tpXSA9IHQpLCB7CiAgICAgIGNvbmZpZzogdCwKICAgICAgcmVsb2FkOiBmdW5jdGlvbiByZWxvYWQodCwgaSkgewogICAgICAgIGUucmVsb2FkLmNhbGwoZSwgdCwgaSk7CiAgICAgIH0sCiAgICAgIHNldENvbHNXaWR0aDogZnVuY3Rpb24gc2V0Q29sc1dpZHRoKCkgewogICAgICAgIGUuc2V0Q29sc1dpZHRoLmNhbGwoZSk7CiAgICAgIH0sCiAgICAgIHJlc2l6ZTogZnVuY3Rpb24gcmVzaXplKCkgewogICAgICAgIGUucmVzaXplLmNhbGwoZSk7CiAgICAgIH0KICAgIH07CiAgfSwKICAgICAgdSA9IGZ1bmN0aW9uIHUoZSkgewogICAgdmFyIHQgPSBzLmNvbmZpZ1tlXTsKICAgIHJldHVybiB0IHx8IHIuZXJyb3IoZSA/ICJUaGUgdGFibGUgaW5zdGFuY2Ugd2l0aCBJRCAnIiArIGUgKyAiJyBub3QgZm91bmQiIDogIklEIGFyZ3VtZW50IHJlcXVpcmVkIiksIHQgfHwgbnVsbDsKICB9LAogICAgICB5ID0gZnVuY3Rpb24geShlLCBhLCBsLCBuKSB7CiAgICB2YXIgciA9IHRoaXMuY29uZmlnIHx8IHt9OwogICAgci5lc2NhcGUgJiYgKGEgPSBvLmVzY2FwZShhKSk7CiAgICB2YXIgYyA9IGUudGVtcGxldCA/IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICJmdW5jdGlvbiIgPT0gdHlwZW9mIGUudGVtcGxldCA/IGUudGVtcGxldChsKSA6IGkodChlLnRlbXBsZXQpLmh0bWwoKSB8fCBTdHJpbmcoYSkpLnJlbmRlcihsKTsKICAgIH0oKSA6IGE7CiAgICByZXR1cm4gbiA/IHQoIjxkaXY+IiArIGMgKyAiPC9kaXY+IikudGV4dCgpIDogYzsKICB9LAogICAgICBoID0gInRhYmxlIiwKICAgICAgZiA9ICIubGF5dWktdGFibGUiLAogICAgICBwID0gImxheXVpLWhpZGUiLAogICAgICB2ID0gImxheXVpLW5vbmUiLAogICAgICBtID0gImxheXVpLXRhYmxlLXZpZXciLAogICAgICBnID0gIi5sYXl1aS10YWJsZS10b29sIiwKICAgICAgYiA9ICIubGF5dWktdGFibGUtYm94IiwKICAgICAgeCA9ICIubGF5dWktdGFibGUtaW5pdCIsCiAgICAgIGsgPSAiLmxheXVpLXRhYmxlLWhlYWRlciIsCiAgICAgIEMgPSAiLmxheXVpLXRhYmxlLWJvZHkiLAogICAgICB3ID0gIi5sYXl1aS10YWJsZS1tYWluIiwKICAgICAgVCA9ICIubGF5dWktdGFibGUtZml4ZWQiLAogICAgICBOID0gIi5sYXl1aS10YWJsZS1maXhlZC1sIiwKICAgICAgTCA9ICIubGF5dWktdGFibGUtZml4ZWQtciIsCiAgICAgIF8gPSAiLmxheXVpLXRhYmxlLXRvdGFsIiwKICAgICAgUyA9ICIubGF5dWktdGFibGUtcGFnZSIsCiAgICAgIEEgPSAiLmxheXVpLXRhYmxlLXNvcnQiLAogICAgICBSID0gImxheXVpLXRhYmxlLWVkaXQiLAogICAgICBXID0gImxheXVpLXRhYmxlLWhvdmVyIiwKICAgICAgeiA9IGZ1bmN0aW9uIHooZSkgewogICAgdmFyIHQgPSAne3sjaWYoaXRlbTIuY29sc3Bhbil7fX0gY29sc3Bhbj0ie3tpdGVtMi5jb2xzcGFufX0ie3sjfSBpZihpdGVtMi5yb3dzcGFuKXt9fSByb3dzcGFuPSJ7e2l0ZW0yLnJvd3NwYW59fSJ7eyN9fX0nOwogICAgcmV0dXJuIGUgPSBlIHx8IHt9LCBbJzx0YWJsZSBjZWxsc3BhY2luZz0iMCIgY2VsbHBhZGRpbmc9IjAiIGJvcmRlcj0iMCIgY2xhc3M9ImxheXVpLXRhYmxlIiAnLCAne3sjIGlmKGQuZGF0YS5za2luKXsgfX1sYXktc2tpbj0ie3tkLmRhdGEuc2tpbn19Int7IyB9IH19IHt7IyBpZihkLmRhdGEuc2l6ZSl7IH19bGF5LXNpemU9Int7ZC5kYXRhLnNpemV9fSJ7eyMgfSB9fSB7eyMgaWYoZC5kYXRhLmV2ZW4peyB9fWxheS1ldmVue3sjIH0gfX0+JywgIjx0aGVhZD4iLCAie3sjIGxheXVpLmVhY2goZC5kYXRhLmNvbHMsIGZ1bmN0aW9uKGkxLCBpdGVtMSl7IH19IiwgIjx0cj4iLCAie3sjIGxheXVpLmVhY2goaXRlbTEsIGZ1bmN0aW9uKGkyLCBpdGVtMil7IH19IiwgJ3t7IyBpZihpdGVtMi5maXhlZCAmJiBpdGVtMi5maXhlZCAhPT0gInJpZ2h0Iil7IGxlZnQgPSB0cnVlOyB9IH19JywgJ3t7IyBpZihpdGVtMi5maXhlZCA9PT0gInJpZ2h0Iil7IHJpZ2h0ID0gdHJ1ZTsgfSB9fScsIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGUuZml4ZWQgJiYgInJpZ2h0IiAhPT0gZS5maXhlZCA/ICd7eyMgaWYoaXRlbTIuZml4ZWQgJiYgaXRlbTIuZml4ZWQgIT09ICJyaWdodCIpeyB9fScgOiAicmlnaHQiID09PSBlLmZpeGVkID8gJ3t7IyBpZihpdGVtMi5maXhlZCA9PT0gInJpZ2h0Iil7IH19JyA6ICIiOwogICAgfSgpLCAie3sjIHZhciBpc1NvcnQgPSAhKGl0ZW0yLmNvbEdyb3VwKSAmJiBpdGVtMi5zb3J0OyB9fSIsICc8dGggZGF0YS1maWVsZD0ie3sgaXRlbTIuZmllbGR8fGkyIH19IiBkYXRhLWtleT0ie3tkLmluZGV4fX0te3tpMX19LXt7aTJ9fSIge3sjIGlmKCBpdGVtMi5wYXJlbnRLZXkpeyB9fWRhdGEtcGFyZW50a2V5PSJ7eyBpdGVtMi5wYXJlbnRLZXkgfX0ie3sjIH0gfX0ge3sjIGlmKGl0ZW0yLm1pbldpZHRoKXsgfX1kYXRhLW1pbndpZHRoPSJ7e2l0ZW0yLm1pbldpZHRofX0ie3sjIH0gfX0gJyArIHQgKyAnIHt7IyBpZihpdGVtMi51bnJlc2l6ZSB8fCBpdGVtMi5jb2xHcm91cCl7IH19ZGF0YS11bnJlc2l6ZT0idHJ1ZSJ7eyMgfSB9fSBjbGFzcz0ie3sjIGlmKGl0ZW0yLmhpZGUpeyB9fWxheXVpLWhpZGV7eyMgfSB9fXt7IyBpZihpc1NvcnQpeyB9fSBsYXl1aS11bnNlbGVjdHt7IyB9IH19e3sjIGlmKCFpdGVtMi5maWVsZCl7IH19IGxheXVpLXRhYmxlLWNvbC1zcGVjaWFse3sjIH0gfX0iPicsICc8ZGl2IGNsYXNzPSJsYXl1aS10YWJsZS1jZWxsIGxheXRhYmxlLWNlbGwtJywgInt7IyBpZihpdGVtMi5jb2xHcm91cCl7IH19IiwgImdyb3VwIiwgInt7IyB9IGVsc2UgeyB9fSIsICJ7e2QuaW5kZXh9fS17e2kxfX0te3tpMn19IiwgJ3t7IyBpZihpdGVtMi50eXBlICE9PSAibm9ybWFsIil7IH19JywgIiBsYXl0YWJsZS1jZWxsLXt7IGl0ZW0yLnR5cGUgfX0iLCAie3sjIH0gfX0iLCAie3sjIH0gfX0iLCAnIiB7eyNpZihpdGVtMi5hbGlnbil7fX1hbGlnbj0ie3tpdGVtMi5hbGlnbn19Int7I319fT4nLCAne3sjIGlmKGl0ZW0yLnR5cGUgPT09ICJjaGVja2JveCIpeyB9fScsICc8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9ImxheVRhYmxlQ2hlY2tib3giIGxheS1za2luPSJwcmltYXJ5IiBsYXktZmlsdGVyPSJsYXlUYWJsZUFsbENob29zZSIge3sjIGlmKGl0ZW0yW2QuZGF0YS5jaGVja05hbWVdKXsgfX1jaGVja2Vke3sjIH07IH19PicsICJ7eyMgfSBlbHNlIHsgfX0iLCAnPHNwYW4+e3tpdGVtMi50aXRsZXx8IiJ9fTwvc3Bhbj4nLCAie3sjIGlmKGlzU29ydCl7IH19IiwgIjxzcGFuIGNsYXNzPVwibGF5dWktdGFibGUtc29ydCBsYXl1aS1pbmxpbmVcIj48aSBjbGFzcz1cImxheXVpLWVkZ2UgbGF5dWktdGFibGUtc29ydC1hc2NcIiB0aXRsZT1cIlx1NTM0N1x1NUU4RlwiPjwvaT48aSBjbGFzcz1cImxheXVpLWVkZ2UgbGF5dWktdGFibGUtc29ydC1kZXNjXCIgdGl0bGU9XCJcdTk2NERcdTVFOEZcIj48L2k+PC9zcGFuPiIsICJ7eyMgfSB9fSIsICJ7eyMgfSB9fSIsICI8L2Rpdj4iLCAiPC90aD4iLCBlLmZpeGVkID8gInt7IyB9OyB9fSIgOiAiIiwgInt7IyB9KTsgfX0iLCAiPC90cj4iLCAie3sjIH0pOyB9fSIsICI8L3RoZWFkPiIsICI8L3RhYmxlPiJdLmpvaW4oIiIpOwogIH0sCiAgICAgIEUgPSBbJzx0YWJsZSBjZWxsc3BhY2luZz0iMCIgY2VsbHBhZGRpbmc9IjAiIGJvcmRlcj0iMCIgY2xhc3M9ImxheXVpLXRhYmxlIiAnLCAne3sjIGlmKGQuZGF0YS5za2luKXsgfX1sYXktc2tpbj0ie3tkLmRhdGEuc2tpbn19Int7IyB9IH19IHt7IyBpZihkLmRhdGEuc2l6ZSl7IH19bGF5LXNpemU9Int7ZC5kYXRhLnNpemV9fSJ7eyMgfSB9fSB7eyMgaWYoZC5kYXRhLmV2ZW4peyB9fWxheS1ldmVue3sjIH0gfX0+JywgIjx0Ym9keT48L3Rib2R5PiIsICI8L3RhYmxlPiJdLmpvaW4oIiIpLAogICAgICBqID0gWyc8ZGl2IGNsYXNzPSJsYXl1aS1mb3JtIGxheXVpLWJvcmRlci1ib3gge3tkLlZJRVdfQ0xBU1N9fXt7IyBpZihkLmRhdGEuY2xhc3NOYW1lKXsgfX0ge3sgZC5kYXRhLmNsYXNzTmFtZSB9fXt7IyB9IH19IiBsYXktZmlsdGVyPSJMQVktdGFibGUte3tkLmluZGV4fX0iIGxheS1pZD0ie3sgZC5kYXRhLmlkIH19IiBzdHlsZT0ie3sjIGlmKGQuZGF0YS53aWR0aCl7IH19d2lkdGg6e3tkLmRhdGEud2lkdGh9fXB4O3t7IyB9IH19IHt7IyBpZihkLmRhdGEuaGVpZ2h0KXsgfX1oZWlnaHQ6e3tkLmRhdGEuaGVpZ2h0fX1weDt7eyMgfSB9fSI+JywgInt7IyBpZihkLmRhdGEudG9vbGJhcil7IH19IiwgJzxkaXYgY2xhc3M9ImxheXVpLXRhYmxlLXRvb2wiPicsICc8ZGl2IGNsYXNzPSJsYXl1aS10YWJsZS10b29sLXRlbXAiPjwvZGl2PicsICc8ZGl2IGNsYXNzPSJsYXl1aS10YWJsZS10b29sLXNlbGYiPjwvZGl2PicsICI8L2Rpdj4iLCAie3sjIH0gfX0iLCAnPGRpdiBjbGFzcz0ibGF5dWktdGFibGUtYm94Ij4nLCAie3sjIGlmKGQuZGF0YS5sb2FkaW5nKXsgfX0iLCAnPGRpdiBjbGFzcz0ibGF5dWktdGFibGUtaW5pdCIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6ICNmZmY7Ij4nLCAnPGkgY2xhc3M9ImxheXVpLWljb24gbGF5dWktaWNvbi1sb2FkaW5nIGxheXVpLWFuaW0gbGF5dWktYW5pbS1yb3RhdGUgbGF5dWktYW5pbS1sb29wIj48L2k+JywgIjwvZGl2PiIsICJ7eyMgfSB9fSIsICJ7eyMgdmFyIGxlZnQsIHJpZ2h0OyB9fSIsICc8ZGl2IGNsYXNzPSJsYXl1aS10YWJsZS1oZWFkZXIiPicsIHooKSwgIjwvZGl2PiIsICc8ZGl2IGNsYXNzPSJsYXl1aS10YWJsZS1ib2R5IGxheXVpLXRhYmxlLW1haW4iPicsIEUsICI8L2Rpdj4iLCAie3sjIGlmKGxlZnQpeyB9fSIsICc8ZGl2IGNsYXNzPSJsYXl1aS10YWJsZS1maXhlZCBsYXl1aS10YWJsZS1maXhlZC1sIj4nLCAnPGRpdiBjbGFzcz0ibGF5dWktdGFibGUtaGVhZGVyIj4nLCB6KHsKICAgIGZpeGVkOiAhMAogIH0pLCAiPC9kaXY+IiwgJzxkaXYgY2xhc3M9ImxheXVpLXRhYmxlLWJvZHkiPicsIEUsICI8L2Rpdj4iLCAiPC9kaXY+IiwgInt7IyB9OyB9fSIsICJ7eyMgaWYocmlnaHQpeyB9fSIsICc8ZGl2IGNsYXNzPSJsYXl1aS10YWJsZS1maXhlZCBsYXl1aS10YWJsZS1maXhlZC1yIj4nLCAnPGRpdiBjbGFzcz0ibGF5dWktdGFibGUtaGVhZGVyIj4nLCB6KHsKICAgIGZpeGVkOiAicmlnaHQiCiAgfSksICc8ZGl2IGNsYXNzPSJsYXl1aS10YWJsZS1tZW5kIj48L2Rpdj4nLCAiPC9kaXY+IiwgJzxkaXYgY2xhc3M9ImxheXVpLXRhYmxlLWJvZHkiPicsIEUsICI8L2Rpdj4iLCAiPC9kaXY+IiwgInt7IyB9OyB9fSIsICI8L2Rpdj4iLCAie3sjIGlmKGQuZGF0YS50b3RhbFJvdyl7IH19IiwgJzxkaXYgY2xhc3M9ImxheXVpLXRhYmxlLXRvdGFsIj4nLCAnPHRhYmxlIGNlbGxzcGFjaW5nPSIwIiBjZWxscGFkZGluZz0iMCIgYm9yZGVyPSIwIiBjbGFzcz0ibGF5dWktdGFibGUiICcsICd7eyMgaWYoZC5kYXRhLnNraW4peyB9fWxheS1za2luPSJ7e2QuZGF0YS5za2lufX0ie3sjIH0gfX0ge3sjIGlmKGQuZGF0YS5zaXplKXsgfX1sYXktc2l6ZT0ie3tkLmRhdGEuc2l6ZX19Int7IyB9IH19IHt7IyBpZihkLmRhdGEuZXZlbil7IH19bGF5LWV2ZW57eyMgfSB9fT4nLCAnPHRib2R5Pjx0cj48dGQ+PGRpdiBjbGFzcz0ibGF5dWktdGFibGUtY2VsbCIgc3R5bGU9InZpc2liaWxpdHk6IGhpZGRlbjsiPlRvdGFsPC9kaXY+PC90ZD48L3RyPjwvdGJvZHk+JywgIjwvdGFibGU+IiwgIjwvZGl2PiIsICJ7eyMgfSB9fSIsICJ7eyMgaWYoZC5kYXRhLnBhZ2UpeyB9fSIsICc8ZGl2IGNsYXNzPSJsYXl1aS10YWJsZS1wYWdlIj4nLCAnPGRpdiBpZD0ibGF5dWktdGFibGUtcGFnZXt7ZC5pbmRleH19Ij48L2Rpdj4nLCAiPC9kaXY+IiwgInt7IyB9IH19IiwgIjxzdHlsZT4iLCAie3sjIGxheXVpLmVhY2goZC5kYXRhLmNvbHMsIGZ1bmN0aW9uKGkxLCBpdGVtMSl7IiwgImxheXVpLmVhY2goaXRlbTEsIGZ1bmN0aW9uKGkyLCBpdGVtMil7IH19IiwgIi5sYXl0YWJsZS1jZWxsLXt7ZC5pbmRleH19LXt7aTF9fS17e2kyfX17ICIsICJ7eyMgaWYoaXRlbTIud2lkdGgpeyB9fSIsICJ3aWR0aDoge3tpdGVtMi53aWR0aH19cHg7IiwgInt7IyB9IH19IiwgIiB9IiwgInt7IyB9KTsiLCAifSk7IH19IiwgIjwvc3R5bGU+IiwgIjwvZGl2PiJdLmpvaW4oIiIpLAogICAgICBGID0gdCh3aW5kb3cpLAogICAgICBJID0gdChkb2N1bWVudCksCiAgICAgIEggPSBmdW5jdGlvbiBIKGUpIHsKICAgIHZhciBpID0gdGhpczsKICAgIGkuaW5kZXggPSArK2QuaW5kZXgsIGkuY29uZmlnID0gdC5leHRlbmQoe30sIGkuY29uZmlnLCBkLmNvbmZpZywgZSksIGkucmVuZGVyKCk7CiAgfTsKCiAgSC5wcm90b3R5cGUuY29uZmlnID0gewogICAgbGltaXQ6IDEwLAogICAgbG9hZGluZzogITAsCiAgICBjZWxsTWluV2lkdGg6IDYwLAogICAgZGVmYXVsdFRvb2xiYXI6IFsiZmlsdGVyIiwgImV4cG9ydHMiLCAicHJpbnQiXSwKICAgIGF1dG9Tb3J0OiAhMCwKICAgIHRleHQ6IHsKICAgICAgbm9uZTogIlx1NjVFMFx1NjU3MFx1NjM2RSIKICAgIH0KICB9LCBILnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgYSA9IGUuY29uZmlnOwogICAgaWYgKGEuZWxlbSA9IHQoYS5lbGVtKSwgYS53aGVyZSA9IGEud2hlcmUgfHwge30sIGEuaWQgPSBhLmlkIHx8IGEuZWxlbS5hdHRyKCJpZCIpIHx8IGUuaW5kZXgsIGEucmVxdWVzdCA9IHQuZXh0ZW5kKHsKICAgICAgcGFnZU5hbWU6ICJwYWdlIiwKICAgICAgbGltaXROYW1lOiAibGltaXQiCiAgICB9LCBhLnJlcXVlc3QpLCBhLnJlc3BvbnNlID0gdC5leHRlbmQoewogICAgICBzdGF0dXNOYW1lOiAiY29kZSIsCiAgICAgIHN0YXR1c0NvZGU6IDAsCiAgICAgIG1zZ05hbWU6ICJtc2ciLAogICAgICBkYXRhTmFtZTogImRhdGEiLAogICAgICB0b3RhbFJvd05hbWU6ICJ0b3RhbFJvdyIsCiAgICAgIGNvdW50TmFtZTogImNvdW50IgogICAgfSwgYS5yZXNwb25zZSksICJvYmplY3QiID09IF90eXBlb2YoYS5wYWdlKSAmJiAoYS5saW1pdCA9IGEucGFnZS5saW1pdCB8fCBhLmxpbWl0LCBhLmxpbWl0cyA9IGEucGFnZS5saW1pdHMgfHwgYS5saW1pdHMsIGUucGFnZSA9IGEucGFnZS5jdXJyID0gYS5wYWdlLmN1cnIgfHwgMSwgZGVsZXRlIGEucGFnZS5lbGVtLCBkZWxldGUgYS5wYWdlLmp1bXApLCAhYS5lbGVtWzBdKSByZXR1cm4gZTsKICAgIGEuaGVpZ2h0ICYmIC9eZnVsbC1cZCskLy50ZXN0KGEuaGVpZ2h0KSAmJiAoZS5mdWxsSGVpZ2h0R2FwID0gYS5oZWlnaHQuc3BsaXQoIi0iKVsxXSwgYS5oZWlnaHQgPSBGLmhlaWdodCgpIC0gZS5mdWxsSGVpZ2h0R2FwKSwgZS5zZXRJbml0KCk7CiAgICB2YXIgbCA9IGEuZWxlbSwKICAgICAgICBuID0gbC5uZXh0KCIuIiArIG0pLAogICAgICAgIG8gPSBlLmVsZW0gPSB0KGkoaikucmVuZGVyKHsKICAgICAgVklFV19DTEFTUzogbSwKICAgICAgZGF0YTogYSwKICAgICAgaW5kZXg6IGUuaW5kZXgKICAgIH0pKTsKCiAgICBpZiAoYS5pbmRleCA9IGUuaW5kZXgsIGUua2V5ID0gYS5pZCB8fCBhLmluZGV4LCBuWzBdICYmIG4ucmVtb3ZlKCksIGwuYWZ0ZXIobyksIGUubGF5VG9vbCA9IG8uZmluZChnKSwgZS5sYXlCb3ggPSBvLmZpbmQoYiksIGUubGF5SGVhZGVyID0gby5maW5kKGspLCBlLmxheU1haW4gPSBvLmZpbmQodyksIGUubGF5Qm9keSA9IG8uZmluZChDKSwgZS5sYXlGaXhlZCA9IG8uZmluZChUKSwgZS5sYXlGaXhMZWZ0ID0gby5maW5kKE4pLCBlLmxheUZpeFJpZ2h0ID0gby5maW5kKEwpLCBlLmxheVRvdGFsID0gby5maW5kKF8pLCBlLmxheVBhZ2UgPSBvLmZpbmQoUyksIGUucmVuZGVyVG9vbGJhcigpLCBlLmZ1bGxTaXplKCksIGEuY29scy5sZW5ndGggPiAxKSB7CiAgICAgIHZhciByID0gZS5sYXlGaXhlZC5maW5kKGspLmZpbmQoInRoIik7CiAgICAgIHIuaGVpZ2h0KGUubGF5SGVhZGVyLmhlaWdodCgpIC0gMSAtIHBhcnNlRmxvYXQoci5jc3MoInBhZGRpbmctdG9wIikpIC0gcGFyc2VGbG9hdChyLmNzcygicGFkZGluZy1ib3R0b20iKSkpOwogICAgfQoKICAgIGUucHVsbERhdGEoZS5wYWdlKSwgZS5ldmVudHMoKTsKICB9LCBILnByb3RvdHlwZS5pbml0T3B0cyA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgaSA9ICh0LmNvbmZpZywgewogICAgICBjaGVja2JveDogNDgsCiAgICAgIHJhZGlvOiA0OCwKICAgICAgc3BhY2U6IDE1LAogICAgICBudW1iZXJzOiA0MAogICAgfSk7CiAgICBlLmNoZWNrYm94ICYmIChlLnR5cGUgPSAiY2hlY2tib3giKSwgZS5zcGFjZSAmJiAoZS50eXBlID0gInNwYWNlIiksIGUudHlwZSB8fCAoZS50eXBlID0gIm5vcm1hbCIpLCAibm9ybWFsIiAhPT0gZS50eXBlICYmIChlLnVucmVzaXplID0gITAsIGUud2lkdGggPSBlLndpZHRoIHx8IGlbZS50eXBlXSk7CiAgfSwgSC5wcm90b3R5cGUuc2V0SW5pdCA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgaSA9IHQuY29uZmlnOwogICAgcmV0dXJuIGkuY2xpZW50V2lkdGggPSBpLndpZHRoIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSBmdW5jdGlvbiBlKHQpIHsKICAgICAgICB2YXIgYSwgbDsKICAgICAgICB0ID0gdCB8fCBpLmVsZW0ucGFyZW50KCksIGEgPSB0LndpZHRoKCk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBsID0gIm5vbmUiID09PSB0LmNzcygiZGlzcGxheSIpOwogICAgICAgIH0gY2F0Y2ggKG4pIHt9CgogICAgICAgIHJldHVybiAhdFswXSB8fCBhICYmICFsID8gYSA6IGUodC5wYXJlbnQoKSk7CiAgICAgIH07CgogICAgICByZXR1cm4gZSgpOwogICAgfSgpLCAid2lkdGgiID09PSBlID8gaS5jbGllbnRXaWR0aCA6IHZvaWQgbGF5dWkuZWFjaChpLmNvbHMsIGZ1bmN0aW9uIChlLCBhKSB7CiAgICAgIGxheXVpLmVhY2goYSwgZnVuY3Rpb24gKGwsIG4pIHsKICAgICAgICBpZiAoIW4pIHJldHVybiB2b2lkIGEuc3BsaWNlKGwsIDEpOwoKICAgICAgICBpZiAobi5rZXkgPSBlICsgIi0iICsgbCwgbi5oaWRlID0gbi5oaWRlIHx8ICExLCBuLmNvbEdyb3VwIHx8IG4uY29sc3BhbiA+IDEpIHsKICAgICAgICAgIHZhciBvID0gMDsKICAgICAgICAgIGxheXVpLmVhY2goaS5jb2xzW2UgKyAxXSwgZnVuY3Rpb24gKHQsIGkpIHsKICAgICAgICAgICAgaS5IQVNfUEFSRU5UIHx8IG8gPiAxICYmIG8gPT0gbi5jb2xzcGFuIHx8IChpLkhBU19QQVJFTlQgPSAhMCwgaS5wYXJlbnRLZXkgPSBlICsgIi0iICsgbCwgbyArPSBwYXJzZUludChpLmNvbHNwYW4gPiAxID8gaS5jb2xzcGFuIDogMSkpOwogICAgICAgICAgfSksIG4uY29sR3JvdXAgPSAhMDsKICAgICAgICB9CgogICAgICAgIHQuaW5pdE9wdHMobik7CiAgICAgIH0pOwogICAgfSk7CiAgfSwgSC5wcm90b3R5cGUucmVuZGVyVG9vbGJhciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICBhID0gZS5jb25maWcsCiAgICAgICAgbCA9IFsnPGRpdiBjbGFzcz0ibGF5dWktaW5saW5lIiBsYXktZXZlbnQ9ImFkZCI+PGkgY2xhc3M9ImxheXVpLWljb24gbGF5dWktaWNvbi1hZGQtMSI+PC9pPjwvZGl2PicsICc8ZGl2IGNsYXNzPSJsYXl1aS1pbmxpbmUiIGxheS1ldmVudD0idXBkYXRlIj48aSBjbGFzcz0ibGF5dWktaWNvbiBsYXl1aS1pY29uLWVkaXQiPjwvaT48L2Rpdj4nLCAnPGRpdiBjbGFzcz0ibGF5dWktaW5saW5lIiBsYXktZXZlbnQ9ImRlbGV0ZSI+PGkgY2xhc3M9ImxheXVpLWljb24gbGF5dWktaWNvbi1kZWxldGUiPjwvaT48L2Rpdj4nXS5qb2luKCIiKSwKICAgICAgICBuID0gZS5sYXlUb29sLmZpbmQoIi5sYXl1aS10YWJsZS10b29sLXRlbXAiKTsKICAgIGlmICgiZGVmYXVsdCIgPT09IGEudG9vbGJhcikgbi5odG1sKGwpO2Vsc2UgaWYgKCJzdHJpbmciID09IHR5cGVvZiBhLnRvb2xiYXIpIHsKICAgICAgdmFyIG8gPSB0KGEudG9vbGJhcikuaHRtbCgpIHx8ICIiOwogICAgICBvICYmIG4uaHRtbChpKG8pLnJlbmRlcihhKSk7CiAgICB9CiAgICB2YXIgciA9IHsKICAgICAgZmlsdGVyOiB7CiAgICAgICAgdGl0bGU6ICJcdTdCNUJcdTkwMDlcdTUyMTciLAogICAgICAgIGxheUV2ZW50OiAiTEFZVEFCTEVfQ09MUyIsCiAgICAgICAgaWNvbjogImxheXVpLWljb24tY29scyIKICAgICAgfSwKICAgICAgZXhwb3J0czogewogICAgICAgIHRpdGxlOiAiXHU1QkZDXHU1MUZBIiwKICAgICAgICBsYXlFdmVudDogIkxBWVRBQkxFX0VYUE9SVCIsCiAgICAgICAgaWNvbjogImxheXVpLWljb24tZXhwb3J0IgogICAgICB9LAogICAgICBwcmludDogewogICAgICAgIHRpdGxlOiAiXHU2MjUzXHU1MzcwIiwKICAgICAgICBsYXlFdmVudDogIkxBWVRBQkxFX1BSSU5UIiwKICAgICAgICBpY29uOiAibGF5dWktaWNvbi1wcmludCIKICAgICAgfQogICAgfSwKICAgICAgICBjID0gW107CiAgICAib2JqZWN0IiA9PSBfdHlwZW9mKGEuZGVmYXVsdFRvb2xiYXIpICYmIGxheXVpLmVhY2goYS5kZWZhdWx0VG9vbGJhciwgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgdmFyIGkgPSAic3RyaW5nIiA9PSB0eXBlb2YgdCA/IHJbdF0gOiB0OwogICAgICBpICYmIGMucHVzaCgnPGRpdiBjbGFzcz0ibGF5dWktaW5saW5lIiB0aXRsZT0iJyArIGkudGl0bGUgKyAnIiBsYXktZXZlbnQ9IicgKyBpLmxheUV2ZW50ICsgJyI+PGkgY2xhc3M9ImxheXVpLWljb24gJyArIGkuaWNvbiArICciPjwvaT48L2Rpdj4nKTsKICAgIH0pLCBlLmxheVRvb2wuZmluZCgiLmxheXVpLXRhYmxlLXRvb2wtc2VsZiIpLmh0bWwoYy5qb2luKCIiKSk7CiAgfSwgSC5wcm90b3R5cGUuc2V0UGFyZW50Q29sID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgIHZhciBpID0gdGhpcywKICAgICAgICBhID0gaS5jb25maWcsCiAgICAgICAgbCA9IGkubGF5SGVhZGVyLmZpbmQoJ3RoW2RhdGEta2V5PSInICsgYS5pbmRleCArICItIiArIHQgKyAnIl0nKSwKICAgICAgICBuID0gcGFyc2VJbnQobC5hdHRyKCJjb2xzcGFuIikpIHx8IDA7CgogICAgaWYgKGxbMF0pIHsKICAgICAgdmFyIG8gPSB0LnNwbGl0KCItIiksCiAgICAgICAgICByID0gYS5jb2xzW29bMF1dW29bMV1dOwogICAgICBlID8gbi0tIDogbisrLCBsLmF0dHIoImNvbHNwYW4iLCBuKSwgbFtuIDwgMSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiXShwKSwgci5jb2xzcGFuID0gbiwgci5oaWRlID0gbiA8IDE7CiAgICAgIHZhciBjID0gbC5kYXRhKCJwYXJlbnRrZXkiKTsKICAgICAgYyAmJiBpLnNldFBhcmVudENvbChlLCBjKTsKICAgIH0KICB9LCBILnByb3RvdHlwZS5zZXRDb2xzUGF0Y2ggPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgdCA9IGUuY29uZmlnOwogICAgbGF5dWkuZWFjaCh0LmNvbHMsIGZ1bmN0aW9uICh0LCBpKSB7CiAgICAgIGxheXVpLmVhY2goaSwgZnVuY3Rpb24gKHQsIGkpIHsKICAgICAgICBpLmhpZGUgJiYgZS5zZXRQYXJlbnRDb2woaS5oaWRlLCBpLnBhcmVudEtleSk7CiAgICAgIH0pOwogICAgfSk7CiAgfSwgSC5wcm90b3R5cGUuc2V0Q29sc1dpZHRoID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIHQgPSBlLmNvbmZpZywKICAgICAgICBpID0gMCwKICAgICAgICBhID0gMCwKICAgICAgICBsID0gMCwKICAgICAgICBuID0gMCwKICAgICAgICBvID0gZS5zZXRJbml0KCJ3aWR0aCIpOwogICAgZS5lYWNoQ29scyhmdW5jdGlvbiAoZSwgdCkgewogICAgICB0LmhpZGUgfHwgaSsrOwogICAgfSksIG8gPSBvIC0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gImxpbmUiID09PSB0LnNraW4gfHwgIm5vYiIgPT09IHQuc2tpbiA/IDIgOiBpICsgMTsKICAgIH0oKSAtIGUuZ2V0U2Nyb2xsV2lkdGgoZS5sYXlNYWluWzBdKSAtIDE7CgogICAgdmFyIHIgPSBmdW5jdGlvbiByKGUpIHsKICAgICAgbGF5dWkuZWFjaCh0LmNvbHMsIGZ1bmN0aW9uIChpLCByKSB7CiAgICAgICAgbGF5dWkuZWFjaChyLCBmdW5jdGlvbiAoaSwgYykgewogICAgICAgICAgdmFyIGQgPSAwLAogICAgICAgICAgICAgIHMgPSBjLm1pbldpZHRoIHx8IHQuY2VsbE1pbldpZHRoOwogICAgICAgICAgcmV0dXJuIGMgPyB2b2lkIChjLmNvbEdyb3VwIHx8IGMuaGlkZSB8fCAoZSA/IGwgJiYgbCA8IHMgJiYgKGEtLSwgZCA9IHMpIDogKGQgPSBjLndpZHRoIHx8IDAsIC9cZCslJC8udGVzdChkKSA/IChkID0gTWF0aC5mbG9vcihwYXJzZUZsb2F0KGQpIC8gMTAwICogbyksIGQgPCBzICYmIChkID0gcykpIDogZCB8fCAoYy53aWR0aCA9IGQgPSAwLCBhKyspKSwgYy5oaWRlICYmIChkID0gMCksIG4gKz0gZCkpIDogdm9pZCByLnNwbGljZShpLCAxKTsKICAgICAgICB9KTsKICAgICAgfSksIG8gPiBuICYmIGEgJiYgKGwgPSAobyAtIG4pIC8gYSk7CiAgICB9OwoKICAgIHIoKSwgcighMCksIGUuYXV0b0NvbE51bXMgPSBhLCBlLmVhY2hDb2xzKGZ1bmN0aW9uIChpLCBhKSB7CiAgICAgIHZhciBuID0gYS5taW5XaWR0aCB8fCB0LmNlbGxNaW5XaWR0aDsKICAgICAgYS5jb2xHcm91cCB8fCBhLmhpZGUgfHwgKDAgPT09IGEud2lkdGggPyBlLmdldENzc1J1bGUodC5pbmRleCArICItIiArIGEua2V5LCBmdW5jdGlvbiAoZSkgewogICAgICAgIGUuc3R5bGUud2lkdGggPSBNYXRoLmZsb29yKGwgPj0gbiA/IGwgOiBuKSArICJweCI7CiAgICAgIH0pIDogL1xkKyUkLy50ZXN0KGEud2lkdGgpICYmIGUuZ2V0Q3NzUnVsZSh0LmluZGV4ICsgIi0iICsgYS5rZXksIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgZS5zdHlsZS53aWR0aCA9IE1hdGguZmxvb3IocGFyc2VGbG9hdChhLndpZHRoKSAvIDEwMCAqIG8pICsgInB4IjsKICAgICAgfSkpOwogICAgfSk7CiAgICB2YXIgYyA9IGUubGF5TWFpbi53aWR0aCgpIC0gZS5nZXRTY3JvbGxXaWR0aChlLmxheU1haW5bMF0pIC0gZS5sYXlNYWluLmNoaWxkcmVuKCJ0YWJsZSIpLm91dGVyV2lkdGgoKTsKCiAgICBpZiAoZS5hdXRvQ29sTnVtcyAmJiBjID49IC1pICYmIGMgPD0gaSkgewogICAgICB2YXIgZCA9IGZ1bmN0aW9uIGQodCkgewogICAgICAgIHZhciBpOwogICAgICAgIHJldHVybiB0ID0gdCB8fCBlLmxheUhlYWRlci5lcSgwKS5maW5kKCJ0aGVhZCB0aDpsYXN0LWNoaWxkIiksIGkgPSB0LmRhdGEoImZpZWxkIiksICFpICYmIHQucHJldigpWzBdID8gZCh0LnByZXYoKSkgOiB0OwogICAgICB9LAogICAgICAgICAgcyA9IGQoKSwKICAgICAgICAgIHUgPSBzLmRhdGEoImtleSIpOwoKICAgICAgZS5nZXRDc3NSdWxlKHUsIGZ1bmN0aW9uICh0KSB7CiAgICAgICAgdmFyIGkgPSB0LnN0eWxlLndpZHRoIHx8IHMub3V0ZXJXaWR0aCgpOwogICAgICAgIHQuc3R5bGUud2lkdGggPSBwYXJzZUZsb2F0KGkpICsgYyArICJweCIsIGUubGF5TWFpbi5oZWlnaHQoKSAtIGUubGF5TWFpbi5wcm9wKCJjbGllbnRIZWlnaHQiKSA+IDAgJiYgKHQuc3R5bGUud2lkdGggPSBwYXJzZUZsb2F0KHQuc3R5bGUud2lkdGgpIC0gMSArICJweCIpOwogICAgICB9KTsKICAgIH0KCiAgICBlLmxvYWRpbmcoITApOwogIH0sIEgucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpczsKICAgIGUuZnVsbFNpemUoKSwgZS5zZXRDb2xzV2lkdGgoKSwgZS5zY3JvbGxQYXRjaCgpOwogIH0sIEgucHJvdG90eXBlLnJlbG9hZCA9IGZ1bmN0aW9uIChlLCBpKSB7CiAgICB2YXIgYSA9IHRoaXM7CiAgICBlID0gZSB8fCB7fSwgZGVsZXRlIGEuaGF2ZUluaXQsIGxheXVpLmVhY2goZSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgImFycmF5IiA9PT0gbGF5dWkuX3R5cGVvZih0KSAmJiBkZWxldGUgYS5jb25maWdbZV07CiAgICB9KSwgYS5jb25maWcgPSB0LmV4dGVuZChpLCB7fSwgYS5jb25maWcsIGUpLCBhLnJlbmRlcigpOwogIH0sIEgucHJvdG90eXBlLmVycm9yVmlldyA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgaSA9IHRoaXMsCiAgICAgICAgYSA9IGkubGF5TWFpbi5maW5kKCIuIiArIHYpLAogICAgICAgIGwgPSB0KCc8ZGl2IGNsYXNzPSInICsgdiArICciPicgKyAoZSB8fCAiRXJyb3IiKSArICI8L2Rpdj4iKTsKICAgIGFbMF0gJiYgKGkubGF5Tm9uZS5yZW1vdmUoKSwgYS5yZW1vdmUoKSksIGkubGF5Rml4ZWQuYWRkQ2xhc3MocCksIGkubGF5TWFpbi5maW5kKCJ0Ym9keSIpLmh0bWwoIiIpLCBpLmxheU1haW4uYXBwZW5kKGkubGF5Tm9uZSA9IGwpLCBkLmNhY2hlW2kua2V5XSA9IFtdOwogIH0sIEgucHJvdG90eXBlLnBhZ2UgPSAxLCBILnByb3RvdHlwZS5wdWxsRGF0YSA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgaSA9IHRoaXMsCiAgICAgICAgYSA9IGkuY29uZmlnLAogICAgICAgIGwgPSBhLnJlcXVlc3QsCiAgICAgICAgbiA9IGEucmVzcG9uc2UsCiAgICAgICAgbyA9IGZ1bmN0aW9uIG8oKSB7CiAgICAgICJvYmplY3QiID09IF90eXBlb2YoYS5pbml0U29ydCkgJiYgaS5zb3J0KGEuaW5pdFNvcnQuZmllbGQsIGEuaW5pdFNvcnQudHlwZSk7CiAgICB9OwoKICAgIGlmIChpLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCBhLnVybCkgewogICAgICB2YXIgciA9IHt9OwogICAgICByW2wucGFnZU5hbWVdID0gZSwgcltsLmxpbWl0TmFtZV0gPSBhLmxpbWl0OwogICAgICB2YXIgYyA9IHQuZXh0ZW5kKHIsIGEud2hlcmUpOwogICAgICBhLmNvbnRlbnRUeXBlICYmIDAgPT0gYS5jb250ZW50VHlwZS5pbmRleE9mKCJhcHBsaWNhdGlvbi9qc29uIikgJiYgKGMgPSBKU09OLnN0cmluZ2lmeShjKSksIGkubG9hZGluZygpLCB0LmFqYXgoewogICAgICAgIHR5cGU6IGEubWV0aG9kIHx8ICJnZXQiLAogICAgICAgIHVybDogYS51cmwsCiAgICAgICAgY29udGVudFR5cGU6IGEuY29udGVudFR5cGUsCiAgICAgICAgZGF0YTogYywKICAgICAgICBkYXRhVHlwZTogImpzb24iLAogICAgICAgIGhlYWRlcnM6IGEuaGVhZGVycyB8fCB7fSwKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiBzdWNjZXNzKHQpIHsKICAgICAgICAgICJmdW5jdGlvbiIgPT0gdHlwZW9mIGEucGFyc2VEYXRhICYmICh0ID0gYS5wYXJzZURhdGEodCkgfHwgdCksIHRbbi5zdGF0dXNOYW1lXSAhPSBuLnN0YXR1c0NvZGUgPyAoaS5yZW5kZXJGb3JtKCksIGkuZXJyb3JWaWV3KHRbbi5tc2dOYW1lXSB8fCAiXHU4RkQ0XHU1NkRFXHU3Njg0XHU2NTcwXHU2MzZFXHU0RTBEXHU3QjI2XHU1NDA4XHU4OUM0XHU4MzAzXHVGRjBDXHU2QjYzXHU3ODZFXHU3Njg0XHU2MjEwXHU1MjlGXHU3MkI2XHU2MDAxXHU3ODAxXHU1RTk0XHU0RTNBXHVGRjFBXCIiICsgbi5zdGF0dXNOYW1lICsgJyI6ICcgKyBuLnN0YXR1c0NvZGUpKSA6IChpLnJlbmRlckRhdGEodCwgZSwgdFtuLmNvdW50TmFtZV0pLCBvKCksIGEudGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gaS5zdGFydFRpbWUgKyAiIG1zIiksIGkuc2V0Q29sc1dpZHRoKCksICJmdW5jdGlvbiIgPT0gdHlwZW9mIGEuZG9uZSAmJiBhLmRvbmUodCwgZSwgdFtuLmNvdW50TmFtZV0pOwogICAgICAgIH0sCiAgICAgICAgZXJyb3I6IGZ1bmN0aW9uIGVycm9yKGUsIHQpIHsKICAgICAgICAgIGkuZXJyb3JWaWV3KCJcdThCRjdcdTZDNDJcdTVGMDJcdTVFMzhcdUZGMENcdTk1MTlcdThCRUZcdTYzRDBcdTc5M0FcdUZGMUEiICsgdCksIGkucmVuZGVyRm9ybSgpLCBpLnNldENvbHNXaWR0aCgpLCAiZnVuY3Rpb24iID09IHR5cGVvZiBhLmVycm9yICYmIGEuZXJyb3IoZSwgdCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoImFycmF5IiA9PT0gbGF5dWkuX3R5cGVvZihhLmRhdGEpKSB7CiAgICAgIHZhciBkID0ge30sCiAgICAgICAgICBzID0gZSAqIGEubGltaXQgLSBhLmxpbWl0OwogICAgICBkW24uZGF0YU5hbWVdID0gYS5kYXRhLmNvbmNhdCgpLnNwbGljZShzLCBhLmxpbWl0KSwgZFtuLmNvdW50TmFtZV0gPSBhLmRhdGEubGVuZ3RoLCAib2JqZWN0IiA9PSBfdHlwZW9mKGEudG90YWxSb3cpICYmIChkW24udG90YWxSb3dOYW1lXSA9IHQuZXh0ZW5kKHt9LCBhLnRvdGFsUm93KSksIGkucmVuZGVyRGF0YShkLCBlLCBkW24uY291bnROYW1lXSksIG8oKSwgaS5zZXRDb2xzV2lkdGgoKSwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgYS5kb25lICYmIGEuZG9uZShkLCBlLCBkW24uY291bnROYW1lXSk7CiAgICB9CiAgfSwgSC5wcm90b3R5cGUuZWFjaENvbHMgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSB0aGlzOwogICAgcmV0dXJuIGQuZWFjaENvbHMobnVsbCwgZSwgdC5jb25maWcuY29scyksIHQ7CiAgfSwgSC5wcm90b3R5cGUucmVuZGVyRGF0YSA9IGZ1bmN0aW9uIChlLCBuLCBvLCByKSB7CiAgICB2YXIgYyA9IHRoaXMsCiAgICAgICAgcyA9IGMuY29uZmlnLAogICAgICAgIHUgPSBlW3MucmVzcG9uc2UuZGF0YU5hbWVdIHx8IFtdLAogICAgICAgIGggPSBlW3MucmVzcG9uc2UudG90YWxSb3dOYW1lXSwKICAgICAgICBmID0gW10sCiAgICAgICAgbSA9IFtdLAogICAgICAgIGcgPSBbXSwKICAgICAgICBiID0gZnVuY3Rpb24gYigpIHsKICAgICAgdmFyIGU7CiAgICAgIHJldHVybiAhciAmJiBjLnNvcnRLZXkgPyBjLnNvcnQoYy5zb3J0S2V5LmZpZWxkLCBjLnNvcnRLZXkuc29ydCwgITApIDogKGxheXVpLmVhY2godSwgZnVuY3Rpb24gKGEsIGwpIHsKICAgICAgICB2YXIgbyA9IFtdLAogICAgICAgICAgICB1ID0gW10sCiAgICAgICAgICAgIGggPSBbXSwKICAgICAgICAgICAgdiA9IGEgKyBzLmxpbWl0ICogKG4gLSAxKSArIDE7CiAgICAgICAgImFycmF5IiA9PT0gbGF5dWkuX3R5cGVvZihsKSAmJiAwID09PSBsLmxlbmd0aCB8fCAociB8fCAobFtkLmNvbmZpZy5pbmRleE5hbWVdID0gYSksIGMuZWFjaENvbHMoZnVuY3Rpb24gKG4sIHIpIHsKICAgICAgICAgIHZhciBmID0gci5maWVsZCB8fCBuLAogICAgICAgICAgICAgIG0gPSBzLmluZGV4ICsgIi0iICsgci5rZXksCiAgICAgICAgICAgICAgZyA9IGxbZl07CgogICAgICAgICAgaWYgKHZvaWQgMCAhPT0gZyAmJiBudWxsICE9PSBnIHx8IChnID0gIiIpLCAhci5jb2xHcm91cCkgewogICAgICAgICAgICB2YXIgYiA9IFsnPHRkIGRhdGEtZmllbGQ9IicgKyBmICsgJyIgZGF0YS1rZXk9IicgKyBtICsgJyIgJyArIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB2YXIgZSA9IFtdOwogICAgICAgICAgICAgIHJldHVybiByLmVkaXQgJiYgZS5wdXNoKCdkYXRhLWVkaXQ9IicgKyByLmVkaXQgKyAnIicpLCByLmFsaWduICYmIGUucHVzaCgnYWxpZ249IicgKyByLmFsaWduICsgJyInKSwgci50ZW1wbGV0ICYmIGUucHVzaCgnZGF0YS1jb250ZW50PSInICsgZyArICciJyksIHIudG9vbGJhciAmJiBlLnB1c2goJ2RhdGEtb2ZmPSJ0cnVlIicpLCByLmV2ZW50ICYmIGUucHVzaCgnbGF5LWV2ZW50PSInICsgci5ldmVudCArICciJyksIHIuc3R5bGUgJiYgZS5wdXNoKCdzdHlsZT0iJyArIHIuc3R5bGUgKyAnIicpLCByLm1pbldpZHRoICYmIGUucHVzaCgnZGF0YS1taW53aWR0aD0iJyArIHIubWluV2lkdGggKyAnIicpLCBlLmpvaW4oIiAiKTsKICAgICAgICAgICAgfSgpICsgJyBjbGFzcz0iJyArIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB2YXIgZSA9IFtdOwogICAgICAgICAgICAgIHJldHVybiByLmhpZGUgJiYgZS5wdXNoKHApLCByLmZpZWxkIHx8IGUucHVzaCgibGF5dWktdGFibGUtY29sLXNwZWNpYWwiKSwgZS5qb2luKCIgIik7CiAgICAgICAgICAgIH0oKSArICciPicsICc8ZGl2IGNsYXNzPSJsYXl1aS10YWJsZS1jZWxsIGxheXRhYmxlLWNlbGwtJyArIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gIm5vcm1hbCIgPT09IHIudHlwZSA/IG0gOiBtICsgIiBsYXl0YWJsZS1jZWxsLSIgKyByLnR5cGU7CiAgICAgICAgICAgIH0oKSArICciPicgKyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdmFyIG4gPSB0LmV4dGVuZCghMCwgewogICAgICAgICAgICAgICAgTEFZX0lOREVYOiB2LAogICAgICAgICAgICAgICAgTEFZX0NPTDogcgogICAgICAgICAgICAgIH0sIGwpLAogICAgICAgICAgICAgICAgICBvID0gZC5jb25maWcuY2hlY2tOYW1lOwoKICAgICAgICAgICAgICBzd2l0Y2ggKHIudHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAiY2hlY2tib3giOgogICAgICAgICAgICAgICAgICByZXR1cm4gJzxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0ibGF5VGFibGVDaGVja2JveCIgbGF5LXNraW49InByaW1hcnkiICcgKyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJbb10gPyAobFtvXSA9IHJbb10sIHJbb10gPyAiY2hlY2tlZCIgOiAiIikgOiBuW29dID8gImNoZWNrZWQiIDogIiI7CiAgICAgICAgICAgICAgICAgIH0oKSArICI+IjsKCiAgICAgICAgICAgICAgICBjYXNlICJyYWRpbyI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBuW29dICYmIChlID0gYSksICc8aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9ImxheVRhYmxlUmFkaW9fJyArIHMuaW5kZXggKyAnIiAnICsgKG5bb10gPyAiY2hlY2tlZCIgOiAiIikgKyAnIGxheS10eXBlPSJsYXlUYWJsZVJhZGlvIj4nOwoKICAgICAgICAgICAgICAgIGNhc2UgIm51bWJlcnMiOgogICAgICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiByLnRvb2xiYXIgPyBpKHQoci50b29sYmFyKS5odG1sKCkgfHwgIiIpLnJlbmRlcihuKSA6IHkuY2FsbChjLCByLCBnLCBuKTsKICAgICAgICAgICAgfSgpLCAiPC9kaXY+PC90ZD4iXS5qb2luKCIiKTsKICAgICAgICAgICAgby5wdXNoKGIpLCByLmZpeGVkICYmICJyaWdodCIgIT09IHIuZml4ZWQgJiYgdS5wdXNoKGIpLCAicmlnaHQiID09PSByLmZpeGVkICYmIGgucHVzaChiKTsKICAgICAgICAgIH0KICAgICAgICB9KSwgZi5wdXNoKCc8dHIgZGF0YS1pbmRleD0iJyArIGEgKyAnIj4nICsgby5qb2luKCIiKSArICI8L3RyPiIpLCBtLnB1c2goJzx0ciBkYXRhLWluZGV4PSInICsgYSArICciPicgKyB1LmpvaW4oIiIpICsgIjwvdHI+IiksIGcucHVzaCgnPHRyIGRhdGEtaW5kZXg9IicgKyBhICsgJyI+JyArIGguam9pbigiIikgKyAiPC90cj4iKSk7CiAgICAgIH0pLCBjLmxheUJvZHkuc2Nyb2xsVG9wKDApLCBjLmxheU1haW4uZmluZCgiLiIgKyB2KS5yZW1vdmUoKSwgYy5sYXlNYWluLmZpbmQoInRib2R5IikuaHRtbChmLmpvaW4oIiIpKSwgYy5sYXlGaXhMZWZ0LmZpbmQoInRib2R5IikuaHRtbChtLmpvaW4oIiIpKSwgYy5sYXlGaXhSaWdodC5maW5kKCJ0Ym9keSIpLmh0bWwoZy5qb2luKCIiKSksIGMucmVuZGVyRm9ybSgpLCAibnVtYmVyIiA9PSB0eXBlb2YgZSAmJiBjLnNldFRoaXNSb3dDaGVja2VkKGUpLCBjLnN5bmNDaGVja0FsbCgpLCBjLmhhdmVJbml0ID8gYy5zY3JvbGxQYXRjaCgpIDogc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgYy5zY3JvbGxQYXRjaCgpOwogICAgICB9LCA1MCksIGMuaGF2ZUluaXQgPSAhMCwgbC5jbG9zZShjLnRpcHNJbmRleCksIHMuSEFTX1NFVF9DT0xTX1BBVENIIHx8IGMuc2V0Q29sc1BhdGNoKCksIHZvaWQgKHMuSEFTX1NFVF9DT0xTX1BBVENIID0gITApKTsKICAgIH07CgogICAgcmV0dXJuIGQuY2FjaGVbYy5rZXldID0gdSwgYy5sYXlQYWdlWzAgPT0gbyB8fCAwID09PSB1Lmxlbmd0aCAmJiAxID09IG4gPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIl0ocCksIDAgPT09IHUubGVuZ3RoID8gKGMucmVuZGVyRm9ybSgpLCBjLmVycm9yVmlldyhzLnRleHQubm9uZSkpIDogKGMubGF5Rml4ZWQucmVtb3ZlQ2xhc3MocCksIHIgPyBiKCkgOiAoYigpLCBjLnJlbmRlclRvdGFsKHUsIGgpLCB2b2lkIChzLnBhZ2UgJiYgKHMucGFnZSA9IHQuZXh0ZW5kKHsKICAgICAgZWxlbTogImxheXVpLXRhYmxlLXBhZ2UiICsgcy5pbmRleCwKICAgICAgY291bnQ6IG8sCiAgICAgIGxpbWl0OiBzLmxpbWl0LAogICAgICBsaW1pdHM6IHMubGltaXRzIHx8IFsxMCwgMjAsIDMwLCA0MCwgNTAsIDYwLCA3MCwgODAsIDkwXSwKICAgICAgZ3JvdXBzOiAzLAogICAgICBsYXlvdXQ6IFsicHJldiIsICJwYWdlIiwgIm5leHQiLCAic2tpcCIsICJjb3VudCIsICJsaW1pdCJdLAogICAgICBwcmV2OiAnPGkgY2xhc3M9ImxheXVpLWljb24iPiYjeGU2MDM7PC9pPicsCiAgICAgIG5leHQ6ICc8aSBjbGFzcz0ibGF5dWktaWNvbiI+JiN4ZTYwMjs8L2k+JywKICAgICAganVtcDogZnVuY3Rpb24ganVtcChlLCB0KSB7CiAgICAgICAgdCB8fCAoYy5wYWdlID0gZS5jdXJyLCBzLmxpbWl0ID0gZS5saW1pdCwgYy5wdWxsRGF0YShlLmN1cnIpKTsKICAgICAgfQogICAgfSwgcy5wYWdlKSwgcy5wYWdlLmNvdW50ID0gbywgYS5yZW5kZXIocy5wYWdlKSkpKSk7CiAgfSwgSC5wcm90b3R5cGUucmVuZGVyVG90YWwgPSBmdW5jdGlvbiAoZSwgYSkgewogICAgdmFyIGwgPSB0aGlzLAogICAgICAgIG4gPSBsLmNvbmZpZywKICAgICAgICBvID0ge307CgogICAgaWYgKG4udG90YWxSb3cpIHsKICAgICAgbGF5dWkuZWFjaChlLCBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICJhcnJheSIgPT09IGxheXVpLl90eXBlb2YodCkgJiYgMCA9PT0gdC5sZW5ndGggfHwgbC5lYWNoQ29scyhmdW5jdGlvbiAoZSwgaSkgewogICAgICAgICAgdmFyIGEgPSBpLmZpZWxkIHx8IGUsCiAgICAgICAgICAgICAgbCA9IHRbYV07CiAgICAgICAgICBpLnRvdGFsUm93ICYmIChvW2FdID0gKG9bYV0gfHwgMCkgKyAocGFyc2VGbG9hdChsKSB8fCAwKSk7CiAgICAgICAgfSk7CiAgICAgIH0pLCBsLmRhdGFUb3RhbCA9IHt9OwogICAgICB2YXIgciA9IFtdOwogICAgICBsLmVhY2hDb2xzKGZ1bmN0aW9uIChlLCBjKSB7CiAgICAgICAgdmFyIGQgPSBjLmZpZWxkIHx8IGUsCiAgICAgICAgICAgIHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgZSwKICAgICAgICAgICAgICB0ID0gYy50b3RhbFJvd1RleHQgfHwgIiIsCiAgICAgICAgICAgICAgaSA9IHBhcnNlRmxvYXQob1tkXSkudG9GaXhlZCgyKSwKICAgICAgICAgICAgICBuID0ge307CiAgICAgICAgICByZXR1cm4gbltkXSA9IGksIGUgPSBjLnRvdGFsUm93ID8geS5jYWxsKGwsIGMsIGksIG4pIHx8IHQgOiB0LCBhID8gYVtjLmZpZWxkXSB8fCBlIDogZTsKICAgICAgICB9KCksCiAgICAgICAgICAgIHUgPSBbJzx0ZCBkYXRhLWZpZWxkPSInICsgZCArICciIGRhdGEta2V5PSInICsgbi5pbmRleCArICItIiArIGMua2V5ICsgJyIgJyArIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBlID0gW107CiAgICAgICAgICByZXR1cm4gYy5hbGlnbiAmJiBlLnB1c2goJ2FsaWduPSInICsgYy5hbGlnbiArICciJyksIGMuc3R5bGUgJiYgZS5wdXNoKCdzdHlsZT0iJyArIGMuc3R5bGUgKyAnIicpLCBjLm1pbldpZHRoICYmIGUucHVzaCgnZGF0YS1taW53aWR0aD0iJyArIGMubWluV2lkdGggKyAnIicpLCBlLmpvaW4oIiAiKTsKICAgICAgICB9KCkgKyAnIGNsYXNzPSInICsgZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGUgPSBbXTsKICAgICAgICAgIHJldHVybiBjLmhpZGUgJiYgZS5wdXNoKHApLCBjLmZpZWxkIHx8IGUucHVzaCgibGF5dWktdGFibGUtY29sLXNwZWNpYWwiKSwgZS5qb2luKCIgIik7CiAgICAgICAgfSgpICsgJyI+JywgJzxkaXYgY2xhc3M9ImxheXVpLXRhYmxlLWNlbGwgbGF5dGFibGUtY2VsbC0nICsgZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGUgPSBuLmluZGV4ICsgIi0iICsgYy5rZXk7CiAgICAgICAgICByZXR1cm4gIm5vcm1hbCIgPT09IGMudHlwZSA/IGUgOiBlICsgIiBsYXl0YWJsZS1jZWxsLSIgKyBjLnR5cGU7CiAgICAgICAgfSgpICsgJyI+JyArIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBlID0gYy50b3RhbFJvdyB8fCBuLnRvdGFsUm93OwogICAgICAgICAgcmV0dXJuICJzdHJpbmciID09IHR5cGVvZiBlID8gaShlKS5yZW5kZXIodC5leHRlbmQoewogICAgICAgICAgICBUT1RBTF9OVU1TOiBzCiAgICAgICAgICB9LCBjKSkgOiBzOwogICAgICAgIH0oKSwgIjwvZGl2PjwvdGQ+Il0uam9pbigiIik7CgogICAgICAgIGMuZmllbGQgJiYgKGwuZGF0YVRvdGFsW2RdID0gcyksIHIucHVzaCh1KTsKICAgICAgfSksIGwubGF5VG90YWwuZmluZCgidGJvZHkiKS5odG1sKCI8dHI+IiArIHIuam9pbigiIikgKyAiPC90cj4iKTsKICAgIH0KICB9LCBILnByb3RvdHlwZS5nZXRDb2xFbGVtID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgIHZhciBpID0gdGhpcywKICAgICAgICBhID0gaS5jb25maWc7CiAgICByZXR1cm4gZS5lcSgwKS5maW5kKCIubGF5dGFibGUtY2VsbC0iICsgKGEuaW5kZXggKyAiLSIgKyB0KSArICI6ZXEoMCkiKTsKICB9LCBILnByb3RvdHlwZS5yZW5kZXJGb3JtID0gZnVuY3Rpb24gKGUpIHsKICAgIG4ucmVuZGVyKGUsICJMQVktdGFibGUtIiArIHRoaXMuaW5kZXgpOwogIH0sIEgucHJvdG90eXBlLnNldFRoaXNSb3dDaGVja2VkID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gdGhpcywKICAgICAgICBpID0gKHQuY29uZmlnLCAibGF5dWktdGFibGUtY2xpY2siKSwKICAgICAgICBhID0gdC5sYXlCb2R5LmZpbmQoJ3RyW2RhdGEtaW5kZXg9IicgKyBlICsgJyJdJyk7CiAgICBhLmFkZENsYXNzKGkpLnNpYmxpbmdzKCJ0ciIpLnJlbW92ZUNsYXNzKGkpOwogIH0sIEgucHJvdG90eXBlLnNvcnQgPSBmdW5jdGlvbiAoZSwgaSwgYSwgbCkgewogICAgdmFyIG4sCiAgICAgICAgbywKICAgICAgICBjID0gdGhpcywKICAgICAgICBzID0ge30sCiAgICAgICAgdSA9IGMuY29uZmlnLAogICAgICAgIHkgPSB1LmVsZW0uYXR0cigibGF5LWZpbHRlciIpLAogICAgICAgIGYgPSBkLmNhY2hlW2Mua2V5XTsKICAgICJzdHJpbmciID09IHR5cGVvZiBlICYmIChuID0gZSwgYy5sYXlIZWFkZXIuZmluZCgidGgiKS5lYWNoKGZ1bmN0aW9uIChpLCBhKSB7CiAgICAgIHZhciBsID0gdCh0aGlzKSwKICAgICAgICAgIG8gPSBsLmRhdGEoImZpZWxkIik7CiAgICAgIGlmIChvID09PSBlKSByZXR1cm4gZSA9IGwsIG4gPSBvLCAhMTsKICAgIH0pKTsKCiAgICB0cnkgewogICAgICB2YXIgbiA9IG4gfHwgZS5kYXRhKCJmaWVsZCIpLAogICAgICAgICAgcCA9IGUuZGF0YSgia2V5Iik7CiAgICAgIGlmIChjLnNvcnRLZXkgJiYgIWEgJiYgbiA9PT0gYy5zb3J0S2V5LmZpZWxkICYmIGkgPT09IGMuc29ydEtleS5zb3J0KSByZXR1cm47CiAgICAgIHZhciB2ID0gYy5sYXlIZWFkZXIuZmluZCgidGggLmxheXRhYmxlLWNlbGwtIiArIHApLmZpbmQoQSk7CiAgICAgIGMubGF5SGVhZGVyLmZpbmQoInRoIikuZmluZChBKS5yZW1vdmVBdHRyKCJsYXktc29ydCIpLCB2LmF0dHIoImxheS1zb3J0IiwgaSB8fCBudWxsKSwgYy5sYXlGaXhlZC5maW5kKCJ0aCIpOwogICAgfSBjYXRjaCAobSkgewogICAgICByLmVycm9yKCJUYWJsZSBtb2R1bGVzOiBzb3J0IGZpZWxkICciICsgbiArICInIG5vdCBtYXRjaGVkIik7CiAgICB9CgogICAgYy5zb3J0S2V5ID0gewogICAgICBmaWVsZDogbiwKICAgICAgc29ydDogaQogICAgfSwgdS5hdXRvU29ydCAmJiAoImFzYyIgPT09IGkgPyBvID0gbGF5dWkuc29ydChmLCBuKSA6ICJkZXNjIiA9PT0gaSA/IG8gPSBsYXl1aS5zb3J0KGYsIG4sICEwKSA6IChvID0gbGF5dWkuc29ydChmLCBkLmNvbmZpZy5pbmRleE5hbWUpLCBkZWxldGUgYy5zb3J0S2V5KSksIHNbdS5yZXNwb25zZS5kYXRhTmFtZV0gPSBvIHx8IGYsIGMucmVuZGVyRGF0YShzLCBjLnBhZ2UsIGMuY291bnQsICEwKSwgbCAmJiBsYXl1aS5ldmVudC5jYWxsKGUsIGgsICJzb3J0KCIgKyB5ICsgIikiLCB7CiAgICAgIGZpZWxkOiBuLAogICAgICB0eXBlOiBpCiAgICB9KTsKICB9LCBILnByb3RvdHlwZS5sb2FkaW5nID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBpID0gdGhpcywKICAgICAgICBhID0gaS5jb25maWc7CiAgICBhLmxvYWRpbmcgJiYgKGUgPyAoaS5sYXlJbml0ICYmIGkubGF5SW5pdC5yZW1vdmUoKSwgZGVsZXRlIGkubGF5SW5pdCwgaS5sYXlCb3guZmluZCh4KS5yZW1vdmUoKSkgOiAoaS5sYXlJbml0ID0gdChbJzxkaXYgY2xhc3M9ImxheXVpLXRhYmxlLWluaXQiPicsICc8aSBjbGFzcz0ibGF5dWktaWNvbiBsYXl1aS1pY29uLWxvYWRpbmcgbGF5dWktYW5pbSBsYXl1aS1hbmltLXJvdGF0ZSBsYXl1aS1hbmltLWxvb3AiPjwvaT4nLCAiPC9kaXY+Il0uam9pbigiIikpLCBpLmxheUJveC5hcHBlbmQoaS5sYXlJbml0KSkpOwogIH0sIEgucHJvdG90eXBlLnNldENoZWNrRGF0YSA9IGZ1bmN0aW9uIChlLCB0KSB7CiAgICB2YXIgaSA9IHRoaXMsCiAgICAgICAgYSA9IGkuY29uZmlnLAogICAgICAgIGwgPSBkLmNhY2hlW2kua2V5XTsKICAgIGxbZV0gJiYgImFycmF5IiAhPT0gbGF5dWkuX3R5cGVvZihsW2VdKSAmJiAobFtlXVthLmNoZWNrTmFtZV0gPSB0KTsKICB9LCBILnByb3RvdHlwZS5zeW5jQ2hlY2tBbGwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgdCA9IGUuY29uZmlnLAogICAgICAgIGkgPSBlLmxheUhlYWRlci5maW5kKCdpbnB1dFtuYW1lPSJsYXlUYWJsZUNoZWNrYm94Il0nKSwKICAgICAgICBhID0gZnVuY3Rpb24gYShpKSB7CiAgICAgIHJldHVybiBlLmVhY2hDb2xzKGZ1bmN0aW9uIChlLCBhKSB7CiAgICAgICAgImNoZWNrYm94IiA9PT0gYS50eXBlICYmIChhW3QuY2hlY2tOYW1lXSA9IGkpOwogICAgICB9KSwgaTsKICAgIH07CgogICAgaVswXSAmJiAoZC5jaGVja1N0YXR1cyhlLmtleSkuaXNBbGwgPyAoaVswXS5jaGVja2VkIHx8IChpLnByb3AoImNoZWNrZWQiLCAhMCksIGUucmVuZGVyRm9ybSgiY2hlY2tib3giKSksIGEoITApKSA6IChpWzBdLmNoZWNrZWQgJiYgKGkucHJvcCgiY2hlY2tlZCIsICExKSwgZS5yZW5kZXJGb3JtKCJjaGVja2JveCIpKSwgYSghMSkpKTsKICB9LCBILnByb3RvdHlwZS5nZXRDc3NSdWxlID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgIHZhciBpID0gdGhpcywKICAgICAgICBhID0gaS5lbGVtLmZpbmQoInN0eWxlIilbMF0sCiAgICAgICAgbCA9IGEuc2hlZXQgfHwgYS5zdHlsZVNoZWV0IHx8IHt9LAogICAgICAgIG4gPSBsLmNzc1J1bGVzIHx8IGwucnVsZXM7CiAgICBsYXl1aS5lYWNoKG4sIGZ1bmN0aW9uIChpLCBhKSB7CiAgICAgIGlmIChhLnNlbGVjdG9yVGV4dCA9PT0gIi5sYXl0YWJsZS1jZWxsLSIgKyBlKSByZXR1cm4gdChhKSwgITA7CiAgICB9KTsKICB9LCBILnByb3RvdHlwZS5mdWxsU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlLAogICAgICAgIHQgPSB0aGlzLAogICAgICAgIGkgPSB0LmNvbmZpZywKICAgICAgICBhID0gaS5oZWlnaHQ7CiAgICB0LmZ1bGxIZWlnaHRHYXAgJiYgKGEgPSBGLmhlaWdodCgpIC0gdC5mdWxsSGVpZ2h0R2FwLCBhIDwgMTM1ICYmIChhID0gMTM1KSwgdC5lbGVtLmNzcygiaGVpZ2h0IiwgYSkpLCBhICYmIChlID0gcGFyc2VGbG9hdChhKSAtICh0LmxheUhlYWRlci5vdXRlckhlaWdodCgpIHx8IDM4KSwgaS50b29sYmFyICYmIChlIC09IHQubGF5VG9vbC5vdXRlckhlaWdodCgpIHx8IDUwKSwgaS50b3RhbFJvdyAmJiAoZSAtPSB0LmxheVRvdGFsLm91dGVySGVpZ2h0KCkgfHwgNDApLCBpLnBhZ2UgJiYgKGUgLT0gdC5sYXlQYWdlLm91dGVySGVpZ2h0KCkgfHwgNDEpLCB0LmxheU1haW4uY3NzKCJoZWlnaHQiLCBlIC0gMikpOwogIH0sIEgucHJvdG90eXBlLmdldFNjcm9sbFdpZHRoID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gMDsKICAgIHJldHVybiBlID8gdCA9IGUub2Zmc2V0V2lkdGggLSBlLmNsaWVudFdpZHRoIDogKGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSwgZS5zdHlsZS53aWR0aCA9ICIxMDBweCIsIGUuc3R5bGUuaGVpZ2h0ID0gIjEwMHB4IiwgZS5zdHlsZS5vdmVyZmxvd1kgPSAic2Nyb2xsIiwgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlKSwgdCA9IGUub2Zmc2V0V2lkdGggLSBlLmNsaWVudFdpZHRoLCBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGUpKSwgdDsKICB9LCBILnByb3RvdHlwZS5zY3JvbGxQYXRjaCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICBpID0gZS5sYXlNYWluLmNoaWxkcmVuKCJ0YWJsZSIpLAogICAgICAgIGEgPSBlLmxheU1haW4ud2lkdGgoKSAtIGUubGF5TWFpbi5wcm9wKCJjbGllbnRXaWR0aCIpLAogICAgICAgIGwgPSBlLmxheU1haW4uaGVpZ2h0KCkgLSBlLmxheU1haW4ucHJvcCgiY2xpZW50SGVpZ2h0IiksCiAgICAgICAgbiA9IChlLmdldFNjcm9sbFdpZHRoKGUubGF5TWFpblswXSksIGkub3V0ZXJXaWR0aCgpIC0gZS5sYXlNYWluLndpZHRoKCkpLAogICAgICAgIG8gPSBmdW5jdGlvbiBvKGUpIHsKICAgICAgaWYgKGEgJiYgbCkgewogICAgICAgIGlmIChlID0gZS5lcSgwKSwgIWUuZmluZCgiLmxheXVpLXRhYmxlLXBhdGNoIilbMF0pIHsKICAgICAgICAgIHZhciBpID0gdCgnPHRoIGNsYXNzPSJsYXl1aS10YWJsZS1wYXRjaCI+PGRpdiBjbGFzcz0ibGF5dWktdGFibGUtY2VsbCI+PC9kaXY+PC90aD4nKTsKICAgICAgICAgIGkuZmluZCgiZGl2IikuY3NzKHsKICAgICAgICAgICAgd2lkdGg6IGEKICAgICAgICAgIH0pLCBlLmZpbmQoInRyIikuYXBwZW5kKGkpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGUuZmluZCgiLmxheXVpLXRhYmxlLXBhdGNoIikucmVtb3ZlKCk7CiAgICB9OwoKICAgIG8oZS5sYXlIZWFkZXIpLCBvKGUubGF5VG90YWwpOwogICAgdmFyIHIgPSBlLmxheU1haW4uaGVpZ2h0KCksCiAgICAgICAgYyA9IHIgLSBsOwogICAgZS5sYXlGaXhlZC5maW5kKEMpLmNzcygiaGVpZ2h0IiwgaS5oZWlnaHQoKSA+PSBjID8gYyA6ICJhdXRvIiksIGUubGF5Rml4UmlnaHRbbiA+IDAgPyAicmVtb3ZlQ2xhc3MiIDogImFkZENsYXNzIl0ocCksIGUubGF5Rml4UmlnaHQuY3NzKCJyaWdodCIsIGEgLSAxKTsKICB9LCBILnByb3RvdHlwZS5ldmVudHMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSwKICAgICAgICBpID0gdGhpcywKICAgICAgICBhID0gaS5jb25maWcsCiAgICAgICAgbyA9IHQoImJvZHkiKSwKICAgICAgICByID0ge30sCiAgICAgICAgcyA9IGkubGF5SGVhZGVyLmZpbmQoInRoIiksCiAgICAgICAgdSA9ICIubGF5dWktdGFibGUtY2VsbCIsCiAgICAgICAgZiA9IGEuZWxlbS5hdHRyKCJsYXktZmlsdGVyIik7CiAgICBpLmxheVRvb2wub24oImNsaWNrIiwgIipbbGF5LWV2ZW50XSIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBvID0gdCh0aGlzKSwKICAgICAgICAgIHIgPSBvLmF0dHIoImxheS1ldmVudCIpLAogICAgICAgICAgcyA9IGZ1bmN0aW9uIHMoZSkgewogICAgICAgIHZhciBsID0gdChlLmxpc3QpLAogICAgICAgICAgICBuID0gdCgnPHVsIGNsYXNzPSJsYXl1aS10YWJsZS10b29sLXBhbmVsIj48L3VsPicpOwogICAgICAgIG4uaHRtbChsKSwgYS5oZWlnaHQgJiYgbi5jc3MoIm1heC1oZWlnaHQiLCBhLmhlaWdodCAtIChpLmxheVRvb2wub3V0ZXJIZWlnaHQoKSB8fCA1MCkpLCBvLmZpbmQoIi5sYXl1aS10YWJsZS10b29sLXBhbmVsIilbMF0gfHwgby5hcHBlbmQobiksIGkucmVuZGVyRm9ybSgpLCBuLm9uKCJjbGljayIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICBsYXl1aS5zdG9wZShlKTsKICAgICAgICB9KSwgZS5kb25lICYmIGUuZG9uZShuLCBsKTsKICAgICAgfTsKCiAgICAgIHN3aXRjaCAobGF5dWkuc3RvcGUoZSksIEkudHJpZ2dlcigidGFibGUudG9vbC5wYW5lbC5yZW1vdmUiKSwgbC5jbG9zZShpLnRpcHNJbmRleCksIHIpIHsKICAgICAgICBjYXNlICJMQVlUQUJMRV9DT0xTIjoKICAgICAgICAgIHMoewogICAgICAgICAgICBsaXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdmFyIGUgPSBbXTsKICAgICAgICAgICAgICByZXR1cm4gaS5lYWNoQ29scyhmdW5jdGlvbiAodCwgaSkgewogICAgICAgICAgICAgICAgaS5maWVsZCAmJiAibm9ybWFsIiA9PSBpLnR5cGUgJiYgZS5wdXNoKCc8bGk+PGlucHV0IHR5cGU9ImNoZWNrYm94IiBuYW1lPSInICsgaS5maWVsZCArICciIGRhdGEta2V5PSInICsgaS5rZXkgKyAnIiBkYXRhLXBhcmVudGtleT0iJyArIChpLnBhcmVudEtleSB8fCAiIikgKyAnIiBsYXktc2tpbj0icHJpbWFyeSIgJyArIChpLmhpZGUgPyAiIiA6ICJjaGVja2VkIikgKyAnIHRpdGxlPSInICsgKGkudGl0bGUgfHwgaS5maWVsZCkgKyAnIiBsYXktZmlsdGVyPSJMQVlfVEFCTEVfVE9PTF9DT0xTIj48L2xpPicpOwogICAgICAgICAgICAgIH0pLCBlLmpvaW4oIiIpOwogICAgICAgICAgICB9KCksCiAgICAgICAgICAgIGRvbmU6IGZ1bmN0aW9uIGRvbmUoKSB7CiAgICAgICAgICAgICAgbi5vbigiY2hlY2tib3goTEFZX1RBQkxFX1RPT0xfQ09MUykiLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgdmFyIGwgPSB0KGUuZWxlbSksCiAgICAgICAgICAgICAgICAgICAgbiA9IHRoaXMuY2hlY2tlZCwKICAgICAgICAgICAgICAgICAgICBvID0gbC5kYXRhKCJrZXkiKSwKICAgICAgICAgICAgICAgICAgICByID0gbC5kYXRhKCJwYXJlbnRrZXkiKTsKICAgICAgICAgICAgICAgIGxheXVpLmVhY2goYS5jb2xzLCBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICAgICAgICAgICBsYXl1aS5lYWNoKHQsIGZ1bmN0aW9uICh0LCBsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGUgKyAiLSIgKyB0ID09PSBvKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IGwuaGlkZTsKICAgICAgICAgICAgICAgICAgICAgIGwuaGlkZSA9ICFuLCBpLmVsZW0uZmluZCgnKltkYXRhLWtleT0iJyArIGEuaW5kZXggKyAiLSIgKyBvICsgJyJdJylbbiA/ICJyZW1vdmVDbGFzcyIgOiAiYWRkQ2xhc3MiXShwKSwgYyAhPSBsLmhpZGUgJiYgaS5zZXRQYXJlbnRDb2woIW4sIHIpLCBpLnJlc2l6ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAiTEFZVEFCTEVfRVhQT1JUIjoKICAgICAgICAgIGMuaWUgPyBsLnRpcHMoIlx1NUJGQ1x1NTFGQVx1NTI5Rlx1ODBGRFx1NEUwRFx1NjUyRlx1NjMwMSBJRVx1RkYwQ1x1OEJGN1x1NzUyOCBDaHJvbWUgXHU3QjQ5XHU5QUQ4XHU3RUE3XHU2RDRGXHU4OUM4XHU1NjY4XHU1QkZDXHU1MUZBIiwgdGhpcywgewogICAgICAgICAgICB0aXBzOiAzCiAgICAgICAgICB9KSA6IHMoewogICAgICAgICAgICBsaXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFsiPGxpIGRhdGEtdHlwZT1cImNzdlwiPlx1NUJGQ1x1NTFGQVx1NTIzMCBDc3YgXHU2NTg3XHU0RUY2PC9saT4iLCAiPGxpIGRhdGEtdHlwZT1cInhsc1wiPlx1NUJGQ1x1NTFGQVx1NTIzMCBFeGNlbCBcdTY1ODdcdTRFRjY8L2xpPiJdLmpvaW4oIiIpOwogICAgICAgICAgICB9KCksCiAgICAgICAgICAgIGRvbmU6IGZ1bmN0aW9uIGRvbmUoZSwgbCkgewogICAgICAgICAgICAgIGwub24oImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGUgPSB0KHRoaXMpLmRhdGEoInR5cGUiKTsKICAgICAgICAgICAgICAgIGQuZXhwb3J0RmlsZS5jYWxsKGksIGEuaWQsIG51bGwsIGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICJMQVlUQUJMRV9QUklOVCI6CiAgICAgICAgICB2YXIgdSA9IHdpbmRvdy5vcGVuKCJcdTYyNTNcdTUzNzBcdTdBOTdcdTUzRTMiLCAiX2JsYW5rIiksCiAgICAgICAgICAgICAgeSA9IFsiPHN0eWxlPiIsICJib2R5e2ZvbnQtc2l6ZTogMTJweDsgY29sb3I6ICM2NjY7fSIsICJ0YWJsZXt3aWR0aDogMTAwJTsgYm9yZGVyLWNvbGxhcHNlOiBjb2xsYXBzZTsgYm9yZGVyLXNwYWNpbmc6IDA7fSIsICJ0aCx0ZHtsaW5lLWhlaWdodDogMjBweDsgcGFkZGluZzogOXB4IDE1cHg7IGJvcmRlcjogMXB4IHNvbGlkICNjY2M7IHRleHQtYWxpZ246IGxlZnQ7IGZvbnQtc2l6ZTogMTJweDsgY29sb3I6ICM2NjY7fSIsICJhe2NvbG9yOiAjNjY2OyB0ZXh0LWRlY29yYXRpb246bm9uZTt9IiwgIioubGF5dWktaGlkZXtkaXNwbGF5OiBub25lfSIsICI8L3N0eWxlPiJdLmpvaW4oIiIpLAogICAgICAgICAgICAgIHYgPSB0KGkubGF5SGVhZGVyLmh0bWwoKSk7CiAgICAgICAgICB2LmFwcGVuZChpLmxheU1haW4uZmluZCgidGFibGUiKS5odG1sKCkpLCB2LmFwcGVuZChpLmxheVRvdGFsLmZpbmQoInRhYmxlIikuaHRtbCgpKSwgdi5maW5kKCJ0aC5sYXl1aS10YWJsZS1wYXRjaCIpLnJlbW92ZSgpLCB2LmZpbmQoIi5sYXl1aS10YWJsZS1jb2wtc3BlY2lhbCIpLnJlbW92ZSgpLCB1LmRvY3VtZW50LndyaXRlKHkgKyB2LnByb3AoIm91dGVySFRNTCIpKSwgdS5kb2N1bWVudC5jbG9zZSgpLCB1LnByaW50KCksIHUuY2xvc2UoKTsKICAgICAgfQoKICAgICAgbGF5dWkuZXZlbnQuY2FsbCh0aGlzLCBoLCAidG9vbGJhcigiICsgZiArICIpIiwgdC5leHRlbmQoewogICAgICAgIGV2ZW50OiByLAogICAgICAgIGNvbmZpZzogYQogICAgICB9LCB7fSkpOwogICAgfSksIHMub24oIm1vdXNlbW92ZSIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBpID0gdCh0aGlzKSwKICAgICAgICAgIGEgPSBpLm9mZnNldCgpLmxlZnQsCiAgICAgICAgICBsID0gZS5jbGllbnRYIC0gYTsKICAgICAgaS5kYXRhKCJ1bnJlc2l6ZSIpIHx8IHIucmVzaXplU3RhcnQgfHwgKHIuYWxsb3dSZXNpemUgPSBpLndpZHRoKCkgLSBsIDw9IDEwLCBvLmNzcygiY3Vyc29yIiwgci5hbGxvd1Jlc2l6ZSA/ICJjb2wtcmVzaXplIiA6ICIiKSk7CiAgICB9KS5vbigibW91c2VsZWF2ZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgdCh0aGlzKTsKICAgICAgci5yZXNpemVTdGFydCB8fCBvLmNzcygiY3Vyc29yIiwgIiIpOwogICAgfSkub24oIm1vdXNlZG93biIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBsID0gdCh0aGlzKTsKCiAgICAgIGlmIChyLmFsbG93UmVzaXplKSB7CiAgICAgICAgdmFyIG4gPSBsLmRhdGEoImtleSIpOwogICAgICAgIGUucHJldmVudERlZmF1bHQoKSwgci5yZXNpemVTdGFydCA9ICEwLCByLm9mZnNldCA9IFtlLmNsaWVudFgsIGUuY2xpZW50WV0sIGkuZ2V0Q3NzUnVsZShuLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgdmFyIHQgPSBlLnN0eWxlLndpZHRoIHx8IGwub3V0ZXJXaWR0aCgpOwogICAgICAgICAgci5ydWxlID0gZSwgci5ydWxlV2lkdGggPSBwYXJzZUZsb2F0KHQpLCByLm1pbldpZHRoID0gbC5kYXRhKCJtaW53aWR0aCIpIHx8IGEuY2VsbE1pbldpZHRoOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KSwgSS5vbigibW91c2Vtb3ZlIiwgZnVuY3Rpb24gKHQpIHsKICAgICAgaWYgKHIucmVzaXplU3RhcnQpIHsKICAgICAgICBpZiAodC5wcmV2ZW50RGVmYXVsdCgpLCByLnJ1bGUpIHsKICAgICAgICAgIHZhciBhID0gci5ydWxlV2lkdGggKyB0LmNsaWVudFggLSByLm9mZnNldFswXTsKICAgICAgICAgIGEgPCByLm1pbldpZHRoICYmIChhID0gci5taW5XaWR0aCksIHIucnVsZS5zdHlsZS53aWR0aCA9IGEgKyAicHgiLCBsLmNsb3NlKGkudGlwc0luZGV4KTsKICAgICAgICB9CgogICAgICAgIGUgPSAxOwogICAgICB9CiAgICB9KS5vbigibW91c2V1cCIsIGZ1bmN0aW9uICh0KSB7CiAgICAgIHIucmVzaXplU3RhcnQgJiYgKHIgPSB7fSwgby5jc3MoImN1cnNvciIsICIiKSwgaS5zY3JvbGxQYXRjaCgpKSwgMiA9PT0gZSAmJiAoZSA9IG51bGwpOwogICAgfSksIHMub24oImNsaWNrIiwgZnVuY3Rpb24gKGEpIHsKICAgICAgdmFyIGwsCiAgICAgICAgICBuID0gdCh0aGlzKSwKICAgICAgICAgIG8gPSBuLmZpbmQoQSksCiAgICAgICAgICByID0gby5hdHRyKCJsYXktc29ydCIpOwogICAgICByZXR1cm4gb1swXSAmJiAxICE9PSBlID8gKGwgPSAiYXNjIiA9PT0gciA/ICJkZXNjIiA6ICJkZXNjIiA9PT0gciA/IG51bGwgOiAiYXNjIiwgdm9pZCBpLnNvcnQobiwgbCwgbnVsbCwgITApKSA6IGUgPSAyOwogICAgfSkuZmluZChBICsgIiAubGF5dWktZWRnZSAiKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgYSA9IHQodGhpcyksCiAgICAgICAgICBsID0gYS5pbmRleCgpLAogICAgICAgICAgbiA9IGEucGFyZW50cygidGgiKS5lcSgwKS5kYXRhKCJmaWVsZCIpOwogICAgICBsYXl1aS5zdG9wZShlKSwgMCA9PT0gbCA/IGkuc29ydChuLCAiYXNjIiwgbnVsbCwgITApIDogaS5zb3J0KG4sICJkZXNjIiwgbnVsbCwgITApOwogICAgfSk7CgogICAgdmFyIHYgPSBmdW5jdGlvbiB2KGUpIHsKICAgICAgdmFyIGEgPSB0KHRoaXMpLAogICAgICAgICAgbCA9IGEucGFyZW50cygidHIiKS5lcSgwKS5kYXRhKCJpbmRleCIpLAogICAgICAgICAgbiA9IGkubGF5Qm9keS5maW5kKCd0cltkYXRhLWluZGV4PSInICsgbCArICciXScpLAogICAgICAgICAgbyA9IGQuY2FjaGVbaS5rZXldIHx8IFtdOwogICAgICByZXR1cm4gbyA9IG9bbF0gfHwge30sIHQuZXh0ZW5kKHsKICAgICAgICB0cjogbiwKICAgICAgICBkYXRhOiBkLmNsZWFyQ2FjaGVLZXkobyksCiAgICAgICAgZGVsOiBmdW5jdGlvbiBkZWwoKSB7CiAgICAgICAgICBkLmNhY2hlW2kua2V5XVtsXSA9IFtdLCBuLnJlbW92ZSgpLCBpLnNjcm9sbFBhdGNoKCk7CiAgICAgICAgfSwKICAgICAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShlKSB7CiAgICAgICAgICBlID0gZSB8fCB7fSwgbGF5dWkuZWFjaChlLCBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICAgICBpZiAoZSBpbiBvKSB7CiAgICAgICAgICAgICAgdmFyIGEsCiAgICAgICAgICAgICAgICAgIGwgPSBuLmNoaWxkcmVuKCd0ZFtkYXRhLWZpZWxkPSInICsgZSArICciXScpOwogICAgICAgICAgICAgIG9bZV0gPSB0LCBpLmVhY2hDb2xzKGZ1bmN0aW9uICh0LCBpKSB7CiAgICAgICAgICAgICAgICBpLmZpZWxkID09IGUgJiYgaS50ZW1wbGV0ICYmIChhID0gaS50ZW1wbGV0KTsKICAgICAgICAgICAgICB9KSwgbC5jaGlsZHJlbih1KS5odG1sKHkuY2FsbChpLCB7CiAgICAgICAgICAgICAgICB0ZW1wbGV0OiBhCiAgICAgICAgICAgICAgfSwgdCwgbykpLCBsLmRhdGEoImNvbnRlbnQiLCB0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9LCBlKTsKICAgIH07CgogICAgaS5lbGVtLm9uKCJjbGljayIsICdpbnB1dFtuYW1lPSJsYXlUYWJsZUNoZWNrYm94Il0rJywgZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IHQodGhpcykucHJldigpLAogICAgICAgICAgYSA9IGkubGF5Qm9keS5maW5kKCdpbnB1dFtuYW1lPSJsYXlUYWJsZUNoZWNrYm94Il0nKSwKICAgICAgICAgIGwgPSBlLnBhcmVudHMoInRyIikuZXEoMCkuZGF0YSgiaW5kZXgiKSwKICAgICAgICAgIG4gPSBlWzBdLmNoZWNrZWQsCiAgICAgICAgICBvID0gImxheVRhYmxlQWxsQ2hvb3NlIiA9PT0gZS5hdHRyKCJsYXktZmlsdGVyIik7CiAgICAgIG8gPyAoYS5lYWNoKGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgICAgdC5jaGVja2VkID0gbiwgaS5zZXRDaGVja0RhdGEoZSwgbik7CiAgICAgIH0pLCBpLnN5bmNDaGVja0FsbCgpLCBpLnJlbmRlckZvcm0oImNoZWNrYm94IikpIDogKGkuc2V0Q2hlY2tEYXRhKGwsIG4pLCBpLnN5bmNDaGVja0FsbCgpKSwgbGF5dWkuZXZlbnQuY2FsbChlWzBdLCBoLCAiY2hlY2tib3goIiArIGYgKyAiKSIsIHYuY2FsbChlWzBdLCB7CiAgICAgICAgY2hlY2tlZDogbiwKICAgICAgICB0eXBlOiBvID8gImFsbCIgOiAib25lIgogICAgICB9KSk7CiAgICB9KSwgaS5lbGVtLm9uKCJjbGljayIsICdpbnB1dFtsYXktdHlwZT0ibGF5VGFibGVSYWRpbyJdKycsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSB0KHRoaXMpLnByZXYoKSwKICAgICAgICAgIGwgPSBlWzBdLmNoZWNrZWQsCiAgICAgICAgICBuID0gZC5jYWNoZVtpLmtleV0sCiAgICAgICAgICBvID0gZS5wYXJlbnRzKCJ0ciIpLmVxKDApLmRhdGEoImluZGV4Iik7CiAgICAgIGxheXVpLmVhY2gobiwgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgICBvID09PSBlID8gdFthLmNoZWNrTmFtZV0gPSAhMCA6IGRlbGV0ZSB0W2EuY2hlY2tOYW1lXTsKICAgICAgfSksIGkuc2V0VGhpc1Jvd0NoZWNrZWQobyksIGxheXVpLmV2ZW50LmNhbGwodGhpcywgaCwgInJhZGlvKCIgKyBmICsgIikiLCB2LmNhbGwodGhpcywgewogICAgICAgIGNoZWNrZWQ6IGwKICAgICAgfSkpOwogICAgfSksIGkubGF5Qm9keS5vbigibW91c2VlbnRlciIsICJ0ciIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSB0KHRoaXMpLAogICAgICAgICAgYSA9IGUuaW5kZXgoKTsKICAgICAgZS5kYXRhKCJvZmYiKSB8fCBpLmxheUJvZHkuZmluZCgidHI6ZXEoIiArIGEgKyAiKSIpLmFkZENsYXNzKFcpOwogICAgfSkub24oIm1vdXNlbGVhdmUiLCAidHIiLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlID0gdCh0aGlzKSwKICAgICAgICAgIGEgPSBlLmluZGV4KCk7CiAgICAgIGUuZGF0YSgib2ZmIikgfHwgaS5sYXlCb2R5LmZpbmQoInRyOmVxKCIgKyBhICsgIikiKS5yZW1vdmVDbGFzcyhXKTsKICAgIH0pLm9uKCJjbGljayIsICJ0ciIsIGZ1bmN0aW9uICgpIHsKICAgICAgbS5jYWxsKHRoaXMsICJyb3ciKTsKICAgIH0pLm9uKCJkYmxjbGljayIsICJ0ciIsIGZ1bmN0aW9uICgpIHsKICAgICAgbS5jYWxsKHRoaXMsICJyb3dEb3VibGUiKTsKICAgIH0pOwoKICAgIHZhciBtID0gZnVuY3Rpb24gbShlKSB7CiAgICAgIHZhciBpID0gdCh0aGlzKTsKICAgICAgaS5kYXRhKCJvZmYiKSB8fCBsYXl1aS5ldmVudC5jYWxsKHRoaXMsIGgsIGUgKyAiKCIgKyBmICsgIikiLCB2LmNhbGwoaS5jaGlsZHJlbigidGQiKVswXSkpOwogICAgfTsKCiAgICBpLmxheUJvZHkub24oImNoYW5nZSIsICIuIiArIFIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSB0KHRoaXMpLAogICAgICAgICAgYSA9IHRoaXMudmFsdWUsCiAgICAgICAgICBsID0gZS5wYXJlbnQoKS5kYXRhKCJmaWVsZCIpLAogICAgICAgICAgbiA9IGUucGFyZW50cygidHIiKS5lcSgwKS5kYXRhKCJpbmRleCIpLAogICAgICAgICAgbyA9IGQuY2FjaGVbaS5rZXldW25dOwogICAgICBvW2xdID0gYSwgbGF5dWkuZXZlbnQuY2FsbCh0aGlzLCBoLCAiZWRpdCgiICsgZiArICIpIiwgdi5jYWxsKHRoaXMsIHsKICAgICAgICB2YWx1ZTogYSwKICAgICAgICBmaWVsZDogbAogICAgICB9KSk7CiAgICB9KS5vbigiYmx1ciIsICIuIiArIFIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUsCiAgICAgICAgICBhID0gdCh0aGlzKSwKICAgICAgICAgIGwgPSB0aGlzLAogICAgICAgICAgbiA9IGEucGFyZW50KCkuZGF0YSgiZmllbGQiKSwKICAgICAgICAgIG8gPSBhLnBhcmVudHMoInRyIikuZXEoMCkuZGF0YSgiaW5kZXgiKSwKICAgICAgICAgIHIgPSBkLmNhY2hlW2kua2V5XVtvXTsKICAgICAgaS5lYWNoQ29scyhmdW5jdGlvbiAodCwgaSkgewogICAgICAgIGkuZmllbGQgPT0gbiAmJiBpLnRlbXBsZXQgJiYgKGUgPSBpLnRlbXBsZXQpOwogICAgICB9KSwgYS5zaWJsaW5ncyh1KS5odG1sKGZ1bmN0aW9uICh0KSB7CiAgICAgICAgcmV0dXJuIHkuY2FsbChpLCB7CiAgICAgICAgICB0ZW1wbGV0OiBlCiAgICAgICAgfSwgdCwgcik7CiAgICAgIH0obC52YWx1ZSkpLCBhLnBhcmVudCgpLmRhdGEoImNvbnRlbnQiLCBsLnZhbHVlKSwgYS5yZW1vdmUoKTsKICAgIH0pLCBpLmxheUJvZHkub24oImNsaWNrIiwgInRkIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIGkgPSB0KHRoaXMpLAogICAgICAgICAgYSA9IChpLmRhdGEoImZpZWxkIiksIGkuZGF0YSgiZWRpdCIpKSwKICAgICAgICAgIGwgPSBpLmNoaWxkcmVuKHUpOwoKICAgICAgaWYgKCFpLmRhdGEoIm9mZiIpICYmIGEpIHsKICAgICAgICB2YXIgbiA9IHQoJzxpbnB1dCBjbGFzcz0ibGF5dWktaW5wdXQgJyArIFIgKyAnIj4nKTsKICAgICAgICByZXR1cm4gblswXS52YWx1ZSA9IGkuZGF0YSgiY29udGVudCIpIHx8IGwudGV4dCgpLCBpLmZpbmQoIi4iICsgUilbMF0gfHwgaS5hcHBlbmQobiksIG4uZm9jdXMoKSwgdm9pZCBsYXl1aS5zdG9wZShlKTsKICAgICAgfQogICAgfSkub24oIm1vdXNlZW50ZXIiLCAidGQiLCBmdW5jdGlvbiAoKSB7CiAgICAgIGIuY2FsbCh0aGlzKTsKICAgIH0pLm9uKCJtb3VzZWxlYXZlIiwgInRkIiwgZnVuY3Rpb24gKCkgewogICAgICBiLmNhbGwodGhpcywgImhpZGUiKTsKICAgIH0pOwoKICAgIHZhciBnID0gImxheXVpLXRhYmxlLWdyaWQtZG93biIsCiAgICAgICAgYiA9IGZ1bmN0aW9uIGIoZSkgewogICAgICB2YXIgaSA9IHQodGhpcyksCiAgICAgICAgICBhID0gaS5jaGlsZHJlbih1KTsKICAgICAgaWYgKCFpLmRhdGEoIm9mZiIpKSBpZiAoZSkgaS5maW5kKCIubGF5dWktdGFibGUtZ3JpZC1kb3duIikucmVtb3ZlKCk7ZWxzZSBpZiAoYS5wcm9wKCJzY3JvbGxXaWR0aCIpID4gYS5vdXRlcldpZHRoKCkpIHsKICAgICAgICBpZiAoYS5maW5kKCIuIiArIGcpWzBdKSByZXR1cm47CiAgICAgICAgaS5hcHBlbmQoJzxkaXYgY2xhc3M9IicgKyBnICsgJyI+PGkgY2xhc3M9ImxheXVpLWljb24gbGF5dWktaWNvbi1kb3duIj48L2k+PC9kaXY+Jyk7CiAgICAgIH0KICAgIH07CgogICAgaS5sYXlCb2R5Lm9uKCJjbGljayIsICIuIiArIGcsIGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBuID0gdCh0aGlzKSwKICAgICAgICAgIG8gPSBuLnBhcmVudCgpLAogICAgICAgICAgciA9IG8uY2hpbGRyZW4odSk7CiAgICAgIGkudGlwc0luZGV4ID0gbC50aXBzKFsnPGRpdiBjbGFzcz0ibGF5dWktdGFibGUtdGlwcy1tYWluIiBzdHlsZT0ibWFyZ2luLXRvcDogLScgKyAoci5oZWlnaHQoKSArIDE2KSArICJweDsiICsgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAic20iID09PSBhLnNpemUgPyAicGFkZGluZzogNHB4IDE1cHg7IGZvbnQtc2l6ZTogMTJweDsiIDogImxnIiA9PT0gYS5zaXplID8gInBhZGRpbmc6IDE0cHggMTVweDsiIDogIiI7CiAgICAgIH0oKSArICciPicsIHIuaHRtbCgpLCAiPC9kaXY+IiwgJzxpIGNsYXNzPSJsYXl1aS1pY29uIGxheXVpLXRhYmxlLXRpcHMtYyBsYXl1aS1pY29uLWNsb3NlIj48L2k+J10uam9pbigiIiksIHJbMF0sIHsKICAgICAgICB0aXBzOiBbMywgIiJdLAogICAgICAgIHRpbWU6IC0xLAogICAgICAgIGFuaW06IC0xLAogICAgICAgIG1heFdpZHRoOiBjLmlvcyB8fCBjLmFuZHJvaWQgPyAzMDAgOiBpLmVsZW0ud2lkdGgoKSAvIDIsCiAgICAgICAgaXNPdXRBbmltOiAhMSwKICAgICAgICBza2luOiAibGF5dWktdGFibGUtdGlwcyIsCiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gc3VjY2VzcyhlLCB0KSB7CiAgICAgICAgICBlLmZpbmQoIi5sYXl1aS10YWJsZS10aXBzLWMiKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGwuY2xvc2UodCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pLCBsYXl1aS5zdG9wZShlKTsKICAgIH0pLCBpLmxheUJvZHkub24oImNsaWNrIiwgIipbbGF5LWV2ZW50XSIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSB0KHRoaXMpLAogICAgICAgICAgYSA9IGUucGFyZW50cygidHIiKS5lcSgwKS5kYXRhKCJpbmRleCIpOwogICAgICBsYXl1aS5ldmVudC5jYWxsKHRoaXMsIGgsICJ0b29sKCIgKyBmICsgIikiLCB2LmNhbGwodGhpcywgewogICAgICAgIGV2ZW50OiBlLmF0dHIoImxheS1ldmVudCIpCiAgICAgIH0pKSwgaS5zZXRUaGlzUm93Q2hlY2tlZChhKTsKICAgIH0pLCBpLmxheU1haW4ub24oInNjcm9sbCIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSB0KHRoaXMpLAogICAgICAgICAgYSA9IGUuc2Nyb2xsTGVmdCgpLAogICAgICAgICAgbiA9IGUuc2Nyb2xsVG9wKCk7CiAgICAgIGkubGF5SGVhZGVyLnNjcm9sbExlZnQoYSksIGkubGF5VG90YWwuc2Nyb2xsTGVmdChhKSwgaS5sYXlGaXhlZC5maW5kKEMpLnNjcm9sbFRvcChuKSwgbC5jbG9zZShpLnRpcHNJbmRleCk7CiAgICB9KSwgRi5vbigicmVzaXplIiwgZnVuY3Rpb24gKCkgewogICAgICBpLnJlc2l6ZSgpOwogICAgfSk7CiAgfSwgZnVuY3Rpb24gKCkgewogICAgSS5vbigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgIEkudHJpZ2dlcigidGFibGUucmVtb3ZlLnRvb2wucGFuZWwiKTsKICAgIH0pLCBJLm9uKCJ0YWJsZS5yZW1vdmUudG9vbC5wYW5lbCIsIGZ1bmN0aW9uICgpIHsKICAgICAgdCgiLmxheXVpLXRhYmxlLXRvb2wtcGFuZWwiKS5yZW1vdmUoKTsKICAgIH0pOwogIH0oKSwgZC5pbml0ID0gZnVuY3Rpb24gKGUsIGkpIHsKICAgIGkgPSBpIHx8IHt9OwogICAgdmFyIGEgPSB0aGlzLAogICAgICAgIGwgPSB0KGUgPyAndGFibGVbbGF5LWZpbHRlcj0iJyArIGUgKyAnIl0nIDogZiArICJbbGF5LWRhdGFdIiksCiAgICAgICAgbiA9ICJUYWJsZSBlbGVtZW50IHByb3BlcnR5IGxheS1kYXRhIGNvbmZpZ3VyYXRpb24gaXRlbSBoYXMgYSBzeW50YXggZXJyb3I6ICI7CiAgICByZXR1cm4gbC5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGEgPSB0KHRoaXMpLAogICAgICAgICAgbCA9IGEuYXR0cigibGF5LWRhdGEiKTsKCiAgICAgIHRyeSB7CiAgICAgICAgbCA9IG5ldyBGdW5jdGlvbigicmV0dXJuICIgKyBsKSgpOwogICAgICB9IGNhdGNoIChvKSB7CiAgICAgICAgci5lcnJvcihuICsgbCwgImVycm9yIik7CiAgICAgIH0KCiAgICAgIHZhciBjID0gW10sCiAgICAgICAgICBzID0gdC5leHRlbmQoewogICAgICAgIGVsZW06IHRoaXMsCiAgICAgICAgY29sczogW10sCiAgICAgICAgZGF0YTogW10sCiAgICAgICAgc2tpbjogYS5hdHRyKCJsYXktc2tpbiIpLAogICAgICAgIHNpemU6IGEuYXR0cigibGF5LXNpemUiKSwKICAgICAgICBldmVuOiAic3RyaW5nIiA9PSB0eXBlb2YgYS5hdHRyKCJsYXktZXZlbiIpCiAgICAgIH0sIGQuY29uZmlnLCBpLCBsKTsKICAgICAgZSAmJiBhLmhpZGUoKSwgYS5maW5kKCJ0aGVhZD50ciIpLmVhY2goZnVuY3Rpb24gKGUpIHsKICAgICAgICBzLmNvbHNbZV0gPSBbXSwgdCh0aGlzKS5jaGlsZHJlbigpLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgIHZhciBhID0gdCh0aGlzKSwKICAgICAgICAgICAgICBsID0gYS5hdHRyKCJsYXktZGF0YSIpOwoKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGwgPSBuZXcgRnVuY3Rpb24oInJldHVybiAiICsgbCkoKTsKICAgICAgICAgIH0gY2F0Y2ggKG8pIHsKICAgICAgICAgICAgcmV0dXJuIHIuZXJyb3IobiArIGwpOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBkID0gdC5leHRlbmQoewogICAgICAgICAgICB0aXRsZTogYS50ZXh0KCksCiAgICAgICAgICAgIGNvbHNwYW46IGEuYXR0cigiY29sc3BhbiIpIHx8IDAsCiAgICAgICAgICAgIHJvd3NwYW46IGEuYXR0cigicm93c3BhbiIpIHx8IDAKICAgICAgICAgIH0sIGwpOwogICAgICAgICAgZC5jb2xzcGFuIDwgMiAmJiBjLnB1c2goZCksIHMuY29sc1tlXS5wdXNoKGQpOwogICAgICAgIH0pOwogICAgICB9KSwgYS5maW5kKCJ0Ym9keT50ciIpLmVhY2goZnVuY3Rpb24gKGUpIHsKICAgICAgICB2YXIgaSA9IHQodGhpcyksCiAgICAgICAgICAgIGEgPSB7fTsKICAgICAgICBpLmNoaWxkcmVuKCJ0ZCIpLmVhY2goZnVuY3Rpb24gKGUsIGkpIHsKICAgICAgICAgIHZhciBsID0gdCh0aGlzKSwKICAgICAgICAgICAgICBuID0gbC5kYXRhKCJmaWVsZCIpOwogICAgICAgICAgaWYgKG4pIHJldHVybiBhW25dID0gbC5odG1sKCk7CiAgICAgICAgfSksIGxheXVpLmVhY2goYywgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgICAgIHZhciBsID0gaS5jaGlsZHJlbigidGQiKS5lcShlKTsKICAgICAgICAgIGFbdC5maWVsZF0gPSBsLmh0bWwoKTsKICAgICAgICB9KSwgcy5kYXRhW2VdID0gYTsKICAgICAgfSksIGQucmVuZGVyKHMpOwogICAgfSksIGE7CiAgfSwgcy50aGF0ID0ge30sIHMuY29uZmlnID0ge30sIGQuZWFjaENvbHMgPSBmdW5jdGlvbiAoZSwgaSwgYSkgewogICAgdmFyIGwgPSBzLmNvbmZpZ1tlXSB8fCB7fSwKICAgICAgICBuID0gW10sCiAgICAgICAgbyA9IDA7CiAgICBhID0gdC5leHRlbmQoITAsIFtdLCBhIHx8IGwuY29scyksIGxheXVpLmVhY2goYSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgbGF5dWkuZWFjaCh0LCBmdW5jdGlvbiAodCwgaSkgewogICAgICAgIGlmIChpLmNvbEdyb3VwKSB7CiAgICAgICAgICB2YXIgbCA9IDA7CiAgICAgICAgICBvKyssIGkuQ0hJTERfQ09MUyA9IFtdLCBsYXl1aS5lYWNoKGFbZSArIDFdLCBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICAgICB0LlBBUkVOVF9DT0xfSU5ERVggfHwgbCA+IDEgJiYgbCA9PSBpLmNvbHNwYW4gfHwgKHQuUEFSRU5UX0NPTF9JTkRFWCA9IG8sIGkuQ0hJTERfQ09MUy5wdXNoKHQpLCBsICs9IHBhcnNlSW50KHQuY29sc3BhbiA+IDEgPyB0LmNvbHNwYW4gOiAxKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGkuUEFSRU5UX0NPTF9JTkRFWCB8fCBuLnB1c2goaSk7CiAgICAgIH0pOwogICAgfSk7CgogICAgdmFyIHIgPSBmdW5jdGlvbiByKGUpIHsKICAgICAgbGF5dWkuZWFjaChlIHx8IG4sIGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgICAgcmV0dXJuIHQuQ0hJTERfQ09MUyA/IHIodC5DSElMRF9DT0xTKSA6IHZvaWQgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIGkgJiYgaShlLCB0KSk7CiAgICAgIH0pOwogICAgfTsKCiAgICByKCk7CiAgfSwgZC5jaGVja1N0YXR1cyA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IDAsCiAgICAgICAgaSA9IDAsCiAgICAgICAgYSA9IFtdLAogICAgICAgIGwgPSBkLmNhY2hlW2VdIHx8IFtdOwogICAgcmV0dXJuIGxheXVpLmVhY2gobCwgZnVuY3Rpb24gKGUsIGwpIHsKICAgICAgcmV0dXJuICJhcnJheSIgPT09IGxheXVpLl90eXBlb2YobCkgPyB2b2lkIGkrKyA6IHZvaWQgKGxbZC5jb25maWcuY2hlY2tOYW1lXSAmJiAodCsrLCBhLnB1c2goZC5jbGVhckNhY2hlS2V5KGwpKSkpOwogICAgfSksIHsKICAgICAgZGF0YTogYSwKICAgICAgaXNBbGw6ICEhbC5sZW5ndGggJiYgdCA9PT0gbC5sZW5ndGggLSBpCiAgICB9OwogIH0sIGQuZ2V0RGF0YSA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IFtdLAogICAgICAgIGkgPSBkLmNhY2hlW2VdIHx8IFtdOwogICAgcmV0dXJuIGxheXVpLmVhY2goaSwgZnVuY3Rpb24gKGUsIGkpIHsKICAgICAgImFycmF5IiAhPT0gbGF5dWkuX3R5cGVvZihpKSAmJiB0LnB1c2goZC5jbGVhckNhY2hlS2V5KGkpKTsKICAgIH0pLCB0OwogIH0sIGQuZXhwb3J0RmlsZSA9IGZ1bmN0aW9uIChlLCB0LCBpKSB7CiAgICB2YXIgYSA9IHRoaXM7CiAgICB0ID0gdCB8fCBkLmNsZWFyQ2FjaGVLZXkoZC5jYWNoZVtlXSksIGkgPSBpIHx8ICJjc3YiOwogICAgdmFyIGwgPSBzLnRoYXRbZV0sCiAgICAgICAgbiA9IHMuY29uZmlnW2VdIHx8IHt9LAogICAgICAgIG8gPSB7CiAgICAgIGNzdjogInRleHQvY3N2IiwKICAgICAgeGxzOiAiYXBwbGljYXRpb24vdm5kLm1zLWV4Y2VsIgogICAgfVtpXSwKICAgICAgICB1ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgcmV0dXJuIGMuaWUgPyByLmVycm9yKCJJRV9OT1RfU1VQUE9SVF9FWFBPUlRTIikgOiAodS5ocmVmID0gImRhdGE6IiArIG8gKyAiO2NoYXJzZXQ9dXRmLTgsXHVGRUZGIiArIGVuY29kZVVSSUNvbXBvbmVudChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBpID0gW10sCiAgICAgICAgICBuID0gW10sCiAgICAgICAgICBvID0gW107CiAgICAgIHJldHVybiBsYXl1aS5lYWNoKHQsIGZ1bmN0aW9uICh0LCBhKSB7CiAgICAgICAgdmFyIG8gPSBbXTsKICAgICAgICAib2JqZWN0IiA9PSBfdHlwZW9mKGUpID8gKGxheXVpLmVhY2goZSwgZnVuY3Rpb24gKGUsIGEpIHsKICAgICAgICAgIDAgPT0gdCAmJiBpLnB1c2goYSB8fCAiIik7CiAgICAgICAgfSksIGxheXVpLmVhY2goZC5jbGVhckNhY2hlS2V5KGEpLCBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICAgby5wdXNoKCciJyArICh0IHx8ICIiKSArICciJyk7CiAgICAgICAgfSkpIDogZC5lYWNoQ29scyhlLCBmdW5jdGlvbiAoZSwgbikgewogICAgICAgICAgaWYgKG4uZmllbGQgJiYgIm5vcm1hbCIgPT0gbi50eXBlICYmICFuLmhpZGUpIHsKICAgICAgICAgICAgdmFyIHIgPSBhW24uZmllbGRdOwogICAgICAgICAgICB2b2lkIDAgIT09IHIgJiYgbnVsbCAhPT0gciB8fCAociA9ICIiKSwgMCA9PSB0ICYmIGkucHVzaChuLnRpdGxlIHx8ICIiKSwgby5wdXNoKCciJyArIHkuY2FsbChsLCBuLCByLCBhLCAidGV4dCIpICsgJyInKTsKICAgICAgICAgIH0KICAgICAgICB9KSwgbi5wdXNoKG8uam9pbigiLCIpKTsKICAgICAgfSksIGxheXVpLmVhY2goYS5kYXRhVG90YWwsIGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgICAgby5wdXNoKHQpOwogICAgICB9KSwgaS5qb2luKCIsIikgKyAiXHJcbiIgKyBuLmpvaW4oIlxyXG4iKSArICJcclxuIiArIG8uam9pbigiLCIpOwogICAgfSgpKSwgdS5kb3dubG9hZCA9IChuLnRpdGxlIHx8ICJ0YWJsZV8iICsgKG4uaW5kZXggfHwgIiIpKSArICIuIiArIGksIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodSksIHUuY2xpY2soKSwgdm9pZCBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHUpKTsKICB9LCBkLnJlc2l6ZSA9IGZ1bmN0aW9uIChlKSB7CiAgICBpZiAoZSkgewogICAgICB2YXIgdCA9IHUoZSk7CiAgICAgIGlmICghdCkgcmV0dXJuOwogICAgICBzLnRoYXRbZV0ucmVzaXplKCk7CiAgICB9IGVsc2UgbGF5dWkuZWFjaChzLnRoYXQsIGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5yZXNpemUoKTsKICAgIH0pOwogIH0sIGQucmVsb2FkID0gZnVuY3Rpb24gKGUsIHQsIGkpIHsKICAgIHZhciBhID0gdShlKTsKCiAgICBpZiAoYSkgewogICAgICB2YXIgbCA9IHMudGhhdFtlXTsKICAgICAgcmV0dXJuIGwucmVsb2FkKHQsIGkpLCBzLmNhbGwobCk7CiAgICB9CiAgfSwgZC5yZW5kZXIgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSBuZXcgSChlKTsKICAgIHJldHVybiBzLmNhbGwodCk7CiAgfSwgZC5jbGVhckNhY2hlS2V5ID0gZnVuY3Rpb24gKGUpIHsKICAgIHJldHVybiBlID0gdC5leHRlbmQoe30sIGUpLCBkZWxldGUgZVtkLmNvbmZpZy5jaGVja05hbWVdLCBkZWxldGUgZVtkLmNvbmZpZy5pbmRleE5hbWVdLCBlOwogIH0sIHQoZnVuY3Rpb24gKCkgewogICAgZC5pbml0KCk7CiAgfSksIGUoaCwgZCk7Cn0pOwpsYXl1aS5kZWZpbmUoImpxdWVyeSIsIGZ1bmN0aW9uIChlKSB7CiAgInVzZSBzdHJpY3QiOwoKICB2YXIgaSA9IGxheXVpLiQsCiAgICAgIG4gPSAobGF5dWkuaGludCgpLCBsYXl1aS5kZXZpY2UoKSwgewogICAgY29uZmlnOiB7fSwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgdmFyIG4gPSB0aGlzOwogICAgICByZXR1cm4gbi5jb25maWcgPSBpLmV4dGVuZCh7fSwgbi5jb25maWcsIGUpLCBuOwogICAgfSwKICAgIG9uOiBmdW5jdGlvbiBvbihlLCBpKSB7CiAgICAgIHJldHVybiBsYXl1aS5vbmV2ZW50LmNhbGwodGhpcywgdCwgZSwgaSk7CiAgICB9CiAgfSksCiAgICAgIHQgPSAiY2Fyb3VzZWwiLAogICAgICBhID0gImxheXVpLXRoaXMiLAogICAgICBsID0gIj4qW2Nhcm91c2VsLWl0ZW1dPioiLAogICAgICBvID0gImxheXVpLWNhcm91c2VsLWxlZnQiLAogICAgICByID0gImxheXVpLWNhcm91c2VsLXJpZ2h0IiwKICAgICAgZCA9ICJsYXl1aS1jYXJvdXNlbC1wcmV2IiwKICAgICAgcyA9ICJsYXl1aS1jYXJvdXNlbC1uZXh0IiwKICAgICAgdSA9ICJsYXl1aS1jYXJvdXNlbC1hcnJvdyIsCiAgICAgIGMgPSAibGF5dWktY2Fyb3VzZWwtaW5kIiwKICAgICAgbSA9IGZ1bmN0aW9uIG0oZSkgewogICAgdmFyIHQgPSB0aGlzOwogICAgdC5jb25maWcgPSBpLmV4dGVuZCh7fSwgdC5jb25maWcsIG4uY29uZmlnLCBlKSwgdC5yZW5kZXIoKTsKICB9OwoKICBtLnByb3RvdHlwZS5jb25maWcgPSB7CiAgICB3aWR0aDogIjYwMHB4IiwKICAgIGhlaWdodDogIjI4MHB4IiwKICAgIGZ1bGw6ICExLAogICAgYXJyb3c6ICJob3ZlciIsCiAgICBpbmRpY2F0b3I6ICJpbnNpZGUiLAogICAgYXV0b3BsYXk6ICEwLAogICAgaW50ZXJ2YWw6IDNlMywKICAgIGFuaW06ICIiLAogICAgdHJpZ2dlcjogImNsaWNrIiwKICAgIGluZGV4OiAwCiAgfSwgbS5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIG4gPSBlLmNvbmZpZzsKICAgIG4uZWxlbSA9IGkobi5lbGVtKSwgbi5lbGVtWzBdICYmIChlLmVsZW1JdGVtID0gbi5lbGVtLmZpbmQobCksIG4uaW5kZXggPCAwICYmIChuLmluZGV4ID0gMCksIG4uaW5kZXggPj0gZS5lbGVtSXRlbS5sZW5ndGggJiYgKG4uaW5kZXggPSBlLmVsZW1JdGVtLmxlbmd0aCAtIDEpLCBuLmludGVydmFsIDwgODAwICYmIChuLmludGVydmFsID0gODAwKSwgbi5mdWxsID8gbi5lbGVtLmNzcyh7CiAgICAgIHBvc2l0aW9uOiAiZml4ZWQiLAogICAgICB3aWR0aDogIjEwMCUiLAogICAgICBoZWlnaHQ6ICIxMDAlIiwKICAgICAgekluZGV4OiA5OTk5CiAgICB9KSA6IG4uZWxlbS5jc3MoewogICAgICB3aWR0aDogbi53aWR0aCwKICAgICAgaGVpZ2h0OiBuLmhlaWdodAogICAgfSksIG4uZWxlbS5hdHRyKCJsYXktYW5pbSIsIG4uYW5pbSksIGUuZWxlbUl0ZW0uZXEobi5pbmRleCkuYWRkQ2xhc3MoYSksIGUuZWxlbUl0ZW0ubGVuZ3RoIDw9IDEgfHwgKGUuaW5kaWNhdG9yKCksIGUuYXJyb3coKSwgZS5hdXRvcGxheSgpLCBlLmV2ZW50cygpKSk7CiAgfSwgbS5wcm90b3R5cGUucmVsb2FkID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBuID0gdGhpczsKICAgIGNsZWFySW50ZXJ2YWwobi50aW1lciksIG4uY29uZmlnID0gaS5leHRlbmQoe30sIG4uY29uZmlnLCBlKSwgbi5yZW5kZXIoKTsKICB9LCBtLnByb3RvdHlwZS5wcmV2SW5kZXggPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgaSA9IGUuY29uZmlnLAogICAgICAgIG4gPSBpLmluZGV4IC0gMTsKICAgIHJldHVybiBuIDwgMCAmJiAobiA9IGUuZWxlbUl0ZW0ubGVuZ3RoIC0gMSksIG47CiAgfSwgbS5wcm90b3R5cGUubmV4dEluZGV4ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIGkgPSBlLmNvbmZpZywKICAgICAgICBuID0gaS5pbmRleCArIDE7CiAgICByZXR1cm4gbiA+PSBlLmVsZW1JdGVtLmxlbmd0aCAmJiAobiA9IDApLCBuOwogIH0sIG0ucHJvdG90eXBlLmFkZEluZGV4ID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBpID0gdGhpcywKICAgICAgICBuID0gaS5jb25maWc7CiAgICBlID0gZSB8fCAxLCBuLmluZGV4ID0gbi5pbmRleCArIGUsIG4uaW5kZXggPj0gaS5lbGVtSXRlbS5sZW5ndGggJiYgKG4uaW5kZXggPSAwKTsKICB9LCBtLnByb3RvdHlwZS5zdWJJbmRleCA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgaSA9IHRoaXMsCiAgICAgICAgbiA9IGkuY29uZmlnOwogICAgZSA9IGUgfHwgMSwgbi5pbmRleCA9IG4uaW5kZXggLSBlLCBuLmluZGV4IDwgMCAmJiAobi5pbmRleCA9IGkuZWxlbUl0ZW0ubGVuZ3RoIC0gMSk7CiAgfSwgbS5wcm90b3R5cGUuYXV0b3BsYXkgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgaSA9IGUuY29uZmlnOwogICAgaS5hdXRvcGxheSAmJiAoY2xlYXJJbnRlcnZhbChlLnRpbWVyKSwgZS50aW1lciA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgZS5zbGlkZSgpOwogICAgfSwgaS5pbnRlcnZhbCkpOwogIH0sIG0ucHJvdG90eXBlLmFycm93ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIG4gPSBlLmNvbmZpZywKICAgICAgICB0ID0gaShbJzxidXR0b24gY2xhc3M9ImxheXVpLWljb24gJyArIHUgKyAnIiBsYXktdHlwZT0ic3ViIj4nICsgKCJ1cGRvd24iID09PSBuLmFuaW0gPyAiJiN4ZTYxOTsiIDogIiYjeGU2MDM7IikgKyAiPC9idXR0b24+IiwgJzxidXR0b24gY2xhc3M9ImxheXVpLWljb24gJyArIHUgKyAnIiBsYXktdHlwZT0iYWRkIj4nICsgKCJ1cGRvd24iID09PSBuLmFuaW0gPyAiJiN4ZTYxYTsiIDogIiYjeGU2MDI7IikgKyAiPC9idXR0b24+Il0uam9pbigiIikpOwogICAgbi5lbGVtLmF0dHIoImxheS1hcnJvdyIsIG4uYXJyb3cpLCBuLmVsZW0uZmluZCgiLiIgKyB1KVswXSAmJiBuLmVsZW0uZmluZCgiLiIgKyB1KS5yZW1vdmUoKSwgbi5lbGVtLmFwcGVuZCh0KSwgdC5vbigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBuID0gaSh0aGlzKSwKICAgICAgICAgIHQgPSBuLmF0dHIoImxheS10eXBlIik7CiAgICAgIGUuc2xpZGUodCk7CiAgICB9KTsKICB9LCBtLnByb3RvdHlwZS5pbmRpY2F0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgbiA9IGUuY29uZmlnLAogICAgICAgIHQgPSBlLmVsZW1JbmQgPSBpKFsnPGRpdiBjbGFzcz0iJyArIGMgKyAnIj48dWw+JywgZnVuY3Rpb24gKCkgewogICAgICB2YXIgaSA9IFtdOwogICAgICByZXR1cm4gbGF5dWkuZWFjaChlLmVsZW1JdGVtLCBmdW5jdGlvbiAoZSkgewogICAgICAgIGkucHVzaCgiPGxpIiArIChuLmluZGV4ID09PSBlID8gJyBjbGFzcz0ibGF5dWktdGhpcyInIDogIiIpICsgIj48L2xpPiIpOwogICAgICB9KSwgaS5qb2luKCIiKTsKICAgIH0oKSwgIjwvdWw+PC9kaXY+Il0uam9pbigiIikpOwogICAgbi5lbGVtLmF0dHIoImxheS1pbmRpY2F0b3IiLCBuLmluZGljYXRvciksIG4uZWxlbS5maW5kKCIuIiArIGMpWzBdICYmIG4uZWxlbS5maW5kKCIuIiArIGMpLnJlbW92ZSgpLCBuLmVsZW0uYXBwZW5kKHQpLCAidXBkb3duIiA9PT0gbi5hbmltICYmIHQuY3NzKCJtYXJnaW4tdG9wIiwgLSh0LmhlaWdodCgpIC8gMikpLCB0LmZpbmQoImxpIikub24oImhvdmVyIiA9PT0gbi50cmlnZ2VyID8gIm1vdXNlb3ZlciIgOiBuLnRyaWdnZXIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHQgPSBpKHRoaXMpLAogICAgICAgICAgYSA9IHQuaW5kZXgoKTsKICAgICAgYSA+IG4uaW5kZXggPyBlLnNsaWRlKCJhZGQiLCBhIC0gbi5pbmRleCkgOiBhIDwgbi5pbmRleCAmJiBlLnNsaWRlKCJzdWIiLCBuLmluZGV4IC0gYSk7CiAgICB9KTsKICB9LCBtLnByb3RvdHlwZS5zbGlkZSA9IGZ1bmN0aW9uIChlLCBpKSB7CiAgICB2YXIgbiA9IHRoaXMsCiAgICAgICAgbCA9IG4uZWxlbUl0ZW0sCiAgICAgICAgdSA9IG4uY29uZmlnLAogICAgICAgIGMgPSB1LmluZGV4LAogICAgICAgIG0gPSB1LmVsZW0uYXR0cigibGF5LWZpbHRlciIpOwogICAgbi5oYXZlU2xpZGUgfHwgKCJzdWIiID09PSBlID8gKG4uc3ViSW5kZXgoaSksIGwuZXEodS5pbmRleCkuYWRkQ2xhc3MoZCksIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBsLmVxKGMpLmFkZENsYXNzKHIpLCBsLmVxKHUuaW5kZXgpLmFkZENsYXNzKHIpOwogICAgfSwgNTApKSA6IChuLmFkZEluZGV4KGkpLCBsLmVxKHUuaW5kZXgpLmFkZENsYXNzKHMpLCBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgbC5lcShjKS5hZGRDbGFzcyhvKSwgbC5lcSh1LmluZGV4KS5hZGRDbGFzcyhvKTsKICAgIH0sIDUwKSksIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBsLnJlbW92ZUNsYXNzKGEgKyAiICIgKyBkICsgIiAiICsgcyArICIgIiArIG8gKyAiICIgKyByKSwgbC5lcSh1LmluZGV4KS5hZGRDbGFzcyhhKSwgbi5oYXZlU2xpZGUgPSAhMTsKICAgIH0sIDMwMCksIG4uZWxlbUluZC5maW5kKCJsaSIpLmVxKHUuaW5kZXgpLmFkZENsYXNzKGEpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoYSksIG4uaGF2ZVNsaWRlID0gITAsIGxheXVpLmV2ZW50LmNhbGwodGhpcywgdCwgImNoYW5nZSgiICsgbSArICIpIiwgewogICAgICBpbmRleDogdS5pbmRleCwKICAgICAgcHJldkluZGV4OiBjLAogICAgICBpdGVtOiBsLmVxKHUuaW5kZXgpCiAgICB9KSk7CiAgfSwgbS5wcm90b3R5cGUuZXZlbnRzID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIGkgPSBlLmNvbmZpZzsKICAgIGkuZWxlbS5kYXRhKCJoYXZlRXZlbnRzIikgfHwgKGkuZWxlbS5vbigibW91c2VlbnRlciIsIGZ1bmN0aW9uICgpIHsKICAgICAgY2xlYXJJbnRlcnZhbChlLnRpbWVyKTsKICAgIH0pLm9uKCJtb3VzZWxlYXZlIiwgZnVuY3Rpb24gKCkgewogICAgICBlLmF1dG9wbGF5KCk7CiAgICB9KSwgaS5lbGVtLmRhdGEoImhhdmVFdmVudHMiLCAhMCkpOwogIH0sIG4ucmVuZGVyID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBpID0gbmV3IG0oZSk7CiAgICByZXR1cm4gaTsKICB9LCBlKHQsIG4pOwp9KTsKbGF5dWkuZGVmaW5lKCJqcXVlcnkiLCBmdW5jdGlvbiAoZSkgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIGEgPSBsYXl1aS5qcXVlcnksCiAgICAgIGwgPSB7CiAgICBjb25maWc6IHt9LAogICAgaW5kZXg6IGxheXVpLnJhdGUgPyBsYXl1aS5yYXRlLmluZGV4ICsgMWU0IDogMCwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgdmFyIGwgPSB0aGlzOwogICAgICByZXR1cm4gbC5jb25maWcgPSBhLmV4dGVuZCh7fSwgbC5jb25maWcsIGUpLCBsOwogICAgfSwKICAgIG9uOiBmdW5jdGlvbiBvbihlLCBhKSB7CiAgICAgIHJldHVybiBsYXl1aS5vbmV2ZW50LmNhbGwodGhpcywgbiwgZSwgYSk7CiAgICB9CiAgfSwKICAgICAgaSA9IGZ1bmN0aW9uIGkoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgYSA9IGUuY29uZmlnOwogICAgcmV0dXJuIHsKICAgICAgc2V0dmFsdWU6IGZ1bmN0aW9uIHNldHZhbHVlKGEpIHsKICAgICAgICBlLnNldHZhbHVlLmNhbGwoZSwgYSk7CiAgICAgIH0sCiAgICAgIGNvbmZpZzogYQogICAgfTsKICB9LAogICAgICBuID0gInJhdGUiLAogICAgICB0ID0gImxheXVpLXJhdGUiLAogICAgICBvID0gImxheXVpLWljb24tcmF0ZSIsCiAgICAgIHUgPSAibGF5dWktaWNvbi1yYXRlLXNvbGlkIiwKICAgICAgcyA9ICJsYXl1aS1pY29uLXJhdGUtaGFsZiIsCiAgICAgIHIgPSAibGF5dWktaWNvbi1yYXRlLXNvbGlkIGxheXVpLWljb24tcmF0ZS1oYWxmIiwKICAgICAgYyA9ICJsYXl1aS1pY29uLXJhdGUtc29saWQgbGF5dWktaWNvbi1yYXRlIiwKICAgICAgZiA9ICJsYXl1aS1pY29uLXJhdGUgbGF5dWktaWNvbi1yYXRlLWhhbGYiLAogICAgICB2ID0gZnVuY3Rpb24gdihlKSB7CiAgICB2YXIgaSA9IHRoaXM7CiAgICBpLmluZGV4ID0gKytsLmluZGV4LCBpLmNvbmZpZyA9IGEuZXh0ZW5kKHt9LCBpLmNvbmZpZywgbC5jb25maWcsIGUpLCBpLnJlbmRlcigpOwogIH07CgogIHYucHJvdG90eXBlLmNvbmZpZyA9IHsKICAgIGxlbmd0aDogNSwKICAgIHRleHQ6ICExLAogICAgcmVhZG9ubHk6ICExLAogICAgaGFsZjogITEsCiAgICB2YWx1ZTogMCwKICAgIHRoZW1lOiAiIgogIH0sIHYucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICBsID0gZS5jb25maWcsCiAgICAgICAgaSA9IGwudGhlbWUgPyAnc3R5bGU9ImNvbG9yOiAnICsgbC50aGVtZSArICc7IicgOiAiIjsKICAgIGwuZWxlbSA9IGEobC5lbGVtKSwgbC52YWx1ZSA+IGwubGVuZ3RoICYmIChsLnZhbHVlID0gbC5sZW5ndGgpLCBwYXJzZUludChsLnZhbHVlKSAhPT0gbC52YWx1ZSAmJiAobC5oYWxmIHx8IChsLnZhbHVlID0gTWF0aC5jZWlsKGwudmFsdWUpIC0gbC52YWx1ZSA8IC41ID8gTWF0aC5jZWlsKGwudmFsdWUpIDogTWF0aC5mbG9vcihsLnZhbHVlKSkpOwoKICAgIGZvciAodmFyIG4gPSAnPHVsIGNsYXNzPSJsYXl1aS1yYXRlIiAnICsgKGwucmVhZG9ubHkgPyAicmVhZG9ubHkiIDogIiIpICsgIj4iLCBzID0gMTsgcyA8PSBsLmxlbmd0aDsgcysrKSB7CiAgICAgIHZhciByID0gJzxsaSBjbGFzcz0ibGF5dWktaW5saW5lIj48aSBjbGFzcz0ibGF5dWktaWNvbiAnICsgKHMgPiBNYXRoLmZsb29yKGwudmFsdWUpID8gbyA6IHUpICsgJyIgJyArIGkgKyAiPjwvaT48L2xpPiI7CiAgICAgIGwuaGFsZiAmJiBwYXJzZUludChsLnZhbHVlKSAhPT0gbC52YWx1ZSAmJiBzID09IE1hdGguY2VpbChsLnZhbHVlKSA/IG4gPSBuICsgJzxsaT48aSBjbGFzcz0ibGF5dWktaWNvbiBsYXl1aS1pY29uLXJhdGUtaGFsZiIgJyArIGkgKyAiPjwvaT48L2xpPiIgOiBuICs9IHI7CiAgICB9CgogICAgbiArPSAiPC91bD4iICsgKGwudGV4dCA/ICc8c3BhbiBjbGFzcz0ibGF5dWktaW5saW5lIj4nICsgbC52YWx1ZSArICJcdTY2MUYiIDogIiIpICsgIjwvc3Bhbj4iOwogICAgdmFyIGMgPSBsLmVsZW0sCiAgICAgICAgZiA9IGMubmV4dCgiLiIgKyB0KTsKICAgIGZbMF0gJiYgZi5yZW1vdmUoKSwgZS5lbGVtVGVtcCA9IGEobiksIGwuc3BhbiA9IGUuZWxlbVRlbXAubmV4dCgic3BhbiIpLCBsLnNldFRleHQgJiYgbC5zZXRUZXh0KGwudmFsdWUpLCBjLmh0bWwoZS5lbGVtVGVtcCksIGMuYWRkQ2xhc3MoImxheXVpLWlubGluZSIpLCBsLnJlYWRvbmx5IHx8IGUuYWN0aW9uKCk7CiAgfSwgdi5wcm90b3R5cGUuc2V0dmFsdWUgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIGEgPSB0aGlzLAogICAgICAgIGwgPSBhLmNvbmZpZzsKICAgIGwudmFsdWUgPSBlLCBhLnJlbmRlcigpOwogIH0sIHYucHJvdG90eXBlLmFjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpcywKICAgICAgICBsID0gZS5jb25maWcsCiAgICAgICAgaSA9IGUuZWxlbVRlbXAsCiAgICAgICAgbiA9IGkuZmluZCgiaSIpLndpZHRoKCk7CiAgICBpLmNoaWxkcmVuKCJsaSIpLmVhY2goZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIHQgPSBlICsgMSwKICAgICAgICAgIHYgPSBhKHRoaXMpOwogICAgICB2Lm9uKCJjbGljayIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgaWYgKGwudmFsdWUgPSB0LCBsLmhhbGYpIHsKICAgICAgICAgIHZhciBvID0gZS5wYWdlWCAtIGEodGhpcykub2Zmc2V0KCkubGVmdDsKICAgICAgICAgIG8gPD0gbiAvIDIgJiYgKGwudmFsdWUgPSBsLnZhbHVlIC0gLjUpOwogICAgICAgIH0KCiAgICAgICAgbC50ZXh0ICYmIGkubmV4dCgic3BhbiIpLnRleHQobC52YWx1ZSArICJcdTY2MUYiKSwgbC5jaG9vc2UgJiYgbC5jaG9vc2UobC52YWx1ZSksIGwuc2V0VGV4dCAmJiBsLnNldFRleHQobC52YWx1ZSk7CiAgICAgIH0pLCB2Lm9uKCJtb3VzZW1vdmUiLCBmdW5jdGlvbiAoZSkgewogICAgICAgIGlmIChpLmZpbmQoImkiKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGEodGhpcykuYWRkQ2xhc3MobykucmVtb3ZlQ2xhc3Mocik7CiAgICAgICAgfSksIGkuZmluZCgiaTpsdCgiICsgdCArICIpIikuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBhKHRoaXMpLmFkZENsYXNzKHUpLnJlbW92ZUNsYXNzKGYpOwogICAgICAgIH0pLCBsLmhhbGYpIHsKICAgICAgICAgIHZhciBjID0gZS5wYWdlWCAtIGEodGhpcykub2Zmc2V0KCkubGVmdDsKICAgICAgICAgIGMgPD0gbiAvIDIgJiYgdi5jaGlsZHJlbigiaSIpLmFkZENsYXNzKHMpLnJlbW92ZUNsYXNzKHUpOwogICAgICAgIH0KICAgICAgfSksIHYub24oIm1vdXNlbGVhdmUiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgaS5maW5kKCJpIikuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBhKHRoaXMpLmFkZENsYXNzKG8pLnJlbW92ZUNsYXNzKHIpOwogICAgICAgIH0pLCBpLmZpbmQoImk6bHQoIiArIE1hdGguZmxvb3IobC52YWx1ZSkgKyAiKSIpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgYSh0aGlzKS5hZGRDbGFzcyh1KS5yZW1vdmVDbGFzcyhmKTsKICAgICAgICB9KSwgbC5oYWxmICYmIHBhcnNlSW50KGwudmFsdWUpICE9PSBsLnZhbHVlICYmIGkuY2hpbGRyZW4oImxpOmVxKCIgKyBNYXRoLmZsb29yKGwudmFsdWUpICsgIikiKS5jaGlsZHJlbigiaSIpLmFkZENsYXNzKHMpLnJlbW92ZUNsYXNzKGMpOwogICAgICB9KTsKICAgIH0pOwogIH0sIHYucHJvdG90eXBlLmV2ZW50cyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gdGhpczsKICAgIGUuY29uZmlnOwogIH0sIGwucmVuZGVyID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBhID0gbmV3IHYoZSk7CiAgICByZXR1cm4gaS5jYWxsKGEpOwogIH0sIGUobiwgbCk7Cn0pOwpsYXl1aS5kZWZpbmUoImpxdWVyeSIsIGZ1bmN0aW9uIChlKSB7CiAgInVzZSBzdHJpY3QiOwoKICB2YXIgbCA9IGxheXVpLiQsCiAgICAgIG8gPSBmdW5jdGlvbiBvKGUpIHt9LAogICAgICB0ID0gJzxpIGNsYXNzPSJsYXl1aS1hbmltIGxheXVpLWFuaW0tcm90YXRlIGxheXVpLWFuaW0tbG9vcCBsYXl1aS1pY29uICI+JiN4ZTYzZTs8L2k+JzsKCiAgby5wcm90b3R5cGUubG9hZCA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgbywKICAgICAgICBpLAogICAgICAgIG4sCiAgICAgICAgciwKICAgICAgICBhID0gdGhpcywKICAgICAgICBjID0gMDsKICAgIGUgPSBlIHx8IHt9OwogICAgdmFyIG0gPSBsKGUuZWxlbSk7CgogICAgaWYgKG1bMF0pIHsKICAgICAgdmFyIGYgPSBsKGUuc2Nyb2xsRWxlbSB8fCBkb2N1bWVudCksCiAgICAgICAgICB1ID0gZS5tYiB8fCA1MCwKICAgICAgICAgIHMgPSAhKCJpc0F1dG8iIGluIGUpIHx8IGUuaXNBdXRvLAogICAgICAgICAgeSA9IGUuZW5kIHx8ICJcdTZDQTFcdTY3MDlcdTY2RjRcdTU5MUFcdTRFODYiLAogICAgICAgICAgdiA9IGUuc2Nyb2xsRWxlbSAmJiBlLnNjcm9sbEVsZW0gIT09IGRvY3VtZW50LAogICAgICAgICAgZCA9ICI8Y2l0ZT5cdTUyQTBcdThGN0RcdTY2RjRcdTU5MUE8L2NpdGU+IiwKICAgICAgICAgIGggPSBsKCc8ZGl2IGNsYXNzPSJsYXl1aS1mbG93LW1vcmUiPjxhIGhyZWY9ImphdmFzY3JpcHQ6OyI+JyArIGQgKyAiPC9hPjwvZGl2PiIpOwogICAgICBtLmZpbmQoIi5sYXl1aS1mbG93LW1vcmUiKVswXSB8fCBtLmFwcGVuZChoKTsKCiAgICAgIHZhciBwID0gZnVuY3Rpb24gcChlLCB0KSB7CiAgICAgICAgZSA9IGwoZSksIGguYmVmb3JlKGUpLCB0ID0gMCA9PSB0IHx8IG51bGwsIHQgPyBoLmh0bWwoeSkgOiBoLmZpbmQoImEiKS5odG1sKGQpLCBpID0gdCwgbyA9IG51bGwsIG4gJiYgbigpOwogICAgICB9LAogICAgICAgICAgZyA9IGZ1bmN0aW9uIGcoKSB7CiAgICAgICAgbyA9ICEwLCBoLmZpbmQoImEiKS5odG1sKHQpLCAiZnVuY3Rpb24iID09IHR5cGVvZiBlLmRvbmUgJiYgZS5kb25lKCsrYywgcCk7CiAgICAgIH07CgogICAgICBpZiAoZygpLCBoLmZpbmQoImEiKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgbCh0aGlzKTsKICAgICAgICBpIHx8IG8gfHwgZygpOwogICAgICB9KSwgZS5pc0xhenlpbWcpIHZhciBuID0gYS5sYXp5aW1nKHsKICAgICAgICBlbGVtOiBlLmVsZW0gKyAiIGltZyIsCiAgICAgICAgc2Nyb2xsRWxlbTogZS5zY3JvbGxFbGVtCiAgICAgIH0pOwogICAgICByZXR1cm4gcyA/IChmLm9uKCJzY3JvbGwiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGUgPSBsKHRoaXMpLAogICAgICAgICAgICB0ID0gZS5zY3JvbGxUb3AoKTsKICAgICAgICByICYmIGNsZWFyVGltZW91dChyKSwgIWkgJiYgbS53aWR0aCgpICYmIChyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgaSA9IHYgPyBlLmhlaWdodCgpIDogbCh3aW5kb3cpLmhlaWdodCgpLAogICAgICAgICAgICAgIG4gPSB2ID8gZS5wcm9wKCJzY3JvbGxIZWlnaHQiKSA6IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQ7CiAgICAgICAgICBuIC0gdCAtIGkgPD0gdSAmJiAobyB8fCBnKCkpOwogICAgICAgIH0sIDEwMCkpOwogICAgICB9KSwgYSkgOiBhOwogICAgfQogIH0sIG8ucHJvdG90eXBlLmxhenlpbWcgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIG8sCiAgICAgICAgdCA9IHRoaXMsCiAgICAgICAgaSA9IDA7CiAgICBlID0gZSB8fCB7fTsKCiAgICB2YXIgbiA9IGwoZS5zY3JvbGxFbGVtIHx8IGRvY3VtZW50KSwKICAgICAgICByID0gZS5lbGVtIHx8ICJpbWciLAogICAgICAgIGEgPSBlLnNjcm9sbEVsZW0gJiYgZS5zY3JvbGxFbGVtICE9PSBkb2N1bWVudCwKICAgICAgICBjID0gZnVuY3Rpb24gYyhlLCBsKSB7CiAgICAgIHZhciBvID0gbi5zY3JvbGxUb3AoKSwKICAgICAgICAgIHIgPSBvICsgbCwKICAgICAgICAgIGMgPSBhID8gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBlLm9mZnNldCgpLnRvcCAtIG4ub2Zmc2V0KCkudG9wICsgbzsKICAgICAgfSgpIDogZS5vZmZzZXQoKS50b3A7CgogICAgICBpZiAoYyA+PSBvICYmIGMgPD0gciAmJiBlLmF0dHIoImxheS1zcmMiKSkgewogICAgICAgIHZhciBmID0gZS5hdHRyKCJsYXktc3JjIik7CiAgICAgICAgbGF5dWkuaW1nKGYsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBsID0gdC5sYXp5aW1nLmVsZW0uZXEoaSk7CiAgICAgICAgICBlLmF0dHIoInNyYyIsIGYpLnJlbW92ZUF0dHIoImxheS1zcmMiKSwgbFswXSAmJiBtKGwpLCBpKys7CiAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgdC5sYXp5aW1nLmVsZW0uZXEoaSk7CiAgICAgICAgICBlLnJlbW92ZUF0dHIoImxheS1zcmMiKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgICAgICBtID0gZnVuY3Rpb24gbShlLCBvKSB7CiAgICAgIHZhciBtID0gYSA/IChvIHx8IG4pLmhlaWdodCgpIDogbCh3aW5kb3cpLmhlaWdodCgpLAogICAgICAgICAgZiA9IG4uc2Nyb2xsVG9wKCksCiAgICAgICAgICB1ID0gZiArIG07CiAgICAgIGlmICh0LmxhenlpbWcuZWxlbSA9IGwociksIGUpIGMoZSwgbSk7ZWxzZSBmb3IgKHZhciBzID0gMDsgcyA8IHQubGF6eWltZy5lbGVtLmxlbmd0aDsgcysrKSB7CiAgICAgICAgdmFyIHkgPSB0LmxhenlpbWcuZWxlbS5lcShzKSwKICAgICAgICAgICAgdiA9IGEgPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4geS5vZmZzZXQoKS50b3AgLSBuLm9mZnNldCgpLnRvcCArIGY7CiAgICAgICAgfSgpIDogeS5vZmZzZXQoKS50b3A7CiAgICAgICAgaWYgKGMoeSwgbSksIGkgPSBzLCB2ID4gdSkgYnJlYWs7CiAgICAgIH0KICAgIH07CgogICAgaWYgKG0oKSwgIW8pIHsKICAgICAgdmFyIGY7CiAgICAgIG4ub24oInNjcm9sbCIsIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZSA9IGwodGhpcyk7CiAgICAgICAgZiAmJiBjbGVhclRpbWVvdXQoZiksIGYgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgIG0obnVsbCwgZSk7CiAgICAgICAgfSwgNTApOwogICAgICB9KSwgbyA9ICEwOwogICAgfQoKICAgIHJldHVybiBtOwogIH0sIGUoImZsb3ciLCBuZXcgbygpKTsKfSk7CmxheXVpLmRlZmluZShbImxheWVyIiwgImZvcm0iXSwgZnVuY3Rpb24gKHQpIHsKICAidXNlIHN0cmljdCI7CgogIHZhciBlID0gbGF5dWkuJCwKICAgICAgaSA9IGxheXVpLmxheWVyLAogICAgICBhID0gbGF5dWkuZm9ybSwKICAgICAgbCA9IChsYXl1aS5oaW50KCksIGxheXVpLmRldmljZSgpKSwKICAgICAgbiA9ICJsYXllZGl0IiwKICAgICAgbyA9ICJsYXl1aS1zaG93IiwKICAgICAgciA9ICJsYXl1aS1kaXNhYmxlZCIsCiAgICAgIGMgPSBmdW5jdGlvbiBjKCkgewogICAgdmFyIHQgPSB0aGlzOwogICAgdC5pbmRleCA9IDAsIHQuY29uZmlnID0gewogICAgICB0b29sOiBbInN0cm9uZyIsICJpdGFsaWMiLCAidW5kZXJsaW5lIiwgImRlbCIsICJ8IiwgImxlZnQiLCAiY2VudGVyIiwgInJpZ2h0IiwgInwiLCAibGluayIsICJ1bmxpbmsiLCAiZmFjZSIsICJpbWFnZSJdLAogICAgICBoaWRlVG9vbDogW10sCiAgICAgIGhlaWdodDogMjgwCiAgICB9OwogIH07CgogIGMucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uICh0KSB7CiAgICB2YXIgaSA9IHRoaXM7CiAgICByZXR1cm4gZS5leHRlbmQoITAsIGkuY29uZmlnLCB0KSwgaTsKICB9LCBjLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uICh0LCBlKSB7CiAgICByZXR1cm4gbGF5dWkub25ldmVudChuLCB0LCBlKTsKICB9LCBjLnByb3RvdHlwZS5idWlsZCA9IGZ1bmN0aW9uICh0LCBpKSB7CiAgICBpID0gaSB8fCB7fTsKCiAgICB2YXIgYSA9IHRoaXMsCiAgICAgICAgbiA9IGEuY29uZmlnLAogICAgICAgIHIgPSAibGF5dWktbGF5ZWRpdCIsCiAgICAgICAgYyA9IGUoInN0cmluZyIgPT0gdHlwZW9mIHQgPyAiIyIgKyB0IDogdCksCiAgICAgICAgdSA9ICJMQVlfbGF5ZWRpdF8iICsgKythLmluZGV4LAogICAgICAgIGQgPSBjLm5leHQoIi4iICsgciksCiAgICAgICAgeSA9IGUuZXh0ZW5kKHt9LCBuLCBpKSwKICAgICAgICBmID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgdCA9IFtdLAogICAgICAgICAgZSA9IHt9OwogICAgICByZXR1cm4gbGF5dWkuZWFjaCh5LmhpZGVUb29sLCBmdW5jdGlvbiAodCwgaSkgewogICAgICAgIGVbaV0gPSAhMDsKICAgICAgfSksIGxheXVpLmVhY2goeS50b29sLCBmdW5jdGlvbiAoaSwgYSkgewogICAgICAgIENbYV0gJiYgIWVbYV0gJiYgdC5wdXNoKENbYV0pOwogICAgICB9KSwgdC5qb2luKCIiKTsKICAgIH0oKSwKICAgICAgICBtID0gZShbJzxkaXYgY2xhc3M9IicgKyByICsgJyI+JywgJzxkaXYgY2xhc3M9ImxheXVpLXVuc2VsZWN0IGxheXVpLWxheWVkaXQtdG9vbCI+JyArIGYgKyAiPC9kaXY+IiwgJzxkaXYgY2xhc3M9ImxheXVpLWxheWVkaXQtaWZyYW1lIj4nLCAnPGlmcmFtZSBpZD0iJyArIHUgKyAnIiBuYW1lPSInICsgdSArICciIHRleHRhcmVhPSInICsgdCArICciIGZyYW1lYm9yZGVyPSIwIj48L2lmcmFtZT4nLCAiPC9kaXY+IiwgIjwvZGl2PiJdLmpvaW4oIiIpKTsKCiAgICByZXR1cm4gbC5pZSAmJiBsLmllIDwgOCA/IGMucmVtb3ZlQ2xhc3MoImxheXVpLWhpZGUiKS5hZGRDbGFzcyhvKSA6IChkWzBdICYmIGQucmVtb3ZlKCksIHMuY2FsbChhLCBtLCBjWzBdLCB5KSwgYy5hZGRDbGFzcygibGF5dWktaGlkZSIpLmFmdGVyKG0pLCBhLmluZGV4KTsKICB9LCBjLnByb3RvdHlwZS5nZXRDb250ZW50ID0gZnVuY3Rpb24gKHQpIHsKICAgIHZhciBlID0gdSh0KTsKICAgIGlmIChlWzBdKSByZXR1cm4gZChlWzBdLmRvY3VtZW50LmJvZHkuaW5uZXJIVE1MKTsKICB9LCBjLnByb3RvdHlwZS5nZXRUZXh0ID0gZnVuY3Rpb24gKHQpIHsKICAgIHZhciBpID0gdSh0KTsKICAgIGlmIChpWzBdKSByZXR1cm4gZShpWzBdLmRvY3VtZW50LmJvZHkpLnRleHQoKTsKICB9LCBjLnByb3RvdHlwZS5zZXRDb250ZW50ID0gZnVuY3Rpb24gKHQsIGksIGEpIHsKICAgIHZhciBsID0gdSh0KTsKICAgIGxbMF0gJiYgKGEgPyBlKGxbMF0uZG9jdW1lbnQuYm9keSkuYXBwZW5kKGkpIDogZShsWzBdLmRvY3VtZW50LmJvZHkpLmh0bWwoaSksIGxheWVkaXQuc3luYyh0KSk7CiAgfSwgYy5wcm90b3R5cGUuc3luYyA9IGZ1bmN0aW9uICh0KSB7CiAgICB2YXIgaSA9IHUodCk7CgogICAgaWYgKGlbMF0pIHsKICAgICAgdmFyIGEgPSBlKCIjIiArIGlbMV0uYXR0cigidGV4dGFyZWEiKSk7CiAgICAgIGEudmFsKGQoaVswXS5kb2N1bWVudC5ib2R5LmlubmVySFRNTCkpOwogICAgfQogIH0sIGMucHJvdG90eXBlLmdldFNlbGVjdGlvbiA9IGZ1bmN0aW9uICh0KSB7CiAgICB2YXIgZSA9IHUodCk7CgogICAgaWYgKGVbMF0pIHsKICAgICAgdmFyIGkgPSBtKGVbMF0uZG9jdW1lbnQpOwogICAgICByZXR1cm4gZG9jdW1lbnQuc2VsZWN0aW9uID8gaS50ZXh0IDogaS50b1N0cmluZygpOwogICAgfQogIH07CgogIHZhciBzID0gZnVuY3Rpb24gcyh0LCBpLCBhKSB7CiAgICB2YXIgbCA9IHRoaXMsCiAgICAgICAgbiA9IHQuZmluZCgiaWZyYW1lIik7CiAgICBuLmNzcyh7CiAgICAgIGhlaWdodDogYS5oZWlnaHQKICAgIH0pLm9uKCJsb2FkIiwgZnVuY3Rpb24gKCkgewogICAgICB2YXIgbyA9IG4uY29udGVudHMoKSwKICAgICAgICAgIHIgPSBuLnByb3AoImNvbnRlbnRXaW5kb3ciKSwKICAgICAgICAgIGMgPSBvLmZpbmQoImhlYWQiKSwKICAgICAgICAgIHMgPSBlKFsiPHN0eWxlPiIsICIqe21hcmdpbjogMDsgcGFkZGluZzogMDt9IiwgImJvZHl7cGFkZGluZzogMTBweDsgbGluZS1oZWlnaHQ6IDIwcHg7IG92ZXJmbG93LXg6IGhpZGRlbjsgd29yZC13cmFwOiBicmVhay13b3JkOyBmb250OiAxNHB4IEhlbHZldGljYSBOZXVlLEhlbHZldGljYSxQaW5nRmFuZyBTQyxNaWNyb3NvZnQgWWFIZWksVGFob21hLEFyaWFsLHNhbnMtc2VyaWY7IC13ZWJraXQtYm94LXNpemluZzogYm9yZGVyLWJveCAhaW1wb3J0YW50OyAtbW96LWJveC1zaXppbmc6IGJvcmRlci1ib3ggIWltcG9ydGFudDsgYm94LXNpemluZzogYm9yZGVyLWJveCAhaW1wb3J0YW50O30iLCAiYXtjb2xvcjojMDFBQUVEOyB0ZXh0LWRlY29yYXRpb246bm9uZTt9YTpob3Zlcntjb2xvcjojYzAwfSIsICJwe21hcmdpbi1ib3R0b206IDEwcHg7fSIsICJpbWd7ZGlzcGxheTogaW5saW5lLWJsb2NrOyBib3JkZXI6IG5vbmU7IHZlcnRpY2FsLWFsaWduOiBtaWRkbGU7fSIsICJwcmV7bWFyZ2luOiAxMHB4IDA7IHBhZGRpbmc6IDEwcHg7IGxpbmUtaGVpZ2h0OiAyMHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItbGVmdC13aWR0aDogNnB4OyBiYWNrZ3JvdW5kLWNvbG9yOiAjRjJGMkYyOyBjb2xvcjogIzMzMzsgZm9udC1mYW1pbHk6IENvdXJpZXIgTmV3OyBmb250LXNpemU6IDEycHg7fSIsICI8L3N0eWxlPiJdLmpvaW4oIiIpKSwKICAgICAgICAgIHUgPSBvLmZpbmQoImJvZHkiKTsKICAgICAgYy5hcHBlbmQocyksIHUuYXR0cigiY29udGVudGVkaXRhYmxlIiwgInRydWUiKS5jc3MoewogICAgICAgICJtaW4taGVpZ2h0IjogYS5oZWlnaHQKICAgICAgfSkuaHRtbChpLnZhbHVlIHx8ICIiKSwgeS5hcHBseShsLCBbciwgbiwgaSwgYV0pLCBnLmNhbGwobCwgciwgdCwgYSk7CiAgICB9KTsKICB9LAogICAgICB1ID0gZnVuY3Rpb24gdSh0KSB7CiAgICB2YXIgaSA9IGUoIiNMQVlfbGF5ZWRpdF8iICsgdCksCiAgICAgICAgYSA9IGkucHJvcCgiY29udGVudFdpbmRvdyIpOwogICAgcmV0dXJuIFthLCBpXTsKICB9LAogICAgICBkID0gZnVuY3Rpb24gZCh0KSB7CiAgICByZXR1cm4gOCA9PSBsLmllICYmICh0ID0gdC5yZXBsYWNlKC88Lis+L2csIGZ1bmN0aW9uICh0KSB7CiAgICAgIHJldHVybiB0LnRvTG93ZXJDYXNlKCk7CiAgICB9KSksIHQ7CiAgfSwKICAgICAgeSA9IGZ1bmN0aW9uIHkodCwgYSwgbiwgbykgewogICAgdmFyIHIgPSB0LmRvY3VtZW50LAogICAgICAgIGMgPSBlKHIuYm9keSk7CiAgICBjLm9uKCJrZXlkb3duIiwgZnVuY3Rpb24gKHQpIHsKICAgICAgdmFyIGUgPSB0LmtleUNvZGU7CgogICAgICBpZiAoMTMgPT09IGUpIHsKICAgICAgICB2YXIgYSA9IG0ociksCiAgICAgICAgICAgIGwgPSBwKGEpLAogICAgICAgICAgICBuID0gbC5wYXJlbnROb2RlOwoKICAgICAgICBpZiAoInByZSIgPT09IG4udGFnTmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICBpZiAodC5zaGlmdEtleSkgcmV0dXJuOwogICAgICAgICAgcmV0dXJuIGkubXNnKCJcdThCRjdcdTY2ODJcdTY1RjZcdTc1MjhzaGlmdCtlbnRlciIpLCAhMTsKICAgICAgICB9CgogICAgICAgIHIuZXhlY0NvbW1hbmQoImZvcm1hdEJsb2NrIiwgITEsICI8cD4iKTsKICAgICAgfQogICAgfSksIGUobikucGFyZW50cygiZm9ybSIpLm9uKCJzdWJtaXQiLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB0ID0gYy5odG1sKCk7CiAgICAgIDggPT0gbC5pZSAmJiAodCA9IHQucmVwbGFjZSgvPC4rPi9nLCBmdW5jdGlvbiAodCkgewogICAgICAgIHJldHVybiB0LnRvTG93ZXJDYXNlKCk7CiAgICAgIH0pKSwgbi52YWx1ZSA9IHQ7CiAgICB9KSwgYy5vbigicGFzdGUiLCBmdW5jdGlvbiAoZSkgewogICAgICByLmV4ZWNDb21tYW5kKCJmb3JtYXRCbG9jayIsICExLCAiPHA+IiksIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIGYuY2FsbCh0LCBjKSwgbi52YWx1ZSA9IGMuaHRtbCgpOwogICAgICB9LCAxMDApOwogICAgfSk7CiAgfSwKICAgICAgZiA9IGZ1bmN0aW9uIGYodCkgewogICAgdmFyIGkgPSB0aGlzOwogICAgaS5kb2N1bWVudDsKICAgIHQuZmluZCgiKltzdHlsZV0iKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHQgPSB0aGlzLnN0eWxlLnRleHRBbGlnbjsKICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGUoInN0eWxlIiksIGUodGhpcykuY3NzKHsKICAgICAgICAidGV4dC1hbGlnbiI6IHQgfHwgIiIKICAgICAgfSk7CiAgICB9KSwgdC5maW5kKCJ0YWJsZSIpLmFkZENsYXNzKCJsYXl1aS10YWJsZSIpLCB0LmZpbmQoInNjcmlwdCxsaW5rIikucmVtb3ZlKCk7CiAgfSwKICAgICAgbSA9IGZ1bmN0aW9uIG0odCkgewogICAgcmV0dXJuIHQuc2VsZWN0aW9uID8gdC5zZWxlY3Rpb24uY3JlYXRlUmFuZ2UoKSA6IHQuZ2V0U2VsZWN0aW9uKCkuZ2V0UmFuZ2VBdCgwKTsKICB9LAogICAgICBwID0gZnVuY3Rpb24gcCh0KSB7CiAgICByZXR1cm4gdC5lbmRDb250YWluZXIgfHwgdC5wYXJlbnRFbGVtZW50KCkuY2hpbGROb2Rlc1swXTsKICB9LAogICAgICB2ID0gZnVuY3Rpb24gdih0LCBpLCBhKSB7CiAgICB2YXIgbCA9IHRoaXMuZG9jdW1lbnQsCiAgICAgICAgbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodCk7CgogICAgZm9yICh2YXIgbyBpbiBpKSB7CiAgICAgIG4uc2V0QXR0cmlidXRlKG8sIGlbb10pOwogICAgfQoKICAgIGlmIChuLnJlbW92ZUF0dHJpYnV0ZSgidGV4dCIpLCBsLnNlbGVjdGlvbikgewogICAgICB2YXIgciA9IGEudGV4dCB8fCBpLnRleHQ7CiAgICAgIGlmICgiYSIgPT09IHQgJiYgIXIpIHJldHVybjsKICAgICAgciAmJiAobi5pbm5lckhUTUwgPSByKSwgYS5wYXN0ZUhUTUwoZShuKS5wcm9wKCJvdXRlckhUTUwiKSksIGEuc2VsZWN0KCk7CiAgICB9IGVsc2UgewogICAgICB2YXIgciA9IGEudG9TdHJpbmcoKSB8fCBpLnRleHQ7CiAgICAgIGlmICgiYSIgPT09IHQgJiYgIXIpIHJldHVybjsKICAgICAgciAmJiAobi5pbm5lckhUTUwgPSByKSwgYS5kZWxldGVDb250ZW50cygpLCBhLmluc2VydE5vZGUobik7CiAgICB9CiAgfSwKICAgICAgaCA9IGZ1bmN0aW9uIGgodCwgaSkgewogICAgdmFyIGEgPSB0aGlzLmRvY3VtZW50LAogICAgICAgIGwgPSAibGF5ZWRpdC10b29sLWFjdGl2ZSIsCiAgICAgICAgbiA9IHAobShhKSksCiAgICAgICAgbyA9IGZ1bmN0aW9uIG8oZSkgewogICAgICByZXR1cm4gdC5maW5kKCIubGF5ZWRpdC10b29sLSIgKyBlKTsKICAgIH07CgogICAgaSAmJiBpW2kuaGFzQ2xhc3MobCkgPyAicmVtb3ZlQ2xhc3MiIDogImFkZENsYXNzIl0obCksIHQuZmluZCgiPmkiKS5yZW1vdmVDbGFzcyhsKSwgbygidW5saW5rIikuYWRkQ2xhc3MociksIGUobikucGFyZW50cygpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICB2YXIgdCA9IHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgZSA9IHRoaXMuc3R5bGUudGV4dEFsaWduOwogICAgICAiYiIgIT09IHQgJiYgInN0cm9uZyIgIT09IHQgfHwgbygiYiIpLmFkZENsYXNzKGwpLCAiaSIgIT09IHQgJiYgImVtIiAhPT0gdCB8fCBvKCJpIikuYWRkQ2xhc3MobCksICJ1IiA9PT0gdCAmJiBvKCJ1IikuYWRkQ2xhc3MobCksICJzdHJpa2UiID09PSB0ICYmIG8oImQiKS5hZGRDbGFzcyhsKSwgInAiID09PSB0ICYmICgiY2VudGVyIiA9PT0gZSA/IG8oImNlbnRlciIpLmFkZENsYXNzKGwpIDogInJpZ2h0IiA9PT0gZSA/IG8oInJpZ2h0IikuYWRkQ2xhc3MobCkgOiBvKCJsZWZ0IikuYWRkQ2xhc3MobCkpLCAiYSIgPT09IHQgJiYgKG8oImxpbmsiKS5hZGRDbGFzcyhsKSwgbygidW5saW5rIikucmVtb3ZlQ2xhc3MocikpOwogICAgfSk7CiAgfSwKICAgICAgZyA9IGZ1bmN0aW9uIGcodCwgYSwgbCkgewogICAgdmFyIG4gPSB0LmRvY3VtZW50LAogICAgICAgIG8gPSBlKG4uYm9keSksCiAgICAgICAgYyA9IHsKICAgICAgbGluazogZnVuY3Rpb24gbGluayhpKSB7CiAgICAgICAgdmFyIGEgPSBwKGkpLAogICAgICAgICAgICBsID0gZShhKS5wYXJlbnQoKTsKICAgICAgICBiLmNhbGwobywgewogICAgICAgICAgaHJlZjogbC5hdHRyKCJocmVmIiksCiAgICAgICAgICB0YXJnZXQ6IGwuYXR0cigidGFyZ2V0IikKICAgICAgICB9LCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgdmFyIGEgPSBsWzBdOwogICAgICAgICAgIkEiID09PSBhLnRhZ05hbWUgPyBhLmhyZWYgPSBlLnVybCA6IHYuY2FsbCh0LCAiYSIsIHsKICAgICAgICAgICAgdGFyZ2V0OiBlLnRhcmdldCwKICAgICAgICAgICAgaHJlZjogZS51cmwsCiAgICAgICAgICAgIHRleHQ6IGUudXJsCiAgICAgICAgICB9LCBpKTsKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgdW5saW5rOiBmdW5jdGlvbiB1bmxpbmsodCkgewogICAgICAgIG4uZXhlY0NvbW1hbmQoInVubGluayIpOwogICAgICB9LAogICAgICBmYWNlOiBmdW5jdGlvbiBmYWNlKGUpIHsKICAgICAgICB4LmNhbGwodGhpcywgZnVuY3Rpb24gKGkpIHsKICAgICAgICAgIHYuY2FsbCh0LCAiaW1nIiwgewogICAgICAgICAgICBzcmM6IGkuc3JjLAogICAgICAgICAgICBhbHQ6IGkuYWx0CiAgICAgICAgICB9LCBlKTsKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgaW1hZ2U6IGZ1bmN0aW9uIGltYWdlKGEpIHsKICAgICAgICB2YXIgbiA9IHRoaXM7CiAgICAgICAgbGF5dWkudXNlKCJ1cGxvYWQiLCBmdW5jdGlvbiAobykgewogICAgICAgICAgdmFyIHIgPSBsLnVwbG9hZEltYWdlIHx8IHt9OwogICAgICAgICAgby5yZW5kZXIoewogICAgICAgICAgICB1cmw6IHIudXJsLAogICAgICAgICAgICBtZXRob2Q6IHIudHlwZSwKICAgICAgICAgICAgZWxlbTogZShuKS5maW5kKCJpbnB1dCIpWzBdLAogICAgICAgICAgICBkb25lOiBmdW5jdGlvbiBkb25lKGUpIHsKICAgICAgICAgICAgICAwID09IGUuY29kZSA/IChlLmRhdGEgPSBlLmRhdGEgfHwge30sIHYuY2FsbCh0LCAiaW1nIiwgewogICAgICAgICAgICAgICAgc3JjOiBlLmRhdGEuc3JjLAogICAgICAgICAgICAgICAgYWx0OiBlLmRhdGEudGl0bGUKICAgICAgICAgICAgICB9LCBhKSkgOiBpLm1zZyhlLm1zZyB8fCAiXHU0RTBBXHU0RjIwXHU1OTMxXHU4RDI1Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9LAogICAgICBjb2RlOiBmdW5jdGlvbiBjb2RlKGUpIHsKICAgICAgICBrLmNhbGwobywgZnVuY3Rpb24gKGkpIHsKICAgICAgICAgIHYuY2FsbCh0LCAicHJlIiwgewogICAgICAgICAgICB0ZXh0OiBpLmNvZGUsCiAgICAgICAgICAgICJsYXktbGFuZyI6IGkubGFuZwogICAgICAgICAgfSwgZSk7CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGhlbHA6IGZ1bmN0aW9uIGhlbHAoKSB7CiAgICAgICAgaS5vcGVuKHsKICAgICAgICAgIHR5cGU6IDIsCiAgICAgICAgICB0aXRsZTogIlx1NUUyRVx1NTJBOSIsCiAgICAgICAgICBhcmVhOiBbIjYwMHB4IiwgIjM4MHB4Il0sCiAgICAgICAgICBzaGFkZUNsb3NlOiAhMCwKICAgICAgICAgIHNoYWRlOiAuMSwKICAgICAgICAgIHNraW46ICJsYXl1aS1sYXllci1tc2ciLAogICAgICAgICAgY29udGVudDogWyIiLCAibm8iXQogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgICAgIHMgPSBhLmZpbmQoIi5sYXl1aS1sYXllZGl0LXRvb2wiKSwKICAgICAgICB1ID0gZnVuY3Rpb24gdSgpIHsKICAgICAgdmFyIGkgPSBlKHRoaXMpLAogICAgICAgICAgYSA9IGkuYXR0cigibGF5ZWRpdC1ldmVudCIpLAogICAgICAgICAgbCA9IGkuYXR0cigibGF5LWNvbW1hbmQiKTsKCiAgICAgIGlmICghaS5oYXNDbGFzcyhyKSkgewogICAgICAgIG8uZm9jdXMoKTsKICAgICAgICB2YXIgdSA9IG0obik7CiAgICAgICAgdS5jb21tb25BbmNlc3RvckNvbnRhaW5lcjsKICAgICAgICBsID8gKG4uZXhlY0NvbW1hbmQobCksIC9qdXN0aWZ5TGVmdHxqdXN0aWZ5Q2VudGVyfGp1c3RpZnlSaWdodC8udGVzdChsKSAmJiBuLmV4ZWNDb21tYW5kKCJmb3JtYXRCbG9jayIsICExLCAiPHA+IiksIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgby5mb2N1cygpOwogICAgICAgIH0sIDEwKSkgOiBjW2FdICYmIGNbYV0uY2FsbCh0aGlzLCB1KSwgaC5jYWxsKHQsIHMsIGkpOwogICAgICB9CiAgICB9LAogICAgICAgIGQgPSAvaW1hZ2UvOwoKICAgIHMuZmluZCgiPmkiKS5vbigibW91c2Vkb3duIiwgZnVuY3Rpb24gKCkgewogICAgICB2YXIgdCA9IGUodGhpcyksCiAgICAgICAgICBpID0gdC5hdHRyKCJsYXllZGl0LWV2ZW50Iik7CiAgICAgIGQudGVzdChpKSB8fCB1LmNhbGwodGhpcyk7CiAgICB9KS5vbigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB0ID0gZSh0aGlzKSwKICAgICAgICAgIGkgPSB0LmF0dHIoImxheWVkaXQtZXZlbnQiKTsKICAgICAgZC50ZXN0KGkpICYmIHUuY2FsbCh0aGlzKTsKICAgIH0pLCBvLm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgaC5jYWxsKHQsIHMpLCBpLmNsb3NlKHguaW5kZXgpOwogICAgfSk7CiAgfSwKICAgICAgYiA9IGZ1bmN0aW9uIGIodCwgZSkgewogICAgdmFyIGwgPSB0aGlzLAogICAgICAgIG4gPSBpLm9wZW4oewogICAgICB0eXBlOiAxLAogICAgICBpZDogIkxBWV9sYXllZGl0X2xpbmsiLAogICAgICBhcmVhOiAiMzUwcHgiLAogICAgICBzaGFkZTogLjA1LAogICAgICBzaGFkZUNsb3NlOiAhMCwKICAgICAgbW92ZVR5cGU6IDEsCiAgICAgIHRpdGxlOiAiXHU4RDg1XHU5NEZFXHU2M0E1IiwKICAgICAgc2tpbjogImxheXVpLWxheWVyLW1zZyIsCiAgICAgIGNvbnRlbnQ6IFsnPHVsIGNsYXNzPSJsYXl1aS1mb3JtIiBzdHlsZT0ibWFyZ2luOiAxNXB4OyI+JywgJzxsaSBjbGFzcz0ibGF5dWktZm9ybS1pdGVtIj4nLCAnPGxhYmVsIGNsYXNzPSJsYXl1aS1mb3JtLWxhYmVsIiBzdHlsZT0id2lkdGg6IDYwcHg7Ij5VUkw8L2xhYmVsPicsICc8ZGl2IGNsYXNzPSJsYXl1aS1pbnB1dC1ibG9jayIgc3R5bGU9Im1hcmdpbi1sZWZ0OiA5MHB4Ij4nLCAnPGlucHV0IG5hbWU9InVybCIgbGF5LXZlcmlmeT0idXJsIiB2YWx1ZT0iJyArICh0LmhyZWYgfHwgIiIpICsgJyIgYXV0b2ZvY3VzPSJ0cnVlIiBhdXRvY29tcGxldGU9Im9mZiIgY2xhc3M9ImxheXVpLWlucHV0Ij4nLCAiPC9kaXY+IiwgIjwvbGk+IiwgJzxsaSBjbGFzcz0ibGF5dWktZm9ybS1pdGVtIj4nLCAiPGxhYmVsIGNsYXNzPVwibGF5dWktZm9ybS1sYWJlbFwiIHN0eWxlPVwid2lkdGg6IDYwcHg7XCI+XHU2MjUzXHU1RjAwXHU2NUI5XHU1RjBGPC9sYWJlbD4iLCAnPGRpdiBjbGFzcz0ibGF5dWktaW5wdXQtYmxvY2siIHN0eWxlPSJtYXJnaW4tbGVmdDogOTBweCI+JywgIjxpbnB1dCB0eXBlPVwicmFkaW9cIiBuYW1lPVwidGFyZ2V0XCIgdmFsdWU9XCJfc2VsZlwiIGNsYXNzPVwibGF5dWktaW5wdXRcIiB0aXRsZT1cIlx1NUY1M1x1NTI0RFx1N0E5N1x1NTNFM1wiIiArICgiX3NlbGYiICE9PSB0LnRhcmdldCAmJiB0LnRhcmdldCA/ICIiIDogImNoZWNrZWQiKSArICI+IiwgIjxpbnB1dCB0eXBlPVwicmFkaW9cIiBuYW1lPVwidGFyZ2V0XCIgdmFsdWU9XCJfYmxhbmtcIiBjbGFzcz1cImxheXVpLWlucHV0XCIgdGl0bGU9XCJcdTY1QjBcdTdBOTdcdTUzRTNcIiAiICsgKCJfYmxhbmsiID09PSB0LnRhcmdldCA/ICJjaGVja2VkIiA6ICIiKSArICI+IiwgIjwvZGl2PiIsICI8L2xpPiIsICc8bGkgY2xhc3M9ImxheXVpLWZvcm0taXRlbSIgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsiPicsICI8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBsYXktc3VibWl0IGxheS1maWx0ZXI9XCJsYXllZGl0LWxpbmsteWVzXCIgY2xhc3M9XCJsYXl1aS1idG5cIj4gXHU3ODZFXHU1QjlBIDwvYnV0dG9uPiIsICI8YnV0dG9uIHN0eWxlPVwibWFyZ2luLWxlZnQ6IDIwcHg7XCIgdHlwZT1cImJ1dHRvblwiIGNsYXNzPVwibGF5dWktYnRuIGxheXVpLWJ0bi1wcmltYXJ5XCI+IFx1NTNENlx1NkQ4OCA8L2J1dHRvbj4iLCAiPC9saT4iLCAiPC91bD4iXS5qb2luKCIiKSwKICAgICAgc3VjY2VzczogZnVuY3Rpb24gc3VjY2Vzcyh0LCBuKSB7CiAgICAgICAgdmFyIG8gPSAic3VibWl0KGxheWVkaXQtbGluay15ZXMpIjsKICAgICAgICBhLnJlbmRlcigicmFkaW8iKSwgdC5maW5kKCIubGF5dWktYnRuLXByaW1hcnkiKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpLmNsb3NlKG4pLCBsLmZvY3VzKCk7CiAgICAgICAgfSksIGEub24obywgZnVuY3Rpb24gKHQpIHsKICAgICAgICAgIGkuY2xvc2UoYi5pbmRleCksIGUgJiYgZSh0LmZpZWxkKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICBiLmluZGV4ID0gbjsKICB9LAogICAgICB4ID0gZnVuY3Rpb24geCh0KSB7CiAgICB2YXIgYSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHQgPSBbIltcdTVGQUVcdTdCMTFdIiwgIltcdTU2M0JcdTU2M0JdIiwgIltcdTU0QzhcdTU0QzhdIiwgIltcdTUzRUZcdTcyMzFdIiwgIltcdTUzRUZcdTYwMUNdIiwgIltcdTYzMTZcdTlGM0JdIiwgIltcdTU0MDNcdTYwQ0FdIiwgIltcdTVCQjNcdTdGOUVdIiwgIltcdTYzMjRcdTc3M0NdIiwgIltcdTk1RURcdTU2MzRdIiwgIltcdTkxMTlcdTg5QzZdIiwgIltcdTcyMzFcdTRGNjBdIiwgIltcdTZDRUFdIiwgIltcdTUwNzdcdTdCMTFdIiwgIltcdTRFQjJcdTRFQjJdIiwgIltcdTc1MUZcdTc1QzVdIiwgIltcdTU5MkFcdTVGMDBcdTVGQzNdIiwgIltcdTc2N0RcdTc3M0NdIiwgIltcdTUzRjNcdTU0RkNcdTU0RkNdIiwgIltcdTVERTZcdTU0RkNcdTU0RkNdIiwgIltcdTU2MThdIiwgIltcdTg4NzBdIiwgIltcdTU5RDRcdTVDNDhdIiwgIltcdTU0MTBdIiwgIltcdTU0QzhcdTZCMjBdIiwgIltcdTYyQjFcdTYyQjFdIiwgIltcdTYwMTJdIiwgIltcdTc1OTFcdTk1RUVdIiwgIltcdTk5OEJcdTU2MzRdIiwgIltcdTYyRENcdTYyRENdIiwgIltcdTYwMURcdTgwMDNdIiwgIltcdTZDNTddIiwgIltcdTU2RjBdIiwgIltcdTc3NjFdIiwgIltcdTk0QjFdIiwgIltcdTU5MzFcdTY3MUJdIiwgIltcdTkxNzddIiwgIltcdTgyNzJdIiwgIltcdTU0RkNdIiwgIltcdTlGMTNcdTYzOENdIiwgIltcdTY2NTVdIiwgIltcdTYwQjJcdTRGMjRdIiwgIltcdTYyOTNcdTcyQzJdIiwgIltcdTlFRDFcdTdFQkZdIiwgIltcdTk2MzRcdTk2NjldIiwgIltcdTYwMTJcdTlBODJdIiwgIltcdTRFOTJcdTdDODldIiwgIltcdTVGQzNdIiwgIltcdTRGMjRcdTVGQzNdIiwgIltcdTczMkFcdTU5MzRdIiwgIltcdTcxOEFcdTczMkJdIiwgIltcdTUxNTRcdTVCNTBdIiwgIltva10iLCAiW1x1ODAzNl0iLCAiW2dvb2RdIiwgIltOT10iLCAiW1x1OEQ1RV0iLCAiW1x1Njc2NV0iLCAiW1x1NUYzMV0iLCAiW1x1ODM0OVx1NkNFNVx1OUE2Q10iLCAiW1x1Nzk1RVx1OUE2Q10iLCAiW1x1NTZFN10iLCAiW1x1NkQ2RVx1NEU5MV0iLCAiW1x1N0VEOVx1NTI5Ql0iLCAiW1x1NTZGNFx1ODlDMl0iLCAiW1x1NUEwMVx1NkI2Nl0iLCAiW1x1NTk2NVx1NzI3OVx1NjZGQ10iLCAiW1x1NzkzQ1x1NzI2OV0iLCAiW1x1OTQ5Rl0iLCAiW1x1OEJERFx1N0I1Ml0iLCAiW1x1ODcyMVx1NzBEQl0iLCAiW1x1ODZDQlx1N0NENV0iXSwKICAgICAgICAgIGUgPSB7fTsKICAgICAgcmV0dXJuIGxheXVpLmVhY2godCwgZnVuY3Rpb24gKHQsIGkpIHsKICAgICAgICBlW2ldID0gbGF5dWkuY2FjaGUuZGlyICsgImltYWdlcy9mYWNlLyIgKyB0ICsgIi5naWYiOwogICAgICB9KSwgZTsKICAgIH0oKTsKCiAgICByZXR1cm4geC5oaWRlID0geC5oaWRlIHx8IGZ1bmN0aW9uICh0KSB7CiAgICAgICJmYWNlIiAhPT0gZSh0LnRhcmdldCkuYXR0cigibGF5ZWRpdC1ldmVudCIpICYmIGkuY2xvc2UoeC5pbmRleCk7CiAgICB9LCB4LmluZGV4ID0gaS50aXBzKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHQgPSBbXTsKICAgICAgcmV0dXJuIGxheXVpLmVhY2goYSwgZnVuY3Rpb24gKGUsIGkpIHsKICAgICAgICB0LnB1c2goJzxsaSB0aXRsZT0iJyArIGUgKyAnIj48aW1nIHNyYz0iJyArIGkgKyAnIiBhbHQ9IicgKyBlICsgJyI+PC9saT4nKTsKICAgICAgfSksICc8dWwgY2xhc3M9ImxheXVpLWNsZWFyIj4nICsgdC5qb2luKCIiKSArICI8L3VsPiI7CiAgICB9KCksIHRoaXMsIHsKICAgICAgdGlwczogMSwKICAgICAgdGltZTogMCwKICAgICAgc2tpbjogImxheXVpLWJveCBsYXl1aS11dGlsLWZhY2UiLAogICAgICBtYXhXaWR0aDogNTAwLAogICAgICBzdWNjZXNzOiBmdW5jdGlvbiBzdWNjZXNzKGwsIG4pIHsKICAgICAgICBsLmNzcyh7CiAgICAgICAgICBtYXJnaW5Ub3A6IC00LAogICAgICAgICAgbWFyZ2luTGVmdDogLTEwCiAgICAgICAgfSkuZmluZCgiLmxheXVpLWNsZWFyPmxpIikub24oImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgdCAmJiB0KHsKICAgICAgICAgICAgc3JjOiBhW3RoaXMudGl0bGVdLAogICAgICAgICAgICBhbHQ6IHRoaXMudGl0bGUKICAgICAgICAgIH0pLCBpLmNsb3NlKG4pOwogICAgICAgIH0pLCBlKGRvY3VtZW50KS5vZmYoImNsaWNrIiwgeC5oaWRlKS5vbigiY2xpY2siLCB4LmhpZGUpOwogICAgICB9CiAgICB9KTsKICB9LAogICAgICBrID0gZnVuY3Rpb24gayh0KSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgbCA9IGkub3Blbih7CiAgICAgIHR5cGU6IDEsCiAgICAgIGlkOiAiTEFZX2xheWVkaXRfY29kZSIsCiAgICAgIGFyZWE6ICI1NTBweCIsCiAgICAgIHNoYWRlOiAuMDUsCiAgICAgIHNoYWRlQ2xvc2U6ICEwLAogICAgICBtb3ZlVHlwZTogMSwKICAgICAgdGl0bGU6ICJcdTYzRDJcdTUxNjVcdTRFRTNcdTc4MDEiLAogICAgICBza2luOiAibGF5dWktbGF5ZXItbXNnIiwKICAgICAgY29udGVudDogWyc8dWwgY2xhc3M9ImxheXVpLWZvcm0gbGF5dWktZm9ybS1wYW5lIiBzdHlsZT0ibWFyZ2luOiAxNXB4OyI+JywgJzxsaSBjbGFzcz0ibGF5dWktZm9ybS1pdGVtIj4nLCAiPGxhYmVsIGNsYXNzPVwibGF5dWktZm9ybS1sYWJlbFwiPlx1OEJGN1x1OTAwOVx1NjJFOVx1OEJFRFx1OEEwMDwvbGFiZWw+IiwgJzxkaXYgY2xhc3M9ImxheXVpLWlucHV0LWJsb2NrIj4nLCAnPHNlbGVjdCBuYW1lPSJsYW5nIj4nLCAnPG9wdGlvbiB2YWx1ZT0iSmF2YVNjcmlwdCI+SmF2YVNjcmlwdDwvb3B0aW9uPicsICc8b3B0aW9uIHZhbHVlPSJIVE1MIj5IVE1MPC9vcHRpb24+JywgJzxvcHRpb24gdmFsdWU9IkNTUyI+Q1NTPC9vcHRpb24+JywgJzxvcHRpb24gdmFsdWU9IkphdmEiPkphdmE8L29wdGlvbj4nLCAnPG9wdGlvbiB2YWx1ZT0iUEhQIj5QSFA8L29wdGlvbj4nLCAnPG9wdGlvbiB2YWx1ZT0iQyMiPkMjPC9vcHRpb24+JywgJzxvcHRpb24gdmFsdWU9IlB5dGhvbiI+UHl0aG9uPC9vcHRpb24+JywgJzxvcHRpb24gdmFsdWU9IlJ1YnkiPlJ1Ynk8L29wdGlvbj4nLCAnPG9wdGlvbiB2YWx1ZT0iR28iPkdvPC9vcHRpb24+JywgIjwvc2VsZWN0PiIsICI8L2Rpdj4iLCAiPC9saT4iLCAnPGxpIGNsYXNzPSJsYXl1aS1mb3JtLWl0ZW0gbGF5dWktZm9ybS10ZXh0Ij4nLCAiPGxhYmVsIGNsYXNzPVwibGF5dWktZm9ybS1sYWJlbFwiPlx1NEVFM1x1NzgwMTwvbGFiZWw+IiwgJzxkaXYgY2xhc3M9ImxheXVpLWlucHV0LWJsb2NrIj4nLCAnPHRleHRhcmVhIG5hbWU9ImNvZGUiIGxheS12ZXJpZnk9InJlcXVpcmVkIiBhdXRvZm9jdXM9InRydWUiIGNsYXNzPSJsYXl1aS10ZXh0YXJlYSIgc3R5bGU9ImhlaWdodDogMjAwcHg7Ij48L3RleHRhcmVhPicsICI8L2Rpdj4iLCAiPC9saT4iLCAnPGxpIGNsYXNzPSJsYXl1aS1mb3JtLWl0ZW0iIHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7Ij4nLCAiPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgbGF5LXN1Ym1pdCBsYXktZmlsdGVyPVwibGF5ZWRpdC1jb2RlLXllc1wiIGNsYXNzPVwibGF5dWktYnRuXCI+IFx1Nzg2RVx1NUI5QSA8L2J1dHRvbj4iLCAiPGJ1dHRvbiBzdHlsZT1cIm1hcmdpbi1sZWZ0OiAyMHB4O1wiIHR5cGU9XCJidXR0b25cIiBjbGFzcz1cImxheXVpLWJ0biBsYXl1aS1idG4tcHJpbWFyeVwiPiBcdTUzRDZcdTZEODggPC9idXR0b24+IiwgIjwvbGk+IiwgIjwvdWw+Il0uam9pbigiIiksCiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIHN1Y2Nlc3MobCwgbikgewogICAgICAgIHZhciBvID0gInN1Ym1pdChsYXllZGl0LWNvZGUteWVzKSI7CiAgICAgICAgYS5yZW5kZXIoInNlbGVjdCIpLCBsLmZpbmQoIi5sYXl1aS1idG4tcHJpbWFyeSIpLm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGkuY2xvc2UobiksIGUuZm9jdXMoKTsKICAgICAgICB9KSwgYS5vbihvLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgaS5jbG9zZShrLmluZGV4KSwgdCAmJiB0KGUuZmllbGQpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIGsuaW5kZXggPSBsOwogIH0sCiAgICAgIEMgPSB7CiAgICBodG1sOiAiPGkgY2xhc3M9XCJsYXl1aS1pY29uIGxheWVkaXQtdG9vbC1odG1sXCIgdGl0bGU9XCJIVE1MXHU2RTkwXHU0RUUzXHU3ODAxXCIgbGF5LWNvbW1hbmQ9XCJodG1sXCIgbGF5ZWRpdC1ldmVudD1cImh0bWxcIlwiPiYjeGU2NGI7PC9pPjxzcGFuIGNsYXNzPVwibGF5ZWRpdC10b29sLW1pZFwiPjwvc3Bhbj4iLAogICAgc3Ryb25nOiAiPGkgY2xhc3M9XCJsYXl1aS1pY29uIGxheWVkaXQtdG9vbC1iXCIgdGl0bGU9XCJcdTUyQTBcdTdDOTdcIiBsYXktY29tbWFuZD1cIkJvbGRcIiBsYXllZGl0LWV2ZW50PVwiYlwiXCI+JiN4ZTYyYjs8L2k+IiwKICAgIGl0YWxpYzogIjxpIGNsYXNzPVwibGF5dWktaWNvbiBsYXllZGl0LXRvb2wtaVwiIHRpdGxlPVwiXHU2NTlDXHU0RjUzXCIgbGF5LWNvbW1hbmQ9XCJpdGFsaWNcIiBsYXllZGl0LWV2ZW50PVwiaVwiXCI+JiN4ZTY0NDs8L2k+IiwKICAgIHVuZGVybGluZTogIjxpIGNsYXNzPVwibGF5dWktaWNvbiBsYXllZGl0LXRvb2wtdVwiIHRpdGxlPVwiXHU0RTBCXHU1MjEyXHU3RUJGXCIgbGF5LWNvbW1hbmQ9XCJ1bmRlcmxpbmVcIiBsYXllZGl0LWV2ZW50PVwidVwiXCI+JiN4ZTY0Njs8L2k+IiwKICAgIGRlbDogIjxpIGNsYXNzPVwibGF5dWktaWNvbiBsYXllZGl0LXRvb2wtZFwiIHRpdGxlPVwiXHU1MjIwXHU5NjY0XHU3RUJGXCIgbGF5LWNvbW1hbmQ9XCJzdHJpa2VUaHJvdWdoXCIgbGF5ZWRpdC1ldmVudD1cImRcIlwiPiYjeGU2NGY7PC9pPiIsCiAgICAifCI6ICc8c3BhbiBjbGFzcz0ibGF5ZWRpdC10b29sLW1pZCI+PC9zcGFuPicsCiAgICBsZWZ0OiAiPGkgY2xhc3M9XCJsYXl1aS1pY29uIGxheWVkaXQtdG9vbC1sZWZ0XCIgdGl0bGU9XCJcdTVERTZcdTVCRjlcdTlGNTBcIiBsYXktY29tbWFuZD1cImp1c3RpZnlMZWZ0XCIgbGF5ZWRpdC1ldmVudD1cImxlZnRcIlwiPiYjeGU2NDk7PC9pPiIsCiAgICBjZW50ZXI6ICI8aSBjbGFzcz1cImxheXVpLWljb24gbGF5ZWRpdC10b29sLWNlbnRlclwiIHRpdGxlPVwiXHU1QzQ1XHU0RTJEXHU1QkY5XHU5RjUwXCIgbGF5LWNvbW1hbmQ9XCJqdXN0aWZ5Q2VudGVyXCIgbGF5ZWRpdC1ldmVudD1cImNlbnRlclwiXCI+JiN4ZTY0Nzs8L2k+IiwKICAgIHJpZ2h0OiAiPGkgY2xhc3M9XCJsYXl1aS1pY29uIGxheWVkaXQtdG9vbC1yaWdodFwiIHRpdGxlPVwiXHU1M0YzXHU1QkY5XHU5RjUwXCIgbGF5LWNvbW1hbmQ9XCJqdXN0aWZ5UmlnaHRcIiBsYXllZGl0LWV2ZW50PVwicmlnaHRcIlwiPiYjeGU2NDg7PC9pPiIsCiAgICBsaW5rOiAiPGkgY2xhc3M9XCJsYXl1aS1pY29uIGxheWVkaXQtdG9vbC1saW5rXCIgdGl0bGU9XCJcdTYzRDJcdTUxNjVcdTk0RkVcdTYzQTVcIiBsYXllZGl0LWV2ZW50PVwibGlua1wiXCI+JiN4ZTY0Yzs8L2k+IiwKICAgIHVubGluazogIjxpIGNsYXNzPVwibGF5dWktaWNvbiBsYXllZGl0LXRvb2wtdW5saW5rIGxheXVpLWRpc2FibGVkXCIgdGl0bGU9XCJcdTZFMDVcdTk2NjRcdTk0RkVcdTYzQTVcIiBsYXktY29tbWFuZD1cInVubGlua1wiIGxheWVkaXQtZXZlbnQ9XCJ1bmxpbmtcIlwiPiYjeGU2NGQ7PC9pPiIsCiAgICBmYWNlOiAiPGkgY2xhc3M9XCJsYXl1aS1pY29uIGxheWVkaXQtdG9vbC1mYWNlXCIgdGl0bGU9XCJcdTg4NjhcdTYwQzVcIiBsYXllZGl0LWV2ZW50PVwiZmFjZVwiXCI+JiN4ZTY1MDs8L2k+IiwKICAgIGltYWdlOiAiPGkgY2xhc3M9XCJsYXl1aS1pY29uIGxheWVkaXQtdG9vbC1pbWFnZVwiIHRpdGxlPVwiXHU1NkZFXHU3MjQ3XCIgbGF5ZWRpdC1ldmVudD1cImltYWdlXCI+JiN4ZTY0YTs8aW5wdXQgdHlwZT1cImZpbGVcIiBuYW1lPVwiZmlsZVwiPjwvaT4iLAogICAgY29kZTogIjxpIGNsYXNzPVwibGF5dWktaWNvbiBsYXllZGl0LXRvb2wtY29kZVwiIHRpdGxlPVwiXHU2M0QyXHU1MTY1XHU0RUUzXHU3ODAxXCIgbGF5ZWRpdC1ldmVudD1cImNvZGVcIj4mI3hlNjRlOzwvaT4iLAogICAgaGVscDogIjxpIGNsYXNzPVwibGF5dWktaWNvbiBsYXllZGl0LXRvb2wtaGVscFwiIHRpdGxlPVwiXHU1RTJFXHU1MkE5XCIgbGF5ZWRpdC1ldmVudD1cImhlbHBcIj4mI3hlNjA3OzwvaT4iCiAgfSwKICAgICAgTCA9IG5ldyBjKCk7CgogIHQobiwgTCk7Cn0pOwpsYXl1aS5kZWZpbmUoImpxdWVyeSIsIGZ1bmN0aW9uIChhKSB7CiAgInVzZSBzdHJpY3QiOwoKICB2YXIgZSA9IGxheXVpLiQ7CiAgYSgiY29kZSIsIGZ1bmN0aW9uIChhKSB7CiAgICB2YXIgbCA9IFtdOwogICAgYSA9IGEgfHwge30sIGEuZWxlbSA9IGUoYS5lbGVtIHx8ICIubGF5dWktY29kZSIpLCBhLmxhbmcgPSAibGFuZyIgaW4gYSA/IGEubGFuZyA6ICJjb2RlIiwgYS5lbGVtLmVhY2goZnVuY3Rpb24gKCkgewogICAgICBsLnB1c2godGhpcyk7CiAgICB9KSwgbGF5dWkuZWFjaChsLnJldmVyc2UoKSwgZnVuY3Rpb24gKGwsIGkpIHsKICAgICAgdmFyIHQgPSBlKGkpLAogICAgICAgICAgYyA9IHQuaHRtbCgpOwogICAgICAodC5hdHRyKCJsYXktZW5jb2RlIikgfHwgYS5lbmNvZGUpICYmIChjID0gYy5yZXBsYWNlKC8mKD8hIz9bYS16QS1aMC05XSs7KS9nLCAiJmFtcDsiKS5yZXBsYWNlKC88L2csICImbHQ7IikucmVwbGFjZSgvPi9nLCAiJmd0OyIpLnJlcGxhY2UoLycvZywgIiYjMzk7IikucmVwbGFjZSgvIi9nLCAiJnF1b3Q7IikpLCB0Lmh0bWwoJzxvbCBjbGFzcz0ibGF5dWktY29kZS1vbCI+PGxpPicgKyBjLnJlcGxhY2UoL1tcclx0XG5dKy9nLCAiPC9saT48bGk+IikgKyAiPC9saT48L29sPiIpLCB0LmZpbmQoIj4ubGF5dWktY29kZS1oMyIpWzBdIHx8IHQucHJlcGVuZCgnPGgzIGNsYXNzPSJsYXl1aS1jb2RlLWgzIj4nICsgKHQuYXR0cigibGF5LXRpdGxlIikgfHwgYS50aXRsZSB8fCAiJmx0Oy8mZ3Q7IikgKyAnPGEgaHJlZj0iamF2YXNjcmlwdDo7Ij4nICsgKHQuYXR0cigibGF5LWxhbmciKSB8fCBhLmxhbmcgfHwgIiIpICsgIjwvYT48L2gzPiIpOwogICAgICB2YXIgbiA9IHQuZmluZCgiPi5sYXl1aS1jb2RlLW9sIik7CiAgICAgIHQuYWRkQ2xhc3MoImxheXVpLWJveCBsYXl1aS1jb2RlLXZpZXciKSwgKHQuYXR0cigibGF5LXNraW4iKSB8fCBhLnNraW4pICYmIHQuYWRkQ2xhc3MoImxheXVpLWNvZGUtIiArICh0LmF0dHIoImxheS1za2luIikgfHwgYS5za2luKSksIChuLmZpbmQoImxpIikubGVuZ3RoIC8gMTAwIHwgMCkgPiAwICYmIG4uY3NzKCJtYXJnaW4tbGVmdCIsIChuLmZpbmQoImxpIikubGVuZ3RoIC8gMTAwIHwgMCkgKyAicHgiKSwgKHQuYXR0cigibGF5LWhlaWdodCIpIHx8IGEuaGVpZ2h0KSAmJiBuLmNzcygibWF4LWhlaWdodCIsIHQuYXR0cigibGF5LWhlaWdodCIpIHx8IGEuaGVpZ2h0KTsKICAgIH0pOwogIH0pOwp9KS5hZGRjc3MoIm1vZHVsZXMvY29kZS5jc3M/dj0yIiwgInNraW5jb2RlY3NzIik7"},null]}