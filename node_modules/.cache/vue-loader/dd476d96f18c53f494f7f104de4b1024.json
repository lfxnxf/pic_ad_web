{"remainingRequest":"/Users/zhang/工作/pic_ad/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/zhang/工作/pic_ad/src/views/setting/department-setting/components/add-modal.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/zhang/工作/pic_ad/src/views/setting/department-setting/components/add-modal.vue","mtime":1638523446917},{"path":"/Users/zhang/工作/pic_ad/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/zhang/工作/pic_ad/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/Users/zhang/工作/pic_ad/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/zhang/工作/pic_ad/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCmltcG9ydCBfIGZyb20gJ3VuZGVyc2NvcmUnOwppbXBvcnQge2dldFRyZWVOb2RlcywgYnVpbGRUcmVlLCBidWlsZFRyZWVDaGVja2VkfSBmcm9tICJAL2xpYnMvdXRpbCI7CmV4cG9ydCBkZWZhdWx0IHsKICBkYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgYnRuTG9hZGluZzogZmFsc2UsCiAgICAgIGJ0bkxvYWRpbmcyOiBmYWxzZSwKICAgICAgYnRuTG9hZGluZzM6IGZhbHNlLAogICAgICBpc0VkaXQ6IGZhbHNlLAogICAgICBtZXJjaGFudF9uYW1lOiAnJywKICAgICAgdGFibGVEYXRhOiBbXSwKICAgICAgdHJlZURhdGE6IFtdLAogICAgICBkZXBhcnRtZW50czogW10sCiAgICAgIGRlcGFydG1lbnRJZHM6IFtdLAogICAgfTsKICB9LAoKICBjb21wb25lbnRzOiB7fSwKCiAgY29tcHV0ZWQ6IHsKICAgIGxvYWRpbmcoKSB7CiAgICAgIHJldHVybiB0aGlzLiRzdG9yZS5zdGF0ZS51c2VyLnVzZXJMb2FkaW5nOwogICAgfSwKICAgIGN1cnJlbnRNZXJjaGFudElkKCl7CiAgICAgIHJldHVybiB0aGlzLiRzdG9yZS5zdGF0ZS51c2VyLmN1ck1lcmNoYW50SWQ7CiAgICB9LAogICAgY3VycmVudE1lcmNoYW50TmFtZSgpewogICAgICByZXR1cm4gdGhpcy4kc3RvcmUuc3RhdGUudXNlci5jdXJNZXJjaGFudE5hbWU7CiAgICB9LAogICAgY3VycmVudE9yZ0lkKCkgewogICAgICByZXR1cm4gdGhpcy4kc3RvcmUuc3RhdGUudXNlci5jdXJPcmdJZDsKICAgIH0sCiAgICBzZXNzaW9uSWQoKSB7CiAgICAgIHJldHVybiB0aGlzLiRzdG9yZS5zdGF0ZS51c2VyLnRva2VuOwogICAgfSwKICAgIGVtcFVzZXJDb2RlKCkgewogICAgICByZXR1cm4gdGhpcy4kc3RvcmUuc3RhdGUudXNlci5lbXBVc2VyQ29kZTsKICAgIH0sCgogICAgLy/pg6jpl6jliJfooagKICAgIGRlcGFydG1lbnRMaXN0KCkgewogICAgICByZXR1cm4gdGhpcy4kc3RvcmUuc3RhdGUudXNlci5kZXBhcnRtZW50TGlzdDsKICAgIH0sCgogIH0sCgogIG1ldGhvZHM6IHsKICAgIGluaXREYXRhOiBhc3luYyBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5tZXJjaGFudF9uYW1lID0gdGhpcy5jdXJyZW50TWVyY2hhbnROYW1lOwogICAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy5nZXREZXBhcnRtZW50TGlzdCgpOwogICAgICBhd2FpdCB0aGlzLnF1ZXJ5RGVwYXJ0bWVudExpc3QocmVzKTsKICAgIH0sCgogICAgLy/ojrflj5bkvIHkuJrpg6jpl6jliJfooagKICAgIGFzeW5jIHF1ZXJ5RGVwYXJ0bWVudExpc3Qoc3RyQ2hlY2tlZCkgewogICAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy4kc3RvcmUuZGlzcGF0Y2goJ2RlcGFydG1lbnRMaXN0JywgeyBvcmdfaWQ6IHRoaXMuY3VycmVudE9yZ0lkLCBzZXNzaW9uaWQ6IHRoaXMuc2Vzc2lvbklkLGxpbWl0OiAyMDAwIH0pOwogICAgICAvLyBjb25zb2xlLmxvZygicXVlcnlEZXBhcnRtZW50TGlzdD09PXJlcz4+PiIgKyBKU09OLnN0cmluZ2lmeShyZXMpKTsKICAgICAgbGV0IHZhbGlkUmVzID0gXy5maWx0ZXIocmVzLCBjdXIgPT4ge3JldHVybiBjdXIuc3RhdHVzID09IDEgfSk7CiAgICAgIC8vIGNvbnNvbGUubG9nKCJxdWVyeURlcGFydG1lbnRMaXN0PT09dmFsaWRSZXM+Pj4iICsgSlNPTi5zdHJpbmdpZnkodmFsaWRSZXMpKTsKICAgICAgYXdhaXQgdGhpcy4kc3RvcmUuY29tbWl0KCJVcGRhdGVFbXBEZXBhcnRtZW50TGlzdCIsIHZhbGlkUmVzKTsKICAgICAgaWYgKHZhbGlkUmVzLmxlbmd0aCA+IDApIHsKICAgICAgICB0aGlzLnRyZWVEYXRhID0gYnVpbGRUcmVlQ2hlY2tlZCh2YWxpZFJlcywge30sICdkZXBhcnRtZW50X2lkJywgJ3BhcmVudGlkJywgJ2NoaWxkcmVuJywgJzAnLCBzdHJDaGVja2VkKTsKICAgICAgfQogICAgfSwKCiAgICBjaG9pY2VBbGwoZGF0YSl7CiAgICAgIGxldCBjaG9pY2VzRGF0YSA9IHRoaXMuJHJlZnMudHJlZTMuZ2V0Q2hlY2tlZEFuZEluZGV0ZXJtaW5hdGVOb2RlcygpOwogICAgICB0aGlzLmRlcGFydG1lbnRzID0gXy5tYXAoY2hvaWNlc0RhdGEsIGZ1bmN0aW9uKGl0ZW0peyByZXR1cm4ge25hbWU6IGl0ZW0ubmFtZSwgb3JnX2lkOiBpdGVtLm9yZ19pZCwgcGFyZW50aWQ6IGl0ZW0ucGFyZW50aWQsIGRlcGFydG1lbnRfaWQ6IGl0ZW0uZGVwYXJ0bWVudF9pZH07IH0pOwogICAgfSwKCiAgICBzeW5jRGVwYXJ0bWVudExpc3Q6IGFzeW5jIGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmJ0bkxvYWRpbmcgPSB0cnVlOwogICAgICAvL+e7memDqOmXqOa3u+WKoOi3n+iKgueCue+8mwogICAgICBsZXQgcm9vdFRyZWU9ewogICAgICAgIGRlcGFydG1lbnRfaWQ6ICcwJywKICAgICAgICBwYXJlbnRpZDogIiIsCiAgICAgICAgbmFtZTogIuWFqOmDqOmDqOmXqCIsCiAgICAgICAgb3JnX2lkOiB0aGlzLmN1cnJlbnRPcmdJZCwKICAgICAgfTsKCiAgICAgIGxldCBmaW5kSXRlbSA9IF8uZmluZCh0aGlzLmRlcGFydG1lbnRzLCBjdXI9PntyZXR1cm4gY3VyLmRlcGFydG1lbnRfaWQgPT0gJzAnIH0pOwoKICAgICAgaWYgKGZpbmRJdGVtID09IHVuZGVmaW5lZCl7CiAgICAgICAgdGhpcy5kZXBhcnRtZW50cy5wdXNoKHJvb3RUcmVlKTsKICAgICAgfQogICAgICBlbHNlewogICAgICAgIGZpbmRJdGVtWydvcmdfaWQnXSA9IHRoaXMuY3VycmVudE9yZ0lkOwogICAgICB9CgogICAgICBsZXQgQmFzZTY0ID0gcmVxdWlyZSgnanMtYmFzZTY0JykuQmFzZTY0OwoKICAgICAgbGV0IHBhcmFtcyA9IHsKICAgICAgICBtZXJjaGFudF9pZDogdGhpcy5jdXJyZW50TWVyY2hhbnRJZCwKICAgICAgICBkZXBhcnRtZW50czogQmFzZTY0LmVuY29kZShKU09OLnN0cmluZ2lmeSh0aGlzLmRlcGFydG1lbnRzKSksCiAgICAgIH07CgogICAgICBhd2FpdCB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnc3luY0RlcGFydG1lbnRzJywgcGFyYW1zKS50aGVuKHJlcz0+ewogICAgICAgIGlmKHJlcy5yZXR1cm5fY29kZT09MCl7CiAgICAgICAgICB0aGlzLmJ0bkxvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuJE1lc3NhZ2Uuc3VjY2Vzcygn5ZCM5q2l6YOo6Zeo5L+h5oGv5oiQ5Yqf77yBJyk7CiAgICAgICAgfQogICAgICB9KS5jYXRjaChlcnI9PnsKICAgICAgICB0aGlzLmJ0bkxvYWRpbmcgPSBmYWxzZTsKICAgICAgfSk7CiAgICB9LAoKICAgIGdldERlcGFydG1lbnRMaXN0OiBhc3luYyBmdW5jdGlvbigpIHsKCiAgICAgIGxldCBwYXJhbXMgPSB7CiAgICAgICAgbWVyY2hhbnRfaWQ6IHRoaXMuY3VycmVudE1lcmNoYW50SWQsCiAgICAgICAgbGV2ZWw6IDEsCiAgICAgIH07CgogICAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy4kc3RvcmUuZGlzcGF0Y2goJ2dldE1lcmNoYW50RGVwYXJ0bWVudExpc3QnLCBwYXJhbXMpOwogICAgICBpZihyZXMucmV0dXJuX2NvZGU9PTApewogICAgICAgICAgdGhpcy4kTWVzc2FnZS5zdWNjZXNzKCfojrflj5bpg6jpl6jkv6Hmga/miJDlip/vvIEnKTsKICAgICAgICAgIGxldCByZXNUcmVlID0gZ2V0VHJlZU5vZGVzKHJlcy5kYXRhLCAnZGVwYXJ0bWVudF9pZCcsICAnY2hpbGRyZW4nKTsKICAgICAgICAgIHJldHVybiByZXNUcmVlOwogICAgICB9CiAgICB9LAogICAgLy8g5ZCM5q2l5ZGY5belCiAgICBhc3luYyBzeW5jRW1wbG95ZWUoZW50aXR5RGF0YSkgewogICAgICB0cnkgewogICAgICAgIGlmKGVudGl0eURhdGE9PSdkZXBhcnRtZW50Jyl7CiAgICAgICAgICB0aGlzLmJ0bkxvYWRpbmcyID0gdHJ1ZTsKICAgICAgICB9ZWxzZSBpZihlbnRpdHlEYXRhPT0nZW1wbG95ZWUnKXsKICAgICAgICAgIHRoaXMuYnRuTG9hZGluZzMgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgbGV0IHJlcyA9IGF3YWl0IHRoaXMuJHN0b3JlLmRpc3BhdGNoKCdpY2xvdWRTeW5jJywgeyBvcmdfaWQ6IHRoaXMuJHN0b3JlLnN0YXRlLnVzZXIuY3VyT3JnSWQsIGVudGl0eTogZW50aXR5RGF0YSB9KTsKICAgICAgICBpZiAocmVzLnJldHVybl9jb2RlICE9PSAwKSB7CiAgICAgICAgICB0aGlzLiRNZXNzYWdlLmVycm9yKHJlcy5yZXR1cm5fbWVzc2FnZSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuYnRuTG9hZGluZzIgPSBmYWxzZTsKICAgICAgICB0aGlzLmJ0bkxvYWRpbmczID0gZmFsc2U7CgogICAgICAgIHRoaXMuJE1lc3NhZ2Uuc3VjY2Vzcygn5ZCM5q2l5pWw5o2u5ZG95Luk5Y+R6YCB5oiQ5Yqf77yM6K+356iN5ZCO5p+l55yL5ZCM5q2l5pWw5o2u57uT5p6c77yBJyk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAvLyBjb25zb2xlLmxvZyhlKTsKICAgICAgICB0aGlzLmJ0bkxvYWRpbmcyID0gZmFsc2U7CiAgICAgICAgdGhpcy5idG5Mb2FkaW5nMyA9IGZhbHNlOwogICAgICB9CiAgICB9LAoKCiAgfSwKCiAgbW91bnRlZCgpewogICAgdGhpcy5pbml0RGF0YSgpOwogIH0sCgogIHdhdGNoOiB7CiAgICBkZXBhcnRtZW50TW9kYWwodmFsKXsKICAgICAgaWYoIXZhbCl7CiAgICAgICAgdGhpcy5idG5Mb2FkaW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5idG5Mb2FkaW5nMiA9IGZhbHNlOwogICAgICB9CiAgICB9CiAgfQp9Owo="},{"version":3,"sources":["add-modal.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"add-modal.vue","sourceRoot":"src/views/setting/department-setting/components","sourcesContent":["<!-- 同步部门信息 -->\n<template>\n  <Row :gutter=\"15\">\n    <Col span=\"12\">\n      <Card title=\"设置商户部门\">\n\n          <Form class=\"margin-top-20\" :label-width=\"100\">\n            <FormItem label=\"商户名称：\">\n              <span class=\"font-blod\" style=\"padding-left:12px\">{{ merchant_name }}</span>\n            </FormItem>\n            <Form inline :label-width=\"100\">\n              <FormItem class=\"tree\" label=\"选择部门：\">\n                <Tree :data=\"treeData\" @on-check-change=\"choiceAll\" ref=\"tree3\" show-checkbox multiple></Tree>\n              </FormItem>\n              <FormItem>\n                <Button type=\"primary\" :loading=\"btnLoading\" @click=\"syncDepartmentList\">提交</Button>\n              </FormItem>\n            </Form>\n          </Form>\n\n      </Card>\n    </Col>\n    <Col span=\"12\">\n      <Card title=\"同步云门户数据到用户中心\">\n\n          <Form class=\"margin-top-20\" :label-width=\"100\">\n\n            <FormItem class=\"margin-bottom-40\" label=\"同步部门：\">\n              <Button class=\"margin-right-20\" type='primary' :loading=\"btnLoading2\" icon=\"md-refresh\"\n                      @click=\"syncEmployee('department')\">同步部门\n              </Button>\n              <!-- <span class=\"orange-color\"><Icon class=\"margin-right-5\" type=\"md-information-circle\"/>同步部门数据</span> -->\n            </FormItem>\n          </Form>\n          <Form class=\"margin-top-20\" :label-width=\"100\">\n\n            <FormItem class=\"margin-bottom-40\" label=\"同步人员：\">\n              <Button class=\"margin-right-20\" type='primary' :loading=\"btnLoading3\" icon=\"md-refresh\"\n                      @click=\"syncEmployee('employee')\">同步人员\n              </Button>\n              <!-- <span class=\"orange-color\"><Icon class=\"margin-right-5\" type=\"md-information-circle\"/>同步人员数据</span> -->\n            </FormItem>\n\n          </Form>\n\n      </Card>\n    </Col>\n  </Row>\n\n</template>\n\n<script>\nimport _ from 'underscore';\nimport {getTreeNodes, buildTree, buildTreeChecked} from \"@/libs/util\";\nexport default {\n  data() {\n    return {\n      btnLoading: false,\n      btnLoading2: false,\n      btnLoading3: false,\n      isEdit: false,\n      merchant_name: '',\n      tableData: [],\n      treeData: [],\n      departments: [],\n      departmentIds: [],\n    };\n  },\n\n  components: {},\n\n  computed: {\n    loading() {\n      return this.$store.state.user.userLoading;\n    },\n    currentMerchantId(){\n      return this.$store.state.user.curMerchantId;\n    },\n    currentMerchantName(){\n      return this.$store.state.user.curMerchantName;\n    },\n    currentOrgId() {\n      return this.$store.state.user.curOrgId;\n    },\n    sessionId() {\n      return this.$store.state.user.token;\n    },\n    empUserCode() {\n      return this.$store.state.user.empUserCode;\n    },\n\n    //部门列表\n    departmentList() {\n      return this.$store.state.user.departmentList;\n    },\n\n  },\n\n  methods: {\n    initData: async function() {\n      this.merchant_name = this.currentMerchantName;\n      let res = await this.getDepartmentList();\n      await this.queryDepartmentList(res);\n    },\n\n    //获取企业部门列表\n    async queryDepartmentList(strChecked) {\n      let res = await this.$store.dispatch('departmentList', { org_id: this.currentOrgId, sessionid: this.sessionId,limit: 2000 });\n      // console.log(\"queryDepartmentList===res>>>\" + JSON.stringify(res));\n      let validRes = _.filter(res, cur => {return cur.status == 1 });\n      // console.log(\"queryDepartmentList===validRes>>>\" + JSON.stringify(validRes));\n      await this.$store.commit(\"UpdateEmpDepartmentList\", validRes);\n      if (validRes.length > 0) {\n        this.treeData = buildTreeChecked(validRes, {}, 'department_id', 'parentid', 'children', '0', strChecked);\n      }\n    },\n\n    choiceAll(data){\n      let choicesData = this.$refs.tree3.getCheckedAndIndeterminateNodes();\n      this.departments = _.map(choicesData, function(item){ return {name: item.name, org_id: item.org_id, parentid: item.parentid, department_id: item.department_id}; });\n    },\n\n    syncDepartmentList: async function() {\n      this.btnLoading = true;\n      //给部门添加跟节点；\n      let rootTree={\n        department_id: '0',\n        parentid: \"\",\n        name: \"全部部门\",\n        org_id: this.currentOrgId,\n      };\n\n      let findItem = _.find(this.departments, cur=>{return cur.department_id == '0' });\n\n      if (findItem == undefined){\n        this.departments.push(rootTree);\n      }\n      else{\n        findItem['org_id'] = this.currentOrgId;\n      }\n\n      let Base64 = require('js-base64').Base64;\n\n      let params = {\n        merchant_id: this.currentMerchantId,\n        departments: Base64.encode(JSON.stringify(this.departments)),\n      };\n\n      await this.$store.dispatch('syncDepartments', params).then(res=>{\n        if(res.return_code==0){\n          this.btnLoading = false;\n          this.$Message.success('同步部门信息成功！');\n        }\n      }).catch(err=>{\n        this.btnLoading = false;\n      });\n    },\n\n    getDepartmentList: async function() {\n\n      let params = {\n        merchant_id: this.currentMerchantId,\n        level: 1,\n      };\n\n      let res = await this.$store.dispatch('getMerchantDepartmentList', params);\n      if(res.return_code==0){\n          this.$Message.success('获取部门信息成功！');\n          let resTree = getTreeNodes(res.data, 'department_id',  'children');\n          return resTree;\n      }\n    },\n    // 同步员工\n    async syncEmployee(entityData) {\n      try {\n        if(entityData=='department'){\n          this.btnLoading2 = true;\n        }else if(entityData=='employee'){\n          this.btnLoading3 = true;\n        }\n\n        let res = await this.$store.dispatch('icloudSync', { org_id: this.$store.state.user.curOrgId, entity: entityData });\n        if (res.return_code !== 0) {\n          this.$Message.error(res.return_message);\n          return;\n        }\n        this.btnLoading2 = false;\n        this.btnLoading3 = false;\n\n        this.$Message.success('同步数据命令发送成功，请稍后查看同步数据结果！');\n      } catch (e) {\n        // console.log(e);\n        this.btnLoading2 = false;\n        this.btnLoading3 = false;\n      }\n    },\n\n\n  },\n\n  mounted(){\n    this.initData();\n  },\n\n  watch: {\n    departmentModal(val){\n      if(!val){\n        this.btnLoading = false;\n        this.btnLoading2 = false;\n      }\n    }\n  }\n};\n</script>\n<style lang='less' scoped>\n/deep/.ivu-card{\n  height: ~'-webkit-calc(100vh - 40px - 36px)';\n  height: ~'-moz-calc(100vh - 40px - 36px)';\n  height: ~'-ms-calc(100vh - 40px - 36px)';\n  height: ~'-o-calc(100vh - 40px - 36px)';\n  height: calc(100vh - 40px - 36px);\n\n}\n\n/deep/.ivu-input{\n  text-align: right;\n}\n/deep/.ivu-form .tree{\n  .ivu-form-item-content{\n    max-height: 500px;\n    overflow-y: auto;\n    background-color: #fff;\n    border: 1px solid #dcdee2;\n    border-radius: 4px;\n    padding: 0 8px;\n    margin-left: 0 !important;\n  }\n  +.ivu-form-item .ivu-form-item-content{\n    margin-left: 0 !important;\n  }\n  .ivu-btn{\n    position: absolute;\n    right: 0;\n    top: 0;\n  }\n}\n/deep/.ivu-tree{\n  li{\n    margin: 0 !important;\n    line-height: 32px;\n  }\n}\n\n</style>\n"]}]}